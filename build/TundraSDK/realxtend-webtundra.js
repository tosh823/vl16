/*
 * realXtend WebTundra v5.4.3
 * http://realxtend.org
 *
 * Commit   5.4.3-8-ca08f5d
 * Date     6.10.2016 9:23:51 UTC
 * Meta     @preserve
 * Copyright realXtend project - http://realxtend.org/

 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at

 *      http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
function BitArray(a,b){void 0===b&&(b=0),this.size=a,this.field=new Array(~~((a-1)/BitArray.ELEMENT_WIDTH)+1);for(var c=0;c<this.field.length;c++)this.field[c]=0==b?0:(b<<BitArray.ELEMENT_WIDTH)-1}function LoadCrunchDecoder(){function e(a){throw a}function q(){return function(){}}function ga(a){eval.call(m,a)}function ha(){return x}function ia(a){x=a}function ja(a){switch(a){case"i1":case"i8":return 1;case"i16":return 2;case"i32":return 4;case"i64":return 8;case"float":return 4;case"double":return 8;default:if("*"===a[a.length-1])return ka;if("i"===a[0])return a=parseInt(a.substr(1)),A(0===a%8),a/8}}function la(a,b,c){c&&c.length?(c.splice||(c=Array.prototype.slice.call(c)),c.splice(0,0,b),s["dynCall_"+a].apply(m,c)):s["dynCall_"+a].call(m,b)}function na(){var a=[],b=0;this.za=function(c){if(c&=255,0==a.length)return 0==(128&c)?String.fromCharCode(c):(a.push(c),b=192==(224&c)?1:224==(240&c)?2:3,"");if(b&&(a.push(c),b--,0<b))return"";var c=a[0],d=a[1],e=a[2],f=a[3];return 2==a.length?c=String.fromCharCode((31&c)<<6|63&d):3==a.length?c=String.fromCharCode((15&c)<<12|(63&d)<<6|63&e):(c=(7&c)<<18|(63&d)<<12|(63&e)<<6|63&f,c=String.fromCharCode(Math.floor((c-65536)/1024)+55296,(c-65536)%1024+56320)),a.length=0,c},this.Cb=function(a){for(var a=unescape(encodeURIComponent(a)),b=[],c=0;c<a.length;c++)b.push(a.charCodeAt(c));return b}}function oa(a){var b=x;return x=x+a|0,x=x+7&-8,b}function pa(a){var b=B;return B=B+a|0,B=B+7&-8,b}function qa(a){var b=D;return D=D+a|0,D=D+7&-8,D>=ra&&E("Cannot enlarge memory arrays in asm.js. Either (1) compile with -s TOTAL_MEMORY=X with X higher than the current value "+ra+", or (2) set Module.TOTAL_MEMORY before the program runs."),b}function sa(a,b){return Math.ceil(a/(b?b:8))*(b?b:8)}function A(a,b){a||E("Assertion failed: "+b)}function xa(a){try{var b=s["_"+a];b||(b=eval("_"+a))}catch(c){}return A(b,"Cannot call unknown function "+a+" (perhaps LLVM optimizations or closure removed it?)"),b}function wa(a,b,c,d){function e(a,b){if("string"==b){if(a===m||a===j||0===a)return 0;a=H(a),b="array"}if("array"==b){f||(f=ha());var c=oa(a.length);return ya(a,c),c}return a}var f=0,g=0,d=d?d.map(function(a){return e(a,c[g++])}):[];return a=a.apply(m,d),"string"==b?b=za(a):(A("array"!=b),b=a),f&&ia(f),b}function Aa(a,b,c){switch(c=c||"i8","*"===c.charAt(c.length-1)&&(c="i32"),c){case"i1":I[a]=b;break;case"i8":I[a]=b;break;case"i16":J[a>>1]=b;break;case"i32":K[a>>2]=b;break;case"i64":va=[b>>>0,(tempDouble=b,1<=+Ba(tempDouble)?0<tempDouble?(0|Ca(+Da(tempDouble/4294967296),4294967295))>>>0:~~+Ea((tempDouble-+(~~tempDouble>>>0))/4294967296)>>>0:0)],K[a>>2]=va[0],K[a+4>>2]=va[1];break;case"float":Fa[a>>2]=b;break;case"double":Ga[a>>3]=b;break;default:E("invalid type for setValue: "+c)}}function L(a,b,c,d){var e,f;"number"==typeof a?(e=l,f=a):(e=p,f=a.length);var g="string"==typeof b?b:m,c=c==Ja?d:[Ka,oa,pa,qa][c===j?Ia:c](Math.max(f,g?1:b.length));if(e){for(d=c,A(0==(3&c)),a=c+(f&-4);d<a;d+=4)K[d>>2]=0;for(a=c+f;d<a;)I[0|d++]=0;return c}if("i8"===g)return a.subarray||a.slice?M.set(a,c):M.set(new Uint8Array(a),c),c;for(var h,i,d=0;d<f;){var k=a[d];"function"==typeof k&&(k=ta.Sd(k)),e=g||b[d],0===e?d++:("i64"==e&&(e="i32"),Aa(c+d,k,e),i!==e&&(h=ja(e),i=e),d+=h)}return c}function za(a,b){for(var c,d=p,e=0;;){if(c=M[a+e|0],128<=c)d=l;else if(0==c&&!b)break;if(e++,b&&e==b)break}b||(b=e);var f="";if(!d){for(;0<b;)c=String.fromCharCode.apply(String,M.subarray(a,a+Math.min(b,1024))),f=f?f+c:c,a+=1024,b-=1024;return f}for(d=new na,e=0;e<b;e++)c=M[a+e|0],f+=d.za(c);return f}function La(a){try{if("number"==typeof a&&(a=za(a)),"_"!==a[0]||"_"!==a[1]||"Z"!==a[2])return a;var b=3,c={v:"void",b:"bool",c:"char",s:"short",i:"int",l:"long",f:"float",d:"double",w:"wchar_t",a:"signed char",h:"unsigned char",t:"unsigned short",j:"unsigned int",m:"unsigned long",x:"long long",y:"unsigned long long",z:"..."},d=[],f=function(g,h,i){var j,h=h||1/0,k="",m=[];if("N"!==a[b]){"K"===a[b]&&b++;var n=parseInt(a.substr(b));if(n){var o=n.toString().length;j=a.substr(b+o,n),b+=o+n}}else{for(b++,"K"===a[b]&&b++,j=[];"E"!==a[b];)if("S"===a[b])b++,n=a.indexOf("_",b),j.push(d[a.substring(b,n)||0]||"?"),b=n+1;else{if(n=parseInt(a.substr(b)),o=n.toString().length,!n||!o){b--;break}var p=a.substr(b+o,n);j.push(p),d.push(p),b+=o+n}if(b++,j=j.join("::"),h--,0===h)return g?[j]:j}"I"===a[b]?(b++,n=f(l),o=f(l,1,l),k+=o[0]+" "+j+"<"+n.join(", ")+">"):k=j;a:for(;b<a.length&&0<h--;)if(j=a[b++],j in c)m.push(c[j]);else switch(j){case"P":m.push(f(l,1,l)[0]+"*");break;case"R":m.push(f(l,1,l)[0]+"&");break;case"L":b++,n=a.indexOf("E",b)-b,m.push(a.substr(b,n)),b+=n+2;break;case"A":n=parseInt(a.substr(b)),b+=n.toString().length,"_"!==a[b]&&e("?"),b++,m.push(f(l,1,l)[0]+" ["+n+"]");break;case"E":break a;default:k+="?"+j;break a}return!i&&1===m.length&&"void"===m[0]&&(m=[]),g?m:k+("("+m.join(", ")+")")};return f()}catch(g){return a}}function Ma(){var a=Error().stack;return a?a.replace(/__Z[\w\d_]+/g,function(a){var b=La(a);return a===b?a:a+" ["+b+"]"}):"(no stack trace available)"}function Ua(a){for(;0<a.length;){var b=a.shift();if("function"==typeof b)b();else{var c=b.M;"number"==typeof c?b.ta===j?la("v",c):la("vi",c,[b.ta]):c(b.ta===j?m:b.ta)}}}function $a(a){Va.unshift(a)}function ab(a){Ya.unshift(a)}function H(a,b,c){return a=(new na).Cb(a),c&&(a.length=c),b||a.push(0),a}function ya(a,b){for(var c=0;c<a.length;c++)I[b+c|0]=a[c]}function bb(a,b){return 0<=a?a:32>=b?2*Math.abs(1<<b-1)+a:Math.pow(2,b)+a}function cb(a,b){if(0>=a)return a;var c=32>=b?Math.abs(1<<b-1):Math.pow(2,b-1);return a>=c&&(32>=b||a>c)&&(a=-2*c+a),a}function gb(a){Q++,s.monitorRunDependencies&&s.monitorRunDependencies(Q),a?(A(!db[a]),db[a]=1):s.P("warning: run dependency added without ID")}function hb(a){Q--,s.monitorRunDependencies&&s.monitorRunDependencies(Q),a?(A(db[a]),delete db[a]):s.P("warning: run dependency removed without ID"),0==Q&&(eb!==m&&(clearInterval(eb),eb=m),fb&&(a=fb,fb=m,a()))}function lb(a){return 0>a||0===a&&-(1/0)===1/a}function mb(a,b){function c(a){var c;return"double"===a?c=Ga[b+g>>3]:"i64"==a?(c=[K[b+g>>2],K[b+(g+8)>>2]],g+=8):(a="i32",c=K[b+g>>2]),g+=Math.max(Math.max(ja(a),ka),8),c}for(var d,e,f=a,g=0,h=[];;){var i=f;if(d=I[f],0===d)break;if(e=I[f+1|0],37==d){var j=p,k=p,n=p,o=p,q=p;a:for(;;){switch(e){case 43:j=l;break;case 45:k=l;break;case 35:n=l;break;case 48:if(o)break a;o=l;break;case 32:q=l;break;default:break a}f++,e=I[f+1|0]}var r=0;if(42==e)r=c("i32"),f++,e=I[f+1|0];else for(;48<=e&&57>=e;)r=10*r+(e-48),f++,e=I[f+1|0];var s=p;if(46==e){var t=0,s=l;if(f++,e=I[f+1|0],42==e)t=c("i32"),f++;else for(;e=I[f+1|0],!(48>e||57<e);)t=10*t+(e-48),f++;e=I[f+1|0]}else t=6;var u;switch(String.fromCharCode(e)){case"h":e=I[f+2|0],104==e?(f++,u=1):u=2;break;case"l":e=I[f+2|0],108==e?(f++,u=8):u=4;break;case"L":case"q":case"j":u=8;break;case"z":case"t":case"I":u=4;break;default:u=m}switch(u&&f++,e=I[f+1|0],String.fromCharCode(e)){case"d":case"i":case"u":case"o":case"x":case"X":case"p":i=100==e||105==e,u=u||4,d=c("i"+8*u);var v;8==u&&(d=117==e?+(d[0]>>>0)+4294967296*+(d[1]>>>0):+(d[0]>>>0)+4294967296*+(0|d[1])),4>=u&&(d=(i?cb:bb)(d&Math.pow(256,u)-1,8*u));var w=Math.abs(d),i="";if(100==e||105==e)v=cb(d,8*u).toString(10);else if(117==e)v=bb(d,8*u).toString(10),d=Math.abs(d);else if(111==e)v=(n?"0":"")+w.toString(8);else if(120==e||88==e){if(i=n&&0!=d?"0x":"",0>d){for(d=-d,v=(w-1).toString(16),w=[],n=0;n<v.length;n++)w.push((15-parseInt(v[n],16)).toString(16));for(v=w.join("");v.length<2*u;)v="f"+v}else v=w.toString(16);88==e&&(i=i.toUpperCase(),v=v.toUpperCase())}else 112==e&&(0===w?v="(nil)":(i="0x",v=w.toString(16)));if(s)for(;v.length<t;)v="0"+v;for(0<=d&&(j?i="+"+i:q&&(i=" "+i)),"-"==v.charAt(0)&&(i="-"+i,v=v.substr(1));i.length+v.length<r;)k?v+=" ":o?v="0"+v:i=" "+i;v=i+v,v.split("").forEach(function(a){h.push(a.charCodeAt(0))});break;case"f":case"F":case"e":case"E":case"g":case"G":if(d=c("double"),isNaN(d))v="nan",o=p;else if(isFinite(d)){if(s=p,u=Math.min(t,20),103!=e&&71!=e||(s=l,t=t||1,u=parseInt(d.toExponential(u).split("e")[1],10),t>u&&-4<=u?(e=(103==e?"f":"F").charCodeAt(0),t-=u+1):(e=(103==e?"e":"E").charCodeAt(0),t--),u=Math.min(t,20)),101==e||69==e?(v=d.toExponential(u),/[eE][-+]\d$/.test(v)&&(v=v.slice(0,-1)+"0"+v.slice(-1))):102!=e&&70!=e||(v=d.toFixed(u),0===d&&lb(d)&&(v="-"+v)),i=v.split("e"),s&&!n)for(;1<i[0].length&&-1!=i[0].indexOf(".")&&("0"==i[0].slice(-1)||"."==i[0].slice(-1));)i[0]=i[0].slice(0,-1);else for(n&&-1==v.indexOf(".")&&(i[0]+=".");t>u++;)i[0]+="0";v=i[0]+(1<i.length?"e"+i[1]:""),69==e&&(v=v.toUpperCase()),0<=d&&(j?v="+"+v:q&&(v=" "+v))}else v=(0>d?"-":"")+"inf",o=p;for(;v.length<r;)v=k?v+" ":!o||"-"!=v[0]&&"+"!=v[0]?(o?"0":" ")+v:v[0]+"0"+v.slice(1);97>e&&(v=v.toUpperCase()),v.split("").forEach(function(a){h.push(a.charCodeAt(0))});break;case"s":if(o=(j=c("i8*"))?kb(j):6,s&&(o=Math.min(o,t)),!k)for(;o<r--;)h.push(32);if(j)for(n=0;n<o;n++)h.push(M[0|j++]);else h=h.concat(H("(null)".substr(0,o),l));if(k)for(;o<r--;)h.push(32);break;case"c":for(k&&h.push(c("i8"));0<--r;)h.push(32);k||h.push(c("i8"));break;case"n":k=c("i32*"),K[k>>2]=h.length;break;case"%":h.push(d);break;default:for(n=i;n<f+2;n++)h.push(I[n])}f+=2}else h.push(d),f+=1}return h}function nb(a,b,c,d){if(c=mb(c,d),d=b===j?c.length:Math.min(c.length,Math.max(b-1,0)),0>a)var a=-a,e=Ka(d+1),a=K[a>>2]=e;for(e=0;e<d;e++)I[a+e|0]=c[e];return(d<b||b===j)&&(I[a+e|0]=0),c.length}function S(a){return K[pb>>2]=a}function qb(a){return/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(a).slice(1)}function rb(a,b){for(var c=0,d=a.length-1;0<=d;d--){var e=a[d];"."===e?a.splice(d,1):".."===e?(a.splice(d,1),c++):c&&(a.splice(d,1),c--)}if(b)for(;c--;c)a.unshift("..");return a}function sb(a){var b="/"===a.charAt(0),c="/"===a.substr(-1),a=rb(a.split("/").filter(function(a){return!!a}),!b).join("/");return!a&&!b&&(a="."),a&&c&&(a+="/"),(b?"/":"")+a}function U(){var a=Array.prototype.slice.call(arguments,0);return sb(a.filter(function(a){return"string"!=typeof a&&e(new TypeError("Arguments to path.join must be strings")),a}).join("/"))}function tb(){for(var a="",b=p,c=arguments.length-1;-1<=c&&!b;c--){var d=0<=c?arguments[c]:"/";"string"!=typeof d&&e(new TypeError("Arguments to path.resolve must be strings")),d&&(a=d+"/"+a,b="/"===d.charAt(0))}return a=rb(a.split("/").filter(function(a){return!!a}),!b).join("/"),(b?"/":"")+a||"."}function vb(a,b){ub[a]={input:[],O:[],Z:b},wb[a]={k:xb}}function Jb(a){a instanceof V||e(a+" : "+Ma()),S(a.Na)}function Y(a,b){a=tb("/",a),b=b||{Aa:0},8<b.Aa&&e(new V(R.pa));for(var c=rb(a.split("/").filter(function(a){return!!a}),p),d=Eb,f="/",g=0;g<c.length;g++){var h=g===c.length-1;if(h&&b.parent)break;if(d=Ab(d,c[g]),f=U(f,c[g]),d.Ab&&(d=d.D.root),!h||b.X)for(h=0;40960===(61440&d.mode);){d=Y(f,{X:p}).g,d.n.la||e(new V(R.u));var d=d.n.la(d),i=tb,j=qb(f),f=j[0],j=j[1];f||j?(j&&(j=j.substr(0,j.length-1)),f+=j):f=".",f=i(f,d),d=Y(f,{Aa:b.Aa}).g,40<h++&&e(new V(R.pa))}}return{path:f,g:d}}function Kb(a){for(var b;;){if(a===a.parent)return b?U(a.D.Ua,b):a.D.Ua;b=b?U(a.name,b):a.name,a=a.parent}}function Lb(a,b){for(var c=0,d=0;d<b.length;d++)c=(c<<5)-c+b.charCodeAt(d)|0;return(a+c>>>0)%Hb.length}function Ab(a,b){var c=Mb(a,"x");for(c&&e(new V(c)),c=Hb[Lb(a.id,b)];c;c=c.Bb){var d=c.name;if(c.parent.id===a.id&&d===b)return c}return a.n.wa(a,b)}function yb(a,b,c,d){var e={id:Gb++,name:b,mode:c,n:{},k:{},ka:d,parent:m,D:m};return a||(a=e),e.parent=a,e.D=a.D,Object.defineProperties(e,{K:{get:function(){return 365===(365&e.mode)},set:function(a){a?e.mode|=365:e.mode&=-366}},write:{get:function(){return 146===(146&e.mode)},set:function(a){a?e.mode|=146:e.mode&=-147}},yb:{get:function(){return 16384===(61440&e.mode)}},xb:{get:function(){return 8192===(61440&e.mode)}}}),a=Lb(e.parent.id,e.name),e.Bb=Hb[a],Hb[a]=e}function Ob(a){var b=Nb[a];return"undefined"==typeof b&&e(Error("Unknown file open mode: "+a)),b}function Mb(a,b){return Ib?0:(-1===b.indexOf("r")||292&a.mode)&&(-1===b.indexOf("w")||146&a.mode)&&(-1===b.indexOf("x")||73&a.mode)?0:R.eb}function Pb(a,b){try{return Ab(a,b),R.Da}catch(c){}return Mb(a,"wx")}function Qb(a,b,c){var d;a:{for(b=b||1,c=c||4096;b<=c;b++)if(!X[b]){d=b;break a}e(new V(R.kb))}return a.C=d,Object.defineProperties(a,{object:{get:function(){return a.g},set:function(b){a.g=b}},Yd:{get:function(){return 1!==(2097155&a.I)}},Zd:{get:function(){return 0!==(2097155&a.I)}},Xd:{get:function(){return 1024&a.I}}}),X[d]=a}function Rb(a,b){var c;b&&(c=Y(b,{X:p}),b=c.path);var d={type:a,ce:{},Ua:b,root:m},e=a.D(d);return e.D=d,d.root=e,c&&(c.g.D=d,c.g.Ab=l,"/"===b&&(Eb=d.root)),Fb.push(d),e}function Sb(a,b,c){var d=Y(a,{parent:l}).g,a="/"===a?"/":qb(a)[2],f=Pb(d,a);return f&&e(new V(f)),d.n.Q||e(new V(R.W)),d.n.Q(d,a,b,c)}function Tb(a,b){return b=4095&(b!==j?b:438),b|=32768,Sb(a,b,0)}function Ub(a,b){return b=1023&(b!==j?b:511),b|=16384,Sb(a,b,0)}function Vb(a,b,c){return"undefined"==typeof c&&(c=b,b=438),Sb(a,8192|b,c)}function Wb(a,b){var c=Y(b,{parent:l}).g,d="/"===b?"/":qb(b)[2],f=Pb(c,d);return f&&e(new V(f)),c.n.ma||e(new V(R.W)),c.n.ma(c,d,a)}function Xb(a,b){var c;c="string"==typeof a?Y(a,{X:l}).g:a,c.n.A||e(new V(R.W)),c.n.A(c,{mode:4095&b|c.mode&-4096,timestamp:Date.now()})}function Yb(a,b){var c,a=sb(a),b="string"==typeof b?Ob(b):b;c=64&b?4095&("undefined"==typeof c?438:c)|32768:0;var d;try{d=Y(a,{X:!(131072&b)}).g}catch(f){}if(64&b&&(d?128&b&&e(new V(R.Da)):d=Sb(a,c,0)),d||e(new V(R.qa)),8192===(61440&d.mode)&&(b&=-513),d?40960===(61440&d.mode)?c=R.pa:16384===(61440&d.mode)&&(0!==(2097155&b)||512&b)?c=R.oa:(c=["r","w","rw"][2097155&b],512&b&&(c+="w"),c=Mb(d,c)):c=R.qa,c&&e(new V(c)),512&b){c=d,c="string"==typeof c?Y(c,{X:l}).g:c,c.n.A||e(new V(R.W)),16384===(61440&c.mode)&&e(new V(R.oa)),32768!==(61440&c.mode)&&e(new V(R.u));var g=Mb(c,"w");g&&e(new V(g)),c.n.A(c,{size:0,timestamp:Date.now()})}return b&=-641,d=Qb({g:d,path:Kb(d),I:b,seekable:l,position:0,k:d.k,Hb:[],error:p},j,j),d.k.open&&d.k.open(d),s.logReadFiles&&!(1&b)&&(Zb||(Zb={}),a in Zb||(Zb[a]=1,s.printErr("read file: "+a))),d}function $b(a){try{a.k.close&&a.k.close(a)}catch(b){e(b)}finally{X[a.C]=m}}function ac(a,b,c,d,f,g){(0>d||0>f)&&e(new V(R.u)),0===(2097155&a.I)&&e(new V(R.ba)),16384===(61440&a.g.mode)&&e(new V(R.oa)),a.k.write||e(new V(R.u));var h=l;return"undefined"==typeof f?(f=a.position,h=p):a.seekable||e(new V(R.sa)),1024&a.I&&((!a.seekable||!a.k.N)&&e(new V(R.sa)),a.k.N(a,0,2)),b=a.k.write(a,b,c,d,f,g),h||(a.position+=b),b}function bc(){V||(V=function(a){this.Na=a;for(var b in R)if(R[b]===a){this.code=b;break}this.message=ob[a],this.stack=Ma()},V.prototype=Error())}function dc(a,b){var c=0;return a&&(c|=365),b&&(c|=146),c}function ec(a,b,c,d,e,f){if(a=b?U("string"==typeof a?a:Kb(a),b):a,d=dc(d,e),e=Tb(a,d),c){if("string"==typeof c){for(var b=Array(c.length),g=0,h=c.length;g<h;++g)b[g]=c.charCodeAt(g);c=b}Xb(a,146|d),b=Yb(a,"w"),ac(b,c,0,c.length,0,f),$b(b),Xb(a,d)}return e}function fc(a,b,c,d){a=U("string"==typeof a?a:Kb(a),b),b=dc(!!c,!!d),fc.Sa||(fc.Sa=64);var f;return f=fc.Sa++<<8|0,wb[f]={k:{open:function(a){a.seekable=p},close:function(){d&&d.buffer&&d.buffer.length&&d(10)},K:function(a,b,d,f){for(var g=0,h=0;h<f;h++){var i;try{i=c()}catch(k){e(new V(R.L))}if(i===j&&0===g&&e(new V(R.V)),i===m||i===j)break;g++,b[d+h]=i}return g&&(a.g.timestamp=Date.now()),g},write:function(a,b,c,f){for(var g=0;g<f;g++)try{d(b[c+g])}catch(h){e(new V(R.L))}return f&&(a.g.timestamp=Date.now()),g}}},Vb(a,b,f)}function gc(a){if(a.xb||a.yb||a.link||a.o)return l;var b=l;if("undefined"!=typeof XMLHttpRequest&&e(Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.")),s.read)try{a.o=H(s.read(a.url),l)}catch(c){b=p}else e(Error("Cannot load without read() or XMLHttpRequest."));return b||S(R.L),b}function hc(a,b,c){if(a=X[a],!a)return S(R.ba),-1;try{return ac(a,I,b,c)}catch(d){return Jb(d),-1}}function ic(a,b,c,d){return c*=b,0==c?0:(a=hc(d,a,c),-1==a?((b=X[d])&&(b.error=l),0):Math.floor(a/b))}function jc(a,b,c){return c=mb(b,c),b=ha(),a=ic(L(c,"i8",Ha),1,c.length,a),ia(b),a}function mc(a){s.print("exit("+a+") called"),s.exit(a)}function nc(a){nc.qb||(D=D+4095&-4096,nc.qb=l,A(qa),nc.ob=qa,qa=function(){E("cannot dynamically allocate, sbrk now has control")});var b=D;return 0!=a&&nc.ob(a),b}function uc(a){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[a.substr(a.lastIndexOf(".")+1)]}function wc(){var a=s.canvas;vc.forEach(function(b){b(a.width,a.height)})}function xc(){var a=s.canvas;this.Jb=a.width,this.Ib=a.height,a.width=screen.width,a.height=screen.height,"undefined"!=typeof SDL&&(a=Oa[SDL.screen+0*ka>>2],K[SDL.screen+0*ka>>2]=8388608|a),wc()}function yc(){var a=s.canvas;a.width=this.Jb,a.height=this.Ib,"undefined"!=typeof SDL&&(a=Oa[SDL.screen+0*ka>>2],K[SDL.screen+0*ka>>2]=a&-8388609),wc()}function Ec(a){this.name="ExitStatus",this.message="Program terminated with exit("+a+")",this.status=a}function Jc(a){function b(){if(Za||(Za=l,Ua(O)),Ua(Wa),s.calledRun=l,s._main&&Ic&&s.callMain(a),s.postRun)for("function"==typeof s.postRun&&(s.postRun=[s.postRun]);s.postRun.length;)ab(s.postRun.shift());Ua(Ya)}if(a=a||s.arguments,Gc===m&&(Gc=Date.now()),0<Q)s.P("run() called, but dependencies remain, so not running");else{if(s.preRun)for("function"==typeof s.preRun&&(s.preRun=[s.preRun]);s.preRun.length;)$a(s.preRun.shift());Ua(Va),0<Q||(s.setStatus?(s.setStatus("Running..."),setTimeout(function(){setTimeout(function(){s.setStatus("")},1),ua||b()},1)):b())}}function Kc(a){ua=l,x=Fc,Ua(Xa),e(new Ec(a))}function E(a){a&&(s.print(a),s.P(a)),ua=l,e("abort() at "+Ma())}var j=void 0,l=!0,m=null,p=!1,s;s||(s=eval("(function() { try { return Module || {} } catch(e) { return {} } })()"));var aa={},v;for(v in s)s.hasOwnProperty(v)&&(aa[v]=s[v]);var w="object"==typeof process&&"function"==typeof require,ba="object"==typeof window,ca="function"==typeof importScripts,da=!ba&&!w&&!ca;if(w){s.print=function(a){process.stdout.write(a+"\n")},s.printErr=function(a){process.stderr.write(a+"\n")};var ea=require("fs"),fa=require("path");s.read=function(a,b){var a=fa.normalize(a),c=ea.readFileSync(a);return!c&&a!=fa.resolve(a)&&(a=path.join(__dirname,"..","src",a),c=ea.readFileSync(a)),c&&!b&&(c=c.toString()),c},s.readBinary=function(a){return s.read(a,l)},s.load=function(a){ga(read(a))},s.arguments=process.argv.slice(2),module.exports=s}else da?(s.print=print,"undefined"!=typeof printErr&&(s.printErr=printErr),s.read="undefined"!=typeof read?read:function(){e("no read() available (jsc?)")},s.readBinary=function(a){return read(a,"binary")},"undefined"!=typeof scriptArgs?s.arguments=scriptArgs:"undefined"!=typeof arguments&&(s.arguments=arguments),this.Module=s):ba||ca?(s.read=function(a){var b=new XMLHttpRequest;return b.open("GET",a,p),b.send(m),b.responseText},"undefined"!=typeof arguments&&(s.arguments=arguments),"undefined"!=typeof console?(s.print=function(a){console.log(a)},s.printErr=function(a){console.log(a)}):s.print=q(),ba?this.Module=s:s.load=importScripts):e("Unknown runtime environment. Where are we?");"undefined"==!s.load&&s.read&&(s.load=function(a){ga(s.read(a))}),s.print||(s.print=q()),s.printErr||(s.printErr=s.print),s.arguments||(s.arguments=[]),s.print=s.print,s.P=s.printErr,s.preRun=[],s.postRun=[];for(v in aa)aa.hasOwnProperty(v)&&(s[v]=aa[v]);var ma,ka=4,ta={},ua=p,va;s.ccall=function(a,b,c,d){return wa(xa(a),b,c,d)},s.cwrap=function(a,b,c){var d=xa(a);return function(){return wa(d,b,c,Array.prototype.slice.call(arguments))}},s.setValue=Aa,s.getValue=function(a,b){switch(b=b||"i8","*"===b.charAt(b.length-1)&&(b="i32"),b){case"i1":return I[a];case"i8":return I[a];case"i16":return J[a>>1];case"i32":return K[a>>2];case"i64":return K[a>>2];case"float":return Fa[a>>2];case"double":return Ga[a>>3];default:E("invalid type for setValue: "+b)}return m};var Ha=1,Ia=2,Ja=4;s.ALLOC_NORMAL=0,s.ALLOC_STACK=Ha,s.ALLOC_STATIC=Ia,s.ALLOC_DYNAMIC=3,s.ALLOC_NONE=Ja,s.allocate=L,s.Pointer_stringify=za,s.UTF16ToString=function(a){for(var b=0,c="";;){var d=J[a+2*b>>1];if(0==d)return c;++b,c+=String.fromCharCode(d)}},s.stringToUTF16=function(a,b){for(var c=0;c<a.length;++c)J[b+2*c>>1]=a.charCodeAt(c);J[b+2*a.length>>1]=0},s.UTF32ToString=function(a){for(var b=0,c="";;){var d=K[a+4*b>>2];if(0==d)return c;++b,65536<=d?(d-=65536,c+=String.fromCharCode(55296|d>>10,56320|1023&d)):c+=String.fromCharCode(d)}},s.stringToUTF32=function(a,b){for(var c=0,d=0;d<a.length;++d){var e=a.charCodeAt(d);if(55296<=e&&57343>=e)var f=a.charCodeAt(++d),e=65536+((1023&e)<<10)|1023&f;K[b+4*c>>2]=e,++c}K[b+4*c>>2]=0};var I,M,J,Na,K,Oa,Fa,Ga,Qa=0,B=0,Ra=0,x=0,Sa=0,Ta=0,D=0,ra=s.TOTAL_MEMORY||16777216;A("undefined"!=typeof Int32Array&&"undefined"!=typeof Float64Array&&!!new Int32Array(1).subarray&&!!new Int32Array(1).set,"Cannot fallback to non-typed array case: Code is too specialized");var N=new ArrayBuffer(ra);I=new Int8Array(N),J=new Int16Array(N),K=new Int32Array(N),M=new Uint8Array(N),Na=new Uint16Array(N),Oa=new Uint32Array(N),Fa=new Float32Array(N),Ga=new Float64Array(N),K[0]=255,A(255===M[0]&&0===M[3],"Typed arrays 2 must be run on a little-endian system"),s.HEAP=j,s.HEAP8=I,s.HEAP16=J,s.HEAP32=K,s.HEAPU8=M,s.HEAPU16=Na,s.HEAPU32=Oa,s.HEAPF32=Fa,s.HEAPF64=Ga;var Va=[],O=[],Wa=[],Xa=[],Ya=[],Za=p;s.addOnPreRun=s.Id=$a,s.addOnInit=s.Fd=function(a){O.unshift(a)},s.addOnPreMain=s.Hd=function(a){Wa.unshift(a)},s.addOnExit=s.Ed=function(a){Xa.unshift(a)},s.addOnPostRun=s.Gd=ab,s.intArrayFromString=H,s.intArrayToString=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];255<d&&(d&=255),b.push(String.fromCharCode(d))}return b.join("")},s.writeStringToMemory=function(a,b,c){for(a=H(a,c),c=0;c<a.length;)I[b+c|0]=a[c],c+=1},s.writeArrayToMemory=ya,s.writeAsciiToMemory=function(a,b,c){for(var d=0;d<a.length;d++)I[b+d|0]=a.charCodeAt(d);c||(I[b+a.length|0]=0)},Math.imul||(Math.imul=function(a,b){var c=65535&a,d=65535&b;return c*d+((a>>>16)*d+c*(b>>>16)<<16)|0}),Math.Vd=Math.imul;var Ba=Math.abs,Ea=Math.ceil,Da=Math.floor,Ca=Math.min,Q=0,db={},eb=m,fb=m;s.addRunDependency=gb,s.removeRunDependency=hb,s.preloadedImages={},s.preloadedAudios={},Qa=8,B=Qa+1376,O.push({M:function(){ib()}}),L([109,95,108,111,111,107,117,112,91,116,93,32,61,61,32,99,85,73,78,84,51,50,95,77,65,88,0,0,0,0,0,0,116,32,60,32,40,49,85,32,60,60,32,116,97,98,108,101,95,98,105,116,115,41,0,0,112,67,111,100,101,115,105,122,101,115,91,115,121,109,95,105,110,100,101,120,93,32,61,61,32,99,111,100,101,115,105,122,101,0,0,0,0,0,0,0,115,111,114,116,101,100,95,112,111,115,32,60,32,116,111,116,97,108,95,117,115,101,100,95,115,121,109,115,0,0,0,0,110,117,109,95,99,111,100,101,115,91,99,93,0,0,0,0,110,101,119,95,99,97,112,97,99,105,116,121,32,38,38,32,40,110,101,119,95,99,97,112,97,99,105,116,121,32,62,32,109,95,99,97,112,97,99,105,116,121,41,0,0,0,0,0,40,108,101,110,32,62,61,32,49,41,32,38,38,32,40,108,101,110,32,60,61,32,99,77,97,120,69,120,112,101,99,116,101,100,67,111,100,101,83,105,122,101,41,0,0,0,0,0,110,101,120,116,95,108,101,118,101,108,95,111,102,115,32,62,32,99,117,114,95,108,101,118,101,108,95,111,102,115,0,0,110,117,109,32,38,38,32,40,110,117,109,32,61,61,32,126,110,117,109,95,99,104,101,99,107,41,0,0,0,0,0,0,105,32,60,32,109,95,115,105,122,101,0,0,0,0,0,0,109,105,110,95,110,101,119,95,99,97,112,97,99,105,116,121,32,60,32,40,48,120,55,70,70,70,48,48,48,48,85,32,47,32,101,108,101,109,101,110,116,95,115,105,122,101,41,0,109,111,100,101,108,46,109,95,99,111,100,101,95,115,105,122,101,115,91,115,121,109,93,32,61,61,32,108,101,110,0,0,116,32,33,61,32,99,85,73,78,84,51,50,95,77,65,88,0,0,0,0,0,0,0,0,109,95,98,105,116,95,99,111,117,110,116,32,60,61,32,99,66,105,116,66,117,102,83,105,122,101,0,0,0,0,0,0,48,0,0,0,0,0,0,0,46,46,47,105,110,99,47,99,114,110,95,100,101,99,111,109,112,46,104,0,0,0,0,0,40,116,111,116,97,108,95,115,121,109,115,32,62,61,32,49,41,32,38,38,32,40,116,111,116,97,108,95,115,121,109,115,32,60,61,32,112,114,101,102,105,120,95,99,111,100,105,110,103,58,58,99,77,97,120,83,117,112,112,111,114,116,101,100,83,121,109,115,41,0,0,0,102,97,108,115,101,0,0,0,99,114,110,100,95,102,114,101,101,58,32,98,97,100,32,112,116,114,0,0,0,0,0,0,99,114,110,100,95,114,101,97,108,108,111,99,58,32,98,97,100,32,112,116,114,0,0,0,40,40,117,105,110,116,51,50,41,112,95,110,101,119,32,38,32,40,67,82,78,68,95,77,73,78,95,65,76,76,79,67,95,65,76,73,71,78,77,69,78,84,32,45,32,49,41,41,32,61,61,32,48,0,0,0,99,114,110,100,95,109,97,108,108,111,99,58,32,111,117,116,32,111,102,32,109,101,109,111,114,121,0,0,0,0,0,0,99,114,110,100,95,109,97,108,108,111,99,58,32,115,105,122,101,32,116,111,111,32,98,105,103,0,0,0,0,0,0,0,109,95,115,105,122,101,32,60,61,32,109,95,99,97,112,97,99,105,116,121,0,0,0,0,37,115,40,37,117,41,58,32,65,115,115,101,114,116,105,111,110,32,102,97,105,108,117,114,101,58,32,34,37,115,34,10,0,0,0,0,0,0,0,0,17,18,19,20,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15,16,0,0,0,1,2,2,3,3,3,3,4,0,0,0,0,0,0,1,1,0,1,0,1,0,0,1,2,1,2,0,0,0,1,0,2,1,0,2,0,0,1,2,3,0,2,3,4,5,6,7,1,0,2,3,1,0,0,0,0],"i8",Ja,8);var jb=sa(L(12,"i8",Ia),8);A(0==jb%8),s._strlen=kb;var R={W:1,qa:2,qd:3,nc:4,L:5,Ga:6,Kb:7,Kc:8,ba:9,Yb:10,V:11,Ad:11,lb:12,eb:13,ic:14,Wc:15,Wb:16,Da:17,Bd:18,Ea:19,Xc:20,oa:21,u:22,Fc:23,kb:24,ad:25,xd:26,jc:27,Sc:28,sa:29,nd:30,yc:31,fd:32,fc:33,kd:34,Oc:42,lc:43,Zb:44,pc:45,qc:46,rc:47,xc:48,yd:49,Ic:50,oc:51,dc:35,Lc:37,Pb:52,Sb:53,Cd:54,Gc:55,Tb:56,Ub:57,ec:35,Vb:59,Uc:60,Jc:61,ud:62,Tc:63,Pc:64,Qc:65,md:66,Mc:67,Nb:68,rd:69,$b:70,gd:71,Ac:72,gc:73,Rb:74,bd:76,Qb:77,ld:78,sc:79,tc:80,wc:81,vc:82,uc:83,Vc:38,Fa:39,Bc:36,pa:40,ra:95,ed:96,cc:104,Hc:105,Ob:97,jd:91,Zc:88,Rc:92,od:108,bc:111,Lb:98,ac:103,Ec:101,Cc:100,vd:110,kc:112,hb:113,ib:115,fb:114,gb:89,zc:90,hd:93,pd:94,Mb:99,Dc:102,jb:106,ca:107,wd:109,zd:87,hc:122,sd:116,$c:95,Nc:123,mc:84,cd:75,Xb:125,Yc:131,dd:130,td:86},ob={0:"Success",1:"Not super-user",2:"No such file or directory",3:"No such process",4:"Interrupted system call",5:"I/O error",6:"No such device or address",7:"Arg list too long",8:"Exec format error",9:"Bad file number",10:"No children",11:"No more processes",12:"Not enough core",13:"Permission denied",14:"Bad address",15:"Block device required",16:"Mount device busy",17:"File exists",18:"Cross-device link",19:"No such device",20:"Not a directory",21:"Is a directory",22:"Invalid argument",23:"Too many open files in system",24:"Too many open files",25:"Not a typewriter",26:"Text file busy",27:"File too large",28:"No space left on device",29:"Illegal seek",30:"Read only file system",31:"Too many links",32:"Broken pipe",33:"Math arg out of domain of func",34:"Math result not representable",35:"File locking deadlock error",36:"File or path name too long",37:"No record locks available",38:"Function not implemented",39:"Directory not empty",40:"Too many symbolic links",42:"No message of desired type",43:"Identifier removed",44:"Channel number out of range",45:"Level 2 not synchronized",46:"Level 3 halted",47:"Level 3 reset",48:"Link number out of range",49:"Protocol driver not attached",50:"No CSI structure available",51:"Level 2 halted",52:"Invalid exchange",53:"Invalid request descriptor",54:"Exchange full",55:"No anode",56:"Invalid request code",57:"Invalid slot",59:"Bad font file fmt",60:"Device not a stream",61:"No data (for no delay io)",62:"Timer expired",63:"Out of streams resources",64:"Machine is not on the network",65:"Package not installed",66:"The object is remote",67:"The link has been severed",68:"Advertise error",69:"Srmount error",70:"Communication error on send",71:"Protocol error",72:"Multihop attempted",73:"Cross mount point (not really error)",74:"Trying to read unreadable message",75:"Value too large for defined data type",76:"Given log. name not unique",77:"f.d. invalid for this operation",78:"Remote address changed",79:"Can   access a needed shared lib",80:"Accessing a corrupted shared lib",81:".lib section in a.out corrupted",82:"Attempting to link in too many libs",83:"Attempting to exec a shared library",84:"Illegal byte sequence",86:"Streams pipe error",87:"Too many users",88:"Socket operation on non-socket",89:"Destination address required",90:"Message too long",91:"Protocol wrong type for socket",92:"Protocol not available",93:"Unknown protocol",94:"Socket type not supported",95:"Not supported",96:"Protocol family not supported",97:"Address family not supported by protocol family",98:"Address already in use",99:"Address not available",100:"Network interface is not configured",101:"Network is unreachable",102:"Connection reset by network",103:"Connection aborted",104:"Connection reset by peer",105:"No buffer space available",106:"Socket is already connected",107:"Socket is not connected",108:"Can't send after socket shutdown",109:"Too many references",110:"Connection timed out",111:"Connection refused",112:"Host is down",113:"Host is unreachable",114:"Socket already connected",115:"Connection already in progress",116:"Stale file handle",122:"Quota exceeded",123:"No medium (in tape drive)",125:"Operation canceled",130:"Previous owner died",131:"State not recoverable"},pb=0,ub=[],xb={open:function(a){var b=ub[a.g.ka];b||e(new V(R.Ea)),a.B=b,a.seekable=p},close:function(a){a.B.O.length&&a.B.Z.ja(a.B,10)},K:function(a,b,c,d){(!a.B||!a.B.Z.Qa)&&e(new V(R.Ga));for(var f=0,g=0;g<d;g++){var h;try{h=a.B.Z.Qa(a.B)}catch(i){e(new V(R.L))}if(h===j&&0===f&&e(new V(R.V)),h===m||h===j)break;f++,b[c+g]=h}return f&&(a.g.timestamp=Date.now()),f},write:function(a,b,c,d){(!a.B||!a.B.Z.ja)&&e(new V(R.Ga));for(var f=0;f<d;f++)try{a.B.Z.ja(a.B,b[c+f])}catch(g){e(new V(R.L))}return d&&(a.g.timestamp=Date.now()),f}},W={cb:1,na:2,bb:3,D:function(){return W.createNode(m,"/",16895,0)},createNode:function(a,b,c,d){return(24576===(61440&c)||4096===(61440&c))&&e(new V(R.W)),c=yb(a,b,c,d),16384===(61440&c.mode)?(c.n={J:W.n.J,A:W.n.A,wa:W.n.wa,Q:W.n.Q,Q:W.n.Q,rename:W.n.rename,ab:W.n.ab,Za:W.n.Za,Xa:W.n.Xa,ma:W.n.ma},c.k={N:W.k.N},c.o={}):32768===(61440&c.mode)?(c.n={J:W.n.J,A:W.n.A},c.k={N:W.k.N,K:W.k.K,write:W.k.write,Ja:W.k.Ja,Ta:W.k.Ta},c.o=[],c.ea=W.na):40960===(61440&c.mode)?(c.n={J:W.n.J,A:W.n.A,la:W.n.la},c.k={}):8192===(61440&c.mode)&&(c.n={J:W.n.J,A:W.n.A},c.k=zb),c.timestamp=Date.now(),a&&(a.o[b]=c),c},ua:function(a){a.ea!==W.na&&(a.o=Array.prototype.slice.call(a.o),a.ea=W.na)},n:{J:function(a){var b={};return b.Qd=8192===(61440&a.mode)?a.id:1,b.Wd=a.id,b.mode=a.mode,b.ae=1,b.uid=0,b.Ud=0,b.ka=a.ka,b.size=16384===(61440&a.mode)?4096:32768===(61440&a.mode)?a.o.length:40960===(61440&a.mode)?a.link.length:0,b.Kd=new Date(a.timestamp),b.$d=new Date(a.timestamp),b.Pd=new Date(a.timestamp),b.pb=4096,b.Md=Math.ceil(b.size/b.pb),b},A:function(a,b){if(b.mode!==j&&(a.mode=b.mode),b.timestamp!==j&&(a.timestamp=b.timestamp),b.size!==j){W.ua(a);var c=a.o;if(b.size<c.length)c.length=b.size;else for(;b.size>c.length;)c.push(0)}},wa:function(){e(new V(R.qa))},Q:function(a,b,c,d){return W.createNode(a,b,c,d)},rename:function(a,b,c){if(16384===(61440&a.mode)){var d;try{d=Ab(b,c)}catch(f){}if(d)for(var g in d.o)e(new V(R.Fa))}delete a.parent.o[a.name],a.name=c,b.o[c]=a,a.parent=b},ab:function(a,b){delete a.o[b]},Za:function(a,b){var c,d=Ab(a,b);for(c in d.o)e(new V(R.Fa));delete a.o[b]},Xa:function(a){var b,c=[".",".."];for(b in a.o)a.o.hasOwnProperty(b)&&c.push(b);return c},ma:function(a,b,c){return a=W.createNode(a,b,41471,0),a.link=c,a},la:function(a){return 40960!==(61440&a.mode)&&e(new V(R.u)),a.link}},k:{K:function(a,b,c,d,e){if(a=a.g.o,e>=a.length)return 0;if(d=Math.min(a.length-e,d),A(0<=d),8<d&&a.subarray)b.set(a.subarray(e,e+d),c);else for(var f=0;f<d;f++)b[c+f]=a[e+f];return d},write:function(a,b,c,d,e,f){var g=a.g;if(g.timestamp=Date.now(),a=g.o,d&&0===a.length&&0===e&&b.subarray)return A(b.length),f&&b.buffer===I.buffer&&0===c?(g.o=b,g.ea=W.cb):(g.o=new Uint8Array(b.subarray(c,c+d)),g.ea=W.bb),d;for(W.ua(g),a=g.o;a.length<e;)a.push(0);for(f=0;f<d;f++)a[e+f]=b[c+f];return d},N:function(a,b,c){
return 1===c?b+=a.position:2===c&&32768===(61440&a.g.mode)&&(b+=a.g.o.length),0>b&&e(new V(R.u)),a.Hb=[],a.position=b},Ja:function(a,b,c){for(W.ua(a.g),a=a.g.o,b+=c;b>a.length;)a.push(0)},Ta:function(a,b,c,d,f,g,h){return 32768!==(61440&a.g.mode)&&e(new V(R.Ea)),a=a.g.o,2&h||a.buffer!==b&&a.buffer!==b.buffer?((0<f||f+d<a.length)&&(a=a.subarray?a.subarray(f,f+d):Array.prototype.slice.call(a,f,f+d)),f=l,(d=Ka(d))||e(new V(R.lb)),b.set(a,d)):(f=p,d=a.byteOffset),{de:d,Jd:f}}}},Bb=L(1,"i32*",Ia),Cb=L(1,"i32*",Ia),Db=L(1,"i32*",Ia),Eb=m,Fb=[],wb=[m],X=[m],Gb=1,Hb=m,Ib=l,V=m,Nb={r:0,rs:1052672,"r+":2,w:577,wx:705,xw:705,"w+":578,"wx+":706,"xw+":706,a:1089,ax:1217,xa:1217,"a+":1090,"ax+":1218,"xa+":1218},zb={open:function(a){a.k=wb[a.g.ka].k,a.k.open&&a.k.open(a)},N:function(){e(new V(R.sa))}},cc,Zb,Z={D:function(){return yb(m,"/",16895,0)},sb:function(a,b,c){return c&&A(1==b==(6==c)),a={tb:a,type:b,protocol:c,p:m,$:{},ya:[],R:[],T:Z.q},b=Z.ia(),c=yb(Z.root,b,49152,0),c.S=a,b=Qb({path:b,g:c,I:Ob("r+"),seekable:p,k:Z.k}),a.$a=b,a},ub:function(a){return a=X[a],a&&49152===(49152&a.g.mode)?a.g.S:m},k:{Wa:function(a){return a=a.g.S,a.T.Wa(a)},Ra:function(a,b,c){return a=a.g.S,a.T.Ra(a,b,c)},K:function(a,b,c,d){return a=a.g.S,(d=a.T.Db(a,d))?(b.set(d.buffer,c),d.buffer.length):0},write:function(a,b,c,d){return a=a.g.S,a.T.Fb(a,b,c,d)},close:function(a){a=a.g.S,a.T.close(a)}},ia:function(){return Z.ia.Ma||(Z.ia.Ma=0),"socket["+Z.ia.Ma++ +"]"},q:{fa:function(a,b,c){var d;if("object"==typeof b&&(d=b,c=b=m),d)d.Ha?(b=d.Ha.ee,c=d.Ha.fe):((c=/ws[s]?:\/\/([^:]+):(\d+)/.exec(d.url))||e(Error("WebSocket URL must be in the format ws(s)://address:port")),b=c[1],c=parseInt(c[2],10));else try{d=new WebSocket("ws://"+b+":"+c,w?{}:["binary"]),d.binaryType="arraybuffer"}catch(f){e(new V(R.hb))}return b={F:b,port:c,e:d,ga:[]},Z.q.Ia(a,b),Z.q.wb(a,b),2===a.type&&"undefined"!=typeof a.U&&b.ga.push(new Uint8Array([255,255,255,255,112,111,114,116,(65280&a.U)>>8,255&a.U])),b},ha:function(a,b,c){return a.$[b+":"+c]},Ia:function(a,b){a.$[b.F+":"+b.port]=b},Ya:function(a,b){delete a.$[b.F+":"+b.port]},wb:function(a,b){function c(c){A("string"!=typeof c&&c.byteLength!==j);var c=new Uint8Array(c),d=e;e=p,d&&10===c.length&&255===c[0]&&255===c[1]&&255===c[2]&&255===c[3]&&112===c[4]&&111===c[5]&&114===c[6]&&116===c[7]?(c=c[8]<<8|c[9],Z.q.Ya(a,b),b.port=c,Z.q.Ia(a,b)):a.R.push({F:b.F,port:b.port,data:c})}function d(){try{for(var a=b.ga.shift();a;)b.e.send(a),a=b.ga.shift()}catch(c){b.e.close()}}var e=l;w?(b.e.Y("open",d),b.e.Y("message",function(a,b){b.Ld&&c(new Uint8Array(a).buffer)}),b.e.Y("error",q())):(b.e.onopen=d,b.e.onmessage=function(a){c(a.data)})},Wa:function(a){if(1===a.type&&a.p)return a.ya.length?65:0;var b=0,c=1===a.type?Z.q.ha(a,a.G,a.H):m;return(a.R.length||!c||c&&c.e.readyState===c.e.aa||c&&c.e.readyState===c.e.CLOSED)&&(b|=65),(!c||c&&c.e.readyState===c.e.OPEN)&&(b|=4),(c&&c.e.readyState===c.e.aa||c&&c.e.readyState===c.e.CLOSED)&&(b|=16),b},Ra:function(a,b,c){switch(b){case 21531:return b=0,a.R.length&&(b=a.R[0].data.length),K[c>>2]=b,0;default:return R.u}},close:function(a){if(a.p){try{a.p.close()}catch(b){}a.p=m}for(var c=Object.keys(a.$),d=0;d<c.length;d++){var e=a.$[c[d]];try{e.e.close()}catch(f){}Z.q.Ya(a,e)}return 0},bind:function(a,b,c){if(("undefined"!=typeof a.Ca||"undefined"!=typeof a.U)&&e(new V(R.u)),a.Ca=b,a.U=c||_mkport(),2===a.type){a.p&&(a.p.close(),a.p=m);try{a.T.zb(a,0)}catch(d){d instanceof V||e(d),d.Na!==R.ra&&e(d)}}},Od:function(a,b,c){if(a.p&&e(new V(ERRNO_CODS.ra)),"undefined"!=typeof a.G&&"undefined"!=typeof a.H){var d=Z.q.ha(a,a.G,a.H);d&&(d.e.readyState===d.e.CONNECTING&&e(new V(R.fb)),e(new V(R.jb)))}b=Z.q.fa(a,b,c),a.G=b.F,a.H=b.port,e(new V(R.ib))},zb:function(a){w||e(new V(R.ra)),a.p&&e(new V(R.u));var b=require("ws").Dd;a.p=new b({host:a.Ca,port:a.U}),a.p.Y("connection",function(b){if(1===a.type){var c=Z.sb(a.tb,a.type,a.protocol),b=Z.q.fa(c,b);c.G=b.F,c.H=b.port,a.ya.push(c)}else Z.q.fa(a,b)}),a.p.Y("closed",function(){a.p=m}),a.p.Y("error",q())},accept:function(a){a.p||e(new V(R.u));var b=a.ya.shift();return b.$a.I=a.$a.I,b},Td:function(a,b){var c,d;return b?((a.G===j||a.H===j)&&e(new V(R.ca)),c=a.G,d=a.H):(c=a.Ca||0,d=a.U||0),{F:c,port:d}},Fb:function(a,b,c,d,f,g){2===a.type?(f!==j&&g!==j||(f=a.G,g=a.H),(f===j||g===j)&&e(new V(R.gb))):(f=a.G,g=a.H);var h=Z.q.ha(a,f,g);if(1===a.type&&((!h||h.e.readyState===h.e.aa||h.e.readyState===h.e.CLOSED)&&e(new V(R.ca)),h.e.readyState===h.e.CONNECTING&&e(new V(R.V))),b=b instanceof Array||b instanceof ArrayBuffer?b.slice(c,c+d):b.buffer.slice(b.byteOffset+c,b.byteOffset+c+d),2===a.type&&(!h||h.e.readyState!==h.e.OPEN))return h&&h.e.readyState!==h.e.aa&&h.e.readyState!==h.e.CLOSED||(h=Z.q.fa(a,f,g)),h.ga.push(b),d;try{return h.e.send(b),d}catch(i){e(new V(R.u))}},Db:function(a,b){1===a.type&&a.p&&e(new V(R.ca));var c=a.R.shift();if(!c){if(1===a.type){var d=Z.q.ha(a,a.G,a.H);if(d){if(d.e.readyState===d.e.aa||d.e.readyState===d.e.CLOSED)return m;e(new V(R.V))}e(new V(R.ca))}e(new V(R.V))}var d=c.data.byteLength||c.data.length,f=c.data.byteOffset||0,g=c.data.buffer||c.data,h=Math.min(b,d),i={buffer:new Uint8Array(g,f,h),F:c.F,port:c.port};return 1===a.type&&h<d&&(c.data=new Uint8Array(g,f+h,d-h),a.R.unshift(c)),i}}};s._memset=kc,s._memcpy=lc;var oc=p,pc=p,qc=p,rc=p,sc=j,tc=j,vc=[],zc,Ac,Bc,Cc;bc(),Hb=Array(4096),Eb=yb(m,"/",16895,0),Rb(W,"/"),Ub("/tmp"),Ub("/dev"),wb[259]={k:{K:function(){return 0},write:function(){return 0}}},Vb("/dev/null",259),vb(1280,{Qa:function(a){if(!a.input.length){var b=m;if(w){if(b=process.stdin.read(),!b){if(process.stdin._readableState&&process.stdin._readableState.ended)return m;return}}else"undefined"!=typeof window&&"function"==typeof window.prompt?(b=window.prompt("Input: "),b!==m&&(b+="\n")):"function"==typeof readline&&(b=readline(),b!==m&&(b+="\n"));if(!b)return m;a.input=H(b,l)}return a.input.shift()},ja:function(a,b){b===m||10===b?(s.print(a.O.join("")),a.O=[]):a.O.push(Dc.za(b))}}),vb(1536,{ja:function(a,b){b===m||10===b?(s.printErr(a.O.join("")),a.O=[]):a.O.push(Dc.za(b))}}),Vb("/dev/tty",1280),Vb("/dev/tty1",1536),Ub("/dev/shm"),Ub("/dev/shm/tmp"),O.unshift({M:function(){if(!s.noFSInit&&!cc){A(!cc,"FS.init was previously called. If you want to initialize later with custom parameters, remove any earlier calls (note that one is automatically added to the generated code)"),cc=l,bc(),s.stdin=s.stdin,s.stdout=s.stdout,s.stderr=s.stderr,s.stdin?fc("/dev","stdin",s.stdin):Wb("/dev/tty","/dev/stdin"),s.stdout?fc("/dev","stdout",m,s.stdout):Wb("/dev/tty","/dev/stdout"),s.stderr?fc("/dev","stderr",m,s.stderr):Wb("/dev/tty1","/dev/stderr");var a=Yb("/dev/stdin","r");K[Bb>>2]=a.C,A(1===a.C,"invalid handle for stdin ("+a.C+")"),a=Yb("/dev/stdout","w"),K[Cb>>2]=a.C,A(2===a.C,"invalid handle for stdout ("+a.C+")"),a=Yb("/dev/stderr","w"),K[Db>>2]=a.C,A(3===a.C,"invalid handle for stderr ("+a.C+")")}}}),Wa.push({M:function(){Ib=p}}),Xa.push({M:function(){cc=p;for(var a=0;a<X.length;a++){var b=X[a];b&&$b(b)}}}),s.FS_createFolder=function(a,b,c,d){return a=U("string"==typeof a?a:Kb(a),b),Ub(a,dc(c,d))},s.FS_createPath=function(a,b){for(var a="string"==typeof a?a:Kb(a),c=b.split("/").reverse();c.length;){var d=c.pop();if(d){var e=U(a,d);try{Ub(e)}catch(f){}a=e}}return e},s.FS_createDataFile=ec,s.FS_createPreloadedFile=function(a,b,c,d,f,g,h,i,k){function n(){qc=document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t}function o(c){function e(c){i||ec(a,b,c,d,f,k),g&&g(),hb("cp "+u)}var j=p;s.preloadPlugins.forEach(function(a){!j&&a.canHandle(u)&&(a.handle(c,u,e,function(){h&&h(),hb("cp "+u)}),j=l)}),j||e(c)}if(s.preloadPlugins||(s.preloadPlugins=[]),!zc&&!ca){zc=l;try{new Blob,Ac=l}catch(r){Ac=p,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}Bc="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:Ac?m:console.log("warning: no BlobBuilder"),Cc="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:j,!s.Va&&"undefined"==typeof Cc&&(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),s.Va=l),s.preloadPlugins.push({canHandle:function(a){return!s.Va&&/\.(jpg|jpeg|png|bmp)$/i.test(a)},handle:function(a,b,c,d){var e=m;if(Ac)try{e=new Blob([a],{type:uc(b)}),e.size!==a.length&&(e=new Blob([new Uint8Array(a).buffer],{type:uc(b)}))}catch(f){var g="Blob constructor present but fails: "+f+"; falling back to blob builder";ma||(ma={}),ma[g]||(ma[g]=1,s.P(g))}e||(e=new Bc,e.append(new Uint8Array(a).buffer),e=e.getBlob());var h=Cc.createObjectURL(e),i=new Image;i.onload=function(){A(i.complete,"Image "+b+" could not be decoded");var d=document.createElement("canvas");d.width=i.width,d.height=i.height,d.getContext("2d").drawImage(i,0,0),s.preloadedImages[b]=d,Cc.revokeObjectURL(h),c&&c(a)},i.onerror=function(){console.log("Image "+h+" could not be decoded"),d&&d()},i.src=h}}),s.preloadPlugins.push({canHandle:function(a){return!s.be&&a.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(a,b,c,d){function e(d){g||(g=l,s.preloadedAudios[b]=d,c&&c(a))}function f(){g||(g=l,s.preloadedAudios[b]=new Audio,d&&d())}var g=p;if(!Ac)return f();try{var h=new Blob([a],{type:uc(b)})}catch(i){return f()}var h=Cc.createObjectURL(h),j=new Audio;j.addEventListener("canplaythrough",function(){e(j)},p),j.onerror=function(){if(!g){console.log("warning: browser could not fully decode audio "+b+", trying slower base64 approach");for(var c="",d=0,f=0,h=0;h<a.length;h++)for(d=d<<8|a[h],f+=8;6<=f;)var i=d>>f-6&63,f=f-6,c=c+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[i];2==f?(c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&d)<<4],c+="=="):4==f&&(c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&d)<<2],c+="="),j.src="data:audio/x-"+b.substr(-3)+";base64,"+c,e(j)}},j.src=h,setTimeout(function(){ua||e(j)},1e4)}});var t=s.canvas;t.Ba=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.Oa=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||q(),t.Oa=t.Oa.bind(document),document.addEventListener("pointerlockchange",n,p),document.addEventListener("mozpointerlockchange",n,p),document.addEventListener("webkitpointerlockchange",n,p),s.elementPointerLock&&t.addEventListener("click",function(a){!qc&&t.Ba&&(t.Ba(),a.preventDefault())},p)}var u=b?tb(U(a,b)):a;if(gb("cp "+u),"string"==typeof c){var v=h,w=function(){v?v():e('Loading data file "'+c+'" failed.')},x=new XMLHttpRequest;x.open("GET",c,l),x.responseType="arraybuffer",x.onload=function(){if(200==x.status||0==x.status&&x.response){var a=x.response;A(a,'Loading data file "'+c+'" failed (no arrayBuffer).'),a=new Uint8Array(a),o(a),hb("al "+c)}else w()},x.onerror=w,x.send(m),gb("al "+c)}else o(c)},s.FS_createLazyFile=function(a,b,c,d,f){var g,h;"undefined"!=typeof XMLHttpRequest?(ca||e("Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc"),g=function(){this.va=p,this.da=[]},g.prototype.get=function(a){if(!(a>this.length-1||0>a)){var b=a%this.rb;return this.vb(Math.floor(a/this.rb))[b]}},g.prototype.Gb=function(a){this.vb=a},g.prototype.Ka=function(){var a=new XMLHttpRequest;a.open("HEAD",c,p),a.send(m),200<=a.status&&300>a.status||304===a.status||e(Error("Couldn't load "+c+". Status: "+a.status));var b,d=Number(a.getResponseHeader("Content-length")),f=1048576;(b=a.getResponseHeader("Accept-Ranges"))&&"bytes"===b||(f=d);var g=this;g.Gb(function(a){var b=a*f,h=(a+1)*f-1,h=Math.min(h,d-1);if("undefined"==typeof g.da[a]){var i=g.da;b>h&&e(Error("invalid range ("+b+", "+h+") or no bytes requested!")),h>d-1&&e(Error("only "+d+" bytes available! programmer error!"));var k=new XMLHttpRequest;k.open("GET",c,p),d!==f&&k.setRequestHeader("Range","bytes="+b+"-"+h),"undefined"!=typeof Uint8Array&&(k.responseType="arraybuffer"),k.overrideMimeType&&k.overrideMimeType("text/plain; charset=x-user-defined"),k.send(m),200<=k.status&&300>k.status||304===k.status||e(Error("Couldn't load "+c+". Status: "+k.status)),b=k.response!==j?new Uint8Array(k.response||[]):H(k.responseText||"",l),i[a]=b}return"undefined"==typeof g.da[a]&&e(Error("doXHR failed!")),g.da[a]}),this.nb=d,this.mb=f,this.va=l},g=new g,Object.defineProperty(g,"length",{get:function(){return this.va||this.Ka(),this.nb}}),Object.defineProperty(g,"chunkSize",{get:function(){return this.va||this.Ka(),this.mb}}),h=j):(h=c,g=j);var i,a=U("string"==typeof a?a:Kb(a),b);i=Tb(a,dc(d,f)),g?i.o=g:h&&(i.o=m,i.url=h);var k={};return Object.keys(i.k).forEach(function(a){var b=i.k[a];k[a]=function(){return gc(i)||e(new V(R.L)),b.apply(m,arguments)}}),k.K=function(a,b,c,d,f){if(gc(i)||e(new V(R.L)),a=a.g.o,f>=a.length)return 0;if(d=Math.min(a.length-f,d),A(0<=d),a.slice)for(var g=0;g<d;g++)b[c+g]=a[f+g];else for(g=0;g<d;g++)b[c+g]=a.get(f+g);return d},i.k=k,i},s.FS_createLink=function(a,b,c){return a=U("string"==typeof a?a:Kb(a),b),Wb(c,a)},s.FS_createDevice=fc,pb=pa(4),K[pb>>2]=0,O.unshift({M:q()}),Xa.push({M:q()});var Dc=new na;w&&(require("fs"),process.platform.match(/^win/)),O.push({M:function(){Z.root=Rb(Z,m)}}),s.requestFullScreen=function(a,b){function c(){pc=p,(document.webkitFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.mozFullscreenElement||document.fullScreenElement||document.fullscreenElement)===d?(d.La=document.cancelFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen,d.La=d.La.bind(document),sc&&d.Ba(),pc=l,tc&&xc()):tc&&yc(),s.onFullScreen&&s.onFullScreen(pc)}sc=a,tc=b,"undefined"==typeof sc&&(sc=l),"undefined"==typeof tc&&(tc=p);var d=s.canvas;rc||(rc=l,document.addEventListener("fullscreenchange",c,p),document.addEventListener("mozfullscreenchange",c,p),document.addEventListener("webkitfullscreenchange",c,p)),d.Eb=d.requestFullScreen||d.mozRequestFullScreen||(d.webkitRequestFullScreen?function(){d.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:m),d.Eb()},s.requestAnimationFrame=function(a){window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||window.setTimeout),window.requestAnimationFrame(a)},s.setCanvasSize=function(a,b,c){var d=s.canvas;d.width=a,d.height=b,c||wc()},s.pauseMainLoop=q(),s.resumeMainLoop=function(){oc&&(oc=p,m())},s.getUserMedia=function(){window.Pa||(window.Pa=navigator.getUserMedia||navigator.mozGetUserMedia),window.Pa(j)},Ra=x=sa(B),Sa=Ra+5242880,Ta=D=sa(Sa),A(Ta<ra),Ca=Math.min;var $=function(a,b,c){"use asm";var d=new a.Int8Array(c);var e=new a.Int16Array(c);var f=new a.Int32Array(c);var g=new a.Uint8Array(c);var h=new a.Uint16Array(c);var i=new a.Uint32Array(c);var j=new a.Float32Array(c);var k=new a.Float64Array(c);var l=b.STACKTOP|0;var m=b.STACK_MAX|0;var n=b.tempDoublePtr|0;var o=b.ABORT|0;var p=+b.NaN;var q=+b.Infinity;var r=0;var s=0;var t=0;var u=0;var v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0;var E=0;var F=0;var G=0;var H=0;var I=0;var J=0;var K=0;var L=0;var M=0;var N=0;var O=a.Math.floor;var P=a.Math.abs;var Q=a.Math.sqrt;var R=a.Math.pow;var S=a.Math.cos;var T=a.Math.sin;var U=a.Math.tan;var V=a.Math.acos;var W=a.Math.asin;var X=a.Math.atan;var Y=a.Math.atan2;var Z=a.Math.exp;var $=a.Math.log;var _=a.Math.ceil;var aa=a.Math.imul;var ba=b.abort;var ca=b.assert;var da=b.asmPrintInt;var ea=b.asmPrintFloat;var fa=b.min;var ga=b.invoke_ii;var ha=b.invoke_v;var ia=b.invoke_iii;var ja=b.invoke_vi;var ka=b._llvm_lifetime_end;var la=b._snprintf;var ma=b._abort;var na=b._fprintf;var oa=b._printf;var pa=b._fflush;var qa=b.__reallyNegative;var ra=b._sysconf;var sa=b.___setErrNo;var ta=b._fwrite;var ua=b._send;var va=b._write;var wa=b._exit;var xa=b._sprintf;var ya=b.__formatString;var za=b.__ZSt9terminatev;var Aa=b._pwrite;var Ba=b._sbrk;var Ca=b.___errno_location;var Da=b.___gxx_personality_v0;var Ea=b._llvm_lifetime_start;var Fa=b._time;var Ga=b.__exit;function Ha(a){a=a|0;var b=0;b=l;l=l+a|0;l=l+7&-8;return b|0}function Ia(){return l|0}function Ja(a){a=a|0;l=a}function Ka(a,b){a=a|0;b=b|0;if((r|0)==0){r=a;s=b}}function La(a){a=a|0;d[n]=d[a];d[n+1|0]=d[a+1|0];d[n+2|0]=d[a+2|0];d[n+3|0]=d[a+3|0]}function Ma(a){a=a|0;d[n]=d[a];d[n+1|0]=d[a+1|0];d[n+2|0]=d[a+2|0];d[n+3|0]=d[a+3|0];d[n+4|0]=d[a+4|0];d[n+5|0]=d[a+5|0];d[n+6|0]=d[a+6|0];d[n+7|0]=d[a+7|0]}function Na(a){a=a|0;E=a}function Oa(a){a=a|0;F=a}function Pa(a){a=a|0;G=a}function Qa(a){a=a|0;H=a}function Ra(a){a=a|0;I=a}function Sa(a){a=a|0;J=a}function Ta(a){a=a|0;K=a}function Ua(a){a=a|0;L=a}function Va(a){a=a|0;M=a}function Wa(a){a=a|0;N=a}function Xa(){}function Ya(a,b,c,d){a=a|0;b=b|0;c=c|0;d=d|0;var e=0,g=0,h=0,i=0,j=0,k=0,m=0,n=0,o=0,p=0,q=0,r=0;e=l;l=l+1032|0;g=e|0;h=e+512|0;i=e+520|0;j=a+8|0;if((f[a+4>>2]|0)>>>0>(f[j>>2]|0)>>>0){k=i|0;xa(k|0,768,(m=l,l=l+24|0,f[m>>2]=472,f[m+8>>2]=2121,f[m+16>>2]=744,m)|0)|0;l=m;oa(k|0,(m=l,l=l+1|0,l=l+7&-8,f[m>>2]=0,m)|0)|0;l=m}if((2147418112/(d>>>0)|0)>>>0<=b>>>0){k=i|0;xa(k|0,768,(m=l,l=l+24|0,f[m>>2]=472,f[m+8>>2]=2122,f[m+16>>2]=328,m)|0)|0;l=m;oa(k|0,(m=l,l=l+1|0,l=l+7&-8,f[m>>2]=0,m)|0)|0;l=m}k=f[j>>2]|0;if(k>>>0>=b>>>0){n=1;l=e;return n|0}do{if(c){o=b-1|0;if((b|0)!=0){if((o&b|0)==0){p=b;break}}q=o>>>16|o;o=q>>>8|q;q=o>>>4|o;o=q>>>2|q;p=(o>>>1|o)+1|0}else{p=b}}while(0);if(!((p|0)!=0&p>>>0>k>>>0)){k=i|0;xa(k|0,768,(m=l,l=l+24|0,f[m>>2]=472,f[m+8>>2]=2131,f[m+16>>2]=152,m)|0)|0;l=m;oa(k|0,(m=l,l=l+1|0,l=l+7&-8,f[m>>2]=0,m)|0)|0;l=m}k=aa(p,d)|0;i=a|0;a=f[i>>2]|0;if((a&7|0)!=0){b=g|0;xa(b|0,768,(m=l,l=l+24|0,f[m>>2]=472,f[m+8>>2]=2500,f[m+16>>2]=600,m)|0)|0;l=m;oa(b|0,(m=l,l=l+1|0,l=l+7&-8,f[m>>2]=0,m)|0)|0;l=m;n=0;l=e;return n|0}if(k>>>0>2147418112){b=g|0;xa(b|0,768,(m=l,l=l+24|0,f[m>>2]=472,f[m+8>>2]=2500,f[m+16>>2]=712,m)|0)|0;l=m;oa(b|0,(m=l,l=l+1|0,l=l+7&-8,f[m>>2]=0,m)|0)|0;l=m;n=0;l=e;return n|0}f[h>>2]=k;b=$a(a,k,h,1)|0;a=f[h>>2]|0;if((b&7|0)!=0){h=g|0;xa(h|0,768,(m=l,l=l+24|0,f[m>>2]=472,f[m+8>>2]=2552,f[m+16>>2]=624,m)|0)|0;l=m;oa(h|0,(m=l,l=l+1|0,l=l+7&-8,f[m>>2]=0,m)|0)|0;l=m}if((b|0)==0){n=0;l=e;return n|0}f[i>>2]=b;if(a>>>0>k>>>0){r=(a>>>0)/(d>>>0)|0}else{r=p}f[j>>2]=r;n=1;l=e;return n|0}function Za(a){a=a|0;var b=0,c=0,d=0,e=0,g=0,h=0,i=0,j=0;b=l;l=l+512|0;c=b|0;d=a+3&-4;a=(d|0)==0?4:d;if(a>>>0>2147418112){d=c|0;xa(d|0,768,(e=l,l=l+24|0,f[e>>2]=472,f[e+8>>2]=2500,f[e+16>>2]=712,e)|0)|0;l=e;oa(d|0,(e=l,l=l+1|0,l=l+7&-8,f[e>>2]=0,e)|0)|0;l=e;g=0;l=b;return g|0}d=nb(a)|0;do{if((d|0)!=0){h=f[d-4>>2]|0;i=h&3;if((i|0)==1){j=0}else{j=(h&-8)-((i|0)==0?8:4)|0}if(j>>>0<a>>>0){break}if((d&7|0)==0){g=d;l=b;return g|0}i=c|0;xa(i|0,768,(e=l,l=l+24|0,f[e>>2]=472,f[e+8>>2]=2527,f[e+16>>2]=624,e)|0)|0;l=e;oa(i|0,(e=l,l=l+1|0,l=l+7&-8,f[e>>2]=0,e)|0)|0;l=e;g=d;l=b;return g|0}}while(0);d=c|0;xa(d|0,768,(e=l,l=l+24|0,f[e>>2]=472,f[e+8>>2]=2500,f[e+16>>2]=680,e)|0)|0;l=e;oa(d|0,(e=l,l=l+1|0,l=l+7&-8,f[e>>2]=0,e)|0)|0;l=e;g=0;l=b;return g|0}function $a(a,b,c,d){a=a|0;b=b|0;c=c|0;d=d|0;var e=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0;if((a|0)==0){e=nb(b)|0;if((c|0)==0){g=e;return g|0}do{if((e|0)==0){h=0}else{i=f[e-4>>2]|0;j=i&3;if((j|0)==1){h=0;break}h=(i&-8)-((j|0)==0?8:4)|0}}while(0);f[c>>2]=h;g=e;return g|0}if((b|0)==0){ob(a);if((c|0)==0){g=0;return g|0}f[c>>2]=0;g=0;return g|0}e=pb(a,b)|0;h=(e|0)!=0;if(h|d^1){k=h?e:a;l=e}else{e=pb(a,b)|0;k=(e|0)==0?a:e;l=e}if((c|0)==0){g=l;return g|0}do{if((k|0)==0){m=0}else{e=f[k-4>>2]|0;a=e&3;if((a|0)==1){m=0;break}m=(e&-8)-((a|0)==0?8:4)|0}}while(0);f[c>>2]=m;g=l;return g|0}function _a(a,b,c){a=a|0;b=b|0;c=c|0;var e=0,h=0;if((a|0)==0|b>>>0<74|(c|0)==0){return}if((f[c>>2]|0)!=40){return}if(((g[a]|0)<<8|(g[a+1|0]|0)|0)!=18552){return}if(((g[a+2|0]|0)<<8|(g[a+3|0]|0))>>>0<74){return}e=((g[a+7|0]|0)<<16|(g[a+6|0]|0)<<24|(g[a+8|0]|0)<<8|(g[a+9|0]|0))>>>0>b>>>0?0:a;if((e|0)==0){return}f[c+4>>2]=(g[e+12|0]|0)<<8|(g[e+13|0]|0);f[c+8>>2]=(g[e+14|0]|0)<<8|(g[e+15|0]|0);f[c+12>>2]=g[e+16|0]|0;f[c+16>>2]=g[e+17|0]|0;a=e+18|0;b=c+32|0;f[b>>2]=g[a]|0;f[b+4>>2]=0;b=d[a]|0;if(b<<24>>24==0){h=8}else{h=b<<24>>24==9?8:16}f[c+20>>2]=h;f[c+24>>2]=(g[e+26|0]|0)<<16|(g[e+25|0]|0)<<24|(g[e+27|0]|0)<<8|(g[e+28|0]|0);f[c+28>>2]=(g[e+30|0]|0)<<16|(g[e+29|0]|0)<<24|(g[e+31|0]|0)<<8|(g[e+32|0]|0);return}function ab(a){a=a|0;var b=0,c=0,e=0,g=0,h=0;b=l;l=l+512|0;c=f[a+20>>2]|0;if((c|0)!=0){bb(c)}c=a+4|0;e=f[c>>2]|0;if((e|0)==0){g=a+16|0;d[g]=0;l=b;return}if((e&7|0)==0){ob(e)}else{e=b|0;xa(e|0,768,(h=l,l=l+24|0,f[h>>2]=472,f[h+8>>2]=2500,f[h+16>>2]=576,h)|0)|0;l=h;oa(e|0,(h=l,l=l+1|0,l=l+7&-8,f[h>>2]=0,h)|0)|0;l=h}f[c>>2]=0;f[a+8>>2]=0;f[a+12>>2]=0;g=a+16|0;d[g]=0;l=b;return}function bb(a){a=a|0;var b=0,c=0,d=0,e=0,g=0,h=0,i=0,j=0,k=0;b=l;l=l+1536|0;c=b|0;d=b+512|0;e=b+1024|0;if((a|0)==0){l=b;return}g=f[a+168>>2]|0;do{if((g|0)!=0){h=f[g-4>>2]|0;i=g-8|0;if((h|0)==0){j=94}else{if((h|0)!=(~f[i>>2]|0)){j=94}}if((j|0)==94){h=c|0;xa(h|0,768,(k=l,l=l+24|0,f[k>>2]=472,f[k+8>>2]=645,f[k+16>>2]=280,k)|0)|0;l=k;oa(h|0,(k=l,l=l+1|0,l=l+7&-8,f[k>>2]=0,k)|0)|0;l=k;if((i|0)==0){break}}if((i&7|0)!=0){h=c|0;xa(h|0,768,(k=l,l=l+24|0,f[k>>2]=472,f[k+8>>2]=2500,f[k+16>>2]=576,k)|0)|0;l=k;oa(h|0,(k=l,l=l+1|0,l=l+7&-8,f[k>>2]=0,k)|0)|0;l=k;break}if((i|0)==0){nb(0)|0;break}else{ob(i);break}}}while(0);c=f[a+176>>2]|0;do{if((c|0)!=0){g=f[c-4>>2]|0;i=c-8|0;if((g|0)==0){j=103}else{if((g|0)!=(~f[i>>2]|0)){j=103}}if((j|0)==103){g=e|0;xa(g|0,768,(k=l,l=l+24|0,f[k>>2]=472,f[k+8>>2]=645,f[k+16>>2]=280,k)|0)|0;l=k;oa(g|0,(k=l,l=l+1|0,l=l+7&-8,f[k>>2]=0,k)|0)|0;l=k;if((i|0)==0){break}}if((i&7|0)!=0){g=e|0;xa(g|0,768,(k=l,l=l+24|0,f[k>>2]=472,f[k+8>>2]=2500,f[k+16>>2]=576,k)|0)|0;l=k;oa(g|0,(k=l,l=l+1|0,l=l+7&-8,f[k>>2]=0,k)|0)|0;l=k;break}if((i|0)==0){nb(0)|0;break}else{ob(i);break}}}while(0);if((a&7|0)==0){ob(a);l=b;return}else{a=d|0;xa(a|0,768,(k=l,l=l+24|0,f[k>>2]=472,f[k+8>>2]=2500,f[k+16>>2]=576,k)|0)|0;l=k;oa(a|0,(k=l,l=l+1|0,l=l+7&-8,f[k>>2]=0,k)|0)|0;l=k;l=b;return}}function cb(a){a=a|0;var b=0,c=0,i=0,j=0,k=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0,P=0,Q=0,R=0;b=l;l=l+1232|0;c=b|0;i=b+512|0;j=b+576|0;k=b+648|0;m=b+720|0;n=a+8|0;o=f[n>>2]|0;if(!((o|0)!=0&o>>>0<8193)){p=m|0;xa(p|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=2998,f[q+16>>2]=496,q)|0)|0;l=q;oa(p|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q}p=a|0;f[p>>2]=o;r=a+20|0;s=f[r>>2]|0;if((s|0)==0){t=Za(180)|0;if((t|0)==0){u=0}else{sb(t+164|0,0,16);u=t}f[r>>2]=u;v=u;w=f[p>>2]|0}else{v=s;w=o}if((f[n>>2]|0)==0){n=m|0;xa(n|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=904,f[q+16>>2]=312,q)|0)|0;l=q;oa(n|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q;x=f[p>>2]|0}else{x=w}p=f[a+4>>2]|0;if(x>>>0>16){a=x;n=0;while(1){y=n+1|0;if(a>>>0>3){a=a>>>1;n=y}else{break}}a=n+2+((y|0)!=32&1<<y>>>0<x>>>0&1)|0;z=a>>>0<11?a&255:11}else{z=0}if((w|0)==0|z>>>0>11){A=0;l=b;return A|0}f[v>>2]=w;sb(j|0,0,68);a=0;while(1){x=d[p+a|0]|0;if(x<<24>>24!=0){y=j+((x&255)<<2)|0;f[y>>2]=(f[y>>2]|0)+1}y=a+1|0;if(y>>>0<w>>>0){a=y}else{B=1;C=-1;D=0;E=0;F=0;break}}while(1){a=f[j+(B<<2)>>2]|0;if((a|0)==0){f[v+28+(B-1<<2)>>2]=0;G=F;H=E;I=D;J=C}else{y=B-1|0;f[i+(y<<2)>>2]=F;x=a+F|0;n=16-B|0;f[v+28+(y<<2)>>2]=(x-1<<n|(1<<n)-1)+1;f[v+96+(y<<2)>>2]=E;f[k+(B<<2)>>2]=E;G=x;H=a+E|0;I=D>>>0>B>>>0?D:B;J=C>>>0<B>>>0?C:B}a=B+1|0;if(a>>>0<17){B=a;C=J;D=I;E=H;F=G<<1}else{break}}f[v+4>>2]=H;G=v+172|0;do{if(H>>>0>(f[G>>2]|0)>>>0){f[G>>2]=H;F=H-1|0;if((H|0)==0){K=140}else{if((F&H|0)!=0){K=140}}if((K|0)==140){E=F>>>16|F;F=E>>>8|E;E=F>>>4|F;F=E>>>2|E;E=(F>>>1|F)+1|0;f[G>>2]=E>>>0>w>>>0?w:E}E=v+176|0;F=f[E>>2]|0;do{if((F|0)!=0){D=f[F-4>>2]|0;C=F-8|0;if((D|0)==0){K=144}else{if((D|0)!=(~f[C>>2]|0)){K=144}}if((K|0)==144){D=c|0;xa(D|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=645,f[q+16>>2]=280,q)|0)|0;l=q;oa(D|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q;if((C|0)==0){break}}if((C&7|0)!=0){D=c|0;xa(D|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=2500,f[q+16>>2]=576,q)|0)|0;l=q;oa(D|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q;break}if((C|0)==0){nb(0)|0;break}else{ob(C);break}}}while(0);F=f[G>>2]|0;C=(F|0)==0?1:F;F=Za((C<<1)+8|0)|0;if((F|0)==0){f[E>>2]=0;A=0;l=b;return A|0}else{D=F+8|0;f[F+4>>2]=C;f[F>>2]=~C;f[E>>2]=D;if((D|0)==0){A=0}else{L=E;break}l=b;return A|0}}else{L=v+176|0}}while(0);G=v+24|0;d[G]=J&255;d[v+25|0]=I&255;J=c|0;c=0;do{D=d[p+c|0]|0;C=D&255;if(D<<24>>24!=0){if((f[j+(C<<2)>>2]|0)==0){xa(J|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=2274,f[q+16>>2]=136,q)|0)|0;l=q;oa(J|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q}D=k+(C<<2)|0;C=f[D>>2]|0;f[D>>2]=C+1;if(C>>>0>=H>>>0){xa(J|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=2278,f[q+16>>2]=104,q)|0)|0;l=q;oa(J|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q}e[(f[L>>2]|0)+(C<<1)>>1]=c&65535}c=c+1|0}while(c>>>0<w>>>0);w=d[G]|0;c=(w&255)>>>0<z>>>0?z:0;z=v+8|0;f[z>>2]=c;H=(c|0)!=0;if(H){k=1<<c;C=v+164|0;do{if(k>>>0>(f[C>>2]|0)>>>0){f[C>>2]=k;D=v+168|0;F=f[D>>2]|0;do{if((F|0)!=0){B=f[F-4>>2]|0;a=F-8|0;if((B|0)==0){K=169}else{if((B|0)!=(~f[a>>2]|0)){K=169}}if((K|0)==169){xa(J|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=645,f[q+16>>2]=280,q)|0)|0;l=q;oa(J|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q;if((a|0)==0){break}}if((a&7|0)!=0){xa(J|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=2500,f[q+16>>2]=576,q)|0)|0;l=q;oa(J|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q;break}if((a|0)==0){nb(0)|0;break}else{ob(a);break}}}while(0);F=k<<2;E=Za(F+8|0)|0;if((E|0)==0){f[D>>2]=0;A=0;l=b;return A|0}else{a=E+8|0;B=a;f[E+4>>2]=k;f[E>>2]=~k;f[D>>2]=B;if((a|0)==0){A=0}else{M=B;N=F;break}l=b;return A|0}}else{M=f[v+168>>2]|0;N=k<<2}}while(0);K=v+168|0;sb(M|0,-1|0,N|0);N=1;do{do{if((f[j+(N<<2)>>2]|0)!=0){M=c-N|0;C=1<<M;F=N-1|0;B=f[i+(F<<2)>>2]|0;if(!((N|0)!=0&N>>>0<17)){xa(J|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=1954,f[q+16>>2]=200,q)|0)|0;l=q;oa(J|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q}a=f[v+28+(F<<2)>>2]|0;if((a|0)==0){O=-1}else{O=(a-1|0)>>>((16-N|0)>>>0)}if(B>>>0>O>>>0){break}a=(f[v+96+(F<<2)>>2]|0)-B|0;F=N<<16;E=B;do{B=h[(f[L>>2]|0)+(a+E<<1)>>1]|0;if((g[p+B|0]|0|0)!=(N|0)){xa(J|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=2320,f[q+16>>2]=64,q)|0)|0;l=q;oa(J|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q}x=E<<M;y=B|F;B=0;do{n=B+x|0;if(n>>>0>=k>>>0){xa(J|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=2326,f[q+16>>2]=40,q)|0)|0;l=q;oa(J|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q}m=f[K>>2]|0;if((f[m+(n<<2)>>2]|0)==-1){P=m}else{xa(J|0,768,(q=l,l=l+24|0,f[q>>2]=472,f[q+8>>2]=2328,f[q+16>>2]=8,q)|0)|0;l=q;oa(J|0,(q=l,l=l+1|0,l=l+7&-8,f[q>>2]=0,q)|0)|0;l=q;P=f[K>>2]|0}f[P+(n<<2)>>2]=y;B=B+1|0}while(B>>>0<C>>>0);E=E+1|0}while(E>>>0<=O>>>0)}}while(0);N=N+1|0}while(N>>>0<=c>>>0);Q=d[G]|0}else{Q=w}w=v+96|0;f[w>>2]=(f[w>>2]|0)-(f[i>>2]|0);w=v+100|0;f[w>>2]=(f[w>>2]|0)-(f[i+4>>2]|0);w=v+104|0;f[w>>2]=(f[w>>2]|0)-(f[i+8>>2]|0);w=v+108|0;f[w>>2]=(f[w>>2]|0)-(f[i+12>>2]|0);w=v+112|0;f[w>>2]=(f[w>>2]|0)-(f[i+16>>2]|0);w=v+116|0;f[w>>2]=(f[w>>2]|0)-(f[i+20>>2]|0);w=v+120|0;f[w>>2]=(f[w>>2]|0)-(f[i+24>>2]|0);w=v+124|0;f[w>>2]=(f[w>>2]|0)-(f[i+28>>2]|0);w=v+128|0;f[w>>2]=(f[w>>2]|0)-(f[i+32>>2]|0);w=v+132|0;f[w>>2]=(f[w>>2]|0)-(f[i+36>>2]|0);w=v+136|0;f[w>>2]=(f[w>>2]|0)-(f[i+40>>2]|0);w=v+140|0;f[w>>2]=(f[w>>2]|0)-(f[i+44>>2]|0);w=v+144|0;f[w>>2]=(f[w>>2]|0)-(f[i+48>>2]|0);w=v+148|0;f[w>>2]=(f[w>>2]|0)-(f[i+52>>2]|0);w=v+152|0;f[w>>2]=(f[w>>2]|0)-(f[i+56>>2]|0);w=v+156|0;f[w>>2]=(f[w>>2]|0)-(f[i+60>>2]|0);i=v+16|0;f[i>>2]=0;w=v+20|0;f[w>>2]=Q&255;a:do{if(H){Q=c;while(1){if((Q|0)==0){break a}R=Q-1|0;if((f[j+(Q<<2)>>2]|0)==0){Q=R}else{break}}f[i>>2]=f[v+28+(R<<2)>>2];Q=c+1|0;f[w>>2]=Q;G=Q;while(1){if(G>>>0>I>>>0){break a}if((f[j+(G<<2)>>2]|0)==0){G=G+1|0}else{break}}f[w>>2]=G}}while(0);f[v+92>>2]=-1;f[v+160>>2]=1048575;f[v+12>>2]=32-(f[z>>2]|0);A=1;l=b;return A|0}function db(a,b){a=a|0;b=b|0;var c=0,e=0,h=0,i=0,j=0,k=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0,P=0,Q=0,R=0,S=0,T=0,U=0,V=0,W=0,X=0,Y=0,Z=0,$=0,_=0,aa=0,ba=0,ca=0,da=0,ea=0,fa=0,ga=0,ha=0,ia=0,ja=0;c=l;l=l+4120|0;e=c+512|0;h=c+1024|0;i=c+1536|0;j=c+2048|0;k=c+2560|0;m=c+3072|0;n=c+3584|0;o=c+4096|0;p=a+20|0;q=f[p>>2]|0;if((q|0)<14){r=a+4|0;s=a+8|0;t=a+16|0;u=c|0;v=q;while(1){w=f[r>>2]|0;if((w|0)==(f[s>>2]|0)){x=0}else{f[r>>2]=w+1;x=g[w]|0}w=v+8|0;f[p>>2]=w;if((w|0)<33){y=w}else{xa(u|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=3200,f[z+16>>2]=432,z)|0)|0;l=z;oa(u|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z;y=f[p>>2]|0}w=x<<32-y|f[t>>2];f[t>>2]=w;if((y|0)<14){v=y}else{A=y;B=w;break}}}else{A=q;B=f[a+16>>2]|0}q=a+16|0;y=B>>>18;f[q>>2]=B<<14;f[p>>2]=A-14;if((y|0)==0){f[b>>2]=0;A=b+4|0;B=f[A>>2]|0;if((B|0)!=0){if((B&7|0)==0){ob(B)}else{B=n|0;xa(B|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=2500,f[z+16>>2]=576,z)|0)|0;l=z;oa(B|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z}f[A>>2]=0;f[b+8>>2]=0;f[b+12>>2]=0}d[b+16|0]=0;A=b+20|0;B=f[A>>2]|0;if((B|0)==0){C=1;l=c;return C|0}bb(B);f[A>>2]=0;C=1;l=c;return C|0}A=b+4|0;B=b+8|0;v=f[B>>2]|0;if((v|0)!=(y|0)){if(v>>>0<=y>>>0){do{if((f[b+12>>2]|0)>>>0<y>>>0){if(Ya(A,y,(v+1|0)==(y|0),1)|0){D=f[B>>2]|0;break}d[b+16|0]=1;C=0;l=c;return C|0}else{D=v}}while(0);sb((f[A>>2]|0)+D|0,0,y-D|0)}f[B>>2]=y}D=A|0;sb(f[D>>2]|0,0,y|0);A=f[p>>2]|0;if((A|0)<5){v=a+4|0;t=a+8|0;x=m|0;m=A;while(1){u=f[v>>2]|0;if((u|0)==(f[t>>2]|0)){E=0}else{f[v>>2]=u+1;E=g[u]|0}u=m+8|0;f[p>>2]=u;if((u|0)<33){F=u}else{xa(x|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=3200,f[z+16>>2]=432,z)|0)|0;l=z;oa(x|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z;F=f[p>>2]|0}u=E<<32-F|f[q>>2];f[q>>2]=u;if((F|0)<5){m=F}else{G=F;H=u;break}}}else{G=A;H=f[q>>2]|0}A=H>>>27;f[q>>2]=H<<5;f[p>>2]=G-5;if((A|0)==0|H>>>0>2952790015){C=0;l=c;return C|0}f[o+20>>2]=0;sb(o|0,0,17);H=o+4|0;G=o+8|0;a:do{if(Ya(H,21,0,1)|0){F=f[G>>2]|0;m=f[H>>2]|0;sb(m+F|0,0,21-F|0);f[G>>2]=21;F=a+4|0;E=a+8|0;x=k|0;v=0;do{t=f[p>>2]|0;if((t|0)<3){u=t;while(1){r=f[F>>2]|0;if((r|0)==(f[E>>2]|0)){I=0}else{f[F>>2]=r+1;I=g[r]|0}r=u+8|0;f[p>>2]=r;if((r|0)<33){J=r}else{xa(x|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=3200,f[z+16>>2]=432,z)|0)|0;l=z;oa(x|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z;J=f[p>>2]|0}r=I<<32-J|f[q>>2];f[q>>2]=r;if((J|0)<3){u=J}else{K=J;L=r;break}}}else{K=t;L=f[q>>2]|0}f[q>>2]=L<<3;f[p>>2]=K-3;d[m+(g[808+v|0]|0)|0]=L>>>29&255;v=v+1|0}while(v>>>0<A>>>0);if(!(cb(o)|0)){M=0;break}v=n|0;m=h|0;x=e|0;u=j|0;r=i|0;s=0;b:while(1){w=y-s|0;N=eb(a,o)|0;do{if(N>>>0<17){if((f[B>>2]|0)>>>0<=s>>>0){xa(v|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=904,f[z+16>>2]=312,z)|0)|0;l=z;oa(v|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z}d[(f[D>>2]|0)+s|0]=N&255;O=s+1|0}else{if((N|0)==18){P=f[p>>2]|0;if((P|0)<7){Q=P;while(1){R=f[F>>2]|0;if((R|0)==(f[E>>2]|0)){S=0}else{f[F>>2]=R+1;S=g[R]|0}R=Q+8|0;f[p>>2]=R;if((R|0)<33){T=R}else{xa(r|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=3200,f[z+16>>2]=432,z)|0)|0;l=z;oa(r|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z;T=f[p>>2]|0}R=S<<32-T|f[q>>2];f[q>>2]=R;if((T|0)<7){Q=T}else{U=T;V=R;break}}}else{U=P;V=f[q>>2]|0}f[q>>2]=V<<7;f[p>>2]=U-7;Q=(V>>>25)+11|0;if(Q>>>0>w>>>0){M=0;break a}O=Q+s|0;break}else if((N|0)==17){Q=f[p>>2]|0;if((Q|0)<3){R=Q;while(1){W=f[F>>2]|0;if((W|0)==(f[E>>2]|0)){X=0}else{f[F>>2]=W+1;X=g[W]|0}W=R+8|0;f[p>>2]=W;if((W|0)<33){Y=W}else{xa(u|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=3200,f[z+16>>2]=432,z)|0)|0;l=z;oa(u|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z;Y=f[p>>2]|0}W=X<<32-Y|f[q>>2];f[q>>2]=W;if((Y|0)<3){R=Y}else{Z=Y;$=W;break}}}else{Z=Q;$=f[q>>2]|0}f[q>>2]=$<<3;f[p>>2]=Z-3;R=($>>>29)+3|0;if(R>>>0>w>>>0){M=0;break a}O=R+s|0;break}else{if((N-19|0)>>>0>=2){_=306;break b}R=f[p>>2]|0;if((N|0)==19){if((R|0)<2){P=R;while(1){W=f[F>>2]|0;if((W|0)==(f[E>>2]|0)){aa=0}else{f[F>>2]=W+1;aa=g[W]|0}W=P+8|0;f[p>>2]=W;if((W|0)<33){ba=W}else{xa(m|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=3200,f[z+16>>2]=432,z)|0)|0;l=z;oa(m|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z;ba=f[p>>2]|0}W=aa<<32-ba|f[q>>2];f[q>>2]=W;if((ba|0)<2){P=ba}else{ca=ba;da=W;break}}}else{ca=R;da=f[q>>2]|0}f[q>>2]=da<<2;
f[p>>2]=ca-2;ea=(da>>>30)+3|0}else{if((R|0)<6){P=R;while(1){Q=f[F>>2]|0;if((Q|0)==(f[E>>2]|0)){fa=0}else{f[F>>2]=Q+1;fa=g[Q]|0}Q=P+8|0;f[p>>2]=Q;if((Q|0)<33){ga=Q}else{xa(x|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=3200,f[z+16>>2]=432,z)|0)|0;l=z;oa(x|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z;ga=f[p>>2]|0}Q=fa<<32-ga|f[q>>2];f[q>>2]=Q;if((ga|0)<6){P=ga}else{ha=ga;ia=Q;break}}}else{ha=R;ia=f[q>>2]|0}f[q>>2]=ia<<6;f[p>>2]=ha-6;ea=(ia>>>26)+7|0}if((s|0)==0|ea>>>0>w>>>0){M=0;break a}P=s-1|0;if((f[B>>2]|0)>>>0<=P>>>0){xa(v|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=904,f[z+16>>2]=312,z)|0)|0;l=z;oa(v|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z}Q=d[(f[D>>2]|0)+P|0]|0;if(Q<<24>>24==0){M=0;break a}P=ea+s|0;if(s>>>0<P>>>0){ja=s}else{O=s;break}while(1){if((f[B>>2]|0)>>>0<=ja>>>0){xa(v|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=904,f[z+16>>2]=312,z)|0)|0;l=z;oa(v|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z}W=ja+1|0;d[(f[D>>2]|0)+ja|0]=Q;if(W>>>0<P>>>0){ja=W}else{O=P;break}}}}}while(0);if(O>>>0<y>>>0){s=O}else{break}}if((_|0)==306){xa(v|0,768,(z=l,l=l+24|0,f[z>>2]=472,f[z+8>>2]=3141,f[z+16>>2]=464,z)|0)|0;l=z;oa(v|0,(z=l,l=l+1|0,l=l+7&-8,f[z>>2]=0,z)|0)|0;l=z;M=0;break}if((O|0)!=(y|0)){M=0;break}M=cb(b)|0}else{d[o+16|0]=1;M=0}}while(0);ab(o);C=M;l=c;return C|0}function eb(a,b){a=a|0;b=b|0;var c=0,d=0,e=0,i=0,j=0,k=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0;c=l;l=l+512|0;d=c|0;e=f[b+20>>2]|0;i=a+20|0;j=f[i>>2]|0;do{if((j|0)<24){k=a+4|0;m=f[k>>2]|0;n=f[a+8>>2]|0;o=m>>>0<n>>>0;if((j|0)>=16){if(o){f[k>>2]=m+1;p=g[m]|0}else{p=0}f[i>>2]=j+8;q=a+16|0;r=p<<24-j|f[q>>2];f[q>>2]=r;s=r;break}if(o){t=(g[m]|0)<<8;u=m+1|0}else{t=0;u=m}if(u>>>0<n>>>0){v=g[u]|0;w=u+1|0}else{v=0;w=u}f[k>>2]=w;f[i>>2]=j+16;k=a+16|0;n=(v|t)<<16-j|f[k>>2];f[k>>2]=n;s=n}else{s=f[a+16>>2]|0}}while(0);j=a+16|0;a=(s>>>16)+1|0;do{if(a>>>0>(f[e+16>>2]|0)>>>0){t=f[e+20>>2]|0;while(1){x=t-1|0;if(a>>>0>(f[e+28+(x<<2)>>2]|0)>>>0){t=t+1|0}else{break}}v=(f[e+96+(x<<2)>>2]|0)+(s>>>((32-t|0)>>>0))|0;if(v>>>0<(f[b>>2]|0)>>>0){y=t;z=h[(f[e+176>>2]|0)+(v<<1)>>1]|0;break}v=d|0;xa(v|0,768,(A=l,l=l+24|0,f[A>>2]=472,f[A+8>>2]=3267,f[A+16>>2]=464,A)|0)|0;l=A;oa(v|0,(A=l,l=l+1|0,l=l+7&-8,f[A>>2]=0,A)|0)|0;l=A;B=0;l=c;return B|0}else{v=f[(f[e+168>>2]|0)+(s>>>((32-(f[e+8>>2]|0)|0)>>>0)<<2)>>2]|0;if((v|0)==-1){w=d|0;xa(w|0,768,(A=l,l=l+24|0,f[A>>2]=472,f[A+8>>2]=3245,f[A+16>>2]=408,A)|0)|0;l=A;oa(w|0,(A=l,l=l+1|0,l=l+7&-8,f[A>>2]=0,A)|0)|0;l=A}w=v&65535;u=v>>>16;if((f[b+8>>2]|0)>>>0<=w>>>0){v=d|0;xa(v|0,768,(A=l,l=l+24|0,f[A>>2]=472,f[A+8>>2]=903,f[A+16>>2]=312,A)|0)|0;l=A;oa(v|0,(A=l,l=l+1|0,l=l+7&-8,f[A>>2]=0,A)|0)|0;l=A}if((g[(f[b+4>>2]|0)+w|0]|0|0)==(u|0)){y=u;z=w;break}v=d|0;xa(v|0,768,(A=l,l=l+24|0,f[A>>2]=472,f[A+8>>2]=3249,f[A+16>>2]=376,A)|0)|0;l=A;oa(v|0,(A=l,l=l+1|0,l=l+7&-8,f[A>>2]=0,A)|0)|0;l=A;y=u;z=w}}while(0);f[j>>2]=f[j>>2]<<y;f[i>>2]=(f[i>>2]|0)-y;B=z;l=c;return B|0}function fb(a,b){a=a|0;b=b|0;var c=0,d=0;c=l;l=l+40|0;d=c|0;f[d>>2]=40;_a(a,b,d);l=c;return f[d+4>>2]|0}function gb(a,b){a=a|0;b=b|0;var c=0,d=0;c=l;l=l+40|0;d=c|0;f[d>>2]=40;_a(a,b,d);l=c;return f[d+8>>2]|0}function hb(a,b){a=a|0;b=b|0;var c=0,d=0;c=l;l=l+40|0;d=c|0;f[d>>2]=40;_a(a,b,d);l=c;return f[d+12>>2]|0}function ib(a,b){a=a|0;b=b|0;var c=0,d=0;c=l;l=l+40|0;d=c|0;f[d>>2]=40;_a(a,b,d);l=c;return f[d+32>>2]|0}function jb(a,b){a=a|0;b=b|0;var c=0,d=0,e=0,g=0,h=0,i=0,j=0;c=l;l=l+552|0;d=c|0;e=c+512|0;f[e>>2]=40;_a(a,b,e);b=e+32|0;e=f[b>>2]|0;a=f[b+4>>2]|0;b=9;g=0;h=0;i=0;if((e|0)==1&(a|0)==0|(e|0)==2&(a|0)==0|(e|0)==7&(a|0)==0|(e|0)==8&(a|0)==0|(e|0)==3&(a|0)==0|(e|0)==4&(a|0)==0|(e|0)==5&(a|0)==0|(e|0)==6&(a|0)==0){j=16;l=c;return j|0}else if((e|0)==(h|0)&(a|0)==(i|0)|(e|0)==(b|0)&(a|0)==(g|0)){j=8;l=c;return j|0}else{g=d|0;xa(g|0,768,(d=l,l=l+24|0,f[d>>2]=472,f[d+8>>2]=2664,f[d+16>>2]=568,d)|0)|0;l=d;oa(g|0,(d=l,l=l+1|0,l=l+7&-8,f[d>>2]=0,d)|0)|0;l=d;j=0;l=c;return j|0}return 0}function kb(a,b,c){a=a|0;b=b|0;c=c|0;var d=0,e=0,g=0,h=0,i=0,j=0,k=0,m=0,n=0,o=0;d=l;l=l+552|0;e=d|0;g=d+512|0;f[g>>2]=40;_a(a,b,g);b=(((f[g+4>>2]|0)>>>(c>>>0))+3|0)>>>2;a=(((f[g+8>>2]|0)>>>(c>>>0))+3|0)>>>2;c=g+32|0;g=f[c>>2]|0;h=f[c+4>>2]|0;c=9;i=0;j=0;k=0;if((g|0)==1&(h|0)==0|(g|0)==2&(h|0)==0|(g|0)==7&(h|0)==0|(g|0)==8&(h|0)==0|(g|0)==3&(h|0)==0|(g|0)==4&(h|0)==0|(g|0)==5&(h|0)==0|(g|0)==6&(h|0)==0){m=16;n=aa(a,b)|0;o=aa(n,m)|0;l=d;return o|0}else if((g|0)==(j|0)&(h|0)==(k|0)|(g|0)==(c|0)&(h|0)==(i|0)){m=8;n=aa(a,b)|0;o=aa(n,m)|0;l=d;return o|0}else{i=e|0;xa(i|0,768,(e=l,l=l+24|0,f[e>>2]=472,f[e+8>>2]=2664,f[e+16>>2]=568,e)|0)|0;l=e;oa(i|0,(e=l,l=l+1|0,l=l+7&-8,f[e>>2]=0,e)|0)|0;l=e;m=0;n=aa(a,b)|0;o=aa(n,m)|0;l=d;return o|0}return 0}function lb(a,b,c,i,j,k){a=a|0;b=b|0;c=c|0;i=i|0;j=j|0;k=k|0;var m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0,P=0,Q=0,R=0,S=0,T=0,U=0,V=0,W=0,X=0,Y=0,Z=0,$=0,_=0,ba=0,ca=0,da=0,ea=0,fa=0,ga=0,ha=0,ia=0,ja=0,ka=0,la=0,ma=0,na=0,pa=0,qa=0,ra=0,sa=0,ta=0,ua=0,va=0,wa=0,ya=0,za=0,Aa=0,Ba=0,Ca=0,Da=0,Ea=0,Fa=0,Ga=0,Ha=0,Ia=0,Ja=0,Ka=0,La=0,Ma=0,Na=0,Oa=0,Pa=0,Qa=0,Ra=0,Sa=0,Ta=0,Ua=0,Va=0,Wa=0,Xa=0,$a=0,bb=0,cb=0,fb=0,gb=0,hb=0,ib=0,jb=0,kb=0,lb=0,nb=0,pb=0,qb=0,rb=0,tb=0,ub=0,vb=0,wb=0,xb=0,yb=0,zb=0,Ab=0,Bb=0,Cb=0,Db=0,Eb=0,Fb=0,Gb=0,Hb=0,Ib=0,Jb=0,Kb=0,Lb=0,Mb=0,Nb=0,Ob=0,Pb=0,Qb=0,Rb=0,Sb=0,Tb=0,Ub=0,Vb=0,Wb=0,Xb=0,Yb=0,Zb=0,$b=0,_b=0,ac=0,bc=0,cc=0,dc=0,ec=0,fc=0,gc=0,hc=0,ic=0,jc=0,kc=0,lc=0,mc=0,nc=0,oc=0,pc=0,qc=0,rc=0,sc=0,tc=0,uc=0,vc=0,wc=0,xc=0,yc=0,zc=0,Ac=0,Bc=0,Cc=0,Dc=0,Ec=0,Fc=0,Gc=0,Hc=0,Ic=0,Jc=0,Kc=0,Lc=0,Mc=0;i=l;l=l+4008|0;m=i|0;n=i+16|0;o=i+32|0;p=i+56|0;q=i+960|0;r=i+1864|0;s=i+1888|0;t=i+1912|0;u=i+2112|0;v=i+2312|0;w=i+2376|0;x=i+2888|0;y=i+2936|0;z=i+3448|0;A=i+3960|0;B=i+4e3|0;f[A>>2]=40;_a(a,b,A);C=(f[A+4>>2]|0)>>>(j>>>0);D=(f[A+8>>2]|0)>>>(j>>>0);E=A+32|0;A=f[E>>2]|0;F=f[E+4>>2]|0;E=9;G=0;H=0;I=0;if((A|0)==1&(F|0)==0|(A|0)==2&(F|0)==0|(A|0)==7&(F|0)==0|(A|0)==8&(F|0)==0|(A|0)==3&(F|0)==0|(A|0)==4&(F|0)==0|(A|0)==5&(F|0)==0|(A|0)==6&(F|0)==0){J=16}else if((A|0)==(H|0)&(F|0)==(I|0)|(A|0)==(E|0)&(F|0)==(G|0)){J=8}else{G=z|0;xa(G|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=2664,f[K+16>>2]=568,K)|0)|0;l=K;oa(G|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K;J=0}G=B|0;f[G>>2]=c;a:do{if((a|0)==0|b>>>0<62){L=0}else{F=Za(300)|0;if((F|0)==0){L=0;break}E=F;f[F>>2]=519686845;A=F+4|0;f[A>>2]=0;I=F+8|0;f[I>>2]=0;H=F+88|0;sb(H|0,0,45);M=F+252|0;sb(M|0,0,13);N=F+268|0;sb(N|0,0,13);O=F+284|0;sb(O|0,0,13);sb(F+136|0,0,21);sb(F+160|0,0,21);sb(F+184|0,0,21);sb(F+208|0,0,21);sb(F+232|0,0,17);b:do{if(b>>>0<74){P=369}else{if(((g[a]|0)<<8|(g[a+1|0]|0)|0)!=18552){P=369;break}if(((g[a+2|0]|0)<<8|(g[a+3|0]|0))>>>0<74){P=369;break}Q=((g[a+7|0]|0)<<16|(g[a+6|0]|0)<<24|(g[a+8|0]|0)<<8|(g[a+9|0]|0))>>>0>b>>>0?0:a;R=H;f[R>>2]=Q;if((Q|0)==0){break}f[A>>2]=a;f[I>>2]=b;S=F+92|0;T=S;U=(g[Q+68|0]|0)<<8|(g[Q+67|0]|0)<<16|(g[Q+69|0]|0);V=a+U|0;W=(g[Q+65|0]|0)<<8|(g[Q+66|0]|0);if((W|0)==0){break}Q=S;f[Q>>2]=V;S=F+96|0;f[S>>2]=V;V=F+104|0;f[V>>2]=W;X=F+100|0;f[X>>2]=a+(W+U);U=F+108|0;f[U>>2]=0;W=F+112|0;f[W>>2]=0;if(!(db(T,F+116|0)|0)){break}Y=f[R>>2]|0;if(((g[Y+39|0]|0)<<8|(g[Y+40|0]|0)|0)==0){Z=d[Y+55|0]|0;$=d[Y+56|0]|0;if(((Z&255)<<8|$&255|0)==0){break}else{_=Z;ba=$;ca=Y}}else{if(!(db(T,F+140|0)|0)){break}if(!(db(T,F+188|0)|0)){break}Y=f[R>>2]|0;_=d[Y+55|0]|0;ba=d[Y+56|0]|0;ca=Y}if(((_&255)<<8|ba&255|0)==0){da=ca}else{if(!(db(T,F+164|0)|0)){break}if(!(db(T,F+212|0)|0)){break}da=f[R>>2]|0}Y=(g[da+39|0]|0)<<8|(g[da+40|0]|0);if((Y|0)==0){ea=da}else{$=x;Z=F+236|0;fa=F+240|0;ga=f[fa>>2]|0;if((ga|0)==(Y|0)){ha=da}else{if(ga>>>0>Y>>>0){ia=da}else{do{if((f[F+244>>2]|0)>>>0<Y>>>0){if(Ya(Z,Y,(ga+1|0)==(Y|0),4)|0){ja=f[fa>>2]|0;break}else{d[F+248|0]=1;break b}}else{ja=ga}}while(0);sb((f[Z>>2]|0)+(ja<<2)|0,0,Y-ja<<2|0);ia=f[R>>2]|0}f[fa>>2]=Y;ha=ia}ga=f[A>>2]|0;ka=(g[ha+34|0]|0)<<8|(g[ha+33|0]|0)<<16|(g[ha+35|0]|0);la=ga+ka|0;ma=(g[ha+37|0]|0)<<8|(g[ha+36|0]|0)<<16|(g[ha+38|0]|0);if((ma|0)==0){break}f[Q>>2]=la;f[S>>2]=la;f[V>>2]=ma;f[X>>2]=ga+(ma+ka);f[U>>2]=0;f[W>>2]=0;ka=x|0;sb($|0,0,17);ma=x+24|0;f[x+44>>2]=0;sb(x+20|0,0,21);ga=0;while(1){if(ga>>>0>=2){P=397;break}if(db(T,x+(ga*24|0)|0)|0){ga=ga+1|0}else{na=0;break}}if((P|0)==397){if((f[fa>>2]|0)==0){ga=w|0;xa(ga|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(ga|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}ga=0;$=0;la=0;pa=0;qa=0;ra=f[Z>>2]|0;sa=0;ta=0;while(1){ua=(eb(T,ka)|0)+ta&31;va=(eb(T,ma)|0)+ga&63;wa=(eb(T,ka)|0)+$&31;ya=(eb(T,ka)|0)+la|0;za=(eb(T,ma)|0)+pa&63;Aa=(eb(T,ka)|0)+qa&31;f[ra>>2]=va<<5|ua<<11|wa|ya<<27|za<<21|Aa<<16;Ba=sa+1|0;if(Ba>>>0<Y>>>0){ga=va;$=wa;la=ya&31;pa=za;qa=Aa;ra=ra+4|0;sa=Ba;ta=ua}else{na=1;break}}}ab(ma);ab(ka);if(!na){break}ta=v;sa=f[R>>2]|0;ra=(g[sa+47|0]|0)<<8|(g[sa+48|0]|0);qa=f[A>>2]|0;pa=(g[sa+42|0]|0)<<8|(g[sa+41|0]|0)<<16|(g[sa+43|0]|0);la=qa+pa|0;$=(g[sa+45|0]|0)<<8|(g[sa+44|0]|0)<<16|(g[sa+46|0]|0);if(($|0)==0){break}f[Q>>2]=la;f[S>>2]=la;f[V>>2]=$;f[X>>2]=qa+($+pa);f[U>>2]=0;f[W>>2]=0;f[s+20>>2]=0;sb(s|0,0,17);if(db(T,s)|0){Ca=-3;Da=-3;Ea=0}else{ab(s);break}while(1){f[t+(Ea<<2)>>2]=Ca;f[u+(Ea<<2)>>2]=Da;pa=Ca+1|0;$=(pa|0)>3;qa=Ea+1|0;if(qa>>>0<49){Ca=$?-3:pa;Da=($&1)+Da|0;Ea=qa}else{break}}sb(ta|0,0,64);ka=F+256|0;ma=f[ka>>2]|0;if((ma|0)!=(ra|0)){if(ma>>>0<=ra>>>0){do{if((f[F+260>>2]|0)>>>0<ra>>>0){if(Ya(M,ra,(ma+1|0)==(ra|0),4)|0){Fa=f[ka>>2]|0;break}else{d[F+264|0]=1;ab(s);break b}}else{Fa=ma}}while(0);sb((f[M>>2]|0)+(Fa<<2)|0,0,ra-Fa<<2|0)}f[ka>>2]=ra}if((ra|0)==0){ma=w|0;xa(ma|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(ma|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}else{ma=v|0;ta=v+4|0;qa=v+8|0;$=v+12|0;pa=v+16|0;la=v+20|0;sa=v+24|0;ga=v+28|0;Y=v+32|0;Z=v+36|0;fa=v+40|0;ua=v+44|0;Ba=v+48|0;Aa=v+52|0;za=v+56|0;ya=v+60|0;wa=f[M>>2]|0;va=0;while(1){Ga=0;do{Ha=eb(T,s)|0;Ia=Ga<<1;Ja=v+(Ia<<2)|0;f[Ja>>2]=(f[Ja>>2]|0)+(f[t+(Ha<<2)>>2]|0)&3;Ja=v+((Ia|1)<<2)|0;f[Ja>>2]=(f[Ja>>2]|0)+(f[u+(Ha<<2)>>2]|0)&3;Ga=Ga+1|0}while(Ga>>>0<8);f[wa>>2]=(g[880+(f[ta>>2]|0)|0]|0)<<2|(g[880+(f[ma>>2]|0)|0]|0)|(g[880+(f[qa>>2]|0)|0]|0)<<4|(g[880+(f[$>>2]|0)|0]|0)<<6|(g[880+(f[pa>>2]|0)|0]|0)<<8|(g[880+(f[la>>2]|0)|0]|0)<<10|(g[880+(f[sa>>2]|0)|0]|0)<<12|(g[880+(f[ga>>2]|0)|0]|0)<<14|(g[880+(f[Y>>2]|0)|0]|0)<<16|(g[880+(f[Z>>2]|0)|0]|0)<<18|(g[880+(f[fa>>2]|0)|0]|0)<<20|(g[880+(f[ua>>2]|0)|0]|0)<<22|(g[880+(f[Ba>>2]|0)|0]|0)<<24|(g[880+(f[Aa>>2]|0)|0]|0)<<26|(g[880+(f[za>>2]|0)|0]|0)<<28|(g[880+(f[ya>>2]|0)|0]|0)<<30;Ga=va+1|0;if(Ga>>>0<ra>>>0){wa=wa+4|0;va=Ga}else{break}}}ab(s);ea=f[R>>2]|0}va=(g[ea+55|0]|0)<<8|(g[ea+56|0]|0);if((va|0)==0){L=F;break a}wa=f[A>>2]|0;ra=(g[ea+50|0]|0)<<8|(g[ea+49|0]|0)<<16|(g[ea+51|0]|0);ya=wa+ra|0;za=(g[ea+53|0]|0)<<8|(g[ea+52|0]|0)<<16|(g[ea+54|0]|0);if((za|0)==0){break}f[Q>>2]=ya;f[S>>2]=ya;f[V>>2]=za;f[X>>2]=wa+(za+ra);f[U>>2]=0;f[W>>2]=0;f[r+20>>2]=0;sb(r|0,0,17);c:do{if(db(T,r)|0){ra=F+272|0;za=f[ra>>2]|0;if((za|0)!=(va|0)){if(za>>>0<=va>>>0){do{if((f[F+276>>2]|0)>>>0<va>>>0){if(Ya(N,va,(za+1|0)==(va|0),2)|0){Ka=f[ra>>2]|0;break}else{d[F+280|0]=1;break c}}else{Ka=za}}while(0);sb((f[N>>2]|0)+(Ka<<1)|0,0,va-Ka<<1|0)}f[ra>>2]=va}za=f[N>>2]|0;wa=0;ya=0;Aa=0;while(1){Ba=eb(T,r)|0;ua=Ba+wa&255;Ba=(eb(T,r)|0)+ya&255;e[za>>1]=(Ba<<8|ua)&65535;fa=Aa+1|0;if(fa>>>0<va>>>0){za=za+2|0;wa=ua;ya=Ba;Aa=fa}else{break}}ab(r);Aa=v;ya=f[R>>2]|0;wa=(g[ya+63|0]|0)<<8|(g[ya+64|0]|0);za=f[A>>2]|0;ra=(g[ya+58|0]|0)<<8|(g[ya+57|0]|0)<<16|(g[ya+59|0]|0);fa=za+ra|0;Ba=(g[ya+61|0]|0)<<8|(g[ya+60|0]|0)<<16|(g[ya+62|0]|0);if((Ba|0)==0){La=0}else{f[Q>>2]=fa;f[S>>2]=fa;f[V>>2]=Ba;f[X>>2]=za+(Ba+ra);f[U>>2]=0;f[W>>2]=0;f[o+20>>2]=0;sb(o|0,0,17);d:do{if(db(T,o)|0){ra=-7;Ba=-7;za=0;while(1){f[p+(za<<2)>>2]=ra;f[q+(za<<2)>>2]=Ba;fa=ra+1|0;ya=(fa|0)>7;ua=za+1|0;if(ua>>>0<225){ra=ya?-7:fa;Ba=(ya&1)+Ba|0;za=ua}else{break}}sb(Aa|0,0,64);za=wa*3|0;Ba=F+288|0;ra=f[Ba>>2]|0;if((ra|0)!=(za|0)){if(ra>>>0<=za>>>0){do{if((f[F+292>>2]|0)>>>0<za>>>0){if(Ya(O,za,(ra+1|0)==(za|0),2)|0){Ma=f[Ba>>2]|0;break}else{d[F+296|0]=1;Na=0;break d}}else{Ma=ra}}while(0);sb((f[O>>2]|0)+(Ma<<1)|0,0,za-Ma<<1|0)}f[Ba>>2]=za}if((za|0)==0){ra=w|0;xa(ra|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(ra|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}if((wa|0)==0){Na=1;break}ra=v|0;ua=v+4|0;ya=v+8|0;fa=v+12|0;Z=v+16|0;Y=v+20|0;ga=v+24|0;sa=v+28|0;la=v+32|0;pa=v+36|0;$=v+40|0;qa=v+44|0;ma=v+48|0;ta=v+52|0;ka=v+56|0;Ga=v+60|0;Ha=f[O>>2]|0;Ja=0;while(1){Ia=0;do{Oa=eb(T,o)|0;Pa=Ia<<1;Qa=v+(Pa<<2)|0;f[Qa>>2]=(f[Qa>>2]|0)+(f[p+(Oa<<2)>>2]|0)&7;Qa=v+((Pa|1)<<2)|0;f[Qa>>2]=(f[Qa>>2]|0)+(f[q+(Oa<<2)>>2]|0)&7;Ia=Ia+1|0}while(Ia>>>0<8);e[Ha>>1]=(g[872+(f[ua>>2]|0)|0]|0)<<3|(g[872+(f[ra>>2]|0)|0]|0)|(g[872+(f[ya>>2]|0)|0]|0)<<6|(g[872+(f[fa>>2]|0)|0]|0)<<9|(g[872+(f[Z>>2]|0)|0]|0)<<12|(g[872+(f[Y>>2]|0)|0]|0)<<15;e[Ha+2>>1]=(g[872+(f[ga>>2]|0)|0]|0)<<2|(d[872+(f[Y>>2]|0)|0]&255)>>>1|(g[872+(f[sa>>2]|0)|0]|0)<<5|(g[872+(f[la>>2]|0)|0]|0)<<8|(g[872+(f[pa>>2]|0)|0]|0)<<11|(g[872+(f[$>>2]|0)|0]|0)<<14;e[Ha+4>>1]=(g[872+(f[qa>>2]|0)|0]|0)<<1|(d[872+(f[$>>2]|0)|0]&255)>>>2|(g[872+(f[ma>>2]|0)|0]|0)<<4|(g[872+(f[ta>>2]|0)|0]|0)<<7|(g[872+(f[ka>>2]|0)|0]|0)<<10|(g[872+(f[Ga>>2]|0)|0]|0)<<13;Ia=Ja+1|0;if(Ia>>>0<wa>>>0){Ha=Ha+6|0;Ja=Ia}else{Na=1;break}}}else{Na=0}}while(0);ab(o);La=Na}if(La){L=La?F:0;break a}else{break b}}}while(0);ab(r)}}while(0);if((P|0)==369){f[H>>2]=0}mb(E);if((F&7|0)==0){ob(F);L=0;break}else{O=y|0;xa(O|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=2500,f[K+16>>2]=576,K)|0)|0;l=K;oa(O|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K;L=0;break}}}while(0);r=k+j|0;do{if(r>>>0>j>>>0){k=L;if((L|0)==0){La=j;Na=D;o=C;q=c;while(1){Ra=q+(aa(aa((o+3|0)>>>2,J)|0,(Na+3|0)>>>2)|0)|0;v=La+1|0;if(v>>>0<r>>>0){La=v;Na=Na>>>1;o=o>>>1;q=Ra}else{break}}f[G>>2]=Ra;break}q=L+88|0;o=L+8|0;Na=L+4|0;La=L+92|0;F=La;E=L+96|0;H=L+104|0;v=L+100|0;p=L+108|0;Ma=L+112|0;Ka=L+240|0;ea=L+256|0;s=La;La=L+116|0;u=L+140|0;t=L+236|0;Fa=w|0;Ea=L+188|0;Da=L+252|0;Ca=L+272|0;na=L+212|0;x=L+288|0;ha=L+284|0;ia=L+164|0;ja=L+268|0;da=y|0;ca=j;ba=D;_=C;a=c;while(1){b=aa((_+3|0)>>>2,J)|0;O=aa(b,(ba+3|0)>>>2)|0;do{if(O>>>0<8|ca>>>0>15){Sa=a}else{if((f[k>>2]|0)!=519686845){Sa=a;break}A=f[q>>2]|0;N=(g[A+70+(ca<<2)+1|0]|0)<<16|(g[A+70+(ca<<2)|0]|0)<<24|(g[A+70+(ca<<2)+2|0]|0)<<8|(g[A+70+(ca<<2)+3|0]|0);M=ca+1|0;if(M>>>0<(g[A+16|0]|0)>>>0){Ta=(g[A+70+(M<<2)+1|0]|0)<<16|(g[A+70+(M<<2)|0]|0)<<24|(g[A+70+(M<<2)+2|0]|0)<<8|(g[A+70+(M<<2)+3|0]|0)}else{Ta=f[o>>2]|0}if(Ta>>>0>N>>>0){Ua=A}else{xa(da|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=3705,f[K+16>>2]=248,K)|0)|0;l=K;oa(da|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K;Ua=f[q>>2]|0}A=f[Na>>2]|0;M=A+N|0;I=Ta-N|0;T=((g[Ua+12|0]|0)<<8|(g[Ua+13|0]|0))>>>(ca>>>0);W=((g[Ua+14|0]|0)<<8|(g[Ua+15|0]|0))>>>(ca>>>0);U=T>>>0>1?(T+3|0)>>>2:1;T=W>>>0>1?(W+3|0)>>>2:1;W=Ua+18|0;X=d[W]|0;if(X<<24>>24==0){Va=8}else{Va=X<<24>>24==9?8:16}X=aa(Va,U)|0;if((b|0)==0){Wa=X;P=494}else{if(X>>>0<=b>>>0){Wa=b;P=494}}a:do{if((P|0)==494){P=0;if((aa(Wa,T)|0)>>>0>O>>>0){break}X=(U+1|0)>>>1;V=(T+1|0)>>>1;if((Ta|0)==(N|0)){break}f[F>>2]=M;f[E>>2]=M;f[H>>2]=I;f[v>>2]=A+Ta;f[p>>2]=0;f[Ma>>2]=0;switch(g[W]|0|0){case 0:{S=f[Ka>>2]|0;Q=f[ea>>2]|0;R=d[Ua+17|0]|0;va=R&255;wa=Wa>>>2;if(R<<24>>24==0){break a}R=(V|0)==0;Aa=V-1|0;Ja=(T&1|0)!=0;Ha=Wa<<1;Ga=wa+1|0;ka=wa+2|0;ta=wa+3|0;ma=X-1|0;$=ma<<4;qa=(U&1|0)!=0;pa=Wa+4|0;la=0;sa=0;Y=0;ga=1;while(1){if(R){Xa=la;$a=sa;bb=ga}else{Z=la;fa=sa;ya=0;ra=f[B+(Y<<2)>>2]|0;ua=ga;while(1){if((ya&1|0)==0){cb=0;fb=X;gb=1;hb=16;ib=ra}else{cb=ma;fb=-1;gb=-1;hb=-16;ib=ra+$|0}za=(ya|0)==(Aa|0);Ba=za&Ja;if((cb|0)==(fb|0)){jb=Z;kb=fa;lb=ua}else{Ia=za&Ja^1;za=Z;Oa=fa;Qa=cb;Pa=ib;nb=ua;while(1){if((nb|0)==1){pb=eb(s,La)|0|512}else{pb=nb}qb=pb&7;rb=g[832+qb|0]|0;tb=za;ub=0;do{vb=(eb(s,u)|0)+tb|0;wb=vb-S|0;xb=wb>>31;tb=xb&vb|wb&~xb;if((f[Ka>>2]|0)>>>0<=tb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[n+(ub<<2)>>2]=f[(f[t>>2]|0)+(tb<<2)>>2];ub=ub+1|0}while(ub>>>0<rb>>>0);rb=pb>>>3;ub=(Qa|0)==(ma|0)&qa;xb=Pa;do{if(Ba|ub){if(ub){wb=(eb(s,Ea)|0)+Oa|0;vb=wb-Q|0;yb=vb>>31;zb=yb&wb|vb&~yb;f[xb>>2]=f[n+((g[840+(qb<<2)|0]|0)<<2)>>2];if((f[ea>>2]|0)>>>0<=zb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[Pa+4>>2]=f[(f[Da>>2]|0)+(zb<<2)>>2];yb=(eb(s,Ea)|0)+zb|0;zb=yb-Q|0;vb=zb>>31;wb=(eb(s,Ea)|0)+(vb&yb|zb&~vb)|0;vb=wb-Q|0;zb=vb>>31;yb=zb&wb|vb&~zb;if(Ba){zb=(eb(s,Ea)|0)+yb|0;vb=zb-Q|0;wb=vb>>31;Ab=wb&zb|vb&~wb;break}f[Pa+Wa>>2]=f[n+((g[842+(qb<<2)|0]|0)<<2)>>2];if((f[ea>>2]|0)>>>0<=yb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[Pa+pa>>2]=f[(f[Da>>2]|0)+(yb<<2)>>2];wb=(eb(s,Ea)|0)+yb|0;yb=wb-Q|0;vb=yb>>31;Ab=vb&wb|yb&~vb;break}else{Bb=Oa;Cb=0}while(1){vb=aa(Cb,Wa)|0;yb=Cb<<1;wb=(eb(s,Ea)|0)+Bb|0;zb=wb-Q|0;Db=zb>>31;Eb=Db&wb|zb&~Db;if((Cb|0)==0|Ia){f[Pa+vb>>2]=f[n+((g[840+(qb<<2)+yb|0]|0)<<2)>>2];if((f[ea>>2]|0)>>>0<=Eb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[Pa+(vb+4)>>2]=f[(f[Da>>2]|0)+(Eb<<2)>>2];Db=(eb(s,Ea)|0)+Eb|0;zb=Db-Q|0;wb=zb>>31;Fb=wb&Db|zb&~wb;f[Pa+(vb+8)>>2]=f[n+((g[(yb|1)+(840+(qb<<2))|0]|0)<<2)>>2];if((f[ea>>2]|0)>>>0<=Fb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[Pa+(vb+12)>>2]=f[(f[Da>>2]|0)+(Fb<<2)>>2];Gb=Fb}else{Fb=(eb(s,Ea)|0)+Eb|0;Eb=Fb-Q|0;vb=Eb>>31;Gb=vb&Fb|Eb&~vb}vb=Cb+1|0;if(vb>>>0<2){Bb=Gb;Cb=vb}else{Ab=Gb;break}}}else{f[xb>>2]=f[n+((g[840+(qb<<2)|0]|0)<<2)>>2];vb=(eb(s,Ea)|0)+Oa|0;Eb=vb-Q|0;Fb=Eb>>31;yb=Fb&vb|Eb&~Fb;if((f[ea>>2]|0)>>>0<=yb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[Pa+4>>2]=f[(f[Da>>2]|0)+(yb<<2)>>2];f[Pa+8>>2]=f[n+((g[841+(qb<<2)|0]|0)<<2)>>2];Fb=(eb(s,Ea)|0)+yb|0;yb=Fb-Q|0;Eb=yb>>31;vb=Eb&Fb|yb&~Eb;if((f[ea>>2]|0)>>>0<=vb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[Pa+12>>2]=f[(f[Da>>2]|0)+(vb<<2)>>2];f[xb+(wa<<2)>>2]=f[n+((g[842+(qb<<2)|0]|0)<<2)>>2];Eb=(eb(s,Ea)|0)+vb|0;vb=Eb-Q|0;yb=vb>>31;Fb=yb&Eb|vb&~yb;if((f[ea>>2]|0)>>>0<=Fb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[xb+(Ga<<2)>>2]=f[(f[Da>>2]|0)+(Fb<<2)>>2];f[xb+(ka<<2)>>2]=f[n+((g[843+(qb<<2)|0]|0)<<2)>>2];yb=(eb(s,Ea)|0)+Fb|0;Fb=yb-Q|0;vb=Fb>>31;Eb=vb&yb|Fb&~vb;if((f[ea>>2]|0)>>>0<=Eb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[xb+(ta<<2)>>2]=f[(f[Da>>2]|0)+(Eb<<2)>>2];Ab=Eb}}while(0);xb=Qa+gb|0;if((xb|0)==(fb|0)){jb=tb;kb=Ab;lb=rb;break}else{za=tb;Oa=Ab;Qa=xb;Pa=Pa+hb|0;nb=rb}}}nb=ya+1|0;if(nb>>>0<V>>>0){Z=jb;fa=kb;ya=nb;ra=ra+Ha|0;ua=lb}else{Xa=jb;$a=kb;bb=lb;break}}}ua=Y+1|0;if(ua>>>0<va>>>0){la=Xa;sa=$a;Y=ua;ga=bb}else{break}}break};case 2:case 3:case 5:case 6:case 4:{ga=f[Ka>>2]|0;Y=f[ea>>2]|0;sa=f[Ca>>2]|0;la=(g[Ua+63|0]|0)<<8|(g[Ua+64|0]|0);va=d[Ua+17|0]|0;Ha=va&255;if(va<<24>>24==0){break a}va=(V|0)==0;ta=V-1|0;Q=(T&1|0)==0;ka=Wa<<1;Ga=(U&1|0)==0;wa=X-1|0;pa=wa<<5;qa=0;ma=0;S=0;Ja=0;Aa=0;$=1;while(1){if(va){Hb=qa;Ib=ma;Jb=S;Kb=Ja;Lb=$}else{R=qa;ua=ma;ra=S;ya=Ja;fa=0;Z=f[B+(Aa<<2)>>2]|0;nb=$;while(1){if((fa&1|0)==0){Mb=0;Nb=X;Ob=1;Pb=32;Qb=Z}else{Mb=wa;Nb=-1;Ob=-1;Pb=-32;Qb=Z+pa|0}Pa=Q|(fa|0)!=(ta|0);if((Mb|0)==(Nb|0)){Rb=R;Sb=ua;Tb=ra;Ub=ya;Vb=nb}else{Qa=R;Oa=ua;za=ra;Ia=ya;Ba=Mb;xb=Qb;qb=nb;while(1){if((qb|0)==1){Wb=eb(s,La)|0|512}else{Wb=qb}ub=Wb&7;Eb=g[832+ub|0]|0;vb=(Ba|0)!=(wa|0);Fb=za;yb=0;do{wb=(eb(s,ia)|0)+Fb|0;zb=wb-sa|0;Db=zb>>31;Fb=Db&wb|zb&~Db;if((f[Ca>>2]|0)>>>0<=Fb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[m+(yb<<2)>>2]=h[(f[ja>>2]|0)+(Fb<<1)>>1]|0;yb=yb+1|0}while(yb>>>0<Eb>>>0);yb=Wb>>>3;rb=Qa;tb=0;do{Db=(eb(s,u)|0)+rb|0;zb=Db-ga|0;wb=zb>>31;rb=wb&Db|zb&~wb;if((f[Ka>>2]|0)>>>0<=rb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[n+(tb<<2)>>2]=f[(f[t>>2]|0)+(rb<<2)>>2];tb=tb+1|0}while(tb>>>0<Eb>>>0);Eb=Ga|vb;tb=Oa;wb=Ia;zb=xb;Db=0;while(1){Xb=(Db|0)==0|Pa;Yb=Db<<1;Zb=tb;$b=wb;_b=zb;ac=0;while(1){bc=(eb(s,na)|0)+$b|0;cc=bc-la|0;dc=cc>>31;ec=dc&bc|cc&~dc;dc=(eb(s,Ea)|0)+Zb|0;cc=dc-Y|0;bc=cc>>31;fc=bc&dc|cc&~bc;if(((ac|0)==0|Eb)&Xb){bc=g[ac+Yb+(840+(ub<<2))|0]|0;cc=ec*3|0;if((f[x>>2]|0)>>>0<=cc>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}dc=f[ha>>2]|0;f[_b>>2]=(h[dc+(cc<<1)>>1]|0)<<16|f[m+(bc<<2)>>2];f[_b+4>>2]=(h[dc+(cc+2<<1)>>1]|0)<<16|(h[dc+(cc+1<<1)>>1]|0);f[_b+8>>2]=f[n+(bc<<2)>>2];if((f[ea>>2]|0)>>>0<=fc>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[_b+12>>2]=f[(f[Da>>2]|0)+(fc<<2)>>2]}bc=ac+1|0;if(bc>>>0<2){Zb=fc;$b=ec;_b=_b+16|0;ac=bc}else{break}}ac=Db+1|0;if(ac>>>0<2){tb=fc;wb=ec;zb=zb+Wa|0;Db=ac}else{break}}Db=Ba+Ob|0;if((Db|0)==(Nb|0)){Rb=rb;Sb=fc;Tb=Fb;Ub=ec;Vb=yb;break}else{Qa=rb;Oa=fc;za=Fb;Ia=ec;Ba=Db;xb=xb+Pb|0;qb=yb}}}qb=fa+1|0;if(qb>>>0<V>>>0){R=Rb;ua=Sb;ra=Tb;ya=Ub;fa=qb;Z=Z+ka|0;nb=Vb}else{Hb=Rb;Ib=Sb;Jb=Tb;Kb=Ub;Lb=Vb;break}}}nb=Aa+1|0;if(nb>>>0<Ha>>>0){qa=Hb;ma=Ib;S=Jb;Ja=Kb;Aa=nb;$=Lb}else{break}}break};case 9:{$=f[Ca>>2]|0;Aa=(g[Ua+63|0]|0)<<8|(g[Ua+64|0]|0);Ja=d[Ua+17|0]|0;S=Ja&255;if(Ja<<24>>24==0){break a}Ja=(V|0)==0;ma=V-1|0;qa=(T&1|0)==0;Ha=Wa<<1;ka=X-1|0;Y=ka<<4;la=(U&1|0)!=0;Ga=0;ga=0;sa=0;wa=1;while(1){if(Ja){gc=Ga;hc=ga;ic=wa}else{ta=Ga;Q=ga;pa=0;va=f[B+(sa<<2)>>2]|0;nb=wa;while(1){if((pa&1|0)==0){jc=0;kc=X;lc=1;mc=16;nc=va}else{jc=ka;kc=-1;lc=-1;mc=-16;nc=va+Y|0}Z=qa|(pa|0)!=(ma|0);if((jc|0)==(kc|0)){oc=ta;pc=Q;qc=nb}else{fa=ta;ya=Q;ra=nc;ua=jc;R=nb;while(1){if((R|0)==1){rc=eb(s,La)|0|512}else{rc=R}qb=rc&7;xb=g[832+qb|0]|0;Ba=fa;Ia=0;do{za=(eb(s,ia)|0)+Ba|0;Oa=za-$|0;Qa=Oa>>31;Ba=Qa&za|Oa&~Qa;if((f[Ca>>2]|0)>>>0<=Ba>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[n+(Ia<<2)>>2]=h[(f[ja>>2]|0)+(Ba<<1)>>1]|0;Ia=Ia+1|0}while(Ia>>>0<xb>>>0);xb=(ua|0)==(ka|0)&la;Ia=ya;yb=ra;Fb=0;while(1){rb=yb;Qa=(Fb|0)==0|Z;Oa=Fb<<1;za=(eb(s,na)|0)+Ia|0;Pa=za-Aa|0;Db=Pa>>31;zb=Db&za|Pa&~Db;if(Qa){Db=g[840+(qb<<2)+Oa|0]|0;Pa=zb*3|0;if((f[x>>2]|0)>>>0<=Pa>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}za=f[ha>>2]|0;f[rb>>2]=(h[za+(Pa<<1)>>1]|0)<<16|f[n+(Db<<2)>>2];f[yb+4>>2]=(h[za+(Pa+2<<1)>>1]|0)<<16|(h[za+(Pa+1<<1)>>1]|0)}Pa=yb+8|0;za=(eb(s,na)|0)+zb|0;zb=za-Aa|0;Db=zb>>31;sc=Db&za|zb&~Db;if(!(xb|Qa^1)){Qa=g[(Oa|1)+(840+(qb<<2))|0]|0;Oa=sc*3|0;if((f[x>>2]|0)>>>0<=Oa>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}Db=f[ha>>2]|0;f[Pa>>2]=(h[Db+(Oa<<1)>>1]|0)<<16|f[n+(Qa<<2)>>2];f[yb+12>>2]=(h[Db+(Oa+2<<1)>>1]|0)<<16|(h[Db+(Oa+1<<1)>>1]|0)}Oa=Fb+1|0;if(Oa>>>0<2){Ia=sc;yb=yb+Wa|0;Fb=Oa}else{break}}Fb=rc>>>3;yb=ua+lc|0;if((yb|0)==(kc|0)){oc=Ba;pc=sc;qc=Fb;break}else{fa=Ba;ya=sc;ra=ra+mc|0;ua=yb;R=Fb}}}R=pa+1|0;if(R>>>0<V>>>0){ta=oc;Q=pc;pa=R;va=va+Ha|0;nb=qc}else{gc=oc;hc=pc;ic=qc;break}}}nb=sa+1|0;if(nb>>>0<S>>>0){Ga=gc;ga=hc;sa=nb;wa=ic}else{break}}break};case 7:case 8:{wa=f[Ca>>2]|0;sa=(g[Ua+63|0]|0)<<8|(g[Ua+64|0]|0);ga=d[Ua+17|0]|0;Ga=ga&255;if(ga<<24>>24==0){break a}ga=(V|0)==0;S=V-1|0;Ha=(T&1|0)==0;Aa=Wa<<1;la=(U&1|0)==0;ka=X-1|0;$=ka<<5;ma=0;qa=0;Y=0;Ja=0;nb=0;va=1;while(1){if(ga){tc=ma;uc=qa;vc=Y;wc=Ja;xc=va}else{pa=ma;Q=qa;ta=Y;R=Ja;ua=0;ra=f[B+(nb<<2)>>2]|0;ya=va;while(1){if((ua&1|0)==0){yc=0;zc=X;Ac=1;Bc=32;Cc=ra}else{yc=ka;zc=-1;Ac=-1;Bc=-32;Cc=ra+$|0}fa=Ha|(ua|0)!=(S|0);if((yc|0)==(zc|0)){Dc=pa;Ec=Q;Fc=ta;Gc=R;Hc=ya}else{Z=pa;Fb=Q;yb=ta;Ia=R;qb=yc;xb=Cc;Oa=ya;while(1){if((Oa|0)==1){Ic=eb(s,La)|0|512}else{Ic=Oa}Db=Ic&7;Qa=g[832+Db|0]|0;Pa=(qb|0)!=(ka|0);zb=Z;za=0;do{rb=(eb(s,ia)|0)+zb|0;wb=rb-wa|0;tb=wb>>31;zb=tb&rb|wb&~tb;if((f[Ca>>2]|0)>>>0<=zb>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[n+(za<<2)>>2]=h[(f[ja>>2]|0)+(zb<<1)>>1]|0;za=za+1|0}while(za>>>0<Qa>>>0);za=Ic>>>3;Ba=yb;tb=0;do{wb=(eb(s,ia)|0)+Ba|0;rb=wb-wa|0;ub=rb>>31;Ba=ub&wb|rb&~ub;if((f[Ca>>2]|0)>>>0<=Ba>>>0){xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K}f[m+(tb<<2)>>2]=h[(f[ja>>2]|0)+(Ba<<1)>>1]|0;tb=tb+1|0}while(tb>>>0<Qa>>>0);Qa=la|Pa;tb=Fb;ub=Ia;rb=xb;wb=0;while(1){Eb=(wb|0)==0|fa;vb=wb<<1;ac=tb;_b=ub;$b=rb;Zb=0;while(1){Yb=(eb(s,na)|0)+ac|0;Xb=Yb-sa|0;bc=Xb>>31;Jc=bc&Yb|Xb&~bc;bc=(eb(s,na)|0)+_b|0;Xb=bc-sa|0;Yb=Xb>>31;Kc=Yb&bc|Xb&~Yb;if(((Zb|0)==0|Qa)&Eb){Yb=g[Zb+vb+(840+(Db<<2))|0]|0;Xb=Jc*3|0;bc=f[x>>2]|0;if(bc>>>0>Xb>>>0){Lc=bc}else{xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K;Lc=f[x>>2]|0}bc=f[ha>>2]|0;cc=Kc*3|0;if(Lc>>>0>cc>>>0){Mc=bc}else{xa(Fa|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=904,f[K+16>>2]=312,K)|0)|0;l=K;oa(Fa|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K;Mc=f[ha>>2]|0}f[$b>>2]=(h[bc+(Xb<<1)>>1]|0)<<16|f[n+(Yb<<2)>>2];f[$b+4>>2]=(h[bc+(Xb+2<<1)>>1]|0)<<16|(h[bc+(Xb+1<<1)>>1]|0);f[$b+8>>2]=(h[Mc+(cc<<1)>>1]|0)<<16|f[m+(Yb<<2)>>2];f[$b+12>>2]=(h[Mc+(cc+2<<1)>>1]|0)<<16|(h[Mc+(cc+1<<1)>>1]|0)}cc=Zb+1|0;if(cc>>>0<2){ac=Jc;_b=Kc;$b=$b+16|0;Zb=cc}else{break}}Zb=wb+1|0;if(Zb>>>0<2){tb=Jc;ub=Kc;rb=rb+Wa|0;wb=Zb}else{break}}wb=qb+Ac|0;if((wb|0)==(zc|0)){Dc=zb;Ec=Jc;Fc=Ba;Gc=Kc;Hc=za;break}else{Z=zb;Fb=Jc;yb=Ba;Ia=Kc;qb=wb;xb=xb+Bc|0;Oa=za}}}Oa=ua+1|0;if(Oa>>>0<V>>>0){pa=Dc;Q=Ec;ta=Fc;R=Gc;ua=Oa;ra=ra+Aa|0;ya=Hc}else{tc=Dc;uc=Ec;vc=Fc;wc=Gc;xc=Hc;break}}}ya=nb+1|0;if(ya>>>0<Ga>>>0){ma=tc;qa=uc;Y=vc;Ja=wc;nb=ya;va=xc}else{break}}break};default:{break a}}}}while(0);Sa=f[G>>2]|0}}while(0);b=Sa+O|0;f[G>>2]=b;U=ca+1|0;if(U>>>0<r>>>0){ca=U;ba=ba>>>1;_=_>>>1;a=b}else{break}}}}while(0);if((L|0)==0){l=i;return}if((f[L>>2]|0)!=519686845){l=i;return}mb(L);if((L&7|0)==0){ob(L);l=i;return}else{L=z|0;xa(L|0,768,(K=l,l=l+24|0,f[K>>2]=472,f[K+8>>2]=2500,f[K+16>>2]=576,K)|0)|0;l=K;oa(L|0,(K=l,l=l+1|0,l=l+7&-8,f[K>>2]=0,K)|0)|0;l=K;l=i;return}}function mb(a){a=a|0;var b=0,c=0,e=0,g=0,h=0;b=l;l=l+512|0;c=b|0;f[a>>2]=0;e=a+284|0;g=f[e>>2]|0;if((g|0)!=0){if((g&7|0)==0){ob(g)}else{g=c|0;xa(g|0,768,(h=l,l=l+24|0,f[h>>2]=472,f[h+8>>2]=2500,f[h+16>>2]=576,h)|0)|0;l=h;oa(g|0,(h=l,l=l+1|0,l=l+7&-8,f[h>>2]=0,h)|0)|0;l=h}f[e>>2]=0;f[a+288>>2]=0;f[a+292>>2]=0}d[a+296|0]=0;e=a+268|0;g=f[e>>2]|0;if((g|0)!=0){if((g&7|0)==0){ob(g)}else{g=c|0;xa(g|0,768,(h=l,l=l+24|0,f[h>>2]=472,f[h+8>>2]=2500,f[h+16>>2]=576,h)|0)|0;l=h;oa(g|0,(h=l,l=l+1|0,l=l+7&-8,f[h>>2]=0,h)|0)|0;l=h}f[e>>2]=0;f[a+272>>2]=0;f[a+276>>2]=0}d[a+280|0]=0;e=a+252|0;g=f[e>>2]|0;if((g|0)!=0){if((g&7|0)==0){ob(g)}else{g=c|0;xa(g|0,768,(h=l,l=l+24|0,f[h>>2]=472,f[h+8>>2]=2500,f[h+16>>2]=576,h)|0)|0;l=h;oa(g|0,(h=l,l=l+1|0,l=l+7&-8,f[h>>2]=0,h)|0)|0;l=h}f[e>>2]=0;f[a+256>>2]=0;f[a+260>>2]=0}d[a+264|0]=0;e=a+236|0;g=f[e>>2]|0;if((g|0)!=0){if((g&7|0)==0){ob(g)}else{g=c|0;xa(g|0,768,(h=l,l=l+24|0,f[h>>2]=472,f[h+8>>2]=2500,f[h+16>>2]=576,h)|0)|0;l=h;oa(g|0,(h=l,l=l+1|0,l=l+7&-8,f[h>>2]=0,h)|0)|0;l=h}f[e>>2]=0;f[a+240>>2]=0;f[a+244>>2]=0}d[a+248|0]=0;ab(a+212|0);ab(a+188|0);ab(a+164|0);ab(a+140|0);ab(a+116|0);l=b;return}function nb(a){a=a|0;var b=0,c=0,d=0,e=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0,P=0,Q=0,R=0,S=0,T=0,U=0,V=0,W=0,X=0,Y=0,Z=0,$=0,_=0,aa=0,ba=0,ca=0,da=0,ea=0,fa=0,ga=0,ha=0,ia=0,ja=0,ka=0,la=0,na=0,oa=0,pa=0,qa=0,sa=0,ta=0,ua=0,va=0,wa=0,xa=0,ya=0,za=0,Aa=0,Da=0,Ea=0,Ga=0,Ha=0,Ia=0,Ja=0,Ka=0,La=0;do{if(a>>>0<245){if(a>>>0<11){b=16}else{b=a+11&-8}c=b>>>3;d=f[228]|0;e=d>>>(c>>>0);if((e&3|0)!=0){g=(e&1^1)+c|0;h=g<<1;i=952+(h<<2)|0;j=952+(h+2<<2)|0;h=f[j>>2]|0;k=h+8|0;l=f[k>>2]|0;do{if((i|0)==(l|0)){f[228]=d&~(1<<g)}else{if(l>>>0<(f[232]|0)>>>0){ma();return 0}m=l+12|0;if((f[m>>2]|0)==(h|0)){f[m>>2]=i;f[j>>2]=l;break}else{ma();return 0}}}while(0);l=g<<3;f[h+4>>2]=l|3;j=h+(l|4)|0;f[j>>2]=f[j>>2]|1;n=k;return n|0}if(b>>>0<=(f[230]|0)>>>0){o=b;break}if((e|0)!=0){j=2<<c;l=e<<c&(j|-j);j=(l&-l)-1|0;l=j>>>12&16;i=j>>>(l>>>0);j=i>>>5&8;m=i>>>(j>>>0);i=m>>>2&4;p=m>>>(i>>>0);m=p>>>1&2;q=p>>>(m>>>0);p=q>>>1&1;r=(j|l|i|m|p)+(q>>>(p>>>0))|0;p=r<<1;q=952+(p<<2)|0;m=952+(p+2<<2)|0;p=f[m>>2]|0;i=p+8|0;l=f[i>>2]|0;do{if((q|0)==(l|0)){f[228]=d&~(1<<r)}else{if(l>>>0<(f[232]|0)>>>0){ma();return 0}j=l+12|0;if((f[j>>2]|0)==(p|0)){f[j>>2]=q;f[m>>2]=l;break}else{ma();return 0}}}while(0);l=r<<3;m=l-b|0;f[p+4>>2]=b|3;q=p;d=q+b|0;f[q+(b|4)>>2]=m|1;f[q+l>>2]=m;l=f[230]|0;if((l|0)!=0){q=f[233]|0;c=l>>>3;l=c<<1;e=952+(l<<2)|0;k=f[228]|0;h=1<<c;do{if((k&h|0)==0){f[228]=k|h;s=e;t=952+(l+2<<2)|0}else{c=952+(l+2<<2)|0;g=f[c>>2]|0;if(g>>>0>=(f[232]|0)>>>0){s=g;t=c;break}ma();return 0}}while(0);f[t>>2]=q;f[s+12>>2]=q;f[q+8>>2]=s;f[q+12>>2]=e}f[230]=m;f[233]=d;n=i;return n|0}l=f[229]|0;if((l|0)==0){o=b;break}h=(l&-l)-1|0;l=h>>>12&16;k=h>>>(l>>>0);h=k>>>5&8;p=k>>>(h>>>0);k=p>>>2&4;r=p>>>(k>>>0);p=r>>>1&2;c=r>>>(p>>>0);r=c>>>1&1;g=f[1216+((h|l|k|p|r)+(c>>>(r>>>0))<<2)>>2]|0;r=g;c=g;p=(f[g+4>>2]&-8)-b|0;while(1){g=f[r+16>>2]|0;if((g|0)==0){k=f[r+20>>2]|0;if((k|0)==0){break}else{u=k}}else{u=g}g=(f[u+4>>2]&-8)-b|0;k=g>>>0<p>>>0;r=u;c=k?u:c;p=k?g:p}r=c;i=f[232]|0;if(r>>>0<i>>>0){ma();return 0}d=r+b|0;m=d;if(r>>>0>=d>>>0){ma();return 0}d=f[c+24>>2]|0;e=f[c+12>>2]|0;do{if((e|0)==(c|0)){q=c+20|0;g=f[q>>2]|0;if((g|0)==0){k=c+16|0;l=f[k>>2]|0;if((l|0)==0){v=0;break}else{w=l;x=k}}else{w=g;x=q}while(1){q=w+20|0;g=f[q>>2]|0;if((g|0)!=0){w=g;x=q;continue}q=w+16|0;g=f[q>>2]|0;if((g|0)==0){break}else{w=g;x=q}}if(x>>>0<i>>>0){ma();return 0}else{f[x>>2]=0;v=w;break}}else{q=f[c+8>>2]|0;if(q>>>0<i>>>0){ma();return 0}g=q+12|0;if((f[g>>2]|0)!=(c|0)){ma();return 0}k=e+8|0;if((f[k>>2]|0)==(c|0)){f[g>>2]=e;f[k>>2]=q;v=e;break}else{ma();return 0}}}while(0);a:do{if((d|0)!=0){e=c+28|0;i=1216+(f[e>>2]<<2)|0;do{if((c|0)==(f[i>>2]|0)){f[i>>2]=v;if((v|0)!=0){break}f[229]=f[229]&~(1<<f[e>>2]);break a}else{if(d>>>0<(f[232]|0)>>>0){ma();return 0}q=d+16|0;if((f[q>>2]|0)==(c|0)){f[q>>2]=v}else{f[d+20>>2]=v}if((v|0)==0){break a}}}while(0);if(v>>>0<(f[232]|0)>>>0){ma();return 0}f[v+24>>2]=d;e=f[c+16>>2]|0;do{if((e|0)!=0){if(e>>>0<(f[232]|0)>>>0){ma();return 0}else{f[v+16>>2]=e;f[e+24>>2]=v;break}}}while(0);e=f[c+20>>2]|0;if((e|0)==0){break}if(e>>>0<(f[232]|0)>>>0){ma();return 0}else{f[v+20>>2]=e;f[e+24>>2]=v;break}}}while(0);if(p>>>0<16){d=p+b|0;f[c+4>>2]=d|3;e=r+(d+4)|0;f[e>>2]=f[e>>2]|1}else{f[c+4>>2]=b|3;f[r+(b|4)>>2]=p|1;f[r+(p+b)>>2]=p;e=f[230]|0;if((e|0)!=0){d=f[233]|0;i=e>>>3;e=i<<1;q=952+(e<<2)|0;k=f[228]|0;g=1<<i;do{if((k&g|0)==0){f[228]=k|g;y=q;z=952+(e+2<<2)|0}else{i=952+(e+2<<2)|0;l=f[i>>2]|0;if(l>>>0>=(f[232]|0)>>>0){y=l;z=i;break}ma();return 0}}while(0);f[z>>2]=d;f[y+12>>2]=d;f[d+8>>2]=y;f[d+12>>2]=q}f[230]=p;f[233]=m}e=c+8|0;if((e|0)==0){o=b;break}else{n=e}return n|0}else{if(a>>>0>4294967231){o=-1;break}e=a+11|0;g=e&-8;k=f[229]|0;if((k|0)==0){o=g;break}r=-g|0;i=e>>>8;do{if((i|0)==0){A=0}else{if(g>>>0>16777215){A=31;break}e=(i+1048320|0)>>>16&8;l=i<<e;h=(l+520192|0)>>>16&4;j=l<<h;l=(j+245760|0)>>>16&2;B=14-(h|e|l)+(j<<l>>>15)|0;A=g>>>((B+7|0)>>>0)&1|B<<1}}while(0);i=f[1216+(A<<2)>>2]|0;a:do{if((i|0)==0){C=0;D=r;E=0}else{if((A|0)==31){F=0}else{F=25-(A>>>1)|0}c=0;m=r;p=i;q=g<<F;d=0;while(1){B=f[p+4>>2]&-8;l=B-g|0;if(l>>>0<m>>>0){if((B|0)==(g|0)){C=p;D=l;E=p;break a}else{G=p;H=l}}else{G=c;H=m}l=f[p+20>>2]|0;
B=f[p+16+(q>>>31<<2)>>2]|0;j=(l|0)==0|(l|0)==(B|0)?d:l;if((B|0)==0){C=G;D=H;E=j;break}else{c=G;m=H;p=B;q=q<<1;d=j}}}}while(0);if((E|0)==0&(C|0)==0){i=2<<A;r=(i|-i)&k;if((r|0)==0){o=g;break}i=(r&-r)-1|0;r=i>>>12&16;d=i>>>(r>>>0);i=d>>>5&8;q=d>>>(i>>>0);d=q>>>2&4;p=q>>>(d>>>0);q=p>>>1&2;m=p>>>(q>>>0);p=m>>>1&1;I=f[1216+((i|r|d|q|p)+(m>>>(p>>>0))<<2)>>2]|0}else{I=E}if((I|0)==0){J=D;K=C}else{p=I;m=D;q=C;while(1){d=(f[p+4>>2]&-8)-g|0;r=d>>>0<m>>>0;i=r?d:m;d=r?p:q;r=f[p+16>>2]|0;if((r|0)!=0){p=r;m=i;q=d;continue}r=f[p+20>>2]|0;if((r|0)==0){J=i;K=d;break}else{p=r;m=i;q=d}}}if((K|0)==0){o=g;break}if(J>>>0>=((f[230]|0)-g|0)>>>0){o=g;break}q=K;m=f[232]|0;if(q>>>0<m>>>0){ma();return 0}p=q+g|0;k=p;if(q>>>0>=p>>>0){ma();return 0}d=f[K+24>>2]|0;i=f[K+12>>2]|0;do{if((i|0)==(K|0)){r=K+20|0;c=f[r>>2]|0;if((c|0)==0){j=K+16|0;B=f[j>>2]|0;if((B|0)==0){L=0;break}else{M=B;N=j}}else{M=c;N=r}while(1){r=M+20|0;c=f[r>>2]|0;if((c|0)!=0){M=c;N=r;continue}r=M+16|0;c=f[r>>2]|0;if((c|0)==0){break}else{M=c;N=r}}if(N>>>0<m>>>0){ma();return 0}else{f[N>>2]=0;L=M;break}}else{r=f[K+8>>2]|0;if(r>>>0<m>>>0){ma();return 0}c=r+12|0;if((f[c>>2]|0)!=(K|0)){ma();return 0}j=i+8|0;if((f[j>>2]|0)==(K|0)){f[c>>2]=i;f[j>>2]=r;L=i;break}else{ma();return 0}}}while(0);a:do{if((d|0)!=0){i=K+28|0;m=1216+(f[i>>2]<<2)|0;do{if((K|0)==(f[m>>2]|0)){f[m>>2]=L;if((L|0)!=0){break}f[229]=f[229]&~(1<<f[i>>2]);break a}else{if(d>>>0<(f[232]|0)>>>0){ma();return 0}r=d+16|0;if((f[r>>2]|0)==(K|0)){f[r>>2]=L}else{f[d+20>>2]=L}if((L|0)==0){break a}}}while(0);if(L>>>0<(f[232]|0)>>>0){ma();return 0}f[L+24>>2]=d;i=f[K+16>>2]|0;do{if((i|0)!=0){if(i>>>0<(f[232]|0)>>>0){ma();return 0}else{f[L+16>>2]=i;f[i+24>>2]=L;break}}}while(0);i=f[K+20>>2]|0;if((i|0)==0){break}if(i>>>0<(f[232]|0)>>>0){ma();return 0}else{f[L+20>>2]=i;f[i+24>>2]=L;break}}}while(0);do{if(J>>>0<16){d=J+g|0;f[K+4>>2]=d|3;i=q+(d+4)|0;f[i>>2]=f[i>>2]|1}else{f[K+4>>2]=g|3;f[q+(g|4)>>2]=J|1;f[q+(J+g)>>2]=J;i=J>>>3;if(J>>>0<256){d=i<<1;m=952+(d<<2)|0;r=f[228]|0;j=1<<i;do{if((r&j|0)==0){f[228]=r|j;O=m;P=952+(d+2<<2)|0}else{i=952+(d+2<<2)|0;c=f[i>>2]|0;if(c>>>0>=(f[232]|0)>>>0){O=c;P=i;break}ma();return 0}}while(0);f[P>>2]=k;f[O+12>>2]=k;f[q+(g+8)>>2]=O;f[q+(g+12)>>2]=m;break}d=p;j=J>>>8;do{if((j|0)==0){Q=0}else{if(J>>>0>16777215){Q=31;break}r=(j+1048320|0)>>>16&8;i=j<<r;c=(i+520192|0)>>>16&4;B=i<<c;i=(B+245760|0)>>>16&2;l=14-(c|r|i)+(B<<i>>>15)|0;Q=J>>>((l+7|0)>>>0)&1|l<<1}}while(0);j=1216+(Q<<2)|0;f[q+(g+28)>>2]=Q;f[q+(g+20)>>2]=0;f[q+(g+16)>>2]=0;m=f[229]|0;l=1<<Q;if((m&l|0)==0){f[229]=m|l;f[j>>2]=d;f[q+(g+24)>>2]=j;f[q+(g+12)>>2]=d;f[q+(g+8)>>2]=d;break}if((Q|0)==31){R=0}else{R=25-(Q>>>1)|0}l=J<<R;m=f[j>>2]|0;while(1){if((f[m+4>>2]&-8|0)==(J|0)){break}S=m+16+(l>>>31<<2)|0;j=f[S>>2]|0;if((j|0)==0){T=829;break}else{l=l<<1;m=j}}if((T|0)==829){if(S>>>0<(f[232]|0)>>>0){ma();return 0}else{f[S>>2]=d;f[q+(g+24)>>2]=m;f[q+(g+12)>>2]=d;f[q+(g+8)>>2]=d;break}}l=m+8|0;j=f[l>>2]|0;i=f[232]|0;if(m>>>0<i>>>0){ma();return 0}if(j>>>0<i>>>0){ma();return 0}else{f[j+12>>2]=d;f[l>>2]=d;f[q+(g+8)>>2]=j;f[q+(g+12)>>2]=m;f[q+(g+24)>>2]=0;break}}}while(0);q=K+8|0;if((q|0)==0){o=g;break}else{n=q}return n|0}}while(0);K=f[230]|0;if(o>>>0<=K>>>0){S=K-o|0;J=f[233]|0;if(S>>>0>15){R=J;f[233]=R+o;f[230]=S;f[R+(o+4)>>2]=S|1;f[R+K>>2]=S;f[J+4>>2]=o|3}else{f[230]=0;f[233]=0;f[J+4>>2]=K|3;S=J+(K+4)|0;f[S>>2]=f[S>>2]|1}n=J+8|0;return n|0}J=f[231]|0;if(o>>>0<J>>>0){S=J-o|0;f[231]=S;J=f[234]|0;K=J;f[234]=K+o;f[K+(o+4)>>2]=S|1;f[J+4>>2]=o|3;n=J+8|0;return n|0}do{if((f[222]|0)==0){J=ra(30)|0;if((J-1&J|0)==0){f[224]=J;f[223]=J;f[225]=-1;f[226]=-1;f[227]=0;f[339]=0;f[222]=(Fa(0)|0)&-16^1431655768;break}else{ma();return 0}}}while(0);J=o+48|0;S=f[224]|0;K=o+47|0;R=S+K|0;Q=-S|0;S=R&Q;if(S>>>0<=o>>>0){n=0;return n|0}O=f[338]|0;do{if((O|0)!=0){P=f[336]|0;L=P+S|0;if(L>>>0<=P>>>0|L>>>0>O>>>0){n=0}else{break}return n|0}}while(0);a:do{if((f[339]&4|0)==0){O=f[234]|0;b:do{if((O|0)==0){T=859}else{L=O;P=1360;while(1){U=P|0;M=f[U>>2]|0;if(M>>>0<=L>>>0){V=P+4|0;if((M+(f[V>>2]|0)|0)>>>0>L>>>0){break}}M=f[P+8>>2]|0;if((M|0)==0){T=859;break b}else{P=M}}if((P|0)==0){T=859;break}L=R-(f[231]|0)&Q;if(L>>>0>=2147483647){W=0;break}m=Ba(L|0)|0;d=(m|0)==((f[U>>2]|0)+(f[V>>2]|0)|0);X=d?m:-1;Y=d?L:0;Z=m;$=L;T=868}}while(0);do{if((T|0)==859){O=Ba(0)|0;if((O|0)==-1){W=0;break}g=O;L=f[223]|0;m=L-1|0;if((m&g|0)==0){_=S}else{_=S-g+(m+g&-L)|0}L=f[336]|0;g=L+_|0;if(!(_>>>0>o>>>0&_>>>0<2147483647)){W=0;break}m=f[338]|0;if((m|0)!=0){if(g>>>0<=L>>>0|g>>>0>m>>>0){W=0;break}}m=Ba(_|0)|0;g=(m|0)==(O|0);X=g?O:-1;Y=g?_:0;Z=m;$=_;T=868}}while(0);b:do{if((T|0)==868){m=-$|0;if((X|0)!=-1){aa=Y;ba=X;T=879;break a}do{if((Z|0)!=-1&$>>>0<2147483647&$>>>0<J>>>0){g=f[224]|0;O=K-$+g&-g;if(O>>>0>=2147483647){ca=$;break}if((Ba(O|0)|0)==-1){Ba(m|0)|0;W=Y;break b}else{ca=O+$|0;break}}else{ca=$}}while(0);if((Z|0)==-1){W=Y}else{aa=ca;ba=Z;T=879;break a}}}while(0);f[339]=f[339]|4;da=W;T=876}else{da=0;T=876}}while(0);do{if((T|0)==876){if(S>>>0>=2147483647){break}W=Ba(S|0)|0;Z=Ba(0)|0;if(!((Z|0)!=-1&(W|0)!=-1&W>>>0<Z>>>0)){break}ca=Z-W|0;Z=ca>>>0>(o+40|0)>>>0;Y=Z?W:-1;if((Y|0)!=-1){aa=Z?ca:da;ba=Y;T=879}}}while(0);do{if((T|0)==879){da=(f[336]|0)+aa|0;f[336]=da;if(da>>>0>(f[337]|0)>>>0){f[337]=da}da=f[234]|0;a:do{if((da|0)==0){S=f[232]|0;if((S|0)==0|ba>>>0<S>>>0){f[232]=ba}f[340]=ba;f[341]=aa;f[343]=0;f[237]=f[222];f[236]=-1;S=0;do{Y=S<<1;ca=952+(Y<<2)|0;f[952+(Y+3<<2)>>2]=ca;f[952+(Y+2<<2)>>2]=ca;S=S+1|0}while(S>>>0<32);S=ba+8|0;if((S&7|0)==0){ea=0}else{ea=-S&7}S=aa-40-ea|0;f[234]=ba+ea;f[231]=S;f[ba+(ea+4)>>2]=S|1;f[ba+(aa-36)>>2]=40;f[235]=f[226]}else{S=1360;while(1){fa=f[S>>2]|0;ga=S+4|0;ha=f[ga>>2]|0;if((ba|0)==(fa+ha|0)){T=891;break}ca=f[S+8>>2]|0;if((ca|0)==0){break}else{S=ca}}do{if((T|0)==891){if((f[S+12>>2]&8|0)!=0){break}ca=da;if(!(ca>>>0>=fa>>>0&ca>>>0<ba>>>0)){break}f[ga>>2]=ha+aa;ca=f[234]|0;Y=(f[231]|0)+aa|0;Z=ca;W=ca+8|0;if((W&7|0)==0){ia=0}else{ia=-W&7}W=Y-ia|0;f[234]=Z+ia;f[231]=W;f[Z+(ia+4)>>2]=W|1;f[Z+(Y+4)>>2]=40;f[235]=f[226];break a}}while(0);if(ba>>>0<(f[232]|0)>>>0){f[232]=ba}S=ba+aa|0;Y=1360;while(1){ja=Y|0;if((f[ja>>2]|0)==(S|0)){T=901;break}Z=f[Y+8>>2]|0;if((Z|0)==0){break}else{Y=Z}}do{if((T|0)==901){if((f[Y+12>>2]&8|0)!=0){break}f[ja>>2]=ba;S=Y+4|0;f[S>>2]=(f[S>>2]|0)+aa;S=ba+8|0;if((S&7|0)==0){ka=0}else{ka=-S&7}S=ba+(aa+8)|0;if((S&7|0)==0){la=0}else{la=-S&7}S=ba+(la+aa)|0;Z=S;W=ka+o|0;ca=ba+W|0;$=ca;K=S-(ba+ka)-o|0;f[ba+(ka+4)>>2]=o|3;do{if((Z|0)==(f[234]|0)){J=(f[231]|0)+K|0;f[231]=J;f[234]=$;f[ba+(W+4)>>2]=J|1}else{if((Z|0)==(f[233]|0)){J=(f[230]|0)+K|0;f[230]=J;f[233]=$;f[ba+(W+4)>>2]=J|1;f[ba+(J+W)>>2]=J;break}J=aa+4|0;X=f[ba+(la+J)>>2]|0;if((X&3|0)==1){_=X&-8;V=X>>>3;b:do{if(X>>>0<256){U=f[ba+((la|8)+aa)>>2]|0;Q=f[ba+(aa+12+la)>>2]|0;R=952+(V<<1<<2)|0;do{if((U|0)!=(R|0)){if(U>>>0<(f[232]|0)>>>0){ma();return 0}if((f[U+12>>2]|0)==(Z|0)){break}ma();return 0}}while(0);if((Q|0)==(U|0)){f[228]=f[228]&~(1<<V);break}do{if((Q|0)==(R|0)){na=Q+8|0}else{if(Q>>>0<(f[232]|0)>>>0){ma();return 0}m=Q+8|0;if((f[m>>2]|0)==(Z|0)){na=m;break}ma();return 0}}while(0);f[U+12>>2]=Q;f[na>>2]=U}else{R=S;m=f[ba+((la|24)+aa)>>2]|0;P=f[ba+(aa+12+la)>>2]|0;do{if((P|0)==(R|0)){O=la|16;g=ba+(O+J)|0;L=f[g>>2]|0;if((L|0)==0){d=ba+(O+aa)|0;O=f[d>>2]|0;if((O|0)==0){oa=0;break}else{pa=O;qa=d}}else{pa=L;qa=g}while(1){g=pa+20|0;L=f[g>>2]|0;if((L|0)!=0){pa=L;qa=g;continue}g=pa+16|0;L=f[g>>2]|0;if((L|0)==0){break}else{pa=L;qa=g}}if(qa>>>0<(f[232]|0)>>>0){ma();return 0}else{f[qa>>2]=0;oa=pa;break}}else{g=f[ba+((la|8)+aa)>>2]|0;if(g>>>0<(f[232]|0)>>>0){ma();return 0}L=g+12|0;if((f[L>>2]|0)!=(R|0)){ma();return 0}d=P+8|0;if((f[d>>2]|0)==(R|0)){f[L>>2]=P;f[d>>2]=g;oa=P;break}else{ma();return 0}}}while(0);if((m|0)==0){break}P=ba+(aa+28+la)|0;U=1216+(f[P>>2]<<2)|0;do{if((R|0)==(f[U>>2]|0)){f[U>>2]=oa;if((oa|0)!=0){break}f[229]=f[229]&~(1<<f[P>>2]);break b}else{if(m>>>0<(f[232]|0)>>>0){ma();return 0}Q=m+16|0;if((f[Q>>2]|0)==(R|0)){f[Q>>2]=oa}else{f[m+20>>2]=oa}if((oa|0)==0){break b}}}while(0);if(oa>>>0<(f[232]|0)>>>0){ma();return 0}f[oa+24>>2]=m;R=la|16;P=f[ba+(R+aa)>>2]|0;do{if((P|0)!=0){if(P>>>0<(f[232]|0)>>>0){ma();return 0}else{f[oa+16>>2]=P;f[P+24>>2]=oa;break}}}while(0);P=f[ba+(R+J)>>2]|0;if((P|0)==0){break}if(P>>>0<(f[232]|0)>>>0){ma();return 0}else{f[oa+20>>2]=P;f[P+24>>2]=oa;break}}}while(0);sa=ba+((_|la)+aa)|0;ta=_+K|0}else{sa=Z;ta=K}J=sa+4|0;f[J>>2]=f[J>>2]&-2;f[ba+(W+4)>>2]=ta|1;f[ba+(ta+W)>>2]=ta;J=ta>>>3;if(ta>>>0<256){V=J<<1;X=952+(V<<2)|0;P=f[228]|0;m=1<<J;do{if((P&m|0)==0){f[228]=P|m;ua=X;va=952+(V+2<<2)|0}else{J=952+(V+2<<2)|0;U=f[J>>2]|0;if(U>>>0>=(f[232]|0)>>>0){ua=U;va=J;break}ma();return 0}}while(0);f[va>>2]=$;f[ua+12>>2]=$;f[ba+(W+8)>>2]=ua;f[ba+(W+12)>>2]=X;break}V=ca;m=ta>>>8;do{if((m|0)==0){wa=0}else{if(ta>>>0>16777215){wa=31;break}P=(m+1048320|0)>>>16&8;_=m<<P;J=(_+520192|0)>>>16&4;U=_<<J;_=(U+245760|0)>>>16&2;Q=14-(J|P|_)+(U<<_>>>15)|0;wa=ta>>>((Q+7|0)>>>0)&1|Q<<1}}while(0);m=1216+(wa<<2)|0;f[ba+(W+28)>>2]=wa;f[ba+(W+20)>>2]=0;f[ba+(W+16)>>2]=0;X=f[229]|0;Q=1<<wa;if((X&Q|0)==0){f[229]=X|Q;f[m>>2]=V;f[ba+(W+24)>>2]=m;f[ba+(W+12)>>2]=V;f[ba+(W+8)>>2]=V;break}if((wa|0)==31){xa=0}else{xa=25-(wa>>>1)|0}Q=ta<<xa;X=f[m>>2]|0;while(1){if((f[X+4>>2]&-8|0)==(ta|0)){break}ya=X+16+(Q>>>31<<2)|0;m=f[ya>>2]|0;if((m|0)==0){T=974;break}else{Q=Q<<1;X=m}}if((T|0)==974){if(ya>>>0<(f[232]|0)>>>0){ma();return 0}else{f[ya>>2]=V;f[ba+(W+24)>>2]=X;f[ba+(W+12)>>2]=V;f[ba+(W+8)>>2]=V;break}}Q=X+8|0;m=f[Q>>2]|0;_=f[232]|0;if(X>>>0<_>>>0){ma();return 0}if(m>>>0<_>>>0){ma();return 0}else{f[m+12>>2]=V;f[Q>>2]=V;f[ba+(W+8)>>2]=m;f[ba+(W+12)>>2]=X;f[ba+(W+24)>>2]=0;break}}}while(0);n=ba+(ka|8)|0;return n|0}}while(0);Y=da;W=1360;while(1){za=f[W>>2]|0;if(za>>>0<=Y>>>0){Aa=f[W+4>>2]|0;Da=za+Aa|0;if(Da>>>0>Y>>>0){break}}W=f[W+8>>2]|0}W=za+(Aa-39)|0;if((W&7|0)==0){Ea=0}else{Ea=-W&7}W=za+(Aa-47+Ea)|0;ca=W>>>0<(da+16|0)>>>0?Y:W;W=ca+8|0;$=ba+8|0;if(($&7|0)==0){Ga=0}else{Ga=-$&7}$=aa-40-Ga|0;f[234]=ba+Ga;f[231]=$;f[ba+(Ga+4)>>2]=$|1;f[ba+(aa-36)>>2]=40;f[235]=f[226];f[ca+4>>2]=27;f[W>>2]=f[340];f[W+4>>2]=f[341];f[W+8>>2]=f[342];f[W+12>>2]=f[343];f[340]=ba;f[341]=aa;f[343]=0;f[342]=W;W=ca+28|0;f[W>>2]=7;if((ca+32|0)>>>0<Da>>>0){$=W;while(1){W=$+4|0;f[W>>2]=7;if(($+8|0)>>>0<Da>>>0){$=W}else{break}}}if((ca|0)==(Y|0)){break}$=ca-da|0;W=Y+($+4)|0;f[W>>2]=f[W>>2]&-2;f[da+4>>2]=$|1;f[Y+$>>2]=$;W=$>>>3;if($>>>0<256){K=W<<1;Z=952+(K<<2)|0;S=f[228]|0;m=1<<W;do{if((S&m|0)==0){f[228]=S|m;Ha=Z;Ia=952+(K+2<<2)|0}else{W=952+(K+2<<2)|0;Q=f[W>>2]|0;if(Q>>>0>=(f[232]|0)>>>0){Ha=Q;Ia=W;break}ma();return 0}}while(0);f[Ia>>2]=da;f[Ha+12>>2]=da;f[da+8>>2]=Ha;f[da+12>>2]=Z;break}K=da;m=$>>>8;do{if((m|0)==0){Ja=0}else{if($>>>0>16777215){Ja=31;break}S=(m+1048320|0)>>>16&8;Y=m<<S;ca=(Y+520192|0)>>>16&4;W=Y<<ca;Y=(W+245760|0)>>>16&2;Q=14-(ca|S|Y)+(W<<Y>>>15)|0;Ja=$>>>((Q+7|0)>>>0)&1|Q<<1}}while(0);m=1216+(Ja<<2)|0;f[da+28>>2]=Ja;f[da+20>>2]=0;f[da+16>>2]=0;Z=f[229]|0;Q=1<<Ja;if((Z&Q|0)==0){f[229]=Z|Q;f[m>>2]=K;f[da+24>>2]=m;f[da+12>>2]=da;f[da+8>>2]=da;break}if((Ja|0)==31){Ka=0}else{Ka=25-(Ja>>>1)|0}Q=$<<Ka;Z=f[m>>2]|0;while(1){if((f[Z+4>>2]&-8|0)==($|0)){break}La=Z+16+(Q>>>31<<2)|0;m=f[La>>2]|0;if((m|0)==0){T=1009;break}else{Q=Q<<1;Z=m}}if((T|0)==1009){if(La>>>0<(f[232]|0)>>>0){ma();return 0}else{f[La>>2]=K;f[da+24>>2]=Z;f[da+12>>2]=da;f[da+8>>2]=da;break}}Q=Z+8|0;$=f[Q>>2]|0;m=f[232]|0;if(Z>>>0<m>>>0){ma();return 0}if($>>>0<m>>>0){ma();return 0}else{f[$+12>>2]=K;f[Q>>2]=K;f[da+8>>2]=$;f[da+12>>2]=Z;f[da+24>>2]=0;break}}}while(0);da=f[231]|0;if(da>>>0<=o>>>0){break}$=da-o|0;f[231]=$;da=f[234]|0;Q=da;f[234]=Q+o;f[Q+(o+4)>>2]=$|1;f[da+4>>2]=o|3;n=da+8|0;return n|0}}while(0);f[(Ca()|0)>>2]=12;n=0;return n|0}function ob(a){a=a|0;var b=0,c=0,d=0,e=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0;if((a|0)==0){return}b=a-8|0;c=b;d=f[232]|0;if(b>>>0<d>>>0){ma()}e=f[a-4>>2]|0;g=e&3;if((g|0)==1){ma()}h=e&-8;i=a+(h-8)|0;j=i;a:do{if((e&1|0)==0){k=f[b>>2]|0;if((g|0)==0){return}l=-8-k|0;m=a+l|0;n=m;o=k+h|0;if(m>>>0<d>>>0){ma()}if((n|0)==(f[233]|0)){p=a+(h-4)|0;if((f[p>>2]&3|0)!=3){q=n;r=o;break}f[230]=o;f[p>>2]=f[p>>2]&-2;f[a+(l+4)>>2]=o|1;f[i>>2]=o;return}p=k>>>3;if(k>>>0<256){k=f[a+(l+8)>>2]|0;s=f[a+(l+12)>>2]|0;t=952+(p<<1<<2)|0;do{if((k|0)!=(t|0)){if(k>>>0<d>>>0){ma()}if((f[k+12>>2]|0)==(n|0)){break}ma()}}while(0);if((s|0)==(k|0)){f[228]=f[228]&~(1<<p);q=n;r=o;break}do{if((s|0)==(t|0)){u=s+8|0}else{if(s>>>0<d>>>0){ma()}v=s+8|0;if((f[v>>2]|0)==(n|0)){u=v;break}ma()}}while(0);f[k+12>>2]=s;f[u>>2]=k;q=n;r=o;break}t=m;p=f[a+(l+24)>>2]|0;v=f[a+(l+12)>>2]|0;do{if((v|0)==(t|0)){w=a+(l+20)|0;x=f[w>>2]|0;if((x|0)==0){y=a+(l+16)|0;z=f[y>>2]|0;if((z|0)==0){A=0;break}else{B=z;C=y}}else{B=x;C=w}while(1){w=B+20|0;x=f[w>>2]|0;if((x|0)!=0){B=x;C=w;continue}w=B+16|0;x=f[w>>2]|0;if((x|0)==0){break}else{B=x;C=w}}if(C>>>0<d>>>0){ma()}else{f[C>>2]=0;A=B;break}}else{w=f[a+(l+8)>>2]|0;if(w>>>0<d>>>0){ma()}x=w+12|0;if((f[x>>2]|0)!=(t|0)){ma()}y=v+8|0;if((f[y>>2]|0)==(t|0)){f[x>>2]=v;f[y>>2]=w;A=v;break}else{ma()}}}while(0);if((p|0)==0){q=n;r=o;break}v=a+(l+28)|0;m=1216+(f[v>>2]<<2)|0;do{if((t|0)==(f[m>>2]|0)){f[m>>2]=A;if((A|0)!=0){break}f[229]=f[229]&~(1<<f[v>>2]);q=n;r=o;break a}else{if(p>>>0<(f[232]|0)>>>0){ma()}k=p+16|0;if((f[k>>2]|0)==(t|0)){f[k>>2]=A}else{f[p+20>>2]=A}if((A|0)==0){q=n;r=o;break a}}}while(0);if(A>>>0<(f[232]|0)>>>0){ma()}f[A+24>>2]=p;t=f[a+(l+16)>>2]|0;do{if((t|0)!=0){if(t>>>0<(f[232]|0)>>>0){ma()}else{f[A+16>>2]=t;f[t+24>>2]=A;break}}}while(0);t=f[a+(l+20)>>2]|0;if((t|0)==0){q=n;r=o;break}if(t>>>0<(f[232]|0)>>>0){ma()}else{f[A+20>>2]=t;f[t+24>>2]=A;q=n;r=o;break}}else{q=c;r=h}}while(0);c=q;if(c>>>0>=i>>>0){ma()}A=a+(h-4)|0;d=f[A>>2]|0;if((d&1|0)==0){ma()}do{if((d&2|0)==0){if((j|0)==(f[234]|0)){B=(f[231]|0)+r|0;f[231]=B;f[234]=q;f[q+4>>2]=B|1;if((q|0)!=(f[233]|0)){return}f[233]=0;f[230]=0;return}if((j|0)==(f[233]|0)){B=(f[230]|0)+r|0;f[230]=B;f[233]=q;f[q+4>>2]=B|1;f[c+B>>2]=B;return}B=(d&-8)+r|0;C=d>>>3;a:do{if(d>>>0<256){u=f[a+h>>2]|0;g=f[a+(h|4)>>2]|0;b=952+(C<<1<<2)|0;do{if((u|0)!=(b|0)){if(u>>>0<(f[232]|0)>>>0){ma()}if((f[u+12>>2]|0)==(j|0)){break}ma()}}while(0);if((g|0)==(u|0)){f[228]=f[228]&~(1<<C);break}do{if((g|0)==(b|0)){D=g+8|0}else{if(g>>>0<(f[232]|0)>>>0){ma()}e=g+8|0;if((f[e>>2]|0)==(j|0)){D=e;break}ma()}}while(0);f[u+12>>2]=g;f[D>>2]=u}else{b=i;e=f[a+(h+16)>>2]|0;t=f[a+(h|4)>>2]|0;do{if((t|0)==(b|0)){p=a+(h+12)|0;v=f[p>>2]|0;if((v|0)==0){m=a+(h+8)|0;k=f[m>>2]|0;if((k|0)==0){E=0;break}else{F=k;G=m}}else{F=v;G=p}while(1){p=F+20|0;v=f[p>>2]|0;if((v|0)!=0){F=v;G=p;continue}p=F+16|0;v=f[p>>2]|0;if((v|0)==0){break}else{F=v;G=p}}if(G>>>0<(f[232]|0)>>>0){ma()}else{f[G>>2]=0;E=F;break}}else{p=f[a+h>>2]|0;if(p>>>0<(f[232]|0)>>>0){ma()}v=p+12|0;if((f[v>>2]|0)!=(b|0)){ma()}m=t+8|0;if((f[m>>2]|0)==(b|0)){f[v>>2]=t;f[m>>2]=p;E=t;break}else{ma()}}}while(0);if((e|0)==0){break}t=a+(h+20)|0;u=1216+(f[t>>2]<<2)|0;do{if((b|0)==(f[u>>2]|0)){f[u>>2]=E;if((E|0)!=0){break}f[229]=f[229]&~(1<<f[t>>2]);break a}else{if(e>>>0<(f[232]|0)>>>0){ma()}g=e+16|0;if((f[g>>2]|0)==(b|0)){f[g>>2]=E}else{f[e+20>>2]=E}if((E|0)==0){break a}}}while(0);if(E>>>0<(f[232]|0)>>>0){ma()}f[E+24>>2]=e;b=f[a+(h+8)>>2]|0;do{if((b|0)!=0){if(b>>>0<(f[232]|0)>>>0){ma()}else{f[E+16>>2]=b;f[b+24>>2]=E;break}}}while(0);b=f[a+(h+12)>>2]|0;if((b|0)==0){break}if(b>>>0<(f[232]|0)>>>0){ma()}else{f[E+20>>2]=b;f[b+24>>2]=E;break}}}while(0);f[q+4>>2]=B|1;f[c+B>>2]=B;if((q|0)!=(f[233]|0)){H=B;break}f[230]=B;return}else{f[A>>2]=d&-2;f[q+4>>2]=r|1;f[c+r>>2]=r;H=r}}while(0);r=H>>>3;if(H>>>0<256){c=r<<1;d=952+(c<<2)|0;A=f[228]|0;E=1<<r;do{if((A&E|0)==0){f[228]=A|E;I=d;J=952+(c+2<<2)|0}else{r=952+(c+2<<2)|0;h=f[r>>2]|0;if(h>>>0>=(f[232]|0)>>>0){I=h;J=r;break}ma()}}while(0);f[J>>2]=q;f[I+12>>2]=q;f[q+8>>2]=I;f[q+12>>2]=d;return}d=q;I=H>>>8;do{if((I|0)==0){K=0}else{if(H>>>0>16777215){K=31;break}J=(I+1048320|0)>>>16&8;c=I<<J;E=(c+520192|0)>>>16&4;A=c<<E;c=(A+245760|0)>>>16&2;r=14-(E|J|c)+(A<<c>>>15)|0;K=H>>>((r+7|0)>>>0)&1|r<<1}}while(0);I=1216+(K<<2)|0;f[q+28>>2]=K;f[q+20>>2]=0;f[q+16>>2]=0;r=f[229]|0;c=1<<K;do{if((r&c|0)==0){f[229]=r|c;f[I>>2]=d;f[q+24>>2]=I;f[q+12>>2]=q;f[q+8>>2]=q}else{if((K|0)==31){L=0}else{L=25-(K>>>1)|0}A=H<<L;J=f[I>>2]|0;while(1){if((f[J+4>>2]&-8|0)==(H|0)){break}M=J+16+(A>>>31<<2)|0;E=f[M>>2]|0;if((E|0)==0){N=1186;break}else{A=A<<1;J=E}}if((N|0)==1186){if(M>>>0<(f[232]|0)>>>0){ma()}else{f[M>>2]=d;f[q+24>>2]=J;f[q+12>>2]=q;f[q+8>>2]=q;break}}A=J+8|0;B=f[A>>2]|0;E=f[232]|0;if(J>>>0<E>>>0){ma()}if(B>>>0<E>>>0){ma()}else{f[B+12>>2]=d;f[A>>2]=d;f[q+8>>2]=B;f[q+12>>2]=J;f[q+24>>2]=0;break}}}while(0);q=(f[236]|0)-1|0;f[236]=q;if((q|0)==0){O=1368}else{return}while(1){q=f[O>>2]|0;if((q|0)==0){break}else{O=q+8|0}}f[236]=-1;return}function pb(a,b){a=a|0;b=b|0;var c=0,d=0,e=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0;if((a|0)==0){c=nb(b)|0;return c|0}if(b>>>0>4294967231){f[(Ca()|0)>>2]=12;c=0;return c|0}if(b>>>0<11){d=16}else{d=b+11&-8}e=a-8|0;g=a-4|0;h=f[g>>2]|0;i=h&-8;j=i-8|0;k=a+j|0;l=k;m=f[232]|0;if(e>>>0<m>>>0){ma();return 0}n=h&3;if(!((n|0)!=1&(j|0)>-8)){ma();return 0}j=i|4;o=a+(j-8)|0;p=f[o>>2]|0;if((p&1|0)==0){ma();return 0}a:do{if((n|0)==0){if(d>>>0<256|i>>>0<(d|4)>>>0){break}if((i-d|0)>>>0>f[224]<<1>>>0|(e|0)==0){break}else{c=a}return c|0}else{do{if(i>>>0<d>>>0){if((l|0)==(f[234]|0)){q=(f[231]|0)+i|0;if(q>>>0<=d>>>0){break a}r=q-d|0;f[g>>2]=h&1|d|2;f[a+((d|4)-8)>>2]=r|1;f[234]=a+(d-8);f[231]=r;break}if((l|0)==(f[233]|0)){r=(f[230]|0)+i|0;if(r>>>0<d>>>0){break a}q=r-d|0;if(q>>>0>15){f[g>>2]=h&1|d|2;f[a+((d|4)-8)>>2]=q|1;f[a+(r-8)>>2]=q;s=a+(r-4)|0;f[s>>2]=f[s>>2]&-2;t=a+(d-8)|0;u=q}else{f[g>>2]=h&1|r|2;q=a+(r-4)|0;f[q>>2]=f[q>>2]|1;t=0;u=0}f[230]=u;f[233]=t;break}if((p&2|0)!=0){break a}q=(p&-8)+i|0;if(q>>>0<d>>>0){break a}r=q-d|0;s=p>>>3;b:do{if(p>>>0<256){v=f[a+i>>2]|0;w=f[a+j>>2]|0;x=952+(s<<1<<2)|0;do{if((v|0)!=(x|0)){if(v>>>0<m>>>0){ma();return 0}if((f[v+12>>2]|0)==(l|0)){break}ma();return 0}}while(0);if((w|0)==(v|0)){f[228]=f[228]&~(1<<s);break}do{if((w|0)==(x|0)){y=w+8|0}else{if(w>>>0<m>>>0){ma();return 0}z=w+8|0;if((f[z>>2]|0)==(l|0)){y=z;break}ma();return 0}}while(0);f[v+12>>2]=w;f[y>>2]=v}else{x=k;z=f[a+(i+16)>>2]|0;A=f[a+j>>2]|0;do{if((A|0)==(x|0)){B=a+(i+12)|0;C=f[B>>2]|0;if((C|0)==0){D=a+(i+8)|0;E=f[D>>2]|0;if((E|0)==0){F=0;break}else{G=E;H=D}}else{G=C;H=B}while(1){B=G+20|0;C=f[B>>2]|0;if((C|0)!=0){G=C;H=B;continue}B=G+16|0;C=f[B>>2]|0;if((C|0)==0){break}else{G=C;H=B}}if(H>>>0<m>>>0){ma();return 0}else{f[H>>2]=0;F=G;break}}else{B=f[a+i>>2]|0;if(B>>>0<m>>>0){ma();return 0}C=B+12|0;if((f[C>>2]|0)!=(x|0)){ma();return 0}D=A+8|0;if((f[D>>2]|0)==(x|0)){f[C>>2]=A;f[D>>2]=B;F=A;break}else{ma();return 0}}}while(0);if((z|0)==0){break}A=a+(i+20)|0;v=1216+(f[A>>2]<<2)|0;do{if((x|0)==(f[v>>2]|0)){f[v>>2]=F;if((F|0)!=0){break}f[229]=f[229]&~(1<<f[A>>2]);break b}else{if(z>>>0<(f[232]|0)>>>0){ma();return 0}w=z+16|0;if((f[w>>2]|0)==(x|0)){f[w>>2]=F}else{f[z+20>>2]=F}if((F|0)==0){break b}}}while(0);if(F>>>0<(f[232]|0)>>>0){ma();return 0}f[F+24>>2]=z;x=f[a+(i+8)>>2]|0;do{if((x|0)!=0){if(x>>>0<(f[232]|0)>>>0){ma();return 0}else{f[F+16>>2]=x;f[x+24>>2]=F;break}}}while(0);x=f[a+(i+12)>>2]|0;if((x|0)==0){break}if(x>>>0<(f[232]|0)>>>0){ma();return 0}else{f[F+20>>2]=x;f[x+24>>2]=F;break}}}while(0);if(r>>>0>=16){f[g>>2]=f[g>>2]&1|d|2;f[a+((d|4)-8)>>2]=r|3;s=a+((q|4)-8)|0;f[s>>2]=f[s>>2]|1;qb(a+(d-8)|0,r);break}f[g>>2]=q|f[g>>2]&1|2;s=a+((q|4)-8)|0;f[s>>2]=f[s>>2]|1;c=a;return c|0}else{s=i-d|0;if(s>>>0<=15){break}f[g>>2]=h&1|d|2;f[a+((d|4)-8)>>2]=s|3;f[o>>2]=f[o>>2]|1;qb(a+(d-8)|0,s);c=a;return c|0}}while(0);if((e|0)==0){break}else{c=a}return c|0}}while(0);e=nb(b)|0;if((e|0)==0){c=0;return c|0}d=f[g>>2]|0;g=(d&-8)-((d&3|0)==0?8:4)|0;d=g>>>0<b>>>0?g:b;tb(e|0,a|0,d)|0;ob(a);c=e;return c|0}function qb(a,b){a=a|0;b=b|0;var c=0,d=0,e=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0;c=a;d=c+b|0;e=d;g=f[a+4>>2]|0;a:do{if((g&1|0)==0){h=f[a>>2]|0;if((g&3|0)==0){return}i=c+(-h|0)|0;j=i;k=h+b|0;l=f[232]|0;if(i>>>0<l>>>0){ma()}if((j|0)==(f[233]|0)){m=c+(b+4)|0;if((f[m>>2]&3|0)!=3){n=j;o=k;break}f[230]=k;f[m>>2]=f[m>>2]&-2;f[c+(4-h)>>2]=k|1;f[d>>2]=k;return}m=h>>>3;if(h>>>0<256){p=f[c+(8-h)>>2]|0;q=f[c+(12-h)>>2]|0;r=952+(m<<1<<2)|0;do{if((p|0)!=(r|0)){if(p>>>0<l>>>0){ma()}if((f[p+12>>2]|0)==(j|0)){break}ma()}}while(0);if((q|0)==(p|0)){f[228]=f[228]&~(1<<m);n=j;o=k;break}do{if((q|0)==(r|0)){s=q+8|0}else{if(q>>>0<l>>>0){ma()}t=q+8|0;if((f[t>>2]|0)==(j|0)){s=t;break}ma()}}while(0);f[p+12>>2]=q;f[s>>2]=p;n=j;o=k;break}r=i;m=f[c+(24-h)>>2]|0;t=f[c+(12-h)>>2]|0;do{if((t|0)==(r|0)){u=16-h|0;v=c+(u+4)|0;w=f[v>>2]|0;if((w|0)==0){x=c+u|0;u=f[x>>2]|0;if((u|0)==0){y=0;break}else{z=u;A=x}}else{z=w;A=v}while(1){v=z+20|0;w=f[v>>2]|0;if((w|0)!=0){z=w;A=v;continue}v=z+16|0;w=f[v>>2]|0;if((w|0)==0){break}else{z=w;A=v}}if(A>>>0<l>>>0){ma()}else{f[A>>2]=0;y=z;break}}else{v=f[c+(8-h)>>2]|0;if(v>>>0<l>>>0){ma()}w=v+12|0;if((f[w>>2]|0)!=(r|0)){ma()}x=t+8|0;if((f[x>>2]|0)==(r|0)){f[w>>2]=t;f[x>>2]=v;y=t;break}else{ma()}}}while(0);if((m|0)==0){n=j;o=k;break}t=c+(28-h)|0;l=1216+(f[t>>2]<<2)|0;do{if((r|0)==(f[l>>2]|0)){f[l>>2]=y;if((y|0)!=0){break}f[229]=f[229]&~(1<<f[t>>2]);n=j;o=k;break a}else{if(m>>>0<(f[232]|0)>>>0){ma()}i=m+16|0;if((f[i>>2]|0)==(r|0)){f[i>>2]=y}else{f[m+20>>2]=y}if((y|0)==0){n=j;o=k;break a}}}while(0);if(y>>>0<(f[232]|0)>>>0){ma()}f[y+24>>2]=m;r=16-h|0;t=f[c+r>>2]|0;do{if((t|0)!=0){if(t>>>0<(f[232]|0)>>>0){ma()}else{f[y+16>>2]=t;f[t+24>>2]=y;break}}}while(0);t=f[c+(r+4)>>2]|0;if((t|0)==0){n=j;o=k;break}if(t>>>0<(f[232]|0)>>>0){ma()}else{f[y+20>>2]=t;f[t+24>>2]=y;n=j;o=k;break}}else{n=a;o=b}}while(0);a=f[232]|0;if(d>>>0<a>>>0){ma()}y=c+(b+4)|0;z=f[y>>2]|0;do{if((z&2|0)==0){if((e|0)==(f[234]|0)){A=(f[231]|0)+o|0;f[231]=A;f[234]=n;f[n+4>>2]=A|1;if((n|0)!=(f[233]|0)){return}f[233]=0;f[230]=0;return}if((e|0)==(f[233]|0)){A=(f[230]|0)+o|0;f[230]=A;f[233]=n;f[n+4>>2]=A|1;f[n+A>>2]=A;return}A=(z&-8)+o|0;s=z>>>3;a:do{if(z>>>0<256){g=f[c+(b+8)>>2]|0;t=f[c+(b+12)>>2]|0;h=952+(s<<1<<2)|0;do{if((g|0)!=(h|0)){if(g>>>0<a>>>0){ma()}if((f[g+12>>2]|0)==(e|0)){break}ma()}}while(0);if((t|0)==(g|0)){f[228]=f[228]&~(1<<s);break}do{if((t|0)==(h|0)){B=t+8|0}else{if(t>>>0<a>>>0){ma()}m=t+8|0;if((f[m>>2]|0)==(e|0)){B=m;break}ma()}}while(0);f[g+12>>2]=t;f[B>>2]=g}else{h=d;m=f[c+(b+24)>>2]|0;l=f[c+(b+12)>>2]|0;do{if((l|0)==(h|0)){i=c+(b+20)|0;p=f[i>>2]|0;if((p|0)==0){q=c+(b+16)|0;v=f[q>>2]|0;if((v|0)==0){C=0;break}else{D=v;E=q}}else{D=p;E=i}while(1){i=D+20|0;p=f[i>>2]|0;if((p|0)!=0){D=p;E=i;continue}i=D+16|0;p=f[i>>2]|0;if((p|0)==0){break}else{D=p;E=i}}if(E>>>0<a>>>0){ma()}else{f[E>>2]=0;C=D;break}}else{i=f[c+(b+8)>>2]|0;if(i>>>0<a>>>0){ma()}p=i+12|0;if((f[p>>2]|0)!=(h|0)){ma()}q=l+8|0;if((f[q>>2]|0)==(h|0)){f[p>>2]=l;f[q>>2]=i;C=l;break}else{ma()}}}while(0);if((m|0)==0){break}l=c+(b+28)|0;g=1216+(f[l>>2]<<2)|0;do{if((h|0)==(f[g>>2]|0)){f[g>>2]=C;if((C|0)!=0){break}f[229]=f[229]&~(1<<f[l>>2]);break a}else{if(m>>>0<(f[232]|0)>>>0){ma()}t=m+16|0;if((f[t>>2]|0)==(h|0)){f[t>>2]=C}else{f[m+20>>2]=C}if((C|0)==0){break a}}}while(0);if(C>>>0<(f[232]|0)>>>0){ma()}f[C+24>>2]=m;h=f[c+(b+16)>>2]|0;do{if((h|0)!=0){if(h>>>0<(f[232]|0)>>>0){ma()}else{f[C+16>>2]=h;f[h+24>>2]=C;break}}}while(0);h=f[c+(b+20)>>2]|0;if((h|0)==0){break}if(h>>>0<(f[232]|0)>>>0){ma()}else{f[C+20>>2]=h;f[h+24>>2]=C;break}}}while(0);f[n+4>>2]=A|1;f[n+A>>2]=A;if((n|0)!=(f[233]|0)){F=A;break}f[230]=A;return}else{f[y>>2]=z&-2;f[n+4>>2]=o|1;f[n+o>>2]=o;F=o}}while(0);o=F>>>3;if(F>>>0<256){z=o<<1;y=952+(z<<2)|0;C=f[228]|0;b=1<<o;do{if((C&b|0)==0){f[228]=C|b;G=y;H=952+(z+2<<2)|0}else{o=952+(z+2<<2)|0;c=f[o>>2]|0;if(c>>>0>=(f[232]|0)>>>0){G=c;H=o;break}ma()}}while(0);f[H>>2]=n;f[G+12>>2]=n;f[n+8>>2]=G;f[n+12>>2]=y;return}y=n;G=F>>>8;do{if((G|0)==0){I=0}else{if(F>>>0>16777215){I=31;break}H=(G+1048320|0)>>>16&8;z=G<<H;b=(z+520192|0)>>>16&4;C=z<<b;z=(C+245760|0)>>>16&2;o=14-(b|H|z)+(C<<z>>>15)|0;I=F>>>((o+7|0)>>>0)&1|o<<1}}while(0);G=1216+(I<<2)|0;f[n+28>>2]=I;f[n+20>>2]=0;f[n+16>>2]=0;o=f[229]|0;z=1<<I;if((o&z|0)==0){f[229]=o|z;f[G>>2]=y;f[n+24>>2]=G;f[n+12>>2]=n;f[n+8>>2]=n;return}if((I|0)==31){J=0}else{J=25-(I>>>1)|0}I=F<<J;J=f[G>>2]|0;while(1){if((f[J+4>>2]&-8|0)==(F|0)){break}K=J+16+(I>>>31<<2)|0;G=f[K>>2]|0;if((G|0)==0){L=1452;break}else{I=I<<1;J=G}}if((L|0)==1452){if(K>>>0<(f[232]|0)>>>0){ma()}f[K>>2]=y;f[n+24>>2]=J;f[n+12>>2]=n;f[n+8>>2]=n;return}K=J+8|0;L=f[K>>2]|0;I=f[232]|0;if(J>>>0<I>>>0){ma()}if(L>>>0<I>>>0){ma()}f[L+12>>2]=y;f[K>>2]=y;f[n+8>>2]=L;f[n+12>>2]=J;f[n+24>>2]=0;return}function rb(a){a=a|0;var b=0;b=a;while(d[b]|0){b=b+1|0}return b-a|0}function sb(a,b,c){a=a|0;b=b|0;c=c|0;var e=0,g=0,h=0;e=a+c|0;if((c|0)>=20){b=b&255;c=a&3;g=b|b<<8|b<<16|b<<24;h=e&~3;if(c){c=a+4-c|0;while((a|0)<(c|0)){d[a]=b;a=a+1|0}}while((a|0)<(h|0)){f[a>>2]=g;a=a+4|0}}while((a|0)<(e|0)){d[a]=b;a=a+1|0}}function tb(a,b,c){a=a|0;b=b|0;c=c|0;var e=0;e=a|0;if((a&3)==(b&3)){while(a&3){if((c|0)==0)return e|0;d[a]=d[b]|0;a=a+1|0;b=b+1|0;c=c-1|0}while((c|0)>=4){f[a>>2]=f[b>>2];a=a+4|0;b=b+4|0;c=c-4|0}}while((c|0)>0){d[a]=d[b]|0;a=a+1|0;b=b+1|0;c=c-1|0}return e|0}function ub(a,b){a=a|0;b=b|0;return Cb[a&1](b|0)|0}function vb(a){a=a|0;Db[a&1]()}function wb(a,b,c){a=a|0;b=b|0;c=c|0;return Eb[a&1](b|0,c|0)|0}function xb(a,b){a=a|0;b=b|0;Fb[a&1](b|0)}function yb(a){a=a|0;ba(0);return 0}function zb(){ba(1)}function Ab(a,b){a=a|0;b=b|0;ba(2);return 0}function Bb(a){a=a|0;ba(3)}var Cb=[yb,yb];var Db=[zb,zb];var Eb=[Ab,Ab];var Fb=[Bb,Bb];return{_strlen:rb,_crn_get_levels:hb,_crn_get_uncompressed_size:kb,_crn_decompress:lb,_crn_get_width:fb,_realloc:pb,_crn_get_bytes_per_block:jb,_memset:sb,_malloc:nb,_memcpy:tb,_free:ob,_crn_get_height:gb,_crn_get_dxt_format:ib,runPostSets:Xa,stackAlloc:Ha,stackSave:Ia,stackRestore:Ja,setThrew:Ka,setTempRet0:Na,setTempRet1:Oa,setTempRet2:Pa,setTempRet3:Qa,setTempRet4:Ra,setTempRet5:Sa,setTempRet6:Ta,setTempRet7:Ua,setTempRet8:Va,setTempRet9:Wa,dynCall_ii:ub,dynCall_v:vb,dynCall_iii:wb,dynCall_vi:xb}}({Math:Math,Int8Array:Int8Array,Int16Array:Int16Array,Int32Array:Int32Array,Uint8Array:Uint8Array,Uint16Array:Uint16Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array},{abort:E,assert:A,asmPrintInt:function(a,b){s.print("int "+a+","+b)},asmPrintFloat:function(a,b){s.print("float "+a+","+b)},min:Ca,invoke_ii:function(a,b){try{return s.dynCall_ii(a,b)}catch(c){"number"!=typeof c&&"longjmp"!==c&&e(c),$.setThrew(1,0)}},invoke_v:function(a){try{s.dynCall_v(a)}catch(b){"number"!=typeof b&&"longjmp"!==b&&e(b),$.setThrew(1,0)}},invoke_iii:function(a,b,c){try{return s.dynCall_iii(a,b,c)}catch(d){"number"!=typeof d&&"longjmp"!==d&&e(d),$.setThrew(1,0)}},invoke_vi:function(a,b){try{s.dynCall_vi(a,b)}catch(c){"number"!=typeof c&&"longjmp"!==c&&e(c),$.setThrew(1,0)}},_llvm_lifetime_end:q(),_snprintf:nb,_abort:function(){s.abort()},_fprintf:jc,_printf:function(a,b){return jc(K[Cb>>2],a,b)},_fflush:q(),__reallyNegative:lb,_sysconf:function(a){switch(a){case 30:return 4096;case 132:case 133:case 12:case 137:case 138:case 15:case 235:case 16:case 17:case 18:case 19:case 20:case 149:case 13:case 10:case 236:case 153:case 9:case 21:case 22:case 159:case 154:case 14:case 77:case 78:case 139:case 80:case 81:case 79:case 82:case 68:case 67:case 164:case 11:case 29:case 47:case 48:case 95:case 52:case 51:case 46:return 200809;case 27:case 246:case 127:case 128:case 23:case 24:case 160:case 161:case 181:case 182:case 242:case 183:case 184:case 243:case 244:case 245:case 165:case 178:case 179:case 49:case 50:case 168:case 169:case 175:case 170:case 171:case 172:case 97:case 76:case 32:case 173:case 35:return-1;case 176:case 177:case 7:case 155:case 8:case 157:case 125:case 126:case 92:case 93:case 129:case 130:case 131:case 94:case 91:return 1;case 74:case 60:case 69:case 70:case 4:return 1024;case 31:case 42:case 72:return 32;case 87:case 26:case 33:return 2147483647;case 34:case 1:return 47839;case 38:case 36:return 99;case 43:case 37:return 2048;case 0:return 2097152;case 3:return 65536;case 28:return 32768;case 44:return 32767;case 75:return 16384;case 39:return 1e3;case 89:return 700;case 71:return 256;case 40:return 255;case 2:return 100;case 180:return 64;case 25:return 20;case 5:return 16;case 6:return 6;case 73:return 4;case 84:return 1}return S(R.u),-1},___setErrNo:S,_fwrite:ic,_send:function(a,b,c){return Z.ub(a)?hc(a,b,c):(S(R.ba),-1)},_write:hc,_exit:function(a){mc(a)},_sprintf:function(a,b,c){return nb(a,j,b,c)},__formatString:mb,__ZSt9terminatev:function(){mc(-1234)},_pwrite:function(a,b,c,d){if(a=X[a],!a)return S(R.ba),-1;try{return ac(a,I,b,c,d)}catch(e){return Jb(e),-1}},_sbrk:nc,___errno_location:function(){return pb},___gxx_personality_v0:q(),_llvm_lifetime_start:q(),_time:function(a){var b=Math.floor(Date.now()/1e3);return a&&(K[a>>2]=b),b},__exit:mc,STACKTOP:x,STACK_MAX:Sa,tempDoublePtr:jb,ABORT:ua,NaN:NaN,Infinity:1/0},N),kb=s._strlen=$._strlen;s._crn_get_levels=$._crn_get_levels,s._crn_get_uncompressed_size=$._crn_get_uncompressed_size,s._crn_decompress=$._crn_decompress,s._crn_get_width=$._crn_get_width,s._realloc=$._realloc,s._crn_get_bytes_per_block=$._crn_get_bytes_per_block;var kc=s._memset=$._memset,Ka=s._malloc=$._malloc,lc=s._memcpy=$._memcpy;s._free=$._free,s._crn_get_height=$._crn_get_height,s._crn_get_dxt_format=$._crn_get_dxt_format;var ib=s.runPostSets=$.runPostSets;s.dynCall_ii=$.dynCall_ii,s.dynCall_v=$.dynCall_v,s.dynCall_iii=$.dynCall_iii,s.dynCall_vi=$.dynCall_vi,oa=function(a){return $.stackAlloc(a)},ha=function(){return $.stackSave()},ia=function(a){$.stackRestore(a)},Ec.prototype=Error();var Fc,Gc=m,fb=function a(){!s.calledRun&&Ic&&Jc(),s.calledRun||(fb=a)};if(s.callMain=s.Nd=function(a){function b(){for(var a=0;3>a;a++)d.push(0)}A(0==Q,"cannot call main when async dependencies remain! (listen on __ATMAIN__)"),A(0==Va.length,"cannot call main when preRun functions remain to be called"),a=a||[],ba&&Gc!==m&&s.P("preload time: "+(Date.now()-Gc)+" ms"),Za||(Za=l,Ua(O));var c=a.length+1,d=[L(H("/bin/this.program"),"i8",0)];b();for(var f=0;f<c-1;f+=1)d.push(L(H(a[f]),"i8",0)),b();d.push(0),d=L(d,"i32",0),Fc=x;try{var g=s._main(c,d,0);s.noExitRuntime||Kc(g)}catch(h){h instanceof Ec||("SimulateInfiniteLoop"==h?s.noExitRuntime=l:(h&&"object"==typeof h&&h.stack&&s.P("exception thrown: "+[h,h.stack]),e(h)))}finally{}},s.run=s.ge=Jc,s.exit=s.Rd=Kc,s.abort=s.abort=E,s.preInit)for("function"==typeof s.preInit&&(s.preInit=[s.preInit]);0<s.preInit.length;)s.preInit.pop()();var Ic=l;return s.noInitialRun&&(Ic=p),Jc(),Module}!function(a){function b(a){return!j||/\B\$super\b/.test(a.toString())}function c(b,c,d){d===a?delete b[c]:b[c]=d}function d(b,c){return Object.prototype.hasOwnProperty.call(b,c)?b[c]:a}function e(a){i=!0;var b=new a;return i=!1,b}var f="1.4",g=this,h=g.Class,i=!1,j=function(){$super()}.toString().indexOf("$super")>0,k=function(){};k.$noConflict=function(){try{c(g,"Class",h)}catch(a){g.Class=h}return k},k.$classyVersion=f,k.$extend=function(f){var h=this.prototype,j=e(this);if(f.__include__)for(var l=0,m=f.__include__.length;l!=m;++l){var n=f.__include__[l];for(var o in n){var p=d(n,o);p!==a&&(j[o]=n[o])}}if(f.__classvars__=f.__classvars__||{},j.__classvars__)for(var q in j.__classvars__)if(!f.__classvars__[q]){var p=d(j.__classvars__,q);f.__classvars__[q]=p}for(var o in f){var p=d(f,o);"__include__"!==o&&p!==a&&(j[o]="function"==typeof p&&b(p)?function(a,b){return function(){var e=d(this,"$super");this.$super=h[b];try{return a.apply(this,arguments)}finally{c(this,"$super",e)}}}(p,o):p)}var r=function(){if(!i){var a=g===this?e(arguments.callee):this;return a.__init__&&a.__init__.apply(a,arguments),a.$class=r,a}};for(var q in f.__classvars__){var p=d(f.__classvars__,q);p!==a&&(r[q]=p)}return r.prototype=j,r.constructor=r,r.$extend=k.$extend,r.$withData=k.$withData,r},k.$withData=function(b){var c=e(this);for(var f in b){var g=d(b,f);g!==a&&(c[f]=g)}return c},g.Class=k}(),function(){if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var a=Date.now();performance.timing&&performance.timing.navigationStart&&(a=performance.timing.navigationStart),
window.performance.now=function(){return Date.now()-a}}}();var Tundra={container:null,client:null,audio:null,config:null,events:null,network:null,frame:null,console:null,asset:null,input:null,ui:null,scene:null,renderer:null,APINames:function(){return["Tundra","TundraClient","AudioAPI","ConfigAPI","Network","FrameAPI","EventAPI","AssetAPI","InputAPI","UiAPI","ConsoleAPI","Scene"]},framework:{},Classes:{},pluginList:[],plugins:{},registerPlugin:function(a){if(void 0===a||null===a)return!1;a._setFramework(this),this.pluginList.push(a);var b=a.pluginPropertyName();return"string"==typeof b&&""!==b||(b=a.name),"string"==typeof b&&""!==b&&(b=b.substring(0,1).toLowerCase()+b.substring(1),void 0===this.plugins[b]?this.plugins[b]=a:console.error("Plugin '"+a.name+"' property name '"+b+"' is already reserved in Tundra.plugins. Skipping registration.")),!0},plugin:function(a){for(var b=0;b<this.pluginList.length;b++){var c=this.pluginList[b];if(c.name===a)return c;if(Array.isArray(c.nameAliases)&&c.nameAliases.length>0)for(var d=0;d<c.nameAliases.length;d++)if(c.nameAliases[d]===a)return c}return null},pluginNames:function(){for(var a=[],b=0;b<this.pluginList.length;b++)try{a.push(this.pluginList[b].name)}catch(c){}return a},loadPlugins:function(a){var b;for(b=0;b<this.pluginList.length;b++)if(this.pluginList[b].loaded!==!0)try{var c=this.pluginList[b];c._initialize($.extend({},a[c.name]))}catch(d){console.error("[Tundra]: Failed to initialize "+this.pluginList[b].name+":",d.toString()),console.error(d.stack||d)}for(b=0;b<Tundra.pluginList.length;b++)try{var c=this.pluginList[b];c._postInitialize($.extend({},a[c.name]))}catch(d){console.error("[Tundra]: Failed to postInitialize "+this.pluginList[b].name+":",d.toString()),console.error(d.stack||d)}},debugOnCheckFail:!1,throwOnCheckFail:!1,checkDefined:function(){if(Tundra.debugOnCheckFail||Tundra.throwOnCheckFail)for(var a=0;a<arguments.length;a++)if(void 0===arguments[a])if(Tundra.debugOnCheckFail);else if(Tundra.throwOnCheckFail)throw"undefined value, arg #"+a},check:function(){if(Tundra.debugOnCheckFail||Tundra.throwOnCheckFail)for(var a=0;a<arguments.length;a++)if(arguments[a]!==!0)if(Tundra.debugOnCheckFail);else if(Tundra.throwOnCheckFail)throw"untrue value"+arguments[a]+", arg #"+a},noop:function(){},getDefaultOptions:function(){return{requirejs:!1,polymer:!1,deprecatedWarnings:!1}},options:{},usingRequireJS:function(){return this.options.requirejs===!0&&"function"==typeof require},usingPolymer:function(){return this.options.polymer===!0&&"function"==typeof Polymer},resolvePolymerResources:function(a){console.warn("DEPRECATED: Tundra.resolvePolymerResources > AssetAPI.loadDependencies");var b=[];Array.isArray(a)||(a=[a]);for(var c=0;c<a.length;c++)this.asset.isRelativeRef(a[c])?b.push(this.asset.getLocalAssetPath(a[c])):b.push(a[c]);return b},browser:{isChrome:void 0!==navigator&&navigator.userAgent.indexOf("Chrome")>-1,isExplorer:void 0!==navigator&&navigator.userAgent.indexOf("MSIE")>-1,isFirefox:void 0!==navigator&&navigator.userAgent.indexOf("Firefox")>-1,isSafari:void 0!==navigator&&navigator.userAgent.indexOf("Safari")>-1,isOpera:void 0!==navigator&&(navigator.userAgent.indexOf("Presto")>-1||navigator.userAgent.indexOf("Opera")>-1||navigator.userAgent.indexOf("OPR/")>-1),isMobileAndroid:function(){var a=navigator.userAgent.match(/Android/i);return void 0!==a&&null!==a},isMobileBlackBerry:function(){var a=navigator.userAgent.match(/BlackBerry/i);return void 0!==a&&null!==a},isMobileiOS:function(){var a=navigator.userAgent.match(/iPhone|iPad|iPod/i);return void 0!==a&&null!==a},isMobileOpera:function(){var a=navigator.userAgent.match(/Opera Mini/i);return void 0!==a&&null!==a},isMobileWindows:function(){var a=navigator.userAgent.match(/IEMobile/i)||navigator.userAgent.match(/WPDesktop/i);return void 0!==a&&null!==a},_isMobileCached:void 0,isMobile:function(){return"boolean"==typeof this._isMobileCached?this._isMobileCached:(this._isMobileCached=this.isMobileAndroid()||this.isMobileiOS()||this.isMobileBlackBerry()||this.isMobileOpera()||this.isMobileWindows(),this._isMobileCached)},name:function(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+)/g.exec(b)||[],"IE "+(a[1]||"")):"Chrome"===c[1]&&(a=b.match(/\bOPR\/(\d+)/),null!=a)?"Opera "+a[1]:(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c[0])},version:function(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+)/g.exec(b)||[],"IE "+(a[1]||"")):"Chrome"===c[1]&&(a=b.match(/\bOPR\/(\d+)/),null!=a)?"Opera "+a[1]:(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c[1])}}};window.Tundra=Tundra,window.TundraSDK=Tundra,Object.defineProperties(Tundra.framework,{client:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.client > Tundra.client"),Tundra.client}},network:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.network > Tundra.network"),Tundra.network}},scene:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.scene > Tundra.scene"),Tundra.scene}},renderer:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.renderer > Tundra.renderer"),Tundra.renderer}},frame:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.frame > Tundra.frame"),Tundra.frame}},events:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.events > Tundra.events"),Tundra.events}},asset:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.asset > Tundra.asset"),Tundra.asset}},input:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.input > Tundra.input"),Tundra.input}},ui:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.ui > Tundra.ui"),Tundra.ui}},console:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.console > Tundra.console"),Tundra.console}}});var TundraLogger=Class.$extend({__init__:function(a){this.name=a,this.prefix="["+a+"]:"},isDebug:function(){return log&&log.level<=1},_createArguments:function(a,b){for(var c=[this.prefix],d=0,e=a.length;d<e;d++)c.push(a[d]);return b===!0&&c.splice(0,0,this._callerLine()),c},_createArgumentsString:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];Array.isArray(d)?b.push("["+d.join(", ")+"]"):"object"==typeof d?b.push(JSON.stringify(d)):b.push(d.toString())}return b.join(" ")},_callerLineLink:function(a){void 0===a&&(a=4);var b=(new Error).stack.split("\n")[a];return b=b.substring(b.indexOf("at ")+3),b.substring(b.lastIndexOf("(")+1,b.length-1)},info:function(){log.info.apply(null,this._createArguments(arguments))},infoC:function(){var a=this._createArguments(arguments);log.info.apply(null,a),null!=Tundra.console&&Tundra.console.logInfo(this._createArgumentsString(a))},warn:function(){log.warn.apply(null,this._createArguments(arguments))},warnC:function(){var a=this._createArguments(arguments);log.warn.apply(null,a),null!=Tundra.console&&Tundra.console.logWarning(this._createArgumentsString(a))},error:function(){log.error.apply(null,this._createArguments(arguments))},errorC:function(){var a=this._createArguments(arguments);log.error.apply(null,a),null!=Tundra.console&&Tundra.console.logError(this._createArgumentsString(a))},debug:function(){log.debug.apply(null,this._createArguments(arguments))},trace:function(){log.trace.apply(null,this._createArguments(arguments))}}),TundraLogging={Level:{TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},loggers:{},CurrentLevel:"INFO",DebugLevelEnabled:!1,getLogger:function(a){return this.get(a)},get:function(a){var b=this.loggers[a];return void 0===b&&(b=this.loggers[a]=new TundraLogger(a)),b},enableAll:function(){log.enableAll()},disableAll:function(){log.disableAll()},setLevel:function(a){if("string"==typeof a)a=a.toUpperCase();else if("number"!=typeof a)return;this.CurrentLevel=this.levelString(a),this.DebugLevelEnabled="DEBUG"===this.CurrentLevel||"TRACE"===this.CurrentLevel,log.setLevel(a),log.debug("[WebTundra]: Setting log level to",this.CurrentLevel)},levelString:function(a){if("string"==typeof a)return a;if("number"==typeof a)for(var b in TundraLogging.Level)if(a===TundraLogging.Level[b])return b;return"Invalid loglevel "+a.toString()}};Tundra.Classes.TundraLogging=TundraLogging;var CoreStringUtils={_splitLinesRegExp:/\r?\n/g,_dblFwdSlashRegExp:/^\s*\/\/.*/gm,_whiteSpaceStartRegExp:/^\s+/,_whiteSpaceEndRegExp:/\s+$/,uuid:function(){return THREE.Math.generateUUID()},formatNumber:function(a){return a.toLocaleString("fr-FR")},startsWith:function(a,b,c){return 0===CoreStringUtils.indexOf(a,b,c)},endsWith:function(a,b,c){var d=a.length-b.length;return c===!0?d>-1&&a.toLowerCase().substring(d)===b.toLowerCase():d>-1&&a.substring(d)===b},indexOf:function(a,b,c){return c=c||!1,c?a.toLowerCase().indexOf(b.toLowerCase()):a.indexOf(b)},trim:function(a){return a.trim?a.trim():a.replace(this._whiteSpaceStartRegExp,"").replace(this._whiteSpaceEndRegExp,"")},trimLeft:function(a){return a.trimLeft?a.trimLeft():a.replace(this._whiteSpaceStartRegExp,"")},trimStringLeft:function(a,b){for(var c=b.length;a.length>0&&a.substring(0,c)===b;)a=a.substring(c);return a},trimRight:function(a){return a.trimRight?a.trimRight():a.replace(this._whiteSpaceEndRegExp,"")},trimStringRight:function(a,b){for(var c=b.length;a.length>0&&a.substring(a.length-c)===b;)a=a.substring(0,a.length-c);return a},readLine:function(a,b,c,d){c="boolean"==typeof c&&c,d="boolean"==typeof d&&d;var e=-1,f=a.indexOf("\n"),g=a.indexOf("\r\n"),h=c?a.indexOf("\t"):-1,i="string"==typeof b&&""!==b?a.indexOf(b):-1;(e===-1||f!==-1&&f<e)&&(e=f),(e===-1||g!==-1&&g<e)&&(e=g),(e===-1||h!==-1&&h<e)&&(e=h),(e===-1||i!==-1&&i<e)&&(e=i);var j=e!==-1?a.substring(0,e):"";return d&&(j=this.trim(j)),j},splitLines:function(a){return a.split(this._splitLinesRegExp)},removeEmptyLines:function(a){if("string"!=typeof a||""===a)return a;for(var b="\n"===a[a.length-1],c=this.splitLines(a),d=0;d<c.length;d++)""===this.trim(c[d])&&(c.splice(d,1),d--);return c.join("\n")+(b?"\n":"")},extension:function(a){var b=this.trim(a);this.startsWith(b,"http",!0)&&b.indexOf("?")!==-1&&(b=b.substring(0,b.indexOf("?")));var c=b.lastIndexOf(".");return c!==-1?b.substring(c).toLowerCase():""},removeComments:function(a){if("string"!=typeof a||""===a)return a;var b=a.indexOf("/*");if(b!==-1)for(var c=a.indexOf("*/",b+2);b!==-1&&c!==-1;){var d=a.substring(0,b),e=a.substring(c+2);a=d+e,b=a.indexOf("/*"),b!==-1&&(c=a.indexOf("*/",b+2))}return this._dblFwdSlashRegExp.test(a)&&(a=a.replace(this._dblFwdSlashRegExp,"")),a},queryValue:function(a){if(""===window.location.search||"string"!=typeof a||""===a)return"";a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(window.location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))},queryValueBool:function(a){var b=this.queryValue(a);return"string"==typeof b&&""!==b&&("true"===b.toLowerCase()||"1"===b)},queryValueInt:function(a,b){b="number"==typeof b?b:0;var c=this.queryValue(a);if("string"==typeof c&&""!==c){var d=parseInt(c);if("number"==typeof d&&!isNaN(d))return d}return b},queryValueFloat:function(a,b){b="number"==typeof b?b:0;var c=this.queryValue(a);if("string"==typeof c&&""!==c){var d=parseFloat(c);if("number"==typeof d&&!isNaN(d))return d}return b},createQueryString:function(a,b){if("object"!=typeof a)return console.error("CoreStringUtils.query: 'options' must bea object"),"";b="boolean"==typeof b&&b;var c="";for(var d in a){var e=a[d].toString();b&&(e=encodeURIComponent(e)),c+=""===c?"?"+d+"="+e:"&"+d+"="+e}return c},enumToString:function(a,b,c){for(var d in a)if(a.hasOwnProperty(d)&&"number"==typeof a[d]&&b===a[d])return d;return c},stringToEnum:function(a,b,c,d){for(var e in a)if(a.hasOwnProperty(e)&&"number"==typeof a[e]&&b.match(new RegExp(e,d?"":"i")))return a[e];return c},parseCommand:function(a){var b={command:"",parameters:[]};if(a=a.trim(),0===a.length)return b;var c=a.indexOf("(");if(c==-1)return b.command=a,b;b.command=a.slice(0,c).trim();var d=a.lastIndexOf(")");d!=-1&&d==a.length-1&&(a=a.substring(0,d)),b.parameters=a.substring(c+1).split(",");for(var e=0;e<b.parameters.length;++e)b.parameters[e]=b.parameters[e].trim();return b}};Tundra.Classes.CoreStringUtils=CoreStringUtils;var MathUtils=Class.$extend({__init__:function(){Object.defineProperties(this,{Zero:{enumerable:!1,writable:!1,value:0},One:{enumerable:!1,writable:!1,value:1},DefaultEpsilon:{enumerable:!1,writable:!1,value:1e-6},TypeOfNumber:{enumerable:!1,writable:!1,value:"number"},SubComponents:{enumerable:!1,writable:!1,value:["x","y","z","w"]},RegExpFloats:{enumerable:!1,writable:!1,value:/[+\-]?((?:[1-9]\d*|0)(?:\.\d*)?|\.\d+)([eE][+-]?\d+)?/g}})},isNaN:Number.isNaN||window.isNaN,isFinite:Number.isFinite||window.isFinite,isInteger:Number.isInteger||function(a){return this.isNumber(nVal)&&this.isFinite(a)&&a>-9007199254740992&&a<9007199254740992&&Math.floor(a)===a},parseFloat:Number.parseFloat||window.parseFloat,parseInt:Number.parseInt||window.parseInt,isNumber:function(a){return typeof a===this.TypeOfNumber&&!this.isNaN(a)},isPow2:function(a){return 0===(a&a-1)},lerp:function(a,b,c){return a+c*(b-a)},clamp:function(a,b,c){return this.isNaN(a)?b:a<=c?a>=b?a:b:c},clamp01:function(a,b,c){return this.clamp(a,0,1)},clampVector3:function(a,b,c){return a.set(this.clamp(a.x,b,c),this.clamp(a.y,b,c),this.clamp(a.z,b,c))},symmetricRandom:function(){return 2*Math.random()-1},equal:function(a,b,c){return!this.isNaN(a)&&!this.isNaN(b)&&Math.abs(a-b)<=(c||this.DefaultEpsilon)},equalVector2:function(a,b,c){return this.equal(a.x,b.x,c)&&this.equal(a.y,b.y,c)},equalVector3:function(a,b,c){return this.equal(a.x,b.x,c)&&this.equal(a.y,b.y,c)&&this.equal(a.z,b.z,c)},equalVector4:function(a,b,c){return this.equalVector3(a,b,c)&&this.equal(a.w,b.w,c)},equalQuaternion:function(a,b,c){return this.equalVector4(a,b,c)},isZero:function(a,b){return this.equal(a,this.Zero,b)},isZeroVector2:function(a,b){return this.isZero(a.x,b)&&this.isZero(a.y,b)},isZeroVector3:function(a,b){return this.isZero(a.x,b)&&this.isZero(a.y,b)&&this.isZero(a.z,b)},isZeroVector4:function(a,b){return this.isZeroVector3(a,b)&&this.isZero(a.w,b)},isZeroQuaternion:function(a,b){return this.isZeroVector3(a,b)&&this.equal(a.w,this.One,b)},isFiniteVector2:function(a){return this.isFinite(a.x)&&this.isFinite(a.y)},isFiniteVector3:function(a){return this.isFinite(a.x)&&this.isFinite(a.y)&&this.isFinite(a.z)},isFiniteVector4:function(a){return this.isFiniteVector3(a)&&this.isFinite(a.w)},isFiniteQuaternion:function(a){return this.isFiniteVector4(a)},isFiniteBox3:function(a){return this.isFiniteVector3(a.min)&&this.isFiniteVector3(a.max)},radToDeg:function(a){return THREE.Math.radToDeg(a)},degToRad:function(a){return THREE.Math.degToRad(a)},radToDegVector3:function(a){return new THREE.Vector3(this.radToDeg(a.x),this.radToDeg(a.y),this.radToDeg(a.z))},degToRadVector3:function(a){return new THREE.Vector3(this.degToRad(a.x),this.degToRad(a.y),this.degToRad(a.z))},parseFloatsTo:function(a,b){if("string"==typeof a&&void 0!==b&&null!==b&&"object"==typeof b){var c=a.match(this.RegExpFloats);if(c)for(var d=0;d<4&&!(c.length<=d);++d){var e=this.parseFloat(c[d]);this.isNaN(e)&&(e=0),b[this.SubComponents[d]]=e}}},round:function(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)},roundVector2:function(a,b){return new THREE.Vector2(this.round(a.x,b),this.round(a.y,b))},roundVector3:function(a,b){return new THREE.Vector3(this.round(a.x,b),this.round(a.y,b),this.round(a.z,b))},roundVector4:function(a,b){return new THREE.Vector4(this.round(a.x,b),this.round(a.y,b),this.round(a.z,b),this.round(a.w,b))},splitToFloats:function(a,b){if("string"==typeof b&&""!==b||(a.indexOf(",")!==-1?b=",":a.indexOf(";")!==-1?b=";":a.indexOf(" ")!==-1&&(b=" "),b=a.indexOf(",")!==-1?",":a.indexOf(" ")?" ":void 0),"string"!=typeof b||""===b)return console.warn("MathUtils.splitToFloats: Failed to find common separator from '"+a+"'"),[];if("string"!=typeof a||""===a)return console.warn("MathUtils.splitToFloats: Invalid input string '"+a+"'"),[];for(var c=a.split(b),d=0;d<c.length;d++){var e=this.parseFloat(c[d]);this.isNumber(e)?c[d]=e:(console.warn("MathUtils.splitToFloats: Failed to parse float from '"+c[d]+"', assigning NaN to index",d),c[d]=NaN)}return c},splitToIntegers:function(a,b){if("string"==typeof b&&""!==b||(a.indexOf(",")!==-1?b=",":a.indexOf(";")!==-1?b=";":a.indexOf(" ")!==-1&&(b=" "),b=a.indexOf(",")!==-1?",":a.indexOf(" ")?" ":void 0),"string"!=typeof b||""===b)return console.warn("MathUtils.splitToIntegers: Failed to find common separator from '"+a+"'"),[];if("string"!=typeof a||""===a)return console.warn("MathUtils.splitToIntegers: Invalid input string '"+a+"'"),[];for(var c=a.split(b),d=0;d<c.length;d++){var e=this.parseInt(c[d]);this.isNumber(e)?c[d]=e:(console.warn("MathUtils.splitToIntegers: Failed to parse int from '"+c[d]+"', assigning NaN to index",d),c[d]=NaN)}return c}});!function(a){THREE.Vector2.prototype.equals=function(b,c){return a.equalVector2(this,b,c)},THREE.Vector3.prototype.equals=function(b,c){return a.equalVector3(this,b,c)},THREE.Vector4.prototype.equals=function(b,c){return a.equalVector4(this,b,c)},THREE.Quaternion.prototype.equals=function(b,c){return a.equalQuaternion(this,b,c)},THREE.Vector2.prototype.isZero=function(b){return a.isZeroVector2(this,b)},THREE.Vector3.prototype.isZero=function(b){return a.isZeroVector3(this,b)},THREE.Vector4.prototype.isZero=function(b){return a.isZeroVector4(this,b)},THREE.Quaternion.prototype.isZero=function(b){return a.isZeroQuaternion(this,b)},THREE.Vector2.prototype.isFinite=function(){return a.isFiniteVector2(this)},THREE.Vector3.prototype.isFinite=function(){return a.isFiniteVector3(this)},THREE.Vector4.prototype.isFinite=function(){return a.isFiniteVector4(this)},THREE.Quaternion.prototype.isFinite=function(){return a.isFiniteQuaternion(this)},THREE.Box3.prototype.isFinite=function(){return a.isFiniteBox3(this)},THREE.Box3.prototype.isDegenerate=function(){return this.min.x>this.max.x||this.min.y>this.max.y||this.min.z>this.max.z},THREE.Vector2.fromString=function(b){var c=new THREE.Vector2;return a.parseFloatsTo(b,c),c},THREE.Vector3.fromString=function(b){var c=new THREE.Vector3;return a.parseFloatsTo(b,c),c},THREE.Vector4.fromString=function(b){var c=new THREE.Vector4;return a.parseFloatsTo(b,c),c},THREE.Quaternion.fromString=function(b){var c=new THREE.Quaternion;return a.parseFloatsTo(b,c),c},THREE.Vector2.prototype.setFromString=function(b){a.parseFloatsTo(b,this)},THREE.Vector3.prototype.setFromString=function(b){a.parseFloatsTo(b,this)},THREE.Vector4.prototype.setFromString=function(b){a.parseFloatsTo(b,this)},THREE.Quaternion.prototype.setFromString=function(b){a.parseFloatsTo(b,this)},THREE.Box2.prototype.toString=function(){return"(min: "+this.min+" max: "+this.max+")"},THREE.Box3.prototype.toString=function(){return"(min: "+this.min+" max: "+this.max+")"},THREE.Color.prototype.toString=function(){return"("+this.r+", "+this.g+", "+this.b+")"},THREE.Euler.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+" "+this.order+")"},THREE.Vector2.prototype.toString=function(){return"("+this.x+", "+this.y+")"},THREE.Vector3.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"},THREE.Vector4.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"},THREE.Quaternion.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"},THREE.Matrix3.prototype.toString=function(){var a=this.elements;return"("+a[0]+", "+a[3]+", "+a[6]+") ("+a[1]+", "+a[4]+", "+a[7]+") ("+a[2]+", "+a[5]+", "+a[8]+")"},THREE.Matrix4.prototype.toString=function(){var a=this.elements;return"("+a[0]+", "+a[4]+", "+a[8]+", "+a[12]+") ("+a[1]+", "+a[5]+", "+a[9]+", "+a[13]+") ("+a[2]+", "+a[6]+", "+a[10]+" ,"+a[14]+") ("+a[3]+", "+a[7]+", "+a[11]+" ,"+a[15]+")"},THREE.Plane.prototype.toString=function(){return"Plane(Normal:("+this.normal.x+", "+this.normal.y+", "+this.normal.z+") d:"+this.constant+")"}}(new MathUtils),Tundra.Classes.MathUtils=MathUtils,window.MathUtils=new MathUtils;var ITundraSerializer=Class.$extend({__init__:function(){},serializeToObject:function(){console.error("[ITundraSerializer]: serializeToObject not implemented!")},serializeToXml:function(){console.error("[ITundraSerializer]: serializeToXml not implemented!")},serializeToBinary:function(){console.error("[ITundraSerializer]: serializeToBinary not implemented!")},deserializeFromObject:function(a,b){console.error("[ITundraSerializer]: deserializeFromObject not implemented!")},deserializeFromXml:function(a,b){console.error("[ITundraSerializer]: deserializeFromXml not implemented!")}}),AttributeChange=Class.$extend({__init__:function(){},__classvars__:{Default:0,Disconnected:1,LocalOnly:2,Replicate:3}}),Transform=Class.$extend({__init__:function(a,b,c){void 0===a||a instanceof THREE.Vector3||TundraLogging.getLogger("Transform").warn("Constructor 'pos' parameter is not a THREE.Vector3",a),void 0===b||b instanceof THREE.Vector3||TundraLogging.getLogger("Transform").warn("Constructor 'rot' parameter is not a THREE.Vector3",b),void 0===c||c instanceof THREE.Vector3||TundraLogging.getLogger("Transform").warn("Constructor 'scale' parameter is not a THREE.Vector3",c),this._pos=a instanceof THREE.Vector3?a:new THREE.Vector3(0,0,0),this._rot=b instanceof THREE.Vector3?b:new THREE.Vector3(0,0,0),this._scale=c instanceof THREE.Vector3?c:new THREE.Vector3(1,1,1),this._rotEuler=new THREE.Euler(THREE.Math.degToRad(this._rot.x),THREE.Math.degToRad(this._rot.y),THREE.Math.degToRad(this._rot.z),"ZYX"),Object.defineProperties(this,{pos:{get:function(){return this._pos},set:function(a){this.setPosition(a)}},rot:{get:function(){return this._rot},set:function(a){this.setRotation(a)}},scale:{get:function(){return this._scale},set:function(a){this.setScale(a)}}})},reset:function(){this.setScale(1,1,1),this.setPosition(0,0,0),this.setRotation(0,0,0)},copy:function(a){this._pos.copy(a._pos),this._rot.copy(a._rot),this._scale.copy(a._scale)},decompose:function(a,b,c){a instanceof Transform?(a._pos.copy(this._pos),a._rot.copy(this._rot),a._scale.copy(this._scale)):(a instanceof THREE.Vector3&&a.copy(this._pos),b instanceof THREE.Vector3&&b.copy(this._rot),c instanceof THREE.Vector3&&c.copy(this._scale))},apply:function(a){a.position.copy(this._pos),this.copyOrientationTo(a.quaternion),a.scale.copy(this._scale),a.updateMatrix(),a.updateMatrixWorld(!0)},lookAt:function(a,b){this.setRotation(this.lookAtQuaternion(a,b))},lookAtQuaternion:function(a,b){return void 0===this._orientationMatrix&&(this._orientationMatrix=new THREE.Matrix4),this._orientationMatrix.makeTranslation(0,0,0),this._orientationMatrix.lookAt(a,b,Tundra.renderer.axisY),(new THREE.Quaternion).setFromRotationMatrix(this._orientationMatrix)},orientation:function(a){if(this._updateEuler(),void 0!==a&&a instanceof THREE.Quaternion)return a.setFromEuler(this._rotEuler,!1),a;var b=new THREE.Quaternion;return b.setFromEuler(this._rotEuler,!1),b},quaternion:function(){return this.orientation()},copyOrientationTo:function(a){this._updateEuler(),a.setFromEuler(this._rotEuler,!1)},_updateEuler:function(){this._rotEuler.set(THREE.Math.degToRad(this._rot.x%360),THREE.Math.degToRad(this._rot.y%360),THREE.Math.degToRad(this._rot.z%360))},euler:function(){return this._updateEuler(),this._rotEuler.clone()},setPosition:function(a,b,c){a instanceof THREE.Vector3?this._pos.copy(a):"number"==typeof a&&"number"==typeof b&&"number"==typeof c?(this._pos.x=a,this._pos.y=b,this._pos.z=c):"object"==typeof a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z?(this._pos.x=a.x,this._pos.y=a.y,this._pos.z=a.z):TundraLogging.getLogger("Transform").error("setPosition must be called with a single Three.Vector3 or x,y,z with type of number.",a,b,c)},setRotation:function(a,b,c){a instanceof THREE.Vector3?this._rot.copy(a):a instanceof THREE.Quaternion?(this._rotEuler.setFromQuaternion(a.normalize(),void 0,!1),this._rot.x=THREE.Math.radToDeg(this._rotEuler.x)%360,this._rot.y=THREE.Math.radToDeg(this._rotEuler.y)%360,this._rot.z=THREE.Math.radToDeg(this._rotEuler.z)%360):a instanceof THREE.Euler?(this._rot.x=THREE.Math.radToDeg(a.x)%360,this._rot.y=THREE.Math.radToDeg(a.y)%360,this._rot.z=THREE.Math.radToDeg(a.z)%360):"number"==typeof a&&"number"==typeof b&&"number"==typeof c?(this._rot.x=a,this._rot.y=b,this._rot.z=c):"object"==typeof a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z?(this._rot.x=a.x,this._rot.y=a.y,this._rot.z=a.z):TundraLogging.getLogger("Transform").error("setRotation must be called with a single Three.Vector3, THREE.Quaternion or x,y,z with type of number.",a,b,c)},setScale:function(a,b,c){return a instanceof THREE.Vector3?this._scale.copy(a):"number"==typeof a&&"number"==typeof b&&"number"==typeof c?(this._scale.x=a,this._scale.y=b,this._scale.z=c):"object"==typeof a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z?(this._scale.x=a.x,this._scale.y=a.y,this._scale.z=a.z):TundraLogging.getLogger("Transform").error("setScale must be called with a single Three.Vector3 or x,y,z with type of number.",a,b,c),!1},clone:function(){return new Transform(this.pos.clone(),this.rot.clone(),this.scale.clone())},fromString:function(a){var b=MathUtils.splitToFloats(a);return b.length>=3&&this.setPosition(MathUtils.parseFloat(b[0]),MathUtils.parseFloat(b[1]),MathUtils.parseFloat(b[2])),b.length>=6&&this.setRotation(MathUtils.parseFloat(b[3]),MathUtils.parseFloat(b[4]),MathUtils.parseFloat(b[5])),b.length>=9&&this.setScale(MathUtils.parseFloat(b[6]),MathUtils.parseFloat(b[7]),MathUtils.parseFloat(b[8])),b.length>=3},toString:function(a){void 0===a&&(a=!1);var b=this.pos.x+" "+this.pos.y+" "+this.pos.z+" | "+this.rot.x+" "+this.rot.y+" "+this.rot.z+" | "+this.scale.x+" "+this.scale.y+" "+this.scale.z;return a||(b="Transform("+b+")"),b},formatParts:function(a){"number"!=typeof a&&(a=6);for(var b=[this._pos.x.toFixed(a),this._pos.y.toFixed(a),this._pos.z.toFixed(a),this._rot.x.toFixed(a),this._rot.y.toFixed(a),this._rot.z.toFixed(a),this._scale.x.toFixed(a),this._scale.y.toFixed(a),this._scale.z.toFixed(a)],c=0;c<b.length;c++){var d=b[c];d=CoreStringUtils.trimStringRight(d,"0"),CoreStringUtils.endsWith(d,".")&&(d=d.substring(0,d.length-1)),b[c]=d}return b}}),Color=Class.$extend({__init__:function(a,b,c,d){this.r="number"==typeof a?a:0,this.g="number"==typeof b?b:0,this.b="number"==typeof c?c:0,this.a="number"==typeof d?d:1},__classvars__:{red:function(){return new Color(1,0,0,1)},green:function(){return new Color(0,1,0,1)},blue:function(){return new Color(0,0,1,1)},white:function(){return new Color(1,1,1,1)},black:function(){return new Color(0,0,0,1)},yellow:function(){return new Color(1,1,0,1)},cyan:function(){return new Color(0,1,1,1)},magenta:function(){return new Color(1,0,1,1)},gray:function(){return new Color(.5,.5,.5,1)},fromString:function(a){if(MathUtils.RegExpFloats.test(a)&&a.indexOf("#")==-1){var b=a.match(MathUtils.RegExpFloats),c=new Color;return b.length>0&&(c.r=MathUtils.parseFloat(b[0])),MathUtils.isNaN(c.r)&&(c.r=0),b.length>1&&(c.g=MathUtils.parseFloat(b[1])),MathUtils.isNaN(c.g)&&(c.g=0),b.length>2&&(c.b=MathUtils.parseFloat(b[2])),MathUtils.isNaN(c.b)&&(c.b=0),b.length>3&&(c.a=MathUtils.parseFloat(b[3]),MathUtils.isNaN(c.a)&&(c.a=0)),c.r>1&&(c.r=Math.min(255,c.r)/255),c.g>1&&(c.g=Math.min(255,c.g)/255),c.b>1&&(c.b=Math.min(255,c.b)/255),c.a>1&&(c.a=Math.min(255,c.b)/255),c}if(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(a)){var d=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(a),e=parseInt(d[1]),f=parseInt(d[2]),g=parseInt(d[3]);return e>1&&(e=Math.min(255,e)/255),f>1&&(f=Math.min(255,f)/255),g>1&&(g=Math.min(255,g)/255),new Color(e,f,g)}if(/^\#([0-9a-f]{6})$/i.test(a)){var h=/^\#([0-9a-f]{6})$/i.exec(a);return Color.fromRgb(parseInt(h[1],16))}return console.error("[Color]: fromString() string format not supported:",a),null},fromRgb:function(a){a=Math.floor(a);var b=(a>>16&255)/255,c=(a>>8&255)/255,d=(255&a)/255;return new Color(b,c,d)},fromHex:function(a){return Color.fromRgb(a)},fromRgba:function(a){a=Math.floor(a);var b=(a>>24&255)/255,c=(a>>16&255)/255,d=(a>>8&255)/255,e=(255&a)/255;return new Color(b,c,d,e)},lerp:function(a,b,c){return a.lerp(b,c)}},clone:function(){return new Color(this.r,this.g,this.b,this.a)},set:function(a,b,c,d){this.r="number"==typeof a?a:this.r,this.g="number"==typeof b?b:this.g,this.b="number"==typeof c?c:this.b,this.a="number"==typeof d?d:this.a},setRGBA:function(a,b,c,d){this.set(a,b,c,d)},copy:function(a){return this.r=a.r,this.g=a.g,this.b=a.b,this.a=a.a,this},toThreeColor:function(){var a=new THREE.Color;return a.setRGB(this.r,this.g,this.b),a},toVector4:function(){return new THREE.Vector4(this.r,this.g,this.b,this.a)},toRgba:function(){var a=this.toRgb(),b=MathUtils.clamp(Math.floor(255*this.a),0,255);return a<<8^b},toRgb:function(a){var b=MathUtils.clamp(Math.floor(255*this.r),0,255),c=MathUtils.clamp(Math.floor(255*this.g),0,255),d=MathUtils.clamp(Math.floor(255*this.b),0,255),e=MathUtils.clamp(Math.floor(255*this.a),0,255);return a!==!0?b<<16^c<<8^d:{r:b,g:c,b:d,a:e}},toHex:function(){return this.toRgb()},toHexString:function(){var a=this.toRgb(!0);a.r=a.r.toString(16),a.g=a.g.toString(16),a.b=a.b.toString(16);for(var b=Object.keys(a),c=0;c<b.length;++c){var d=b[c];1===a[d].length&&(a[d]="0"+a[d])}return"#"+a.r+a.g+a.b},toString:function(a){if(a===!0){var b=MathUtils.clamp(Math.floor(255*this.r),0,255),c=MathUtils.clamp(Math.floor(255*this.g),0,255),d=MathUtils.clamp(Math.floor(255*this.b),0,255),e=MathUtils.clamp(Math.floor(255*this.a),0,255);return"rgba("+b+", "+c+", "+d+", "+e+")"}return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"},serializetoString:function(){return this.r+" "+this.g+" "+this.b+" "+this.a},equals:function(a,b){return MathUtils.equal(this.r,a.r,b)&&MathUtils.equal(this.g,a.g,b)&&MathUtils.equal(this.b,a.b,b)&&MathUtils.equal(this.a,a.a,b)},add:function(a){return this.r+=a.r,this.g+=a.g,this.b+=a.b,this.a+=a.a,this},addScalar:function(a){return this.r+=a,this.g+=a,this.b+=a,this.a+=a,this},multiply:function(a){return this.r*=a.r,this.g*=a.g,this.b*=a.b,this.a*=a.a,this},multiplyScalar:function(a){return this.r*=a,this.g*=a,this.b*=a,this.a*=a,this},lerp:function(a,b){return this.r=MathUtils.lerp(this.r,a.r,b),this.g=MathUtils.lerp(this.g,a.g,b),this.b=MathUtils.lerp(this.b,a.b,b),this.a=MathUtils.lerp(this.a,a.a,b),this},clamp:function(a,b){return this.r=MathUtils.clamp(this.r,a,b),this.g=MathUtils.clamp(this.g,a,b),this.b=MathUtils.clamp(this.b,a,b),this.a=MathUtils.clamp(this.a,a,b),this},clamp01:function(){return this.clamp(0,1)},fromString:function(a){if(a.indexOf("#")!==-1||a.indexOf("(")!==-1){var b=Color.fromString(a);return!!b&&(this.copy(b),!0)}var c=MathUtils.splitToFloats(a),d=c.length>=3;return d&&(this.set(MathUtils.parseFloat(c[0]),MathUtils.parseFloat(c[1]),MathUtils.parseFloat(c[2])),c.length>=4&&(this.a=MathUtils.parseFloat(c[3])),this.r>1&&(this.r=Math.min(255,this.r)/255),this.g>1&&(this.g=Math.min(255,this.g)/255),this.b>1&&(this.b=Math.min(255,this.b)/255),this.a>1&&(this.a=Math.min(255,this.b)/255)),d}}),Attribute=ITundraSerializer.$extend({__init__:function(a,b,c,d,e){this.$super(),this.owner=a,this.interpolation=void 0,this.index=b,this.name=c,this.id=void 0,this.value=d,this.typeId=e,this.typeName=Attribute.toTypeName(e),this.sizeBytes=Attribute.sizeInBytes(e),
this.headerSizeBytes=Attribute.headerSizeInBytes(e)},__classvars__:{None:0,String:1,Int:2,Real:3,Color:4,Float2:5,Float3:6,Float4:7,Bool:8,UInt:9,Quat:10,AssetReference:11,AssetReferenceList:12,EntityReference:13,QVariant:14,QVariantList:15,Transform:16,QPoint:17,typeNames:function(){for(var a=[],b=0;b<Attribute.typeNameList.length;++b)a.push(Attribute.typeNameList[b]);return a},typeIds:function(){for(var a=[],b=0;b<Attribute.typIdList.length;++b)a.push(Attribute.typIdList[b]);return a},toTypeName:function(a){if("number"!=typeof a)return TundraLogging.getLogger("Attribute").error("toTypeName function called with non number 'typeId'",a),null;switch(a){case 1:return"string";case 2:return"int";case 3:return"real";case 4:return"Color";case 5:return"float2";case 6:return"float3";case 7:return"float4";case 8:return"bool";case 9:return"uint";case 10:return"Quat";case 11:return"AssetReference";case 13:return"EntityReference";case 12:return"AssetReferenceList";case 15:return"QVariantList";case 14:return"QVariant";case 16:return"Transform";case 17:return"QPoint"}return null},toTypeId:function(a){if("string"!=typeof a)return TundraLogging.getLogger("Attribute").error("toTypeId function called with non string 'typeName'",a),null;var b=a.toLowerCase();return"string"===b?1:"int"===b?2:"real"===b?3:"color"===b?4:"float2"===b?5:"float3"===b?6:"float4"===b?7:"bool"===b?8:"uint"===b?9:"quat"===b?10:"assetreference"===b?11:"entityreference"===b?12:"assetreferencelist"===b?13:"qvariantlist"===b||"variantlist"===b?14:"qvariant"===b||"variant"===b?15:"transform"===b?16:"qpoint"===b||"point"===b?17:null},typeNameList:["string","int","real","Color","float2","float3","float4","bool","uint","Quat","EntityReference","AssetReferenceList","QVariantList","QVariant","Transform","QPoint"],typIdList:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],sizeInBytes:function(a){switch(a){case 1:return;case 2:return 4;case 3:return 4;case 4:return 16;case 5:return 8;case 6:return 12;case 7:return 16;case 8:return 1;case 9:return 4;case 10:return 16;case 11:case 13:case 12:case 15:case 14:return;case 16:return 36;case 17:return 8}TundraLogging.getLogger("Attribute").error("Unknown attribute type id "+a+". Cannot resolve size in bytes!")},headerSizeInBytes:function(a){switch(a){case 1:return 2;case 11:case 13:return 1;case 12:case 15:return 1;case 14:return 1}return 0},defaultValueForType:function(a){switch(a){case 1:return"";case 2:case 9:return 0;case 3:return 0;case 4:return new Color;case 5:case 17:return new THREE.Vector2(0,0);case 6:return new THREE.Vector3(0,0,0);case 7:return new THREE.Vector4(0,0,0,0);case 8:return!1;case 10:return new THREE.Quaternion;case 11:case 13:case 14:return"";case 12:case 15:return[];case 16:return new Transform}return TundraLogging.getLogger("Attribute").error("defaultValueForType() Unknown attribute type id "+a),null}},_reset:function(){this.owner=null,this.index=null,this.name=null,this.id=null,this.value=null,this.typeId=null,this.typeName=null,this.sizeBytes=null,this.headerSizeBytes=null},serializeValue:function(){switch(this.typeId){case 2:case 9:case 3:case 8:return this.value.toString();case 1:case 11:case 13:case 14:return this.value;case 17:return this.value.x+" "+this.value.y;case 5:case 6:case 7:case 10:return this.value.toArray().join(" ");case 4:return this.value.serializetoString();case 12:case 15:return this.value.join(";");case 16:return this.value.formatParts().join(",")}},serializeToObject:function(){var a={};return a.id=this.name,a.type=this.typeName,a.value=this.serializeValue(),a},serializeToXml:function(){var a=document.createElement("attribute");return a.setAttribute("id",this.name),a.setAttribute("type",this.typeName),a.setAttribute("value",this.serializeValue()),a},deserializeFromObject:function(a,b){b=b||AttributeChange.Default;var c=a.value;c&&this.setFromString(c,b)},deserializeFromXml:function(a,b){b=b||AttributeChange.Default;var c=a.getAttribute("value");c&&this.setFromString(c,b)},toString:function(){return"index="+this.index+" name="+this.name+" typeId="+this.typeId+" typeName="+this.typeName+" size="+this.sizeBytes+" header="+this.headerSizeBytes+" value="+this.value.toString()},get:function(){return this.value},getClone:function(){if("function"==typeof this.value.getClone)return this.value.getClone();if("function"==typeof this.value.clone)return this.value.clone();var a=typeof this.value;if("string"===a||"boolean"===a||"number"===a)return this.value;if(Array.isArray(this.value)){for(var b=[],c=0;c<this.value.length;c++)b.push(this.value[c]);return b}return TundraLogging.getLogger("Attribute").warn("getClone() not implemented for type",this.typeName,a),TundraLogging.getLogger("Attribute").warn(this),this.value},set:function(a,b){return void 0!==b&&null!==b||(b=AttributeChange.Default),"number"!=typeof b?(TundraLogging.getLogger("Attribute").error("set called with non-number change type: "+b),!1):(b===AttributeChange.Default&&(b=null!=this.owner&&this.owner.replicated?AttributeChange.Replicate:AttributeChange.LocalOnly),this.interpolation&&this.interpolation.change(a),this.value=a,null!=this.owner&&b!==AttributeChange.Disconnected&&this.owner._attributeChanged(this,b),!0)},onChanged:function(a,b){return null!=this.owner&&this.owner.hasParentEntity()?Tundra.events.subscribe("Scene.AttributeChanged."+this.owner.parentEntity.id.toString()+"."+this.owner.id.toString()+"."+this.index.toString(),a,b):(TundraLogging.getLogger("Attribute").error("Cannot subscribe onChanged, parent component or parent entity not set!"),null)},headerFromBinary:function(a){if(this.headerSizeBytes>0){if(1===this.headerSizeBytes)return a.readU8();if(2===this.headerSizeBytes)return a.readU16()}},dataFromBinary:function(a,b){switch(this.typeId){case 1:this.set(a.readString(b,!0),AttributeChange.LocalOnly);break;case 11:case 13:case 14:this.set(a.readString(b),AttributeChange.LocalOnly);break;case 2:this.set(a.readS32(),AttributeChange.LocalOnly);break;case 3:this.set(a.readFloat32(),AttributeChange.LocalOnly);break;case 4:this.value.r=a.readFloat32(),this.value.g=a.readFloat32(),this.value.b=a.readFloat32(),this.value.a=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 5:this.value.x=a.readFloat32(),this.value.y=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 6:this.value.x=a.readFloat32(),this.value.y=a.readFloat32(),this.value.z=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 7:this.value.x=a.readFloat32(),this.value.y=a.readFloat32(),this.value.z=a.readFloat32(),this.value.w=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 8:this.set(a.readBoolean(),AttributeChange.LocalOnly);break;case 9:this.set(a.readU32(),AttributeChange.LocalOnly);break;case 10:this.value.x=a.readFloat32(),this.value.y=a.readFloat32(),this.value.z=a.readFloat32(),this.value.w=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 12:case 15:this.value=[];for(var c=0;c<b;++c)this.value.push(a.readStringU8());this.set(this.value,AttributeChange.LocalOnly);break;case 16:this.value.pos.x=a.readFloat32(),this.value.pos.y=a.readFloat32(),this.value.pos.z=a.readFloat32(),this.value.rot.x=a.readFloat32(),this.value.rot.y=a.readFloat32(),this.value.rot.z=a.readFloat32(),this.value.scale.x=a.readFloat32(),this.value.scale.y=a.readFloat32(),this.value.scale.z=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 17:this.value.x=a.readS32(),this.value.y=a.readS32(),this.set(this.value,AttributeChange.LocalOnly)}},fromBinary:function(a){var b=void 0!==this.sizeBytes?this.sizeBytes:this.headerFromBinary(a);return void 0===b?void TundraLogging.getLogger("Attribute").error("Size and header size of '"+this.name+"' seems to be unknown, did you mess up the IComponent.declareAttribute() calls?"):void this.dataFromBinary(a,b)},setFromString:function(a,b){switch(this.typeId){case 1:case 11:case 13:case 14:return this.set(a,b);case 2:case 9:return this.set(MathUtils.parseInt(a),b);case 3:return this.set(MathUtils.parseFloat(a),b);case 5:case 17:var c=MathUtils.splitToFloats(a);return c.length>=2&&(this.value.x=c[0],this.value.y=c[1],this.set(this.value,b));case 6:var c=MathUtils.splitToFloats(a);return c.length>=3&&(this.value.x=c[0],this.value.y=c[1],this.value.z=c[2],this.set(this.value,b));case 7:case 10:var c=MathUtils.splitToFloats(a);return c.length>=4&&(this.value.x=c[0],this.value.y=c[1],this.value.z=c[2],this.value.w=c[3],this.set(this.value,b));case 8:var d=a.trim().toLowerCase();return this.value="true"===d||"1"===d,this.set(this.value,b);case 12:case 15:return this.value=a.split(";"),this.set(this.value,b);default:if("function"==typeof this.value.fromString){var e=this.value.fromString(a);return("boolean"!=typeof e||e!==!1)&&this.set(this.value,b)}return TundraLogging.getLogger("Attribute").error("Attribute value type does not implement setFromString/fromString:",this.toString()),!1}}}),IComponent=ITundraSerializer.$extend({__init__:function(a,b,c,d){this.$super(),this.log=TundraLogging.getLogger(IComponent.ensureComponentNameWithoutPrefix(c)),this.id=a,this.typeId=b,this.typeName=IComponent.ensureComponentNameWithoutPrefix(c),this.name=d,this.replicated=!0,this.local=!1,this.temporary=!1,this.parentEntity=null,this.parentScene=null,this.notImplemented=!1,this.attributes={},this.attributeCount=0,this.attributeIndexes={},this.blockSignals=!1,this.oldTxmlFormatAttrNames={}},__classvars__:{ensureComponentNamePrefix:function(a){return"ec_"===a.substring(0,3).toLowerCase()?a:"EC_"+a},ensureComponentNameWithoutPrefix:function(a){return"ec_"===a.substring(0,3).toLowerCase()?a.substr(3):a},propertyName:function(a){return a=IComponent.ensureComponentNameWithoutPrefix(a),a.substring(0,1).toLowerCase()+a.substring(1)}},_reset:function(){this.reset(),this.attributeIndexes={},this.attributeCount=0,this.blockSignals=!1;for(var a in this.attributes){var b=this.attributes[a];void 0!==b&&null!==b&&b._reset(),b=null}this.attrs={},this.parentEntity=null,this.parentScene=null},hasParentEntity:function(){return null!==this.parentEntity},hasParentScene:function(){return null!==this.parentScene},reset:function(){},_update:function(){this.update()},update:function(){},onAttributeChanged:function(a,b){return!this.parentEntity||this.parentEntity.id<=0?(console.log("ERROR: Entity.onAttributeChanged called on a non initialized component! No valid parent entity!"),null):Tundra.events.subscribe("Scene.AttributeChanged."+this.parentEntity.id.toString()+"."+this.id.toString(),a,b)},serializeToObject:function(a){var b={};b.id=this.id,b.typeId=this.typeId,b.typeName=this.typeName,b.sync=this.replicated,b.attributes=[],b.name=this.name||void 0,b.temp=a&&this.temporary||void 0;for(var c in this.attributes)b.attributes.push(this.attributes[c].serializeToObject());return b},serializeToXml:function(a){a=a||!1;var b=document.createElement("component");b.setAttribute("type",this.typeName),b.setAttribute("typeId",this.typeId),b.setAttribute("sync",this.replicated),this.name.length>0&&b.setAttribute("name",this.name),(!this.temporary||this.temporary&&a)&&b.setAttribute("temp",this.temporary);for(var c in this.attributes)b.appendChild(this.attributes[c].serializeToXml());return b},deserializeFromObject:function(a,b){b=b||AttributeChange.Default;for(var c=0;c<a.attributes.length;++c){var d=a.attributes[c],e=d.id;if(this.isDynamic()){var f=d.type,g=Attribute.toTypeId(f);if(!g)return void this.log.warn("[deserializeFromObject]: Unknown type name: ",f,"skipping attribute creation!");this.createAttribute(g,e)?this.attributes[e].deserializeFromObject(d,b):this.log.warn("[deserializeFromObject]: Could not create attribute named "+e+" with type "+f+", skipping")}else this.attributes[e]?this.attributes[e].deserializeFromObject(d,b):this.log.warn("[deserializeFromObject]: Skipping undeclared attribute:",e)}},deserializeFromXml:function(a,b){b=b||AttributeChange.Default;for(var c=0;c<a.childNodes.length;++c){var d=a.childNodes[c];if("attribute"==d.nodeName){var e=d.getAttribute("id"),f=d.getAttribute("type"),g=d.getAttribute("name");if(e=e||this.oldTxmlFormatAttrNames[g],this.isDynamic()){var h=Attribute.toTypeId(f);if(!h){this.log.warn("[deserializeFromXml]: Unknown type name: ",f,"skipping attribute creation!");continue}this.createAttribute(h,e)&&this.attributes[e].deserializeFromXml(d,b)}else this.attributes[e]?this.attributes[e].deserializeFromXml(d,b):this.log.warn("[deserializeFromXml]: Skipping undeclared attribute:",e)}}},toString:function(){return this.id+" "+this.typeName+(this.name.length>0?" name = "+this.name:"")},isDynamic:function(){return!1},setParent:function(a){this.parentEntity=void 0!==a?a:null,this.parentScene=void 0!==a?a.parentScene:null},declareAttribute:function(a,b,c,d,e){var f=new Attribute(this,a,b,c,d);if(this.attributes[b]=f,this.attributeIndexes[a]=b,this.attributeCount=Object.keys(this.attributes).length,void 0===this[b]){var g={};g[b]={get:function(){return f.getClone()},set:function(a){f.set(a)},configurable:this.isDynamic()},Object.defineProperties(this,g)}"string"==typeof e&&""!=e&&(this.oldTxmlFormatAttrNames[e]=b)},setAttribute:function(a,b,c){var d=this.attributes[a];void 0!==d&&d.set(b,c)},attributeById:function(a){if(void 0!==a&&null!==a)return this.attributes[a]},attribute:function(a){return this.attributeById(a)},getAttribute:function(a){return this.attributeById(a)},hasAttribute:function(a){return void 0!==this.attribute(a)},attributeByIndex:function(a){return this.attributeById(this.attributeIndexes[a])},getAttributeByIndex:function(a){return this.attributeByIndex(a)},deserializeFromBinary:function(a){if(this.attributeCount<=0&&!this.isDynamic())return-1;this.blockSignals=!0;try{this.isDynamic()?this._deserializeFromBinaryDynamic(a):this._deserializeFromBinaryStatic(a)}catch(b){Tundra.client.logError("[Attribute]: deserializeFromBinary exception: "+b)}this.blockSignals=!1},_deserializeFromBinaryStatic:function(a){for(var b=0;b<this.attributeCount;++b){var c=this.attributeByIndex(b);c.fromBinary(a)}},_deserializeFromBinaryDynamic:function(a){if(void 0!==a.readLimitBytes)for(var b=a.readBytes();a.readBytes()-b<a.readLimitBytes;){var c=a.readU8(),d=a.readU8(),e=a.readStringU8();this.declareAttribute(c,e,Attribute.defaultValueForType(d),d),this.deserializeAttributeFromBinary(c,a)}else console.error("[Attribute]: DataDeserializer for parsing dynamic component structure does not have 'readLimitBytes' property. This information is needed to know when to stop parsing.")},deserializeAttributeFromBinary:function(a,b){if(!(this.attributeCount<=0)){var c=this.attributeByIndex(a);void 0!==c&&null!==c&&c.fromBinary(b)}},createAttributeFromBinary:function(a,b){if(!this.isDynamic())return void Tundra.client.logError("[IComponent]: createAttributeFromBinary called to a non dynamic component!",!0);var c=b.readU8(),d=b.readStringU8();this.declareAttribute(a,d,Attribute.defaultValueForType(c),c),this.deserializeAttributeFromBinary(a,b),"function"==typeof this._attributeAdded&&this._attributeAdded(a)},_attributeChanged:function(a,b){if(!this.blockSignals)return this.parentEntity&&this.parentEntity.parentScene?void(void 0!==a&&null!==a&&(this.attributeChanged(a.index,a.name,a.get()),null!==this.parentEntity&&null!==this.parentEntity.parentScene&&this.parentEntity.parentScene._publishAttributeChanged(this.parentEntity,a))):void Tundra.client.logError("[IComponent]: Cannot send attribute update event, parent entity or scene is null!",!0)},attributeChanged:function(a,b,c){}}),EntityAction=Class.$extend({__init__:function(){this.name=void 0,this.executionType=EntityAction.Invalid,this.parameters=[],this.entity=void 0,this.entityId=void 0},__classvars__:{Invalid:0,Local:1,Server:2,Peers:4}}),UniqueIdGenerator=Class.$extend({__init__:function(){this.id=0,this.localId=UniqueIdGenerator.FirstLocalId-1,this.unackedId=UniqueIdGenerator.FirstUnackedId-1},__classvars__:{FirstReplicatedId:1,LastReplicatedId:1073741823,FirstUnackedId:1073741824,FirstLocalId:2147483648,LastLocalId:4294967295},allocateReplicated:function(){return this.id++,this.id>UniqueIdGenerator.LastReplicatedId&&(this.id=UniqueIdGenerator.FirstReplicatedId),this.id},allocateUnacked:function(){return this.unackedId++,this.unackedId>=UniqueIdGenerator.FirstLocalId&&(this.unackedId=UniqueIdGenerator.FirstUnackedId+1),this.unackedId},allocateLocal:function(){return this.localId++,this.localId>UniqueIdGenerator.LastLocalId&&(this.localId=UniqueIdGenerator.FirstLocalId+1),this.localId}}),DataSerializer=Class.$extend({__init__:function(a,b){if("number"!=typeof a&&(Tundra.client.logWarning("[DataSerializer]: You are creating a data serializer with undefined size! Initializing size to 0 bytes."),a=0),b="number"==typeof b?b:DataSerializer.ArrayType.Uint8,b===DataSerializer.ArrayType.Uint8)this.array=new Uint8Array(a);else if(b===DataSerializer.ArrayType.Uint16)this.array=new Uint16Array(a);else if(b===DataSerializer.ArrayType.Uint32)this.array=new Uint32Array(a);else if(b===DataSerializer.ArrayType.Float32)this.array=new Float32Array(a);else{if(b!==DataSerializer.ArrayType.Float64)return void Tundra.client.logError("[DataSerializer]: Unknown 'arrayType' "+b+". Use on of the supported ones from DataSerializer.ArrayType");this.array=new Float64Array(a)}this.data=new DataView(this.array.buffer),this.bytePos=0,this.bitPos=0,this.type=b},__classvars__:{floatWriteDataView:new DataView(new ArrayBuffer(4)),doubleWriteDataView:new DataView(new ArrayBuffer(8)),ArrayType:{Uint8:0,Uint16:1,Uint32:2,Float32:3,Float64:4},utf8StringByteSize:function(a){for(var b=0,c=0,d=a.length;c<d;++c)b+=DataSerializer.utf8CharCodeByteSize(a.charCodeAt(c));return b},utf8CharCodeByteSize:function(a){return a<128?1:a<2048?2:a<65536?3:a<2097152?4:a<67108864?5:6},vleHeaderSizeBytes:function(a){return a<128?1:a<16384?2:4}},getBuffer:function(){return this.array.buffer},filledBytes:function(){return 0===this.bitPos?this.bytePos:this.bytePos+1},filledBits:function(){return 8*this.bytePos+this.bitPos},capacity:function(){return this.data.byteLength},bytesLeft:function(){return this.bytePos>=this.data.byteLength?0:this.data.byteLength-this.bytePos},bitsLeft:function(){return this.bytePos>=this.data.byteLength?0:8*(this.data.byteLength-this.bytePos)-this.bitPos},skipBytes:function(a){this.bytePos+=a},writeBoolean:function(a){this.writeU8(a===!0?1:0)},writeUint8Array:function(a){for(var b=0,c=a.length;b<c;++b)this.writeU8(a[b])},writeUtf8Char:function(a){a<128?this.writeU8(a):a<2048?(this.writeU8(192|a>>6&31),this.writeU8(128|63&a)):a<65536?(this.writeU8(224|a>>12&15),this.writeU8(128|a>>6&63),this.writeU8(128|63&a)):a<2097152?(this.writeU8(240|a>>18&7),this.writeU8(128|a>>12&63),this.writeU8(128|a>>6&63),this.writeU8(128|63&a)):a<67108864?(this.writeU8(248|a>>24&3),this.writeU8(128|a>>18&63),this.writeU8(128|a>>12&63),this.writeU8(128|a>>6&63),this.writeU8(128|63&a)):(this.writeU8(252|a>>30&1),this.writeU8(128|a>>24&63),this.writeU8(128|a>>18&63),this.writeU8(128|a>>12&63),this.writeU8(128|a>>6&63),this.writeU8(128|63&a))},writeStringWithHeader:function(a,b,c){"boolean"!=typeof c&&(c=!1);var d=c?DataSerializer.utf8StringByteSize(b):b.length;1==a?this.writeU8(d):2==a?this.writeU16(d):4==a?this.writeU32(d):this.writeVLE(d);var e=0,f=b.length;if(c)for(;e<f;++e)this.writeUtf8Char(b.charCodeAt(e));else for(;e<f;++e)this.writeU8(b.charCodeAt(e))},writeStringVLE:function(a,b){this.writeStringWithHeader(0,a,b)},writeStringU8:function(a,b){this.writeStringWithHeader(1,a,b)},writeStringU16:function(a,b){this.writeStringWithHeader(2,a,b)},writeStringU32:function(a,b){this.writeStringWithHeader(4,a,b)},writeS8:function(a){0===this.bitPos?(this.data.setInt8(this.bytePos,a),this.bytePos+=1):this.writeBits(a,8)},writeU8:function(a){0===this.bitPos?(this.data.setUint8(this.bytePos,a),this.bytePos+=1):this.writeBits(a,8)},writeS16:function(a){0===this.bitPos?(this.data.setInt16(this.bytePos,a,!0),this.bytePos+=2):this.writeBits(a,16)},writeU16:function(a){0===this.bitPos?(this.data.setUint16(this.bytePos,a,!0),this.bytePos+=2):this.writeBits(a,16)},writeS32:function(a){0===this.bitPos?(this.data.setIn32(this.bytePos,a,!0),this.bytePos+=4):this.writeBits(a,32)},writeU32:function(a){0===this.bitPos?(this.data.setUint32(this.bytePos,a,!0),this.bytePos+=4):this.writeBits(a,32)},writeFloat32:function(a){0===this.bitPos?(this.data.setFloat32(this.bytePos,a,!0),this.bytePos+=4):(DataSerializer.floatWriteDataView.setFloat32(0,a,!0),this.writeBits(DataSerializer.floatWriteDataView.getUint32(0,!0),32))},writeFloat64:function(a){0===this.bitPos?(this.data.setFloat64(this.bytePos,a,!0),this.bytePos+=8):(DataSerializer.doubleWriteDataView.setFloat64(0,a,!0),this.writeBits(DataSerializer.doubleWriteDataView.getUint32(0,!0),32),this.writeBits(DataSerializer.doubleWriteDataView.getUint32(4,!0),32))},writeVLE:function(a){a<128?this.writeU8(a):a<16384?(this.writeU8(127&a|128),this.writeU8(a>>7)):(this.writeU8(127&a|128),this.writeU8(a>>7&127|128),this.writeU16(a>>14))},writeBits:function(a,b){for(var c=0,d=this.data.getUint8(this.bytePos);b>0;)a&1<<c?d|=1<<this.bitPos:d&=255-(1<<this.bitPos),c++,b--,this.bitPos++,this.bitPos>7&&(this.bitPos=0,this.data.setUint8(this.bytePos,d),this.bytePos++,b>0&&(d=this.data.getUint8(this.bytePos)));0!==this.bitPos&&this.data.setUint8(this.bytePos,d)},writeUnsignedFixedPoint:function(a,b,c){var d=1<<a,e=(1<<a+b)-1,f=c<=0?0:c>=d?e:c*(1<<b);return this.writeBits(f,a+b),f},writeSignedFixedPoint:function(a,b,c){return this.writeUnsignedFixedPoint(a,b,c+(1<<a-1))},writeQuantizedFloat:function(a,b,c,d){var e=Math.floor((Math.min(Math.max(d,a),b)-a)*((1<<c)-1)/(b-a));return this.writeBits(e,c),e},writeNormalizedVector2D:function(a,b,c){this.writeQuantizedFloat(-Math.PI,Math.PI,c,atan2(b,a))},writeVector2D:function(a,b,c,d,e){var f=Math.sqrt(a*a+b*b),g=this.writeUnsignedFixedPoint(c,d,f);if(0!==g){var h=Math.atan2(b,a);return this.writeQuantizedFloat(-Math.PI,Math.PI,e,h),c+d+e}return c+d},writeNormalizedVector3D:function(a,b,c,d,e){var f=Math.atan2(a,c),g=Math.asin(-b);this.writeQuantizedFloat(-Math.PI,Math.PI,d,f),this.writeQuantizedFloat(-Math.PI/2,Math.PI/2,e,g)},writeVector3D:function(a,b,c,d,e,f,g){var h=Math.sqrt(a*a+b*b+c*c),i=this.writeUnsignedFixedPoint(f,g,h);if(0!==i){var j=Math.atan2(a,c),k=Math.asin(-b/h);return this.writeQuantizedFloat(-Math.PI,Math.PI,d,j),this.writeQuantizedFloat(-Math.PI/2,Math.PI/2,e,k),f+g+d+e}return f+g},writeArithmeticEncoded2:function(a,b,c,d,e){this.writeBits(b*e+d,a)},writeArithmeticEncoded3:function(a,b,c,d,e,f,g){this.writeBits((b*e+d)*g+f,a)},writeArithmeticEncoded4:function(a,b,c,d,e,f,g,h,i){this.writeBits(((b*e+d)*g+f)*i+h,a)},writeArithmeticEncoded5:function(a,b,c,d,e,f,g,h,i,j,k){this.writeBits((((b*e+d)*g+f)*i+h)*k+j,a)}}),INetworkMessage=Class.$extend({__init__:function(a,b){this.id=a,this.name=void 0!==b?b:INetworkMessage.Ids[a]},__classvars__:{id:0,name:"",Ids:{100:"LoginMessage",101:"LoginReplyMessage",102:"ClientJoinedMessage",103:"ClientLeftMessage",110:"CreateEntityMessage",111:"CreateComponentsMessage",112:"CreateAttributesMessage",113:"EditAttributesMessage",114:"RemoveAttributesMessage",115:"RemoveComponentsMessage",116:"RemoveEntityMessage",117:"CreateEntityReplyMessage",118:"CreateComponentsReplyMessage",119:"RigidBodyUpdateMessage",120:"EntityActionMessage",121:"AssetDiscoveryMessage",122:"AssetDeletedMessage"}},getBuffer:function(){return void 0!==this.ds&&null!==this.ds&&this.ds instanceof DataSerializer?this.ds.getBuffer():null},deserialize:function(a){this.ds=a},serialize:function(a){this.ds=new DataSerializer(a)}}),EntityActionMessage=INetworkMessage.$extend({__init__:function(){this.$super(EntityActionMessage.id,"EntityActionMessage"),this.entityAction=new EntityAction},__classvars__:{id:120,name:"EntityActionMessage",staticNumBytes:9},deserialize:function(a){var b=!1;this.entityAction.entityId=a.readU32(),this.entityAction.name=a.readStringU8(b),this.entityAction.executionType=a.readU8();for(var c=a.readU8(),d=0;d<c;++d){var e=a.readVLE();this.entityAction.parameters[d]=a.readString(e,b)}},serialize:function(a){if(void 0===a.entityId&&void 0===a.entity)return void Tundra.client.logError("[EntityActionMessage]: serialize() called with entity action that does not have entityId or entity set!");var b=!1,c=DataSerializer.utf8StringByteSize(a.name);c+=4*a.parameters.length;var d,e;for(d=0,e=a.parameters.length;d<e;++d)c+=DataSerializer.utf8StringByteSize(a.parameters[d]);for(this.$super(EntityActionMessage.staticNumBytes+c),this.ds.writeU16(this.id),this.ds.writeU32(void 0!==a.entityId?a.entityId:a.entity.id),this.ds.writeStringU8(a.name),this.ds.writeU8(a.executionType),this.ds.writeU8(a.parameters.length),d=0,e=a.parameters.length;d<e;++d)this.ds.writeStringVLE(a.parameters[d],b)}}),Entity=ITundraSerializer.$extend({__init__:function(){this.$super(),this.log=TundraLogging.getLogger("Entity"),this.componentIdGenerator=new UniqueIdGenerator,this.id=-1,Object.defineProperties(this,{name:{get:function(){return this.getName()},set:function(a){this.setName(a)}},description:{get:function(){return this.getDescription()},set:function(a){this.setDescription(a)}},group:{get:function(){return this.getGroup()},set:function(a){this.setGroup(a)}}}),this.replicated=!0,this.local=!1,this.temporary=!1,this.parentScene=null,this.parentEntity=null,this.children=[],this.components=[]},__classvars__:{ExecType:{Invalid:0,Local:1,Server:2,Peers:4,0:"Invalid",1:"Local",2:"Server",4:"Peers"}},_nextLocalComponentId:function(){return this.componentIdGenerator.allocateLocal()},_nextReplicatedComponentId:function(){return this.componentIdGenerator.allocateReplicated()},createChild:function(a,b){if(!this.parentScene)return void this.log.error("createChild: Parent scene null");var c=this.parentScene.createEntity(a,[],b);return c&&c.setParent(this,b),c},addChild:function(a,b){return!!a&&a.setParent(this,b)},detachChild:function(a,b){return!!a&&(this.isChild(a)?a.setParent(null,b):(this.log.warn("detachChild: 'child' not parented to this Entity ("+this.toString()+"), cannot detach."),!1))},removeChild:function(a,b){return!!a&&(this.isChild(a)?(this.parentScene?this.parentScene.removeEntity(a.id,b):console.log("Null parent scene, can not remove child entity"),!0):(this.log.warn("detachChild: 'child' not parented to this Entity ("+this.toString()+"), cannot detach."),!1))},removeAllChildren:function(a){if(0===this.children.length)return!0;for(;this.children.length>0;)if(!this.removeChild(this.children[this.children.length-1],a))return!1;return!0},setParentScene:function(a){this.parentScene=a},clearParent:function(a){return!this.hasParent()||this.setParent(null,a)},setParent:function(a,b){if(a&&this.id===a.id)return this.log.error("setParent: Attempted to parent Entity to self"),!1;if(this.isParent(a))return!0;for(var c=a;c;){if(c.id==this.id)return this.log.error("setParent: Attempted to cyclically parent an Entity"),!1;c=c.parentEntity}var d=this.parentEntity?this.parentEntity.childIndex(this):-1;return d!==-1&&this.parentEntity.children.splice(d,1),a&&a.children.push(this),a||this.hasParent()?(this.parentEntity=a,!this.parentScene&&a&&a.parentScene&&this.setParentScene(a.parentScene),this.parentScene?this.parentScene._publishParentChanged(a,this,b):this.log.warn("setParent: Parent scene not set, cannot fire events"),!0):void 0},hasParent:function(){return void 0!==this.parentEntity&&null!==this.parentEntity},isParent:function(a){return this.hasParent()&&a&&this.parentEntity.id===a.id},isChild:function(a){return a&&a.isParent(this)},childIndex:function(a){if(!a)return-1;for(var b=0;b<this.children.length;b++)if(this.children[b].id===a.id)return b;return-1},onParentChanged:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onParentChanged called on a non initialized entity!"),null):Tundra.events.subscribe("Entity.Parent.Changed."+this.id.toString(),a,b)},onChildrenChanged:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onChildrenChanged called on a non initialized entity!"),null):Tundra.events.subscribe("Entity.Children.Changed."+this.id.toString(),a,b)},setId:function(a){this.id=a},getName:function(){var a=this.componentByTypeId(26);return a?a.attributes.name.value:""},setName:function(a,b){var c=this.getOrCreateComponent("Name",void 0,b);c.setName(a,b)},getDescription:function(){var a=this.component("Name");return a?a.getDescription():""},setDescription:function(a,b){var c=this.getOrCreateComponent("Name",void 0,b);c.setDescription(a,b)},getGroup:function(){var a=this.component("Name");return a?a.getGroup():""},setGroup:function(a,b){var c=this.getOrCreateComponent("Name",void 0,b);c.setGroup(a,b)},onAboutToBeRemoved:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onAboutToBeRemoved called on a non initialized entity!"),null):Tundra.events.subscribe("Entity.AboutToBeRemoved."+this.id.toString(),a,b)},onComponentCreated:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onComponentCreated called on a non initialized entity!"),null):Tundra.events.subscribe("Scene.ComponentCreated."+this.id.toString(),a,b)},onComponentRemoved:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onComponentRemoved called on a non initialized entity!"),null):Tundra.events.subscribe("Scene.ComponentRemoved."+this.id.toString(),a,b)},onEntityAction:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onEntityAction called on a non initialized entity!"),null):Tundra.events.subscribe("Scene.EntityAction."+this.id.toString(),a,b)},reset:function(){Tundra.events.send("Entity.AboutToBeRemoved."+this.id.toString(),this);for(var a=null,b=[],c=0;c<this.components.length;c++)null!=this.components[c]&&("Placeable"!==this.components[c].typeName?b.push(this.components[c].id):a=this.components[c].id);for(c=0;c<b.length;c++)this.removeComponent(b[c]);null!=a&&this.removeComponent(a),this.components=[],Tundra.events.remove("Entity.AboutToBeRemoved."+this.id.toString()),Tundra.events.remove("Scene.EntityAction."+this.id.toString())},serializeToObject:function(a){a=a||!1;var b={};b.id=this.id,b.sync=this.replicated,b.components=[],b.temp=a&&this.temporary||void 0;for(var c=0;c<this.components.length;++c){var d=this.components[c].temporary;(!d||d&&a)&&b.components.push(this.components[c].serializeToObject(a))}return b},serializeToXml:function(a){a=a||!1;var b=document.createElement("entity");b.setAttribute("id",this.id),b.setAttribute("sync",this.replicated),(!this.temporary||this.temporary&&a)&&b.setAttribute("temp",this.temporary);for(var c=0;c<this.components.length;++c){var d=this.components[c].temporary;(!d||d&&a)&&b.appendChild(this.components[c].serializeToXml(a))}return b},deserializeFromObject:function(a,b){b=b||AttributeChange.Default;for(var c=0;c<a.components.length;++c){var d=a.components[c],e=d.typeId,f=d.typeName;if(this.parentScene.$class.registeredComponent(e)){var g=d.sync,h=d.name,i=d.temp||!1,j=null;j=g?this.createComponent(e,h,b):this.createLocalComponent(e,h),j.temporary=i,j.deserializeFromObject(d,b)}else this.log.warn("[deserializeFromObject]: skipping unregistered component:",f)}},deserializeFromXml:function(a,b){b=b||AttributeChange.Default;for(var c=0;c<a.childNodes.length;++c){var d=a.childNodes[c];if("component"==d.nodeName){var e=parseInt(d.getAttribute("typeId"))||parseInt(d.getAttribute("typeid")),f=d.getAttribute("type");if(e=e||f,this.parentScene.$class.registeredComponent(e)){var g=d.getAttribute("name"),h="true"==d.getAttribute("sync"),i="true"==d.getAttribute("temp")||!1,j=null;j=h?this.createComponent(e,g):this.createLocalComponent(e,g,b),j.temporary=i,j.deserializeFromXml(d,b)}else this.log.warn("[deserializeFromXml]: skipping unregistered component:",f)}}},toString:function(){return this.id+(this.name.length>0?" name = "+this.name:"")},update:function(){var a=this.component("Placeable");a&&a.update();for(var b=0;b<this.components.length;++b)null!=this.components[b]&&(null!=a&&a.id===this.components[b].id||this.components[b]._update());
},exec:function(a,b,c){if("string"==typeof a){var d=a.toLowerCase();if("local"===d)a=EntityAction.Local;else if("server"===d)a=EntityAction.Server;else{if("peers"!==d)return void this.log.error("exec(): Error cannot convert string exec type "+a+" no a valid EntityAction exec type!");a=EntityAction.Peers}}if(a<1||a>7)return void this.log.error("exec(): Invalid EntityAction input parameter: "+a);var e=new EntityAction;if(e.entity=this,e.entityId=this.id,e.executionType=a,e.name=b,e.parameters=[],Array.isArray(c))for(var f=0;f<c.length;f++){var g=c[f];null===g||void 0===g?e.parameters.push(""):"object"==typeof g||Array.isArray(g)?e.parameters.push(JSON.stringify(g)):e.parameters.push(g.toString())}else null!==g&&"object"==typeof c?e.parameters.push(JSON.stringify(c)):void 0!==c&&null!==c&&e.parameters.push(c.toString());if(0!==(e.executionType&EntityAction.Local)&&this.parentScene&&this.parentScene._publishEntityAction(e),0!==(e.executionType&EntityAction.Server)||0!==(e.executionType&EntityAction.Peers)){var h=new EntityActionMessage;h.serialize(e),Tundra.network.send(h)}},addComponent:function(a){if(void 0===a||null===a)return!1;for(var b=this.components.length-1;b>=0;b--)if(null!=this.components[b]&&this.components[b].id===a.id)return!1;var c=IComponent.propertyName(a.typeName);return""!==a.typeName&&"name"!==c&&(this[c]=a,c!==c.toLowerCase()&&(this[c.toLowerCase()]=a)),this.components.push(a),a.setParent(this),a._update(),a.local&&a.id>this.componentIdGenerator.localId?this.componentIdGenerator.localId=a.id:a.replicated&&a.id>this.componentIdGenerator.id&&(this.componentIdGenerator.id=a.id),null!=this.parentScene&&this.parentScene._publishComponentCreated(this,a),!0},removeComponent:function(a){for(var b=this.components.length-1;b>=0;b--)if(null!=this.components[b]&&this.components[b].id===a){var c=this.components[b];return null!=c&&(null!=this.parentScene&&this.parentScene._publishComponentRemoved(this,c),c._reset()),this.components.splice(b,1),c=null,!0}return!1},removeComponentByName:function(a,b){for(var c=IComponent.ensureComponentNameWithoutPrefix(a),d=this.components.length-1;d>=0;d--)if(this.components[d].typeName===c){if(null!=b&&this.components[d].name!==b)continue;var e=this.components[d];return null!=e&&(Tundra.events.send("Scene.ComponentRemoved."+this.id.toString(),this,e),e._reset()),this.components.splice(d,1),e=null,!0}return!1},component:function(a,b){if("string"!=typeof a)return this.log.error("component() called with non-string type name for Entity: "+this.toString()),null;for(var c=IComponent.ensureComponentNameWithoutPrefix(a),d=this.components.length-1;d>=0;d--)if(this.components[d]&&this.components[d].typeName===c&&(void 0===b||this.components[d].name===b))return this.components[d];return null},getComponent:function(a,b){return this.component(a,b)},componentById:function(a){for(var b=this.components.length-1;b>=0;b--)if(null!=this.components[b]&&this.components[b].id===a)return this.components[b];return null},getComponentById:function(a){return this.componentById(a)},componentByTypeId:function(a,b){for(var c=this.components.length-1;c>=0;c--)if(null!=this.components[c]&&this.components[c].typeId===a&&(void 0===b||this.components[c].name===b))return this.components[c];return null},getComponents:function(a,b){for(var c=[],d="string"!=typeof a,e=d?"":IComponent.ensureComponentNameWithoutPrefix(a),f=this.components.length-1;f>=0;f--){var g=this.components[f];(null!=g&&d&&g.typeId===a||!d&&g.typeName===e)&&(void 0===b||"string"!=typeof b?c.push(g):g.name===b&&c.push(g))}return c},createLocalComponent:function(a,b){return this.createComponent(a,b,AttributeChange.LocalOnly)},createComponent:function(a,b,c){if(null==this.parentScene)return this.log.error("Cannot create component, parent scene is null for Entity: "+this.toString()),null;void 0!==c&&"number"!=typeof c&&this.log.warn("createComponent called with non AttributeChange.Type change mode, defaulting to AttributeChange.Default."),c=c||AttributeChange.Default,b=b||"",c!==AttributeChange.LocalOnly&&(c===AttributeChange.Default?c=AttributeChange.LocalOnly:(this.log.warn("createComponent called with localOnly != AttributeChange.LocalOnly. Creating replicated components is not supported at the moment, defaulting to LocalOnly."),c=AttributeChange.LocalOnly));var d=this.parentScene.createComponent(a,b);return null!=d&&(c==AttributeChange.LocalOnly||c==AttributeChange.Disconnected||c==AttributeChange.Default?d.replicated=!1:d.replicated=!0,d.local=!d.replicated,d.id=d.replicated?this._nextReplicatedComponentId():this._nextLocalComponentId()),this.addComponent(d),d},getOrCreateLocalComponent:function(a,b){return this.getOrCreateComponent(a,b,AttributeChange.LocalOnly)},getOrCreateComponent:function(a,b,c){var d=this.component(a,b);return d||(d=this.createComponent(a,b,c)),d}}),TransformEditor=Class.$extend({__init__:function(){this.targets=[],this.previousParentOfTarget={},this.activeNode=void 0,this.visuals=!0,this.helpers={},this.cameraSubscription=null,this.translationSnap=0,this.rotationSnap=0,this.Mode={Translate:"translate",Rotate:"rotate",Scale:"scale"},this.mode=this.Mode.Translate,this.gridHelper=new GridHelper(void 0,100),this.configure(),this._initTransformControl(),this.cameraSubscription=Tundra.renderer.onActiveCameraChanged(this,this.onActiveCameraChanged),Tundra.frame.onUpdate(this,this.onFrameUpdate)},__classvars__:{ModeFromString:function(a){return"string"!=typeof a?"":(a=a.toLowerCase(),"translate"===a||"position"===a||"pos"===a?"translate":"rotate"===a||"rotation"===a||"rot"===a?"rotate":"scale"===a||"scaling"===a?"scale":"")}},_initTransformControl:function(){var a=Tundra.renderer.camera,b=Tundra.renderer.renderer.domElement;this.transformControl=new THREE.TransformControls(a,b,this.options),this.transformControl.setSpace("local"),this.transformControl.addEventListener("change",this.onUpdate.bind(this)),this.transformControl.addEventListener("mouseDown",this.onDragStarted.bind(this)),this.transformControl.addEventListener("mouseUp",this.onDragStopped.bind(this)),this.options&&this.options.mode?this.transformControl.setMode(TransformEditor.ModeFromString(this.options.mode)):this.transformControl.setMode(TransformEditor.ModeFromString(this.mode)),this.setTranslationSnap(this.options.pos&&this.options.pos.snap?this.options.pos.snap:this.translationSnap),this.setRotationSnap(this.options.rot&&this.options.rot.snap?this.options.rot.snap:this.rotationSnap),this.setGridSize(this.options&&this.options.gridSize?this.options.gridSize:100)},_appendTarget:function(a){if(!a)return!1;if(a.typeId&&20===a.typeId&&(a=a.parentEntity),!a.placeable)return console.error("[TransformEditor]: _appendTarget: Invalid target provided:",a),!1;if(this.isTargetEntity(a))return!1;var b=a.placeable.sceneNode,c=this._getAncestors(b),d=this._getDescendants(b);if(!this._isAncestorInTargets(b,c)){var e=this._descendantInTargets(b,d);e!=-1&&this.targets.splice(e,1),this.targets.push(a.placeable)}if(this.visuals){var f=this._getThreeMesh(a);f&&this._updateHelpers(f);for(var g=c.length-1;g>=0;g--){var h=Tundra.scene.entityById(c[g].tundraEntityId);if(h){var i=this._getThreeMesh(h);i&&this._updateHelpers(i,65535)}}for(var g=d.length-1;g>=0;g--){var h=Tundra.scene.entityById(d[g].tundraEntityId);if(h){var i=this._getThreeMesh(h);i&&this._updateHelpers(i,16711935)}}}return!0},_updateHelpers:function(a,b){b=b||16776960;var c=a.uuid;if(!this.helpers[c]){var d=a.clone();this.helpers[c]={wireframe:new THREE.WireframeHelper(d,65535),box:new THREE.BoxHelper(a),originalMesh:a},Tundra.renderer.scene.add(this.helpers[c].wireframe),Tundra.renderer.scene.add(this.helpers[c].box)}this.helpers[c].wireframe.material.linewidth=2,this.helpers[c].wireframe.visible=!1,this.helpers[c].box.material.linewidth=4,this.helpers[c].box.material.depthTest=!1,this.helpers[c].box.material.depthWrite=!1,this.helpers[c].box.material.side=THREE.FrontSide,this.helpers[c].box.material.color=new THREE.Color(b),this.helpers[c].box.update(a)},_getFirstAncestor:function(a){for(;a.parent&&"Object3D"===a.parent.type;)a=a.parent;return a},_getAncestors:function(a){for(var b=[],c=a;c.parent&&"Object3D"===c.parent.type;)b.push(c.parent),c=c.parent;return b},_getDescendants:function(a){var b=[];if(a.children.length>0)for(var c=a.children.length-1;c>=0;c--)a.children[c].tundraComponentId&&"Object3D"===a.children[c].type&&(b.push(a.children[c]),b=b.concat(this._getDescendants(a.children[c])));return b},_getThreeMesh:function(a){if(a.meshmoon3dtext)return a.meshmoon3dtext.textMesh;var b=a.mesh;return b&&b.meshAsset&&b.meshAsset.mesh&&b.meshAsset.mesh.children.length>0?b.meshAsset.mesh.children[0]:void 0},_isAncestorInTargets:function(a,b){b=b||this._getAncestors(a);for(var c=b.length-1;c>=0;c--)for(var d=b[c].uuid,e=this.targets.length-1;e>=0;e--){var f=this.targets[e].sceneNode.uuid;if(d==f)return!0}return!1},_descendantInTargets:function(a,b){for(var b=b||this._getDescendants(a),c=b.length-1;c>=0;c--)for(var d=b[c].uuid,e=this.targets.length-1;e>=0;e--){var f=this.targets[e].sceneNode.uuid;if(d==f)return e}return-1},configure:function(a,b){b=b||!1,b=b||$.isEmptyObject(this.options),b&&(this.options=$.extend(!0,{scale:{lock:!1}},a))},targetEntities:function(){for(var a=[],b=0;b<this.targets.length;b++)this.targets[b]&&this.targets[b].parentEntity&&a.push(this.targets[b].parentEntity);return a},isTargetEntity:function(a){if(!(a instanceof Entity))return!1;for(var b=this.targetEntities(),c=0;c<b.length;c++)if(b[c].id===a.id)return!0;return!1},setTargetEntity:function(a,b){this.setTargetEntities(a._ptr?a._ptr:a,b)},appendTarget:function(a,b){if(a&&a.placeable&&!this._isAncestorInTargets(a.placeable.sceneNode)){for(var c=this.targets.length-1;c>=0;c--)if(this.targets[c].parentEntity.id==a.id)return;this.setTargetEntities(this.targets.concat([a]),b)}},setTargetEntities:function(a,b){if(a){this.clearSelection(!1),this.configure(b,!0);var c=!1;a=Array.isArray(a)?a:[a];for(var d=0;d<a.length;d++)this._appendTarget(a[d])&&(c=!0);if(!c||0===this.targets.length)return 0===this.targets.length&&Tundra.events.send("TransformEditor.Targets.Change",[],[]),!1;var e=null;if(1==this.targets.length)e=this.targets[0].sceneNode;else{for(var f=new THREE.Vector3(0,0,0),g=new THREE.Vector3(0,0,0),h=new THREE.Vector3(0,0,0),d=0;d<this.targets.length;++d){var i=this.targets[d].worldPosition();f.add(i);var j=this.targets[d].sceneNode.rotation.toVector3();g.add(j);var k=this.targets[d].worldScale();h.add(k)}f.divideScalar(this.targets.length),g.divideScalar(this.targets.length),h.divideScalar(this.targets.length),e=Tundra.renderer.createSceneNode(),e.position.copy(f),e.quaternion.setFromEuler(new THREE.Euler(g.x,g.y,g.z)),e.scale.copy(h),e.updateMatrix(),e.updateMatrixWorld(),Tundra.renderer.scene.add(e)}this._attachSceneNode(e),this.cameraSubscription=Tundra.renderer.onActiveCameraChanged(this,this.onActiveCameraChanged),Tundra.events.send("TransformEditor.Targets.Change",this.targets,this.targetEntities())}},_attachSceneNode:function(a){this.activeNode=a,this.transformControl||this._initTransformControl(),this.transformControl.attach(this.activeNode),Tundra.renderer.scene.add(this.transformControl)},_detachParents:function(){if(!(this.targets.length<2)&&this.activeNode)for(var a=this.targets.length-1;a>=0;a--){var b=this.targets[a].sceneNode;"Object3D"==b.parent.type&&(this.previousParentOfTarget[b.uuid]=b.parent,THREE.SceneUtils.detach(b,b.parent,Tundra.renderer.scene)),THREE.SceneUtils.attach(this.targets[a].sceneNode,Tundra.renderer.scene,this.activeNode)}},_reAttachParent:function(a){this.targets.length<2||!this.activeNode||!a||(THREE.SceneUtils.detach(a,this.activeNode,Tundra.renderer.scene),this.previousParentOfTarget[a.uuid]&&(THREE.SceneUtils.attach(a,Tundra.renderer.scene,this.previousParentOfTarget[a.uuid]),delete this.previousParentOfTarget[a.uuid]))},setMode:function(a){var b=TransformEditor.ModeFromString(a);return b?(this.mode=b,this.transformControl&&this.transformControl.setMode(b),void Tundra.events.send("TransformEditor.Mode.Change",b)):void console.warn("TransformEditor.setMode: Invalid mode",a)},setTranslationSnap:function(a){this.translationSnap=a>=0?a:0,this.gridHelper&&(this.gridHelper.setStep(this.translationSnap),this.translationSnap>0?this.gridHelper.show():this.gridHelper.hide()),this.transformControl&&this.transformControl.setTranslationSnap(this.translationSnap>0?this.translationSnap:null)},setRotationSnap:function(a){this.rotationSnap=a>=0?a:0,this.transformControl&&this.transformControl.setRotationSnap(this.rotationSnap>0?THREE.Math.degToRad(this.rotationSnap):null)},setGridSize:function(a){this.gridHelper&&this.gridHelper.setSize(a)},setGridPosition:function(a){this.gridHelper&&this.gridHelper.setPos(a)},onFrameUpdate:function(a){if(this.transformControl){this.transformControl.isAttached()&&this.transformControl.update();for(var b=Object.keys(this.helpers),c=0;c<b.length;++c)this.helpers[b[c]].box&&this.helpers[b[c]].originalMesh&&this.helpers[b[c]].box.update(this.helpers[b[c]].originalMesh)}},onActiveCameraChanged:function(a,b){this.transformControl&&this.transformControl.setCamera(a.camera)},onUpdate:function(a){this.activeNode&&0!==this.targets.length&&(this.activeNode.updateMatrix(),this.activeNode.updateMatrixWorld())},onDragStarted:function(a){this._detachParents();for(var b=Object.keys(this.helpers),c=0;c<b.length;++c){var d=b[c],e=this.helpers[d].wireframe,f=this.helpers[d].originalMesh;e.matrix.copy(f.matrixWorld),e.visible=!0}1==this.targets.length&&Tundra.events.send("TransformEditor.DragStart",this.targets[0].parentEntity)},onDragStopped:function(a){var b=[];if(this.targets.length>1)for(var c=this.targets.length-1;c>=0;c--){var d=this.targets[c],e=d.transform,f=d.sceneNode;this._reAttachParent(f),e.setPosition(f.position),e.setRotation(f.quaternion),e.setScale(f.scale),b.push({target:d,before:d.transform,after:e}),d.transform=e}else if(1===this.targets.length){var d=this.targets[0],e=d.transform;e.setPosition(this.activeNode.position),e.setRotation(this.activeNode.quaternion),e.setScale(this.activeNode.scale),b.push({target:d,before:d.transform,after:e}),d.transform=e}Tundra.events.send("TransformEditor.Transform.Change");for(var g=Object.keys(this.helpers),c=0;c<g.length;++c){var h=g[c];this.helpers[h].wireframe.visible=!1}1==b.length&&Tundra.events.send("TransformEditor.DragEnd",b[0].target.parentEntity),Tundra.events.send("TransformEditor.MultiTransform",b)},clearSelection:function(a){this.cameraSubscription&&Tundra.events.unsubscribe(this.cameraSubscription),this.targets.length>1&&Tundra.renderer.scene.remove(this.activeNode),this.gridHelper&&this.gridHelper.hide(),this.transformControl&&(this.transformControl.detach(),Tundra.renderer.scene.remove(this.transformControl),delete this.transformControl),this.activeNode=void 0;for(var b=Object.keys(this.helpers),c=b.length-1;c>=0;c--){var d=b[c];Tundra.renderer.scene.remove(this.helpers[d].wireframe),Tundra.renderer.scene.remove(this.helpers[d].box),delete this.helpers[d]}this.targets.length=0,this.cameraSubscription=void 0,a!==!1&&Tundra.events.send("TransformEditor.Targets.Change",[],[])}}),GridHelper=Class.$extend({__init__:function(a,b,c){this.pos=a||new THREE.Vector3,this.size=b||10,this.step=c||1,this.visible=!1,this.obj=null},_create:function(a,b,c){a||(a=this.pos),b||(b=this.size),c||(c=this.step),this.pos=a,this.size=b,this.step=c,this.obj=new THREE.GridHelper(this.size,this.step),Tundra.renderer.scene.add(this.obj),this.obj.position.copy(this.pos),this.obj.visible=this.visible},_destroy:function(){this.obj&&(Tundra.renderer.scene.remove(this.obj),delete this.obj)},show:function(){this.obj||this._create(),this.obj.visible=this.visible=!0},hide:function(){this.obj&&(this.visible=this.obj.visible=!1)},setSize:function(a){this._destroy(),this._create(void 0,a,void 0)},setStep:function(a){this._destroy(),this._create(void 0,void 0,a)},setPos:function(a){this._destroy(),this._create(a,void 0,void 0)}}),PlaceableUtils={};PlaceableUtils.Animator=Class.$extend({__init__:function(){this.log=TundraLogging.getLogger("PlaceableUtils.Animator"),this.schedule=[]},reset:function(){this.stop(!0)},getScheduled:function(a){var b=a;if("string"!=typeof b&&"Placeable"===a.typeName&&(b=a.parentEntity.id+"."+a.id),"string"!=typeof b)return void this.log.error("getScheduled: Invalid parameter:",a);for(var c=this.schedule.length-1;c>=0;c--)if(this.schedule[c].key===a)return this.schedule[c]},getEasing:function(a,b){if("function"==typeof a)return a;if("string"==typeof a){var c=a.toLowerCase();if("linear"===c)return TWEEN.Easing.Linear.None;if("quadratic"===c)return b?TWEEN.Easing.Quadratic.Out:TWEEN.Easing.Quadratic.InOut;if("bounce"===c)return b?TWEEN.Easing.Bounce.Out:TWEEN.Easing.Bounce.InOut;if("cubic"===c)return b?TWEEN.Easing.Cubic.Out:TWEEN.Easing.Cubic.InOut}return b?TWEEN.Easing.Cubic.Out:TWEEN.Easing.Cubic.InOut},position:function(a,b){if(b=b||{},"Placeable"!==a.typeName)return this.log.error("position: First parameter needs to be a Placeable component"),null;if(null==a.parentEntity)return this.log.error("position: Placeable component is not parented."),null;if(void 0===b.to||"number"!=typeof b.to.z)return this.log.error("position: Option 'to' must be a Vector3 like object."),null;b.from=b.from||a.worldPosition();var c=a.parentEntity.id+"."+a.id+".pos",d=this._stopByKey(c);b.easing=this.getEasing(b.easing,d),b.duration=b.duration||1e3,a._animatingPosition=!0;var e={key:c,placeable:a,animator:this};return e.stop=function(){return this.animator&&this.key?void this.animator._stopByKey(this.key):void(this.placeable&&(this.placeable._animatingPosition=!1))},e.animation=new TWEEN.Tween({x:b.from.x,y:b.from.y,z:b.from.z,placeable:a,sheduled:e,t:0}).easing(b.easing).to({x:b.to.x,y:b.to.y,z:b.to.z,t:1},b.duration).onUpdate(function(){if(this.placeable&&this.placeable.parentEntity){if("function"==typeof this.sheduled.animation._shouldStop&&this.sheduled.animation._shouldStop.apply(this)===!0)return this.sheduled.animation.stop();this.placeable.setPosition(this.x,this.y,this.z),"function"==typeof this.sheduled.animation._onUpdate&&this.sheduled.animation._onUpdate.apply(this)}}).onComplete(function(){this.sheduled.stop(),"function"==typeof this.sheduled.animation._onComplete&&this.sheduled.animation._onComplete.apply(this)}),this.schedule.push(e),e.animation.start(),e.animation},rotation:function(a,b){if(b=b||{},"Placeable"!==a.typeName)return this.log.error("rotation: First parameter needs to be a Placeable component"),null;if(null==a.parentEntity)return this.log.error("rotation: Placeable component is not parented."),null;if(void 0===b.to||"number"!=typeof b.to.z)return this.log.error("rotation: Option 'to' must be a Vector3 like object."),null;b.from=b.from||a.rotation();var c=a.parentEntity.id+"."+a.id+".rot",d=this._stopByKey(c);b.easing=this.getEasing(b.easing,d),b.duration=b.duration||1e3,a._animatingRotation=!0;var e={key:c,placeable:a,animator:this};return e.stop=function(){return this.animator&&this.key?void this.animator._stopByKey(this.key):void(this.placeable&&(this.placeable._animatingRotation=!1))},e.animation=new TWEEN.Tween({x:b.from.x,y:b.from.y,z:b.from.z,placeable:a,sheduled:e}).easing(b.easing).to({x:b.to.x,y:b.to.y,z:b.to.z},b.duration).onUpdate(function(){this.placeable&&this.placeable.parentEntity&&this.placeable.setRotation(this.x,this.y,this.z)}).onComplete(function(){this.sheduled.stop()}),this.schedule.push(e),e.animation.start(),e.animation},setVisibilityScaling:function(a,b,c){if(c=c||{},"Placeable"!==a.typeName)return this.log.error("setVisibilityScaling: First parameter needs to be a Placeable component"),null;if(null==a.parentEntity)return this.log.error("setVisibilityScaling: Placeable component is not parented."),null;c.from=c.from||(b?0:a.transform.scale),c.to=c.to||(b?1:0);var d=a.parentEntity.id+"."+a.id+".scale",e=this._stopByKey(d);if(b||a.visible){var f={x:"number"==typeof c.from?c.from:c.from.x,y:"number"==typeof c.from?c.from:c.from.y,z:"number"==typeof c.from?c.from:c.from.z,placeable:a,visible:b},g={x:"number"==typeof c.to?c.to:c.to.x,y:"number"==typeof c.to?c.to:c.to.y,z:"number"==typeof c.to?c.to:c.to.z};c.easing=this.getEasing(c.easing,e),c.duration=c.duration||1e3,a._animatingVisibility=!0,a._animatingVisibilityTo=b,a._animatingScale=!0,a.setScale(f.x,f.y,f.z),a.visible=!0,a.parentEntity.billboard&&(a.parentEntity.billboard.setOverrideScale(f.x,f.y),a.parentEntity.billboard.show(!1));var h={key:d,placeable:a,animator:this};return h.stop=function(){return this.animator&&this.key?void this.animator._stopByKey(this.key):void(this.placeable&&(this.placeable._animatingVisibility=!1,this.placeable._animatingVisibilityTo=void 0,this.placeable._animatingScale=!1))},f.sheduled=h,h.animation=new TWEEN.Tween(f).easing(c.easing).to(g,c.duration).onUpdate(function(){this.placeable&&this.placeable.parentEntity&&((this.x<0||MathUtils.isZero(this.x))&&(this.x=0),(this.y<0||MathUtils.isZero(this.y))&&(this.y=0),(this.z<0||MathUtils.isZero(this.z))&&(this.z=0),this.placeable.setScale(this.x,this.y,this.z),this.placeable.parentEntity.billboard&&this.placeable.parentEntity.billboard.setOverrideScale(this.x,this.y))}).onComplete(function(a){this.placeable&&this.placeable.parentEntity&&(this.placeable.visible=this.visible,this.placeable.parentEntity.billboard&&this.placeable.parentEntity.billboard.setVisible(this.visible)),this.sheduled.stop()}),this.schedule.push(h),h.animation.start(),h.animation}},stop:function(a){var b=!1;if("string"==typeof a||"object"==typeof a){if("string"!=typeof a&&"Placeable"===a.typeName){var c=a.parentEntity.id+"."+a.id;return this._stopByKey(c+".pos")&&(b=!0),this._stopByKey(c+".scale")&&(b=!0),b}return"string"!=typeof a?(this.log.error("stop: Invalid parameter:",a),!1):this._stopByKey(a)}if("boolean"==typeof a&&a===!0){for(;this.schedule.length>0;)this.schedule[0].key?this._stopByKey(this.schedule[0].key):this.schedule.splice(0,1);this.schedule=[],b=!0}else this.log.error("stop: Invalid parameter:",a);return b},_stopByKey:function(a){for(var b=!1,c=this.schedule.length-1;c>=0;c--)if(this.schedule[c].key===a){found=!0;var d=this.schedule.splice(c,1)[0];d.key=void 0,d.stop(),d.animation&&(b||(b=d.animation.isPlaying()),d.animation.stop())}return b}}),PlaceableUtils._transformEditor=null,Object.defineProperties(PlaceableUtils,{Gizmo:{get:function(){return this._transformEditor||(this._transformEditor=new TransformEditor),this._transformEditor}}}),Tundra.Classes.PlaceableUtils=PlaceableUtils;var IRenderSystem=Class.$extend({__init__:function(a){this.name=a},__classvars__:{register:function(a){var b=new this;return a.registerRenderSystem(b)?b:null},getDefaultOptions:function(){return{}}},_load:function(a){TundraLogging.getLogger("IRenderSystem").info("Loading "+this.name+" render system"),this.load(a)},load:function(a){},_unload:function(){TundraLogging.getLogger("IRenderSystem").info("Unloading "+this.name+" render system"),this.unload()},unload:function(){},postInitialize:function(){},setActiveCamera:function(a){TundraLogging.getLogger("IRenderSystem").warn("setActiveCamera() not implemented.")},activeCamera:function(){return TundraLogging.getLogger("IRenderSystem").warn("activeCamera() not implemented."),null},activeCameraEntity:function(){return TundraLogging.getLogger("IRenderSystem").warn("activeCameraEntity() not implemented."),null},createSceneNode:function(){return TundraLogging.getLogger("IRenderSystem").warn("createSceneNode() not implemented."),null},updateSceneNode:function(a,b){TundraLogging.getLogger("IRenderSystem").warn("updateSceneNode() not implemented.")},raycastAllFrom:function(a,b,c){return TundraLogging.getLogger("IRenderSystem").warn("raycastAllFrom() not implemented."),null},raycastFrom:function(a,b,c){return TundraLogging.getLogger("IRenderSystem").warn("raycastFrom() not implemented."),null},raycastAll:function(a,b,c){return TundraLogging.getLogger("IRenderSystem").warn("raycastAll() not implemented."),null},raycast:function(a,b,c){return TundraLogging.getLogger("IRenderSystem").warn("raycast() not implemented."),null}}),IDomIntegration=Class.$extend({__init__:function(a){this.name=a},__classvars__:{register:function(a){var b=new this;return a.registerDomIntegration(b)?b:null}},_load:function(){Tundra.client.log.info("Loading "+this.name+" DOM integration system"),this.load()},load:function(){},_unload:function(){Tundra.client.log.info("Unloading "+this.name+" DOM integration system"),this.unload()},unload:function(){}}),EasingCurve=Class.$extend({__init__:function(a,b){this.p0=new THREE.Vector2(0,0),this.p1=a||new THREE.Vector2(0,.5),this.p2=b||new THREE.Vector2(1,.5),this.p3=new THREE.Vector2(1,1)},getTime:function(a){a=Math.min(Math.max(a,0),1);var b=this.p0.clone().lerp(this.p1,a),c=this.p1.clone().lerp(this.p2,a),d=this.p2.clone().lerp(this.p3,a);return b.lerp(c,a),c.lerp(d,a),b.lerp(c,a).x}}),ITundraAPI=Class.$extend({__init__:function(a,b){"string"==typeof a&&""!==a||console.error("ITundraAPI constructor must be called with 'name' that is a non-empty string!"),this.name=a,this.options=b||{},this.staging={initialized:!1,postInitialized:!1};var c=this.name;"string"==typeof c&&c.length>3&&"API"===c.substring(c.length-3)&&(c=c.substring(0,c.length-3)),this.log=TundraLogging.getLogger(c)},reset:function(){},_initialize:function(){this.staging.initialized||(this.initialize(),this.staging.initialized=!0)},initialize:function(){},_postInitialize:function(){this.staging.postInitialized||(this.postInitialize(),this.staging.postInitialized=!0)},postInitialize:function(){}}),AsyncHelper=Class.$extend({__init__:function(a,b){this.name="string"==typeof a&&""!==a?"AsyncHelper."+a:"AsyncHelper",this.handles={},this.deferred={},this.data={},this.defaultContext=b||this},__classvars__:{async:function(a,b,c){if("function"!=typeof a)return console.error("AsyncHelper.async: 'callback' is not a function:",a),!1;"number"==typeof b&&"number"!=typeof c&&(c=b,b=void 0);var d=b&&b.length?b:[b],e=function(){a.apply(this,d)}.bind(this),f="number"==typeof c&&c>0,g=f?setTimeout(e,c):requestAnimationFrame(e);return f?g:~g},cancel:function(a){"number"==typeof a&&(a<0?cancelAnimationFrame(~a):clearTimeout(a))}},async:function(a,b,c,d){if("string"!=typeof a||""===a.trim())return TundraLogging.get(this.name).error("async: 'name' is invalid:",a),!1;if("function"!=typeof b)return TundraLogging.get(this.name).error("async: 'callback' is not a function:",b),!1;this.cancel(a),"number"==typeof c&&"number"!=typeof d&&(d=c,c=void 0);var e=c&&c.length?c:[c],f=this._wrap(a,b,e),g="number"==typeof d&&d>0,h=g?setTimeout(f,d):requestAnimationFrame(f);return this.handles[a]=g?h:~h,!0},hasAsync:function(a){return void 0!==this.handles[a]},numAsync:function(){return Object.keys(this.handles).length},defer:function(a,b){if("string"!=typeof a||""===a.trim())return TundraLogging.get(this.name).error("defer: 'name' is invalid:",a),$.Deferred().promise();var c=this.deferred[a];if(void 0!==c)return c.promise();var d=this._createDefer(a,b);return d.promise},hasDefer:function(a){return void 0!==this.deferred[a]},numDefers:function(){return Object.keys(this.deferred).length},deferImmediate:function(a,b){var c=this.defer(a);return this.resolve.apply(this,arguments),c},resolve:function(a,b){if("string"!=typeof a||""===a.trim())return TundraLogging.get(this.name).error("resolve: 'name' is invalid:",a),!1;var c=this.deferred[a];if(void 0!==c){delete this.deferred[a];var d=[];if(arguments.length>2)for(var e=2;e<arguments.length;e++)d.push(arguments[e]);b!==!1?c.resolve.apply(c,d):c.reject.apply(c,d)}},cancel:function(a){if("string"!=typeof a||""===a.trim())return TundraLogging.get(this.name).error("cancel: 'name' is invalid:",a),!1;var b=this.handles[a];return void 0!==b&&(b<0?cancelAnimationFrame(~b):clearTimeout(b)),delete this.handles[a],delete this.deferred[a],void 0!==b},when:function(){for(var a=[],b=0;b<arguments.length;++b)"string"==typeof arguments[b]?a.push(this.defer(arguments[b])):$.isFunction(arguments[b].promise)&&a.push(arguments[b]);return $.when.apply(this.defaultContext||this,a)},_createDefer:function(a,b){var c={isNew:void 0===this.deferred[a]};return void 0!==b&&"function"!=typeof b&&(b=void 0),c.defer=$.Deferred(b),c.promise=c.defer.promise(),c.isNew&&(this.deferred[a]=c.defer),c},_wrap:function(a,b,c){return function(){delete this.handles[a],b.apply(this.defaultContext||this,c)}.bind(this)}});Tundra.Classes.AsyncHelper=AsyncHelper;var FrameLimiter=Class.$extend({__init__:function(a){this.step="number"==typeof a?a:0,this.t=0,this.time=performance.now()},tick:function(){var a=performance.now();this.t+=(performance.now()-this.time)/1e3,this.time=a},shouldUpdate:function(a){return"number"==typeof a?this.t+=a:this.tick(),this.t>=this.step&&(this.t=this.t%this.step,!0)}});Tundra.Classes.FrameLimiter=FrameLimiter;var AssetCache=Class.$extend({__init__:function(){this.assets={}},assetData:function(){for(var a={},b=Object.keys(this.assets),c=0;c<b.length;c++){var d=this.assets[b[c]];d&&d.isLoaded()&&(void 0===a[d.type]?a[d.type]=1:a[d.type]++)}return a},get:function(a){return this.assets[a]},set:function(a,b){this.assets[a]=b},remove:function(a){delete this.assets[a]},hasAsset:function(a){return void 0!==this.get(a)},getAssets:function(){var a=[];for(var b in this.assets)a.push(this.assets[b]);return a},forgetAssets:function(){this.assets={}}}),_enableAssetProfiling=!1,_profiling=_enableAssetProfiling?{loaded:0,timeTotal:0,types:["all"]}:void 0,IAsset=Class.$extend({__init__:function(a,b){this.log=TundraLogging.getLogger(b),this.name=a,this.type=b,this.baseRef=0!==a.indexOf("/")?a.substring(0,a.lastIndexOf("/")+1):"",a.indexOf(".zip#")!==-1&&(this.baseRef=a.substring(0,a.lastIndexOf(".zip#")+5)),this.dependencyRefs=[],this.requiresCloning=!1,this.isCloneSource=!1,this.logging=!1},__classvars__:{cloneCounts:{}},numClones:function(){var a=IAsset.cloneCounts[this.name];return void 0===a&&(a=0),a},originalName:function(){var a=this.name.indexOf("_clone_");return a>0?this.name.substring(0,a):this.name},cloneName:function(a){return this.name+"_clone_"+a},isLoaded:function(){return!1},onDeserializedFromData:function(a,b){return Tundra.events.subscribe("IAsset.DeserializedFromData."+this.name,a,b)},onLoaded:function(a,b){return Tundra.events.subscribe("IAsset.Loaded."+this.name,a,b)},onFailed:function(a,b){return Tundra.events.subscribe("IAsset.Failed."+this.name,a,b)},onDependencyFailed:function(a,b){return Tundra.events.subscribe("IAsset.DependencyFailed."+this.name,a,b)},onUnloaded:function(a,b){return Tundra.events.subscribe("IAsset.Unloaded."+this.name,a,b)},clone:function(a){if(void 0===a||"string"!=typeof a){var b=this.numClones()+1;a=this.cloneName(b),IAsset.cloneCounts[this.name]=b}if(void 0===a||"string"!=typeof a)return this.log.error("Canno clone() as input parameter 'newAssetName' is not defined!"),null;var c=Tundra.asset.getAsset(a);if(void 0!==c&&null!==c)return this.log.error("Cannot clone() asset '"+this.name+"' to new asset '"+a+"', it already exists!"),null;var d=this._cloneImpl(a);return void 0!==d&&null!==d?Tundra.asset.cache.set(d.name,d):this.log.error("Failed to create clone '"+a+"'"),d},_cloneImpl:function(a){return this.log.warn("_cloneImpl() not implemented/overridden by this asset type '"+this.type+"'"),null},numDependencies:function(){return this.dependencies().length},numPendingDependencies:function(){return 0},dependencies:function(){return this.dependencyRefs},pendingDependencies:function(){return[]},deserializeFromData:function(a,b,c){},unload:function(){},_deserializeFromData:function(a,b,c){var d=void 0;if(void 0!==_profiling)for(var e=0;e<_profiling.types.length;e++)if("all"===_profiling.types[e]||_profiling.types[e]===this.type){d=new Date;break}var f=this.deserializeFromData(a,b,c);if(void 0===f?f=!0:"boolean"!=typeof f&&(this.log.error("deserializeFromData returned non boolean type value: "+f+" for "+this.name+". Assuming loading failed, marking to false. Fix your failure code paths to return 'false'.",!0),
f=!1),void 0!==_profiling&&void 0!==d){var g=this.name.substring(this.name.lastIndexOf("/")+1),h=new Date-d;_profiling.timeTotal+=h,_profiling.loaded+=f?1:0,console.log("Loaded in "+h+" msec [totals: time spent = "+_profiling.timeTotal+" msec num = "+_profiling.loaded+"] "+g)}return f&&Tundra.asset._emitAssetDeserializedFromData(this),f&&this.isLoaded()&&this._emitLoaded(),f},_unload:function(){this.unload(),this._emiUnloaded()},_emitDeserializedFromData:function(){Tundra.events.send("IAsset.DeserializedFromData."+this.name,this)},_emitLoaded:function(){Tundra.events.send("IAsset.Loaded."+this.name,this)},_emitFailed:function(a){Tundra.events.send("IAsset.Failed."+this.name,this,a)},_emitDependencyFailed:function(a){Tundra.events.send("IAsset.DependencyFailed."+this.name,a)},_emiUnloaded:function(){Tundra.events.send("IAsset.Unloaded."+this.name,this)}}),AssetTransfer=Class.$extend({__init__:function(a,b,c,d,e){this.factory=a,this.ref=b,this.proxyRef=c,this.type=d,this.suffix=e,this.requestDataType=void 0,this.requestTimeout=1e4,this.active=!1,this.loading=!1,this.aborted=!1,this.silent=!1,this.parentAssets=[],this.httpStatusCode=-1,this.subscribers=[],this.subscriptions=[]},__classvars__:{completedFired:{},reset:function(){AssetTransfer.completedFired={}},HttpStatus:{CONTINUE:100,SWITCHING_PROTOCOLS:101,OK:200,CREATED:201,ACCEPTED:202,NON_AUTHORITATIVE_INFORMATION:203,NO_CONTENT:204,RESET_CONTENT:205,PARTIAL_CONTENT:206,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,USE_PROXY:305,TEMPORARY_REDIRECT:307,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,REQUEST_ENTITY_TOO_LARGE:413,REQUEST_URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,REQUEST_RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505},statusCodeName:function(a){switch(a){case this.HttpStatus.CONTINUE:return"Continue";case this.HttpStatus.SWITCHING_PROTOCOLS:return"Switching Protocols";case this.HttpStatus.OK:return"OK";case this.HttpStatus.CREATED:return"Created";case this.HttpStatus.ACCEPTED:return"Accepted";case this.HttpStatus.NON_AUTHORITATIVE_INFORMATION:return"Non Authoritative Information";case this.HttpStatus.NO_CONTENT:return"No Content";case this.HttpStatus.RESET_CONTENT:return"Reset Content";case this.HttpStatus.PARTIAL_CONTENT:return"Partial Content";case this.HttpStatus.MULTIPLE_CHOICES:return"Multiple Choices";case this.HttpStatus.MOVED_PERMANENTLY:return"Moved Permanently";case this.HttpStatus.FOUND:return"Found";case this.HttpStatus.SEE_OTHER:return"See Other";case this.HttpStatus.NOT_MODIFIED:return"Not Modified";case this.HttpStatus.USE_PROXY:return"Use Proxy";case this.HttpStatus.TEMPORARY_REDIRECT:return"Temporary Redirect";case this.HttpStatus.BAD_REQUEST:return"Bad Request";case this.HttpStatus.UNAUTHORIZED:return"Unauthorized";case this.HttpStatus.PAYMENT_REQUIRED:return"Payment Required";case this.HttpStatus.FORBIDDEN:return"Forbidden";case this.HttpStatus.NOT_FOUND:return"Not Found";case this.HttpStatus.METHOD_NOT_ALLOWED:return"Method Not Allowed";case this.HttpStatus.NOT_ACCEPTABLE:return"Not Acceptable";case this.HttpStatus.PROXY_AUTHENTICATION_REQUIRED:return"Proxy Authentication Required";case this.HttpStatus.REQUEST_TIMEOUT:return"Request Timeout";case this.HttpStatus.CONFLICT:return"Conflict";case this.HttpStatus.GONE:return"Gone";case this.HttpStatus.LENGTH_REQUIRED:return"Length Required";case this.HttpStatus.PRECONDITION_FAILED:return"Precondition Failed";case this.HttpStatus.REQUEST_ENTITY_TOO_LARGE:return"Request Rntity Too Large";case this.HttpStatus.REQUEST_URI_TOO_LONG:return"Request Uri Too Long";case this.HttpStatus.UNSUPPORTED_MEDIA_TYPE:return"Unsupported Media Type";case this.HttpStatus.REQUEST_RANGE_NOT_SATISFIABLE:return"Request Range Not Satisfiable";case this.HttpStatus.EXPECTATION_FAILED:return"Expectation Failed";case this.HttpStatus.INTERNAL_SERVER_ERROR:return"Internal Server Error";case this.HttpStatus.NOT_IMPLEMENTED:return"Not Implemented";case this.HttpStatus.BAD_GATEWAY:return"Bad Gateway";case this.HttpStatus.SERVICE_UNAVAILABLE:return"Service Unavailable";case this.HttpStatus.GATEWAY_TIMEOUT:return"Gateway Timeout";case this.HttpStatus.HTTP_VERSION_NOT_SUPPORTED:return"Http Version Not Supported";case 0:return"";default:return"Unknown HTTP status code "+a}},isHttpSuccess:function(a){switch(a){case this.HttpStatus.OK:case this.HttpStatus.CREATED:case this.HttpStatus.ACCEPTED:case this.HttpStatus.NOT_MODIFIED:return!0;default:return!1}}},toString:function(){return"ref = "+this.ref+" type = "+this.type+" suffix = "+this.suffix+" dataType = "+this.requestDataType},equals:function(a){if(a&&a.ref)return this.ref===a.ref&&this.proxyRef===a.proxyRef&&this.type===a.type},abort:function(){this.aborted!==!0&&(this.aborted=!0,Tundra.asset.removeTransfer(this),void 0!==this._ajax&&"function"==typeof this._ajax.abort&&(this._ajax.abort(),this._ajax=void 0))},addParentAsset:function(a){if(!(a instanceof IAsset))return void TundraLogging.get("AssetTransfer").error("addParentAsset called with non IAsset object:",a);for(var b=0;b<this.parentAssets.length;b++)if(this.parentAssets[b].name===a.name)return;this.parentAssets.push(a)},onCompleted:function(a,b,c){this.subscribers.push({type:"completed",context:a,callback:b,metadata:c})},onFailed:function(a,b,c){this.subscribers.push({type:"failed",context:a,callback:b,metadata:c})},_detectRequestDataType:function(){var a=null!=this.factory?this.factory.requestDataType(this.suffix):void 0;return"string"==typeof a?a:(TundraLogging.get("AssetTransfer").warn("AssetFactory for",this.ref,"failed to return data type. Guessing from known types."),"Binary"===this.type?"arraybuffer":"Text"===this.type&&".xml"===this.suffix||".txml"===this.suffix?"xml":"Text"===this.type&&".html"===this.suffix||".html"===this.suffix?"document":"Text"===this.type&&".json"===this.suffix?"json":"Text"===this.type?"text":void 0)},_send:function(){if(this.active===!0)return void TundraLogging.get("AssetTransfer").error("Transfer is already active, refusing to re-send:",this.ref);if(this.active=!0,void 0!==Tundra.asset.getHttpProxyResolver()){var a=Tundra.asset.getHttpProxyResolver().resolveRequestMetadata(this,this.proxyRef);void 0!==a&&(this.requestDataType="string"==typeof a.dataType?a.dataType:void 0,this.requestTimeout="number"==typeof a.timeout?a.timeout:this.requestTimeout)}void 0!==this.requestDataType&&null!==this.requestDataType&&""!==this.requestDataType||(this.requestDataType=this._detectRequestDataType()),"arraybuffer"!==this.requestDataType&&"document"!==this.requestDataType?this._ajax=$.ajax({type:"GET",timeout:this.requestTimeout,url:void 0!==this.proxyRef?this.proxyRef:this.ref,dataType:this.requestDataType,context:this,success:this._onTransferCompleted,error:this._onTransferFailed}):(this._ajax=new XMLHttpRequest,this._ajax.open("GET",void 0!==this.proxyRef?this.proxyRef:this.ref,!0),this._ajax.responseType=this.requestDataType,this._ajax.timeout=this.requestTimeout,this._ajax.addEventListener("load",this._onTransferCompletedBinary.bind(this),!1),this._ajax.addEventListener("timeout",this._onTransferFailedBinary.bind(this),!1),this._ajax.addEventListener("error",this._onTransferFailedBinary.bind(this),!1),this._ajax.send(null))},_handleHttpErrors:function(a){return!AssetTransfer.isHttpSuccess(a)&&(Tundra.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+a+" "+AssetTransfer.statusCodeName(a)),!0)},_onTransferCompleted:function(a,b,c){this.aborted!==!0&&(this.httpStatusCode=c.status,this._handleHttpErrors(this.httpStatusCode)||(this._loadAssetFromData(a),c.responseText=null,c.responseXml=null,c=null,a=null,this._ajax=void 0))},_onTransferCompletedBinary:function(a){if(this.aborted!==!0){var b=a.currentTarget;this.httpStatusCode=b.status,this._handleHttpErrors(this.httpStatusCode)||(this._loadAssetFromData(b.response),b.response=null,b=null,this._ajax=void 0)}},_onTransferFailed:function(a,b,c){this.aborted!==!0&&(this.httpStatusCode=a.status,Tundra.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+(0!==a.status?a.status:"Request Timed Out")+" "+AssetTransfer.statusCodeName(a.status)+("string"==typeof b?" ("+b+")":"")),a.responseText=null,a.responseXml=null,a=null,this._ajax=void 0)},_onTransferFailedBinary:function(a){if(this.aborted!==!0){var b=a.currentTarget;this.httpStatusCode=b.status,Tundra.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+(0!==b.status?b.status:"Request Timed Out")+" "+AssetTransfer.statusCodeName(b.status)),b.response=null,b=null,this._ajax=void 0}},_loadAssetFromData:function(a){Tundra.asset.removeActiveTransfer(this);var b=Tundra.asset.createEmptyAsset(this.ref,this.type);if(null==b)return void Tundra.asset.assetTransferFailed(this,"Failed to create asset of unknown type '"+this.type+"' for '"+this.ref+"'");try{this._deserializeFromData(b,a)}catch(c){Tundra.asset.assetTransferFailed(this,"Exception while deserializing asset from data: "+c,!0),void 0!==c.stack&&console.error(c.stack),console.log(this)}this.active=!1},_deserializeFromData:function(a,b){var c=a._deserializeFromData(b,this.requestDataType,this);c?a.isLoaded()?this._assetLoadCompleted(a):(this.loading=!0,this.subscriptions.push(a.onLoaded(this,this._assetLoadCompleted)),this.subscriptions.push(a.onFailed(this,this._assetLoadFailed)),this.subscriptions.push(a.onDependencyFailed(this,this._assetDependencyFailed))):Tundra.asset.assetTransferFailed(this,"IAsset.deserializeFromData failed loading asset "+this.ref)},_assetLoadCompleted:function(a){this.loading=!1,Tundra.asset.assetTransferCompleted(this,a)},_assetLoadFailed:function(a,b){this.loading=!1,Tundra.asset.assetTransferFailed(this,"Asset "+this.ref+" request failed: "+("string"==typeof b?b:"Unkown reason"))},_assetDependencyFailed:function(a){this.loading=!1,Tundra.asset.assetTransferFailed(this,"Asset "+this.ref+" request failed. Dependency "+a+" could not be loaded.")},_emitCompleted:function(a){for(var b=0;b<this.subscriptions.length;b++)Tundra.events.unsubscribe(this.subscriptions[b]);this.subscriptions=[];var c=AssetTransfer.completedFired[a.name];void 0===c&&(c=0);for(var b=0;b<this.subscribers.length;++b)try{var d=this.subscribers[b];if("completed"!==d.type)continue;var e=null;a.requiresCloning&&c>0?a.canReuse===!0?(a.canReuse=!1,e=a):e=a.clone():e=a,c++,d.callback.call(void 0!==d.context&&null!==d.context?d.context:this,e,d.metadata)}catch(f){Tundra.client.logError("[AssetTransfer]: Completed handler exception: "+f,!0),void 0!==f.stack&&console.error(f.stack)}AssetTransfer.completedFired[a.name]=c,this.subscribers=[]},_emitFailed:function(a){for(var b=0;b<this.subscriptions.length;b++)Tundra.events.unsubscribe(this.subscriptions[b]);this.subscriptions=[];for(var b=0;b<this.subscribers.length;++b)try{var c=this.subscribers[b];if("failed"!==c.type)continue;c.callback.call(void 0!==c.context&&null!==c.context?c.context:this,this,a,c.metadata)}catch(d){Tundra.client.logError("[AssetTransfer]: Failed handler exception: "+d,!0)}this.subscribers=[]}}),AssetFactory=Class.$extend({__init__:function(a,b,c,d){"string"!=typeof a&&console.error("AssetFactory constructor 'assetType' needs to be a string!"),void 0!==b&&null!==b||console.error("AssetFactory constructor 'assetClass' is not a valid object!"),void 0!==c&&Array.isArray(c)?console.error("AssetFactory constructor 'typeExtensions' must be a object mapping suffix to request data type!"):void 0!==c&&"object"!=typeof c&&console.error("AssetFactory constructor 'typeExtensions' must be a object mapping suffix to request data type!"),this.assetType=a,this.assetClass=b,this.typeExtensions=c,this.defaultDataType=d},supportedSuffixes:function(){return Object.keys(this.typeExtensions)},requestDataType:function(a){var b=this.typeExtensions[a.toLowerCase()];return"string"==typeof b?b:"string"==typeof this.defaultDataType?this.defaultDataType:void 0},canCreate:function(a){if(void 0===this.typeExtensions||null===this.typeExtensions)return!1;for(var b=CoreStringUtils.extension(a),c=(a.toLowerCase(),Object.keys(this.typeExtensions)),d=0,e=c.length;d<e;++d)if(CoreStringUtils.endsWith(b,c[d]))return!0;return!1},createEmptyAsset:function(a){var b=new this.assetClass(a);return this.emptyAssetCreated(b),b},emptyAssetCreated:function(a){}}),TextAsset=IAsset.$extend({__init__:function(a){this.$super(a,"TextAsset"),this.data=null},isLoaded:function(){return null!==this.data},deserializeFromData:function(a,b,c){this.data=a},unload:function(){this.data=null}}),BinaryAsset=IAsset.$extend({__init__:function(a){this.$super(a,"BinaryAsset"),this.data=null},isLoaded:function(){return null!==this.data},deserializeFromData:function(a,b,c){this.data=a},unload:function(){this.data=null}}),AssetAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b);for(var d=Object.keys(this.options.storages),e=0;e<d.length;e++){var f=d[e];""===this.options.storages[f]||CoreStringUtils.endsWith(this.options.storages[f],"/")||(this.options.storages[f]+="/"),this.options.storages[f]!==this.options.storages[f.toLowerCase()]&&(this.options.storages[f.toLowerCase()]=this.options.storages[f],delete this.options.storages[f]),"webtundra://"===f.toLowerCase()&&(this.options.storages["web-tundra://"]=this.options.storages[f.toLowerCase()])}this._timing=new AsyncHelper(this.name,this),this._timing.data={transferNum:0,tStart:0},this._limiterProcess=new FrameLimiter(.1),this.cache=new AssetCache,this.transfers=[],this.factories=[],this.autoProcessTransfers=!0,this.maxActiveTransfers=8,this.maxActiveTransfersPerType={}},initialize:function(){this.registerAssetFactory(new AssetFactory("Binary",BinaryAsset,{},"arraybuffer")),this.registerAssetFactory(new AssetFactory("Text",TextAsset,{".xml":"xml",".txml":"xml",".html":"document",".htm":"document",".json":"json",".js":"json",".txt":"text",".rss":"xml"},"text"))},postInitialize:function(){for(var a=0;a<this.factories.length;a++)this._logAssetTypeFactory(this.factories[a],!0)},reset:function(){this.abortTransfers(),this.defaultStorage=null,this.transfers=[],this.readyTransfers=[],this.activeTransfers=[],this.noFactoryErrors={},AssetTransfer.reset(),this._timing.async("forget.assets",function(){this.forgetAssets(!0)})},__classvars__:{getDefaultOptions:function(){return{storages:{"webtundra://":""}}},httpProxyResolver:void 0,setHttpProxyResolver:function(a){return this.httpProxyResolver=a,Tundra.events&&Tundra.events.send("AssetAPI.HTTP.Proxy.Changed",this.httpProxyResolver),this.httpProxyResolver},loadScript:function(a,b){return b=$.extend(b||{},{url:a,dataType:"script",cache:!0}),$.ajax(b)},loadDependencies:function(a){if(void 0!==a&&null!==a||(a=""),"string"!=typeof a)return Tundra.asset.log.error("loadDependencies: First parameter must be a context ref. If you don't need to specify a context pass in 'undefined'"),$.Deferred(function(a){a.reject()}).promise();var b=[].slice.call(arguments,1);if(!Array.isArray(b)||0===b.length)return Tundra.asset.log.error("loadDependencies: Invoked without any dependencies"),$.Deferred(function(a){a.reject()}).promise();a=Tundra.asset.resolveAssetRef("",a);for(var c=0;c<b.length;c++)if("string"!=typeof b[c])return Tundra.asset.log.error("loadDependencies: Invoked with a dependency that is not a string:",b),$.Deferred(function(a){a.reject()}).promise();for(var c=0;c<b.length;c++){var d=Tundra.asset.resolveAssetRef(a,b[c]);"string"==typeof d&&""!==d&&d!==b[c]&&(b[c]=d)}return promise=$.Deferred(function(c){$.extend(c,{_context:a,_refs:b,_error:void 0,_onFail:function(a,b,c){void 0===this._error&&(this._error="Failed to fetch dependency '"+this._processingRef+"' for '"+this._context+"':",c?this._error+=" "+c.toString():b&&(this._error+=" "+b))},_processNext:function(){if(void 0!==this._error)return Tundra.asset.log.error("loadDependencies:",this._error),void this.reject(this.error);if(0===this._refs.length)return void this.resolve();this._processingRef=this._refs.splice(0,1)[0];var a=CoreStringUtils.extension(this._processingRef);".html"!==a?Tundra.asset.loadScript(this._processingRef).fail(this._onFail.bind(this)).always(this._processNext.bind(this)):this._processNext()}}),c._processNext()}).promise()}},loadScript:function(a,b){return AssetAPI.loadScript(a,b)},loadDependencies:function(){return AssetAPI.loadDependencies.apply(AssetAPI,arguments)},setHttpProxyResolver:function(a){return AssetAPI.setHttpProxyResolver(a)},onHttpProxyResolvedChanged:function(a,b){return Tundra.events.subscribe("AssetAPI.HTTP.Proxy.Changed",a,b)},getHttpProxyResolver:function(){return AssetAPI.httpProxyResolver},registerAssetFactory:function(a){if(!(a instanceof AssetFactory))return this.log.error("registerAssetFactory called with a non AssetFactory object:",a),!1;for(var b=0;b<this.factories.length;++b)if(this.factories[b].assetType===a.assetType)return this.log.error("AssetFactory with type '"+a.assetType+"' already registered:",this.factories[b]),!1;return this.factories.push(a),this._logAssetTypeFactory(a),!0},_logAssetTypeFactory:function(a,b){(this.staging.postInitialized||b===!0)&&(void 0!==a.typeExtensions&&a.supportedSuffixes().length>0?this.log.debug("Registered factory",a.assetType,a.supportedSuffixes()):this.log.debug("Registered factory",a.assetType))},getAssetFactory:function(a,b){if("string"==typeof b){for(var c=0;c<this.factories.length;c++)if(this.factories[c].assetType===b)return this.factories[c];if(0===b.indexOf("."))for(var c=0;c<this.factories.length;c++)if(this.factories[c].canCreate(b))return this.factories[c]}else for(var c=0;c<this.factories.length;c++)if(this.factories[c].canCreate(a))return this.factories[c];return null},getLocalAssetPath:function(a){return CoreStringUtils.startsWith(a,"webtundra://")?a=a.substring(12):CoreStringUtils.startsWith(a,"webtundra-applications://")&&(a=a.substring(24)),this.options.storages["webtundra://"]+a},getAsset:function(a){return this.cache.get(a)},abortTransfers:function(){if(void 0!==this.transfers)for(var a=0;a<this.transfers.length;a++)this.transfers[a].abort();if(void 0!==this.activeTransfers)for(var a=0;a<this.activeTransfers.length;a++)this.activeTransfers[a].abort()},forgetAssets:function(a){a="boolean"!=typeof a||a;for(var b=this.cache.getAssets(),c=0;c<b.length;c++){var d=b[c];null!=d&&Tundra.events.send("AssetAPI.AssetAboutToBeRemoved",d),a&&null!=d&&"function"==typeof d.unload&&(d.requiresCloning=!1,d.isCloneSource=!1,d.unload()),d=null}this.cache.forgetAssets()},forgetAsset:function(a,b){return this.forget(a,b)},forget:function(a,b){if(b="boolean"!=typeof b||b,"string"!=typeof a&&a instanceof IAsset&&(a=a.name),"string"!=typeof a)return void this.log.error("forgetAsset: Must pass in asset reference of IAsset instance:",a,b);var c=this.cache.get(a);c&&(Tundra.events.send("AssetAPI.AssetAboutToBeRemoved",c),b&&"function"==typeof c.unload&&(c.requiresCloning=!1,c.isCloneSource=!1,c.unload()),c=null,this.cache.remove(a))},update:function(a){if(this._limiterProcess.shouldUpdate(a)&&(this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers&&this.autoProcessTransfers===!0&&this.processTransfers(),this.readyTransfers.length>0))for(var b=performance.now(),c=5,d=this.readyTransfers.length-1;d>=0;d--){var e=this.readyTransfers[d],f=this.getAsset(e.ref);if(f&&e._emitCompleted(f),this.readyTransfers.splice(d,1),performance.now()-b>c)return}},handleDefaultStorage:function(a){var b=JSON.parse(a);this.defaultStorage=b.storage},makeDefaultStorageRelativeRef:function(a){if(null!=this.defaultStorage&&"string"==typeof this.defaultStorage.src&&CoreStringUtils.startsWith(a,this.defaultStorage.src))return a.substring(this.defaultStorage.src.length)},resourceTypeForAssetRef:function(a){if(""!==a){var b=this.getAssetFactory(a);return null!=b&&"string"==typeof b.assetType?b.assetType:void 0}},isSupportedAssetRef:function(a){return null!==this.getAssetFactory(a)},isSupportedAssetType:function(a){return null!==this.getAssetFactory(void 0,a)},isRelativeRef:function(a){if(0===a.indexOf("/"))return!0;if(this.isRegisteredStorageSheme(a))return!0;var b=a.toLowerCase();return 0!==b.indexOf("http://")&&0!==b.indexOf("https://")},isLocalhostRef:function(a){var b=a.toLowerCase(),c="";if(0===b.indexOf("http://")?c=b.substring(7):0===b.indexOf("https://")&&(c=b.substring(8)),""!==c){if(0===c.indexOf("localhost"))return!0;if("string"==typeof Tundra.DeveloperServerHost&&0===c.indexOf(Tundra.DeveloperServerHost))return!0}return!1},isRegisteredStorageSheme:function(a){var b=a.indexOf("://");return b!==-1&&void 0!==this.options.storages[a.substring(0,b+3).toLowerCase()]},resolveRef:function(a,b){if("string"!=typeof b&&"string"==typeof a&&(b=a,a=""),"string"!=typeof b||""===b)return"";if(!this.isRelativeRef(b))return b;if(this.isRegisteredStorageSheme(b))return this.resolveCustomStorageRef(b);var c=b;if(CoreStringUtils.startsWith(b,"/")&&(b=b.substring(1)),a instanceof IAsset)return a.baseRef+b;if("string"==typeof a){if(""===a)return c;var d=a;return a.indexOf(".zip#")!==-1?d=a.substring(0,a.lastIndexOf(".zip#")+5):CoreStringUtils.endsWith(a,"/")||a.indexOf("/")===-1||(d=a.substring(0,a.lastIndexOf("/")+1)),d+b}return this.log.error("resolveAssetRef: Allowed 'context' types are IAsset and String, given:",a,"for ref",b),c},resolveAssetRef:function(a,b){return this.resolveRef(a,b)},resolveCustomStorageRef:function(a){if("string"!=typeof a||""===a)return"";var b=a.indexOf("://");if(b===-1)return"";var c=a.substring(0,b+3).toLowerCase();if("http://"===c||"https://"===c)return"";var d=a.substring(b+3),e=this.options.storages[c];return"string"!=typeof e?"":(0===d.indexOf("/")&&(d=d.substring(1)),e+d)},requestDependencyAsset:function(a,b,c){if(!(a instanceof IAsset))return this.log.error("requestDependencyAsset called with non IAsset object as 'parentAsset':",a),null;if("string"!=typeof b)return this.log.error("requestDependencyAsset: 'ref' is not a string:",b),null;b=this.resolveAssetRef(a,b);var d=this.transfers.length,e=this.requestAsset(b,c);if(null==e)return e;if(e.addParentAsset(a),this.transfers.length>d){var f=this.transfers.splice(this.transfers.length-1,1)[0];f.ref!==e.ref&&this.log.error("Something went wrong in injecting transfer to the start of the queue: "+e.ref+" removed from last index: "+f.ref),this.transfers.splice(0,0,f)}if(void 0!==a&&void 0!==a.dependencyRefs){for(var g=!1,h=a.dependencyRefs.length-1;h>=0&&!(g=a.dependencyRefs[h]===e.ref);h--);g||a.dependencyRefs.push(e.ref)}return e},requestAsset:function(a,b){return this.request(a,b)},prependTransfer:function(a){if(a instanceof AssetTransfer){for(var b=-1,c=0;c<this.transfers.length;c++)if(this.transfers[c].equals(a)){b=c;break}if(b>0){var d=this.transfers.splice(b,1)[0];d&&d.ref===a.ref||this.log.error("prependTransfer: Something went wrong in injecting transfer to the start of the queue: "+a.ref+" removed from index "+b+": "+(d?d.ref:"-")),this.transfers.splice(0,0,d)}}},request:function(a,b){if("string"!=typeof a)return this.log.error("requestAsset: 'ref' is not a string:",a),null;if(CoreStringUtils.startsWith(a,"generated://",!0)||CoreStringUtils.startsWith(a,"local://",!0))return null;var c=this.getAssetFactory(a,b);if(null===c){var d=this.noFactoryErrors[a];return void 0===d&&("string"==typeof b?this.log.error("No registered AssetFactory for type '"+b+"':",a):this.log.error("No registered AssetFactory for suffix '"+CoreStringUtils.extension(a)+"':",a),this.noFactoryErrors[a]=!0),null}var e=CoreStringUtils.extension(a),f=c.assetType;"string"==typeof e&&""!==e&&e.indexOf("/")===-1||(0===b.indexOf(".")?e=b.trim().toLowerCase():"Binary"===f?e="":this.log.warn("Failed to detect asset extension for '"+a+"':",e));var g=this.resolveCustomStorageRef(a);if("string"!=typeof g||""===g){if(CoreStringUtils.startsWith(a,"webtundra://")||CoreStringUtils.startsWith(a,"webtundra-applications://"))a=this.getLocalAssetPath(a);else if(this.isRelativeRef(a)&&(a=null!=this.defaultStorage&&"string"==typeof this.defaultStorage.src?this.defaultStorage.src+a:this.options.storages["webtundra://"]+a,CoreStringUtils.startsWith(a,"local://",!0)))return console.warn("local:// default storage cannot be used with WebTundra. It has no direct disk access. Ignoring request:",a),null}else a=g;var h=void 0,i={};CoreStringUtils.startsWith(a,"http",!0)&&void 0!==AssetAPI.httpProxyResolver&&(h=AssetAPI.httpProxyResolver.resolve(i,a,f,e));for(var j=null,k=this.readyTransfers.length-1;k>=0;k--)if(j=this.readyTransfers[k],j.ref===a)return j;for(var k=this.transfers.length-1;k>=0;k--)if(j=this.transfers[k],j.ref===a)return j;var l=this.getAsset(a);if(void 0!==l&&null!==l){if(l.isLoaded())return j=new AssetTransfer(null,a,h,f,e),j.proxyMetadata=i,this.readyTransfers.push(j),j;this.cache.remove(l.name)}return j=new AssetTransfer(c,a,h,f,e),j.proxyMetadata=i,this.transfers.push(j),this._timing.cancel("transfers.completed.sync"),0===this._timing.data.transferNum&&(this._timing.data.tStart=performance.now()),this._timing.data.transferNum++,Tundra.events.send("AssetAPI.ActiveAssetTransferCountChanged",this.numCurrentTransfers()),j},processTransfers:function(a,b){void 0===a&&(a=!0),"number"!=typeof b&&(b=performance.now());var c=!0;if(this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers)for(var d=this.numQueuedTransfersPerType(),e=0;e<this.transfers.length;++e){var f=this.transfers[e];if(void 0===f||null===f){this.transfers.splice(0,1);break}if(!f.active&&!f.loading){var g=this.maxAssetTransfersForType(f.type);if(!(void 0!==g&&"number"==typeof g&&g>0&&this.activeTransfersForType(f.type)>=g&&Object.keys(d).length>1)){c=!1,this.activeTransfers.push(f),f._send();break}}}a===!0&&!c&&this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers&&performance.now()-b<5&&this.processTransfers(a,b)},maxAssetTransfersForType:function(a){if("string"==typeof a)return this.maxActiveTransfersPerType[a]},numQueuedTransfersPerType:function(){for(var a={},b=0;b<this.transfers.length;b++)if(!this.transfers[b].active&&!this.transfers[b].loading){var c=this.transfers[b].type;void 0===a[c]&&(a[c]=0),a[c]+=1}return a},numQueuedTransfers:function(){for(var a=0,b=0;b<this.transfers.length;b++)!this.transfers[b].active&&this.transfers[b].loading&&(a+=1);return a},transferState:function(){for(var a={active:{},loading:{},queued:{}},b=0;b<this.activeTransfers.length;b++){var c=this.activeTransfers[b].type;void 0===a.active[c]&&(a.active[c]=0),a.active[c]+=1}for(var b=0;b<this.transfers.length;b++)if(!this.transfers[b].active){var d=this.transfers[b].loading?"loading":"queued",c=this.transfers[b].type;void 0===a[d][c]&&(a[d][c]=0),a[d][c]+=1}return a},activeTransfersForType:function(a){for(var b=0,c=0;c<this.activeTransfers.length;++c)this.activeTransfers[c].type===a&&b++;return b},removeActiveTransfer:function(a){for(var b=0;b<this.activeTransfers.length;++b)if(this.activeTransfers[b].ref===a.ref){this.activeTransfers.splice(b,1);break}},removeTransfer:function(a){this.removeActiveTransfer(a);for(var b=0;b<this.transfers.length;++b)if(this.transfers[b].ref===a.ref){this.transfers.splice(b,1);break}var c=this.numCurrentTransfers();Tundra.events.send("AssetAPI.ActiveAssetTransferCountChanged",c),0===c&&(this._timing.resolve("transfers.completed",!0,this._timing.data.transferNum),Tundra.client.isConnected()||this.log.isDebug()?this._timing.async("transfers.completed.sync",function(){if("number"==typeof this._timing.data.transferNum&&this._timing.data.transferNum>0){var a=performance.now()-this._timing.data.tStart,b=a/1e3,c=a/this._timing.data.transferNum,d=this._timing.data.transferNum/b;this.log.info(this._timing.data.transferNum,"transfers completed in",b.toFixed(2),"sec / avg",c.toFixed(0),"msec / QPS",d.toFixed(2),"- All done")}if(this._timing.data.transferNum=0,this.log.isDebug()||Tundra.network.options.debug===!1){for(var e={},f=Tundra.asset.cache.getAssets(),g=0;g<f.length;g++){var h=f[g];void 0===e[h.type]?e[h.type]=1:e[h.type]+=1}this.log.debug("Loaded assets:",e)}},500):this._timing.data.transferNum=0)},assetTransferCompleted:function(a,b){b.requiresCloning&&(b.isCloneSource=!0),void 0===this.getAsset(b.name)&&this.log.warn("Could not find cache item to update for",b.name,"Did you create the original asset with AssetAPI.createEmptyAsset?"),this.cache.set(b.name,b),this.removeTransfer(a),a._emitCompleted(b),b=null,a=null},assetTransferFailed:function(a,b){"string"==typeof b&&(a.silent||204===a.httpStatusCode||Tundra.client.logError("[AssetAPI]: "+b,!0)),this.removeTransfer(a),a._emitFailed(b),a=null},createEmptyAsset:function(a,b){var c=this.getAssetFactory(void 0,b);if(null!==c){var d=c.createEmptyAsset(a);return this.cache.set(d.name,d),Tundra.events.send("AssetAPI.AssetCreated",d),d}return null},numCurrentTransfers:function(){return this.transfers.length},allTransfersCompleted:function(){return 0===this.numCurrentTransfers()},onTransfersCompleted:function(){return this.allTransfersCompleted()?this._timing.deferImmediate("transfers.completed",!0,0):this._timing.defer("transfers.completed")},onActiveAssetTransferCountChanged:function(a,b){return Tundra.events.subscribe("AssetAPI.ActiveAssetTransferCountChanged",a,b)},onAssetCreated:function(a,b){return Tundra.events.subscribe("AssetAPI.AssetCreated",a,b)},onAssetDeserializedFromData:function(a,b){return Tundra.events.subscribe("AssetAPI.AssetDeserializedFromData",a,b)},_emitAssetDeserializedFromData:function(a){Tundra.events.send("AssetAPI.AssetDeserializedFromData",a),a._emitDeserializedFromData()},onAssetAboutToBeRemoved:function(a,b){return Tundra.events.subscribe("AssetAPI.AssetAboutToBeRemoved",a,b)}}),IApplication=Class.$extend({__init__:function(a){null==a&&(Tundra.client.log.warn("[IApplication]: Constructor called without a valid application name!",!0),a="Unknown Application"),Tundra.client.log.info("Starting "+a+" application"),this.log=TundraLogging.getLogger(a),this.framework=Tundra.framework,this.name=a,this.assetRef=IApplication.assetRef,this.entity=IApplication.entity,this.component=IApplication.component,this.eventSubscriptions=[],this.startupApplication=IApplication.startupApplication;try{void 0!==IApplication.parentScriptAsset&&null!==IApplication.parentScriptAsset&&IApplication.parentScriptAsset._setApplication(this)}catch(b){console.error("[IApplication]: Failed to register "+this.name+": "+b),void 0!==b.stack&&console.error(b)}},__classvars__:{entity:null,component:null,assetRef:null,startupApplication:null,parentScriptAsset:null,_setupStatic:function(a,b,c,d,e){IApplication.assetRef=c,IApplication.entity=a,IApplication.component=b,IApplication.startupApplication=d,IApplication.parentScriptAsset=e},_resetStatic:function(){IApplication.entity=null,IApplication.component=null,IApplication.assetRef=null,IApplication.startupApplication=null,IApplication.parentScriptAsset=null},loadDependencies:function(a){return a instanceof IApplication?(arguments[0]=a.assetRef,AssetAPI.loadDependencies.apply(AssetAPI,arguments)):(console.error("[IApplication]: loadDependencies: First parameter must be a IApplication instance given:",a),$.Deferred(function(a){a.reject()}).promise())}},_onScriptDestroyed:function(){try{this.onScriptDestroyed()}catch(a){console.error("IApplication.onScriptDestroyed:",this.name,this.entity),console.error(a)}this.name=null,this.assetRef=null,this.entity=null,this.component=null,this.startupApplication=null,this.framework=null,this.unsubscribeEvents()},onScriptDestroyed:function(){},resolveRef:function(a){var b=Tundra.asset.resolveAssetRef("",this.assetRef);return Tundra.asset.resolveAssetRef(b,a)},subscribeEvent:function(a){void 0!==a&&this.eventSubscriptions.push(a)},unsubscribeEvents:function(){for(var a=0;a<this.eventSubscriptions.length;a++)Tundra.events.unsubscribe(this.eventSubscriptions[a]);
this.eventSubscriptions=[]}});window.IApplication=IApplication;var ICameraApplication=IApplication.$extend({__init__:function(a,b){void 0===b&&(b=!0),b===!0&&this.$super(a),this.cameraEntity=null,this.cameraApplicationState={applicationName:"",animateActivation:!1,animationT:0,animationDuration:2,animationStartTransform:null,animationEndTransform:null,previousCameraEntity:null,onUpdateSub:null,animationStart:null,animationStop:null,easing:new EasingCurve}},__classvars__:{CollisionsEnabled:!1,CollisionDistance:1.5,CollisionDistanceY:1.5,CollisionTargets:[],DirectionRays:[new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0)],CollisionLastHitDirection:new THREE.Vector3(0,0,0),CollisionLastHitPosition:new THREE.Vector3(0,0,0),CollisionLastHitDistance:-1,detectCollision:function(a){if(ICameraApplication.CollisionsEnabled!==!0||0===ICameraApplication.CollisionTargets.length)return!1;if(null==a)return!1;for(var b=0,c=ICameraApplication.DirectionRays.length;b<c;++b){var d=ICameraApplication.DirectionRays[b],e=Tundra.renderer.raycastFrom(a,d,{targets:ICameraApplication.CollisionTargets,ignoreECModel:!0,recursive:!0}),f=0===d.y?ICameraApplication.CollisionDistance:ICameraApplication.CollisionDistanceY;if(e.distance>-.1&&e.distance<f)return ICameraApplication.CollisionLastHitDirection.copy(d),ICameraApplication.CollisionLastHitPosition.copy(e.pos),ICameraApplication.CollisionLastHitDistance=e.distance,!0}return!1},collision:function(a,b){if(0===ICameraApplication.CollisionTargets.length)return-1;if(null==a)return-1;var c=Tundra.renderer.raycastFrom(a,b,{targets:ICameraApplication.CollisionTargets,ignoreECModel:!0,recursive:!0});return c},cameraApplicationTooltip:null,showCameraApplicationInfoTooltipEnabled:!0,showCameraApplicationInfoTooltip:function(a,b){var c=Tundra.plugin("LoginScreenPlugin");if((null==c||!c.isLoadingScreenVisible())&&ICameraApplication.showCameraApplicationInfoTooltipEnabled){void 0===b&&(b=2e3),null==ICameraApplication.cameraApplicationTooltip&&(ICameraApplication.cameraApplicationTooltip=$("<div/>",{id:"webtundra-camera-application-tooltip"}),ICameraApplication.cameraApplicationTooltip.css(ICameraApplication.cameraTooltipCSS),ICameraApplication.cameraApplicationTooltip.position({my:"center top",at:"center-100 top+10",of:Tundra.client.container}),ICameraApplication.cameraApplicationTooltip.hide(),Tundra.ui.addWidgetToScene(ICameraApplication.cameraApplicationTooltip),ICameraApplication.cameraApplicationTooltip.fadeIn());var d=a+" Camera";ICameraApplication.overrideCameraApplicationInfoTooltipText&&(d=ICameraApplication.overrideCameraApplicationInfoTooltipText(d)),ICameraApplication.cameraApplicationTooltip.text(d),void 0!==ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId&&clearTimeout(ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId),ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId=setTimeout(function(){null!=ICameraApplication.cameraApplicationTooltip&&(ICameraApplication.cameraApplicationTooltip.fadeOut(function(){$(this).remove()}),ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId=void 0,ICameraApplication.cameraApplicationTooltip=null)},b)}},overrideCameraApplicationInfoTooltipText:function(a){return a},cameraTooltipCSS:{border:"1px solid grey","text-align":"center","min-width":200,"border-radius":4,padding:3,"padding-left":5,"padding-right":5,position:"absolute",width:"auto","font-family":"Arial","font-size":"14pt","font-weight":"bold",color:"color: rgb(56,56,56)","background-color":"rgba(248, 248, 248, 0.85)"}},_onScriptDestroyed:function(){this.$super(),this.resetCameraApplication()},startCameraApplication:function(a,b,c,d){if(void 0===a)return void console.error("[ICameraApplication]: createCameraEntity must pass applicationName e.g. 'Avatar' and entity name e.g. 'AvatarCamera'!");if(void 0===d&&(d=!0),null==this.cameraEntity?this.cameraEntity=Tundra.scene.createLocalEntity(["Name","Placeable","Camera","SoundListener"]):(this.cameraEntity.replicated=!1,this.cameraEntity.local=!0,this.cameraEntity.getOrCreateLocalComponent("Placeable"),this.cameraEntity.getOrCreateLocalComponent("Camera"),this.cameraEntity.getOrCreateLocalComponent("SoundListener")),this.cameraApplicationState.applicationName=a,this.cameraEntity.name=b,void 0!==c&&"number"==typeof c&&(this.cameraEntity.camera.verticalFov=c),this.subscribeEvent(Tundra.renderer.onActiveCameraChanged(this,this._onActiveCameraChanged)),d===!0)try{Tundra.client.registerCameraApplication(a,this)}catch(e){console.error(e.stack||e)}return this.cameraEntity},setVerticalFov:function(a){null!=this.cameraEntity&&null!=this.cameraEntity.camera&&void 0!==a&&"number"==typeof a&&(this.cameraEntity.camera.verticalFov=a)},resetCameraApplication:function(){this._subCameraAnimationFrameUpdates(!0),this.cameraEntity=null},animateBeforeActivation:function(a){"boolean"==typeof a&&(this.cameraApplicationState.animateActivation=a)},_subCameraAnimationFrameUpdates:function(a){void 0===a&&(a=!1),null!=this.cameraApplicationState.onUpdateSub&&Tundra.events.unsubscribe(this.cameraApplicationState.onUpdateSub),a===!1?this.cameraApplicationState.onUpdateSub=Tundra.frame.onUpdate(this,this._onCameraAnimationUpdate):null!=this.cameraEntity&&null!=this.cameraEntity.camera&&(this.cameraEntity.camera._animating=!1)},_onCameraStepAnimation:function(a){var b=this.cameraApplicationState,c=b.animationStart.pos.clone();c.lerp(b.animationStop.pos.clone(),a);var d=b.animationStart.rot.clone();d.slerp(b.animationStop.rot.clone(),a),d.normalize(),this.cameraEntity.placeable.setWorldPosition(c),this.cameraEntity.placeable.setWorldOrientation(d)},_onCameraAnimationUpdate:function(a){var b=this.cameraApplicationState;if(!(b.animationT<b.animationDuration))return this._onCameraStepAnimation(1),this._subCameraAnimationFrameUpdates(!0),this.onCameraActivated(this.cameraEntity,b.previousCameraEntity),b.animationT=0,b.previousCameraEntity=null,b.animationStart=null,void(b.animationStop=null);var c=b.easing.getTime(b.animationT/b.animationDuration);this._onCameraStepAnimation(c),b.animationT+=a},_activateCameraApplication:function(){null!=this.cameraEntity&&null!=this.cameraEntity.camera&&this.cameraEntity.camera.setActive()},_onActiveCameraChanged:function(a,b){void 0!==a&&null!==a&&(a===this.cameraEntity.camera?this._onCameraActivated(this.cameraEntity,void 0!==b?b.parentEntity:void 0):b===this.cameraEntity.camera&&(this._subCameraAnimationFrameUpdates(!0),this.onCameraDeactivated(this.cameraEntity,a.parentEntity)))},_onCameraActivated:function(a,b){ICameraApplication.showCameraApplicationInfoTooltip(this.cameraApplicationState.applicationName),this.cameraApplicationState.animateActivation===!1||null==b||null==b.placeable||null==a.placeable?this.onCameraActivated(a,b):(this.cameraApplicationState.animationT=0,this.cameraApplicationState.previousCameraEntity=b,this.cameraApplicationState.animationStart={pos:b.placeable.worldPosition(),rot:b.placeable.worldOrientation()},this.cameraApplicationState.animationStop={pos:a.placeable.worldPosition(),rot:a.placeable.worldOrientation()},a.placeable.setWorldPosition(this.cameraApplicationState.animationStart.pos),a.placeable.setWorldOrientation(this.cameraApplicationState.animationStart.rot),a.camera._animating=!0,this._subCameraAnimationFrameUpdates(!1))},onCameraActivated:function(a,b){},onCameraDeactivated:function(a,b){}});window.ICameraApplication=ICameraApplication,BitArray.ELEMENT_WIDTH=24,BitArray.prototype.set=function(a,b){1==b?this.field[~~(a/BitArray.ELEMENT_WIDTH)]|=1<<a%BitArray.ELEMENT_WIDTH:this.field[~~(a/BitArray.ELEMENT_WIDTH)]&1<<a%BitArray.ELEMENT_WIDTH&&(this.field[~~(a/BitArray.ELEMENT_WIDTH)]^=1<<a%BitArray.ELEMENT_WIDTH)},BitArray.prototype.get=function(a){return(this.field[~~(a/BitArray.ELEMENT_WIDTH)]&1<<a%BitArray.ELEMENT_WIDTH)>0?1:0},BitArray.prototype.each=function(a){for(var b=0;b<this.size;b++)a(this.get(b),b)},BitArray.prototype.toString=function(){var a=this.field.map(function(a){var b=a.toString(2);return b=new Array(BitArray.ELEMENT_WIDTH-b.length+1).join("0")+b}).reverse().join("");return a.split("").reverse().join("").slice(0,this.size)};var DataDeserializer=Class.$extend({__init__:function(a,b,c){this.bytePos=0,this.bitPos=0,void 0!==a&&this.setBuffer(a,b,c)},__classvars__:{floatReadDataView:new DataView(new ArrayBuffer(4)),doubleReadDataView:new DataView(new ArrayBuffer(8)),readByteFromBits:function(a,b){for(var c=0,d=0;d<8;++d){var e=a.get(b+d);1===e?c|=1<<d:c&=~(1<<d)}return c}},setBuffer:function(a,b,c){void 0===c?this.data=new DataView(a,b):this.data=new DataView(a,b,c),this.bytePos=0,this.bitPos=0},readUint8Array:function(a){var b=new Uint8Array(this.data.buffer,this.bytePos,a);return this.bytePos+=a,b},bytesRead:function(){return this.bytePos},readBytes:function(){return this.bytesRead()},bytesLeft:function(){return this.bytePos>=this.data.byteLength?0:this.data.byteLength-this.bytePos},bitsLeft:function(){return this.bytePos>=this.data.byteLength?0:8*(this.data.byteLength-this.bytePos)-this.bitPos},skipBytes:function(a){this.bytePos+=a},readBoolean:function(){return this.readU8()>0},readBool:function(){return this.readBoolean()},readUtf8CharCode:function(){var a,b,c,d,e;return a=this.readU8(),a<128?a:a<224?(b=this.readU8(),63&b|(31&a)<<6):a<240?(b=this.readU8(),c=this.readU8(),63&c|(63&b)<<6|(15&a)<<12):a<248?(b=this.readU8(),c=this.readU8(),d=this.readU8(),63&d|(63&c)<<6|(63&b)<<12|(7&a)<<18):a<252?(b=this.readU8(),c=this.readU8(),d=this.readU8(),e=this.readU8(),63&e|(63&d)<<6|(63&c)<<12|(63&b)<<18|(3&a)<<24):(b=this.readU8(),c=this.readU8(),d=this.readU8(),e=this.readU8(),char6=this.readU8(),63&char6|(63&e)<<6|(63&d)<<12|(63&c)<<18|(63&b)<<24|(1&a)<<30)},readStringUntil:function(a,b){for(var c="";this.bytesLeft()>0;){var d=this.readU8(),e=String.fromCharCode(d);if(void 0!==b&&d===b)break;if(void 0!==a&&e===a)break;c+=e}return c},readString:function(a,b){"boolean"!=typeof b&&(b=!1);var c="";if(a>0){var d=this.bytePos+a;if(b)for(;this.bytePos<d;)c+=String.fromCharCode(this.readUtf8CharCode(d-this.bytePos));else for(;this.bytePos<d;)c+=String.fromCharCode(this.readU8())}return c},readStringU8:function(a){return this.readString(this.readU8(),a)},readStringU16:function(a){return this.readString(this.readU16(),a)},readStringU32:function(a){return this.readString(this.readU32(),a)},readS8:function(){if(0===this.bitPos){var a=this.data.getInt8(this.bytePos);return this.bytePos+=1,a}var b=this.readBits(8);return b>=128&&(b-=256),b},readU8:function(){if(0===this.bitPos){var a=this.data.getUint8(this.bytePos);return this.bytePos+=1,a}return this.readBits(8)},readS16:function(){if(0===this.bitPos){var a=this.data.getInt16(this.bytePos);return this.bytePos+=2,a}var b=this.readBits(16);return b>=32768&&(b-=65536),b},readU16:function(){if(0===this.bitPos){var a=this.data.getUint16(this.bytePos,!0);return this.bytePos+=2,a}return this.readBits(16)},readS32:function(){if(0===this.bitPos){var a=this.data.getInt32(this.bytePos,!0);return this.bytePos+=4,a}var b=this.readBits(32);return b>=2147483648&&(b-=4294967296),b},readU32:function(){if(0===this.bitPos){var a=this.data.getUint32(this.bytePos,!0);return this.bytePos+=4,a}return this.readBits(32)},readFloat32:function(){if(0===this.bitPos){var a=this.data.getFloat32(this.bytePos,!0);return this.bytePos+=4,a}return DataDeserializer.floatReadDataView.setUint32(0,this.readBits(32),!0),DataDeserializer.floatReadDataView.getFloat32(0,!0)},readFloat64:function(){if(0===this.bitPos){var a=this.data.getFloat64(this.bytePos,!0);return this.bytePos+=8,a}return DataDeserializer.doubleReadDataView.setUint32(0,this.readBits(32),!0),DataDeserializer.doubleReadDataView.setUint32(4,this.readBits(32),!0),DataDeserializer.doubleReadDataView.getFloat64(0,!0)},readFloat32Vector3:function(){return{x:this.readFloat32(),y:this.readFloat32(),z:this.readFloat32()}},readFloat32Vector4:function(){return{x:this.readFloat32(),y:this.readFloat32(),z:this.readFloat32(),w:this.readFloat32()}},readVLE:function(){var a=this.readU8();if(0===(128&a))return a;a=127&a;var b=this.readU8();if(0===(128&b))return a|b<<7;b=127&b;var c=this.readU16();return a|b<<7|c<<14},readBit:function(){return this.readBits(1)},readBits:function(a){for(var b=0,c=0,d=this.data.getUint8(this.bytePos);a>0;)d&1<<this.bitPos&&(b|=1<<c),c++,a--,this.bitPos++,this.bitPos>7&&(this.bitPos=0,this.bytePos++,a>0&&(d=this.data.getUint8(this.bytePos)));return b},readBitArray:function(a){for(var b=0,c=new BitArray(8*a,0),d=0;d<a;++d)for(var e=this.readU8(),f=0;f<8;++f){var g=(~~e&1<<f)>0?1:0;c.set(b,g),b++}return c},readUnsignedFixedPoint:function(a,b){var c=this.readBits(a+b);return c/(1<<b)},readSignedFixedPoint:function(a,b){return this.readUnsignedFixedPoint(a,b)-(1<<a-1)},readQuantizedFloat:function(a,b,c){var d=this.readBits(c);return a+d*(b-a)/((1<<c)-1)},readNormalizedVector2D:function(a){var b=this.readQuantizedFloat(-Math.PI,Math.PI,a);return{x:Math.cos(b),y:Math.sin(b)}},readVector2D:function(a,b,c){var d=this.readBits(a+b);if(0!==d){var e=d/(1<<b),f=this.readQuantizedFloat(-Math.PI,Math.PI,c);return{x:Math.cos(f)*e,y:Math.sin(f)*e}}return{x:0,y:0}},readNormalizedVector3D:function(a,b){var c=this.readQuantizedFloat(-Math.PI,Math.PI,a),d=this.readQuantizedFloat(-Math.PI/2,Math.PI/2,b),e=Math.cos(d);return{x:e*Math.sin(c),y:-Math.sin(d),z:e*Math.cos(c)}},readVector3D:function(a,b,c,d){var e=this.readBits(c+d);if(0!==e){var f=e/(1<<d),g=this.readQuantizedFloat(-Math.PI,Math.PI,a),h=this.readQuantizedFloat(-Math.PI/2,Math.PI/2,b),i=Math.cos(h);return{x:i*Math.sin(g)*f,y:-Math.sin(h)*f,z:i*Math.cos(g)*f}}return{x:0,y:0,z:0}},readArithmeticEncoded2:function(a,b,c){var d=[],e=this.readBits(a);return d[1]=e%c,d[0]=Math.floor(e/c),d},readArithmeticEncoded3:function(a,b,c,d){var e=[],f=this.readBits(a);return val3=f%d,f=Math.floor(f/d),e[1]=f%c,e[0]=Math.floor(f/c),e},readArithmeticEncoded4:function(a,b,c,d,e){var f=[],g=this.readBits(a);return f[3]=g%e,g=Math.floor(g/e),f[2]=g%d,g=Math.floor(g/d),f[1]=g%c,f[0]=Math.floor(g/c),f},readArithmeticEncoded5:function(a,b,c,d,e,f){var g=[],h=this.readBits(a);return g[4]=h%f,h=Math.floor(h/f),g[3]=h%e,h=Math.floor(h/e),g[2]=h%d,h=Math.floor(h/d),g[1]=h%c,g[0]=Math.floor(h/c),g}}),INetworkMessageHandler=Class.$extend({__init__:function(a){this.name=a},canHandle:function(a){return!1},handle:function(a,b){return!1}}),LoginReplyMessage=INetworkMessage.$extend({__init__:function(){this.$super(LoginReplyMessage.id,"LoginReplyMessage"),this.success=!1,this.connectionId=-1,this.replyData="",this.protocolVersion=1},__classvars__:{id:101,name:"LoginReplyMessage"},deserialize:function(a){this.success=a.readBoolean(),this.connectionId=a.readVLE(),this.replyData=a.readStringU16(),a.bytesLeft()>=1&&(this.protocolVersion=a.readVLE())}}),ClientJoinedMessage=INetworkMessage.$extend({__init__:function(){this.$super(ClientJoinedMessage.id,"ClientJoinedMessage"),this.connectionId=-1},__classvars__:{id:102,name:"ClientJoinedMessage"},deserialize:function(a){this.connectionId=a.readVLE()}}),ClientLeftMessage=INetworkMessage.$extend({__init__:function(){this.$super(ClientLeftMessage.id,"ClientLeftMessage"),this.connectionId=-1},__classvars__:{id:103,name:"ClientLeftMessage"},deserialize:function(a){this.connectionId=a.readVLE()}}),TundraMessageHandler=INetworkMessageHandler.$extend({__init__:function(){this.$super("TundraMessageHandler")},canHandle:function(a){return a>=101&&a<=103||(120===a||(a>=110&&a<=116||119==a))},handle:function(a,b){var c=Tundra.client;if(a>=110&&a<=116||119==a){var d=new INetworkMessage(a);d.deserialize(b),c.scene.onTundraMessage(d)}else if(a===EntityActionMessage.id){var d=new EntityActionMessage;d.deserialize(b),c.scene.handleEntityActionMessage(d)}else if(a===LoginReplyMessage.id){var d=new LoginReplyMessage;d.deserialize(b),d.success?(c.connectionId=d.connectionId,c.protocolVersion=d.protocolVersion,""!==d.loginReplyData&&c.asset.handleDefaultStorage(d.replyData)):(c.log.error("Authentication to server failed: ",d),c.disconnect())}else if(a===ClientJoinedMessage.id){var d=new ClientJoinedMessage;d.deserialize(b)}else if(a===ClientLeftMessage.id){var d=new ClientLeftMessage;d.deserialize(b)}}}),WebSocketTester=Class.$extend({__init__:function(){this.log=TundraLogging.getLogger("WebSocketTester"),this.timing=new AsyncHelper("WebSocketTester",this)},on:function(a){return a=a.trim().toLowerCase(),"connected"===a&&this.isConnected()?this.timing.deferImmediate(a,!0,{}):this.timing.defer(a)},connect:function(a,b){this.options=$.extend({message:"",disconnectOnFirstMessage:!0,showDialogOnError:!0},b),a=a.trim(),CoreStringUtils.startsWith(a,"http://",!0)?a=a.substring(7):CoreStringUtils.startsWith(a,"https://",!0)&&(a=a.substring(8)),CoreStringUtils.startsWith(a,"ws://")||CoreStringUtils.startsWith(a,"wss://")||(a="ws://"+a),this.websocket=new WebSocket(a),this.websocket.onopen=this.onOpened.bind(this),this.websocket.onerror=this.onError.bind(this),this.websocket.onclose=this.onClosed.bind(this),this.websocket.onmessage=this.onMessage.bind(this)},disconnect:function(){void 0!==this.websocket&&this.websocket.close(),this.websocket=void 0},isConnected:function(){return void 0!==this.websocket&&3!==this.websocket.readyState},send:function(a){void 0!==this.websocket&&this.websocket.send(a)},onOpened:function(a){this.log.debug("connected"),this._dispatch("connected",!0,a),"string"==typeof this.options.message&&""!==this.options.message&&(this.send(this.options.message),this.options.message=void 0)},onError:function(a){this.log.debug("error",a),this._dispatch("error",!0,a),this.options.showDialogOnError===!0&&Tundra.ui.openModalDialog({heading:"Restricted Network",html:"<div>Check your firewall settings or contact your network administrator.<div></div>",icon:"warning",iconColor:"rgb(207, 190, 16)"})},onClosed:function(a){this.log.debug("disconnected"),this._dispatch("disconnected",!0,a)},onMessage:function(a){this.log.debug("message",a),this._dispatch("message",!0,a),this.options.disconnectOnFirstMessage===!0&&this.disconnect()},_dispatch:function(a,b,c){try{this.timing.resolve(a,b,c)}catch(d){this.log.error("Exception in '"+a+"' handlers:",d)}}}),ObserverPositionMessage=INetworkMessage.$extend({__init__:function(){this.$super(ObserverPositionMessage.id,"ObserverPositionMessage")},__classvars__:{id:105,name:"ObserverPositionMessage"},serialize:function(a,b){this.$super(29),this.ds.writeU16(this.id),this.ds.writeVLE(0);var c=2,d=3;this.ds.writeArithmeticEncoded2(8,c,3,d,4),this.ds.writeFloat32(a.x),this.ds.writeFloat32(a.y),this.ds.writeFloat32(a.z);var e=2*Math.acos(b.w),f=Math.sin(e/2),g={};Math.abs(f)>1e-5?(f=1/f,g.x=b.x*f,g.y=b.y*f,g.z=b.z*f):(e=0,g.x=1,g.y=0,g.z=0),e>=Math.PI&&(g.x=-g.x,g.y=-g.y,g.z=-g.z,e=2*Math.PI-e),this.ds.writeQuantizedFloat(0,Math.PI,10,e),this.ds.writeNormalizedVector3D(g.x,g.y,g.z,11,10)}}),Network=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.messageHandlers=[],this.priorityUpdatePeriod=1,this.lastObserverSendTime=0,this.lastObserverPosition=new THREE.Vector3,this.lastObserverOrientation=new THREE.Quaternion},initialize:function(){this.registerMessageHandler(new TundraMessageHandler)},postInitialize:function(){Tundra.console.registerCommand("disconnect","Disconnects the active server connection",null,Tundra.client,Tundra.client.disconnect)},__classvars__:{getDefaultOptions:function(){return{debug:!1}},components:{1:"Avatar",21:"RttTarget",2:"Billboard",23:"RigidBody",5:"Script",24:"VolumeTrigger",6:"Sound",25:"DynamicComponent",7:"SoundListener",26:"Name",8:"EnvironmentLight",27:"ParticleSystem",9:"Fog",28:"Highlight",10:"Sky",29:"HoveringText",11:"Terrain",30:"TransformGizmo",12:"WaterPlane",31:"Material",13:"InputMapper",33:"ProximityTrigger",32:"SceneShadowSetup",14:"AnimationController",34:"PlanarMirror",15:"Camera",35:"WidgetCanvas",16:"Light",36:"WebView",17:"Mesh",37:"MediaPlayer",18:"OgreCompositor",38:"SkyX",19:"OgreCustomObject",39:"Hydrax",20:"Placeable",40:"LaserPointer",41:"SlideShow",52:"GraphicsViewCanvas",42:"WidgetBillboard",108:"StencilGlow",43:"PhysicsMotor"},protocolVersion:{Original:1,CustomComponents:2,HierarchicScene:3,WebClientRigidBodyMessage:4}},registerMessageHandler:function(a){return a instanceof INetworkMessageHandler?void this.messageHandlers.push(a):void this.log.error("registerMessageHandler called with a non INetworkMessageHandler object:",hadler)},send:function(a){if(Tundra.client._isWebSocketConnected()){if(!(a instanceof INetworkMessage))return void this.log.error("Cannot send message, given object is not an instance of INetworkMessage!");var b=a.getBuffer();null!==b?Tundra.client.websocket.send(b):this.log.error("Cannot send message as it's buffer is null! Are you sure it's an outgoing message and serialize() has been called?"),a=null}},receive:function(a){for(var b=new DataDeserializer(a,0),c=b.readU16(),d=0;d<this.messageHandlers.length;d++)if(this.messageHandlers[d].canHandle(c))return void this.messageHandlers[d].handle(c,b);var e=new INetworkMessage(c);this.log.warn("Received an unhandled network message",e.name,e.id)},updateObserver:function(a){if(null!=Tundra.client.websocket&&(0==this.lastObserverSendTime||a-this.lastObserverSendTime>=1e3*this.priorityUpdatePeriod)){var b=Tundra.scene.entityById(Tundra.client.observerEntityId);if(null!=b&&null!=b.placeable){var c=b.placeable.worldPosition(),d=b.placeable.worldOrientation();if(0==this.lastObserverSendTime||!this.lastObserverPosition.equals(c)||!this.lastObserverOrientation.equals(d)){this.lastObserverPosition.copy(c),this.lastObserverOrientation.copy(d);var e=new ObserverPositionMessage;e.serialize(c,d),this.send(e),this.lastObserverSendTime=a}}}}}),EventSubscription=Class.$extend({__init__:function(a,b,c){this.channel=a,this.id=b,this.priority=c},reset:function(){Tundra.events.unsubscribe(this)},isActive:function(){return void 0!==this.id}}),EventAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.signals={},this.debugging=!1},send:function(a){var b="string"==typeof a?a:a.channel;if("string"!=typeof b)return this.log.error("send: First parameter must be a channel name or a EventSubscription object:",b),!1;var c=this.signals[b];if(void 0===c||!c.hasActiveBindings())return!1;if(this._args=[],arguments.length>1)for(var d=1;d<arguments.length;d++)this._args.push(arguments[d]);return c.dispatch.apply(c,this._args),!c._shouldPropagate},_args:[],subscribe:function(a,b,c,d){"function"==typeof b&&"function"!=typeof c&&("number"==typeof c&&"number"!=typeof d&&(d=c),c=b,b=void 0),d="number"==typeof d?d:0;var e=this._getOrCreateSignal(a);return e.subscribe(c,b,d)},_getOrCreateSignal:function(a){var b=this.signals[a];return void 0!==b?b:this._createSignal(a)},_createSignal:function(a){var b=new signals.Signal;return b.tundra={subIndex:0,channel:a,debugging:this.debugging},b.subscribe=function(a,b,c){var d=++this.tundra.subIndex,e=new EventSubscription(this.tundra.channel,d),f=this.add(a,b,c);return f.tundra={id:d,subscription:e},this.tundra.debugging===!0&&console.debug("subscribed  ",f.tundra.subscription.id,this.tundra.channel),e},b.unsubscribe=function(a){for(var b=this._bindings.length-1;b>=0;b--){var c=this._bindings[b];if(c.tundra.id===a)return c.tundra.subscription instanceof EventSubscription&&(this.tundra.debugging===!0&&console.debug("unsubscribed",c.tundra.subscription.id,this.tundra.channel),c.tundra.subscription.id=void 0),c.tundra={},c._destroy(),c.active=!1,this._bindings.splice(b,1),!0}return!1},b.aboutToDispose=function(){for(var a=this._bindings.length-1;a>=0;a--){var b=this._bindings[a];b.tundra.subscription instanceof EventSubscription&&(this.tundra.debugging===!0&&console.debug("unsubscribed ALL",b.tundra.subscription.id,this.tundra.channel),b.tundra.subscription.id=void 0),b.tundra={}}},b.numBindings=function(){return this._bindings.length},b.hasActiveBindings=function(){for(var a=this._bindings.length-1;a>=0;a--)if(this._bindings[a].active===!0)return!0;return!1},b.numActiveBindings=function(){for(var a=0,b=this._bindings.length-1;b>=0;b--)this._bindings[b].active===!0&&a++;return a},b.numSubscribtions=function(){for(var a=0,b=this._bindings.length-1;b>=0;b--){var c=this._bindings[b];c.tundra.subscription instanceof EventSubscription&&a++}return a},b.hasActiveSubscribtions=function(){for(var a=this._bindings.length-1;a>=0;a--){var b=this._bindings[a];if(b.tundra.subscription instanceof EventSubscription&&"number"==typeof b.tundra.subscription.id)return!0}return!1},b.numActiveSubscribtions=function(){for(var a=0,b=this._bindings.length-1;b>=0;b--){var c=this._bindings[b];c.tundra.subscription instanceof EventSubscription&&"number"==typeof c.tundra.subscription.id&&a++}return a},this.signals[a]=b,b},unsubscribe:function(a,b){var c=a,d=b;if(a instanceof EventSubscription&&(c=a.channel,d=a.id),"string"!=typeof c||"number"!=typeof d)return!1;var e=this.signals[c];if(void 0===e)return!1;var f=e.unsubscribe(d);return f&&!e.hasActiveBindings()&&(this.debugging===!0&&console.debug("disposing empty channel",e.tundra.channel),e.dispose(),e=void 0,delete this.signals[c]),f&&a instanceof EventSubscription&&(a.id=void 0),f},remove:function(a){var b=this.signals[a];return void 0!==b&&(b.aboutToDispose(),b.dispose(),b=void 0,delete this.signals[a],!0)},dumpState:function(){var a=0;for(var b in this.signals){var c=this.signals[b];a+=c.numActiveSubscribtions(),console.debug({bindings:c.numBindings(),active_b:c.numActiveBindings(),subs:c.numSubscribtions(),active_s:c.numActiveSubscribtions()},b),c.numBindings()===c.numActiveBindings()&&c.numSubscribtions()===c.numActiveSubscribtions()||console.warn("Number of listeners do not match up. EventAPI internals might have a bug?")}console.debug("Total signals",Object.keys(this.signals).length,"Total subscriptions",a)}}),EC_Sound=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"soundRef","",Attribute.AssetReference,"Sound ref"),this.declareAttribute(1,"soundInnerRadius",0,Attribute.Real,"Sound radius inner"),this.declareAttribute(2,"soundOuterRadius",20,Attribute.Real,"Sound radius outer"),this.declareAttribute(3,"soundGain",1,Attribute.Real,"Sound gain"),this.declareAttribute(4,"playOnLoad",!1,Attribute.Bool,"Play on load"),this.declareAttribute(5,"loopSound",!1,Attribute.Bool,"Loop sound"),this.declareAttribute(6,"spatial",!0,Attribute.Bool,"Spatial")},__classvars__:{TypeId:6,TypeName:"Sound"}}),EC_Sound_WebAudio=EC_Sound.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d)},__classvars__:{Implementation:"webaudio"},update:function(){this.cache={_soundGainNode:Tundra.audio.context.createGain(),_position:new THREE.Vector3,_pannerNode:Tundra.audio.context.createPanner(),_placeable:void 0},this.cache._soundGainNode.gain.value=this.soundGain,this.cache._pannerNode.setPosition(this.cache._position.x,this.cache._position.y,this.cache._position.z),this.cache._pannerNode.connect(Tundra.audio.masterGainNode),this.checkAndUpdatePlaceable(),this.checkAndUpdateSoundRef(),this.parentEntity.onComponentCreated(this,this.onComponentCreated),this.parentEntity.onComponentRemoved(this,this.onComponentRemoved)},reset:function(){this.disposeSource()},disposeSource:function(){this.cache._element&&this.cache._element.pause(),this.cache._source&&this.cache._source.disconnect(),this.cache._element=void 0,this.cache._source=void 0},play:function(){this.cache._element&&this.cache._element.play()},stop:function(){this.cache._element&&(this.cache._element.pause(),this.cache._element.currentTime=0)},pause:function(){this.cache._element&&this.cache._element.pause()},checkAndUpdateSoundRef:function(){if(this.soundRef){this.disposeSource();var a=new Audio(this.soundRef);a.crossOrigin="anonymous",this.cache._source&&this.cache._source.disconnect(),this.cache._element=a,this.cache._source=Tundra.audio.context.createMediaElementSource(a),this.playOnLoad&&(a.autoplay=!0),a.loop=this.loopSound,this._reconnectSourceNode()}else this.disposeSource()},_reconnectSourceNode:function(){this.cache._source&&(this.cache._source.disconnect(),this.cache._soundGainNode.disconnect(),this.cache._source.connect(this.cache._soundGainNode),this.cache._soundGainNode.connect(Tundra.audio.ambientNode),this.spatial?this.spatial&&this.cache._pannerNode&&this.cache._placeable?this.cache._soundGainNode.connect(this.cache._pannerNode):this.cache._source&&this.cache._source.disconnect():this.cache._soundGainNode.connect(Tundra.audio.masterGainNode))},_updatePosition:function(){this.cache._pannerNode&&this.cache._placeable&&(this.parentEntity.placeable.worldPosition(this.cache._position),this.cache._pannerNode.setPosition(this.cache._position.x,this.cache._position.y,this.cache._position.z))},checkAndUpdatePlaceable:function(){this.cache._placeable||this.hasParentEntity()&&this.parentEntity.placeable&&(this.cache._placeable=this.parentEntity.placeable,this._updatePosition(),this.parentEntity.placeable.onAttributeChanged(this,this.onPlaceableAttributeChanged))},onComponentCreated:function(a,b){20==b.typeId&&(this.checkAndUpdatePlaceable(),this._reconnectSourceNode())},onComponentRemoved:function(a,b){20==b.typeId&&this.cache._placeable&&this.cache._placeable.id===b.id&&(this.cache._placeable=void 0,this._reconnectSourceNode())},onPlaceableAttributeChanged:function(a,b,c,d,e){0==c&&this._updatePosition()},changeGain:function(){this.cache._soundGainNode&&(this.cache._soundGainNode.gain.value=this.soundGain)},changeLoopSound:function(){this.cache._element&&(this.cache._element.loop=this.loopSound)},attributeChanged:function(a,b,c){switch(a){case 0:this.checkAndUpdateSoundRef();break;case 3:this.changeGain();break;case 4:c&&this.play();break;case 5:this.changeLoopSound();break;case 6:this._reconnectSourceNode()}}}),EC_SoundListener=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"active",!1,Attribute.Bool,"Active")},__classvars__:{TypeId:7,TypeName:"SoundListener"}}),EC_SoundListener_WebAudio=EC_SoundListener.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this._positionCache=new THREE.Vector3,this._orientationCache=new THREE.Quaternion,this._frontVector=new THREE.Vector3(0,0,-1),this._frontDir=this._frontVector.clone(),this._upVector=new THREE.Vector3(0,1,0),this._upDir=this._upVector.clone()},__classvars__:{Implementation:"webaudio"},update:function(){this.updater=Tundra.frame.onUpdate(this,this.onUpdate)},onUpdate:function(a){this.hasParentEntity()&&null!=this.parentEntity.placeable&&this.active&&(this.parentEntity.placeable.worldPosition(this._positionCache),this.parentEntity.placeable.worldOrientation(this._orientationCache),this._frontDir.copy(this._frontVector),this._frontDir.applyQuaternion(this._orientationCache),this._frontDir.normalize(),this._upDir.copy(this._upVector),this._upDir.applyQuaternion(this._orientationCache),this._upDir.normalize(),Tundra.audio.context.listener.setPosition(this._positionCache.x,this._positionCache.y,this._positionCache.z),Tundra.audio.context.listener.setOrientation(this._frontDir.x,this._frontDir.y,this._frontDir.z,this._upDir.x,this._upDir.y,this._upDir.z))},setActive:function(){Tundra.audio.setActiveSoundListener(this)},reset:function(){Tundra.audio.activeSoundListenerEntity().id==this.parentEntity.id&&Tundra.audio.activeSoundListener.id==this.id&&Tundra.audio.setActiveSoundListener(null)}}),AudioAPI=ITundraAPI.$extend({__init__:function(a,b){this.$super(a,b),this.activeSoundListener=null,Object.defineProperties(this,{masterGain:{get:function(){return this.options.masterGain},set:function(a){this.options.masterGain=a,this.updateActiveNode()}},followActiveCamera:{get:function(){return this.options.followActiveCamera},set:function(a){this.options.followActiveCamera=a,this.onActiveCameraChanged(Tundra.renderer.activeCameraComponent)}}})},__classvars__:{getDefaultOptions:function(){return{followActiveCamera:!0,masterGain:1}}},registerComponents:function(){Tundra.scene.registerComponent(EC_Sound_WebAudio),
Tundra.scene.registerComponent(EC_SoundListener_WebAudio)},registerAssetFactories:function(){},initialize:function(){this.context=new(window.AudioContext||window.webkitAudioContext),this.masterGainNode=this.context.createGain(),this.masterGainNode.gain.value=0,this.masterGainNode.connect(this.context.destination),this.ambientNode=this.context.createGain(),this.ambientNode.gain.value=this.options.masterGain,this.ambientNode.connect(this.context.destination),this.registerComponents()},setActiveSoundListener:function(a){this.activeSoundListener&&(this.activeSoundListener.active=!1),this.activeSoundListener=a,this.activeSoundListener&&(this.activeSoundListener.active=!0),this.updateActiveNode()},activeSoundListenerEntity:function(){return null!=this.activeSoundListener?this.activeSoundListener.parentEntity:null},postInitialize:function(){Tundra.renderer.onActiveCameraChanged(this,this.onActiveCameraChanged),this.onActiveCameraChanged(Tundra.renderer.activeCameraComponent)},onActiveCameraChanged:function(a){if(!a)return void this.setActiveSoundListener(null);if(this.options.followActiveCamera){var b=a.parentEntity.getOrCreateComponent("SoundListener");b.setActive()}},updateActiveNode:function(){this.activeSoundListener?(this.masterGainNode.gain.value=this.masterGain,this.ambientNode.gain.value=0):(this.masterGainNode.gain.value=0,this.ambientNode.gain.value=this.masterGain)}}),ConfigAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.supported=void 0!==window.localStorage,this.supported||this.log.warn("Browser does not support 'localStorage', disabling functionality.")},readSection:function(a){if("string"!=typeof a||""===a.trim())return this.log.error("readSection: Invalid 'section':",a),{};if(!this.supported)return{};var b=localStorage.getItem("webtundra."+a);if("string"==typeof b)try{return JSON.parse(b)}catch(c){this.log.error("readSection: failed to parse object from section '"+a+"' value '"+b+"': "+c),c.stack&&console.error(c.stack)}return{}},read:function(a,b,c){if("string"!=typeof b||""===b.trim())return this.log.error("read: Invalid 'key':",b),c;if(!this.supported)return c;var d=this.readSection(a);return"object"!=typeof d?c:void 0!==d[b]?d[b]:c},writeSection:function(a,b){if("string"!=typeof a||""===a.trim())return this.log.error("writeSection: Invalid 'section':",a),!1;if(null===b||"object"!=typeof b||Array.isArray(b))return this.log.error("writeSection: Invalid parameter 'obj' not type of 'object' instead is '"+(Array.isArray(b)?"Array":typeof b)+"'",b),null!==b&&void 0!==b||this.log.error("You used undefined or null, if you wish to reset/remove the section pass in a empty object literal '{}' instead"),!1;if(!this.supported)return!1;try{return localStorage.setItem("webtundra."+a,JSON.stringify(b)),!0}catch(c){this.log.error("writeSection: "+c),c.stack&&console.error(c.stack)}return!1},write:function(a,b,c){if("string"!=typeof b||""===b.trim())return this.log.error("write: Invalid 'key':",b),!1;if(!this.supported)return!1;var d=this.readSection(a);return void 0!==c?d[b]=c:delete d[b],this.writeSection(a,d)},valueExists:function(a,b){if("string"!=typeof b||""===b.trim())return this.log.error("valueExists: Invalid 'key':",b),!1;if(!this.supported)return!1;var c=this.readSection(a);return void 0!==c[b]}}),ConsoleAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.commands=[]},initialize:function(){Tundra.client.onLogInfo(this,this.logInfo),Tundra.client.onLogWarning(this,this.logWarning),Tundra.client.onLogError(this,this.logError),this.registerCommand("help","Prints all available console commands",null,this,this.help)},help:function(){if(!(this.commands.length<=0)){for(var a=0,b=0;b<this.commands.length;++b)this.commands[b].name.length>a&&(a=this.commands[b].name.length);var c="";for(b=0;b<this.commands.length;++b){var d=this.commands[b];if(void 0!==d.name&&null!==d.name){for(var e=d.name;e.length<a;)e+=" ";if(c+="  "+e+(""!==d.description?" - "+d.description:"")+"<br/>",""!==d.parameterDescription){for(var f="";f.length<a;)f+=" ";c+=f+"     <span style='color:black;'>"+d.parameterDescription+"</span><br/>"}}}var g=Tundra.client;if(g.ui.console){var h=g.ui.console.html();g.ui.console.html(h+"<span style='color:brown;'>"+c+"</span>"),g.ui.console.is(":visible")&&g.ui.console.animate({scrollTop:g.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}}},commandSuggestion:function(a){for(var b=a.toLowerCase(),c=0;c<this.commands.length;++c)if(this.commands[c].name.toLowerCase()===b)return null;for(c=0;c<this.commands.length;++c)if(0===this.commands[c].name.toLowerCase().indexOf(b))return this.commands[c].name;return null},getCommandData:function(a){for(var b=a.toLowerCase(),c=0;c<this.commands.length;++c)if(this.commands[c].name.toLowerCase()===b)return this.commands[c];return null},registerCommand:function(a,b,c,d,e){if("string"!=typeof a)return Tundra.client.logError("[ConsoleAPI]: registerCommand 'name' parameter must be a non empty string!",!0),null;var f=this.getCommandData(a);if(f)return this.subscribeCommand(a,d,e);void 0!==b&&null!==b||(b=""),void 0!==c&&null!==c||(c="");var g=this.commands.length;return this.commands.push({channel:"ConsoleAPI."+g,index:g,name:a,description:b,parameterDescription:c}),this.subscribeCommand(a,d,e)},subscribeCommand:function(a,b,c){if(void 0===c||null===c)return null;var d=this.getCommandData(a);return d?Tundra.events.subscribe(d.channel,b,c):null},executeCommandRaw:function(a){a=CoreStringUtils.trim(a);var b=a,c="";a.indexOf("(")!=-1&&(b=CoreStringUtils.trim(a.substring(0,a.indexOf("("))),c=CoreStringUtils.trim(a.substring(a.indexOf("(")+1))),""===c&&a.indexOf(" ")!=-1&&(b=CoreStringUtils.trim(a.substring(0,a.indexOf(" "))),c=CoreStringUtils.trim(a.substring(a.indexOf(" ")+1))),c.indexOf(")")!=-1&&(c=c.substring(0,c.indexOf(")"))),b=CoreStringUtils.trim(b),c=""!==c?CoreStringUtils.trim(c).split(","):[];var d=this.executeCommand(b,c);return d||Tundra.client.logError("Could not find console command '"+b+"'"),d},executeCommand:function(a,b){var c=this.getCommandData(a);return c&&Tundra.events.send(c.channel,b),null!==c},logInfo:function(a){var b=Tundra.client;if(b.ui&&b.ui.console){var c=b.ui.console.html();b.ui.console.html(c+a+"<br />"),b.ui.console.is(":visible")&&b.ui.console.animate({scrollTop:b.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}},logWarning:function(a){var b=Tundra.client;if(b.ui&&b.ui.console){var c=b.ui.console.html();b.ui.console.html(c+"<span style='color: rgb(119,101,0);'>"+a+"</span><br />"),b.ui.console.is(":visible")&&b.ui.console.animate({scrollTop:b.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}},logError:function(a){var b=Tundra.client;if(b.ui&&b.ui.console){var c=b.ui.console.html();b.ui.console.html(c+"<span style='color: red;'>"+a+"</span><br />"),b.ui.console.is(":visible")&&b.ui.console.animate({scrollTop:b.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}}}),Scene=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.entities=[],this.id=1,this.entityIdGenerator=new UniqueIdGenerator},postInitialize:function(){for(var a=Scene.registeredComponentsList(),b=0;b<a.length;b++)"string"!=typeof a[b].Implementation&&this._logComponentRegistration(a[b],!0);for(var b=0;b<a.length;b++)"string"==typeof a[b].Implementation&&this._logComponentRegistration(a[b],!0);Tundra.console.registerCommand("dumpScene","Dumps the scene to browsers developer console","(string) Optional entity name if you want to print a single entity",this,this.onDumpScene)},reset:function(){this.id=1,this.removeAllEntities(),Tundra.events.remove("Scene.EntityCreated"),Tundra.events.remove("Scene.EntityRemoved"),Tundra.events.remove("Scene.ComponentCreated"),Tundra.events.remove("Scene.ComponentRemoved"),Tundra.events.remove("Scene.EntityAction"),Tundra.events.send("Scene.Reset",this)},__classvars__:{registeredComponents:{},ClearRegisteredComponents:function(){this.registeredComponents={}},registeredComponentsList:function(){for(var a=[],b=Object.keys(Scene.registeredComponents),c=0;c<b.length;c++){var d=b[c];a.push(Scene.registeredComponents[d])}return a},registeredComponent:function(a){if("string"==typeof a)for(var b=IComponent.ensureComponentNameWithoutPrefix(a),c=Object.keys(Scene.registeredComponents),d=0;d<c.length;d++){var e=c[d];if(Scene.registeredComponents[e].TypeName===b){a=e;break}}return Scene.registeredComponents[a]},registerComponent:function(a){return a.prototype instanceof IComponent?"number"!=typeof a.TypeId?(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. 'TypeId' is not a number."),!1):a.TypeId<=0?(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. 'TypeId' number is invalid",a.TypeId),!1):"string"!=typeof a.TypeName?(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. 'TypeName' is not a string."),!1):""===a.TypeName?(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. 'TypeName' string is invalid",a.TypeName),!1):void 0!==this.registeredComponents[a.TypeId]?(TundraLogging.getLogger("Scene").error("Component with type id",a.TypeId,"("+this.registeredComponents[a.TypeId].TypeName+") already registered!"),!1):(a.TypeName=IComponent.ensureComponentNameWithoutPrefix(a.TypeName),this.registeredComponents[a.TypeId]=a,this._registerComponentPropertyName(a),null!=Tundra.scene&&Tundra.scene._logComponentRegistration(a),!0):(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. First parameter must be a IComponent."),!1)},registered:function(a){return a.prototype instanceof IComponent?"number"!=typeof a.TypeId?(TundraLogging.getLogger("Scene").error("registered: Invalid component class. 'TypeId' is not a number."),!1):a.TypeId<=0?(TundraLogging.getLogger("Scene").error("registered: Invalid component class. 'TypeId' number is invalid",a.TypeId),!1):void 0!==this.registeredComponents[a.TypeId]:(TundraLogging.getLogger("Scene").error("registered: Invalid component class. First parameter must be a IComponent."),!1)},_registerComponentPropertyName:function(a){for(var b=IComponent.propertyName(a.TypeName),c=!1,d=0;d<Scene.componentPropertyNames.length&&!(c=Scene.componentPropertyNames[d]===b);d++);c||Scene.componentPropertyNames.push(b)},componentPropertyNames:function(){var a=[];for(var b in Network.components)a.push(IComponent.propertyName(Network.components[b]));return a}()},registerComponent:function(a){return Scene.registerComponent(a)},registered:function(a){return Scene.registered(a)},serializeToObject:function(a){a=a||!1;var b={};b.id=this.id,b.entities=[];for(var c=0;c<this.entities.length;++c){var d=this.entities[c].temporary;(!d||d&&a)&&b.entities.push(this.entities[c].serializeToObject(a))}return b},serializeToXml:function(a){a=a||!1;for(var b=document.createElement("scene"),c=0;c<this.entities.length;++c){var d=this.entities[c].temporary;(!d||d&&a)&&b.appendChild(this.entities[c].serializeToXml(a))}return b},deserializeFromObject:function(a,b){b=b||AttributeChange.Default;for(var c=[],d=0;d<a.entities.length;++d){var e=a.entities[d],f=e.sync,g=e.temp||!1,h=this.createEntity(0,null,b,f,f,!0);h.temporary=g,h.deserializeFromObject(e,b),c.push(h)}return c},deserializeFromXml:function(a,b){if(a.getElementsByTagName("parsererror").length>0)return void Tundra.scene.log.error("[deserializeFromXml]: Error parsing a scene from TXML: the document is not a valid TXML format!");for(var c=a.firstChild;c&&"scene"!=c.nodeName;)c=c.nextSibling;return this.createContentFromXml(c,b)},createContentFromXml:function(a,b){b=b||AttributeChange.Default;var c=[];if("scene"!=a.nodeName)return Tundra.scene.log.error("[createContentFromXml]: The given element is not a <scene> element, instead it is <"+a.nodeName+">"),c;for(var d=0;d<a.childNodes.length;++d){var e=a.childNodes[d];if("entity"==e.nodeName){var f="true"==e.getAttribute("sync"),g="true"==e.getAttribute("temp")||!1,h=this.createEntity(0,null,b,f,f,!0);h.temporary=g,h.deserializeFromXml(e,b),c.push(h)}}return c},toString:function(){return"id="+this.id+" entities="+this.entities.length},_logComponentRegistration:function(a,b){if(null!=Tundra.scene&&(this.staging.postInitialized||b)){for(var c=void 0!==a.Implementation?"["+a.Implementation+"] ":"",d=a.TypeId.toString();d.length<3;)d=" "+d;Tundra.scene.log.debug("Registered component "+c+d,a.TypeName)}},onDumpScene:function(a){if(0===this.entities.length)return void this.log.info("Current scene has no entities");this.log.info("");for(var b=!1,c=a[0],d=0;d<this.entities.length;d++){var e=this.entities[d],f=void 0===c||c===e.name;if(f){b=!0,this.log.info(e.id+" "+e.name);for(var g=0;g<e.components.length;g++){var h=e.components[g];if(this.log.info("  "+h.id+" "+h.typeName),h.isDynamic())for(var i in h.attributeIndexes){var j=h.getAttributeByIndex(i);void 0!==j&&null!==j&&this.log.info("    "+j.toString())}else for(var k=0;k<h.attributeCount;k++)this.log.info("    "+h.getAttributeByIndex(k).toString())}}}b||void 0===c||this.log.error("Failed to find entity '"+c+"'")},_onEntityNameChanged:function(a,b,c){for(var d=this.entities.length-1;d>=0;d--){var e=this.entities[d],f=null!=e.placeable?e.placeable.parentRef:void 0;void 0!==f&&null!==f&&(""!==c&&""!==f&&f===c&&e.placeable.removeParent(),""!==b&&f===b&&e.placeable.checkParent())}},onReset:function(a,b){return Tundra.events.subscribe("Scene.Reset",a,b)},onEntityCreated:function(a,b){return Tundra.events.subscribe("Scene.EntityCreated",a,b)},onEntityRemoved:function(a,b){return Tundra.events.subscribe("Scene.EntityRemoved",a,b)},onComponentCreated:function(a,b){return Tundra.events.subscribe("Scene.ComponentCreated",a,b)},onComponentRemoved:function(a,b){return Tundra.events.subscribe("Scene.ComponentRemoved",a,b)},onAttributeChanged:function(a,b){return Tundra.events.subscribe("Scene.AttributeChanged",a,b)},onEntityAction:function(a,b){return Tundra.events.subscribe("Scene.EntityAction",a,b)},_publishEntityCreated:function(a){return null==a?void console.log("ERROR: Scene trying to publish EntityCreated with null entity!"):void Tundra.events.send("Scene.EntityCreated",a)},_publishEntityRemoved:function(a,b){if(null==a)return void console.log("ERROR: Scene trying to publish EntityRemoved with null entity!");void 0!==b&&null!==b&&b!==AttributeChange.Default||(b=a.local?AttributeChange.LocalOnly:AttributeChange.Replicate);try{b!==AttributeChange.Disconnected&&Tundra.events.send("Scene.EntityRemoved",a)}catch(c){this.log.error("Scene.EntityRemoved handler exception:",c.stack||c)}var d=a.id.toString();Tundra.events.remove("Scene.ParentChanged."+d),Tundra.events.remove("Scene.ComponentCreated."+d),Tundra.events.remove("Scene.ComponentRemoved."+d),Tundra.events.remove("Scene.AttributeChanged."+d),Tundra.events.remove("Scene.EntityAction."+d)},_publishParentChanged:function(a,b,c){void 0!==c&&null!==c&&c!==AttributeChange.Default||(c=b?b.local?AttributeChange.LocalOnly:AttributeChange.Replicate:a?a.local?AttributeChange.LocalOnly:AttributeChange.Replicate:AttributeChange.LocalOnly),c!==AttributeChange.Disconnected&&(b&&(Tundra.events.send("Entity.Parent.Changed."+b.id.toString(),b,a,c),Tundra.events.send("Scene.ParentChanged."+b.id.toString(),b,a,c)),a&&Tundra.events.send("Entity.Children.Changed."+a.id.toString(),a,b,c))},_publishComponentCreated:function(a,b){return null==a?void console.log("ERROR: Scene trying to publish ComponentCreated with null entity!"):null==b?void console.log("ERROR: Scene trying to publish ComponentCreated with null component!"):(Tundra.events.send("Scene.ComponentCreated",a,b),void Tundra.events.send("Scene.ComponentCreated."+a.id.toString(),a,b))},_publishComponentRemoved:function(a,b){return null==a?void console.log("ERROR: Scene trying to publish ComponentRemoved with null entity!"):null==b?void console.log("ERROR: Scene trying to publish ComponentRemoved with null component!"):(Tundra.events.send("Scene.ComponentRemoved",a,b),void Tundra.events.send("Scene.ComponentRemoved."+a.id.toString(),a,b))},_publishEntityAction:function(a){return null==a?void console.log("ERROR: Scene trying to publish EntityAction with null entity action object!"):null==a.entity?void console.log("ERROR: Scene trying to publish EntityAction with null entity in the action object!"):(Tundra.events.send("Scene.EntityAction",a),void Tundra.events.send("Scene.EntityAction."+a.entity.id.toString(),a))},_publishAttributeChanged:function(a,b){if(null==a)return void console.log("ERROR: Scene trying to publish AttributeChanged with null entity!");if(null==b.owner)return void console.log("ERROR: Scene trying to publish AttributeChanged with null component!");var c=a.id.toString(),d=b.owner.id.toString(),e=b.index,f=b.getClone();Tundra.events.send("Scene.AttributeChanged",a,b.owner,b.index,b.name,f),Tundra.events.send("Scene.AttributeChanged."+c,a,b.owner,b.index,b.name,f),Tundra.events.send("Scene.AttributeChanged."+c+"."+d,a,b.owner,b.index,b.name,f),Tundra.events.send("Scene.AttributeChanged."+c+"."+d+"."+e,f)},_initComponentProperties:function(a){for(var b=Scene.componentPropertyNames,c=b.length-1;c>=0;c--){var d=b[c];if("name"!==d){a[d]=null;var e=d.toLowerCase();d!==e&&(a[e]=null)}}},nextFreeIdLocal:function(){return this.entityIdGenerator.allocateLocal()},nextFreeId:function(){return this.entityIdGenerator.allocateReplicated()},update:function(a){},createLocalEntity:function(a,b,c){return void 0!==a&&null!==a||(a=[]),void 0!==b&&null!==b||(b=AttributeChange.LocalOnly),void 0!==c&&null!==c&&"boolean"==typeof c||(c=!1),this.createEntity(this.nextFreeIdLocal(),a,b,!1,c)},createEntity:function(a,b,c,d,e,f){if("number"!=typeof a&&(a=0),void 0!==b&&null!==b||(b=[]),void 0!==c&&null!==c||(c=AttributeChange.Default),"number"!=typeof c&&(this.log.warn("createEntity called with non AttributeChange.Type change mode, defaulting to AttributeChange.Default."),c=AttributeChange.Default),c!=AttributeChange.LocalOnly&&(c=AttributeChange.LocalOnly),"boolean"!=typeof d&&(d=!0),"boolean"!=typeof e&&(e="boolean"!=typeof d||d),a=0!==a?a:d?this.nextFreeId():this.nextFreeIdLocal(),this.entityById(a))return this.log.error("Entity id "+a+" already exists in scene, can not create"),null;var g=new Entity;g.replicated=d,g.local=!g.replicated,g.setId(a),this._initComponentProperties(g),this.addEntity(g,f!==!1&&0===b.length);for(var h=0;h<b.length;++h){var i=IComponent.ensureComponentNameWithoutPrefix(b[h]);g.createComponent(i,null,e?AttributeChange.Replicate:AttributeChange.LocalOnly)}return b.length>0&&g.update(),f!==!1&&this._publishEntityCreated(g),g},addEntity:function(a,b){return this.entities.push(a),a.setParentScene(this),a.update(),b!==!1&&this._publishEntityCreated(a),!0},remove:function(a,b){return this.removeEntity(a,b)},removeEntity:function(a,b){a instanceof Entity&&(a=a.id);for(var c=this.entities.length-1;c>=0;c--)if(this.entities[c].id===a){var d=this.entities.splice(c,1)[0];if(d){this._publishEntityRemoved(d,b);try{d.reset()}catch(e){this.log.error("removeEntity: Failed to remove entity:"),this.log.error(e.stack||e)}d.clearParent(AttributeChange.Disconnected),d.removeAllChildren(b),d.id=-1,d.parentScene=null}return d=null,!0}return!1},removeAllEntities:function(){for(;this.entities.length>0;){var a=this.entities[0];try{a&&"function"==typeof a.reset&&a.reset()}catch(b){this.log.error("removeAllEntities: Failed to remove entity '"+a.toString()+"'"),this.log.error(b.stack||b)}"object"==typeof a&&(a.id=-1,a.parentScene=null),this.entities.splice(0,1)}this.entities=[]},entityById:function(a){for(var b=this.entities.length-1;b>=0;b--)if(this.entities[b].id===a)return this.entities[b];return null},entityByName:function(a){for(var b=this.entities.length-1;b>=0;b--){var c=this.entities[b],d=c.getName();if(d===a)return c}return null},findEntityWith:function(a,b){for(var c=this.entitiesWithComponent(a),d=0;d<c.length;d++)if(c[d].name===b)return c[d];return null},findEntitiesContaining:function(a,b){b===!1&&(a=a.toLowerCase());for(var c=[],d=this.entities.length-1;d>=0;d--){var e=b===!1?this.entities[d].name.toLowerCase():this.entities[d].name;""!==e&&e.indexOf(a)!==-1&&c.push(this.entities[d])}return c},entitiesWithComponent:function(a,b){var c=[];if(null==a&&null==b)return c;for(var d="string"!=typeof a,e=this.entities.length-1;e>=0;e--){var f=d?this.entities[e].componentByTypeId(a,b):this.entities[e].component(a,b);null!=f&&c.push(this.entities[e])}return c},entitiesWithComponents:function(a){var b=[];if(null==a||void 0===a.length||a.length<=0)return b;for(var c=this.entities.length-1;c>=0;c--)for(var d=this.entities[c],e=0,f=a.length;e<f;++e){var g=a[e],h="string"!=typeof g?d.componentByTypeId():d.component(a[e]);null!=h&&b.push(d)}return b},components:function(a,b){for(var c=[],d=this.entities.length-1;d>=0;d--){var e=this.entities[d],f=e.getComponents(a,b);f.length>0&&(c=c.concat(f))}return c},createComponent:function(a,b){if("string"!=typeof a&&"number"!=typeof a)return this.log.error("createComponent: 'type' must be string or a number:",a),null;var c=Scene.registeredComponent(a);if(!c&&"string"==typeof a)for(var d=IComponent.ensureComponentNameWithoutPrefix(a),e=Object.keys(Network.components),f=0,g=e.length;f<g;f++)if(Network.components[e[f]]===d){c={TypeId:parseInt(e[f])};break}return c?this.createComponentById(-1,c.TypeId,"string"==typeof b?b:""):(this.log.error("createComponent: Failed to find component implementation for type '"+a+"'"),null)},createComponentById:function(a,b,c,d){void 0===c&&(c=""),null===d&&(d=void 0);var e=null,f=Scene.registeredComponent(b);if(void 0!==f)try{e=this._createComponentImpl(f,a,c)}catch(g){return this.log.error("Failed to instantiate registered component "+f.typeName+": "+g),null!=console.error&&console.error(g),null}if(null!=e)void 0!==d&&e.deserializeFromBinary(d);else{var h=Network.components[b];if(void 0===h||null===h)return this.log.warn("Component type name could not be resolved from ID "+b),null;e=new IComponent(a,b,h,c),e.notImplemented=!0}return e},_createComponentImpl:function(a,b,c){return new a(b,a.TypeId,a.TypeName,c)},createComponentFromBinary:function(a,b){var c=b.readVLE(),d=b.readVLE(),e=b.readStringU8(),f=b.readVLE(),g=b.readBytes();b.readLimitBytes=f;var h=this.createComponentById(c,d,e,b);if(null==h)return void this.log.error("Failed to create Component with id "+c+" and type id "+d+" from binary data.");var i=f-(b.readBytes()-g);return i>0&&b.skipBytes(i),a.addComponent(h)},onTundraMessage:function(a){if(119===a.id)return void this.handleRigidBodyUpdateMessage(a.ds);var b=(a.ds.readVLE(),a.ds.readVLE());113===a.id?this.handleEditAttributesMessage(b,a.ds):110===a.id?this.handleCreateEntityMessage(b,a.ds):116===a.id?this.handleRemoveEntityMessage(b):111===a.id?this.handleCreateComponentsMessage(b,a.ds):115===a.id?this.handleRemoveComponentsMessage(b,a.ds):112===a.id?this.handleCreateAttributesMessage(b,a.ds):114===a.id&&this.handleRemoveAttributesMessage(b,a.ds)},handleEntityActionMessage:function(a){return a.entityAction.entity=this.entityById(a.entityAction.entityId),null==a.entityAction.entity?void(Tundra.network.options.debug&&this.log.error("Failed to find entity with id "+a.entityAction.entityId+" to execute Entity action on!",!0)):void this._publishEntityAction(a.entityAction)},handleCreateEntityMessage:function(a,b){var c=this.createEntity(a,[],AttributeChange.Replicate,!0,!0,!1);c.temporary=b.readBoolean(),a>this.entityIdGenerator.id&&(this.entityIdGenerator.id=a);var d=0;Tundra.client.protocolVersion>=Network.protocolVersion.HierarchicScene&&(d=b.readU32());for(var e=b.readVLE(),f=0;f<e;++f)if(!this.createComponentFromBinary(c,b)){this.log.error("Failed to create Component to a newly created Entity "+a);break}this._publishEntityCreated(c)},handleRemoveEntityMessage:function(a){this.removeEntity(a)||Tundra.network.options.debug&&this.log.error("Failed to find Entity with id "+a+" for removal!")},handleCreateComponentsMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to create Components. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=3;)if(!this.createComponentFromBinary(c,b))return void this.log.error("Failed to create Component to a existing Entity "+a)},handleRemoveComponentsMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to remove Components. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=1;){var d=b.readVLE();if(!c.removeComponent(d))return void(Tundra.network.options.debug&&this.log.error("Failed to remove Component with id "+d+" from Entity "+a))}},handleCreateAttributesMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to create Attribute. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=3;){var d=b.readVLE(),e=c.componentById(d);if(null!=e){var f=b.readU8();e.createAttributeFromBinary(f,b)}else if(Tundra.network.options.debug)return void this.log.error("Failed to create Attribute from Component with id "+d+" from Entity "+a+". Component not found!")}},handleRemoveAttributesMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to remove Attribute. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=2;){var d=b.readVLE(),e=c.componentById(d);if(null==e)return void(Tundra.network.options.debug&&this.log.error("Failed to remove Attribute with component id "+d+". Component not found!"));if(!e.isDynamic())return void this.log.error("Cannot remove Attribute from Component with id "+d+". Component is not of dynamic type.");e.removeAttribute(b.readU8())}},handleEditAttributesMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to update Attributes. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=2;){var d=b.readVLE(),e=c.componentById(d);if(null==e)return void(Tundra.network.options.debug&&this.log.error("Failed to update Attributes with component id "+d+". Component not found!"));var f=b.readVLE();if(e.notImplemented)b.skipBytes(f);else if(1===b.readBit())for(var g=0;g<e.attributeCount;++g)0!==b.readBit()&&e.deserializeAttributeFromBinary(g,b);else for(var h=b.readU8(),i=0;i<h;++i){var j=b.readU8();e.deserializeAttributeFromBinary(j,b)}}},handleRigidBodyUpdateMessage:function(a){for(;a.bitsLeft()>=9;){var b=a.readVLE(),c=this.entityById(b),d=c?c.placeable:null,e=c?c.rigidbody:null,f=d?d.attributes.transform.get():new Transform;null==c&&Tundra.client.networkDebugLogging&&this.log.error("Failed to find entity with id "+b+" to apply rigid body update to!");var g=a.readArithmeticEncoded5(8,3,4,3,3,2),h=g[0],i=g[1],j=g[2],k=g[3],l=g[4];if(1==h?f.setPosition(a.readSignedFixedPoint(11,8),a.readSignedFixedPoint(11,8),a.readSignedFixedPoint(11,8)):2==h&&f.setPosition(a.readFloat32(),a.readFloat32(),a.readFloat32()),1==i){var m=a.readNormalizedVector2D(8);f.lookAt(new THREE.Vector3(0,0,0),new THREE.Vector3(m.x,0,m.y))}else if(2==i){var n=a.readNormalizedVector3D(9,8);f.lookAt(new THREE.Vector3(0,0,0),new THREE.Vector3(n.x,n.y,n.z))}else if(3==i){var o=a.readBits(10);if(0!=o){var p=o*Math.PI/1023,q=a.readNormalizedVector3D(11,10),r=new THREE.Quaternion;r.setFromAxisAngle(new THREE.Vector3(q.x,q.y,q.z),p),f.setRotation(r)}else f.setRotation(0,0,0)}if(1==j){var s=a.readFloat32();f.setScale(s,s,s)}else 2==j&&f.setScale(a.readFloat32(),a.readFloat32(),a.readFloat32());if(1==k){var t=a.readVector3D(11,10,3,8);e&&e.attributes.linearVelocity&&e.attributes.linearVelocity.set(new THREE.Vector3(t.x,t.y,t.z))}else if(2==k){var t=a.readVector3D(11,10,10,8);e&&e.attributes.linearVelocity&&e.attributes.linearVelocity.set(new THREE.Vector3(t.x,t.y,t.z))}if(1==l){var o=a.readBits(10);if(0!=o){var q=a.readNormalizedVector3D(11,10);if(e&&e.attributes.angularVelocity){var p=o*Math.PI/1023,r=new THREE.Quaternion;r.setFromAxisAngle(new THREE.Vector3(q.x,q.y,q.z),p);var u=new THREE.Euler;u.setFromQuaternion(r,"ZYX",!1),e.attributes.angularVelocity.set(new THREE.Vector3(180*u.x/Math.PI,180*u.y/Math.PI,180*u.z/Math.PI))}}}!d||0==h&&0==i&&0==j||d.attributes.transform.set(f,AttributeChange.LocalOnly)}}}),IInputEvent=Class.$extend({__init__:function(a){return"string"!=typeof a?void console.error("IInputEvent cannot be constructed without a name. Given:",a):(this.log=TundraLogging.getLogger(a),this.name=a,this.type="",this.typeId=IInputEvent.Type.Unknown,this.x=null,this.y=null,this.z=null,this.relativeX=0,this.relativeY=0,this.relativeZ=0,this.target=null,this.targetId="",this.targetNodeName="",this.originalEvent=null,void(this._preventDefaultFunction=null))},__classvars__:{Type:{Unknown:-1}},toString:function(){return"InputEvent{ "+this.basePropertiesToString()+" }"},clear:function(){this.clearPosition()},basePropertiesToString:function(){return"typeId:"+this.typeId+" type:"+this.type+" x:"+this.x+" y:"+this.y+" relativeX:"+this.relativeX+" relativeY:"+this.relativeY+" relativeZ:"+this.relativeZ+" target:"+this.targetNodeName+(""!==this.targetId?"#"+this.targetId:"")+" originalEvent:"+(null!=this.originalEvent?"valid":"null")},suppress:function(a,b){var c=!1;return"object"==typeof this.originalEvent&&(a="boolean"!=typeof a||a,a&&("function"==typeof this._preventDefaultFunction?(this._preventDefaultFunction(),c=!0,"boolean"!=typeof preventPropagation&&(preventPropagation=!1)):"function"==typeof this.originalEvent.preventDefault&&(this.originalEvent.preventDefault(),c=!0)),preventPropagation="boolean"!=typeof preventPropagation||preventPropagation,preventPropagation&&"function"==typeof this.originalEvent.stopPropagation&&(this.originalEvent.stopPropagation(),c=!0)),c},isTarget:function(){for(var a=!1,b=0;b<arguments.length;b++){var c=arguments[b];if("string"==typeof c?a=c===this.targetId||c===this.targetNodeName:c instanceof Element?a=c.id===this.targetId&&c.localName===this.targetNodeName:"object"==typeof c&&"string"==typeof c.jquery&&"function"==typeof c.get?c.length>0?a=this.isTarget(c.get(0)):this.log.error("isTarget: Passed an empty jQuery selector:",c.selector):this.log.error("isTarget: Invalid element parameter:",c),a===!0)return a}return a},setOriginalEvent:function(a,b){if(this.originalEvent=a,"object"==typeof a.target){var c="string"==typeof a.target.id,d="string"==typeof a.target.localName;return this.targetId=c?a.target.id:"",this.targetNodeName=d?a.target.localName:"",this.target=a.target,c||d}return this.targetNodeName="",this.targetId="",this.target=null,!1},clearPosition:function(){this.setPositionAxis("x",null),this.setPositionAxis("y",null),this.setPositionAxis("z",null)},clearRelativePosition:function(){this.relativeX=this.relativeY=this.relativeZ=0},setPosition:function(a,b,c){this.setPositionAxis("x",a),this.setPositionAxis("y",b),this.setPositionAxis("z",c)},setPositionAxis:function(a,b){var c="relative"+a.toUpperCase();"number"==typeof b?(this[c]="number"==typeof this[a]?b-this[a]:0,this[a]=b):(this[c]=0,this[a]=null)}}),InputEventMouse=IInputEvent.$extend({__init__:function(){this.$super("InputEventMouse"),this.translated={x:0,y:0},this._pressPos={x:0,y:0},this.buttons={},this.prevButtons={},this.clearButtons(),Object.defineProperties(this,{leftDown:{get:function(){return this.isButtonDown(InputEventMouse.Button.Left)},set:function(a){this.setButton(InputEventMouse.Button.Left,a)}},rightDown:{get:function(){return this.isButtonDown(InputEventMouse.Button.Right)},set:function(a){this.setButton(InputEventMouse.Button.Right,a)}},middleDown:{get:function(){return this.isButtonDown(InputEventMouse.Button.Middle)},set:function(a){this.setButton(InputEventMouse.Button.Middle,a)}}})},__classvars__:{Type:{move:1,press:2,release:3,wheel:4,dblclick:5},Button:{NoButton:0,Left:1,Right:2,Middle:4,X1:8,X2:16}},toString:function(){for(var a=this.name+"{ "+this.basePropertiesToString(),b=[],c=Object.keys(InputEventMouse.Button),d=0;d<c.length;d++){var e=InputEventMouse.Button[c[d]];
this.buttons[e]===!0&&b.push(c[d])}return b.length>0&&(a+=" buttons:"+b.join("|")),a+" }"},setType:function(a){this.type=a,this.typeId="number"==typeof InputEventMouse.Type[a]?InputEventMouse.Type[a]:IInputEvent.Type.Unknown},clearButtons:function(){for(var a=Object.keys(InputEventMouse.Button),b=0;b<a.length;b++){var c=InputEventMouse.Button[a[b]];this.buttons[c]=!1,this.prevButtons[c]=!1}},setOriginalEvent:function(a,b){this.$super(a,b),"press"===b?(this._pressPos.x=a.pageX,this._pressPos.y=a.pageY):"release"===b?(this.translated.x=a.pageX-this._pressPos.x,this.translated.y=a.pageY-this._pressPos.y):this.translated.y=this.translated.x=0},readButtonsFromEvent:function(a,b){$.extend(this.prevButtons,this.buttons),Tundra.browser.isFirefox?this.setButtons(1===a.buttons,2===a.buttons,3===a.buttons):this.setButtons(1===a.which,3===a.which,2===a.which)},setButtons:function(a,b,c){this.setButton(InputEventMouse.Button.Left,a),this.setButton(InputEventMouse.Button.Right,b),this.setButton(InputEventMouse.Button.Middle,c)},setButton:function(a,b){this.buttons[a]="boolean"==typeof b&&b},isAnyButtonDown:function(){return this.buttons[InputEventMouse.Button.Left]||this.buttons[InputEventMouse.Button.Right]||this.buttons[InputEventMouse.Button.Middle]||this.buttons[InputEventMouse.Button.X1]||this.buttons[InputEventMouse.Button.X2]},wasButtonDown:function(a){return this._buttonDown(a,this.prevButtons)},wasAnyButtonDown:function(){return this.prevButtons[InputEventMouse.Button.Left]||this.prevButtons[InputEventMouse.Button.Right]||this.prevButtons[InputEventMouse.Button.Middle]||this.prevButtons[InputEventMouse.Button.X1]||this.prevButtons[InputEventMouse.Button.X2]},hasTranslated:function(a,b){return Math.abs(this.translated.x)>("number"==typeof a?a:0)||Math.abs(this.translated.y)>("number"==typeof b?b:"number"==typeof a?a:0)},isButtonDown:function(a){return this._buttonDown(a,this.buttons)},_buttonDown:function(a,b){if("string"==typeof a){var c=a.toLowerCase();if("left"===c)a=InputEventMouse.Button.Left;else if("right"===c)a=InputEventMouse.Button.Right;else if("middle"===c)a=InputEventMouse.Button.Middle;else if("x1"===c)a=InputEventMouse.Button.X1;else{if("x2"!==c)return this.log.error("is/wasButtonDown: Invalid identifier '"+a+"'"),!1;a=InputEventMouse.Button.X2}}var d=b[a];return"boolean"!=typeof d?(this.log.error("is/wasButtonDown: Invalid identifier '"+a+"'"),!1):d}}),InputAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.timing=new AsyncHelper("InputAPI",this),this.mouse=new InputEventMouse,this._resetMouseWheelDirBinded=this._resetMouseWheelDir.bind(this),this._lastMouseWheelDir=0,this.keyboard={type:"",keyCode:0,key:"",repeat:!1,pressed:{},targetId:"",targetNodeName:"",originalEvent:null,suppress:function(a,b){null!=this.originalEvent&&(void 0!==a&&a!==!0||this.originalEvent.preventDefault(),void 0!==b&&b!==!0||this.originalEvent.stopPropagation())}},this.keys={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},this.keycodes={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}},initialize:function(){this.clearOverrideCursor(),Tundra.ui.onTabFocusChanged(this,this.clearOverrideCursor.bind(this)),Tundra.input.registerMouseEvents(Tundra.client.container),this.ignoredNodeNameRules=["webrocket-","meshmoon-"],$(document).keydown(function(a){for(var b=a.target.nodeName.toLowerCase(),c=this.ignoredNodeNameRules.length-1;c>=0;c--)if(0===b.indexOf(this.ignoredNodeNameRules[c]))return;$(a.target,document.activeElement).is("input, textarea, core-input, paper-input, overlay-host")||this.onKeyPressInternal(a)}.bind(this)).keyup(function(a){for(var b=a.target.nodeName.toLowerCase(),c=this.ignoredNodeNameRules.length-1;c>=0;c--)if(0===b.indexOf(this.ignoredNodeNameRules[c]))return;$(a.target,document.activeElement).is("input, textarea, core-input, paper-input, overlay-host")||this.onKeyReleaseInternal(a)}.bind(this))},postInitialize:function(){for(var a=0;a<InputAPI.plugins.length;a++)try{InputAPI.plugins[a]._start()}catch(b){this.log.error("Plugin '"+InputAPI.plugins[a].name+"' start() threw exception: "+b)}},reset:function(){Tundra.events.remove("InputAPI.MouseEvent"),Tundra.events.remove("InputAPI.MouseMove"),Tundra.events.remove("InputAPI.MouseClick"),Tundra.events.remove("InputAPI.MousePress"),Tundra.events.remove("InputAPI.MouseRelease"),Tundra.events.remove("InputAPI.MouseWheel"),Tundra.events.remove("InputAPI.MouseDoubleClicked"),Tundra.events.remove("InputAPI.KeyEvent"),Tundra.events.remove("InputAPI.KeyPress"),Tundra.events.remove("InputAPI.KeyRelease");for(var a=0;a<InputAPI.plugins.length;a++)try{InputAPI.plugins[a]._reset()}catch(b){this.log.error("Plugin '"+InputAPI.plugins[a].name+"' reset() threw exception: "+b)}},__classvars__:{plugins:[],registerPlugin:function(a){for(var b=0;b<InputAPI.plugins.length;b++)if(InputAPI.plugins[b].name===a.name)return void this.log.error("registerPlugin() Name of the plugin needs to be unique. Name",a.name,"already registered");InputAPI.plugins.push(a)},getPlugin:function(a){for(var b=0;b<InputAPI.plugins.length;b++)if(InputAPI.plugins[b].name===a)return InputAPI.plugins[b];return null}},registerPluginEvent:function(a,b){var c="on"+a;return void 0!==this[c]?(this.log.error("[InputAPI]: Cannot register plugin event "+a+" the handler InputAPI."+c+" is already registered!"),!1):(this[c]=function(a,c){return Tundra.events.subscribe(b,a,c)},this.log.debug("Registered event",b),!0)},setOverrideCursor:function(a){Tundra.client.container&&Tundra.client.container.css("cursor",a)},getOverrideCursor:function(){var a=Tundra.client.container?Tundra.client.container.css("cursor"):"";return"string"==typeof a&&"default"!==a||(a=""),a},clearOverrideCursor:function(){this.setOverrideCursor("default")},hasEvent:function(a){return"string"==typeof a&&"function"==typeof this["on"+a]},supportsEventType:function(a){return"function"==typeof this["on"+a]},registerMouseEvents:function(a){var b=this,c=$(a);c.css({"user-select":"none"}),c.mousedown(function(a){b.onMousePressInternal(a)}),c.mouseup(function(a){b.onMouseReleaseInternal(a)}),c.mousemove(function(a){b.onMouseMoveInternal(a)}),c.mousewheel(function(a,c,d,e){b.onMouseWheelInternal(a,c,d,e)}),c.dblclick(function(a){b.onMouseDoubleClickInternal(a)}),c.bind("contextmenu",function(){return!1})},onMouseEvent:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseEvent",a,b,c)},onMouseMove:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseMove",a,b,c)},onMouseClick:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseClick",a,b,c)},onMousePress:function(a,b,c){return Tundra.events.subscribe("InputAPI.MousePress",a,b,c)},onMouseRelease:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseRelease",a,b,c)},onMouseWheel:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseWheel",a,b,c)},onMouseDoubleClicked:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseDoubleClicked",a,b,c)},onKeyEvent:function(a,b,c){return Tundra.events.subscribe("InputAPI.KeyEvent",a,b,c)},onKeyPress:function(a,b,c){return Tundra.events.subscribe("InputAPI.KeyPress",a,b,c)},onKeyRelease:function(a,b,c){return Tundra.events.subscribe("InputAPI.KeyRelease",a,b,c)},onMouseMoveInternal:function(a){this.readMouseEvent("move",a),0===this.mouse.relativeX&&0===this.mouse.relativeY||Tundra.events.send("InputAPI.MouseMove",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)},onMousePressInternal:function(a){this.readMouseEvent("press",a),Tundra.events.send("InputAPI.MouseClick",this.mouse)||Tundra.events.send("InputAPI.MousePress",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)},onMouseReleaseInternal:function(a){this.readMouseEvent("release",a),this.mouse.setButtons(!1,!1,!1),Tundra.events.send("InputAPI.MouseClick",this.mouse)||Tundra.events.send("InputAPI.MouseRelease",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)},_resetMouseWheelDir:function(){this._lastMouseWheelDir=0},onMouseWheelInternal:function(a,b,c,d){return 0!==typeof this._lastMouseWheelDir&&(this._lastMouseWheelDir<0&&d>0||this._lastMouseWheelDir>0&&d<0)?void(this._lastMouseWheelDir=0):(this.timing.async("reset.wheel.dir",this._resetMouseWheelDirBinded,300),this._lastMouseWheelDir=d,this.readMouseEvent("wheel",a,d),void(Tundra.events.send("InputAPI.MouseWheel",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)))},onMouseDoubleClickInternal:function(a){this.readMouseEvent("dblclick",a),Tundra.events.send("InputAPI.MouseDoubleClicked",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)},readMouseEvent:function(a,b,c){this.mouse.setOriginalEvent(b,a),this.mouse.readButtonsFromEvent(b,a),this.mouse.setPosition(b.pageX,b.pageY),"number"==typeof c&&(this.mouse.relativeZ=c),this.mouse.setType(a)},onKeyPressInternal:function(a){this.readKeyEvent(a),this.keyboard.type="press",Tundra.events.send("InputAPI.KeyPress",this.keyboard)||Tundra.events.send("InputAPI.KeyEvent",this.keyboard)},onKeyReleaseInternal:function(a){this.readKeyEvent(a),this.keyboard.type="release",Tundra.events.send("InputAPI.KeyRelease",this.keyboard)||Tundra.events.send("InputAPI.KeyEvent",this.keyboard)},readKeyEvent:function(a){this.keyboard.originalEvent=a,void 0!==a.target&&null!==a.target?(this.keyboard.targetNodeName=a.target.localName,this.keyboard.targetId=a.target.id):(this.keyboard.targetNodeName="",this.keyboard.targetId=""),this.keyboard.keyCode=a.which,this.keyboard.key=this.characterForKeyCode(a.which),this.keyboard.repeat=!1,"keydown"===a.type?this.keyboard.pressed[this.keyboard.key]===!0?this.keyboard.repeat=!0:this.keyboard.pressed[this.keyboard.key]=!0:delete this.keyboard.pressed[this.keyboard.key]},characterForKeyCode:function(a){return this.keys[a]?this.keys[a]:this.keycodes[a]?this.keycodes[a]:String.fromCharCode(a).toLowerCase()}}),UiAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.tabActive=!0,this.timing=new AsyncHelper("UiAPI",this),this.buttons=[],this.numContextMenus=0,this.createTaskbar(this.options.taskbar),this.createConsole(this.options.console),this.onWindowResizeDOM(),window.addEventListener("resize",this.onWindowResizeDOM.bind(this),!1),$(window).focus(function(){this.tabActive=!0,Tundra.events.send("UiAPI.TabFocusChanged",!0)}.bind(this)).blur(function(){this.tabActive=!1,Tundra.events.send("UiAPI.TabFocusChanged",!1)}.bind(this)),Tundra.client.onConnected(this,this.onConnected),Tundra.client.onDisconnected(this,this.onDisconnected)},__classvars__:{getDefaultOptions:function(){return{taskbar:!0,console:!0,fps:!1}}},initialize:function(){this.fps=$("<div/>",{id:"webtundra-fps"}),this.fps.css({"background-color":"transparent",position:"absolute",color:"black","font-family":"Arial","font-size":"18pt","font-weight":"bold","z-index":parseInt(null!=this.console?this.console.css("z-index"):"49")+1}),this.fps.width(60),this.fps.height(30),this.fps.fpsFrames=0,this.fps.fpsTime=0,this.fps.alwaysShow="function"==typeof require,this.fps.hide(),this.fps.cachedVisible=!1,this.addWidgetToScene(this.fps),this.onWindowResizeInternal(),Tundra.console.registerCommand("clear","Clears the console messages",null,this,this.clearConsole),Tundra.console.registerCommand("showFps","Toggles if FPS counter is shown",null,this,function(){this.fps.alwaysShow=!this.fps.alwaysShow,this.fps.alwaysShow?this.fps.cachedVisible||(this.fps.fadeIn(),this.fps.cachedVisible=!0):null==this.console||this.console.is(":visible")||(this.fps.fadeOut(),this.fps.cachedVisible=!1)})},reset:function(){for(var a=0;a<this.buttons.length;a++)this.buttons[a].remove();this.buttons=[];for(var a=0;a<this.numContextMenus;a++){var b=$("#webtundra-context-menu-"+a);null!=b&&b.remove()}this.numContextMenus=0,this.buttonDisconnect=this.addAction("Disconnect",Tundra.asset.getLocalAssetPath("img/icon-disconnect.png")),this.buttonDisconnect.click(function(a){Tundra.client.disconnect(),a.stopPropagation(),a.preventDefault()}),Tundra.usingRequireJS()&&(this.buttonConsole=this.addAction("Console",Tundra.asset.getLocalAssetPath("img/icon-console.png")),this.buttonConsole.click(function(a){this.toggleConsole(),a.preventDefault(),a.stopPropagation()}.bind(this))),this.onWindowResizeInternal()},onConnected:function(){Tundra.input.onKeyPress(this,this.onKeyPress)},onDisconnected:function(){this.console.is(":visible")&&this.toggleConsole(),this.clearConsole()},topZIndex:function(){var a=null!=this.console?this.console.css("z-index"):5;return"string"==typeof a&&"auto"!==a&&a.length>0?parseInt(a)+50:150},createTaskbar:function(a){if(null==this.taskbar){if(void 0!==a&&null!==a||(a=!0),!a)return void(this.taskbar=null);this.taskbar=$("<div/>"),this.taskbar.attr("id","webtundra-taskbar"),this.taskbar.css({position:"absolute",left:0,bottom:0,padding:0,margin:0,height:Tundra.browser.isMobile()?36:30,width:"100%",border:0,"border-top":"1px solid gray","background-color":"rgb(248,248,248)","box-shadow":"inset 0 0 7px gray, 0 0 7px gray, inset 0 0px 0px 0px gray;","user-select":"none"}),Tundra.browser.isMobile()?this.taskbar.css({"background-color":"transparent","border-top":0,"box-shadow":"none"}):Tundra.browser.isOpera?this.taskbar.css("background-image","-o-linear-gradient(rgb(248,248,248),rgb(190,190,190))"):Tundra.browser.isFirefox?this.taskbar.css({"background-image":"-moz-linear-gradient(top, rgb(248,248,248), rgb(190,190,190))","-moz-box-shadow":"inset 0 0 0px gray, 0 0 5px gray"}):(Tundra.browser.isChrome||Tundra.browser.isSafari)&&this.taskbar.css({"background-image":"-webkit-gradient(linear, left top, left bottom, color-stop(0, rgb(248,248,248)), color-stop(0.8, rgb(190,190,190)))","-webkit-box-shadow":"0 0 7px gray"}),this.add(this.taskbar)}},createConsole:function(a){null==this.console&&(void 0!==a&&null!==a||(a=!0),this.console=a?$("<div/>"):null,null!=this.console&&(this.console.attr("id","webtundra-console"),this.console.css({position:"absolute",height:0,width:"100%","white-space":"pre",margin:0,padding:0,"padding-top":5,"padding-bottom":5,border:0,overflow:"auto","font-family":"Courier New","font-size":"10pt",color:"#444","background-color":"rgba(255, 255, 255, 0.8)","z-index":100}),this.consoleInput=$("<input/>",{id:"webtundra-console-input",type:"text"}),this.consoleInput.data("data",{history:[],index:0}),this.consoleInput.css({position:"absolute",color:"#444","background-color":"rgba(221, 221, 221, 0.8)",border:1,"border-top":"1px solid gray","border-bottom":"1px solid gray","padding-left":5,"font-family":"Courier New","font-size":"10pt",height:20,width:"100%","z-index":100}),this.consoleInput.focus(function(){$(this).css("background-color","white")}).blur(function(){$(this).css("background-color","rgba(248,248,248, 0.8)"),Tundra.browser.isMobile()&&Tundra.ui.toggleConsole(!1)}).keydown(function(a){if(9==a.which){var b=Tundra.console.commandSuggestion($(this).val());return null!=b&&b!==$(this).val()&&$(this).val(b),a.preventDefault(),!1}if(38==a.which||40==a.which){var c=$(this).data("data");c.index+=38==a.which?1:-1,c.index>=c.history.length&&(c.index=c.history.length-1);var d=c.index>=0?c.history[c.index]:"";return c.index<-1&&(c.index=-1),$(this).val(d),a.preventDefault(),!1}}).keypress(function(a){if(13==a.which){var b=$(this).val();if(""==b)return;return Tundra.console.executeCommandRaw(b)&&($(this).data("data").history.unshift(b),$(this).data("data").index=-1),$(this).val(""),a.preventDefault(),!1}}).keyup(function(a){27==a.keyCode&&this.toggleConsole()}.bind(this)),this.addWidgetToScene([this.console,this.consoleInput]),this.console.hide(),this.consoleInput.hide()))},clearConsole:function(){this.console.empty()},onWindowResize:function(a,b){return Tundra.events.subscribe("UiAPI.WindowResize",a,b)},onTabFocusChanged:function(a,b){return Tundra.events.subscribe("UiAPI.TabFocusChanged",a,b)},onClearFocus:function(a,b){return Tundra.events.subscribe("UiAPI.ClearFocus",a,b)},clearFocus:function(){Tundra.events.send("UiAPI.ClearFocus")},addWidgetToScene:function(a){this.add(a)},add:function(a){for(var b=Array.isArray(a)?a:[a],c=!0,d=0;d<b.length;++d){var e=$(b[d]);if(null!=e&&void 0!=e){var f=e.css("z-index");"string"==typeof f&&""!==f&&(f=parseInt(f)),("number"!=typeof f||isNaN(f))&&(f=0),f<5&&e.css("z-index",5),Tundra.client.container.append(e)}else console.error("[UiAPI]: Invalid input widget could not be added to the scene."),c=!1}return c},addWebComponentToScene:function(a,b,c,d){null!=a&&a.indexOf("-")!=-1||console.error("[UiAPI]: Web component tag name must contain dash (-).");var e=Tundra.asset.requestAsset(b,"Text");null!=e&&e.onCompleted(null,function(b){var e=document.createElement(a);e.innerHTML=b.data,$("body").append(e),"function"==typeof c?c(e):d.call(c,e)})},addAction:function(a,b,c,d){if(null==this.taskbar)return null;var e=this.taskbar.height();null==c&&(c=32),Tundra.browser.isMobile()&&c<40&&(c=40);var f=this.buttons.length,g="taskbar-button-"+f,h=$("<div/>",{id:g,title:null!=a?a:""});return void 0!==d&&d!==!0||h.button(),h.tooltip(),Tundra.browser.isMobile()&&h.tooltip("disable"),h.height(e),h.width(c),h.css({padding:0,margin:0,width:c,"min-width":c,"max-width":c,"background-color":"transparent",border:0,"border-radius":0,"border-color":"transparent"}),Tundra.browser.isMobile()&&h.css("background-color","rgba(230, 230, 230, 0.8)"),null!=b&&""!=b&&h.css({"background-image":"url("+b+")","background-repeat":"no-repeat","background-position":"center"}),h.fadeIn(),this.taskbar.append(h),this.buttons.push(h),this.onWindowResizeInternal(),h},addContextMenu:function(a,b,c,d,e){void 0===b&&(b=!0),void 0===c&&(c=!1);var f="webtundra-context-menu-"+this.numContextMenus;this.numContextMenus++,a=$(a),a.contextMenu(f,{},{disable_native_context_menu:b,leftClick:c,showMenu:d,hideMenu:e});var g=$("#"+f);return g.css({"background-color":"#F2F2F2",border:"1px solid #999999","list-style-type":"none",margin:0,padding:0}),g},addContextMenuItems:function(a,b){b=Array.isArray(b)?b:[b];for(var c=0;c<b.length;c++){var d=b[c],e=$("<li/>"),f=$('<a href="#">'+d.name+"</a>");f.css({"font-family":"Arial","font-size":20,"background-color":"#F2F2F2",color:"#333333","text-decoration":"none",display:"block",padding:5}),f.hover(function(){$(this).css({"background-color":"rgb(150,150,150)",color:"rgb(255,255,255)"})},function(){$(this).css({"background-color":"#F2F2F2",color:"#333333"})}),f.data("itemName",d.name),f.on("click",d.callback),e.append(f),a.append(e)}},onKeyPress:function(a){if(null!=this.console&&"1"===a.key&&"input"!==a.targetNodeName){if(this.consoleInput.is(":visible")&&this.consoleInput.is(":focus"))return;this.toggleConsole()}},toggleConsole:function(a){if(null!=this.console){var b=this.console.is(":visible");if(void 0!==a&&null!==a||(a=!b),a!=b)if(b||(this.console.height(0),this.console.show(),this.consoleInput.show()),Tundra.browser.isMobile())a?(this.console.show(),this.console.animate({scrollTop:this.console.prop("scrollHeight")},350),this.consoleInput.focus(),this.onWindowResizeInternal()):(this.console.scrollTop(0),this.console.hide(),this.consoleInput.trigger("blur"),this.consoleInput.hide(),this.onWindowResizeInternal());else{var c=this;this.console.animate({height:b?0:250},{duration:250,easing:"swing",progress:function(){c.onWindowResizeInternal()},complete:b?function(){c.console.scrollTop(0),c.console.hide(),c.consoleInput.trigger("blur"),c.consoleInput.hide(),c.onWindowResizeInternal()}:function(){c.console.animate({scrollTop:c.console.prop("scrollHeight")},350),c.consoleInput.focus(),c.onWindowResizeInternal()}})}}},width:function(){return Tundra.client.container.width()},height:function(){return Tundra.client.container.height()},refresh:function(){this.onWindowResizeDOM(),this.timing.async("refresh",this.onWindowResizeDOM)},onWindowResizeDOM:function(a){this.onWindowResizeInternal(),Tundra.container&&Tundra.events.send("UiAPI.WindowResize",Tundra.container.width(),Tundra.container.height())},onWindowResizeInternal:function(){if(null!=this.taskbar&&this.buttons.length>0){for(var a=0,b=this.buttons.length-1;b>=0;b--)a+=this.buttons[b].width();this.buttons[0].position({my:"left",at:"right-"+a,of:this.taskbar});for(var c=this.buttons[0],b=1;b<this.buttons.length;b++)this.buttons[b].position({my:"left",at:"right",of:c,collision:"fit"}),c=this.buttons[b]}null!=this.console&&(this.console.is(":visible")&&(this.console.position({my:"left top",at:"left top",of:this.console.parent()}),Tundra.browser.isMobile()&&this.console.outerHeight(this.height()-this.consoleInput.outerHeight())),this.consoleInput.is(":visible")&&this.consoleInput.position({my:"left top",at:"left bottom",of:this.console}))}}),FrameStats={ms:0,msMin:1/0,msMax:0,fps:0,fpsMin:1/0,fpsMax:0,frames:0,startTime:performance.now(),prevTime:performance.now(),_tick:function(){var a=performance.now();return this.ms=a-this.startTime,this.msMin=Math.min(this.msMin,this.ms),this.msMax=Math.max(this.msMax,this.ms),this.frames++,a>this.prevTime+250&&(this.fps=1e3*this.frames/(a-this.prevTime),this.fpsMin=Math.min(this.fpsMin,this.fps),this.fpsMax=Math.max(this.fpsMax,this.fps),this.prevTime=a,this.frames=0),a},_update:function(){this.startTime=this._tick()}},FrameProfiler=Class.$extend({__init__:function(a){this.name=a,this.scopes={},this.Scope=function(a){this.name=a,this.groupFunc=void 0,this.decimals=4,this.count=0,this.time=0,this.spent=0,this.spentTotal=0},this.Scope.prototype.group=function(a,b){return"boolean"==typeof a&&void 0===b&&(b=a,a=void 0),b="boolean"==typeof b&&b,this.groupFunc=console.group,"function"==typeof this.groupFunc&&"function"==typeof console.groupEnd?(b&&(this.groupFunc=console.groupCollapsed),this.groupFunc.call(console,a||this.name),this.count++):this.groupFunc=void 0,this.start()},this.Scope.prototype.groupEnd=function(a){return 0!==this.time&&this.report(),this.groupFunc&&console.groupEnd(),this},this.Scope.prototype.start=function(){return this.time=performance.now(),this.groupFunc||this.count++,this},this.Scope.prototype.end=function(){return this.spent=performance.now()-this.time,this.spentTotal+=this.spent,this.time=0,this},this.Scope.prototype.report=function(){if(0!==this.count){if(0!==this.time&&this.end(),0===arguments.length)console.debug("FrameProfiler."+this.name,"   count",this.count,"   msec",this.spent.toFixed(4),"/",this.spentTotal.toFixed(2));else{for(var a=["FrameProfiler."+this.name,"   count",this.count,"   msec",this.spent.toFixed(4),"/",this.spentTotal.toFixed(2),"   "],b=0;b<arguments.length;b++)a.push(arguments[b]);console.debug.apply(console,a)}return this}}},scope:function(a){"string"==typeof a&&""!==a||(a=this.name||"");var b=this.scopes[a.toLowerCase()];return void 0===b&&(b=this.scopes[a.toLowerCase()]=new this.Scope(a)),b},group:function(a,b,c){return"string"==typeof a&&""!==a||(a=this.name||""),"string"==typeof b&&(a+="."+b),this.scope(a).group(b,c)},groupEnd:function(a){return this.scope(a).groupEnd()},start:function(a){return this.scope(a).start()},end:function(a){return this.scope(a).end()},report:function(a){return this.scope(a).report()}});Tundra.Classes.FrameProfiler=FrameProfiler;var FrameAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.currentWallClockTime=0,this.currentFrameNumber=0,this.delayedExecutes=[],"number"==typeof b.limit&&(b.limit>=1&&b.limit<=59?this.limiter=new FrameLimiter(1/b.limit):this.log.warn("Option 'limit' valid range is 1-59, configured:",b.limit)),this.stats=FrameStats,this.profiler=new FrameProfiler},reset:function(){Tundra.events.remove("FrameAPI.Update"),Tundra.events.remove("FrameAPI.PostFrameUpdate")},setLimit:function(a){"number"==typeof a&&a>=1&&a<=59?this.limiter=new FrameLimiter(1/a):this.limiter=void 0},_limit:function(a){return void 0===this.limiter||this.limiter.shouldUpdate(a)},_update:function(a){this.stats._update(),this.currentWallClockTime+=a,Tundra.events.send("FrameAPI.Update",a),this._updateDelayedExecutes(a),this.currentFrameNumber++,this.currentFrameNumber<0&&(this.currentFrameNumber=0)},_updateDelayedExecutes:function(a){if(0!==this.delayedExecutes.length)for(var b=0;b<this.delayedExecutes.length;++b)if(this.delayedExecutes[b].timeLeft-=a,this.delayedExecutes[b].timeLeft<=0){var c=this.delayedExecutes[b];this.delayedExecutes.splice(b,1),b--,this._postDelayedExecute(c)}},_postDelayedExecute:function(a){try{"function"!=typeof a.callback&&"function"==typeof a.context?a.context.call(a.context,a.param):a.callback.call(null!=a.context?a.context:a.callback,a.param)}catch(b){TundraLogging.getLogger("FrameAPI").error("Failed to invoke callback for delayed execute:",b)}},_preRender:function(a){Tundra.events.send("FrameAPI.PreRender",a)},_postUpdate:function(a){Tundra.events.send("FrameAPI.PostFrameUpdate",a)},wallClockTime:function(){return this.currentWallClockTime},frameNumber:function(){return this.currentFrameNumber},onUpdate:function(a,b){return Tundra.events.subscribe("FrameAPI.Update",a,b)},onPreRender:function(a,b){return Tundra.events.subscribe("FrameAPI.PreRender",a,b)},onPostFrameUpdate:function(a,b){return Tundra.events.subscribe("FrameAPI.PostFrameUpdate",a,b)},delayedExecute:function(a,b,c,d){return"number"!=typeof a?void TundraLogging.getLogger("FrameAPI").error("delayedExecute parameter 'afterSeconds' must be a number!"):void this.delayedExecutes.push({timeLeft:a,context:b,callback:c,param:"function"!=typeof c&&void 0===d?c:d})}}),LoginMessage=INetworkMessage.$extend({__init__:function(){this.$super(LoginMessage.id,"LoginMessage")},__classvars__:{id:100,name:"LoginMessage"},serialize:function(a){this.$super(4+DataSerializer.utf8StringByteSize(a)+1),this.ds.writeU16(this.id),this.ds.writeStringU16(a),this.ds.writeVLE(Network.protocolVersion.WebClientRigidBodyMessage)}}),EC_Name=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"name","",Attribute.String,"name"),this.declareAttribute(1,"description","",Attribute.String,"description"),this.declareAttribute(2,"group","",Attribute.String)},__classvars__:{TypeId:26,TypeName:"Name"},onNameChanged:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Name.NameChanged."+this.parentEntity.id+"."+this.id,a,b):(this.log.error("Cannot subscribe onNameChanged, parent entity not set!"),null)},setName:function(a,b){if(a!==this.attributes.name.get()){var c=this.attributes.name.getClone();this.attributes.name.set(a,b),this.hasParentEntity()&&Tundra.events.send("EC_Name.NameChanged."+this.parentEntity.id+"."+this.id,a,c),this.hasParentScene()&&this.parentScene._onEntityNameChanged(this.parentEntity,a,c)}},getName:function(){return this.attributes.name.value},setDescription:function(a,b){a!==this.attributes.description.get()&&this.attributes.description.set(a,b)},getDescription:function(){return this.attributes.description.getClone()},setGroup:function(a,b){a!==this.attributes.group.get()&&this.attributes.group.set(a,b)},getGroup:function(){return this.attributes.group.getClone()},update:function(){},attributeChanged:function(a,b,c){}});Scene.registerComponent(EC_Name);var EC_Script=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.startupApplication=!1,this.scriptsRequested=!1,this.scriptAsset=null,this.declareAttribute(0,"scriptRef",[],Attribute.AssetReferenceList,"Script ref"),this.declareAttribute(1,"runOnLoad",!1,Attribute.Bool,"Run on load"),this.declareAttribute(2,"runMode",EC_Script.RunMode.Both,Attribute.Int,"Run mode"),this.declareAttribute(3,"applicationName","",Attribute.String,"Script application name"),this.declareAttribute(4,"className","",Attribute.String,"Script class name")},__classvars__:{TypeId:5,TypeName:"Script",RunMode:{Both:0,Client:1,Server:2},nativeScriptReplacements:[],registerNativeScriptReplacement:function(a,b){var c="object"==typeof a?a:void 0;void 0===c&&(c={},c[a]=b);for(var d=Object.keys(c),e=0;e<d.length;e++){var f=d[e];void 0===this.getNativeScriptReplacement(f)?this.nativeScriptReplacements.push({keyword:f,replacement:c[f]}):console.error("[EC_Script]: Native script replacement '"+f+"' already registered")}},getNativeScriptReplacement:function(a){for(var b=0;b<this.nativeScriptReplacements.length;b++)if(this.nativeScriptReplacements[b].keyword.toLowerCase()===a.toLowerCase())return this.nativeScriptReplacements[b]},localScriptReplacement:[],registerLocalScriptReplacement:function(a,b){this.localScriptReplacement.push({keyword:a,replacement:b})}},reset:function(){null!=this.scriptAsset&&this.scriptAsset.stop(this.parentEntity,this),this.scriptAsset=null,this.appInstanceStartedSub&&(this.appInstanceStartedSub.reset(),this.appInstanceStartedSub=void 0)},onScriptLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Script."+this.parentEntity.id+"."+this.id+".ScriptLoaded",a,b):(this.log.error("Cannot subscribe onMeshLoaded, parent entity not set!"),null)},onScriptStarted:function(a,b,c){return this.hasParentEntity()?Tundra.events.subscribe("EC_Script."+this.parentEntity.id+"."+this.id+".ScriptStarted",a,b,c):(this.log.error("Cannot subscribe onMeshLoaded, parent entity not set!"),null)},_scriptLoaded:function(a){if(null==this.parentEntity)return void this.log.warn("_scriptLoaded with null Parent Entity");if(this.scriptAsset=a,Tundra.events.send("EC_Script."+this.parentEntity.id+"."+this.id+".ScriptLoaded",this.parentEntity,this,this.scriptAsset),!this.scriptAsset.running&&this.attributes.runOnLoad.get()){var b=this.scriptAsset.run(this.parentEntity,this,this.startupApplication);null!=b&&(this.appInstanceStartedSub&&this.appInstanceStartedSub.reset(),this.appInstanceStartedSub=b.onApplicationStarted(this,function(a,b){return null==this.parentEntity?void console.error("Dead script sent a ScriptStarted event",this):(this.appInstanceStartedSub&&(this.appInstanceStartedSub.reset(),this.appInstanceStartedSub=void 0),void Tundra.events.send("EC_Script."+this.parentEntity.id+"."+this.id+".ScriptStarted",this.parentEntity,this,this.scriptAsset,b))}))}},update:function(){if(!this.scriptsRequested){null!=this.scriptAsset&&this.scriptAsset.stop(this.parentEntity,this),this.scriptAsset=null;var a=this.attributes.scriptRef.getClone();if(0==a.length)return;if(void 0===a[0]||""===a[0])return;if(this.scriptsRequested=!0,this.attributes.runMode.get()===EC_Script.RunMode.Server)return void this.log.debug("Skipping loading and execution of Server only Tundra application '"+a[0]+"'");var b=a[0],c=b.substring(b.lastIndexOf(".")).toLowerCase(),d=!1,e=b.substring(b.lastIndexOf("/")+1);if(".webtundrajs"===c&&(d=!0),d)for(var f=0,g=EC_Script.localScriptReplacement.length;f<g;f++){var h=EC_Script.localScriptReplacement[f];if(e.toLowerCase().indexOf(h.keyword.toLowerCase())!==-1&&null!=h.replacement&&""!=h.replacement){var i=h.replacement.substring(h.replacement.lastIndexOf("/")+1);this.log.infoC("Replacing script '"+e+"' with registered local development script '"+i+"'"),b=h.replacement,d=!0;break}}else for(var f=0,g=EC_Script.nativeScriptReplacements.length;f<g;f++){var h=EC_Script.nativeScriptReplacements[f];if(e.toLowerCase().indexOf(h.keyword.toLowerCase())!==-1&&null!=h.replacement&&""!=h.replacement){var i=h.replacement.substring(h.replacement.lastIndexOf("/")+1);this.log.infoC("Replacing native Tundra script '"+e+"' with registered script '"+i+"'"),b=h.replacement,d=!0;break}}if(!d)return void this.log.debug("Skipping loading and execution of native Tundra application '"+e+"'");var j=Tundra.asset.requestAsset(b,"Script");null!=j&&j.onCompleted(this,this._scriptLoaded)}},attributeChanged:function(a,b,c){0===a?(this.scriptsRequested=!1,this.update()):1===a&&(null==this.scriptAsset||this.scriptAsset.running||c!==!0||this.scriptAsset.run(this.parentEntity,this,this.startupApplication))}});Scene.registerComponent(EC_Script);var EC_Avatar=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),
this.declareAttribute(0,"appearanceRef","",Attribute.AssetReference),this.useAvatarAsset=!0;var e=Tundra.asset.resolveAssetRef("webtundra://media/assets/avatar/jack.avatar");this.defaultAppearanceRef=e,this.avatarAssets={},this.avatarAssets[e]={mesh:Tundra.asset.resolveAssetRef("webtundra://media/assets/avatar/jack.mesh"),skeleton:Tundra.asset.resolveAssetRef("webtundra://media/assets/avatar/jack.skeleton"),materials:[Tundra.asset.resolveAssetRef("webtundra://media/assets/avatar/jack_body.material"),Tundra.asset.resolveAssetRef("webtundra://media/assets/avatar/jack_face.material")]},this.resetState()},__classvars__:{TypeId:1,TypeName:"Avatar",MeshComponentName:"EC_Avatar_Generated_Mesh"},reset:function(){this.resetState()},resetState:function(){this.currentAppearanceRef="",this.avatarRequested=!1,this.attachementsRequested=!1,this.avatarApplied=!1,this.avatarDescAsset=null,null!=this.parentEntity&&this.parentEntity.removeComponentByName("Mesh",EC_Avatar.MeshComponentName)},attributeChanged:function(a,b,c){0===a&&this.update()},getAvatarData:function(){return this.avatarAssets[this.attributes.appearanceRef.get()]},getDefaultAvatarData:function(){return this.avatarAssets[this.defaultAppearanceRef]},getAvatarRotation:function(){var a=this.getAvatarData();return null!=a&&null!=a.rotation?a.rotation:0},onAvatarDescLoaded:function(a){this.avatarDescAsset=a.cloneInstance(),this.update()},onAvatarAttachementLoaded:function(a,b){for(var c=0;c<this.avatarDescAsset.attachements.length;c++)if(!this.avatarDescAsset.attachements[c].isLoaded())return;this.update()},update:function(){var a=this.attributes.appearanceRef.get();if(""!==a&&this.currentAppearanceRef!==a&&(""!==this.currentAppearanceRef&&this.currentAppearanceRef!==a&&this.resetState(),!this.avatarApplied)){if(this.useAvatarAsset){if(!this.avatarRequested){this.avatarRequested=!0;var b=Tundra.asset.requestAsset(a,"RealXtendAvatarDescription");return void(null!=b&&b.onCompleted(this,this.onAvatarDescLoaded))}if(null==this.avatarDescAsset)return;if(!this.attachementsRequested&&(this.attachementsRequested=!0,this.avatarDescAsset.attachements.length>0)){for(var c=0;c<this.avatarDescAsset.attachements.length;c++)this.avatarDescAsset.attachements[c].requestAssets(this,this.onAvatarAttachementLoaded);return}}var d=this.useAvatarAsset?void 0!==this.avatarDescAsset&&this.avatarDescAsset.assets:this.getAvatarData();null==d&&(this.log.warn("Avatar '"+this.attributes.appearanceRef.get()+"' not supported, using default."),d=this.getDefaultAvatarData()),this.parentEntity.removeComponentByName("Mesh",EC_Avatar.MeshComponentName);var e=this.parentEntity.createLocalComponent("Mesh",EC_Avatar.MeshComponentName);e.replicated=!1,e.local=!0,e.temporary=!0,e.meshRef=d.mesh,e.skeletonRef=d.skeleton,e.materialRefs=d.materials,e.castShadows=!0;var f=e.nodeTransformation;f.pos.y=-.86,f.rot.y=0,e.nodeTransformation=f,null!=this.avatarDescAsset&&this.avatarDescAsset.attachements.length>0&&e.setAttachements(this.avatarDescAsset.attachements),this.avatarApplied=!0,this.currentAppearanceRef=a,e.update()}}});Scene.registerComponent(EC_Avatar);var EC_DynamicComponent=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d)},__classvars__:{TypeId:25,TypeName:"DynamicComponent"},isDynamic:function(){return!0},hasAttribute:function(a){var b=this.getAttribute(a);return void 0!==b&&null!==b},createAttribute:function(a,b){if("string"==typeof a&&(a=Attribute.toTypeId(a)),void 0===a||null===a)return this.log.error("createAttribute: received invalid type name or id parameter."),!1;if(this.hasAttribute(b))return this.log.error("createAttribute: attribute with name '"+b+"' already exists!"),!1;for(var c=0;c<1e4&&void 0!==this.attributeIndexes[c];)c++;return this.declareAttribute(c,b,Attribute.defaultValueForType(a),a),this._attributeAdded(c),!0},removeAttribute:function(a){try{var b=void 0,c=void 0;if("string"==typeof a?b=a:"number"==typeof a&&(c=a,b=this.attributeIndexes[a]),void 0===b||null===b)return!1;var d=this.attributes[b];if(void 0===d||null===d)return!1;if(void 0===c&&(c=d.index),this._attributeAboutToBeRemoved(d),void 0!==this[b]){var e={};e[b]={get:function(){},set:function(a){},configurable:!0},Object.defineProperties(this,e)}return d._reset(),d=null,delete this.attributes[b],delete this.attributeIndexes[c],this.attributes[b]=void 0,this.attributeIndexes[c]=void 0,!0}catch(f){this.log.error("removeAttribute:",f)}return!1},onAttributeAdded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_DynamicComponent.AttributeAdded."+this.parentEntity.id+"."+this.id,a,b):(this.log.error("Cannot subscribe onAttributeAdded, no parent entity!"),null)},_attributeAdded:function(a){"number"==typeof a&&(a=this.attributeByIndex(a)),void 0!==a&&null!==a&&this.hasParentEntity()&&Tundra.events.send("EC_DynamicComponent.AttributeAdded."+this.parentEntity.id+"."+this.id,this,a)},onAttributeAboutToBeRemoved:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_DynamicComponent.AttributeAboutToBeRemoved."+this.parentEntity.id+"."+this.id,a,b):(this.log.error("Cannot subscribe onAttributeAboutToBeRemoved, no parent entity!"),null)},_attributeAboutToBeRemoved:function(a){void 0!==a&&null!==a&&this.hasParentEntity()&&Tundra.events.send("EC_DynamicComponent.AttributeAboutToBeRemoved."+this.parentEntity.id+"."+this.id,this,a.index,a.name)}});Scene.registerComponent(EC_DynamicComponent);var EC_HtmlBillboard=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"position",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(1,"size",new THREE.Vector2(-1,-1),Attribute.Float2),this.declareAttribute(2,"hoverMagnify",!1,Attribute.Bool)},__classvars__:{TypeId:1e3,TypeName:"HtmlBillboard"}}),TundraClient=Class.$extend({__init__:function(a){Tundra.client=this,this.options=TundraClient.mergeOptions(a),Tundra.options=this.options.Tundra,this.log=TundraLogging.getLogger("WebTundra"),this.log.info(this.getVersion()),"number"==typeof this.options.TundraClient.loglevel&&(this.options.TundraClient.loglevel=TundraLogging.levelString(this.options.TundraClient.loglevel)),TundraLogging.setLevel(this.options.TundraClient.loglevel),this.log.debug("Created Tundra",Tundra.options),this.log.debug("Created TundraClient",this.options.TundraClient);for(var b=[EC_Name,EC_Script,EC_DynamicComponent,EC_Avatar],c=0;c<b.length;c++)Scene.registered(b[c])||Scene.registerComponent(b[c]);if(this.container=Tundra.container=this.loadContainer(),this.APIs=[],this.audio=Tundra.audio=this.loadAPI("AudioAPI",AudioAPI),this.config=Tundra.config=this.loadAPI("ConfigAPI",ConfigAPI),this.events=Tundra.events=this.loadAPI("EventAPI",EventAPI),this.network=Tundra.network=this.loadAPI("Network",Network),this.frame=Tundra.frame=this.loadAPI("FrameAPI",FrameAPI),this.console=Tundra.console=this.loadAPI("ConsoleAPI",ConsoleAPI),this.asset=Tundra.asset=this.loadAPI("AssetAPI",AssetAPI),this.input=Tundra.input=this.loadAPI("InputAPI",InputAPI),this.ui=Tundra.ui=this.loadAPI("UiAPI",UiAPI),this.scene=Tundra.scene=this.loadAPI("Scene",Scene),this.renderer=Tundra.renderer=this.loadRenderer(),this.domIntegration=null,this.loginProperties={},this.connectionId=0,this.networkDebugLogging=this.options.networkDebugLogging,this.protocolVersion=Network.protocolVersion.Original,this.observerEntityId=0,this.reset(),this.initializeAPIs(),Tundra.loadPlugins(this.options.plugins),"object"==typeof this.renderer&&"function"==typeof this.renderer.postInitialize&&this.renderer.postInitialize(),this.postInitializeAPIs(),this.onUpdateInternal(),Object.keys(this.options.TundraClient.applications).length>0)for(var d in this.options.TundraClient.applications)this.runApplication(d,this.options.TundraClient.applications[d])},getVersion:function(){try{var a=[];"object"==typeof window.WebTundraVersion&&"string"==typeof window.WebTundraVersion.version?"undefined"!==window.WebTundraVersion.version?a.push("v"+window.WebTundraVersion.version+" ("+window.WebTundraVersion.commit+")"):a.push("nightly ("+window.WebTundraVersion.commit+")"):a.push("Developer Mode"),"object"==typeof THREE&&void 0!==THREE.REVISION&&a.push("THREE "+THREE.REVISION),a.push(Tundra.browser.name()+" "+Tundra.browser.version()+(Tundra.browser.isMobile()?" [Mobile]":"")),this.version=a.join(" | ")}catch(b){this.version="Version detection failed: "+b}return this.version},loadAPI:function(a,b){var c=$.extend({},this.options[a]),d=new b(a,c,$.extend({},this.options));return this.APIs.push(d),this.log.debug("Created",d.name,Object.keys(d.options).length>0?d.options:""),d},initializeAPIs:function(){for(var a=0;a<this.APIs.length;a++)this.APIs[a]._initialize()},postInitializeAPIs:function(){for(var a=0;a<this.APIs.length;a++)this.APIs[a]._postInitialize()},loadContainer:function(){var a=null;return void 0===this.options.TundraClient.container||null===this.options.TundraClient.container?(a=$("<div/>"),a.attr("id","webtundra-container-custom"),a.css({"background-color":"black",position:"absolute","z-index":0,top:0,left:0,padding:0,margin:0,width:"100%",height:"100%",overflow:"hidden"}),$("body").append(a)):a=$(this.options.TundraClient.container),a},loadRenderer:function(){var a=null;return"function"==typeof this.options.TundraClient.renderer?a=this.options.TundraClient.renderer.register(TundraClient):"string"==typeof a&&(a=TundraClient.getRenderSystemByName(a)),null==a&&TundraClient.renderSystems.length>0&&(a=TundraClient.renderSystems[0]),null!==a?(this.log.debug("Loading Renderer",this.options.Renderer),a._load($.extend({},this.options.Renderer))):this.log.error("Failed to load a render system. Registered:",TundraClient.renderSystems),a},reset:function(){this.websocket=null,this.websocketFaked=!1,this.loginProperties={},this.connectionId=0,this.authTokens={},this.renderer&&"object"==typeof this.renderer&&"function"==typeof this.renderer.reset&&this.renderer.reset();for(var a=0;a<this.APIs.length;a++)this.APIs[a].reset();this.lastTime=performance.now(),this.observerEntityId=0,this.network.lastObserverSendTime=0,this.cameraApplications=[],this.cameraApplicationIndex=0,this.cameraSwitcherButton=null,this.cameraSwitcherMenu=null},__classvars__:{domIntegrations:[],registerDomIntegration:function(a){return a instanceof IDomIntegration?TundraClient.domIntegrations.push(a):null!=console.error&&console.error("[WebTundra]: registerDomIntegration called with object that is not an instance of IDomIntegration!"),a instanceof IDomIntegration},renderSystems:[],registerRenderSystem:function(a){return a instanceof IRenderSystem?TundraClient.renderSystems.push(a):null!=console.error&&console.error("[WebTundra]: registerRenderSystem called with object that is not an instance of IRenderSystem!"),a instanceof IRenderSystem},getRenderSystemByName:function(a){for(var b=0;b<TundraClient.renderSystems.length;b++)if(TundraClient.renderSystems[b].name===a)return TundraClient.renderSystems[b];return TundraClient.log.error("getRenderSystemByName: Failed to find:",a),null},mergeOptions:function(a){a=a||{};var b=$.extend({},a);b.plugins||(b.plugins={}),a.plugins||(a.plugins={});for(var c=TundraClient.getDefaultOptions(),d=0,e=Tundra.APINames();d<e.length;d++)b[e[d]]=$.extend(!0,{},c[e[d]],a[e[d]]);for(var d=0,f=Tundra.pluginNames();d<f.length;d++)b.plugins[f[d]]=$.extend(!0,{},c.plugins[f[d]],a.plugins[f[d]]);"object"==typeof a.TundraClient&&"function"==typeof a.TundraClient.renderer&&"function"==typeof a.TundraClient.renderer.getDefaultOptions?b.Renderer=$.extend({},c.Renderer,a.TundraClient.renderer.getDefaultOptions(),a.Renderer):b.Renderer=$.extend({},c.Renderer,a.Renderer);var g=function(a,b,c){if(Array.isArray(c)){for(var d=0;d<c.length;d++)if(typeof a[b]===c[d])return!0;return!1}return"string"==typeof c?typeof a[b]===c:(console.error("Invalid options type check",a,b,c),!1)},h=function(a,b,c,d,e){d=d||b,c[d]=a[b],delete a[b],"string"==typeof e&&""!==e&&console.warn("DEPRECATED: TundraClient constructor option:",e)};return g(b,"polymer","boolean")&&h(b,"polymer",b.Tundra,"polymer","options.polymer > options.Tundra.polymer"),g(b,"requirejs","boolean")&&h(b,"requirejs",b.Tundra,"requirejs","options.requirejs > options.Tundra.requirejs"),g(b,"container",["string","object"])&&h(b,"container",b.TundraClient,"container","options.container > options.TundraClient.container"),g(b,"renderSystem",["string","object","function"])&&h(b,"renderSystem",b.TundraClient,"renderer","options.renderSystem > options.TundraClient.renderer"),g(b,"applications","object")&&h(b,"applications",b.TundraClient,"applications","options.applications > options.TundraClient.applications"),g(b,"loglevel",["string","number"])&&h(b,"loglevel",b.TundraClient,"loglevel","options.loglevel > options.TundraClient.loglevel"),"object"==typeof b.asset&&g(b.asset,"localStoragePath","string")&&(h(b.asset,"localStoragePath",b.AssetAPI.storages,"webtundra://",'options.asset.localStoragePath > options.AssetAPI.storages["webtundra://"]'),0===Object.keys(b.asset).length&&delete b.asset),g(b,"taskbar","boolean")&&h(b,"taskbar",b.UiAPI,"taskbar","options.taskbar > options.UiAPI.taskbar"),g(b,"console","boolean")&&h(b,"console",b.UiAPI,"console","options.console > options.UiAPI.console"),g(b,"allowFullscreen","boolean")&&h(b,"allowFullscreen",b.UiAPI,"allowFullscreen","options.allowFullscreen > options.UiAPI.allowFullscreen"),g(b,"showfps","boolean")&&h(b,"showfps",b.UiAPI,"fps","options.showfps > options.UiAPI.fps"),g(b,"networkDebugLogging","boolean")&&h(b,"networkDebugLogging",b.Network,"debug","options.networkDebugLogging > options.Network.debug"),b},getDefaultOptions:function(){for(var a={plugins:{}},b=0,c=Tundra.APINames();b<c.length;b++)a[c[b]]={};for(var b=0,d=Tundra.pluginNames();b<d.length;b++)a.plugins[d[b]]={};return $.extend(a.TundraClient,{loglevel:"info",container:null,renderer:null,applications:{}}),$.extend(a.Tundra,Tundra.getDefaultOptions()),$.extend(a.Network,Network.getDefaultOptions()),$.extend(a.AudioAPI,AudioAPI.getDefaultOptions()),$.extend(a.UiAPI,UiAPI.getDefaultOptions()),$.extend(a.AssetAPI,AssetAPI.getDefaultOptions()),a.Renderer=IRenderSystem.getDefaultOptions(),a}},getDefaultOptions:function(){return TundraClient.getDefaultOptions()},setDomIntegration:function(a){void 0!==this.domIntegration&&null!==this.domIntegration&&this.domIntegration._unload(),this.domIntegration=a,this.domIntegration._load()},registerCameraApplication:function(a,b){if(!(b instanceof ICameraApplication))return void console.error("[WebTundra]: registerCameraApplication called with object that is not an instance of ICameraApplication!");for(var c=0;c<this.cameraApplications.length;c++)if(this.cameraApplications[c].name===a)return void console.error("[WebTundra]: Camera application '"+a+"' already registered!");if(this.cameraApplications.push({name:a,application:b}),!(this.cameraApplications.length<=1)){var d=this;if(null!=this.cameraSwitcherButton)return void this.ui.addContextMenuItems(this.cameraSwitcherMenu,{name:a,callback:function(){d.activateCameraApplication($(this).data("itemName"))}});this.cameraSwitcherButton=this.ui.addAction("Change Camera (shift+tab)","http://meshmoon.data.s3.amazonaws.com/icons/pictos1/24/209.png",40,!1),this.cameraSwitcherMenu=this.ui.addContextMenu(this.cameraSwitcherButton,!0,!0);for(var c=0;c<this.cameraApplications.length;c++)this.ui.addContextMenuItems(this.cameraSwitcherMenu,{name:this.cameraApplications[c].name,callback:function(){d.activateCameraApplication($(this).data("itemName"))}});this.input.onKeyPress(this,function(a){!a.originalEvent.shiftKey||9!==a.keyCode&&"tab"!==a.key||"body"!==a.targetNodeName&&"canvas"!==a.targetNodeName||(this.cameraApplicationIndex++,this.cameraApplicationIndex>=this.cameraApplications.length&&(this.cameraApplicationIndex=0),this.activateCameraApplication(this.cameraApplications[this.cameraApplicationIndex].name),a.originalEvent.preventDefault())})}},activateCameraApplication:function(a){for(var b=0;b<this.cameraApplications.length;b++)if(this.cameraApplications[b].name===a)return this.cameraApplicationIndex=b,void this.cameraApplications[b].application._activateCameraApplication()},setAuthToken:function(a,b){this.authTokens[a]=b},getAuthToken:function(a){return this.authTokens[a]},runApplication:function(a,b){if(null==Scene.registeredComponent("Script"))return this.log.error("runApplication: Cannot run script '"+b+"', Script component not registered."),null;var c=this.scene.createLocalEntity(["Name","Script"]);return c.name=a||"Startup Application",c.script.startupApplication=!0,c.script.attributes.runMode.set(EC_Script.RunMode.Client,AttributeChange.LocalOnly),c.script.attributes.runOnLoad.set(!0,AttributeChange.LocalOnly),c.script.attributes.scriptRef.set([b],AttributeChange.LocalOnly),c},findApplicationEntity:function(a,b){for(var c=this.scene.entitiesWithComponent("Script"),d=0;d<c.length;d++)if(c[d].name===a)return c[d]},findApplication:function(a,b,c){var d=this.findApplicationEntity(a);if(d&&d.script&&d.script.scriptAsset&&Array.isArray(d.script.scriptAsset.instances)){if(c===!0)return d.script.scriptAsset.instances;var e=d.script.scriptAsset._getInstance(d,d.script);if(e)return e&&e.application?e.application:void 0;for(var f=0;f<instances.length;f++)if(instances[f]&&"object"==typeof instances[f]&&instances[f].application)return instances[f].application}},onConnected:function(a,b){return Tundra.events.subscribe("TundraClient.Connected",a,b)},onConnectionError:function(a,b){return Tundra.events.subscribe("TundraClient.ConnectionError",a,b)},onDisconnected:function(a,b){return Tundra.events.subscribe("TundraClient.Disconnected",a,b)},onLogInfo:function(a,b){return Tundra.events.subscribe("TundraClient.LogInfo",a,b)},onLogWarning:function(a,b){return Tundra.events.subscribe("TundraClient.LogWarning",a,b)},onLogError:function(a,b){return Tundra.events.subscribe("TundraClient.LogError",a,b)},onUpdateInternal:function(){var a=Tundra.client;requestAnimationFrame(a.onUpdateInternal);var b=performance.now(),c=b-a.lastTime;if(frametimeMsec=c,c/=1e3,a.lastTime=b,void 0!==a.frame.limiter){if(!a.frame._limit(c))return;c+=a.frame.limiter.step}a.frame._update(c),a.asset.update(c),a.scene.update(c),a.frame._preRender(c),a.renderer.update(c,frametimeMsec),a.observerEntityId>0&&a.network.updateObserver(b),a.frame._postUpdate(c)},logInfo:function(a,b){void 0!==b&&null!=b||(b=!1),b&&null!=console.log&&console.log(a),Tundra.events.send("TundraClient.LogInfo",a)},logWarning:function(a,b){void 0!==b&&null!=b||(b=!1),b&&null!=console.warn&&console.warn(a),Tundra.events.send("TundraClient.LogWarning",a)},logError:function(a,b){void 0!==b&&null!=b||(b=!1),b&&null!=console.error&&console.error(a),Tundra.events.send("TundraClient.LogError",a)},isConnected:function(){return this.websocketFaked===!0||this._isWebSocketConnected()},_isWebSocketConnected:function(){return null!=this.websocket&&3!==this.websocket.readyState},connect:function(a,b){if("string"!=typeof a)return this.log.error("connect() called with non-string 'host'"),{success:!1,reason:"Host not a string"};a=a.trim(),CoreStringUtils.startsWith(a,"http://",!0)?a=a.substring(7):CoreStringUtils.startsWith(a,"https://",!0)&&(a=a.substring(8)),CoreStringUtils.startsWith(a,"ws://")||CoreStringUtils.startsWith(a,"wss://")||(a="ws://"+a);try{this.websocket=new WebSocket(a)}catch(c){return{success:!1,reason:"This browser does not support WebSocket connections"}}return this.websocket.binaryType="arraybuffer",this.websocket.onopen=this.onWebSocketConnectionOpened,this.websocket.onerror=this.onWebSocketConnectionError,this.websocket.onclose=this.onWebSocketConnectionClosed,this.websocket.onmessage=this.onWebSocketMessage,this.loginProperties=void 0!==b&&null!==b?b:{},{success:!0}},fakeConnectionState:function(){this.isConnected()||(this.websocketFaked=!0,this.events.send("TundraClient.Connected"))},disconnect:function(){null!=this.websocket?this.websocket.close():this.websocketFaked&&this.events.send("TundraClient.Disconnected",{}),this.reset()},onWebSocketConnectionOpened:function(a){var b=Tundra.client;b.log.infoC("Server connection established");var c=new LoginMessage;c.serialize(JSON.stringify(b.loginProperties)),Tundra.network.send(c,a),b.events.send("TundraClient.Connected")},onWebSocketConnectionError:function(a){var b=Tundra.client;b.log.errorC("Failed to connect to",a.target.url),b.events.send("TundraClient.ConnectionError",a)},onWebSocketConnectionClosed:function(a){var b=Tundra.client;b.log.infoC("Server connection disconnected"),b.events.send("TundraClient.Disconnected",a),b.reset()},onWebSocketMessage:function(a){var b=Tundra.client;"string"!=typeof a.data?(Tundra.client.network.receive(a.data),a.data=null):b.log.info("Server sent a unexpected string message '"+a.data+"'")}}),RaycastResult=Class.$extend({__init__:function(){this.entity=null,this.component=null,this.object=null,this.pos=new THREE.Vector3(0,0,0),this.submeshIndex=-1,this.face=new THREE.Face3,this.distance=-1,this.ray=new THREE.Ray,this.execution={error:"",screenPos:new THREE.Vector2(0,0),selectionLayer:-1},this._zeroVec=new THREE.Vector3(0,0,0),this._uv1=new THREE.Vector2(0,0),this._uv2=new THREE.Vector2(0,0),this._uv1Queried=!1,this._uv2Queried=!1},reset:function(){this.entity=null,this.component=null,this.object=null,this.pos.set(0,0,0),this.submeshIndex=-1,this.face.a=-1,this.face.b=-1,this.face.c=-1,this.distance=-1,this.ray.origin.set(0,0,0),this.ray.direction.set(0,0,0),this._uv1.set(0,0),this._uv2.set(0,0),this._uv1Queried=!1,this._uv2Queried=!1,this.execution.error="",this.execution.screenPos.set(0,0),this.execution.selectionLayer=-1},copyFace:function(a){this.face.a=a?a.a:-1,this.face.b=a?a.b:-1,this.face.c=a?a.c:-1,this.face.normal.copy(a?a.normal:this._zeroVec),this.face.color.copy(a?a.color:this._zeroVec),a&&(this.face.vertexNormals=a.vertexNormals,this.face.vertexTangents=a.vertexTangents,this.face.vertexColors=a.vertexColors,this.face.materialIndex=a.materialIndex)},clone:function(){var a=new RaycastResult;return a.entity=this.entity,a.component=this.component,a.object=this.object,a.pos.copy(this.pos),a.submeshIndex=this.submeshIndex,a.face=this.face.clone(),a.distance=this.distance,a.ray.copy(this.ray),a._uv1.copy(this._uv1),a._uv2.copy(this._uv2),this._uv1Queried=this._uv1Queried,this._uv2Queried=this._uv2Queried,a.execution.error=this.execution.error,a.execution.screenPos.copy(this.execution.screenPos),a.execution.selectionLayer=this.execution.selectionLayer,a},hasError:function(){return""!==this.execution.error},setError:function(a){this.execution.error=a},executionMatches:function(a,b,c){return this.execution.screenPos.x===a&&this.execution.screenPos.y===b&&this.execution.selectionLayer===c},setExecutionInfo:function(a,b,c){this.execution.screenPos.x=a,this.execution.screenPos.y=b,this.execution.selectionLayer=c},hasValidFace:function(){return this.face.a!==-1&&this.face.b!==-1&&this.face.c!==-1},getNormal:function(){return this.hasValidFace()?this.face.normal:(this._zeroVec.set(0,0,0),this._zeroVec)},getUV:function(a){if(a="number"==typeof a?a:0,a<0||a>1)return console.warn("[RaycastResult]: UVs 0 or 1 are valid, given:",a),null;if(0===a&&this._uv1Queried)return this._uv1;if(1===a&&this._uv2Queried)return this._uv2;0===a?this._uv1Queried=!0:this._uv2Queried=!0;var b=0===a?this._uv1:this._uv2;if(!this.object||!this.object.geometry)return b;if(this.hasValidFace())if(this.object.geometry instanceof THREE.BufferGeometry){var c=0===a?this.object.geometry.getAttribute("uv"):this.object.geometry.getAttribute("uv2");if(c&&c.array&&c.itemSize>=2){b.set(0,0);for(var d=new THREE.Vector2(0,0),e=0;e<3;e++){var f=0===e?this.face.a:1===e?this.face.b:this.face.c;if(d.set(c.array[f*c.itemSize],c.array[f*c.itemSize+1]),"number"!=typeof d.x||isNaN(d.x)||"number"!=typeof d.y||isNaN(d.y))return b;b.add(d)}b.divideScalar(2)}}else if(this.object.geometry instanceof THREE.Geometry){if(!Array.isArray(this.object.geometry.faceVertexUvs)||a>=this.object.geometry.faceVertexUvs.length)return b;var c=this.object.geometry.faceVertexUvs[a];if(Array.isArray(c)&&c.length>0){var g=c[this.face.a],h=c[this.face.b],i=c[this.face.c];if(g instanceof THREE.Vector2==!1||h instanceof THREE.Vector2==!1||i instanceof THREE.Vector2==!1)return b;b.add(g),b.add(h),b.add(i),b.divideScalar(2)}}return b}}),TransformInterpolator=Class.$extend({__init__:function(){this.jobs=[],this.serverUpdateInterval=.05,this.enabled=!0,this.transformCache=[],this.tempTransform=new Transform,this.rotation={q1:new THREE.Quaternion,q2:new THREE.Quaternion},Tundra.frame.onUpdate(this,this.onUpdate)},update:function(a,b,c,d){if(!d.interpolation.previous||a.local||b.local||!this.enabled)return void Tundra.client.renderer.updateSceneNode(c,d.interpolation.current);var e=this.serverUpdateInterval,f=this.end(a,b);void 0===f?Tundra.client.renderer.updateSceneNode(c,d.interpolation.current):e=.5*f.duration+.5*(.001*(performance.now()-f.timeStart));var g={target:b,start:this.getTransform(),end:this.getTransform(),timeStart:performance.now(),time:void 0!==f?0:e+1e-4,duration:e};g.start.copy(d.interpolation.previous),g.end.copy(d.interpolation.current),this.jobs.push(g)},getTransform:function(){return this.transformCache.length>0?this.transformCache.splice(0,1)[0]:new Transform},_freeTransform:function(a){this.transformCache.length<=98&&a.end&&a.start&&(this.transformCache.push(a.end),this.transformCache.push(a.start))},end:function(a,b){for(var c=this.jobs.length-1;c>=0;c--){var d=this.jobs[c];if(d.target&&d.target.parentEntity){if(d.target.parentEntity.id===a.id&&d.target.id===b.id)return this._freeTransform(d),this.jobs.splice(c,1)[0]}else this._freeTransform(d),this.jobs.splice(c,1)}},onUpdate:function(a){for(var b=this.jobs.length-1;b>=0;b--){var c=this.jobs[b];if(c.time<c.duration){c.time+=a;var d=c.time/c.duration;d>1&&(d=1),this.tempTransform._pos.copy(c.start._pos).lerp(c.end._pos,d),this.tempTransform._scale.copy(c.start._scale).lerp(c.end._scale,d),c.start.orientation(this.rotation.q1),c.end.orientation(this.rotation.q2),this.rotation.q1.slerp(this.rotation.q2,d),this.tempTransform.setRotation(this.rotation.q1),Tundra.client.renderer.updateSceneNode(c.target.sceneNode,this.tempTransform)}else c.time+=a,c.time>=2*c.duration&&(this.transformCache.length<=98&&(this.transformCache.push(c.end),this.transformCache.push(c.start)),this.jobs.splice(b,1))}}}),ObjMeshAsset=IAsset.$extend({__init__:function(a){this.$super(a,"ObjMeshAsset"),this.requiresCloning=!0,this.mesh=void 0},__classvars__:{Loader:new THREE.OBJLoader},isLoaded:function(){return void 0!==this.mesh&&this.mesh.children.length>0},unload:function(){if(!this.requiresCloning||!this.isCloneSource){var a=this.numSubmeshes();this.logging&&null!=this.mesh&&a>0&&this.log.debug("unload",this.name),this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh);for(var b=0;b<a;b++){this.logging&&console.log("  submesh "+b);var c=this.getSubmesh(b);null!=c.geometry&&(this.logging&&console.log("    geometry"),this.isGeometryInUse(c.geometry)===!1?c.geometry.dispose():this.logging&&this.log.debug("      Still in use, not unloading"),c.geometry=null),c.material=null,c=null}null!=this.mesh&&(this.mesh.children=[]),this.mesh=void 0}},isGeometryInUse:function(a){if(void 0===a.uuid)return!1;var b=!1;return Tundra.renderer.scene.traverse(function(c){b!==!0&&null!=c&&void 0!==c.geometry&&(c.geometry instanceof THREE.BufferGeometry||c.geometry instanceof THREE.Geometry)&&c.geometry.uuid===a.uuid&&(b=!0)}),b},_cloneImpl:function(a){var b=new ObjMeshAsset(a);b.mesh=Tundra.renderer.createSceneNode();for(var c=0,d=this.numSubmeshes();c<d;++c){var e=this.getSubmesh(c),f=null;f=e instanceof THREE.SkinnedMesh?new THREE.SkinnedMesh(e.geometry,Tundra.renderer.materialWhite,!1):new THREE.Mesh(e.geometry,Tundra.renderer.materialWhite),f.name=b.name+"_submesh_"+c,f.tundraSubmeshIndex=e.tundraSubmeshIndex,b.mesh.add(f)}return b},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:null},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},deserializeFromData:function(a,b){try{this.mesh=ObjMeshAsset.Loader.parse(a)}catch(c){this.log.error("Failed to load OBJ mesh",this.name,c.toString()),this.mesh=void 0}void 0!==this.mesh&&null!==this.mesh||(this.mesh=Tundra.renderer.createSceneNode()),this.mesh.name=this.name,this.mesh.matrixAutoUpdate=!1;for(var d=0;d<this.mesh.children.length;d++)this.mesh.children[d].tundraSubmeshIndex=d,this.mesh.children[d].name=this.name+"_submesh_"+d;return this.isLoaded()}}),ThreeJsonAsset=IAsset.$extend({__init__:function(a){this.$super(a,"ThreeJsonAsset"),this.requiresCloning=!0,this.mesh=void 0},__classvars__:{Loader:new THREE.JSONLoader},isLoaded:function(){return void 0!==this.mesh&&this.mesh.children.length>0},unload:function(){if(!this.requiresCloning||!this.isCloneSource){var a=this.numSubmeshes();this.logging&&null!=this.mesh&&a>0&&this.log.debug("unload",this.name),null!=this.mesh&&null!=this.mesh.parent&&this.mesh.parent.remove(this.mesh);for(var b=0;b<a;b++){this.logging&&console.log("  submesh "+b);var c=this.getSubmesh(b);null!=c.geometry&&(this.logging&&console.log("    geometry"),this.isGeometryInUse(c.geometry)===!1?c.geometry.dispose():this.logging&&this.log.debug("      Still in use, not unloading"),c.geometry=null),c.material=null,c=null}null!=this.mesh&&(this.mesh.children=[]),this.mesh=void 0}},isGeometryInUse:function(a){if(void 0===a.uuid)return!1;var b=!1;return Tundra.renderer.scene.traverse(function(c){b!==!0&&null!=c&&void 0!==c.geometry&&(c.geometry instanceof THREE.BufferGeometry||c.geometry instanceof THREE.Geometry)&&c.geometry.uuid===a.uuid&&(b=!0)}),b},_cloneImpl:function(a){var b=new ThreeJsonAsset(a);b.mesh=Tundra.renderer.createSceneNode();for(var c=0,d=this.numSubmeshes();c<d;++c){var e=this.getSubmesh(c),f=null;f=e instanceof THREE.SkinnedMesh?new THREE.SkinnedMesh(e.geometry,Tundra.renderer.materialWhite,!1):new THREE.Mesh(e.geometry,Tundra.renderer.materialWhite),f.name=b.name+"_submesh_"+c,f.tundraSubmeshIndex=e.tundraSubmeshIndex,b.mesh.add(f)}return b},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:null},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},deserializeFromData:function(a,b){try{var c=ThreeJsonAsset.Loader.parse(a);if(void 0!==c&&void 0!==c.geometry){var d=void 0;void 0!==c.materials&&(d=1===c.materials.length?c.materials[0]:new THREE.MeshFaceMaterial(c.materials)),this.mesh=Tundra.renderer.createSceneNode(),this.mesh.add(new THREE.Mesh(c.geometry,d))}else this.log.error("Parsing failed, three.js didnt return a valid geometry for",this.name)}catch(e){this.log.error("Failed to load JSON mesh",this.name,e.toString()),this.mesh=void 0}void 0!==this.mesh&&null!==this.mesh||(this.mesh=Tundra.renderer.createSceneNode()),this.mesh.name=this.name,this.mesh.matrixAutoUpdate=!1;for(var f=0;f<this.mesh.children.length;f++)this.mesh.children[f].tundraSubmeshIndex=f,this.mesh.children[f].name=this.name+"_submesh_"+f;return this.isLoaded()}}),global=window;!function(a,b){b(a)}(this,function(a){"use strict";var b=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","animations","scenes"],c=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(a){this._rootDescription=a},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(a){var b=new RegExp("^"+window.location.protocol,"i");return!!a.match(b)}},resolvePathIfNeeded:{value:function(a){if(this._isAbsolutePath(a))return a;var b=/^data:/;return b.test(a)?a:this.baseURL+a}},_resolvePathsForCategories:{value:function(a){a.forEach(function(a){var b=this.json[a];if(b){var c=Object.keys(b);c.forEach(function(a){var c=b[a];c.uri=this.resolvePathIfNeeded(c.uri)},this)}},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){
return this._json},set:function(a){this._json!==a&&(this._json=a,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(a,b){var c=null,d=b;return c=this.rootDescription[d],c?c?c[a]:null:(console.log("ERROR:CANNOT find expected category named:"+d),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),this._state.categoryIndex!==-1&&(this._state.categoryState.index=0,!0)}},_stepToNextDescription:{enumerable:!1,value:function(){var a=this._state.categoryState,b=a.keys;return b?(a.index++,a.keys=null,a.index>=b.length&&this._stepToNextCategory()):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(a){return!!this.rootDescription[a]}},_handleState:{value:function(){for(var a={buffers:this.handleBuffer,bufferViews:this.handleBufferView,shaders:this.handleShader,programs:this.handleProgram,techniques:this.handleTechnique,materials:this.handleMaterial,meshes:this.handleMesh,cameras:this.handleCamera,lights:this.handleLight,nodes:this.handleNode,scenes:this.handleScene,images:this.handleImage,animations:this.handleAnimation,accessors:this.handleAccessor,skins:this.handleSkin,samplers:this.handleSampler,textures:this.handleTexture,videos:this.handleVideo,extensions:this.handleExtension},c=!0;this._state.categoryIndex!==-1;){var d=b[this._state.categoryIndex],e=this._state.categoryState,f=e.keys;if(f||(e.keys=f=Object.keys(this.rootDescription[d]),!f||0!=f.length)){var g=d,h=f[e.index],i=this.getEntryDescription(h,g);if(i){if(a[g]&&a[g].call(this,h,i,this._state.userInfo)===!1){c=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+h),c=!1;break}}else this._stepToNextDescription()}this.handleLoadCompleted&&this.handleLoadCompleted(c)}},_loadJSONIfNeeded:{enumerable:!0,value:function(a){var b=this;if(this._json)a&&a(this.json);else{var c=this._path,d=c.lastIndexOf("/");this.baseURL=0!==d?c.substring(0,d+1):"";var e=new XMLHttpRequest;e.open("GET",c,!0),e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(b.json=JSON.parse(e.responseText),a&&a(b.json))},e.send(null)}}},_buildLoader:{value:function(a){function b(b){c.rootDescription=b,a&&a(this)}var c=this;this._loadJSONIfNeeded(b)}},_state:{value:null,writable:!0},_getEntryType:{value:function(a){for(var c=b,d=0;d<c.length;d++){var e=this.rootDescription[c[d]];if(e)return c[d]}return null}},getNextCategoryIndex:{value:function(a){for(var c=a;c<b.length;c++)if(this.hasCategory(b[c]))return c;return-1}},load:{enumerable:!0,value:function(a,b){var c=this;this._buildLoader(function(d){var e=c.getNextCategoryIndex.call(c,0);e!==-1&&(c._state={userInfo:a,options:b,categoryIndex:e,categoryState:{index:"0"}},c._handleState())})}},initWithPath:{value:function(a){return this._path=a,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return"undefined"==typeof this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(a,b){return this.json=a,this.baseURL=b,b||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}});return a&&(a.glTFParser=c),c}),THREE.glTFLoader=function(a){this.meshesRequested=0,this.meshesLoaded=0,this.pendingMeshes=[],this.animationsRequested=0,this.animationsLoaded=0,this.animations=[],this.shadersRequested=0,this.shadersLoaded=0,this.shaders={},this.loadRequests=[],THREE.glTFShaders.removeAll(),THREE.Loader.call(this,a)},THREE.glTFLoader.prototype=new THREE.Loader,THREE.glTFLoader.prototype.constructor=THREE.glTFLoader,THREE.glTFLoader.prototype.load=function(url,callback){function RgbArraytoHex(a){if(!a)return 4294967295;var b=Math.floor(255*a[0]),c=Math.floor(255*a[1]),d=Math.floor(255*a[2]),e=255,f=(e<<24)+(b<<16)+(c<<8)+d;return f}function componentsPerElementForGLType(a){switch(a){case"SCALAR":nElements=1;break;case"VEC2":nElements=2;break;case"VEC3":nElements=3;break;case"VEC4":nElements=4;break;case"MAT2":nElements=4;break;case"MAT3":nElements=9;break;case"MAT4":nElements=16}return nElements}function replaceShaderDefinitions(shader,material){var program=material.params.program,shaderParams=material.params.technique.parameters,shaderAttributes=material.params.technique.attributes,params={};for(var attribute in material.params.attributes){var pname=shaderAttributes[attribute],shaderParam=shaderParams[pname],semantic=shaderParam.semantic;semantic&&(params[attribute]=shaderParam)}var s=shader,r="";for(var pname in params){var param=params[pname],semantic=param.semantic;switch(r=eval("/"+pname+"/g"),semantic){case"POSITION":s=s.replace(r,"position");break;case"NORMAL":s=s.replace(r,"normal");break;case"TEXCOORD_0":s=s.replace(r,"uv");break;case"WEIGHT":s=s.replace(r,"skinWeight");break;case"JOINT":s=s.replace(r,"skinIndex")}}return s}function replaceShaderSemantics(a){var b=theLoader.shaders[a.params.vertexShader];b&&(b=replaceShaderDefinitions(b,a),theLoader.shaders[a.params.vertexShader]=b)}function createShaderMaterial(a){replaceShaderSemantics(a);var b=theLoader.shaders[a.params.fragmentShader];if(!b)return console.log("ERROR: Missing fragment shader definition:",a.params.fragmentShader),new THREE.MeshPhongMaterial;var c=theLoader.shaders[a.params.vertexShader];if(!c)return console.log("ERROR: Missing vertex shader definition:",a.params.vertexShader),new THREE.MeshPhongMaterial;var d=THREE.UniformsUtils.clone(a.params.uniforms);for(uniform in a.params.uniforms){var e=a.params.uniforms[uniform],f=d[uniform];"t"==f.type&&(f.value=e.value)}var g=new THREE.RawShaderMaterial({fragmentShader:b,vertexShader:c,uniforms:d,transparent:a.params.transparent});return g}function LoadTexture(a){function b(a,b){var c=decodeURIComponent(b);return a?atob(c):c}function c(a,c){for(var d=b(a,c),e=new ArrayBuffer(d.length),f=new Uint8Array(e),g=0;g<d.length;g++)f[g]=d.charCodeAt(g);return e}function d(a,d){d="undefined"!=typeof d?d:"";var e=a[1],f=!!a[2],g=a[3];switch(d){case"":case"text":return b(f,g);case"ArrayBuffer":return c(f,g);case"blob":var h=c(f,g);return new Blob([h],{type:e});case"document":var i=new DOMParser;return i.parseFromString(b(f,g),e);case"json":return JSON.parse(b(f,g));default:throw"Unhandled responseType: "+d}}if(!a)return null;var e=function(a,b,c){var d=new Image;d.onload=function(){b(d)},"undefined"!=typeof c&&(d.onerror=c),d.src=a},f=/^data:(.*?)(;base64)?,(.*)$/,g=f.exec(a);if(null!==g){var h=new THREE.Texture,i=d(g,"blob"),j=window.URL.createObjectURL(i);return e(j,function(a){h.image=a,h.needsUpdate=!0}),h}var k=new THREE.TextureLoader;return k.crossOrigin="anonymous",k.load(a)}function CreateTexture(a,b){var c=null,d=null;if(b){var e=b;if(e){var f=a.getEntry(e);if(f){var g=a.getEntry(f.description.source);g&&(c=g.description.uri);var h=a.getEntry(f.description.sampler);h&&(d=h.description)}}}var e=LoadTexture(c);return e&&d&&(d.wrapS==WebGLRenderingContext.REPEAT&&(e.wrapS=THREE.RepeatWrapping),d.wrapT==WebGLRenderingContext.REPEAT&&(e.wrapT=THREE.RepeatWrapping),d.magFilter==WebGLRenderingContext.LINEAR&&(e.magFilter=THREE.LinearFilter)),e}var theLoader=this,ClassicGeometry=function(){this.geometry=new THREE.BufferGeometry,this.totalAttributes=0,this.loadedAttributes=0,this.indicesLoaded=!1,this.finished=!1,this.onload=null,this.uvs=null,this.indexArray=null};ClassicGeometry.prototype.constructor=ClassicGeometry,ClassicGeometry.prototype.buildBufferGeometry=function(){var a=this.geometry;a.setIndex(new THREE.BufferAttribute(this.indexArray,1));var b={start:0,index:0,count:this.indexArray.length};a.groups.push(b),a.computeBoundingSphere()},ClassicGeometry.prototype.checkFinished=function(){this.indexArray&&this.loadedAttributes===this.totalAttributes&&(this.buildBufferGeometry(),this.finished=!0,this.onload&&this.onload())};var IndicesDelegate=function(){};IndicesDelegate.prototype.handleError=function(a,b){console.log("ERROR(IndicesDelegate):"+a+":"+b)},IndicesDelegate.prototype.convert=function(a,b){return new Uint16Array(a,0,b.indices.count)},IndicesDelegate.prototype.resourceAvailable=function(a,b){var c=b.geometry;return c.indexArray=a,c.checkFinished(),!0};var indicesDelegate=new IndicesDelegate,IndicesContext=function(a,b){this.indices=a,this.geometry=b},VertexAttributeDelegate=function(){};VertexAttributeDelegate.prototype.handleError=function(a,b){console.log("ERROR(VertexAttributeDelegate):"+a+":"+b)},VertexAttributeDelegate.prototype.convert=function(a,b){return a},VertexAttributeDelegate.prototype.bufferResourceAvailable=function(a,b){var c,d,e,f=b.geometry,g=b.attribute,h=b.semantic;if("POSITION"==h)c=new Float32Array(a,0,g.count*componentsPerElementForGLType(g.type)),f.geometry.addAttribute("position",new THREE.BufferAttribute(c,3));else if("NORMAL"==h)e=componentsPerElementForGLType(g.type),c=new Float32Array(a,0,g.count*e),f.geometry.addAttribute("normal",new THREE.BufferAttribute(c,3));else if("TEXCOORD_0"==h||"TEXCOORD"==h){for(e=componentsPerElementForGLType(g.type),c=new Float32Array(a,0,g.count*e),d=0;d<c.length/2;d++)c[2*d+1]=1-c[2*d+1];f.geometry.addAttribute("uv",new THREE.BufferAttribute(c,e))}else"WEIGHT"==h?(e=componentsPerElementForGLType(g.type),c=new Float32Array(a,0,g.count*e),f.geometry.addAttribute("skinWeight",new THREE.BufferAttribute(c,e))):"JOINT"==h&&(e=componentsPerElementForGLType(g.type),c=new Float32Array(a,0,g.count*e),f.geometry.addAttribute("skinIndex",new THREE.BufferAttribute(c,e)))},VertexAttributeDelegate.prototype.resourceAvailable=function(a,b){this.bufferResourceAvailable(a,b);var c=b.geometry;return c.loadedAttributes++,c.checkFinished(),!0};var vertexAttributeDelegate=new VertexAttributeDelegate,VertexAttributeContext=function(a,b,c){this.attribute=a,this.semantic=b,this.geometry=c},Mesh=function(){this.primitives=[],this.materialsPending=[],this.loadedGeometry=0,this.onCompleteCallbacks=[]};Mesh.prototype.addPrimitive=function(a,b){var c=this;a.onload=function(){c.loadedGeometry++,c.checkComplete()},this.primitives.push({geometry:a,material:b,mesh:null})},Mesh.prototype.onComplete=function(a){this.onCompleteCallbacks.push(a)},Mesh.prototype.checkComplete=function(){var a=this;this.onCompleteCallbacks.length&&this.primitives.length==this.loadedGeometry&&(this.onCompleteCallbacks.forEach(function(b){b(a)}),this.onCompleteCallbacks=[])},Mesh.prototype.attachToNode=function(a){var b=this;this.primitives.forEach(function(c){var d=c.material,e=d.params;if(d instanceof THREE.Material||(d=createShaderMaterial(d)),!b.skin){var f=new THREE.Mesh(c.geometry.geometry,d);if(f.castShadow=!0,a.add(f),d instanceof THREE.ShaderMaterial){var g=new THREE.glTFShader(d,e,f,theLoader.rootObj);THREE.glTFShaders.add(g)}}})};var Material=function(a){this.params=a},AnimationParameterDelegate=function(){};AnimationParameterDelegate.prototype.handleError=function(a,b){console.log("ERROR(AnimationParameterDelegate):"+a+":"+b)},AnimationParameterDelegate.prototype.convert=function(a,b){var c=b.parameter,d=null;switch(c.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":d=new Float32Array(a,0,c.count*componentsPerElementForGLType(c.type))}return d},AnimationParameterDelegate.prototype.resourceAvailable=function(a,b){var c=b.animation,d=b.parameter;return d.data=a,c.handleParameterLoaded(d),!0};var animationParameterDelegate=new AnimationParameterDelegate,AnimationParameterContext=function(a,b){this.parameter=a,this.animation=b},Animation=function(){this.totalParameters=0,this.loadedParameters=0,this.parameters={},this.finishedLoading=!1,this.onload=null};Animation.prototype.constructor=Animation,Animation.prototype.handleParameterLoaded=function(a){this.parameters[a.name]=a,this.loadedParameters++,this.checkFinished()},Animation.prototype.checkFinished=function(){this.loadedParameters===this.totalParameters&&(this.finishedLoading=!0,this.onload&&this.onload())};var InverseBindMatricesDelegate=function(){};InverseBindMatricesDelegate.prototype.handleError=function(a,b){console.log("ERROR(InverseBindMatricesDelegate):"+a+":"+b)},InverseBindMatricesDelegate.prototype.convert=function(a,b){var c=b.parameter,d=null;switch(c.type){case"MAT4":d=new Float32Array(a,0,c.count*componentsPerElementForGLType(c.type))}return d},InverseBindMatricesDelegate.prototype.resourceAvailable=function(a,b){var c=b.skin;return c.inverseBindMatrices=a,!0};var inverseBindMatricesDelegate=new InverseBindMatricesDelegate,InverseBindMatricesContext=function(a,b){this.parameter=a,this.skin=b},ShaderDelegate=function(){};ShaderDelegate.prototype.handleError=function(a,b){console.log("ERROR(ShaderDelegate):"+a+":"+b)},ShaderDelegate.prototype.convert=function(a,b){return a},ShaderDelegate.prototype.resourceAvailable=function(a,b){return theLoader.shadersLoaded++,theLoader.shaders[b.id]=a,!0};var shaderDelegate=new ShaderDelegate,ShaderContext=function(a,b){this.id=a,this.uri=b},ResourceEntry=function(a,b,c){this.entryID=a,this.object=b,this.description=c},Resources=function(){this._entries={}};Resources.prototype.setEntry=function(a,b,c){return a?(this._entries[a]&&console.warn("entry["+a+"] is being overwritten"),void(this._entries[a]=new ResourceEntry(a,b,c))):void console.error("No EntryID provided, cannot store",c)},Resources.prototype.getEntry=function(a){return this._entries[a]},Resources.prototype.clearEntries=function(){this._entries={}},LoadDelegate=function(){},LoadDelegate.prototype.loadCompleted=function(a,b){a.call(Window,b)};var ThreeGLTFLoader=Object.create(glTFParser,{load:{enumerable:!0,value:function(a,b){this.resources=new Resources,this.cameras=[],this.lights=[],this.animations=[],this.joints={},THREE.GLTFLoaderUtils.init(),glTFParser.load.call(this,a,b)}},cameras:{enumerable:!0,writable:!0,value:[]},lights:{enumerable:!0,writable:!0,value:[]},animations:{enumerable:!0,writable:!0,value:[]},handleBuffer:{value:function(a,b,c){return this.resources.setEntry(a,null,b),b.type="ArrayBuffer",!0}},handleBufferView:{value:function(a,b,c){this.resources.setEntry(a,null,b);var d=this.resources.getEntry(b.buffer);b.type="ArrayBufferView";var e=this.resources.getEntry(a);return e.buffer=d,!0}},handleShader:{value:function(a,b,c){this.resources.setEntry(a,null,b);var d={id:a,uri:b.uri},e=new ShaderContext(a,b.uri);return theLoader.shadersRequested++,THREE.GLTFLoaderUtils.getFile(d,shaderDelegate,e),!0}},handleProgram:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},handleTechnique:{value:function(a,b,c){return b.refCount=0,this.resources.setEntry(a,null,b),!0}},createShaderParams:{value:function(a,b,c,d,e){var f=this.resources.getEntry(d);if(c.uniforms={},c.attributes={},c.program=f,c.technique=e,f){c.fragmentShader=f.description.fragmentShader,c.vertexShader=f.description.vertexShader;for(var g in e.uniforms){var h,i,j=e.uniforms[g],k=e.parameters[j],l=k.type,m=k.count,n=b[j],o="";switch(l){case WebGLRenderingContext.FLOAT:if(o="f",h=k.value,"transparency"==j){var p=!0,q=p?n:1-n;h=q,c.transparent=!0}break;case WebGLRenderingContext.FLOAT_VEC2:if(o="v2",h=new THREE.Vector2,k&&k.value){var r=k.value;h.fromArray(r)}n&&h.fromArray(n);break;case WebGLRenderingContext.FLOAT_VEC3:if(o="v3",h=new THREE.Vector3,k&&k.value){var s=k.value;h.fromArray(s)}n&&h.fromArray(n);break;case WebGLRenderingContext.FLOAT_VEC4:if(o="v4",h=new THREE.Vector4,k&&k.value){var t=k.value;h.fromArray(t)}n&&h.fromArray(n);break;case WebGLRenderingContext.FLOAT_MAT2:console.log("Warning: FLOAT_MAT2");break;case WebGLRenderingContext.FLOAT_MAT3:if(o="m3",h=new THREE.Matrix3,k&&k.value){var u=k.value;h.fromArray(u)}n&&h.fromArray(n);break;case WebGLRenderingContext.FLOAT_MAT4:if(void 0!==m){o="m4v",h=new Array(m);for(var v=0;v<m;v++)h[v]=new THREE.Matrix4;if(i=m,k&&k.value){var w=k.value;h.fromArray(w)}n&&h.fromArray(n)}else{if(o="m4",h=new THREE.Matrix4,k&&k.value){var x=k.value;h.fromArray(x)}n&&h.fromArray(n)}break;case WebGLRenderingContext.SAMPLER_2D:o="t",h=n?CreateTexture(this.resources,n):null;break;default:throw new Error("Unknown shader uniform param type: "+l+" - "+theLoader.idx[l])}var y={type:o,value:h,length:i};c.uniforms[g]=y}for(var z in e.attributes){var j=e.attributes[z],A=e.parameters[j],B=A.type,C=A.semantic,D={type:B,semantic:C};c.attributes[z]=D}}}},threeJSMaterialType:{value:function(a,b,c){var d,e=b.extensions,f=e?e.KHR_materials_common:null,g=null;if(f){switch(f.technique){case"BLINN":case"PHONG":g=THREE.MeshPhongMaterial;break;case"LAMBERT":g=THREE.MeshLambertMaterial;break;case"CONSTANT":default:g=THREE.MeshBasicMaterial}f.doubleSided&&(c.side=THREE.DoubleSide),f.transparent&&(c.transparent=!0),d={};for(prop in f.values)d[prop]=f.values[prop]}else{var h=b.technique?this.resources.getEntry(b.technique):null;d=b.values;var i=h.description;++i.refCount>1;var j=i.program;this.createShaderParams(a,d,c,j,i);var k=!0;k&&(g=Material)}d.diffuse&&"string"==typeof d.diffuse&&(c.map=CreateTexture(this.resources,d.diffuse)),d.reflective&&"string"==typeof d.reflective&&(c.envMap=CreateTexture(this.resources,d.reflective));var l=d.shininesss||d.shininess;l&&(l=l);var m=null;c.map||(m=d.diffuse);var n=1;if(d.hasOwnProperty("transparency")){var o=!0;n=o?d.transparency:1-d.transparency}return c.color=RgbArraytoHex(m),c.opacity=n,c.transparent=n<1,c.map&&c.map.sourceFile.toLowerCase().indexOf(".png")!=-1&&(c.transparent=!0),void 0!==l&&(c.shininess=Math.max(l,1e-4)),delete c.ambient,void 0!==d.ambient&&"string"!=typeof d.ambient,void 0!==d.emission&&(c.emissive=RgbArraytoHex(d.emission)),void 0!==d.specular&&(c.specular=RgbArraytoHex(d.specular)),g}},handleMaterial:{value:function(a,b,c){var d={},e=this.threeJSMaterialType(a,b,d),f=new e(d);return this.resources.setEntry(a,f,b),!0}},handleMesh:{value:function(a,b,c){var d=new Mesh;this.resources.setEntry(a,d,b);var e=b.primitives;if(!e)return console.log("MISSING_PRIMITIVES for mesh:"+a),!1;for(var f=0;f<e.length;f++){var g=e[f];if(g.mode===WebGLRenderingContext.TRIANGLES){var h=new ClassicGeometry,i=this.resources.getEntry(g.material);d.addPrimitive(h,i.object);var j=Object.keys(g.attributes);j.forEach(function(a){h.totalAttributes++},this);var k=this.resources.getEntry(g.indices),l=this.resources.getEntry(k.description.bufferView),m={bufferView:l,byteOffset:k.description.byteOffset,count:k.description.count,id:k.entryID,componentType:k.description.componentType,type:k.description.type},n=new IndicesContext(m,h),o={indicesObject:m,indicesDelegate:indicesDelegate,indicesContext:n};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.indicesObject,a.indicesDelegate,a.indicesContext);b&&a.indicesDelegate.resourceAvailable(b,a.indicesContext)},o),j.forEach(function(a){var c,d=g.attributes[a],e=this.resources.getEntry(d);if(e){c=e.object,c.id=d;var f=this.resources.getEntry(c.bufferView)}else{c=b.attributes[d],c.id=d,this.resources.setEntry(d,c,c);var f=this.resources.getEntry(c.bufferView);e=this.resources.getEntry(d)}var i={bufferView:f,byteOffset:c.byteOffset,byteStride:c.byteStride,count:c.count,max:c.max,min:c.min,componentType:c.componentType,type:c.type,id:d},j=new VertexAttributeContext(i,a,h),k={attributeObject:i,vertexAttributeDelegate:vertexAttributeDelegate,attribContext:j};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.attributeObject,a.vertexAttributeDelegate,a.attribContext);b&&a.vertexAttributeDelegate.resourceAvailable(b,a.attribContext)},k)},this)}}return!0}},handleCamera:{value:function(a,b,c){var d;if("perspective"==b.type){var e=b.perspective.znear,f=b.perspective.zfar,g=b.perspective.yfov,h=b.perspective.xfov,i=b.perspective.aspect_ratio;i||(i=1),void 0===h&&g&&(h=g*i),void 0===g&&h&&(g=h/i),h&&(h=THREE.Math.radToDeg(h),d=new THREE.PerspectiveCamera(h,i,e,f))}else d=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e,f);return d&&this.resources.setEntry(a,d,b),!0}},handleLight:{value:function(a,b,c){var d=null,e=b.type;if(e&&b[e]){var f=b[e],g=RgbArraytoHex(f.color);switch(e){case"directional":d=new THREE.DirectionalLight(g),d.position.set(0,0,1);break;case"point":d=new THREE.PointLight(g);break;case"spot ":d=new THREE.SpotLight(g),d.position.set(0,0,1);break;case"ambient":d=new THREE.AmbientLight(g)}}return d&&this.resources.setEntry(a,d,b),!0}},addPendingMesh:{value:function(a,b){theLoader.pendingMeshes.push({mesh:a,node:b})}},handleNode:{value:function(a,b,c){var d=null;b.jointName?(d=new THREE.Bone,d.jointName=b.jointName,this.joints[b.jointName]=a):d=new THREE.Object3D,d.name=b.name,d.glTFID=a,d.glTF=b,this.resources.setEntry(a,d,b);var e=b.matrix;if(e)d.matrixAutoUpdate=!1,d.applyMatrix((new THREE.Matrix4).set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]));else{var f=b.translation,g=b.rotation,h=b.scale,i=f?new THREE.Vector3(f[0],f[1],f[2]):new THREE.Vector3,j=g?new THREE.Quaternion(g[0],g[1],g[2],g[3]):new THREE.Quaternion,k=h?new THREE.Vector3(h[0],h[1],h[2]):new THREE.Vector3(1,1,1),l=new THREE.Matrix4;l.compose(i,j,k),d.matrixAutoUpdate=!1,d.applyMatrix(l)}var m=this;if(b.meshes){b.meshInstances={};var n;b.skin&&(n=this.resources.getEntry(b.skin)),b.meshes.forEach(function(a){meshEntry=this.resources.getEntry(a),theLoader.meshesRequested++,meshEntry.object.onComplete(function(c){m.addPendingMesh(c,d),b.meshInstances[a]=meshEntry.object,n&&(c.skin=n,b.instanceSkin=n.object),theLoader.meshesLoaded++,theLoader.checkComplete()})},this)}if(b.camera){var o=this.resources.getEntry(b.camera);o&&(d.add(o.object),this.cameras.push(o.object))}if(b.extensions&&b.extensions.KHR_materials_common&&b.extensions.KHR_materials_common.light){var p=b.extensions.KHR_materials_common.light,q=this.resources.getEntry(p);q&&(d.add(q.object),this.lights.push(q.object))}return!0}},handleExtension:{value:function(a,b,c){switch(a){case"KHR_materials_common":var d=b.lights;for(lightID in d){var e=d[lightID];this.handleLight(lightID,e)}}return!0}},buildNodeHirerachy:{value:function(a,b){var c=this.resources.getEntry(a),d=c.object;b.add(d);var e=c.description.children;return e&&e.forEach(function(a){this.buildNodeHirerachy(a,d)},this),d}},buildSkin:{value:function(a){var b=a.glTF,c=b.instanceSkin,d=b.skeletons;c&&d.forEach(function(d){var e=this.resources.getEntry(d);if(e){var f=e.object;a.add(f);var g=!0;for(meshID in b.meshInstances){var h=b.meshInstances[meshID],i=null;h.primitives.forEach(function(b){var e=b.material,f=e.params;e instanceof THREE.Material||(e=createShaderMaterial(e)),i=new THREE.SkinnedMesh(b.geometry.geometry,e,!1);b.geometry.geometry;if(i&&g){e.skinning=!0;var h,j=c.jointNames,k=[],l=[],m=[],n=j.length;for(h=0;h<n;h++){var o=j[h],p=this.joints[o],q=this.resources.getEntry(p).object;if(q){q.skin=i,k.push(q),l.push(q);var r=c.inverseBindMatrices,s=(new THREE.Matrix4).set(r[16*h+0],r[16*h+4],r[16*h+8],r[16*h+12],r[16*h+1],r[16*h+5],r[16*h+9],r[16*h+13],r[16*h+2],r[16*h+6],r[16*h+10],r[16*h+14],r[16*h+3],r[16*h+7],r[16*h+11],r[16*h+15]);m.push(s)}else console.log("WARNING: jointName:"+o+" cannot be found in skeleton:"+d)}i.bind(new THREE.Skeleton(l,m,!1),c.bindShapeMatrix)}if(i&&(i.castShadow=!0,a.add(i),e instanceof THREE.ShaderMaterial)){f.joints=k;var t=new THREE.glTFShader(e,f,i,theLoader.rootObj);THREE.glTFShaders.add(t)}},this)}}},this)}},buildSkins:{value:function(a){a.glTF&&a.glTF.instanceSkin&&this.buildSkin(a);var b=a.children;b&&b.forEach(function(a){this.buildSkins(a)},this)}},createMeshAnimations:{value:function(a){this.buildSkins(a)}},handleScene:{value:function(a,b,c){return b.nodes?(b.nodes.forEach(function(a){this.buildNodeHirerachy(a,c.rootObj)},this),this.delegate&&this.delegate.loadCompleted(c.callback,c.rootObj),theLoader.loadAllAssets(),!0):(console.log("ERROR: invalid file required nodes property is missing from scene"),!1)}},handleImage:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},addNodeAnimationChannel:{value:function(a,b,c){this.nodeAnimationChannels||(this.nodeAnimationChannels={}),this.nodeAnimationChannels[a]||(this.nodeAnimationChannels[a]=[]),this.nodeAnimationChannels[a].push(c)}},createAnimations:{value:function(){for(var a in this.nodeAnimationChannels){var b=this.nodeAnimationChannels[a],c=(b.length,new THREE.glTFAnimation(b));c.name="animation_"+a,this.animations.push(c)}}},buildAnimation:{value:function(a){var b,c=[],d=a.channels.length;for(b=0;b<d;b++){var e=a.channels[b],f=a.samplers[e.sampler];if(f){var g=a.parameters[f.input];if(g&&g.data){var h=a.parameters[f.output];if(h&&h.data){var i=e.target,j=this.resources.getEntry(i.id);if(j){var k=i.path,l={keys:g.data,values:h.data,count:g.count,target:j.object,path:k,type:f.interpolation};this.addNodeAnimationChannel(i.id,e,l),c.push(l)}}}}}}},handleAnimation:{value:function(a,b,c){theLoader.animationsRequested++;var d=new Animation;d.name=a,d.onload=function(){theLoader.animationsLoaded++,theLoader.animations.push(d),theLoader.checkComplete()},d.channels=b.channels,d.samplers=b.samplers,this.resources.setEntry(a,d,b);var e=b.parameters;if(!e)return console.log("MISSING_PARAMETERS for animation:"+a),!1;var f=Object.keys(e);f.forEach(function(a){d.totalParameters++},this);var f=Object.keys(e);return f.forEach(function(a){var b=e[a],c=this.resources.getEntry(b);c=c.object;var f=this.resources.getEntry(c.bufferView),g={bufferView:f,byteOffset:c.byteOffset,count:c.count,componentType:c.componentType,type:c.type,id:c.bufferView,name:a},h=new AnimationParameterContext(g,d),i={paramObject:g,animationParameterDelegate:animationParameterDelegate,paramContext:h};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.paramObject,a.animationParameterDelegate,a.paramContext);b&&a.animationParameterDelegate.resourceAvailable(b,a.paramContext)},i)},this),!0}},handleAccessor:{value:function(a,b,c){return this.resources.setEntry(a,b,b),!0}},handleSkin:{value:function(a,b,c){var d={},e=b.bindShapeMatrix;d.bindShapeMatrix=(new THREE.Matrix4).set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]),d.jointNames=b.jointNames;var f=this.resources.getEntry(b.inverseBindMatrices);f=f.description,d.inverseBindMatricesDescription=f,d.inverseBindMatricesDescription.id=b.inverseBindMatrices;var g=this.resources.getEntry(f.bufferView),h={bufferView:g,byteOffset:f.byteOffset,count:f.count,componentType:f.componentType,type:f.type,id:f.bufferView,name:d.inverseBindMatricesDescription.id},i=new InverseBindMatricesContext(h,d),j={paramObject:h,inverseBindMatricesDelegate:inverseBindMatricesDelegate,context:i};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.paramObject,a.inverseBindMatricesDelegate,a.context);b&&a.inverseBindMatricesDelegate.resourceAvailable(b,a.context)},j);var k=this.resources.getEntry(d.inverseBindMatricesDescription.bufferView);return d.inverseBindMatricesDescription.bufferView=k.object,this.resources.setEntry(a,d,b),!0}},handleSampler:{value:function(a,b,c){return this.resources.setEntry(a,b,b),!0}},handleTexture:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},handleError:{value:function(a){throw new Error(a)}},_delegate:{value:new LoadDelegate,writable:!0},delegate:{enumerable:!0,get:function(){return this._delegate},set:function(a){this._delegate=a}}}),Context=function(a,b){this.rootObj=a,this.callback=b},rootObj=new THREE.Object3D,self=this,loader=Object.create(ThreeGLTFLoader);return loader.initWithPath(url),loader.load(new Context(rootObj,function(a){}),null),this.loader=loader,this.callback=callback,this.rootObj=rootObj,rootObj},THREE.glTFLoader.prototype.scheduleLoad=function(a,b){this.loadRequests.push({fn:a,data:b})},THREE.glTFLoader.prototype.loadAllAssets=function(){for(var a=0,b=this.loadRequests.length;a<b;a++){var c=this.loadRequests[a];c.fn(c.data)}},THREE.glTFLoader.prototype.callLoadedCallback=function(){var a={scene:this.rootObj,cameras:this.loader.cameras,animations:this.loader.animations,shaders:this.loader.shaders};this.callback(a)},THREE.glTFLoader.prototype.checkComplete=function(){if(this.meshesLoaded==this.meshesRequested&&this.shadersLoaded==this.shadersRequested&&this.animationsLoaded==this.animationsRequested){for(var a=0;a<this.pendingMeshes.length;a++){var b=this.pendingMeshes[a];b.mesh.attachToNode(b.node)}for(var a=0;a<this.animationsLoaded;a++){var c=this.animations[a];this.loader.buildAnimation(c)}this.loader.createAnimations(),this.loader.createMeshAnimations(this.rootObj),THREE.glTFShaders.bindShaderParameters(this.rootObj),this.callLoadedCallback()}},THREE.GLTFLoaderUtils=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(a){return!!this._resources[a]}},_storeResource:{enumerable:!1,value:function(a,b){return a?(this._containsResource[a]&&console.log("WARNING: resource:"+a+" is already stored, overriding"),void(this._resources[a]=b)):void console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(a){return this._resources[a]}},_loadStream:{value:function(a,b,c){function d(a,b){var c=decodeURIComponent(b);return a?atob(c):c}function e(a,b){for(var c=d(a,b),e=new ArrayBuffer(c.length),f=new Uint8Array(e),g=0;g<c.length;g++)f[g]=c.charCodeAt(g);return e}function f(a,b){b="undefined"!=typeof b?b:"";var c=a[1],f=!!a[2],g=a[3];switch(b){case"":case"text":return d(f,g);case"ArrayBuffer":return e(f,g);case"blob":var h=e(f,g);return new Blob([h],{type:c});case"document":var i=new DOMParser;return i.parseFromString(d(f,g),c);case"json":return JSON.parse(d(f,g));default:throw"Unhandled responseType: "+b}}var g=/^data:(.*?)(;base64)?,(.*)$/,h=g.exec(a);if(null!==h)return void c.streamAvailable(a,f(h,b));if(!b)return void c.handleError(THREE.GLTFLoaderUtils.INVALID_TYPE,null);if(!a)return void c.handleError(THREE.GLTFLoaderUtils.INVALID_PATH);var i=new XMLHttpRequest;i.open("GET",a,!0),i.responseType=b===this.ARRAY_BUFFER?"arraybuffer":"text",i.onload=function(b){200==i.status||206==i.status?c.streamAvailable(a,i.response):c.handleError(THREE.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},i.send(null)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(a){var b=this._resourcesStatus[a.id];b?this._resourcesStatus[a.id]++:this._resourcesStatus[a.id]=1;var c=this._streamsStatus[a.uri];if(c&&"loading"===c.status)return void c.requests.push(a);this._streamsStatus[a.uri]={status:"loading",requests:[a]};var d=this,e={};e.streamAvailable=function(a,b){var c=d._streamsStatus[a],e=c.requests;e.forEach(function(a){var c=b.slice(a.range[0],a.range[1]),e=a.delegate.convert(c,a.ctx);d._storeResource(a.id,e),a.delegate.resourceAvailable(e,a.ctx),--d._resourcesStatus[a.id]},this),delete d._streamsStatus[a]},e.handleError=function(b,c){a.delegate.handleError(b,c)},this._loadStream(a.uri,a.type,e)}},_elementSizeForGLType:{value:function(a,b){var c=0;switch(b){case"SCALAR":c=1;break;case"VEC2":c=2;break;case"VEC3":c=3;break;case"VEC4":c=4;break;case"MAT2":c=4;break;case"MAT3":c=9;break;case"MAT4":c=16}switch(a){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*c;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(a,b,c){var d=a.bufferView,e=d.buffer,f=a.byteOffset+d.description.byteOffset,g=[f,this._elementSizeForGLType(a.componentType,a.type)*a.count+f];
this._handleRequest({id:a.id,range:g,type:e.description.type,uri:e.description.uri,delegate:b,ctx:c},null)}},getBuffer:{value:function(a,b,c){this._getResource(a.id);return this._handleWrappedBufferViewResourceLoading(a,b,c),null}},getFile:{value:function(a,b,c){return a.delegate=b,a.ctx=c,this._handleRequest({id:a.id,uri:a.uri,range:[0],type:"text",delegate:b,ctx:c},null),null}}}),THREE.glTFAnimator=function(){var a=[];return{add:function(b){a.push(b)},remove:function(b){var c=a.indexOf(b);c!==-1&&a.splice(c,1)},update:function(){for(i=0;i<a.length;i++)a[i].update()}}}(),THREE.glTFAnimation=function(a){this.running=!1,this.loop=!1,this.duration=0,this.startTime=0,this.interps=[],a&&this.createInterpolators(a)},THREE.glTFAnimation.prototype.createInterpolators=function(a){var b,c=a.length;for(b=0;b<c;b++){var d=new THREE.glTFInterpolator(a[b]);this.interps.push(d),this.duration=Math.max(this.duration,d.duration)}},THREE.glTFAnimation.prototype.play=function(){this.running||(this.startTime=Date.now(),this.running=!0,THREE.glTFAnimator.add(this))},THREE.glTFAnimation.prototype.stop=function(){this.running=!1,THREE.glTFAnimator.remove(this)},THREE.glTFAnimation.prototype.update=function(){if(this.running){var a=Date.now(),b=(a-this.startTime)/1e3,c=b%this.duration,d=Math.floor(b/this.duration);if(d>=1&&!this.loop){this.running=!1;var e,f=this.interps.length;for(e=0;e<f;e++)this.interps[e].interp(this.duration);return void this.stop()}var e,f=this.interps.length;for(e=0;e<f;e++)this.interps[e].interp(c)}},THREE.glTFInterpolator=function(a){this.keys=a.keys,this.values=a.values,this.count=a.count,this.type=a.type,this.path=a.path,this.isRot=!1;var b=a.target;switch(b.updateMatrix(),b.matrixAutoUpdate=!0,this.targetNode=b,a.path){case"translation":this.target=b.position,this.originalValue=b.position.clone();break;case"rotation":this.target=b.quaternion,this.originalValue=b.quaternion.clone(),this.isRot=!0;break;case"scale":this.target=b.scale,this.originalValue=b.scale.clone()}this.duration=this.keys[this.count-1],this.vec1=new THREE.Vector3,this.vec2=new THREE.Vector3,this.vec3=new THREE.Vector3,this.quat1=new THREE.Quaternion,this.quat2=new THREE.Quaternion,this.quat3=new THREE.Quaternion},THREE.glTFInterpolator.prototype.interp=function(a){var b;if(a==this.keys[0])this.isRot?this.quat3.set(this.values[0],this.values[1],this.values[2],this.values[3]):this.vec3.set(this.values[0],this.values[1],this.values[2]);else if(a<this.keys[0])this.isRot?(this.quat1.set(this.originalValue.x,this.originalValue.y,this.originalValue.z,this.originalValue.w),this.quat2.set(this.values[0],this.values[1],this.values[2],this.values[3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,a/this.keys[0])):(this.vec3.set(this.originalValue.x,this.originalValue.y,this.originalValue.z),this.vec2.set(this.values[0],this.values[1],this.values[2]),this.vec3.lerp(this.vec2,a/this.keys[0]));else if(a>=this.keys[this.count-1])this.isRot?this.quat3.set(this.values[4*(this.count-1)],this.values[4*(this.count-1)+1],this.values[4*(this.count-1)+2],this.values[4*(this.count-1)+3]):this.vec3.set(this.values[3*(this.count-1)],this.values[3*(this.count-1)+1],this.values[3*(this.count-1)+2]);else for(b=0;b<this.count-1;b++){var c=this.keys[b],d=this.keys[b+1];a>=c&&a<=d&&(this.isRot?(this.quat1.set(this.values[4*b],this.values[4*b+1],this.values[4*b+2],this.values[4*b+3]),this.quat2.set(this.values[4*(b+1)],this.values[4*(b+1)+1],this.values[4*(b+1)+2],this.values[4*(b+1)+3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,(a-c)/(d-c))):(this.vec3.set(this.values[3*b],this.values[3*b+1],this.values[3*b+2]),this.vec2.set(this.values[3*(b+1)],this.values[3*(b+1)+1],this.values[3*(b+1)+2]),this.vec3.lerp(this.vec2,(a-c)/(d-c))))}this.target&&this.copyValue(this.target)},THREE.glTFInterpolator.prototype.copyValue=function(a){this.isRot?a.copy(this.quat3):a.copy(this.vec3)},THREE.glTFShaders=function(){var a=[];return{add:function(b){a.push(b)},remove:function(b){var c=a.indexOf(b);c!==-1&&a.splice(c,1)},removeAll:function(b){a=[]},bindShaderParameters:function(b){for(i=0;i<a.length;i++)a[i].bindParameters(b)},update:function(b,c){for(i=0;i<a.length;i++)a[i].update(b,c)}}}(),THREE.glTFShader=function(a,b,c,d){this.material=a,this.parameters=b.technique.parameters,this.uniforms=b.technique.uniforms,this.joints=b.joints,this.object=c,this.semantics={},this.m4=new THREE.Matrix4},THREE.glTFShader.prototype.bindParameters=function(a){function b(a,b){a.glTFID==e.node&&(b.sourceObject=a)}for(var c in this.uniforms){var d=this.uniforms[c],e=this.parameters[d];if(e.semantic){var f={semantic:e.semantic,uniform:this.material.uniforms[c]};e.node?a.traverse(function(a){b(a,f)}):f.sourceObject=this.object,this.semantics[d]=f}}},THREE.glTFShader.prototype.update=function(a,b){a.updateMatrixWorld(),b.updateMatrixWorld(),b.matrixWorldInverse.getInverse(b.matrixWorld);for(var c in this.semantics){var d=this.semantics[c];if(d)switch(d.semantic){case"MODELVIEW":var e=d.uniform.value;e.multiplyMatrices(b.matrixWorldInverse,d.sourceObject.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var f=d.uniform.value;this.m4.multiplyMatrices(b.matrixWorldInverse,d.sourceObject.matrixWorld),f.getNormalMatrix(this.m4);break;case"PROJECTION":var e=d.uniform.value;e.copy(b.projectionMatrix);break;case"JOINTMATRIX":for(var g=d.uniform.value,h=0;h<g.length;h++)g[h].getInverse(d.sourceObject.matrixWorld).multiply(this.joints[h].matrixWorld).multiply(this.object.skeleton.boneInverses[h]);break;default:throw new Error("Unhandled shader semantic"+d)}}};var WebTundraGltfWrapper={Parser:glTFParser,Loader:THREE.glTFLoader,LoaderUtils:THREE.GLTFLoaderUtils,Animation:THREE.glTFAnimation,Animator:THREE.glTFAnimator,Shaders:THREE.glTFShaders},GltfAsset=IAsset.$extend({__init__:function(a){this.$super(a,"GltfAsset"),this.requiresCloning=!0,this.mesh=void 0},_cloneImpl:function(a){var b=new GltfAsset(a);return b.mesh=this.mesh.clone(),b},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:void 0},isLoaded:function(){return void 0!==this.mesh},deserializeFromData:function(a,b,c){try{this.load(c.proxyRef||c.ref,function(a){this.mesh=a.scene,this._emitLoaded()}.bind(this))}catch(d){return!1}},load:function(a,b){var c=new WebTundraGltfWrapper.Loader;c.load(a,b)}}),AnimationProviderAsset=IAsset.$extend({__classvars__:{Type:{SkinnedMesh:0,KeyFrame:1}},__init__:function(a,b,c){this.$super(a,b),this.providesAnimations=!0,this.animationHierarchy={},this.animationType=c},getAvailableAnimations:function(){return Object.keys(this.animationHierarchy)},hasAnimation:function(a){return void 0!==this.animationHierarchy[a]},getAnimation:function(a){if(!this.isAttached())return this.log.error("Cannot get animation, skeleton",this.name,"not attached."),null;var b=this.animationHierarchy[a];return void 0===b?(this.log.error("Could not find animation",a,"for playback in",this.name,". See getAvailableAnimations() for available animation names."),null):b}});THREE.Animation=function(a,b){this.root=a,this.data=THREE.AnimationHandler.init(b),this.hierarchy=THREE.AnimationHandler.parse(a),this.currentTime=0,this.timeScale=1,this.isPlaying=!1,this.loop=!0,this.weight=0,this.interpolationType=THREE.AnimationHandler.LINEAR},THREE.Animation.prototype={constructor:THREE.Animation,keyTypes:["pos","rot","scl"],play:function(a,b){this.currentTime=void 0!==a?a:0,this.weight=void 0!==b?b:1,this.isPlaying=!0,this.reset(),THREE.AnimationHandler.play(this)},stop:function(){this.isPlaying=!1,THREE.AnimationHandler.stop(this)},reset:function(){for(var a=0,b=this.hierarchy.length;a<b;a++){var c=this.hierarchy[a];void 0===c.animationCache&&(c.animationCache={animations:{},blending:{positionWeight:0,quaternionWeight:0,scaleWeight:0}});var d=this.data.name,e=c.animationCache.animations,f=e[d];void 0===f&&(f={prevKey:{pos:0,rot:0,scl:0},nextKey:{pos:0,rot:0,scl:0},originalMatrix:c.matrix},e[d]=f);for(var g=0;g<3;g++){for(var h=this.keyTypes[g],i=this.data.hierarchy[a].keys[0],j=this.getNextKeyWith(h,a,1);j.time<this.currentTime&&j.index>i.index;)i=j,j=this.getNextKeyWith(h,a,j.index+1);f.prevKey[h]=i,f.nextKey[h]=j}}},resetBlendWeights:function(){for(var a=0,b=this.hierarchy.length;a<b;a++){var c=this.hierarchy[a],d=c.animationCache;if(void 0!==d){var e=d.blending;e.positionWeight=0,e.quaternionWeight=0,e.scaleWeight=0}}},update:function(){var a=[],b=new THREE.Vector3,c=new THREE.Vector3,d=new THREE.Quaternion,e=function(a,b){var c,d,e,g,h,i,j,k,l,m=[],n=[];return c=(a.length-1)*b,d=Math.floor(c),e=c-d,m[0]=0===d?d:d-1,m[1]=d,m[2]=d>a.length-2?d:d+1,m[3]=d>a.length-3?d:d+2,i=a[m[0]],j=a[m[1]],k=a[m[2]],l=a[m[3]],g=e*e,h=e*g,n[0]=f(i[0],j[0],k[0],l[0],e,g,h),n[1]=f(i[1],j[1],k[1],l[1],e,g,h),n[2]=f(i[2],j[2],k[2],l[2],e,g,h),n},f=function(a,b,c,d,e,f,g){var h=.5*(c-a),i=.5*(d-b);return(2*(b-c)+h+i)*g+(-3*(b-c)-2*h-i)*f+h*e+b};return function(f){if(this.isPlaying!==!1&&(this.currentTime+=f*this.timeScale,0!==this.weight)){var g=this.data.length;(this.currentTime>g||this.currentTime<0)&&(this.loop?(this.currentTime%=g,this.currentTime<0&&(this.currentTime+=g),this.reset()):this.stop());for(var h=0,i=this.hierarchy.length;h<i;h++)for(var j=this.hierarchy[h],k=j.animationCache.animations[this.data.name],l=j.animationCache.blending,m=0;m<3;m++){var n=this.keyTypes[m],o=k.prevKey[n],p=k.nextKey[n];if(this.timeScale>0&&p.time<=this.currentTime||this.timeScale<0&&o.time>=this.currentTime){for(o=this.data.hierarchy[h].keys[0],p=this.getNextKeyWith(n,h,1);p.time<this.currentTime&&p.index>o.index;)o=p,p=this.getNextKeyWith(n,h,p.index+1);k.prevKey[n]=o,k.nextKey[n]=p}var q=(this.currentTime-o.time)/(p.time-o.time),r=o[n],s=p[n];if(q<0&&(q=0),q>1&&(q=1),"pos"===n){if(this.interpolationType===THREE.AnimationHandler.LINEAR){c.x=r[0]+(s[0]-r[0])*q,c.y=r[1]+(s[1]-r[1])*q,c.z=r[2]+(s[2]-r[2])*q;var t=this.weight/(this.weight+l.positionWeight);j.position.lerp(c,t),l.positionWeight+=this.weight}else if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){a[0]=this.getPrevKeyWith("pos",h,o.index-1).pos,a[1]=r,a[2]=s,a[3]=this.getNextKeyWith("pos",h,p.index+1).pos,q=.33*q+.33;var u=e(a,q),t=this.weight/(this.weight+l.positionWeight);l.positionWeight+=this.weight;var v=j.position;if(v.x=v.x+(u[0]-v.x)*t,v.y=v.y+(u[1]-v.y)*t,v.z=v.z+(u[2]-v.z)*t,this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){var w=e(a,1.01*q);b.set(w[0],w[1],w[2]),b.sub(v),b.y=0,b.normalize();var x=Math.atan2(b.x,b.z);j.rotation.set(0,x,0)}}}else if("rot"===n)if(THREE.Quaternion.slerp(r,s,d,q),0===l.quaternionWeight)j.quaternion.copy(d),l.quaternionWeight=this.weight;else{var t=this.weight/(this.weight+l.quaternionWeight);THREE.Quaternion.slerp(j.quaternion,d,j.quaternion,t),l.quaternionWeight+=this.weight}else if("scl"===n){c.x=r[0]+(s[0]-r[0])*q,c.y=r[1]+(s[1]-r[1])*q,c.z=r[2]+(s[2]-r[2])*q;var t=this.weight/(this.weight+l.scaleWeight);j.scale.lerp(c,t),l.scaleWeight+=this.weight}}return!0}}}(),getNextKeyWith:function(a,b,c){var d=this.data.hierarchy[b].keys;for(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?c=c<d.length-1?c:d.length-1:c%=d.length;c<d.length;c++)if(void 0!==d[c][a])return d[c];return this.data.hierarchy[b].keys[0]},getPrevKeyWith:function(a,b,c){var d=this.data.hierarchy[b].keys;for(c=this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?c>0?c:0:c>=0?c:c+d.length;c>=0;c--)if(void 0!==d[c][a])return d[c];return this.data.hierarchy[b].keys[d.length-1]}},THREE.AnimationHandler={LINEAR:0,CATMULLROM:1,CATMULLROM_FORWARD:2,add:function(){console.warn("THREE.AnimationHandler.add() has been deprecated.")},get:function(){console.warn("THREE.AnimationHandler.get() has been deprecated.")},remove:function(){console.warn("THREE.AnimationHandler.remove() has been deprecated.")},animations:[],init:function(a){if(a.initialized===!0)return a;for(var b=0;b<a.hierarchy.length;b++){for(var c=0;c<a.hierarchy[b].keys.length;c++)if(a.hierarchy[b].keys[c].time<0&&(a.hierarchy[b].keys[c].time=0),void 0!==a.hierarchy[b].keys[c].rot&&!(a.hierarchy[b].keys[c].rot instanceof THREE.Quaternion)){var d=a.hierarchy[b].keys[c].rot;a.hierarchy[b].keys[c].rot=(new THREE.Quaternion).fromArray(d)}if(a.hierarchy[b].keys.length&&void 0!==a.hierarchy[b].keys[0].morphTargets){for(var e={},c=0;c<a.hierarchy[b].keys.length;c++)for(var f=0;f<a.hierarchy[b].keys[c].morphTargets.length;f++){var g=a.hierarchy[b].keys[c].morphTargets[f];e[g]=-1}a.hierarchy[b].usedMorphTargets=e;for(var c=0;c<a.hierarchy[b].keys.length;c++){var h={};for(var g in e){for(var f=0;f<a.hierarchy[b].keys[c].morphTargets.length;f++)if(a.hierarchy[b].keys[c].morphTargets[f]===g){h[g]=a.hierarchy[b].keys[c].morphTargetsInfluences[f];break}f===a.hierarchy[b].keys[c].morphTargets.length&&(h[g]=0)}a.hierarchy[b].keys[c].morphTargetsInfluences=h}}for(var c=1;c<a.hierarchy[b].keys.length;c++)a.hierarchy[b].keys[c].time===a.hierarchy[b].keys[c-1].time&&(a.hierarchy[b].keys.splice(c,1),c--);for(var c=0;c<a.hierarchy[b].keys.length;c++)a.hierarchy[b].keys[c].index=c}return a.initialized=!0,a},parse:function(a){var b=function(a,c){c.push(a);for(var d=0;d<a.children.length;d++)b(a.children[d],c)},c=[];if(a instanceof THREE.SkinnedMesh)for(var d=0;d<a.skeleton.bones.length;d++)c.push(a.skeleton.bones[d]);else b(a,c);return c},play:function(a){this.animations.indexOf(a)===-1&&this.animations.push(a)},stop:function(a){var b=this.animations.indexOf(a);b!==-1&&this.animations.splice(b,1)},update:function(a){for(var b=0;b<this.animations.length;b++)this.animations[b].resetBlendWeights();for(var b=0;b<this.animations.length;b++)this.animations[b].update(a)}},THREE.KeyFrameAnimation=function(a){this.root=a.node,this.data=THREE.AnimationHandler.init(a),this.hierarchy=THREE.AnimationHandler.parse(this.root),this.currentTime=0,this.timeScale=.001,this.isPlaying=!1,this.isPaused=!0,this.loop=!0;for(var b=0,c=this.hierarchy.length;b<c;b++){var d=this.data.hierarchy[b].keys,e=this.data.hierarchy[b].sids,f=this.hierarchy[b];if(d.length&&e){for(var g=0;g<e.length;g++){var h=e[g],i=this.getNextKeyWith(h,b,0);i&&i.apply(h)}f.matrixAutoUpdate=!1,this.data.hierarchy[b].node.updateMatrix(),f.matrixWorldNeedsUpdate=!0}}},THREE.KeyFrameAnimation.prototype={constructor:THREE.KeyFrameAnimation,play:function(a){if(this.currentTime=void 0!==a?a:0,this.isPlaying===!1){this.isPlaying=!0;var b,c,d,e=this.hierarchy.length;for(b=0;b<e;b++){c=this.hierarchy[b],d=this.data.hierarchy[b],void 0===d.animationCache&&(d.animationCache={},d.animationCache.prevKey=null,d.animationCache.nextKey=null,d.animationCache.originalMatrix=c.matrix);var f=this.data.hierarchy[b].keys;f.length>1&&(d.animationCache.prevKey=f[0],d.animationCache.nextKey=f[1],this.startTime=Math.min(f[0].time,this.startTime),this.endTime=Math.max(f[f.length-1].time,this.endTime))}this.update(0)}this.isPaused=!1},stop:function(){this.isPlaying=!1,this.isPaused=!1;for(var a=0;a<this.data.hierarchy.length;a++){var b=this.hierarchy[a],c=this.data.hierarchy[a];if(void 0!==c.animationCache){var d=c.animationCache.originalMatrix;d.copy(b.matrix),b.matrix=d,delete c.animationCache}}},update:function(a){if(this.isPlaying!==!1){this.currentTime+=a*this.timeScale;var b=this.data.length;this.loop===!0&&this.currentTime>b&&(this.currentTime%=b),this.currentTime=Math.min(this.currentTime,b);for(var c=0,d=this.hierarchy.length;c<d;c++){var e=this.hierarchy[c],f=this.data.hierarchy[c],g=f.keys,h=f.animationCache;if(g.length){var i=h.prevKey,j=h.nextKey;if(j.time<=this.currentTime){for(;j.time<this.currentTime&&j.index>i.index;)i=j,j=g[i.index+1];h.prevKey=i,h.nextKey=j}j.time>=this.currentTime?i.interpolate(j,this.currentTime):i.interpolate(j,j.time),this.data.hierarchy[c].node.updateMatrix(),e.matrixWorldNeedsUpdate=!0}}}},getNextKeyWith:function(a,b,c){var d=this.data.hierarchy[b].keys;for(c%=d.length;c<d.length;c++)if(d[c].hasTarget(a))return d[c];return d[0]},getPrevKeyWith:function(a,b,c){var d=this.data.hierarchy[b].keys;for(c=c>=0?c:c+d.length;c>=0;c--)if(d[c].hasTarget(a))return d[c];return d[d.length-1]}},THREE.ColladaLoader=function(){function a(a,c,d,e){var f=0;if(document.implementation&&document.implementation.createDocument){var g=new XMLHttpRequest;g.onreadystatechange=function(){4===g.readyState?0===g.status||200===g.status?g.response?(Ma=c,b(g.response,void 0,a)):e?e({type:"error",url:a}):console.error("ColladaLoader: Empty or non-existing file ("+a+")"):e?e({type:"error",url:a}):console.error("ColladaLoader: Couldn't load \""+a+'" ('+g.status+")"):3===g.readyState&&d&&(0===f&&(f=g.getResponseHeader("Content-Length")),d({total:f,loaded:g.responseText.length}))},g.open("GET",a,!0),g.send(null)}else alert("Don't know how to parse XML!")}function b(a,b,c){if(Ka=(new DOMParser).parseFromString(a,"text/xml"),b=b||Ma,void 0!==c){var i=c.split("/");i.pop(),Ha=(i.length<1?".":i.join("/"))+"/"}d(),ua(),Oa=e("library_images image",A,"image"),Sa=e("library_materials material",U,"material"),Ta=e("library_effects effect",Z,"effect"),Ra=e("library_geometries geometry",K,"geometry"),Ua=e("library_cameras camera",da,"camera"),Va=e("library_lights light",fa,"light"),Qa=e("library_controllers controller",B,"controller"),Pa=e("library_animations animation",_,"animation"),Fa=e("library_visual_scenes visual_scene",E,"visual_scene"),Ga=e("library_kinematics_models kinematics_model",ha,"kinematics_model"),Ia=[],Ja=[],Ba=f(),La=new THREE.Group;for(var j=0;j<Ba.nodes.length;j++)La.add(r(Ba.nodes[j]));La.scale.multiplyScalar(Ya),h(),Ca=g(),q();var k={scene:La,morphs:Ia,skins:Ja,animations:Da,kinematics:Ea,dae:{images:Oa,materials:Sa,cameras:Ua,lights:Va,effects:Ta,geometries:Ra,controllers:Qa,animations:Pa,visualScenes:Fa,visualScene:Ba,scene:Ba,kinematicsModels:Ga,kinematicsModel:Ca}};return b&&b(k),k}function c(a){Wa=a}function d(){var a=Ka.querySelectorAll("asset"),b=a[0];if(b&&b.childNodes)for(var c=0;c<b.childNodes.length;c++){var d=b.childNodes[c];switch(d.nodeName){case"unit":var e=d.getAttribute("meter");e&&(Ya=parseFloat(e));break;case"up_axis":Za=d.textContent.charAt(0)}}}function e(a,b,c){for(var d=Ka.querySelectorAll(a),e={},f=0,g=d.length,h=0;h<g;h++){var i=d[h],j=(new b).parse(i);j.id&&0!==j.id.length||(j.id=c+f++),e[j.id]=j}return e}function f(){var a=Ka.querySelectorAll("scene instance_visual_scene")[0];if(a){var b=a.getAttribute("url").replace(/^#/,"");return Fa[b.length>0?b:"visual_scene0"]}return null}function g(){var a=Ka.querySelectorAll("instance_kinematics_model")[0];if(a){var b=a.getAttribute("url").replace(/^#/,"");return Ga[b.length>0?b:"kinematics_model0"]}return null}function h(){Da=[],i(La)}function i(a){var b=Ba.getChildById(a.colladaId,!0),c=null;if(b&&b.keys){c={fps:60,hierarchy:[{node:b,keys:b.keys,sids:b.sids}],node:a,name:"animation_"+a.name,length:0},Da.push(c);for(var d=0,e=b.keys.length;d<e;d++)c.length=Math.max(c.length,b.keys[d].time)}else c={hierarchy:[{keys:[],sids:[]}]};for(var d=0,e=a.children.length;d<e;d++)for(var f=i(a.children[d]),g=0,h=f.hierarchy.length;g<h;g++)c.hierarchy.push({keys:[],sids:[]});return c}function j(){var a,b=1e6,c=-b,d=0;for(var e in Pa){var f=Pa[e];a=a||f.id;for(var g=0;g<f.sampler.length;g++){var h=f.sampler[g];h.create(),b=Math.min(b,h.startTime),c=Math.max(c,h.endTime),d=Math.max(d,h.input.length)}}return{start:b,end:c,frames:d,ID:a}}function k(a,b){var c=b instanceof H?Qa[b.url]:b;if(!c||!c.morph)return void console.log("could not find morph controller!");for(var d=c.morph,e=0;e<d.targets.length;e++){var f=d.targets[e],g=Ra[f];if(g.mesh&&g.mesh.primitives&&g.mesh.primitives.length){var h=g.mesh.primitives[0].geometry;h.vertices.length===a.vertices.length&&a.morphTargets.push({name:"target_1",vertices:h.vertices})}}a.morphTargets.push({name:"target_Z",vertices:a.vertices})}function l(a,b,c,d){if(a.world=a.world||new THREE.Matrix4,a.localworld=a.localworld||new THREE.Matrix4,a.world.copy(a.matrix),a.localworld.copy(a.matrix),a.channels&&a.channels.length){var e=a.channels[0],f=e.sampler.output[c];f instanceof THREE.Matrix4&&(a.world.copy(f),a.localworld.copy(f),0===c&&a.matrix.copy(f))}d&&a.world.multiplyMatrices(d,a.world),b.push(a);for(var g=0;g<a.nodes.length;g++)l(a.nodes[g],b,c,a.world)}function m(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=-1;if("JOINT"==d.type){for(var f=0;f<b.joints.length;f++)if(d.sid===b.joints[f]){e=f;break}if(e>=0){var g=b.invBindMatrices[e];d.invBindMatrix=g,d.skinningMatrix=new THREE.Matrix4,d.skinningMatrix.multiplyMatrices(d.world,g),d.animatrix=new THREE.Matrix4,d.animatrix.copy(d.localworld),d.weights=[];for(var f=0;f<b.weights.length;f++)for(var h=0;h<b.weights[f].length;h++){var i=b.weights[f][h];i.joint===e&&d.weights.push(i)}}else console.warn("ColladaLoader: Could not find joint '"+d.sid+"'."),d.skinningMatrix=new THREE.Matrix4,d.weights=[]}}}function n(a){var b=[],c=function(a,b,d){var e={};e.name=b.sid,e.parent=a,e.matrix=b.matrix;var f=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];e.matrix.decompose(f[0],f[1],f[2]),e.pos=[f[0].x,f[0].y,f[0].z],e.scl=[f[2].x,f[2].y,f[2].z],e.rotq=[f[1].x,f[1].y,f[1].z,f[1].w],d.push(e);for(var g in b.nodes)c(b.sid,b.nodes[g],d)};return c(-1,a,b),b}function o(a,b,c){var d=[];l(b,d,-1),m(d,c.skin);for(var e=new THREE.Vector3,f=[],g=0;g<a.vertices.length;g++)f.push(new THREE.Vector3);for(g=0;g<d.length;g++)if("JOINT"==d[g].type)for(var h=0;h<d[g].weights.length;h++){var i=d[g].weights[h],j=i.index,k=i.weight,n=a.vertices[j],o=f[j];e.x=n.x,e.y=n.y,e.z=n.z,e.applyMatrix4(d[g].skinningMatrix),o.x+=e.x*k,o.y+=e.y*k,o.z+=e.z*k}for(var g=0;g<a.vertices.length;g++)a.vertices[g]=f[g]}function p(a,b,c){var d=Qa[b.url];if(c=void 0!==c?c:40,!d||!d.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!b.skeleton||!b.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var e=j(),f=Ba.getChildById(b.skeleton[0],!0)||Ba.getChildBySid(b.skeleton[0],!0),g=n(f),h=d.skin.joints,i=[],k=0;k<h.length;k++)for(var p=0;p<g.length;p++)g[p].name===h[k]&&(i[k]=g[p]);for(var k=0;k<i.length;k++)for(var p=0;p<i.length;p++)i[k].parent===i[p].name&&(i[k].parent=p);var k,p,q;new THREE.Vector3;for(k=0;k<a.vertices.length;k++)a.vertices[k].applyMatrix4(d.skin.bindShapeMatrix);for(var r=[],s=[],t=d.skin.weights,k=0;k<t.length;k++){var u=new THREE.Vector4(t[k][0]?t[k][0].joint:0,t[k][1]?t[k][1].joint:0,t[k][2]?t[k][2].joint:0,t[k][3]?t[k][3].joint:0),q=new THREE.Vector4(t[k][0]?t[k][0].weight:0,t[k][1]?t[k][1].weight:0,t[k][2]?t[k][2].weight:0,t[k][3]?t[k][3].weight:0);r.push(u),s.push(q)}a.skinIndices=r,a.skinWeights=s,a.bones=i;for(var v={name:e.ID,fps:30,length:e.frames/30,hierarchy:[]},p=0;p<i.length;p++)v.hierarchy.push({parent:i[p].parent,name:i[p].name,keys:[]});for(console.log("ColladaLoader:",e.ID+" has "+i.length+" bones."),o(a,f,d),c=0;c<e.frames;c++){var w=[];l(f,w,c),m(w,d.skin);for(var k=0;k<w.length;k++)for(var p=0;p<v.hierarchy.length;p++)if(v.hierarchy[p].name===w[k].sid){var x={};x.time=c/30,x.matrix=w[k].animatrix,0===c&&(w[k].matrix=x.matrix);var y=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];x.matrix.decompose(y[0],y[1],y[2]),x.pos=[y[0].x,y[0].y,y[0].z],x.scl=[y[2].x,y[2].y,y[2].z],x.rot=y[1],v.hierarchy[p].keys.push(x)}a.animation=v}}function q(){if(Ca&&0===Ca.joints.length)return void(Ea=void 0);var a={},b=function(b,c){var d=c.getAttribute("id"),e=Ba.getChildById(d,!0),f=Ca.joints[b];La.traverse(function(c){c.colladaId==d&&(a[b]={node:c,transforms:e.transforms,joint:f,position:f.zeroPosition})})};Ea={joints:Ca&&Ca.joints,getJointValue:function(b){var c=a[b];return c?c.position:void console.log("getJointValue: joint "+b+" doesn't exist")},setJointValue:function(b,c){var e=a[b];if(e){var f=e.joint;if(c>f.limits.max||c<f.limits.min)console.log("setJointValue: joint "+b+" value "+c+" outside of limits (min: "+f.limits.min+", max: "+f.limits.max+")");else if(f.static)console.log("setJointValue: joint "+b+" is static");else{var g=e.node,h=f.axis,i=e.transforms,j=new THREE.Matrix4;for(d=0;d<i.length;d++){var k=i[d];if(k.sid&&k.sid.indexOf("joint"+b)!==-1)switch(f.type){case"revolute":j.multiply(l.makeRotationAxis(h,THREE.Math.degToRad(c)));break;case"prismatic":j.multiply(l.makeTranslation(h.x*c,h.y*c,h.z*c));break;default:console.warn("setJointValue: unknown joint type: "+f.type)}else{var l=new THREE.Matrix4;switch(k.type){case"matrix":j.multiply(k.obj);break;case"translate":j.multiply(l.makeTranslation(k.obj.x,k.obj.y,k.obj.z));break;case"rotate":j.multiply(l.makeRotationAxis(k.obj,k.angle))}}}var m=j.elements,n=Array.prototype.slice.call(m),o=[n[0],n[4],n[8],n[12],n[1],n[5],n[9],n[13],n[2],n[6],n[10],n[14],n[3],n[7],n[11],n[15]];g.matrix.set.apply(g.matrix,o),g.matrix.decompose(g.position,g.quaternion,g.scale)}}else console.log("setJointValue: joint "+b+" doesn't exist")}};var c=Ka.querySelector("scene instance_kinematics_scene");if(c)for(var d=0;d<c.childNodes.length;d++){var e=c.childNodes[d];if(1==e.nodeType)switch(e.nodeName){case"bind_joint_axis":var f=e.getAttribute("target").split("/").pop(),g=e.querySelector("axis param").textContent,h=parseInt(g.split("joint").pop().split(".")[0]),i=Ka.querySelector('[sid="'+f+'"]');if(i){var j=i.parentElement;b(h,j)}}}}function r(a,b){var c,d,e,f,g=new THREE.Object3D,h=!1;for(e=0;e<a.controllers.length;e++){var i=Qa[a.controllers[e].url];switch(i.type){case"skin":if(Ra[i.skin.source]){var j=new J;j.url=i.skin.source,j.instance_material=a.controllers[e].instance_material,a.geometries.push(j),h=!0,c=a.controllers[e]}else if(Qa[i.skin.source]){var l=Qa[i.skin.source];if(d=l,l.morph&&Ra[l.morph.source]){var j=new J;j.url=l.morph.source,j.instance_material=a.controllers[e].instance_material,a.geometries.push(j)}}break;case"morph":if(Ra[i.morph.source]){var j=new J;j.url=i.morph.source,j.instance_material=a.controllers[e].instance_material,a.geometries.push(j),d=a.controllers[e]}console.log("ColladaLoader: Morph-controller partially supported.")}}var m={};for(e=0;e<a.geometries.length;e++){var n,o=a.geometries[e],q=o.instance_material,s=Ra[o.url],t={},u=[],v=0;if(s){if(!s.mesh||!s.mesh.primitives)continue;if(0===g.name.length&&(g.name=s.id),q)for(f=0;f<q.length;f++){var w=q[f],x=Sa[w.target],y=x.instance_effect.url,z=Ta[y].shader,A=z.material;if(s.doubleSided){if(!(w.symbol in m)){var B=A.clone();B.side=THREE.DoubleSide,m[w.symbol]=B}A=m[w.symbol]}A.opacity=A.opacity?A.opacity:1,t[w.symbol]=v,u.push(A),n=A,n.name=null===x.name||""===x.name?x.id:x.name,v++}var C,D=n||new THREE.MeshLambertMaterial({color:14540253,side:s.doubleSided?THREE.DoubleSide:THREE.FrontSide}),E=s.mesh.geometry3js;if(v>1)for(D=new THREE.MultiMaterial(u),f=0;f<E.faces.length;f++){var F=E.faces[f];F.materialIndex=t[F.daeMaterial]}void 0!==c?(p(E,c),E.morphTargets.length>0?(D.morphTargets=!0,D.skinning=!1):(D.morphTargets=!1,D.skinning=!0),C=new THREE.SkinnedMesh(E,D,!1),C.name="skin_"+Ja.length,Ja.push(C)):void 0!==d?(k(E,d),D.morphTargets=!0,C=new THREE.Mesh(E,D),C.name="morph_"+Ia.length,Ia.push(C)):C=E.isLineStrip===!0?new THREE.Line(E):new THREE.Mesh(E,D),g.add(C)}}for(e=0;e<a.cameras.length;e++){var G=a.cameras[e],H=Ua[G.url],I=new THREE.PerspectiveCamera(H.yfov,parseFloat(H.aspect_ratio),parseFloat(H.znear),parseFloat(H.zfar));g.add(I)}for(e=0;e<a.lights.length;e++){var K=null,L=a.lights[e],M=Va[L.url];if(M&&M.technique){var N=M.color.getHex(),O=M.intensity,P=M.distance,Q=M.falloff_angle;switch(M.technique){case"directional":K=new THREE.DirectionalLight(N,O,P),K.position.set(0,0,1);break;case"point":K=new THREE.PointLight(N,O,P);break;case"spot":K=new THREE.SpotLight(N,O,P,Q),K.position.set(0,0,1);break;case"ambient":K=new THREE.AmbientLight(N)}}K&&g.add(K)}if(g.name=a.name||a.id||"",g.colladaId=a.id||"",g.layer=a.layer||"",g.matrix=a.matrix,g.matrix.decompose(g.position,g.quaternion,g.scale),Xa.centerGeometry&&g.geometry){var R=g.geometry.center();R.multiply(g.scale),R.applyQuaternion(g.quaternion),g.position.sub(R)}for(e=0;e<a.nodes.length;e++)g.add(r(a.nodes[e],a));return g}function s(a){for(var b=Ka.querySelectorAll("library_nodes node"),c=0;c<b.length;c++){var d=b[c].attributes.getNamedItem("id");if(d&&d.value===a)return b[c]}}function t(a){var b=[],c=1e6,d=-1e6;for(var e in Pa)for(var f=Pa[e],g=0;g<f.channel.length;g++){var h=f.channel[g],i=f.sampler[g],e=h.target.split("/")[0];e==a.id&&(i.create(),h.sampler=i,c=Math.min(c,i.startTime),d=Math.max(d,i.endTime),b.push(h))}return b.length&&(a.startTime=c,a.endTime=d),b}function u(a){if(a.channels&&a.channels.length){for(var b=[],c=[],d=0,e=a.channels.length;d<e;d++){var f,g=a.channels[d],h=g.fullSid,i=g.sampler,j=i.input,k=a.getTransformBySid(g.sid);if(g.arrIndices){f=[];for(var l=0,m=g.arrIndices.length;l<m;l++)f[l]=za(g.arrIndices[l])}else f=Aa(g.member);if(k){c.indexOf(h)===-1&&c.push(h);for(var l=0,m=j.length;l<m;l++){var n=j[l],o=i.getData(k.type,l,f),p=v(b,n);if(!p){p=new ca(n);var q=w(b,n);b.splice(q===-1?b.length:q,0,p)}p.addTarget(h,k,f,o)}}else console.log('Could not find transform "'+g.sid+'" in node '+a.id)}for(var d=0;d<c.length;d++)for(var r=c[d],l=0;l<b.length;l++){var p=b[l];p.hasTarget(r)||x(b,p,l,r)}a.keys=b,a.sids=c}}function v(a,b){for(var c=null,d=0,e=a.length;d<e&&null===c;d++){var f=a[d];if(f.time===b)c=f;else if(f.time>b)break}return c}function w(a,b){for(var c=-1,d=0,e=a.length;d<e&&c===-1;d++){var f=a[d];f.time>=b&&(c=d)}return c}function x(a,b,c,d){var e=z(a,d,c?c-1:0),f=y(a,d,c+1);if(e&&f){var g,h=(b.time-e.time)/(f.time-e.time),i=e.getTarget(d),j=f.getTarget(d).data,k=i.data;if("matrix"===i.type)g=k;else if(k.length){g=[];for(var l=0;l<k.length;++l)g[l]=k[l]+(j[l]-k[l])*h}else g=k+(j-k)*h;b.addTarget(d,i.transform,i.member,g)}}function y(a,b,c){for(;c<a.length;c++){var d=a[c];if(d.hasTarget(b))return d}return null}function z(a,b,c){for(c=c>=0?c:c+a.length;c>=0;c--){var d=a[c];if(d.hasTarget(b))return d}return null}function A(){this.id="",this.init_from=""}function B(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function C(){this.method=null,this.source=null,this.targets=null,this.weights=null}function D(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function E(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function F(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function G(){this.sid="",this.type="",this.data=[],this.obj=null}function H(){this.url="",this.skeleton=[],this.instance_material=[]}function I(){this.symbol="",this.target=""}function J(){this.url="",this.instance_material=[]}function K(){this.id="",this.mesh=null}function L(a){this.geometry=a.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function M(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function N(){M.call(this),this.vcount=[]}function O(){M.call(this),this.vcount=1}function P(){M.call(this),this.vcount=3}function Q(){this.source="",this.count=0,this.stride=0,this.params=[]}function R(){this.input={}}function S(){this.semantic="",this.offset=0,this.source="",this.set=0}function T(a){this.id=a,this.type=null}function U(){this.id="",this.name="",this.instance_effect=null}function V(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function W(a,b){this.type=a,this.effect=b,this.material=null}function X(a){this.effect=a,this.init_from=null,this.format=null}function Y(a){this.effect=a,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function Z(){this.id="",this.name="",
this.shader=null,this.surface={},this.sampler={}}function $(){this.url=""}function _(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function aa(a){this.animation=a,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function ba(a){this.id="",this.animation=a,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ca(a){this.targets=[],this.time=a}function da(){this.id="",this.name="",this.technique=""}function ea(){this.url=""}function fa(){this.id="",this.name="",this.technique=""}function ga(){this.url=""}function ha(){this.id="",this.name="",this.joints=[],this.links=[]}function ia(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function ja(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function ka(){this.joint="",this.transforms=[],this.links=[]}function la(a){var b=a.getAttribute("id");return void 0!=Na[b]?Na[b]:(Na[b]=new T(b).parse(a),Na[b])}function ma(a){for(var b=pa(a),c=[],d=0,e=b.length;d<e;d++)c.push("true"===b[d]||"1"===b[d]);return c}function na(a){for(var b=pa(a),c=[],d=0,e=b.length;d<e;d++)c.push(parseFloat(b[d]));return c}function oa(a){for(var b=pa(a),c=[],d=0,e=b.length;d<e;d++)c.push(parseInt(b[d],10));return c}function pa(a){return a.length>0?qa(a).split(/\s+/):[]}function qa(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}function ra(a,b,c){return a.hasAttribute(b)?parseInt(a.getAttribute(b),10):c}function sa(a,b){var c=new THREE.ImageLoader;c.crossOrigin="anonymous",c.load(b,function(b){a.image=b,a.needsUpdate=!0})}function ta(a,b){a.doubleSided=!1;var c=b.querySelectorAll("extra double_sided")[0];c&&c&&1===parseInt(c.textContent,10)&&(a.doubleSided=!0)}function ua(){if(Xa.convertUpAxis!==!0||Za===Xa.upAxis)$a=null;else switch(Za){case"X":$a="Y"===Xa.upAxis?"XtoY":"XtoZ";break;case"Y":$a="X"===Xa.upAxis?"YtoX":"YtoZ";break;case"Z":$a="X"===Xa.upAxis?"ZtoX":"ZtoY"}}function va(a,b){if(Xa.convertUpAxis===!0&&Za!==Xa.upAxis)switch($a){case"XtoY":var c=a[0];a[0]=b*a[1],a[1]=c;break;case"XtoZ":var c=a[2];a[2]=a[1],a[1]=a[0],a[0]=c;break;case"YtoX":var c=a[0];a[0]=a[1],a[1]=b*c;break;case"YtoZ":var c=a[1];a[1]=b*a[2],a[2]=c;break;case"ZtoX":var c=a[0];a[0]=a[1],a[1]=a[2],a[2]=c;break;case"ZtoY":var c=a[1];a[1]=a[2],a[2]=b*c}}function wa(a,b){if(Xa.convertUpAxis!==!0||Za===Xa.upAxis)return b;switch(a){case"X":b="XtoY"===$a?b*-1:b;break;case"Y":b="YtoZ"===$a||"YtoX"===$a?b*-1:b;break;case"Z":b="ZtoY"===$a?b*-1:b}return b}function xa(a,b){var c=[a[b],a[b+1],a[b+2]];return va(c,-1),new THREE.Vector3(c[0],c[1],c[2])}function ya(a){if(Xa.convertUpAxis){var b=[a[0],a[4],a[8]];va(b,-1),a[0]=b[0],a[4]=b[1],a[8]=b[2],b=[a[1],a[5],a[9]],va(b,-1),a[1]=b[0],a[5]=b[1],a[9]=b[2],b=[a[2],a[6],a[10]],va(b,-1),a[2]=b[0],a[6]=b[1],a[10]=b[2],b=[a[0],a[1],a[2]],va(b,-1),a[0]=b[0],a[1]=b[1],a[2]=b[2],b=[a[4],a[5],a[6]],va(b,-1),a[4]=b[0],a[5]=b[1],a[6]=b[2],b=[a[8],a[9],a[10]],va(b,-1),a[8]=b[0],a[9]=b[1],a[10]=b[2],b=[a[3],a[7],a[11]],va(b,-1),a[3]=b[0],a[7]=b[1],a[11]=b[2]}return(new THREE.Matrix4).set(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15])}function za(a){if(a>-1&&a<3){var b=["X","Y","Z"],c={X:0,Y:1,Z:2};a=Aa(b[a]),a=c[a]}return a}function Aa(a){if(Xa.convertUpAxis)switch(a){case"X":switch($a){case"XtoY":case"XtoZ":case"YtoX":a="Y";break;case"ZtoX":a="Z"}break;case"Y":switch($a){case"XtoY":case"YtoX":case"ZtoX":a="X";break;case"XtoZ":case"YtoZ":case"ZtoY":a="Z"}break;case"Z":switch($a){case"XtoZ":a="X";break;case"YtoZ":case"ZtoX":case"ZtoY":a="Y"}}return a}var Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka=null,La=null,Ma=null,Na={},Oa={},Pa={},Qa={},Ra={},Sa={},Ta={},Ua={},Va={},Wa=THREE.SmoothShading,Xa={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Ya=1,Za="Y",$a=null;return A.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];"init_from"===c.nodeName&&(this.init_from=c.textContent)}return this},B.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.type="none";for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"skin":this.skin=(new D).parse(c),this.type=c.nodeName;break;case"morph":this.morph=(new C).parse(c),this.type=c.nodeName}}return this},C.prototype.parse=function(a){var b,c={},d=[];for(this.method=a.getAttribute("method"),this.source=a.getAttribute("source").replace(/^#/,""),b=0;b<a.childNodes.length;b++){var e=a.childNodes[b];if(1==e.nodeType)switch(e.nodeName){case"source":var f=(new T).parse(e);c[f.id]=f;break;case"targets":d=this.parseInputs(e);break;default:console.log(e.nodeName)}}for(b=0;b<d.length;b++){var g=d[b],f=c[g.source];switch(g.semantic){case"MORPH_TARGET":this.targets=f.read();break;case"MORPH_WEIGHT":this.weights=f.read()}}return this},C.prototype.parseInputs=function(a){for(var b=[],c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"input":b.push((new S).parse(d))}}return b},D.prototype.parse=function(a){var b,c,d={};this.source=a.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var e=0;e<a.childNodes.length;e++){var f=a.childNodes[e];if(1==f.nodeType)switch(f.nodeName){case"bind_shape_matrix":var g=na(f.textContent);this.bindShapeMatrix=ya(g);break;case"source":var h=(new T).parse(f);d[h.id]=h;break;case"joints":b=f;break;case"vertex_weights":c=f;break;default:console.log(f.nodeName)}}return this.parseJoints(b,d),this.parseWeights(c,d),this},D.prototype.parseJoints=function(a,b){for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"input":var e=(new S).parse(d),f=b[e.source];"JOINT"===e.semantic?this.joints=f.read():"INV_BIND_MATRIX"===e.semantic&&(this.invBindMatrices=f.read())}}},D.prototype.parseWeights=function(a,b){for(var c,d,e=[],f=0;f<a.childNodes.length;f++){var g=a.childNodes[f];if(1==g.nodeType)switch(g.nodeName){case"input":e.push((new S).parse(g));break;case"v":c=oa(g.textContent);break;case"vcount":d=oa(g.textContent)}}for(var h=0,f=0;f<d.length;f++){for(var i=d[f],j=[],k=0;k<i;k++){for(var l={},m=0;m<e.length;m++){var n=e[m],o=c[h+n.offset];switch(n.semantic){case"JOINT":l.joint=o;break;case"WEIGHT":l.weight=b[n.source].data[o]}}j.push(l),h+=e.length}for(var k=0;k<j.length;k++)j[k].index=f;this.weights.push(j)}},E.prototype.getChildById=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},E.prototype.getChildBySid=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},E.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.nodes=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"node":this.nodes.push((new F).parse(c))}}return this},F.prototype.getChannelForTransform=function(a){for(var b=0;b<this.channels.length;b++){var c,d,e=this.channels[b],f=e.target.split("/"),g=(f.shift(),f.shift()),h=g.indexOf(".")>=0,i=g.indexOf("(")>=0;if(h)f=g.split("."),g=f.shift(),d=f.shift();else if(i){c=g.split("("),g=c.shift();for(var j=0;j<c.length;j++)c[j]=parseInt(c[j].replace(/\)/,""))}if(g===a)return e.info={sid:g,dotSyntax:h,arrSyntax:i,arrIndices:c},e}return null},F.prototype.getChildById=function(a,b){if(this.id===a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},F.prototype.getChildBySid=function(a,b){if(this.sid===a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},F.prototype.getTransformBySid=function(a){for(var b=0;b<this.transforms.length;b++)if(this.transforms[b].sid===a)return this.transforms[b];return null},F.prototype.parse=function(a){var b;this.id=a.getAttribute("id"),this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.type=a.getAttribute("type"),this.layer=a.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"node":this.nodes.push((new F).parse(d));break;case"instance_camera":this.cameras.push((new ea).parse(d));break;case"instance_controller":this.controllers.push((new H).parse(d));break;case"instance_geometry":this.geometries.push((new J).parse(d));break;case"instance_light":this.lights.push((new ga).parse(d));break;case"instance_node":b=d.getAttribute("url").replace(/^#/,"");var e=s(b);e&&this.nodes.push((new F).parse(e));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new G).parse(d));break;case"extra":break;default:console.log(d.nodeName)}}return this.channels=t(this),u(this),this.updateMatrix(),this},F.prototype.updateMatrix=function(){this.matrix.identity();for(var a=0;a<this.transforms.length;a++)this.transforms[a].apply(this.matrix)},G.prototype.parse=function(a){return this.sid=a.getAttribute("sid"),this.type=a.nodeName,this.data=na(a.textContent),this.convert(),this},G.prototype.convert=function(){switch(this.type){case"matrix":this.obj=ya(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":va(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":va(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},G.prototype.apply=function(){var a=new THREE.Matrix4;return function(b){switch(this.type){case"matrix":b.multiply(this.obj);break;case"translate":b.multiply(a.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":b.multiply(a.makeRotationAxis(this.obj,this.angle));break;case"scale":b.scale(this.obj)}}}(),G.prototype.update=function(a,b){var c=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(b)if(1===b.length)switch(b[0]){case 0:this.obj.n11=a[0],this.obj.n21=a[1],this.obj.n31=a[2],this.obj.n41=a[3];break;case 1:this.obj.n12=a[0],this.obj.n22=a[1],this.obj.n32=a[2],this.obj.n42=a[3];break;case 2:this.obj.n13=a[0],this.obj.n23=a[1],this.obj.n33=a[2],this.obj.n43=a[3];break;case 3:this.obj.n14=a[0],this.obj.n24=a[1],this.obj.n34=a[2],this.obj.n44=a[3]}else if(2===b.length){var d="n"+(b[0]+1)+(b[1]+1);this.obj[d]=a}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(a);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(b)&&(b=c[b[0]]),b){case"X":this.obj.x=a;break;case"Y":this.obj.y=a;break;case"Z":this.obj.z=a;break;default:this.obj.x=a[0],this.obj.y=a[1],this.obj.z=a[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(b)&&(b=c[b[0]]),b){case"X":this.obj.x=a;break;case"Y":this.obj.y=a;break;case"Z":this.obj.z=a;break;case"ANGLE":this.angle=THREE.Math.degToRad(a);break;default:this.obj.x=a[0],this.obj.y=a[1],this.obj.z=a[2],this.angle=THREE.Math.degToRad(a[3])}}},H.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1===c.nodeType)switch(c.nodeName){case"skeleton":this.skeleton.push(c.textContent.replace(/^#/,""));break;case"bind_material":for(var d=c.querySelectorAll("instance_material"),e=0;e<d.length;e++){var f=d[e];this.instance_material.push((new I).parse(f))}break;case"extra":}}return this},I.prototype.parse=function(a){return this.symbol=a.getAttribute("symbol"),this.target=a.getAttribute("target").replace(/^#/,""),this},J.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType&&"bind_material"===c.nodeName){for(var d=c.querySelectorAll("instance_material"),e=0;e<d.length;e++){var f=d[e];this.instance_material.push((new I).parse(f))}break}}return this},K.prototype.parse=function(a){this.id=a.getAttribute("id"),ta(this,a);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"mesh":this.mesh=new L(this).parse(c);break;case"extra":}}return this},L.prototype.parse=function(a){this.primitives=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"source":la(c);break;case"vertices":this.vertices=(new R).parse(c);break;case"linestrips":this.primitives.push((new O).parse(c));break;case"triangles":this.primitives.push((new P).parse(c));break;case"polygons":this.primitives.push((new M).parse(c));break;case"polylist":this.primitives.push((new N).parse(c))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var d=Na[this.vertices.input.POSITION.source].data,b=0;b<d.length;b+=3)this.geometry3js.vertices.push(xa(d,b).clone());for(var b=0;b<this.primitives.length;b++){var e=this.primitives[b];e.setVertices(this.vertices),this.handlePrimitive(e,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},L.prototype.handlePrimitive=function(a,b){if(a instanceof O)return void(b.isLineStrip=!0);var c,d,e,f,g,h,i,j=a.p,k=a.inputs,l=0,m=3,n=0,o=[];for(c=0;c<k.length;c++){e=k[c];var p=e.offset+1;switch(n=n<p?p:n,e.semantic){case"TEXCOORD":o.push(e.set)}}for(var q=0;q<j.length;++q)for(var r=j[q],s=0;s<r.length;){var t=[],u=[],v=null,w=[];for(m=a.vcount?a.vcount.length?a.vcount[l++]:a.vcount:r.length/n,c=0;c<m;c++)for(d=0;d<k.length;d++)switch(e=k[d],h=Na[e.source],f=r[s+c*n+e.offset],i=h.accessor.params.length,g=f*i,e.semantic){case"VERTEX":t.push(f);break;case"NORMAL":u.push(xa(h.data,g));break;case"TEXCOORD":v=v||{},void 0===v[e.set]&&(v[e.set]=[]),v[e.set].push(new THREE.Vector2(h.data[g],h.data[g+1]));break;case"COLOR":w.push((new THREE.Color).setRGB(h.data[g],h.data[g+1],h.data[g+2]))}if(0===u.length)if(e=this.vertices.input.NORMAL){h=Na[e.source],i=h.accessor.params.length;for(var x=0,y=t.length;x<y;x++)u.push(xa(h.data,t[x]*i))}else b.calcNormals=!0;if(!v&&(v={},e=this.vertices.input.TEXCOORD)){o.push(e.set),h=Na[e.source],i=h.accessor.params.length;for(var x=0,y=t.length;x<y;x++)g=t[x]*i,void 0===v[e.set]&&(v[e.set]=[]),v[e.set].push(new THREE.Vector2(h.data[g],1-h.data[g+1]))}if(0===w.length&&(e=this.vertices.input.COLOR)){h=Na[e.source],i=h.accessor.params.length;for(var x=0,y=t.length;x<y;x++)g=t[x]*i,w.push((new THREE.Color).setRGB(h.data[g],h.data[g+1],h.data[g+2]))}var z,A,B=null,C=[];if(3===m)C.push(new THREE.Face3(t[0],t[1],t[2],u,w.length?w:new THREE.Color));else if(4===m)C.push(new THREE.Face3(t[0],t[1],t[3],u.length?[u[0].clone(),u[1].clone(),u[3].clone()]:[],w.length?[w[0],w[1],w[3]]:new THREE.Color)),C.push(new THREE.Face3(t[1],t[2],t[3],u.length?[u[1].clone(),u[2].clone(),u[3].clone()]:[],w.length?[w[1],w[2],w[3]]:new THREE.Color));else if(m>4&&Xa.subdivideFaces){var D=w.length?w:new THREE.Color;for(d=1;d<m-1;)C.push(new THREE.Face3(t[0],t[d],t[d+1],u.length?[u[0].clone(),u[d++].clone(),u[d].clone()]:[],D))}if(C.length)for(var x=0,y=C.length;x<y;x++)for(B=C[x],B.daeMaterial=a.material,b.faces.push(B),d=0;d<o.length;d++)z=v[o[d]],A=m>4?[z[0],z[x+1],z[x+2]]:4===m?0===x?[z[0],z[1],z[3]]:[z[1].clone(),z[2],z[3].clone()]:[z[0],z[1],z[2]],void 0===b.faceVertexUvs[d]&&(b.faceVertexUvs[d]=[]),b.faceVertexUvs[d].push(A);else console.log("dropped face with vcount "+m+" for geometry with id: "+b.id);s+=n*m}},M.prototype.setVertices=function(a){for(var b=0;b<this.inputs.length;b++)this.inputs[b].source===a.id&&(this.inputs[b].source=a.input.POSITION.source)},M.prototype.parse=function(a){this.material=a.getAttribute("material"),this.count=ra(a,"count",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"input":this.inputs.push((new S).parse(a.childNodes[b]));break;case"vcount":this.vcount=oa(c.textContent);break;case"p":this.p.push(oa(c.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},N.prototype=Object.create(M.prototype),N.prototype.constructor=N,O.prototype=Object.create(M.prototype),O.prototype.constructor=O,P.prototype=Object.create(M.prototype),P.prototype.constructor=P,Q.prototype.parse=function(a){this.params=[],this.source=a.getAttribute("source"),this.count=ra(a,"count",0),this.stride=ra(a,"stride",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if("param"===c.nodeName){var d={};d.name=c.getAttribute("name"),d.type=c.getAttribute("type"),this.params.push(d)}}return this},R.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++)if("input"===a.childNodes[b].nodeName){var c=(new S).parse(a.childNodes[b]);this.input[c.semantic]=c}return this},S.prototype.parse=function(a){return this.semantic=a.getAttribute("semantic"),this.source=a.getAttribute("source").replace(/^#/,""),this.set=ra(a,"set",-1),this.offset=ra(a,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},T.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"bool_array":this.data=ma(c.textContent),this.type=c.nodeName;break;case"float_array":this.data=na(c.textContent),this.type=c.nodeName;break;case"int_array":this.data=oa(c.textContent),this.type=c.nodeName;break;case"IDREF_array":case"Name_array":this.data=pa(c.textContent),this.type=c.nodeName;break;case"technique_common":for(var d=0;d<c.childNodes.length;d++)if("accessor"===c.childNodes[d].nodeName){this.accessor=(new Q).parse(c.childNodes[d]);break}}}return this},T.prototype.read=function(){var a=[],b=this.accessor.params[0];switch(b.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var c=0;c<this.data.length;c+=16){var d=this.data.slice(c,c+16),e=ya(d);a.push(e)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+b.type+".")}return a},U.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++)if("instance_effect"===a.childNodes[b].nodeName){this.instance_effect=(new $).parse(a.childNodes[b]);break}return this},V.prototype.isColor=function(){return null===this.texture},V.prototype.isTexture=function(){return null!=this.texture},V.prototype.parse=function(a){"transparent"===a.nodeName&&(this.opaque=a.getAttribute("opaque"));for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"color":var d=na(c.textContent);this.color=new THREE.Color,this.color.setRGB(d[0],d[1],d[2]),this.color.a=d[3];break;case"texture":this.texture=c.getAttribute("texture"),this.texcoord=c.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(c)}}return this},V.prototype.parseTexture=function(a){if(!a.childNodes)return this;a.childNodes[1]&&"extra"===a.childNodes[1].nodeName&&(a=a.childNodes[1],a.childNodes[1]&&"technique"===a.childNodes[1].nodeName&&(a=a.childNodes[1]));for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[c.nodeName]=parseFloat(c.textContent);break;case"wrapU":case"wrapV":"TRUE"===c.textContent.toUpperCase()?this.texOpts[c.nodeName]=1:this.texOpts[c.nodeName]=parseInt(c.textContent);break;default:this.texOpts[c.nodeName]=c.textContent}}return this},W.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[c.nodeName]=(new V).parse(c);break;case"bump":var d=c.getAttribute("bumptype");d?"heightfield"===d.toLowerCase()?this.bump=(new V).parse(c):"normalmap"===d.toLowerCase()?this.normal=(new V).parse(c):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+d+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new V).parse(c)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new V).parse(c));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var e=c.querySelectorAll("float");e.length>0&&(this[c.nodeName]=parseFloat(e[0].textContent))}}return this.create(),this},W.prototype.create=function(){var a={},b=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var c=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);c>0&&(b=!0,a.transparent=!0,a.opacity=1-c)}var d={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var e in this)switch(e){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var f=this[e];if(f instanceof V)if(f.isTexture()){var g=f.texture,h=this.effect.sampler[g];if(void 0!==h&&void 0!==h.source){var i=this.effect.surface[h.source];if(void 0!==i){var j=Oa[i.init_from];if(j){var k,l=Ha+j.init_from,m=THREE.Loader.Handlers.get(l);null!==m?k=m.load(l):(k=new THREE.Texture,sa(k,l)),k.wrapS=f.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,k.wrapT=f.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,k.offset.x=f.texOpts.offsetU,k.offset.y=f.texOpts.offsetV,k.repeat.x=f.texOpts.repeatU,k.repeat.y=f.texOpts.repeatV,a[d[e]]=k,"emission"===e&&(a.emissive=16777215)}}}}else"diffuse"!==e&&b||("emission"===e?a.emissive=f.color.getHex():a[e]=f.color.getHex());break;case"shininess":a[e]=this[e];break;case"reflectivity":a[e]=this[e],a[e]>0&&(a.envMap=Xa.defaultEnvMap),a.combine=THREE.MixOperation;break;case"index_of_refraction":a.refractionRatio=this[e],1!==this[e]&&(a.envMap=Xa.defaultEnvMap);break;case"transparency":}switch(a.shading=Wa,a.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==a.diffuse&&(a.color=a.diffuse,delete a.diffuse),this.type){case"constant":void 0!=a.emissive&&(a.color=a.emissive),this.material=new THREE.MeshBasicMaterial(a);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(a);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(a)}return this.material},X.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"init_from":this.init_from=c.textContent;break;case"format":this.format=c.textContent;break;default:console.log("unhandled Surface prop: "+c.nodeName)}}return this},Y.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"source":this.source=c.textContent;break;case"minfilter":this.minfilter=c.textContent;break;case"magfilter":this.magfilter=c.textContent;break;case"mipfilter":this.mipfilter=c.textContent;break;case"wrap_s":this.wrap_s=c.textContent;break;case"wrap_t":this.wrap_t=c.textContent;break;default:console.log("unhandled Sampler2D prop: "+c.nodeName)}}return this},Z.prototype.create=function(){if(null===this.shader)return null},Z.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),ta(this,a),this.shader=null;for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(c))}}return this},Z.prototype.parseNewparam=function(a){for(var b=a.getAttribute("sid"),c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"surface":this.surface[b]=new X(this).parse(d);break;case"sampler2D":this.sampler[b]=new Y(this).parse(d);break;case"extra":break;default:console.log(d.nodeName)}}},Z.prototype.parseProfileCOMMON=function(a){for(var b,c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"profile_COMMON":this.parseProfileCOMMON(d);break;case"technique":b=d;break;case"newparam":this.parseNewparam(d);break;case"image":var e=(new A).parse(d);Oa[e.id]=e;break;case"extra":break;default:console.log(d.nodeName)}}return b},Z.prototype.parseTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new W(c.nodeName,this).parse(c);break;case"extra":this.parseExtra(c)}}},Z.prototype.parseExtra=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique":this.parseExtraTechnique(c)}}},Z.prototype.parseExtraTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"bump":this.shader.parse(a)}}},$.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},_.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.source={};for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"animation":var d=(new _).parse(c);for(var e in d.source)this.source[e]=d.source[e];for(var f=0;f<d.channel.length;f++)this.channel.push(d.channel[f]),this.sampler.push(d.sampler[f]);break;case"source":var e=(new T).parse(c);this.source[e.id]=e;break;case"sampler":this.sampler.push(new ba(this).parse(c));break;case"channel":this.channel.push(new aa(this).parse(c))}}return this},aa.prototype.parse=function(a){this.source=a.getAttribute("source").replace(/^#/,""),this.target=a.getAttribute("target");var b=this.target.split("/"),c=(b.shift(),b.shift()),d=c.indexOf(".")>=0,e=c.indexOf("(")>=0;if(d)b=c.split("."),this.sid=b.shift(),this.member=b.shift();else if(e){var f=c.split("(");this.sid=f.shift();for(var g=0;g<f.length;g++)f[g]=parseInt(f[g].replace(/\)/,""));this.arrIndices=f}else this.sid=c;return this.fullSid=c,this.dotSyntax=d,this.arrSyntax=e,this},ba.prototype.parse=function(a){this.id=a.getAttribute("id"),this.inputs=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"input":this.inputs.push((new S).parse(c))}}return this},ba.prototype.create=function(){for(var a=0;a<this.inputs.length;a++){var b=this.inputs[a],c=this.animation.source[b.source];switch(b.semantic){case"INPUT":this.input=c.read();break;case"OUTPUT":this.output=c.read(),this.strideOut=c.accessor.stride;break;case"INTERPOLATION":this.interpolation=c.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(b.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var a=0;a<this.input.length;a++)this.startTime=Math.min(this.startTime,this.input[a]),this.endTime=Math.max(this.endTime,this.input[a]);this.duration=this.endTime-this.startTime}},ba.prototype.getData=function(a,b,c){var d;if("matrix"===a&&16===this.strideOut)d=this.output[b];else if(this.strideOut>1){d=[],b*=this.strideOut;for(var e=0;e<this.strideOut;++e)d[e]=this.output[b+e];if(3===this.strideOut)switch(a){case"rotate":case"translate":va(d,-1);break;case"scale":va(d,1)}else 4===this.strideOut&&"matrix"===a&&va(d,-1)}else d=this.output[b],c&&"translate"===a&&(d=wa(c,d));return d},ca.prototype.addTarget=function(a,b,c,d){this.targets.push({sid:a,member:c,transform:b,data:d})},ca.prototype.apply=function(a){for(var b=0;b<this.targets.length;++b){var c=this.targets[b];a&&c.sid!==a||c.transform.update(c.data,c.member)}},ca.prototype.getTarget=function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b].sid===a)return this.targets[b];return null},ca.prototype.hasTarget=function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b].sid===a)return!0;return!1},ca.prototype.interpolate=function(a,b){for(var c=0,d=this.targets.length;c<d;c++){var e,f=this.targets[c],g=a.getTarget(f.sid);if("matrix"!==f.transform.type&&g){var h=(b-this.time)/(a.time-this.time),i=g.data,j=f.data;if(h<0&&(h=0),h>1&&(h=1),j.length){e=[];for(var k=0;k<j.length;++k)e[k]=j[k]+(i[k]-j[k])*h}else e=j+(i-j)*h}else e=f.data;f.transform.update(e,f.member)}},da.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"optics":this.parseOptics(c)}}return this},da.prototype.parseOptics=function(a){for(var b=0;b<a.childNodes.length;b++)if("technique_common"===a.childNodes[b].nodeName)for(var c=a.childNodes[b],d=0;d<c.childNodes.length;d++)if(this.technique=c.childNodes[d].nodeName,"perspective"===this.technique)for(var e=c.childNodes[d],f=0;f<e.childNodes.length;f++){var g=e.childNodes[f];switch(g.nodeName){case"yfov":this.yfov=g.textContent;break;case"xfov":this.xfov=g.textContent;break;case"znear":this.znear=g.textContent;break;case"zfar":this.zfar=g.textContent;break;case"aspect_ratio":this.aspect_ratio=g.textContent}}else if("orthographic"===this.technique)for(var h=c.childNodes[d],f=0;f<h.childNodes.length;f++){var g=h.childNodes[f];switch(g.nodeName){case"xmag":this.xmag=g.textContent;break;case"ymag":this.ymag=g.textContent;break;case"znear":this.znear=g.textContent;break;case"zfar":this.zfar=g.textContent;break;case"aspect_ratio":this.aspect_ratio=g.textContent}}return this},ea.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},fa.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique_common":this.parseCommon(c);break;case"technique":this.parseTechnique(c)}}return this},fa.prototype.parseCommon=function(a){for(var b=0;b<a.childNodes.length;b++)switch(a.childNodes[b].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=a.childNodes[b].nodeName;for(var c=a.childNodes[b],d=0;d<c.childNodes.length;d++){var e=c.childNodes[d];switch(e.nodeName){case"color":var f=na(e.textContent);this.color=new THREE.Color(0),this.color.setRGB(f[0],f[1],f[2]),this.color.a=f[3];break;case"falloff_angle":this.falloff_angle=parseFloat(e.textContent);break;case"quadratic_attenuation":var g=parseFloat(e.textContent);this.distance=g?Math.sqrt(1/g):0}}}return this},fa.prototype.parseTechnique=function(a){this.profile=a.getAttribute("profile");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"intensity":this.intensity=parseFloat(c.textContent)}}return this},ga.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},ha.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.joints=[],this.links=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique_common":this.parseCommon(c)}}return this},ha.prototype.parseCommon=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(a.childNodes[b].nodeName){case"joint":this.joints.push((new ia).parse(c));break;case"link":this.links.push((new ja).parse(c))}}return this},ia.prototype.parse=function(a){this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var b=a.querySelector("axis"),c=na(b.textContent);this.axis=xa(c,0);var d=a.querySelector("limits min")?parseFloat(a.querySelector("limits min").textContent):-360,e=a.querySelector("limits max")?parseFloat(a.querySelector("limits max").textContent):360;
this.limits={min:d,max:e};for(var f=["prismatic","revolute"],g=0;g<f.length;g++){var h=f[g],i=a.querySelector(h);i&&(this.type=h)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},ja.prototype.parse=function(a){this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.transforms=[],this.attachments=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"attachment_full":this.attachments.push((new ka).parse(c));break;case"rotate":case"translate":case"matrix":this.transforms.push((new G).parse(c))}}return this},ka.prototype.parse=function(a){this.joint=a.getAttribute("joint").split("/").pop(),this.links=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"link":this.links.push((new ja).parse(c));break;case"rotate":case"translate":case"matrix":this.transforms.push((new G).parse(c))}}return this},{load:a,parse:b,setPreferredShading:c,applySkin:p,geometries:Ra,options:Xa}};var KeyFrameAnimationHandler=Class.$extend({__classvars__:{instances:[],update:function(a){for(var b=0,c=this.instances.length;b<c;++b)this.instances[b].update(a)}},__init__:function(){this.animations=[],this.progress=0,this.isPlaying=!1,this.loop=!1,this.speed=1,this.length=0,KeyFrameAnimationHandler.instances.push(this)},load:function(a){for(var b=0,c=a.length;b<c;++b){var d=a[b],e=new THREE.KeyFrameAnimation(d);e.timeScale=1,this.length=d.length>this.length?d.length:this.length,this.animations.push(e)}},play:function(a,b){if(!(this.animations.length<1)){this.loop=a||!1,this.speed=b||1,this.stop();for(var c=0,d=this.animations.length;c<d;++c){for(var e=this.animations[c],f=0,g=e.hierarchy.length;f<g;f++){var h=e.data.hierarchy[f].keys,i=e.data.hierarchy[f].sids,j=e.hierarchy[f];if(h.length&&i){for(var k=0;k<i.length;k++){var l=i[k],m=e.getNextKeyWith(l,f,0);m&&m.apply(l)}j.matrixAutoUpdate=!1,e.data.hierarchy[f].node.updateMatrix(),j.matrixWorldNeedsUpdate=!0}}e.loop=!1,e.play()}this.progress=0,this.isPlaying=!0}},stop:function(){this.isPlaying=!1,this.progress=0;for(var a=0,b=this.animations.length;a<b;++a)this.animations[a].stop()},update:function(a){if(this.isPlaying){if(this.progress>0&&this.progress<this.length)for(var b=0,c=this.animations.length;b<c;++b)this.animations[b].update(a*this.speed);else this.progress>=this.length&&(this.stop(),this.loop&&this.play(this.loop,this.speed));this.progress+=a*this.speed}}}),WebTundraColladaWrapper={Animation:THREE.Animation,AnimationHandler:THREE.AnimationHandler,KeyFrameAnimation:THREE.KeyFrameAnimation,KeyFrameAnimationHandler:KeyFrameAnimationHandler,Loader:THREE.ColladaLoader},ColladaThreeJsUtils={loadKeyFrameAnimations:function(a){var b=new WebTundraColladaWrapper.KeyFrameAnimationHandler;return b.load(a),{__keyframe_animation__:b}},loadAnimations:function(a){for(var b={},c=new THREE.Vector3,d=new THREE.Quaternion,e=new THREE.Vector3,f=0,g=a.length;f<g;++f){for(var h=a[f],i=THREE.AnimationHandler.init(h),j=THREE.AnimationHandler.parse(h.node),k=i.hierarchy,l=[],m=0,n=k.length;m<n;++m){var o=j[m],p=[],q=[],r=[],s=k[m].keys,t=k[m].sids;k[m].node;if(!(!s||s.length<1||!t||t.length<1)){c.copy(o.position),d.copy(o.quaternion),e.copy(o.scale);for(var u=0,v=s.length;u<v;++u)this.getTransformForSids(t,s,u,c,d,e),p.push(c.x,c.y,c.z),q.push(d.x,d.y,d.z,d.w),r.push(s[u].time);var w=this.getPathForNode(o);l.push(new THREE.VectorKeyframeTrack(w+"position",r,p)),l.push(new THREE.QuaternionKeyframeTrack(w+"quaternion",r,q))}}b[h.name]=new THREE.AnimationClip(h.name,h.length,l)}return b},getNextKeyWith:function(a,b,c){for(b%=c.length;b<c.length;++b)if(c[b].hasTarget(a))return c[b];return c[0]},getPathForNode:function(a){for(var b=[],c=a;c.parent&&c.parent instanceof THREE.Object3D;)b.push(c.name),c=c.parent;b.reverse();var d=b.join("/")+".";return d},getTransformForSids:function(a,b,c,d,e,f){for(var g=0;g<a.length;++g){var h=this.getNextKeyWith(a[g],c,b),i=this.getTargetForSid(a[g],h);i&&this.extractTarget(i,d,e,f)}},getTargetForSid:function(a,b){for(var c=0;c<b.targets.length;++c){var d=b.targets[c];if(d.sid===a)return d}return null},getTransformForKey:function(a,b,c,d){for(var e=0,f=a.targets.length;e<f;++e){var g=a.targets[e];this.extractTarget(g,b,c,d)}},extractTarget:function(a,b,c,d){var e=a.transform.type,f=a.member;if("translate"===e||"scale"===e){var g="translate"===e?b:d;switch(f){case"X":g.x=a.data;break;case"Y":g.y=a.data;break;case"Z":g.z=a.data;break;default:g.x=a.data[0],g.y=a.data[1],g.z=a.data[2]}}else if("rotate"===e){var h=(new THREE.Quaternion).setFromAxisAngle(a.transform.obj,a.transform.angle);c.multiply(h)}else console.warn("[ColladaThreeJsUtils]: Key frames do not contain any data! Animation will be garbled")},loadSkinnedMeshAnimations:function(a){var b=a.geometry.animation,c=a.skeleton.bones,d={};return d[b.name]=THREE.AnimationClip.parseAnimation(b,c),d}},ColladaAsset=AnimationProviderAsset.$extend({__init__:function(a){this.$super(a,"ColladaAsset",AnimationProviderAsset.Type.SkinnedMesh),this.requiresCloning=!0,this.mesh=void 0,this.skin=void 0,this.animations=[]},_cloneImpl:function(a){var b=new ColladaAsset(a);return b.mesh=this.mesh.clone(),b},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:void 0},isLoaded:function(){return void 0!==this.mesh},isAttached:function(){return Object.keys(this.animationHierarchy).length>0},getBoneParent:function(){return this.skin?this.skin:this.isLoaded()?this.mesh:null},deserializeFromData:function(a,b,c){try{var d=new WebTundraColladaWrapper.Loader;d.parse(a,function(a){this.mesh=a.scene,this.skin=Array.isArray(a.skins)?a.skins[0]:void 0,this.skin?(this.animationType=AnimationProviderAsset.Type.SkinnedMesh,this.animationHierarchy=ColladaThreeJsUtils.loadSkinnedMeshAnimations(this.skin)):(this.animationType=AnimationProviderAsset.Type.KeyFrame,this.animationHierarchy=ColladaThreeJsUtils.loadKeyFrameAnimations(a.animations)),this._emitLoaded()}.bind(this),c.proxyRef||c.ref)}catch(e){return this.log.error("Could not load collada asset:",e),!1}},unload:function(){this.requiresCloning&&this.isCloneSource||(this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.skin&&this.skin.parent&&this.skin.parent.remove(this.skin))}});!function(){function a(){}function b(){}function c(){}function d(){this.skinIndices=[],this.skinWeights=[],this.matrices=[]}function e(){this.hierarchy=[]}function f(){this.node=null,this.name=null,this.id=null,this.vertices=[],this.indices=[],this.normals=[],this.uvs=[],this.bones=[],this.skins=null}function g(){this.uv=null,this.map=null,this.ref=null,this.node=null,this.index=null}function h(){this.normal=null,this.map=null,this.ref=null,this.node=null,this.index=null}function i(){this.version=null,this.id=null,this.internalId=null,this.times=null,this.values=null,this.attrFlag=null,this.attrData=null}function j(){this.id=null,this.attr=null,this.attrX=!1,this.attrY=!1,this.attrZ=!1,this.internalId=null,this.containerInternalId=null,this.containerBoneId=null,this.curveIdx=null,this.curves=[]}function k(){this.curves={},this.length=0,this.fps=30,this.frames=0}function l(){this.textures=[],this.perGeoMap={}}function m(){this.fileName="",this.name="",this.id=null,this.parentIds=[]}function n(a,b,c){for(var d=[],e=0;e<b.length;++e)for(var f=0;f<c;++f)d.push(a[b[e]*c+f]);return d}function o(a,b,c){for(var d={},e=[],f=0,g=0;g<b.length;++g)if(!(b[g]in d)){d[b[g]]={};for(var h=0;h<c;++h)d[b[g]][h]=a[g*c+h];f=f<b[g]?b[g]:f}try{for(g=0;g<=f;g++)for(var i=0;i<c;i++)e.push(d[g][i])}catch(j){}return e}THREE.FBXLoader=function(a,b){THREE.Loader.call(this,a),this.manager=void 0!==b?b:THREE.DefaultLoadingManager,this.textureLoader=null,this.textureBasePath=null},THREE.FBXLoader.prototype=Object.create(THREE.Loader.prototype),THREE.FBXLoader.prototype.constructor=THREE.FBXLoader,THREE.FBXLoader.prototype.load=function(a,b,c,d){var e=this,f=new THREE.XHRLoader(e.manager);f.load(a,function(c){e.isFbxFormatASCII(c)?e.isFbxVersionSupported(c)?(e.textureBasePath=e.extractUrlBase(a),b(e.parse(c))):console.warn("FBXLoader: !!! FBX Version below 7 not supported !!!"):console.warn("FBXLoader: !!! FBX Binary format not supported !!!")},c,d)},THREE.FBXLoader.prototype.setCrossOrigin=function(a){this.crossOrigin=a},THREE.FBXLoader.prototype.isFbxFormatASCII=function(a){CORRECT=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];for(var b=0,c=function(c){var d=a[c-1];return a=a.slice(b+c),b++,d},d=0;d<CORRECT.length;++d)if(num=c(1),num==CORRECT[d])return!1;return!0},THREE.FBXLoader.prototype.isFbxVersionSupported=function(a){var b=/FBXVersion: (\d+)/;if(match=a.match(b),match){var c=parseInt(match[1]);return console.log("FBXLoader: FBX version "+c),c>=7e3}return!1},THREE.FBXLoader.prototype.parse=function(a){var c=this;console.time("FBXLoader"),console.time("FBXLoader: TextParser");var f=(new b).parse(a);console.timeEnd("FBXLoader: TextParser"),console.time("FBXLoader: ObjectParser"),c.hierarchy=(new e).parseHierarchy(f),c.weights=(new d).parse(f,c.hierarchy),c.animations=(new k).parse(f,c.hierarchy),c.textures=(new l).parse(f,c.hierarchy),console.timeEnd("FBXLoader: ObjectParser"),console.time("FBXLoader: GeometryParser"),geometries=this.parseGeometries(f),console.timeEnd("FBXLoader: GeometryParser");for(var g=new THREE.Group,h=0;h<geometries.length;++h)void 0!==geometries[h]&&g.add(geometries[h]);return console.timeEnd("FBXLoader"),g},THREE.FBXLoader.prototype.parseGeometries=function(a){if(!("Geometry"in a.Objects.subNodes))return[];var b=0;for(var c in a.Objects.subNodes.Geometry)c.match(/^\d+$/)&&b++;var d=[];if(b>0)for(c in a.Objects.subNodes.Geometry)"Mesh"===a.Objects.subNodes.Geometry[c].attrType&&d.push(this.parseGeometry(a.Objects.subNodes.Geometry[c],a));else d.push(this.parseGeometry(a.Objects.subNodes.Geometry,a));return d},THREE.FBXLoader.prototype.parseGeometry=function(a,b){geo=(new f).parse(a),geo.addBones(this.hierarchy.hierarchy);var c=new THREE.BufferGeometry;c.name=geo.name,c.addAttribute("position",new THREE.BufferAttribute(new Float32Array(geo.vertices),3)),void 0!==geo.normals&&geo.normals.length>0&&c.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(geo.normals),3)),void 0!==geo.uvs&&geo.uvs.length>0&&c.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(geo.uvs),2)),void 0!==geo.indices&&geo.indices.length>65535?c.setIndex(new THREE.BufferAttribute(new Uint32Array(geo.indices),1)):void 0!==geo.indices&&c.setIndex(new THREE.BufferAttribute(new Uint16Array(geo.indices),1)),c.verticesNeedUpdate=!0,c.computeBoundingSphere(),c.computeBoundingBox();var d,e=this.textures.getById(b.searchConnectionParent(geo.id));void 0!==e&&e.length>0&&(null===this.textureLoader&&(this.textureLoader=new THREE.TextureLoader),d=this.textureLoader.load(this.textureBasePath+"/"+e[0].fileName));var g;g=void 0!==d?new THREE.MeshBasicMaterial({map:d}):new THREE.MeshBasicMaterial({color:3342591}),c=(new THREE.Geometry).fromBufferGeometry(c),c.bones=geo.bones,c.skinIndices=this.weights.skinIndices,c.skinWeights=this.weights.skinWeights;var h=null;return void 0===geo.bones||void 0===geo.skins||void 0===this.animations||0===this.animations.length?h=new THREE.Mesh(c,g):(g.skinning=!0,h=new THREE.SkinnedMesh(c,g),this.addAnimation(h,this.weights.matrices,this.animations)),h},THREE.FBXLoader.prototype.addAnimation=function(a,b,c){for(var d={name:"animationtest",fps:30,length:c.length,hierarchy:[]},e=0;e<a.geometry.bones.length;++e){var f=a.geometry.bones[e].name;f=f.replace(/.*:/,""),d.hierarchy.push({parent:a.geometry.bones[e].parent,name:f,keys:[]})}var g=function(a,b){if(void 0===a)return!1;var c;switch(b){case"S":if(void 0===a.S)return!1;c=a.S;break;case"R":if(void 0===a.R)return!1;c=a.R;break;case"T":if(void 0===a.T)return!1;c=a.T}return void 0!==c.curves.x&&(void 0!==c.curves.y&&void 0!==c.curves.z)},h=function(a,b){var c=i(a.curves.x,b),d=i(a.curves.y,b),e=i(a.curves.z,b);return c&&d&&e},i=function(a,b){var c=a.values[b];return void 0!==c},j=function(a,b){var d={};if(d.time=frame/c.fps,d.pos=b.pos,d.rot=b.rotq,d.scl=b.scl,void 0===a)return d;try{if(g(a,"T")&&h(a.T,frame)){var e=new THREE.Vector3(a.T.curves.x.values[frame],a.T.curves.y.values[frame],a.T.curves.z.values[frame]);d.pos=[e.x,e.y,e.z]}else delete d.pos;if(g(a,"R")&&h(a.R,frame)){var f=degToRad(a.R.curves.x.values[frame]),i=degToRad(a.R.curves.y.values[frame]),j=degToRad(a.R.curves.z.values[frame]),k=new THREE.Vector3(f,i,j),l=quatFromVec(k.x,k.y,k.z);d.rot=[l.x,l.y,l.z,l.w]}else delete d.rot;if(g(a,"S")&&h(a.S,frame)){var m=new THREE.Vector3(a.S.curves.x.values[frame],a.S.curves.y.values[frame],a.S.curves.z.values[frame]);d.scl=[m.x,m.y,m.z]}else delete d.scl}catch(n){console.log(b),console.log(n)}return d},k=a.geometry.bones;for(frame=0;frame<c.frames;frame++)for(e=0;e<k.length;e++)for(var l=k[e],m=c.curves[e],n=0;n<d.hierarchy.length;n++)d.hierarchy[n].name===l.name&&d.hierarchy[n].keys.push(j(m,l));void 0===a.geometry.animations&&(a.geometry.animations=[]),a.geometry.animations.push(THREE.AnimationClip.parseAnimation(d,a.geometry.bones))},THREE.FBXLoader.prototype.parseMaterials=function(a){if(!("Material"in a.subNodes))return[];var b=0;for(var c in a.subNodes.Materials)c.match(/^\d+$/)&&b++;var d=[];if(b>0)for(c in a.subNodes.Material)d.push(parseMaterial(a.subNodes.Material[c]));else d.push(parseMaterial(a.subNodes.Material));return d},THREE.FBXLoader.prototype.parseMaterial=function(a){},THREE.FBXLoader.prototype.loadFile=function(a,b,c,d,e){var f=new THREE.XHRLoader(this.manager);f.setResponseType(e);var g=f.load(a,function(a){b(a)},c,d);return g},THREE.FBXLoader.prototype.loadFileAsBuffer=function(a,b,c,d){this.loadFile(a,onLoad,c,d,"arraybuffer")},THREE.FBXLoader.prototype.loadFileAsText=function(a,b,c,d){this.loadFile(a,b,c,d,"text")},a.prototype.add=function(a,b){this[a]=b},a.prototype.searchConnectionParent=function(a){if(void 0===this.__cache_search_connection_parent&&(this.__cache_search_connection_parent=[]),void 0!==this.__cache_search_connection_parent[a])return this.__cache_search_connection_parent[a];this.__cache_search_connection_parent[a]=[];for(var b=this.Connections.properties.connections,c=[],d=0;d<b.length;++d)if(b[d][0]==a){var e=0===b[d][1]?-1:b[d][1];c.push(e)}return c.length>0?(this.__cache_search_connection_parent[a]=this.__cache_search_connection_parent[a].concat(c),c):(this.__cache_search_connection_parent[a]=[-1],[-1])},a.prototype.searchConnectionChildren=function(a){if(void 0===this.__cache_search_connection_children&&(this.__cache_search_connection_children=[]),void 0!==this.__cache_search_connection_children[a])return this.__cache_search_connection_children[a];this.__cache_search_connection_children[a]=[];for(var b=this.Connections.properties.connections,c=[],d=0;d<b.length;++d)b[d][1]==a&&c.push(0===b[d][0]?-1:b[d][0]);return c.length>0?(this.__cache_search_connection_children[a]=this.__cache_search_connection_children[a].concat(c),c):(this.__cache_search_connection_children[a]=[-1],[-1])},a.prototype.searchConnectionType=function(a,b){var c=a+","+b;if(void 0===this.__cache_search_connection_type&&(this.__cache_search_connection_type=""),void 0!==this.__cache_search_connection_type[c])return this.__cache_search_connection_type[c];this.__cache_search_connection_type[c]="";for(var d=this.Connections.properties.connections,e=0;e<d.length;++e)if(d[e][0]==a&&d[e][1]==b)return this.__cache_search_connection_type[c]=d[e][2],d[e][2];return this.__cache_search_connection_type[a]=null,null},b.prototype={getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(a){this.nodeStack.push(a),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(a,b){this.currentProp=a,this.currentPropName=b},parse:function(b){this.currentIndent=0,this.allNodes=new a,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var c=b.split("\n");for(var d in c){var e=c[d];if(!e.match(/^[\s\t]*;/)&&!e.match(/^[\s\t]*$/)){var f=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):(.*){","");if(match=e.match(f),match){var g=match[1].trim().replace(/^"/,"").replace(/"$/,""),h=match[2].split(",").map(function(a){return a.trim().replace(/^"/,"").replace(/"$/,"")});this.parseNodeBegin(e,g,h||null)}else{var i=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)");if(match=e.match(i),match){var j=match[1].replace(/^"/,"").replace(/"$/,"").trim(),k=match[2].replace(/^"/,"").replace(/"$/,"").trim();this.parseNodeProperty(e,j,k)}else{var l=new RegExp("^\\t{"+(this.currentIndent-1)+"}}");e.match(l)?this.nodeEnd():e.match(/^[^\s\t}]/)&&this.parseNodePropertyContinued(e)}}}}return this.allNodes},parseNodeBegin:function(a,b,c){var d={name:b,properties:{},subNodes:{}},e=this.parseNodeAttr(c),f=this.getCurrentNode();if(0===this.currentIndent)this.allNodes.add(b,d);else if(b in f.subNodes){var g=f.subNodes[b];this.isFlattenNode(f.subNodes[b])&&(""===e.id?(f.subNodes[b]=[],f.subNodes[b].push(g)):(f.subNodes[b]={},f.subNodes[b][g.id]=g)),""===e.id?f.subNodes[b].push(d):f.subNodes[b][e.id]=d}else f.subNodes[b]=d;c&&(d.id=e.id,d.attrName=e.name,d.attrType=e.type),this.pushStack(d)},parseNodeAttr:function(a){var b=a[0];""!==a[0]&&(b=parseInt(a[0]),isNaN(b)&&(b=a[0]));var c,d;return a.length>1&&(c=a[1].replace(/^(\w+)::/,""),d=a[2]),{id:b,name:c||"",type:d||""}},parseNodeProperty:function(a,b,c){var d=this.getCurrentNode(),e=d.name;if(void 0!==e){var f=e.match(/Properties(\d)+/);if(f)return void this.parseNodeSpecialProperty(a,b,c)}if("C"==b){var g=c.split(",").slice(1),h=parseInt(g[0]),i=parseInt(g[1]),j=c.split(",").slice(3);b="connections",c=[h,i],c=c.concat(j),void 0===d.properties[b]&&(d.properties[b]=[])}if("Node"==b){var k=parseInt(c);d.properties.id=k,d.id=k}b in d.properties?Array.isArray(d.properties[b])?d.properties[b].push(c):d.properties[b]+=c:Array.isArray(d.properties[b])?d.properties[b].push(c):d.properties[b]=c,this.setCurrentProp(d.properties,b)},parseNodePropertyContinued:function(a){this.currentProp[this.currentPropName]+=a},parseNodeSpecialProperty:function(a,b,c){var d=c.split('",').map(function(a){return a.trim().replace(/^\"/,"").replace(/\s/,"_")}),e=d[0],f=d[1],g=d[2],h=d[3],i=d[4];switch(f){case"int":i=parseInt(i);break;case"double":i=parseFloat(i);break;case"ColorRGB":case"Vector3D":var j=i.split(",");i=new THREE.Vector3(j[0],j[1],j[2])}this.getPrevNode().properties[e]={type:f,type2:g,flag:h,value:i},this.setCurrentProp(this.getPrevNode().properties,e)},nodeEnd:function(a){this.popStack()},isFlattenNode:function(a){return"subNodes"in a&&"properties"in a}},c.prototype={},d.prototype.parseCluster=function(a,b,c){var d=a.searchConnectionParent(b),e=toInt(c.subNodes.Indexes.properties.a.split(",")),f=toFloat(c.subNodes.Weights.properties.a.split(",")),g=toMat44(toFloat(c.subNodes.Transform.properties.a.split(","))),h=toMat44(toFloat(c.subNodes.TransformLink.properties.a.split(",")));return{parent:d,id:parseInt(b),indices:e,weights:f,transform:g,transformlink:h,linkMode:c.properties.Mode}},d.prototype.parse=function(a,b){this.skinIndices=[],this.skinWeights=[],this.matrices=[];var c=a.Objects.subNodes.Deformer,d={};for(var e in c)if("Cluster"===c[e].attrType){if(!("Indexes"in c[e].subNodes))continue;var f=this.parseCluster(a,e,c[e]),g=a.searchConnectionChildren(f.id)[0];d[g]=f}for(var h=[],i=b.hierarchy,j=0;j<i.length;++j){var k=i[j].internalId;if(void 0!==d[k]){var l=d[k];this.matrices.push(l.transform);for(var m=0;m<l.indices.length;++m){void 0===h[l.indices[m]]&&(h[l.indices[m]]={},h[l.indices[m]].joint=[],h[l.indices[m]].weight=[]);var n=a.searchConnectionChildren(l.id);n.length>1&&console.warn("FBXLoader: node "+l.id+" have many weight kids: "+n),h[l.indices[m]].joint.push(b.getBoneIdfromInternalId(a,n[0])),h[l.indices[m]].weight.push(l.weights[m])}}else this.matrices.push(new THREE.Matrix4)}for(var o=0;o<h.length;o++){var p=new THREE.Vector4(h[o].joint[0]?h[o].joint[0]:0,h[o].joint[1]?h[o].joint[1]:0,h[o].joint[2]?h[o].joint[2]:0,h[o].joint[3]?h[o].joint[3]:0),q=new THREE.Vector4(h[o].weight[0]?h[o].weight[0]:0,h[o].weight[1]?h[o].weight[1]:0,h[o].weight[2]?h[o].weight[2]:0,h[o].weight[3]?h[o].weight[3]:0);this.skinIndices.push(p),this.skinWeights.push(q)}return this},e.prototype.parseHierarchy=function(a){var b=a.Objects,c=b.subNodes.Model,d=[];for(var e in c)void 0!==c[e].attrType&&d.push(c[e]);this.hierarchy=[];for(var f=0;f<d.length;++f){var g=d[f],h=a.searchConnectionParent(g.id)[0],i=[0,0,0],j=[0,0,0,1],k=[1,1,1];if("Lcl_Translation"in g.properties&&(i=toFloat(g.properties.Lcl_Translation.value.split(","))),"Lcl_Rotation"in g.properties){j=toRad(toFloat(g.properties.Lcl_Rotation.value.split(",")));var l=new THREE.Quaternion;l.setFromEuler(new THREE.Euler(j[0],j[1],j[2],"ZYX")),j=[l.x,l.y,l.z,l.w]}"Lcl_Scaling"in g.properties&&(k=toFloat(g.properties.Lcl_Scaling.value.split(",")));var m=g.attrName;m=m.replace(/:/,""),m=m.replace(/_/,""),m=m.replace(/-/,""),this.hierarchy.push({parent:h,name:m,pos:i,rotq:j,scl:k,internalId:g.id})}return this.reindexParentId(),this.restoreBindPose(a),this},e.prototype.reindexParentId=function(){for(var a=0;a<this.hierarchy.length;a++)for(var b=0;b<this.hierarchy.length;++b)if(this.hierarchy[a].parent==this.hierarchy[b].internalId){this.hierarchy[a].parent=b;break}},e.prototype.restoreBindPose=function(a){var b=a.Objects.subNodes.Pose;if(void 0!==b){for(var c=b.subNodes.PoseNode,d={},e={},f=0;f<c.length;++f){var g=toMat44(c[f].subNodes.Matrix.properties.a.split(",")),h=toMat44(c[f].subNodes.Matrix.properties.a.split(","));d[c[f].id]=g,e[c[f].id]=h}for(var i=0;i<this.hierarchy.length;++i){var j=this.hierarchy[i],k=j.internalId;if(void 0!==e[k]){for(var l,m=new THREE.Vector3(0,0,0),n=new THREE.Quaternion,o=new THREE.Vector3(1,1,1),p=a.searchConnectionParent(k),q=0;q<p.length;++q)if(this.isBoneNode(p[q])){l=p[q];break}if(void 0!==l&&void 0!==d[l]){var r=new THREE.Matrix4;r.getInverse(e[l]),r.multiply(d[k]),d[k]=r}d[k].decompose(m,n,o),j.pos=[m.x,m.y,m.z],j.rotq=[n.x,n.y,n.z,n.w],j.scl=[o.x,o.y,o.z]}}}},e.prototype.searchRealId=function(a){for(var b=0;b<this.hierarchy.length;b++)if(a==this.hierarchy[b].internalId)return b;return-1},e.prototype.getByInternalId=function(a){for(var b=0;b<this.hierarchy.length;b++)if(a==this.hierarchy[b].internalId)return this.hierarchy[b];return null},e.prototype.isBoneNode=function(a){for(var b=0;b<this.hierarchy.length;++b)if(a===this.hierarchy[b].internalId)return!0;return!1},e.prototype.getBoneIdfromInternalId=function(a,b){if(void 0===a.__cache_get_boneid_from_internalid&&(a.__cache_get_boneid_from_internalid=[]),void 0!==a.__cache_get_boneid_from_internalid[b])return a.__cache_get_boneid_from_internalid[b];for(var c=0;c<this.hierarchy.length;++c)if(this.hierarchy[c].internalId==b){return a.__cache_get_boneid_from_internalid[b]=c,c}return-1},f.prototype.parse=function(a){return this.node=a,this.name=a.attrName,this.id=a.id,this.vertices=this.getVertices(),void 0===this.vertices?void console.log("FBXLoader: Geometry.parse(): pass"+this.node.id):(this.indices=this.getPolygonVertexIndices(),this.uvs=(new g).parse(this.node,this),this.normals=(new h).parse(this.node,this),this.getPolygonTopologyMax()>3&&(this.indices=this.convertPolyIndicesToTri(this.indices,this.getPolygonTopologyArray())),this)},f.prototype.getVertices=function(){if(this.node.__cache_vertices)return this.node.__cache_vertices;if(void 0===this.node.subNodes.Vertices)return console.warn("this.node: "+this.node.attrName+"("+this.node.id+") does not have Vertices"),this.node.__cache_vertices=void 0,null;var a=this.node.subNodes.Vertices.properties.a,b=a.split(",").map(function(a){return parseFloat(a)});return this.node.__cache_vertices=b,this.node.__cache_vertices},f.prototype.getPolygonVertexIndices=function(){if(this.node.__cache_indices&&this.node.__cache_poly_topology_max)return this.node.__cache_indices;if(void 0===this.node.subNodes)return console.error("this.node.subNodes undefined"),void console.log(this.node);if(void 0===this.node.subNodes.PolygonVertexIndex)return console.warn("this.node: "+this.node.attrName+"("+this.node.id+") does not have PolygonVertexIndex "),void(this.node.__cache_indices=void 0);for(var a=this.node.subNodes.PolygonVertexIndex.properties.a,b=a.split(","),c=1,d=null,e=[],f=0;f<b.length;++f){var g=parseInt(b[f]);g<0?(c>d&&(d=c),b[f]=g^-1,e.push(c),c=1):(b[f]=g,c++)}return null===d&&(console.warn("FBXLoader: topology N not found: "+this.node.attrName),console.warn(this.node),d=3),this.node.__cache_poly_topology_max=d,this.node.__cache_poly_topology_arr=e,this.node.__cache_indices=b,this.node.__cache_indices},f.prototype.getPolygonTopologyMax=function(){return this.node.__cache_indices&&this.node.__cache_poly_topology_max?this.node.__cache_poly_topology_max:(this.getPolygonVertexIndices(this.node),this.node.__cache_poly_topology_max)},f.prototype.getPolygonTopologyArray=function(){return this.node.__cache_indices&&this.node.__cache_poly_topology_max?this.node.__cache_poly_topology_arr:(this.getPolygonVertexIndices(this.node),this.node.__cache_poly_topology_arr)},f.prototype.convertPolyIndicesToTri=function(a,b){for(var c=[],d=0,e=0,f=0;d<a.length;){f=b[e];for(var g=0;g<=f-3;g++)c.push(a[d]),c.push(a[d+(f-2-g)]),c.push(a[d+(f-1-g)]);e++,d+=f}return c},f.prototype.addBones=function(a){this.bones=a},g.prototype.getUV=function(a){return this.node&&this.uv&&this.map&&this.ref?this.uv:this._parseText(a)},g.prototype.getMap=function(a){return this.node&&this.uv&&this.map&&this.ref?this.map:(this._parseText(a),this.map)},g.prototype.getRef=function(a){return this.node&&this.uv&&this.map&&this.ref?this.ref:(this._parseText(a),this.ref)},g.prototype.getIndex=function(a){return this.node&&this.uv&&this.map&&this.ref?this.index:(this._parseText(a),this.index)},g.prototype.getNode=function(a){return null!==this.node?this.node:(this.node=a.subNodes.LayerElementUV,this.node)},g.prototype._parseText=function(a){var b=this.getNode(a);if(void 0===b)return[];var c=0,d="";for(var e in b)e.match(/^\d+$/)&&(c++,d=e);c>0&&(console.warn("multi uv not supported"),b=b[e]);var f=b.subNodes.UVIndex.properties.a,g=b.subNodes.UV.properties.a,h=b.properties.MappingInformationType,i=b.properties.ReferenceInformationType;return this.uv=toFloat(g.split(",")),this.index=toInt(f.split(",")),this.map=h,this.ref=i,this.uv},g.prototype.parse=function(a,b){this.uvNode=this.getNode(a),this.uv=this.getUV(a);var c=this.getMap(a),d=this.getRef(a),e=this.getIndex(a),f=b.getPolygonTopologyArray();switch(c){case"ByPolygonVertex":switch(d){case"Direct":this.uv=this.parseUV_ByPolygonVertex_Direct(this.uv,e,f,2);break;case"IndexToDirect":this.uv=this.parseUV_ByPolygonVertex_IndexToDirect(this.uv,e)}this.uv=o(this.uv,b.getPolygonVertexIndices(a),2);break;case"ByPolygon":switch(d){case"Direct":this.uv=this.parseUV_ByPolygon_Direct();break;case"IndexToDirect":this.uv=this.parseUV_ByPolygon_IndexToDirect()}}return this.uv},g.prototype.parseUV_ByPolygonVertex_Direct=function(a,b,c,d){return parse_Data_ByPolygonVertex_Direct(a,b,c,d)},g.prototype.parseUV_ByPolygonVertex_IndexToDirect=function(a,b){return n(a,b,2)},g.prototype.parseUV_ByPolygon_Direct=function(a){return console.warn("not implemented"),a},g.prototype.parseUV_ByPolygon_IndexToDirect=function(a){return console.warn("not implemented"),a},g.prototype.parseUV_ByVertex_Direct=function(a){return console.warn("not implemented"),a},h.prototype.getNormal=function(a){return this.node&&this.normal&&this.map&&this.ref?this.normal:(this._parseText(a),this.normal)},h.prototype.getMap=function(a){return this.node&&this.normal&&this.map&&this.ref?this.map:(this._parseText(a),this.map)},h.prototype.getRef=function(a){return this.node&&this.normal&&this.map&&this.ref?this.ref:(this._parseText(a),this.ref)},h.prototype.getNode=function(a){return this.node?this.node:(this.node=a.subNodes.LayerElementNormal,this.node)},h.prototype._parseText=function(a){var b=this.getNode(a);if(void 0===b)return void console.warn("node: "+a.attrName+"("+a.id+") does not have LayerElementNormal");var c=b.properties.MappingInformationType,d=b.properties.ReferenceInformationType,e=b.subNodes.Normals.properties.a;this.normal=toFloat(e.split(",")),this.map=c,this.ref=d},h.prototype.parse=function(a,b){var c=this.getNormal(a),d=(this.getNode(a),this.getMap(a)),e=this.getRef(a),f=b.getPolygonVertexIndices(a),g=b.getPolygonTopologyArray(a);switch(d){case"ByPolygonVertex":switch(e){case"Direct":c=this.parseNormal_ByPolygonVertex_Direct(c,f,g,3);break;case"IndexToDirect":c=this.parseNormal_ByPolygonVertex_IndexToDirect()}break;case"ByPolygon":switch(e){case"Direct":c=this.parseNormal_ByPolygon_Direct();break;case"IndexToDirect":c=this.parseNormal_ByPolygon_IndexToDirect()}}return c},h.prototype.parseNormal_ByPolygonVertex_Direct=function(a,b,c,d){return parse_Data_ByPolygonVertex_Direct(a,b,c,d)},h.prototype.parseNormal_ByPolygonVertex_IndexToDirect=function(a){return console.warn("not implemented"),a},h.prototype.parseNormal_ByPolygon_Direct=function(a){return console.warn("not implemented"),a},h.prototype.parseNormal_ByPolygon_IndexToDirect=function(a){return console.warn("not implemented"),a},h.prototype.parseNormal_ByVertex_Direct=function(a){return console.warn("not implemented"),a},i.prototype.fromNode=function(a){return this.id=a.id,this.internalId=a.id,this.times=a.subNodes.KeyTime.properties.a,this.values=a.subNodes.KeyValueFloat.properties.a,this.attrFlag=a.subNodes.KeyAttrFlags.properties.a,this.attrData=a.subNodes.KeyAttrDataFloat.properties.a,this.times=toFloat(this.times.split(",")),this.values=toFloat(this.values.split(",")),this.attrData=toFloat(this.attrData.split(",")),this.attrFlag=toInt(this.attrFlag.split(",")),this.times=this.times.map(function(a){return p(a)}),this},i.prototype.getLength=function(){return this.times[this.times.length-1]},j.prototype.fromNode=function(a,b,c){if(this.id=b.id,this.attr=b.attrName,this.internalId=b.id,!this.attr.match(/S|R|T/))return null;for(var d in b.properties)d.match(/X/)&&(this.attrX=!0),d.match(/Y/)&&(this.attrY=!0),d.match(/Z/)&&(this.attrZ=!0);this.containerIndices=a.searchConnectionParent(this.id),this.curveIdx=a.searchConnectionChildren(this.id);for(var e=this.containerIndices.length-1;e>=0;--e){var f=c.searchRealId(this.containerIndices[e]);if(f>=0&&(this.containerBoneId=f,this.containerId=this.containerIndices[e]),f>=0)break}return this},j.prototype.setCurve=function(a){this.curves.push(a)},k.prototype.parse=function(a,b){var c=a.Objects.subNodes.AnimationCurveNode,d=a.Objects.subNodes.AnimationCurve,e=[];for(var f in c)if(f.match(/\d+/)){var g=(new j).fromNode(a,c[f],b);e.push(g)}for(var h={},k=0;k<e.length;++k)null!==e[k]&&(h[e[k].id]=e[k]);var l=[],m=0;for(f in d)if(f.match(/\d+/)){var n=(new i).fromNode(d[f]);l.push(n),m=n.getLength()?n.getLength():m;var o=a.searchConnectionParent(n.id)[0],p=a.searchConnectionType(n.id,o);p.match(/X/)&&(p="x"),p.match(/Y/)&&(p="y"),p.match(/Z/)&&(p="z"),h[o].curves[p]=n}for(var q in h){var r=h[q].containerBoneId;void 0===this.curves[r]&&(this.curves[r]={}),this.curves[r][h[q].attr]=h[q]}return this.length=m,this.frames=this.length*this.fps,this},l.prototype.add=function(a){void 0===this.textures&&(this.textures=[]),this.textures.push(a);for(var b=0;b<a.parentIds.length;++b)void 0===this.perGeoMap[a.parentIds[b]]&&(this.perGeoMap[a.parentIds[b]]=[]),this.perGeoMap[a.parentIds[b]].push(this.textures[this.textures.length-1])},l.prototype.parse=function(a,b){var c=a.Objects.subNodes.Texture;for(var d in c){var e=(new m).parse(c[d],a);this.add(e)}return this},l.prototype.getById=function(a){return this.perGeoMap[a]},m.prototype.parse=function(a,b){return this.id=a.id,this.name=a.attrName,this.fileName=this.parseFileName(a.properties.FileName),
this.parentIds=this.searchParents(this.id,b),this},m.prototype.parseFileName=function(a){if(void 0===a)return"";var b=a.split(/[\\\/]/);return b.length>0?b[b.length-1]:a},m.prototype.searchParents=function(a,b){var c=b.searchConnectionParent(a);return c},parse_Data_ByPolygonVertex_Direct=function(a,b,c,d){for(var e=[],f=0,g=0;g<b.length;++g){e[b[g]]=[];for(var h=0;h<d;++h)e[b[g]][h]=a[f+h];f+=d}for(var i=[],j=0;j<e.length;++j)if(void 0!==e[j])for(var k=0;k<d;++k)void 0!==e[j][k]&&i.push(e[j][k]);return i};var p=function(a){return a/46186158e3};degToRad=function(a){return a*Math.PI/180},radToDeg=function(a){return 180*a/Math.PI},quatFromVec=function(a,b,c){var d=new THREE.Euler(a,b,c,"ZYX"),e=new THREE.Quaternion;return e.setFromEuler(d),e},toInt=function(a){return a.map(function(a){return parseInt(a)})},toFloat=function(a){return a.map(function(a){return parseFloat(a)})},toRad=function(a){return a.map(function(a){return degToRad(a)})},toMat44=function(a){var b=new THREE.Matrix4;return b.set(a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]),b}}();var FBXAsset=AnimationProviderAsset.$extend({__init__:function(a){this.$super(a,"FBXAsset",AnimationProviderAsset.Type.SkinnedMesh),this.requiresCloning=!0,this.mesh=void 0},_cloneImpl:function(a){var b=new FBXAsset(a);return b.mesh=this.mesh.clone(),b},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:void 0},isLoaded:function(){return void 0!==this.mesh},getBoneParent:function(){return this.skin?this.skin:this.isLoaded()?this.mesh:null},isAttached:function(){return Object.keys(this.animationHierarchy).length>0},deserializeFromData:function(a,b,c){try{var d=new THREE.FBXLoader;d.textureBasePath=this.baseRef.substring(0,this.baseRef.length-1),this.mesh=d.parse(a),this.mesh.traverse(function(a){if(a instanceof THREE.SkinnedMesh&&(this.skin=a,a.geometry.animations||a.geometry.morphAnimations))for(var b=a.geometry.animations,c=0,d=b.length;c<d;++c)this.animationHierarchy[b[c].name]=b[c]}.bind(this)),this._emitLoaded(),console.log("FBX: deserializeFromData:",this.mesh)}catch(e){return console.log("[FBXAsset]: Failed to deserialize FBX asset from data: ",e),!1}},unload:function(){this.requiresCloning&&this.isCloneSource||(this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.skin&&this.skin.parent&&this.skin.parent.remove(this.skin))}});THREE.AssimpJSONLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.AssimpJSONLoader.prototype={constructor:THREE.AssimpJSONLoader,load:function(a,b,c,d){var e=this;this.texturePath=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:this.extractUrlBase(a);var f=new THREE.XHRLoader(this.manager);f.load(a,function(a){var c,f,g=JSON.parse(a);if(f=g.__metadata__,"undefined"!=typeof f){if("assimp2json"!==f.format)return void d("Not an assimp2json scene");if(f.version<100&&f.version>=200)return void d("Unsupported assimp2json file format version")}c=e.parse(g),b(c)},c,d)},setCrossOrigin:function(a){this.crossOrigin=a},setTexturePath:function(a){this.texturePath=a},extractUrlBase:function(a){var b=a.split("/");return b.pop(),(b.length<1?".":b.join("/"))+"/"},parse:function(a){var b=this.parseList(a.meshes,this.parseMesh),c=this.parseList(a.materials,this.parseMaterial);return this.parseObject(a,a.rootnode,b,c)},parseList:function(a,b){for(var c=new Array(a.length),d=0;d<a.length;++d)c[d]=b.call(this,a[d]);return c},parseMesh:function(a){function b(a,b,c){var d,e,f,g,h,i;for(d=0,e=b.length;d<e;++d)f=b[d],g=2*f.a,h=2*f.b,i=2*f.c,c.push([new THREE.Vector2(a[g],a[g+1]),new THREE.Vector2(a[h],a[h+1]),new THREE.Vector2(a[i],a[i+1])])}function c(a,b){var c,d,e,f,g,h;for(c=0,d=b.length;c<d;++c)e=b[c],f=3*e.a,g=3*e.b,h=3*e.c,e.vertexNormals=[new THREE.Vector3(a[f],a[f+1],a[f+2]),new THREE.Vector3(a[g],a[g+1],a[g+2]),new THREE.Vector3(a[h],a[h+1],a[h+2])]}function d(a,b){for(var c=0,d=b.length;c<d;++c){var e=b[c],f=4*e.a,g=4*e.b,h=4*e.c;e.vertexColors=[(new THREE.Color).fromArray(f),(new THREE.Color).fromArray(g),(new THREE.Color).fromArray(h)]}}var e,f,g,h,i;for(e=new THREE.Geometry,h=a.vertices,f=0,g=h.length;f<g;)e.vertices.push(new THREE.Vector3(h[f++],h[f++],h[f++]));for(h=a.faces,f=0,g=h.length;f<g;++f)i=h[f],face=new THREE.Face3(i[0],i[1],i[2]),e.faces.push(face);for(a.texturecoords=a.texturecoords||[],f=0,g=a.texturecoords.length;f<g;++f)b(a.texturecoords[f],e.faces,e.faceVertexUvs[f]);return a.normals&&c(a.normals,e.faces),a.colors&&a.colors[0]&&d(a.colors[0],e.faces),e.computeBoundingSphere(),e},parseMaterial:function(a){function b(a){var b=new THREE.Color;return b.setRGB(a[0],a[1],a[2]),b}function c(){var a=new Image;return a.width=1,a.height=1,new THREE.Texture(a)}var d,e,f=null,g=this,h=[],i={shading:THREE.SmoothShading};for(var d in a.properties)e=a.properties[d],"$tex.file"===e.key?1!==e.semantic&&5!==e.semantic&&6!==e.semantic&&2!==e.semantic||!function(a){var b,c=new THREE.TextureLoader(g.manager);1===a?b="map":5===a?b="bumpMap":6===a?b="normalMap":2===a&&(b="specularMap"),h.push(b),c.setCrossOrigin(this.crossOrigin);var d=g.texturePath+"/"+e.value;d=d.replace(/\\/g,"/"),c.load(d,function(a){a&&(a.wrapS=a.wrapT=THREE.RepeatWrapping,f[b]=a,f.needsUpdate=!0)})}(e.semantic):"?mat.name"===e.key?i.name=e.value:"$clr.diffuse"===e.key?i.color=b(e.value):"$clr.specular"===e.key?i.specular=b(e.value):"$clr.emissive"===e.key?i.emissive=b(e.value):"$mat.shadingm"===e.key?1===e.value&&(i.shading=THREE.FlatShading):"$mat.shininess"===e.key&&(i.shininess=e.value);if(h.length)for(d=h.length-1;d>=0;--d)i[h[d]]=c();return f=new THREE.MeshPhongMaterial(i)},parseObject:function(a,b,c,d){var e,f,g=new THREE.Object3D;for(g.name=b.name||"",g.matrix=(new THREE.Matrix4).fromArray(b.transformation).transpose(),g.matrix.decompose(g.position,g.quaternion,g.scale),e=0;b.meshes&&e<b.meshes.length;++e)f=b.meshes[e],g.add(new THREE.Mesh(c[f],d[a.meshes[f].materialindex]));for(e=0;b.children&&e<b.children.length;++e)g.add(this.parseObject(a,b.children[e],c,d));return g}};var AssimpJsonAsset=IAsset.$extend({__init__:function(a){this.$super(a,"AssimpJsonAsset"),this.requiresCloning=!0,this.mesh=void 0},_cloneImpl:function(a){var b=new AssimpJsonAsset(a);return b.mesh=this.mesh.clone(),b},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:void 0},isLoaded:function(){return void 0!==this.mesh},deserializeFromData:function(a,b,c){try{var d=a.__metadata__;if(d){if("assimp2json"!==d.format)return this.log.error("Not an assimp file format:",d.format),!1;if(d.version<100&&d.version>=200)return this.log.error("Unsupported assimp version:",d.version),!1}var e=new THREE.AssimpJSONLoader;e.texturePath=this.baseRef.substring(0,this.baseRef.length-1),this.mesh=e.parse(a),this._emitLoaded()}catch(f){return this.log.error("Could not load assimp asset:",f),!1}},unload:function(){this.requiresCloning&&this.isCloneSource||this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh)}}),EC_EnvironmentLight=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"sunColor",new Color(.639,.639,.639),Attribute.Color,"Sunlight color"),this.declareAttribute(1,"ambientColor",Tundra.renderer.defaultSceneAmbientLightColor(),Attribute.Color,"Ambient light color"),this.declareAttribute(2,"sunDirection",new THREE.Vector3(-1,-1,-1),Attribute.Float3,"Sunlight direction vector"),this.declareAttribute(3,"sunCastShadows",!0,Attribute.Bool,"Sunlight cast shadows"),this.declareAttribute(4,"brightness",1,Attribute.Real,"Brightness")},__classvars__:{TypeId:8,TypeName:"EnvironmentLight"}}),EC_EnvironmentLight_ThreeJs=EC_EnvironmentLight.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.directionalLight=null,this.subs=[],this.limiter=new FrameLimiter(1/30)},__classvars__:{Implementation:"three.js"},reset:function(){var a=!1,b=Tundra.renderer;null!=this.directionalLight&&(a=!0,b.scene.remove(this.directionalLight)),this.directionalLight=null,b.ambientLight.color=b.defaultSceneAmbientLightColor();for(var c=0;c<this.subs.length;c++)this.subs[c].reset();this.subs=[],a&&b.updateLights(this)},onActiveCameraChanged:function(a){null!=a&&null!=a.camera&&this.onUpdate(1)},onUpdate:function(a){return},update:function(){this.createLight(),Tundra.renderer.ambientLight.color=this.ambientColor.toThreeColor()},onShadowSettingsChanged:function(a){null!=this.directionalLight&&(this.directionalLight.shadow.mapSize.width=a.textureSize.width,this.directionalLight.shadow.mapSize.height=a.textureSize.height,this.directionalLight.shadow.camera.near=a.clip.near,this.directionalLight.shadow.camera.far=a.clip.far,this.directionalLight.shadow.camera.right=a.bounds.right,this.directionalLight.shadow.camera.left=a.bounds.left,this.directionalLight.shadow.camera.top=a.bounds.top,this.directionalLight.shadow.camera.nottom=a.bounds.bottom)},recreateLight:function(){this._lights_self_change!==!0&&(this.reset(),this.update())},createLight:function(){if(null==this.directionalLight){var a=Tundra.renderer;this.directionalLight=a.createLight("directional"),this.directionalLight.color=this.sunColor.toThreeColor(),this.directionalLight.castShadow=this.sunCastShadows,this.directionalLight.intensity=.6*this.brightness,this.directionalLight.position.copy(this.sunDirection.multiplyScalar(1e3).negate()),this.onShadowSettingsChanged(a.shadowSettings),this.onActiveCameraChanged(a.activeCameraComponent),a.scene.add(this.directionalLight),a.updateLights(this),0===this.subs.length&&(this.subs.push(a.onShadowSettingsChanged(this,this.onShadowSettingsChanged)),this.subs.push(a.onActiveCameraChanged(this,this.onActiveCameraChanged)),this.subs.push(Tundra.frame.onUpdate(this,this.onUpdate)))}},attributeChanged:function(a,b,c){if(null!=this.directionalLight)switch(a){case 0:this.directionalLight.color=c.toThreeColor();break;case 1:Tundra.renderer.ambientLight.color=c.toThreeColor();break;case 2:this.directionalLight.position.copy(c.multiplyScalar(1e3).negate());case 3:this.directionalLight.castShadow=this.sunCastShadows,Tundra.renderer.updateLights(this);break;case 4:this.directionalLight.intensity=.6*c}},setSunColor:function(a){this.sunColor=Color.fromString(a)},setAmbientColor:function(a){this.ambientColor=Color.fromString(a)}}),EC_Fog=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"mode",EC_Fog.Type.Linear,Attribute.Int,"Mode"),this.declareAttribute(1,"color",new Color(.707792,.770537,.831373,1),Attribute.Color,"Sunlight color"),this.declareAttribute(2,"startDistance",100,Attribute.Real,"Start distance"),this.declareAttribute(3,"endDistance",2e3,Attribute.Real,"End distance"),this.declareAttribute(4,"expDensity",.001,Attribute.Real,"Exponential density")},__classvars__:{TypeId:9,TypeName:"Fog",Type:{NoFog:0,Exponentially:1,ExponentiallySquare:2,Linear:3}}}),EC_Fog_ThreeJs=EC_Fog.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this._activated=!1},__classvars__:{Implementation:"three.js"},reset:function(a){(this._activated||a===!0)&&(this._activated=!1,Tundra.renderer.scene.fog=null,Tundra.renderer.renderer.setClearColor(0),this._forceMaterialUpdates())},update:function(){return this._activated||null==Tundra.renderer.scene.fog?(this._forceMaterialUpdates(),void this._createFog(this.mode)):void this.log.warn("Fog is already set, only the first initialized fog will be enabled. Inactivating",this.toString())},_forceMaterialUpdates:function(){for(var a=Tundra.renderer.getAllMeshes(),b=0;b<a.length;b++)void 0!==a[b].material&&null!==a[b].material&&(a[b].material.needsUpdate=!0)},_createFog:function(a){return this.reset(!0),a===EC_Fog.Type.NoFog?void(this._activated=!0):(a===EC_Fog.Type.Linear?Tundra.renderer.scene.fog=new THREE.Fog(this.color.toThreeColor(),this.startDistance,this.endDistance):Tundra.renderer.scene.fog=new THREE.FogExp2(this.color.toThreeColor(),this.expDensity),this._activated=null!=Tundra.renderer.scene.fog,void(this._activated&&Tundra.renderer.renderer.setClearColor(Tundra.renderer.scene.fog.color)))},attributeChanged:function(a,b,c){this._activated&&(0===a?this._createFog(c):1===a?(Tundra.renderer.scene.fog.color=c.toThreeColor(),Tundra.renderer.renderer.setClearColor(Tundra.renderer.scene.fog.color)):2===a?Tundra.renderer.scene.fog.near=c:3===a?Tundra.renderer.scene.fog.far=c:4===a&&(Tundra.renderer.scene.fog.density=c))}}),EC_Sky=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),10===this.typeId&&(this.declareAttribute(0,"materialRef","",Attribute.AssetReference,"Material"),this.declareAttribute(1,"textureRefs",[],Attribute.AssetReferenceList,"Texture"),this.declareAttribute(2,"distance",999,Attribute.Real,"Distance"),this.declareAttribute(3,"orientation",new THREE.Quaternion(0,0,0,1),Attribute.Quat,"Orientation"),this.declareAttribute(4,"drawFirst",!0,Attribute.Bool,"Draw first"),this.declareAttribute(5,"enabled",!0,Attribute.Bool,"Enabled"))},__classvars__:{TypeId:10,TypeName:"Sky"}}),EC_Sky_ThreeJs=EC_Sky.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.skyBoxMesh=null,this.skyBoxMaterial=null,this.skyBoxTexture=null,this.directionLight=null,this.skyLoaded=!1,this.skipLoading=!1,this.texturesRequested=!1,this.texturesLoaded=!1,this.textures=[],this.envLightChecked=!0},__classvars__:{Implementation:"three.js"},reset:function(){if(null!=this.skyBoxMesh&&(null!=this.skyBoxMesh.geometry&&(this.skyBoxMesh.geometry.dispose(),this.skyBoxMesh.geometry=null),Tundra.renderer.scene.remove(this.skyBoxMesh),this.skyBoxMesh=null),null!=this.directionLight&&(Tundra.renderer.scene.remove(this.directionLight),this.directionLight=null),null!=this.skyBoxTexture&&(this.skyBoxTexture.dispose(),this.skyBoxTexture=null),null!=this.skyBoxMaterial){for(var a=0;a<this.skyBoxMaterial.materials.length;a++)this.skyBoxMaterial.materials[a].dispose();this.skyBoxMaterial.materials=[],this.skyBoxMaterial=null}this.envLightChecked=!1,this.skyLoaded=!1,this.skipLoading=!1,this.texturesRequested=!1,this.texturesLoaded=!1,this.textures=[],void 0!==this.frameUpdateSubscription&&(Tundra.events.unsubscribe(this.frameUpdateSubscription),this.frameUpdateSubscription=void 0)},setParent:function(a){this.$super(a),this.update()},checkExistingSky:function(){if(null==this.parentEntity||null==this.parentEntity.parentScene)return!1;for(var a=this.parentEntity.parentScene.components("Sky"),b=0;b<a.length;b++)if(a[b].skyLoaded===!0)return!0;a=this.parentEntity.parentScene.components("SkyX");for(var b=0;b<a.length;b++)if(a[b].skyLoaded===!0)return!0;return!1},update:function(){if(null!=this.parentEntity&&null!=this.parentEntity.parentScene&&!this.skyLoaded&&!this.skipLoading){if(this.skipLoading=this.checkExistingSky(),this.skipLoading)return void console.log("Skipping loading of "+this.typeName+", scene already has a sky component");if(this.envLightChecked||(Tundra.frame.delayedExecute(1,this,function(){if(null!=this.parentScene){var a=this.parentScene.entitiesWithComponent("EnvironmentLight");if(0===a.length){var b=this.parentEntity.createComponent("EnvironmentLight","EC_Sky Created Light",AttributeChange.LocalOnly);null!=b&&(b.brightness=.5,b.sunDirection=new THREE.Vector3(-.5,-1,-.5))}}}),this.envLightChecked=!0),!this.texturesRequested){for(var a="http://meshmoon.data.s3.amazonaws.com/asset-library/skybox/default/rex_sky_",b=[a+"right.dds",a+"left.dds",a+"bot.dds",a+"top.dds",a+"front.dds",a+"back.dds"],c=0;c<b.length;++c){var d=Tundra.asset.requestAsset(b[c]);null!=d&&d.onCompleted(this,this.onSkyTextureLoaded,c)}this.texturesRequested=!0}if(this.texturesLoaded){if(void 0===this.frameUpdateSubscription&&(this.frameUpdateSubscription=Tundra.frame.onPreRender(this,this.onPreRender)),null==this.skyBoxMaterial){for(var e=[],c=0;c<this.textures.length;++c){var f=this.textures[c].texture;f.wrapS=THREE.ClampToEdgeWrapping,f.wrapT=THREE.ClampToEdgeWrapping,f.needsUpdate=!0,e.push(new THREE.MeshBasicMaterial({map:f,side:THREE.BackSide,depthWrite:!1}))}this.skyBoxMaterial=new THREE.MeshFaceMaterial(e)}null==this.skyBoxMesh&&(this.skyBoxMesh=new THREE.Mesh(new THREE.BoxGeometry(2500,2500,2500,1,1,1),this.skyBoxMaterial),this.skyBoxMesh.scale.set(2,2,2),this.skyBoxMesh.renderOrder=-1e5,this.skyBoxMesh.quaternion.setFromEuler(new THREE.Euler(Math.PI,0,0)),this.skyBoxMesh.name=this.typeName+"-mesh",Tundra.renderer.scene.add(this.skyBoxMesh)),this.skyLoaded=!0;for(var g=this.parentEntity.parentScene.components("WaterPlane"),c=0;c<g.length;c++)g[c].waterLoaded===!0&&null!=g[c].waterMaterial&&(g[c].waterMaterial.needsUpdate=!0);g=this.parentEntity.parentScene.components("HydraX");for(var c=0;c<g.length;c++)g[c].waterLoaded===!0&&null!=g[c].waterMaterial&&(g[c].waterMaterial.needsUpdate=!0)}}},onSkyTextureLoaded:function(a,b){this.textures[b]=a;for(var c=0;c<6;c++)if(void 0===this.textures[c]||null===this.textures[c])return;this.texturesLoaded=!0,this.update()},onPreRender:function(){if(null!=this.skyBoxMesh){var a=Tundra.renderer.activeCameraEntity(),b=a&&a.placeable?a.placeable.worldPosition():void 0;b&&(this.skyBoxMesh.position.x=b.x,this.skyBoxMesh.position.y=b.y,this.skyBoxMesh.position.z=b.z,this.skyBoxMesh.updateMatrixWorld())}}}),EC_SkyX_ThreeJs=EC_Sky_ThreeJs.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d)},__classvars__:{TypeId:38,TypeName:"SkyX",Implementation:"three.js"}}),EC_AnimationController=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"animationState","",Attribute.String,"Animation state"),this.declareAttribute(1,"drawDebug",!1,Attribute.Bool,"Draw debug")},__classvars__:{TypeId:14,TypeName:"AnimationController"}}),EC_AnimationController_ThreeJs=EC_AnimationController.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.mixer=null,this.currentAnimation=null,this.subs={},this.onUpdateSubscription=void 0,this._toBeActivated={}},__classvars__:{Implementation:"three.js"},unsub:function(a){if("string"==typeof a){var b=this.subs[a];void 0!==b&&(Tundra.events.unsubscribe(b),this.subs[a]=void 0)}else if("boolean"==typeof a&&a===!0){for(var c=Object.keys(this.subs),d=0;d<c.length;d++)Tundra.events.unsubscribe(this.subs[c[d]]);this.subs={},this.onUpdateSubscription&&(this.onUpdateSubscription.reset(),this.onUpdateSubscription=void 0)}},reset:function(){this.unsub(!0)},update:function(){this.unsub("onComponentCreated"),this.subs.onComponentCreated=this.parentEntity.onComponentCreated(this,this.onComponentCreated),this.parentEntity.mesh&&(this.unsub("onAnimationsLoaded"),this.subs.onAnimationsLoaded=this.parentEntity.mesh.onAnimationsLoaded(this,this.onAnimationsLoaded),this.getSkeletonAsset()&&this._reloadMixer())},onComponentCreated:function(a,b){"Mesh"===b.typeName&&this.update()},onAnimationsLoaded:function(a,b,c){this._reloadMixer()},onFrameUpdate:function(a){this.mixer&&this.mixer.update(a)},attributeChanged:function(a,b,c){0===a&&this.playAnimation(c)},_reloadMixer:function(){var a=this.getSkeletonAsset();a&&a.isAttached()&&(this.mixer&&this.mixer.stopAllAction(),this.currentAnimation&&(this.currentAnimation.stop(),this.currentAnimation=void 0),this.mixer=new THREE.AnimationMixer(a.getBoneParent()),this.onUpdateSubscription||(this.onUpdateSubscription=Tundra.frame.onUpdate(this,this.onFrameUpdate)),this._toBeActivated.name&&this.playAnimation(this._toBeActivated.name,this._toBeActivated.loop,this._toBeActivated.speed,this._toBeActivated.fadein))},playAnimation:function(a,b,c,d){if(b="boolean"==typeof b&&b,c="number"==typeof c?c:1,this._toBeActivated={name:a,loop:b,speed:c,fadein:d},this.mixer){var e=this.getSkeletonAsset();if(!e)return void this.log.warn("playAnimation could not find valid skeleton from Mesh component in Entity '"+(this.parentEntity?this.parentEntity.toString():"")+"'");var f=e.getAnimation(a);if(null!=f){if(0!==e.animationType)return;var g=this.mixer.clipAction(f);if(g.timeScale=c,g.loop=b===!1?THREE.LoopOnce:THREE.LoopRepeat,this.mixer.stopAllAction(),"number"==typeof d&&this.currentAnimation){var h=this.currentAnimation.time;this.currentAnimation.play(),this.currentAnimation.time=h,g.play(),this.currentAnimation.crossFadeTo(g,d,!0)}else null!=this.currentAnimation&&this.currentAnimation.stop(),g.play();this.currentAnimation=g}else this.log.error("Could not find animation",a,"for playback in",e.originalName()," See EC_AnimationController.getAvailableAnimations().")}},getAvailableAnimations:function(){var a=this.getSkeletonAsset();return a?a.getAvailableAnimations():[]},getSkeletonAsset:function(){return this.parentEntity&&this.parentEntity.mesh&&this.parentEntity.mesh.meshAsset&&this.parentEntity.mesh.meshAsset.providesAnimations?this.parentEntity.mesh.meshAsset:this.parentEntity&&this.parentEntity.mesh&&this.parentEntity.mesh.skeletonAsset&&this.parentEntity.mesh.skeletonAsset.providesAnimations?this.parentEntity.mesh.skeletonAsset:null}}),EC_Light=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"type",EC_Light.Type.PointLight,Attribute.Int,"Light type"),this.declareAttribute(1,"diffColor",new Color(1,1,1),Attribute.Color,"Diffuse color"),this.declareAttribute(2,"specColor",new Color(0,0,0),Attribute.Color,"Specular color"),this.declareAttribute(3,"castShadows",!1,Attribute.Bool,"Cast shadows"),this.declareAttribute(4,"range",25,Attribute.Real,"Light range"),this.declareAttribute(5,"brightness",1,Attribute.Real,"Brightness"),this.declareAttribute(6,"constAtten",0,Attribute.Real,"Constant atten"),this.declareAttribute(7,"linearAtten",.01,Attribute.Real,"Linear atten"),this.declareAttribute(8,"quadraAtten",.01,Attribute.Real,"Quadratic atten"),this.declareAttribute(9,"innerAngle",30,Attribute.Real,"Light inner angle"),this.declareAttribute(10,"outerAngle",40,Attribute.Real,"Light outer angle")},__classvars__:{TypeId:16,TypeName:"Light",Type:{PointLight:0,SpotLight:1,DirectionalLight:2,AmbientLight:3},typeToString:function(a){return CoreStringUtils.enumToString(EC_Light.Type,a,void 0)}}}),EC_Light_ThreeJs=EC_Light.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.lightNode=null,this.lightDebugger=null,this._parentingSub=null,this._drawDebug=!1,Object.defineProperties(this,{drawDebug:{get:function(){return this._drawDebug},set:function(a){this._drawDebug=a,this._drawDebug?this._updateDebugger():this._destroyDebugger()}}})},__classvars__:{Implementation:"three.js",createLight:function(a,b,c,d){void 0!==b&&("string"==typeof b&&(b=Color.fromString(b)),b instanceof Color&&(b=b.toThreeColor())),void 0!==c&&null!==c||(c=1),void 0!==d&&null!==d||(d=0),c<0&&(c=0),d<=0&&(d=0);var e=null;return a===EC_Light.Type.PointLight?e=new THREE.PointLight(b,c,d):a===EC_Light.Type.SpotLight?e=new THREE.SpotLight(b,c,d):a===EC_Light.Type.DirectionalLight?e=new THREE.DirectionalLight(b,c,d):a===EC_Light.Type.AmbientLight?e=new THREE.AmbientLight(b):console.error("[EC_Light]: createLight(): Invalid EC_Light.Type!"),null!=e&&(e.matrixAutoUpdate=!1),e},createLightDebugger:function(a){if(null!=a.lightNode){var b=null;return a.lightNode instanceof THREE.PointLight?b=new THREE.PointLightHelper(a.lightNode,a.lightNode.distance):a.lightNode instanceof THREE.SpotLight?b=new THREE.SpotLightHelper(a.lightNode):a.lightNode instanceof THREE.DirectionalLight&&(b=new THREE.DirectionalLightHelper(a.lightNode,5)),b}}},reset:function(){this.destroy()},update:function(){this.create()},setDiffColor:function(a){this.diffColor=Color.fromString(a)},attributeChanged:function(a,b,c){if(0===a)this.destroy(),this.create();else if(1===a&&null!=this.lightNode)this.lightNode.color=c.toThreeColor(),this._updateDebugger(b);else if(3===a&&null!=this.lightNode)this.lightNode.castShadow=c,this._updateDebugger(b),Tundra.renderer.updateLights(this);else if(4===a&&null!=this.lightNode)this.lightNode.distance=c>=1?c:1,this._updateDebugger(b);else if(5===a&&null!=this.lightNode)this.lightNode.intensity=c>=0?c:0,this._updateDebugger(b);else if(9===a&&null!=this.lightNode){var d=.5*THREE.Math.degToRad(c);this.lightNode.angle=d,this._updateDebugger(b)}else if(10===a&&null!=this.lightNode){var d=.5*THREE.Math.degToRad(c);this.lightNode.exponent=Math.cos(d),this._updateDebugger(b)}},create:function(){if(null==this.lightNode){if(this.lightNode=EC_Light_ThreeJs.createLight(this.type,this.diffColor,this.brightness,this.range),this.type===EC_Light.Type.SpotLight){var a=.5*THREE.Math.degToRad(this.innerAngle);this.lightNode.angle=a,a=.5*THREE.Math.degToRad(this.outerAngle),this.lightNode.exponent=Math.cos(a)}this._parentLight()}},destroy:function(){this._destroyDebugger(),this.lightNode&&this.lightNode.parent&&(this.lightNode.parent.remove(this.lightNode),Tundra.renderer.updateLights(this)),null!=this._parentingSub&&Tundra.events.unsubscribe(this._parentingSub),this.lightNode=null,this._parentingSub=null},_updateDebugger:function(a){if(this._drawDebug===!0&&this.lightNode&&this.lightNode.parent){var b=!1;if(null==this.lightDebugger){if(this.lightDebugger=EC_Light_ThreeJs.createLightDebugger(this),null==this.lightDebugger)return;this.lightNode.add(this.lightDebugger),b=!0}if(void 0!==a&&!b&&"range"===a&&this.lightDebugger instanceof THREE.PointLightHelper)return this._destroyDebugger(),void this._updateDebugger();this.lightNode.updateMatrix(),this.lightNode.updateMatrixWorld(!0),this.lightDebugger.matrix=this.lightNode.matrix,this.lightDebugger.matrixAutoUpdate=!1,this.lightDebugger.update()}},_destroyDebugger:function(){null!=this.lightDebugger&&null!=this.lightDebugger.parent&&this.lightDebugger.parent.remove(this.lightDebugger),this.lightDebugger=null},_parentLight:function(){if(null!=this.parentEntity&&null!=this.lightNode&&null==this.lightNode.parent){if(null==this.parentEntity.placeable)return void(this._parentingSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated));null!=this._parentingSub&&Tundra.events.unsubscribe(this._parentingSub),this._parentingSub=null,this.lightNode.target instanceof THREE.Object3D&&(this.lightNode.target=this.parentEntity.placeable.sceneNode),this.lightNode.position.set(0,0,-1e-4),this.lightNode.matrixAutoUpdate=!1,this.parentEntity.placeable.addChild(this.lightNode),this._updateDebugger(),Tundra.renderer.updateLights(this)}},_onParentEntityComponentCreated:function(a,b){null!=b&&"Placeable"===b.typeName&&this._parentLight()}}),EC_Camera=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"upVector",new THREE.Vector3(0,1,0),Attribute.Float3),this.declareAttribute(1,"nearPlane",.1,Attribute.Real),this.declareAttribute(2,"farPlane",Tundra.browser.isMobile()?3e3:5e3,Attribute.Real),this.declareAttribute(3,"verticalFov",45,Attribute.Real),this.declareAttribute(4,"aspectRatio","",Attribute.String),this._orthographic=!1,Object.defineProperties(this,{orthographic:{get:function(){return this._orthographic},set:function(a){this._orthographic=a,this.onOrthographicChanged(this._orthographic)}}})},onOrthographicChanged:function(){},__classvars__:{TypeId:15,TypeName:"Camera"}}),ThreeJsCombinedCamera=Class.$extend({__init__:function(a,b,c,d,e){this._viewSize=a,Object.defineProperties(this,{viewSize:{get:function(){return this._viewSize},set:function(a){this._setViewSize(a)}}}),this._aspect=b,Object.defineProperties(this,{aspect:{get:function(){return this._aspect},set:function(a){this._setViewSize(void 0,a)}}}),this._fov=c,Object.defineProperties(this,{fov:{get:function(){return this._fov},set:function(a){this._setFov(a)}}}),this._near=d,Object.defineProperties(this,{near:{get:function(){return this._near},set:function(a){this._setNearFar(a)}}}),this._far=e,Object.defineProperties(this,{far:{get:function(){return this._far},set:function(a){this._setNearFar(void 0,a)}}}),this.left=-.5*(b*a),this.right=.5*(b*a),this.top=.5*a,this.bottom=-.5*a,this.cameraP=new THREE.PerspectiveCamera(c,b,d,e),this.cameraO=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,1e-6,1e10),this.cameraP._combinedCamera=this,this.cameraO._combinedCamera=this,this.orthographic=!1,this.toPerspective()},_setViewSize:function(a,b){a=a||this.viewSize,b=b||this.aspect,this._viewSize=a,this._aspect=b,this.left=-.5*(b*a),this.right=.5*(b*a),this.top=.5*a,this.bottom=-.5*a,this.updateOrthographic()},_setFov:function(a){this._fov=a,this.updatePerspective()},_setNearFar:function(a,b){a=a||this.near,b=b||this.far,this._near=a,this._far=b,this.updatePerspective(),this.updateOrthographic()},updatePerspective:function(){this.cameraP.fov=this.fov,this.cameraP.aspect=this.aspect,this.cameraP.near=this.near,this.cameraP.far=this.far,this.cameraP.updateProjectionMatrix()},toPerspective:function(a){this.updatePerspective(),this.currentCamera=this.cameraP,this.orthographic=!1,a===!0&&"function"==typeof this.onCameraChanged&&this.onCameraChanged(this.currentCamera)},updateOrthographic:function(){this.cameraO.near=1e-6,this.cameraO.far=1e10,this.cameraO.left=this.left,this.cameraO.right=this.right,this.cameraO.top=this.top,this.cameraO.bottom=this.bottom,this.cameraO.updateProjectionMatrix()},toOrthographic:function(a){this.updateOrthographic(),this.currentCamera=this.cameraO,this.orthographic=!0,a===!0&&"function"==typeof this.onCameraChanged&&this.onCameraChanged(this.currentCamera)}}),EC_Camera_ThreeJs=EC_Camera.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.camera=void 0,this._active=!1,Object.defineProperties(this,{active:{get:function(){return this.isActive()},set:function(a){this.setActive(a)}}}),this._windowSizeSub=Tundra.ui.onWindowResize(this,this.onWindowResize)},__classvars__:{Implementation:"three.js"},getWorldFocusPosition:function(){return null==this.parentEntity||null==this.parentEntity.placeable?null:this.parentEntity.placeable.worldPosition()},_farPlane:function(){return Tundra.renderer.options.logarithmicDepthBuffer===!0?1e27:this.farPlane},_nearPlane:function(){return Tundra.renderer.options.logarithmicDepthBuffer===!0?1e-6:this.nearPlane},update:function(){var a=this.aspectRatio();if(void 0===this._combinedCamera){var b=33200;this._combinedCamera=new ThreeJsCombinedCamera(b,a,this.verticalFov,this._nearPlane(),this._farPlane()),this._combinedCamera.onCameraChanged=function(a){this.camera=a,this.active&&(this.update(),Tundra.renderer.camera=a)}.bind(this),this.camera=this._combinedCamera.currentCamera,this._combinedCamera.viewSize=b}else this._combinedCamera.fov=this.verticalFov,this._combinedCamera.aspect=a,this._combinedCamera.near=this._nearPlane(),this._combinedCamera.far=this._farPlane();!this.camera.parent&&this.parentEntity&&(null!=this.parentEntity.placeable?this.parentEntity.placeable.addChild(this.camera):this._componentAddedSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated))},reset:function(){this.active&&Tundra.renderer.setActiveCamera(null),this._componentAddedSub&&(this._componentAddedSub.reset(),this._componentAddedSub=void 0),this._windowSizeSub&&(this._windowSizeSub.reset(),this._windowSizeSub=void 0)},_onParentEntityComponentCreated:function(a,b){null!=b&&"Placeable"===b.typeName&&(this._componentAddedSub&&(this._componentAddedSub.reset(),this._componentAddedSub=void 0),this.camera&&!this.camera.parent&&b.addChild(this.camera))},onActiveStateChanged:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Camera.ActiveStateChanged."+this.parentEntity.id+"."+this.id,a,b):(Tundra.client.logError("[EC_Camera]: Cannot subscribe onActiveStateChanged, parent entity not set!",!0),null)},_postActiveStateChanged:function(a){Tundra.events.send("EC_Camera.ActiveStateChanged."+this.parentEntity.id+"."+this.id,this.parentEntity,this,a)},setActive:function(a){if(void 0===a&&(a=!0),"boolean"==typeof a&&this._active!==a){if(a&&Tundra.renderer.activeCamera()&&Tundra.renderer.activeCamera()._animating===!0)return void this.log.warn("Current camera is animating, cannot activate "+this.parentEntity.name);this._active=a,this._active&&Tundra.renderer.setActiveCamera(this),
this._postActiveStateChanged(this._active)}},isActive:function(){return this._active},attributeChanged:function(a,b,c){this.update()},aspectRatio:function(){var a=Tundra.renderer.windowSize;return void 0!==a&&0!==a.height?a.width/a.height:0},isPointInView:function(a,b,c){var d=void 0;if(a instanceof THREE.Vector3?d=a:"number"==typeof a&&"number"==typeof b&&"number"==typeof c?(d=new THREE.Vector3,d.x=a,d.y=b,d.z=c):"object"==typeof a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z&&(d=new THREE.Vector3,d.x=a.x,d.y=a.y,d.z=a.z),!d)return this.log.error("isPointInView: invalid arguments provided!"),!1;var e=new THREE.Frustum;return e.setFromMatrix((new THREE.Matrix4).multiply(this.camera.projectionMatrix,this.camera.matrixWorldInverse)),e.containsPoint(d)},onWindowResize:function(a,b){void 0!==this.camera&&(this.camera.aspect=a/b,this.camera.updateProjectionMatrix())},onOrthographicChanged:function(){this.orthographic&&!this._combinedCamera.orthographic?this._combinedCamera.toOrthographic(!0):!this.orthographic&&this._combinedCamera.orthographic&&this._combinedCamera.toPerspective(!0)}}),EC_Mesh=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"nodeTransformation",new Transform,Attribute.Transform,"Transform"),this.declareAttribute(1,"meshRef","",Attribute.AssetReference,"Mesh ref"),this.declareAttribute(2,"skeletonRef","",Attribute.AssetReference,"Skeleton ref"),this.declareAttribute(3,"materialRefs",[],Attribute.AssetReferenceList,"Mesh materials"),this.declareAttribute(4,"drawDistance",0,Attribute.Real,"Draw distance"),this.declareAttribute(5,"castShadows",!1,Attribute.Bool,"Cast shadows")},__classvars__:{TypeId:17,TypeName:"Mesh"}}),EC_Mesh_ThreeJs=EC_Mesh.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.meshAsset=null,this.skeletonAsset=null,this.materialAssets=[],this.meshRequested=!1,this.skeletonRequested=!1,this.materialsRequested=!1,this.attachements=[],this.attachementsMeta={},this._loadsEmitted={mesh:!1}},__classvars__:{Implementation:"three.js"},reset:function(){Tundra.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded"),Tundra.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded"),Tundra.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded"),this.resetMesh(),this.resetMaterials(),this.attachements=[],this.attachementsMeta={},void 0!==this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0)},attributeChanged:function(a,b,c){if(0===a)this.meshAsset&&this.meshAsset.isLoaded()?Tundra.renderer.updateSceneNode(this.meshAsset.mesh,this.nodeTransformation):this.update();else if(1===a)this.resetMesh(),this.update();else if(2===a)this.update();else if(3===a)this.materialsRequested=!1,this.update();else if(4===a);else if(5===a){if(null==this.meshAsset)return;for(var d=0,e=this.meshAsset.numSubmeshes();d<e;++d){var f=this.meshAsset.getSubmesh(d);void 0!==f&&null!==f&&(f.castShadow=c,f.traverse(function(a){a.castShadow=c}))}}},getSceneNode:function(){return null!=this.meshAsset?this.meshAsset.getSceneNode():null},getSubmesh:function(a){return null!=this.meshAsset?this.meshAsset.getSubmesh(a):null},numSubmeshes:function(){return null!=this.meshAsset?this.meshAsset.numSubmeshes():0},getBoundingBox:function(){var a=new THREE.Box3;this.numSubmeshes()>0&&a.set(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0));for(var b=0,c=this.numSubmeshes();b<c;b++){var d=this.getSubmesh(b);null!=d&&null!=d.geometry&&(null==d.geometry.boundingBox&&d.geometry.computeBoundingBox(),a.union(d.geometry.boundingBox))}return a},update:function(){if(null==this.meshAsset&&!this.meshRequested){var a=this.attributes.meshRef.get();if(null!=a&&""!=a){var b=this._determineType(a);this.meshRequested=!0;var c=Tundra.asset.requestAsset(a,b);null!=c&&c.onCompleted(this,this._meshAssetLoaded)}}if(!this.materialsRequested)for(var d=this.attributes.materialRefs.get(),e=0;e<d.length;e++){this.materialsRequested=!0;var f=d[e];if("string"==typeof f&&""!==f){var g=null!=this.meshAsset?this.meshAsset.getSubmesh(e):void 0;if(void 0!=g&&null!=g.material&&g.material.name===f)continue;var b="OgreMaterial";CoreStringUtils.endsWith(f,".mtl",!0)&&(b=void 0);var c=Tundra.asset.requestAsset(f,b);null!=c&&(c.onCompleted(this,this._materialAssetLoaded,e),c.onFailed(this,this._materialAssetFailed,e),this.materialAssets[e]=c)}}if(null!=this.meshAsset&&this.meshAsset.isLoaded()){if(this.allMaterialsLoaded()){if(null==this.skeletonAsset&&!this.skeletonRequested){var h=this.attributes.skeletonRef.get();if(null!=h&&""!=h){this.skeletonRequested=!0;var c=Tundra.asset.requestAsset(h);if(null!=c)return void c.onCompleted(this,this._skeletonAssetLoaded)}}for(var d=this.attributes.materialRefs.get(),i=this.meshAsset.numSubmeshes(),e=0;e<i;++e){var g=this.meshAsset.getSubmesh(e);if(void 0!==g&&null!==g){var f=d[e];if(null==g.material||g.material.name!==f){var j=this.materialAssets[e];if(void 0===j&&void 0===f)for(var k=0;k<this.materialAssets.length;k++){var l=this.materialAssets[k];l instanceof IAsset&&"function"==typeof l.createMaterial&&(j=l)}j instanceof IAsset&&j.material instanceof THREE.Material?g.material=j.material:j instanceof IAsset&&"function"==typeof j.createMaterial?g.material=j.createMaterial(g):j instanceof THREE.Material?g.material=j:g.material||(g.material=Tundra.renderer.materialWhite),g.receiveShadow=!0,g.castShadow=this.castShadows,g.traverse(function(a){a.receiveShadow=!0,a.castShadow=this.castShadows}.bind(this))}}}this.materialAssets.length>i&&this.log.warnC("Too many materials for target mesh "+this.meshAsset.name+". Materials: "+this.materialAssets.length+" Submeshes: "+i+" In entity: "+this.parentEntity.id+" "+this.parentEntity.name)}this.meshAsset.mesh&&!this.meshAsset.mesh.parent&&(null!=this.parentEntity.placeable?this._onParentEntityComponentCreated(this.parentEntity,this.parentEntity.placeable):this._componentAddedSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated)),this.meshAsset.mesh&&Tundra.renderer.updateSceneNode(this.meshAsset.mesh,this.nodeTransformation),null!=this.skeletonAsset&&this.skeletonAsset.attach(this.meshAsset),""!==this.skeletonRef&&null==this.skeletonAsset||this.attachAttachements()}},_determineType:function(a){return CoreStringUtils.endsWith(a,".assimp.json",!0)?"AssimpJson":CoreStringUtils.endsWith(a,".json",!0)||CoreStringUtils.endsWith(a,".js",!0)?"ThreeJsonMesh":void 0},_onParentEntityComponentCreated:function(a,b){null!=b&&"Placeable"===b.typeName&&(void 0!==this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0),null!=b.sceneNode?this._onParentPlaceableNodeCreated(b,b.sceneNode):this._placeableNodeCreatedSub=b.onSceneNodeCreated(this,this._onParentPlaceableNodeCreated))},_onParentPlaceableNodeCreated:function(a,b){if(void 0!==this._placeableNodeCreatedSub&&(Tundra.events.unsubscribe(this._placeableNodeCreatedSub),this._placeableNodeCreatedSub=void 0),null!=this.meshAsset&&null!=this.meshAsset.mesh){var c=null==this.meshAsset.mesh.parent;a.addChild(this.meshAsset.mesh),c&&this._loadsEmitted.mesh===!1&&(this._loadsEmitted.mesh=!0,Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",this.parentEntity,this,this.meshAsset))}else this.log.error("Mesh not ready but placeable is?!")},attachAttachements:function(){if(""!==this.meshRef&&null==this.meshAsset)return void this.log.warn("attachAttachements: Mesh",this.meshRef,"not ready yet!");if(""!==this.skeletonRef&&null==this.skeletonAsset)return void this.log.warn("attachAttachements: Skeleton",this.skeletonRef,"not ready yet!");for(var a=[],b=0;b<this.attachements.length;b++){var c=this.attachements[b];c.attach(this.meshAsset,this.skeletonAsset)&&c.verticesToHide.length>0&&(a=a.concat(c.verticesToHide))}if(0!==a.length){for(var d=0;d<a.length&&void 0!==a[d];d++)for(var e=d+1;e<a.length;e++)a[d]===a[e]&&(a.splice(e,1),e--);var f=!0;if(Array.isArray(this.attachementsMeta.vertices)){f=!1;for(var g=0,h=this.attachementsMeta.vertices.length;g<h;g++)if(this.attachementsMeta.vertices[g]!==a[g]){f=!0;break}}if(f){this.attachementsMeta.vertices=a;var i=this.meshAsset.getSubmesh(0);if(null!=i){void 0===this.attachementsMeta.geometryOriginal&&(this.attachementsMeta.geometryOriginal=i.geometry),void 0===this.attachementsMeta.submeshOriginal&&(this.attachementsMeta.submeshOriginal=i),void 0!==this.attachementsMeta.geometry&&this.attachementsMeta.geometry.dispose(),this.attachementsMeta.geometry=this.attachementsMeta.geometryOriginal.clone();for(var j=this.attachementsMeta.geometry.attributes.index.array,k=Array.prototype.slice.call(j),l=(k.length,0),m=k.length;l<m;l+=3){var n=a.indexOf(k[l]),o=n!==-1?a.indexOf(k[l+1]):-1,p=o!==-1?a.indexOf(k[l+2]):-1;p!==-1&&(k.splice(l,3),m-=3,l-=3)}for(var q=this.attachementsMeta.geometryOriginal.attributes.index.is32bit,r=new DataSerializer(k.length,q===!0?DataSerializer.ArrayType.Uint32:DataSerializer.ArrayType.Uint16),l=0,m=k.length;l<m;++l)q?r.writeU32(k[l]):r.writeU16(k[l]);this.attachementsMeta.geometry.attributes.index.array=r.array,this.attachementsMeta.geometry.drawcalls=[],this.attachementsMeta.geometry.addDrawCall(0,r.array.length),this.attachementsMeta.geometry.offsets=this.attachementsMeta.geometry.drawcalls;var s=i.parent;s.remove(i),this.attachementsMeta.submesh=new THREE.SkinnedMesh(this.attachementsMeta.geometry,i.material,i.useVertexTexture),this.meshAsset.mesh.add(this.attachementsMeta.submesh),this.attachementsMeta.submesh.bind(this.skeletonAsset.skeleton),this.skeletonAsset.skeleton.pose()}}}},detachAttachements:function(){for(var a=0;a<this.attachements.length;a++)this.attachements[a].detach()},resetMesh:function(){if(this.detachAttachements(),null!=this.meshAsset){var a=this.parentEntity.getComponent("Placeable");null!=a&&null!=a.sceneNode&&a.sceneNode.remove(this.meshAsset.mesh),this.meshAsset.unload()}this.meshAsset=null,this.meshRequested=!1,this._loadsEmitted.mesh=!1},resetMaterials:function(){null!=this.meshAsset&&this.meshAsset.resetMaterials();for(var a=0;a<this.materialAssets.length;a++){var b=this.materialAssets[a];null!=b&&"function"==typeof b.unload&&b.unload(),b=null}this.materialAssets=[],this.materialsRequested=!1},setMesh:function(a,b){return"string"!=typeof a?(this.log.errorC("setMesh must be called with a string ref, called with:",a),!1):this.attributes.meshRef.set(a,b)},setMaterial:function(a,b,c){if("string"==typeof a&&"number"==typeof b){for(var d=this.attributes.materialRefs.get(),e=d.length;e<b;++e)d.push("");return d[b]=a,this.attributes.materialRefs.set(d,c)}return this.log.errorC("setMaterial must be called single string ref and material index as the second parameter, called with:",a,b),!1},setMaterials:function(a,b){return Array.isArray(a)?this.attributes.materialRefs.set(a,b):(this.log.errorC("setMaterials must be called with Array parameter, called with:",a),!1)},onMeshLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",a,b):(this.log.error("Cannot subscribe onMeshLoaded, parent entity not set!"),null)},onSkeletonLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded",a,b):(this.log.error("Cannot subscribe onSkeletonLoaded, parent entity not set!"),null)},onMaterialLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded",a,b):(this.log.error("Cannot subscribe onMaterialLoaded, parent entity not set!"),null)},onMaterialsLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialsLoaded",a,b):(this.log.error("Cannot subscribe onMaterialsLoaded, parent entity not set!"),null)},onAnimationsLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".AnimationsLoaded",a,b):(this.log.error("Cannot subscribe onAnimationsLoaded, parent entity not set!"),null)},_meshAssetLoaded:function(a){if(this.hasParentEntity()){if(this.meshAsset=a,null!=this.meshAsset.mesh){this.meshAsset.mesh.tundraEntityId=this.parentEntity.id;for(var b=0,c=this.meshAsset.numSubmeshes();b<c;b++){var d=this.meshAsset.getSubmesh(b);null!=d&&(d.tundraEntityId=this.parentEntity.id)}}this.update(),this.meshAsset.mesh.parent&&this._loadsEmitted.mesh===!1&&(this._loadsEmitted.mesh=!0,Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",this.parentEntity,this,this.meshAsset)),this.meshAsset.providesAnimations===!0&&Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".AnimationsLoaded",this.parentEntity,this,this.meshAsset)}},_skeletonAssetLoaded:function(a,b){this.hasParentEntity()&&(this.skeletonAsset=a,this.update(),Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded",this.parentEntity,this,this.skeletonAsset),this.skeletonAsset.providesAnimations===!0&&Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".AnimationsLoaded",this.parentEntity,this,this.skeletonAsset))},_materialAssetLoaded:function(a,b){if(this.hasParentEntity()&&(void 0!==a&&void 0!==b&&(this.materialAssets[b]=a),this.allMaterialsLoaded())){this.update();for(var c=0;c<this.materialAssets.length;++c){var d=this.materialAssets[c];d instanceof IAsset&&d.isLoaded()&&Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded",this.parentEntity,this,c,d)}Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialsLoaded",this.parentEntity,this)}},_materialAssetFailed:function(a,b,c){this._materialAssetLoaded(Tundra.renderer.materialLoadError,c)},allMaterialsLoaded:function(){for(var a=0;a<this.materialAssets.length;++a){var b=this.materialAssets[a];if(void 0!==b&&null!==b&&!(b instanceof THREE.Material)){if(b instanceof AssetTransfer)return!1;if(!(b instanceof IAsset))return!1}}return!0},numMaterialsLoading:function(){for(var a=0,b=0;b<this.materialAssets.length;++b){var c=this.materialAssets[b];void 0!==c&&null!==c&&(c instanceof AssetTransfer&&a++,c instanceof IAsset&&!c.isLoaded()&&a++)}return a},setAttachements:function(a){return this.attachements.length>0&&this.detachAttachements(),Array.isArray(a)?(this.attachements=a,void(null==this.meshAsset||""!==this.skeletonRef&&null==this.skeletonAsset||this.attachAttachements())):void(this.attachements=[])}}),AttributeInterpolationData=Class.$extend({__init__:function(a){this.previous=void 0,this.current=void 0,this.previousCanCopy=!1,this.currentCanCopy=!1},change:function(a){this.current&&(this.previousCanCopy?this.previous.copy(this.current):(this.previous=this.current.clone(),this.previousCanCopy="function"==typeof this.previous.copy)),this.currentCanCopy?this.current.copy(a):(this.current=a.clone(),this.currentCanCopy="function"==typeof this.current.copy)},reset:function(){this.previous=void 0,this.current=void 0}}),EC_Placeable=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"transform",new Transform,Attribute.Transform,"Transform"),this.declareAttribute(1,"drawDebug",!1,Attribute.Bool,"Show bounding box"),this.declareAttribute(2,"visible",!0,Attribute.Bool,"Visible"),this.declareAttribute(3,"selectionLayer",1,Attribute.Int,"Selection layer"),this.declareAttribute(4,"parentRef","",Attribute.EntityReference,"Parent entity ref"),this.declareAttribute(5,"parentBone","",Attribute.String,"Parent bone name")},__classvars__:{TypeId:20,TypeName:"Placeable"}}),EC_Placeable_ThreeJs=EC_Placeable.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.attributes.transform.interpolation=new AttributeInterpolationData,this.sceneNode=null,this._pendingChildren=[]},__classvars__:{Implementation:"three.js",TransformInterpolator:void 0},reset:function(){if(null!=this.sceneNode){Tundra.events.send("EC_Placeable."+this.parentEntity.id+"."+this.id+".AboutToBeDestroyed",this,this.sceneNode);var a=this.sceneNode.parent;void 0!==a&&null!==a&&a.remove(this.sceneNode)}this.sceneNode=null,void 0!==this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0),void 0!==this._entityCreatedSub&&(Tundra.events.unsubscribe(this._entityCreatedSub),this._entityCreatedSub=void 0)},update:function(){var a=Tundra.renderer;if(null==this.sceneNode){this.sceneNode=a.createSceneNode(),this.sceneNode.name=this.parentEntity.name,this.sceneNode.tundraEntityId=this.parentEntity.id,this.sceneNode.tundraComponentId=this.id,this._setVisible(this.attributes.visible.get()),a.scene.add(this.sceneNode),this.checkParent(),a.updateSceneNode(this.sceneNode,this.attributes.transform.value);for(var b=0;b<this._pendingChildren.length;b++)this.addChild(this._pendingChildren[b]);return this._pendingChildren=[],void Tundra.events.send("EC_Placeable."+this.parentEntity.id+"."+this.id+".SceneNodeCreated",this,this.sceneNode)}this.checkParent(),a.updateSceneNode(this.sceneNode,this.attributes.transform.value)},attributeChanged:function(a,b,c){switch(a){case 0:null!=this.sceneNode&&(EC_Placeable_ThreeJs.TransformInterpolator?EC_Placeable_ThreeJs.TransformInterpolator.update(this.parentEntity,this,this.sceneNode,this.attributes.transform):Tundra.client.renderer.updateSceneNode(this.sceneNode,c));break;case 1:break;case 2:this._setVisible(c);break;case 3:break;case 4:this.checkParent();break;case 5:}},onSceneNodeCreated:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Placeable."+this.parentEntity.id+"."+this.id+".SceneNodeCreated",a,b):(this.log.error("Cannot subscribe onSceneNodeCreated, parent entity not set!"),null)},onAboutToBeDestroyed:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Placeable."+this.parentEntity.id+"."+this.id+".AboutToBeDestroyed",a,b):(this.log.error("Cannot subscribe onAboutToBeDestroyed, parent entity not set!"),null)},addChild:function(a){return void 0!==a&&null!==a&&(a instanceof Entity?this.addChild(a.placeable):a instanceof EC_Placeable?this.addChild(a.sceneNode):(null!=this.sceneNode?(this.sceneNode.add(a),a.updateMatrix(),a.updateMatrixWorld(!0),void 0!==this._visibilityTimerId&&clearTimeout(this._visibilityTimerId),this._visibilityTimerId=setTimeout(this.updateVisibility.bind(this),50)):this._pendingChildren.push(a),!0))},parentNode:function(){return this.sceneNode&&this.sceneNode.parent?this.sceneNode.parent:null},getParentEntity:function(){var a=this.parentNode();return a&&"number"==typeof a.tundraEntityId?Tundra.scene.entityById(a.tundraEntityId):null},_applyParentChain:function(a,b){for(var c=this.sceneNode.parent;null!==c&&void 0!==c&&c instanceof THREE.Scene==!1;)a instanceof THREE.Vector3?a.add(c[b]):a instanceof THREE.Quaternion&&a.multiply(c[b].clone().normalize()),c=c.parent},distanceTo:function(a){var b=a instanceof THREE.Vector3?a:void 0;if(void 0===b){var c=a instanceof Entity?a.placeable:a instanceof EC_Placeable?a:void 0;null!=c&&(b=c.worldPosition())}if(void 0!==b)return this.worldPosition().distanceTo(b)},decompose:function(a,b,c){this.attributes.transform.value.decompose(a,b,c)},position:function(){return this.attributes.transform.get().pos.clone()},setPosition:function(a,b,c,d){var e=this.attributes.transform.get();e.setPosition(a,b,c);var f="number"!=typeof a?b:d;return this.attributes.transform.set(e,f)},worldPosition:function(a){return null==this.sceneNode?null:(a=a||new THREE.Vector3,a.setFromMatrixPosition(this.sceneNode.matrixWorld),a)},setWorldPosition:function(a){var b=this.attributes.transform.get(),c=a.clone();""!==this.parentRef&&this.sceneNode.parent.worldToLocal(c),b.pos.copy(c),this.attributes.transform.set(b)},scale:function(){return this.attributes.transform.get().scale.clone()},setScale:function(a,b,c,d){var e=this.attributes.transform.get();e.setScale(a,b,c);var f="number"!=typeof a?b:d;return this.attributes.transform.set(e,f)},rotation:function(a){return a=a||new THREE.Vector3,a.copy(this.attributes.transform.get().rot),a},setRotation:function(a,b,c,d){var e=this.attributes.transform.get();e.setRotation(a,b,c);var f="number"!=typeof a?b:d;return this.attributes.transform.set(e,f)},checkParent:function(){if(null!=this.sceneNode&&null!=this.parentEntity&&null!=this.parentScene){if(void 0!==this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0),void 0!==this._entityCreatedSub&&(Tundra.events.unsubscribe(this._entityCreatedSub),this._entityCreatedSub=void 0),""!==this.parentRef){for(var a=null,b=this.attributes.parentRef.value,c=parseInt(b),d=!isNaN(c),e=0,f=this.parentScene.entities.length;e<f;e++){var g=this.parentScene.entities[e];if(d&&g.id===c){a=g;break}if(!d&&g.name===b&&(a=g,a.placeable))break}if(null!=a){if(null!=a.placeable)return void a.placeable.addChild(this);this._componentAddedSub=a.onComponentCreated(this,this._onParentPlaceableEntityComponentCreated)}else this._entityCreatedSub=this.parentScene.onEntityCreated(this,this._onParentSceneEntityCreated)}this.removeParent()}},removeParent:function(){this.sceneNode&&null!=this.parentEntity&&null!=this.parentScene&&this.sceneNode.parent&&this.sceneNode.parent!==Tundra.renderer.scene&&(Tundra.renderer.scene.add(this.sceneNode),Tundra.client.renderer.updateSceneNode(this.sceneNode,this.transform))},_onParentSceneEntityCreated:function(a){(""!==a.name&&a.name===this.parentRef||a.id===parseInt(this.parentRef))&&this.checkParent()},_onParentPlaceableEntityComponentCreated:function(a,b){null!=b&&"Placeable"===b.typeName&&this.checkParent()},updateVisibility:function(){this._setVisible(this.attributes.visible.get())},isVisibleTraverse:function(){if(!this.attributes.visible.get())return!1;if(!this.sceneNode)return!1;for(var a=this.sceneNode.parent;a&&!(a instanceof THREE.Scene);){if(a.visible===!1)return!1;a=a.parent}return!0},_setVisible:function(a){null!=this.sceneNode&&this.sceneNode.traverse(function(b){if(!(b instanceof THREE.PerspectiveCamera)){if(a&&void 0!==b.tundraEntityId){var c=Tundra.scene.entityById(b.tundraEntityId),d=null!=c?void 0!==b.tundraComponentId?c.componentById(b.tundraComponentId):c.placeable:null;if(null!=d&&!d.visible)return}b.visible=a}})},lookAt:function(a){var b,c=this.attributes.transform.get(),d=this.worldPosition();b=a instanceof THREE.Vector3?a:a.placeable.worldPosition();var e=c.lookAtQuaternion(d,b);if(this.sceneNode&&this.sceneNode.parent){var f=new THREE.Quaternion;f.setFromRotationMatrix(this.sceneNode.parent.matrixWorld),f.inverse(),e.multiplyQuaternions(f,e)}c.setRotation(e),this.transform=c},orientation:function(){return this.attributes.transform.get().orientation()},worldOrientation:function(a){return null==this.sceneNode?null:(a=a||new THREE.Quaternion,a.setFromRotationMatrix(this.sceneNode.matrixWorld),a)},setWorldOrientation:function(a){var b=this.attributes.transform.get(),c=a.clone();if(""!==this.parentRef){var d=new THREE.Quaternion;d.setFromRotationMatrix(this.sceneNode.parent.matrixWorld),d.inverse(),c.multiplyQuaternions(d,c)}b.setRotation(c),this.attributes.transform.set(b)},worldTransform:function(){var a=this.transform.clone();return a.pos=this.worldPosition(),a},setWorldTransform:function(a){var b=this.attributes.transform.get(),c=""!==this.parentRef?this.transform.pos.clone():new THREE.Vector3(0,0,0);b=a,b.pos.add(c),this.attributes.transform.set(b)},worldScale:function(a){return null==this.sceneNode?null:(a=a||new THREE.Vector3,a.setFromMatrixScale(this.sceneNode.matrixWorld),a)}}),EC_Billboard=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"materialRef","",Attribute.AssetReference),this.declareAttribute(1,"position",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(2,"width",1,Attribute.Real),this.declareAttribute(3,"height",1,Attribute.Real),this.declareAttribute(4,"rotation",0,Attribute.Real),this.declareAttribute(5,"show",!0,Attribute.Bool)},__classvars__:{TypeId:2,TypeName:"Billboard"}}),EC_Billboard_ThreeJs=EC_Billboard.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.material=null,this.sprite=null;var e=this;this._text=void 0,Object.defineProperties(this,{text:{get:function(){return this._text},set:function(a){this._text=a,e.loadTextSprite()}},autoHideDistanceFurtherThanCameraToFocus:{get:function(){return this._autoHideDistanceFurtherThanCameraToFocus},set:function(a){this._autoHideDistanceFurtherThanCameraToFocus="number"==typeof a&&a>0?a*a:-1},_autoHideDistanceFurtherThanCameraToFocus:-1},autoHideDistanceFurtherThan:{get:function(){return this._autoHideDistanceFurtherThan},set:function(a){this._autoHideDistanceFurtherThan="number"==typeof a&&a>0?a*a:-1},_autoHideDistanceFurtherThan:-1},autoHideDistanceFurtherThanFromCamera:{get:function(){return this._autoHideDistanceFurtherThanFromCamera},set:function(a){this._autoHideDistanceFurtherThanFromCamera="number"==typeof a&&a>0?a*a:-1},_autoHideDistanceFurtherThanFromCamera:-1},autoScaleDistanceCloserThan:{get:function(){return this._autoScaleDistanceCloserThan},set:function(a){this._autoScaleDistanceCloserThan="number"==typeof a&&a>0?a*a:-1},_autoScaleDistanceCloserThan:-1},autoScaleDistanceFurtherThan:{get:function(){return this._autoScaleDistanceFurtherThan},set:function(a){this._autoScaleDistanceFurtherThan="number"==typeof a&&a>0?a*a:-1},_autoScaleDistanceFurtherThan:-1},ignoreWhenRaycasting:{get:function(){return this._ignoreWhenRaycasting},set:function(a){this._ignoreWhenRaycasting="boolean"==typeof a&&a}}}),this.style={background:void 0,font:"black",fontSize:48,border:void 0,borderWidth:1,padding:void 0,isDefined:function(){return this.background||this.border},key:function(){var a="";return this.background instanceof Color?a+="_background="+this.background.toString(!0):"string"==typeof this.background&&(a+="_background="+this.background),this.border instanceof Color?a+="_border="+this.border.toString(!0):"string"==typeof this.border&&(a+="_border="+this.border),this.font instanceof Color?a+="_font="+this.font.toString(!0):"string"==typeof this.font&&(a+="_font="+this.font),a},css:function(a){if("borderWidth"===a)return"number"==typeof this.borderWidth?this.borderWidth.toString():"0";var b=void 0;return"background"===a&&(b=this.background),"border"===a&&(b=this.border),"font"===a&&(b=this.font),b?b instanceof Color?b.toString(!0):b:"transparent"}},this.color=new THREE.Color(1,1,1),this.depthTest=!0,this.depthWrite=!0,this.autoScaleLimits=new THREE.Vector2(1,1),this.autoOffset=new THREE.Vector3(0,0,0),this._autoScalingFactor=1,this.onHoverIn=null,this.onHoverOut=null,this._overrideScale=new THREE.Vector2(1,1),this._ignoreWhenRaycasting=!1,this._scaleAccordingToDistance=-1},__classvars__:{Implementation:"three.js",MaterialCache:{},ImgCache:{},Canvas:void 0,Animator:new PlaceableUtils.Animator(AttributeChange.LocalOnly),GetOrCreateMaterial:function(a,b){var c="boolean"!=typeof a.depthTest||a.depthTest,d="boolean"!=typeof a.depthWrite||a.depthWrite,e=b+"_"+c+"_"+d,f=this.MaterialCache[e];if(void 0===f){if(f=new THREE.SpriteMaterial({color:a.color}),f.depthTest=a.depthTest,f.depthWrite=a.depthWrite,b.indexOf(".dds")===-1&&a.style.isDefined()){var e=b+a.style.key(),g=EC_Billboard_ThreeJs.ImgCache[e];if(g)if(g.complete)f.map=EC_Billboard_ThreeJs.StylizeImage(a,a.style,g),f.needsUpdate=!0;else{var h=$(g).data("materials");Array.isArray(h)?h.push(f):h=[f],$(g).data("materials",h)}else{g=new Image,g.onload=function(){for(var a=$(g).data("materials"),b=0;b<a.length;b++)a[b].map=EC_Billboard_ThreeJs.StylizeImage(this.ec_billboard,this.ec_billboard.style,g),a[b].needsUpdate=!0}.bind({ec_billboard:a}),g.crossOrigin="anonymous",g.src=b,EC_Billboard_ThreeJs.ImgCache[e]=g;var h=$(g).data("materials");Array.isArray(h)?h.push(f):h=[f],$(g).data("materials",h)}}else{var i=Tundra.asset.requestAsset(b);i.onCompleted(f,function(a){this.map=a.texture,this.map.repeat.set(-1,1),this.map.offset.set(1,0),this.needsUpdate=!0})}this.MaterialCache[e]=f}return f},GetOrCreateTextMaterial:function(a,b){var c="boolean"!=typeof a.depthTest||a.depthTest,d="boolean"!=typeof a.depthWrite||a.depthWrite,e=b+"_"+c+"_"+d+"_",f=this.MaterialCache[e];return void 0===f?(f=new THREE.SpriteMaterial({color:a.color}),f.depthTest=a.depthTest,f.depthWrite=a.depthWrite,f.map=EC_Billboard_ThreeJs.StylizeImage(a,a.style,void 0,b),this.MaterialCache[e]=f):a.width=a.width*f.map._tundraRatio,f},StylizeImage:function(a,b,c,d){if((!c||0===c.width||0===c.height)&&"string"!=typeof d)return console.error("EC_Billboard_ThreeJs.StylizeImage: null image",c),null;void 0===EC_Billboard_ThreeJs.Canvas&&(EC_Billboard_ThreeJs.Canvas=document.createElement("canvas"));var e="number"==typeof b.padding?b.padding:0,f=2*e,g=2*e,h=EC_Billboard_ThreeJs.Canvas.getContext("2d");if(c)f+=c.width,g+=c.height,EC_Billboard_ThreeJs.Canvas.width=128,EC_Billboard_ThreeJs.Canvas.height=128;else{h.font=b.fontSize+"px serif",h.textAlign="center",h.textBaseline="middle";var i=h.measureText(d);f+=i.width,g+=b.fontSize;var j=function(a){var b=a>0?a-1:0;b|=b>>1,b|=b>>2,b|=b>>4,b|=b>>8,b|=b>>16,b++;var c=Math.pow(2,Math.floor(Math.log(a)/Math.log(2)));return a-c<b-a?c:b};EC_Billboard_ThreeJs.Canvas.width=j(f),EC_Billboard_ThreeJs.Canvas.height=j(g)}h.scale(EC_Billboard_ThreeJs.Canvas.width/f,EC_Billboard_ThreeJs.Canvas.height/g),h.clearRect(0,0,f,g),h.fillStyle=b.css("background"),h.strokeStyle=b.css("border"),h.lineWidth=b.css("borderWidth"),h.lineCap="round",h.lineJoin="round",h.fillRect(0,0,f,g),h.rect(0,0,f,g),h.stroke(),c?h.drawImage(c,e,e):(h.fillStyle=b.css("font"),h.font=b.fontSize+"px 'Open Sans', sans-serif",h.textBaseline="hanging",h.fillText(d,e,e,f-2*e));var k=new Image,l=new THREE.Texture(k);l.flipY=!1;try{k.onload=function(){l.repeat.set(-1,1),l.offset.set(1,0),l.needsUpdate=!0},k.src=EC_Billboard_ThreeJs.Canvas.toDataURL("image/png")}catch(m){return console.error("Failed to draw billboard from '"+c.src+"': "+m.toString()),null}return l._tundraRatio=f/g,d&&(a.width=a.width*l._tundraRatio),l},LastHovered:null,UpdateSub:null,InstancesMap:navigator.userAgent.indexOf("PhantomJS")===-1?new Map:{},AddInstance:function(a){var b=a.parentEntity.id+"."+a.id;this.InstancesMap.set(b,a)},RemoveInstance:function(a){var b=a.parentEntity.id+"."+a.id;this.InstancesMap.delete(b)},_Limiter:Tundra.browser.isMobile()?new FrameLimiter(1/30):void 0,Raycast:function(){return this.Update(1),Tundra.renderer.raycast({targets:this._VisibleSprites,ignoreECModel:!0})},Update:function(a){if(!this._Limiter||this._Limiter.shouldUpdate(a)){if(0===this.InstancesMap.size)return void(this.UpdateSub&&(Tundra.events.unsubscribe(this.UpdateSub),this.UpdateSub=null));var b=Tundra.renderer.activeCameraEntity(),c=null!=b&&null!=b.camera?b.camera.camera:null;if(null!=c&&null!=b.placeable){if(this._VisibleSprites=[],b.placeable.worldPosition(this._CameraWorldPos),b.camera.getWorldFocusPosition(this._CameraFocusPos),this._DistanceFromCameraToFocus=this._CameraWorldPos.distanceToSquared(this._CameraFocusPos),this.InstancesMap.forEach(this._UpdateOne,this),this._VisibleSprites.length>0){var d=Tundra.renderer.raycast({targets:this._VisibleSprites,ignoreECModel:!0});if(null!=d.object&&null!=d.object.tundraBillboard){var e=d.object.tundraBillboard.parentEntity.id+"."+d.object.tundraBillboard.id,f=this.LastHovered&&this.LastHovered.parentEntity?this.LastHovered.parentEntity.id+"."+this.LastHovered.id:"";return void(f!==e&&(null!=this.LastHovered&&null!=this.LastHovered.onHoverOut&&(this.LastHovered.hovered=!1,this.LastHovered.onHoverOut(this.LastHovered,d)),this.LastHovered=d.object.tundraBillboard,this.LastHovered.hovered=!0,null!=this.LastHovered.onHoverIn&&this.LastHovered.onHoverIn(this.LastHovered,d)))}}null!=this.LastHovered&&(null!=this.LastHovered.onHoverOut&&(this.LastHovered.hovered=!1,this.LastHovered.onHoverOut(this.LastHovered)),this.LastHovered=null)}}},_DistanceFromCameraToFocus:0,_VisibleSprites:[],_CameraWorldPos:new THREE.Vector3(0,0,0),
_CameraFocusPos:new THREE.Vector3(0,0,0),_TempVector:new THREE.Vector3(0,0,0),_UpdateOne:function(a){if(a&&a.sprite&&a.visibleOverride!==!1&&!(a._autoScaleDistanceCloserThan<0&&a._autoScaleDistanceFurtherThan<0&&a._autoHideDistanceFurtherThan<0)){if(!a.worldPosition(this._TempVector))return void a.hide(!1);if(a._autoHideDistanceFurtherThanCameraToFocus>0&&this._DistanceFromCameraToFocus>=a._autoHideDistanceFurtherThanCameraToFocus)return void a.hide(!1);var b=this._CameraFocusPos.distanceToSquared(this._TempVector);if(a._autoHideDistanceFurtherThan>0&&b>=a._autoHideDistanceFurtherThan)return void a.hide(!1);if(b=this._CameraWorldPos.distanceToSquared(this._TempVector),a._autoHideDistanceFurtherThanFromCamera>0&&b>=a._autoHideDistanceFurtherThanFromCamera)return void a.hide(!1);a.show(!0);var c=a.attributes.position.value,d=1;a._scaleAccordingToDistance<0?a._autoScaleDistanceCloserThan>0&&b<a._autoScaleDistanceCloserThan?(d=b/a._autoScaleDistanceCloserThan,d<a.autoScaleLimits.x&&(d=a.autoScaleLimits.x)):a._autoScaleDistanceFurtherThan>0&&b>a._autoScaleDistanceFurtherThan&&(d=b/a._autoScaleDistanceFurtherThan,d>a.autoScaleLimits.y&&(d=a.autoScaleLimits.y)):d=Math.sqrt(b*a._scaleAccordingToDistance),a._autoScalingFactor=d,0!=c.y?a.sprite.position.set(c.x,c.y+c.y*d,c.z):a.sprite.position.set(0,0,0),d>1&&!a.autoOffset.isZero()&&a.sprite.position.add(a.autoOffset.clone().multiplyScalar(d-1)),a._updateSize(),this._VisibleSprites.push(a.sprite)}}},isVisible:function(){return!!(this.sprite&&this.sprite.parent&&this.parentEntity&&this.parentEntity.placeable)&&this.parentEntity.placeable.attributes.visible.value},clearVisibilityOverride:function(){this.visibleOverride=!0},setVisible:function(a,b){a===!0||void 0===a?this.show(b):this.hide(b)},show:function(a){return!this.parentEntity.placeable||this.parentEntity.placeable.attributes.visible.value||this.parentEntity.placeable._animatingVisibility&&this.parentEntity.placeable._animatingVisibilityTo===!0?void("boolean"==typeof a&&a&&(this.visibleOverride=!0)):(this.visibleOverride=!0,this.animation&&this.animation.stop(),void(this.animation=EC_Billboard_ThreeJs.Animator.setVisibilityScaling(this.parentEntity.placeable,!0,{skipPlaceableScale:!0})))},hide:function(a){if(!this.parentEntity.placeable||!this.parentEntity.placeable.attributes.visible.value||this.parentEntity.placeable._animatingVisibility&&this.parentEntity.placeable._animatingVisibilityTo===!1)return void("boolean"==typeof a&&a&&(this.visibleOverride=!1));var b=this.visibleOverride;a="boolean"!=typeof a||a,a&&(this.visibleOverride=!1),this.animation&&this.animation.stop(),this.animation||b===!0?this.animation=EC_Billboard_ThreeJs.Animator.setVisibilityScaling(this.parentEntity.placeable,!1,{skipPlaceableScale:!0}):this.parentEntity.placeable.attributes.visible.value=!1},getMaterial:function(){return null!=this.sprite&&null!=this.sprite.material?this.sprite.material:null},loadTextSprite:function(){if("string"==typeof this._text&&""!==this._text){if(null!=this.sprite){if("string"==typeof this.sprite.tundraReference&&this.sprite.tundraReference===this._text)return;this.reset()}null==this.sprite&&(this.sprite=new THREE.Sprite(EC_Billboard_ThreeJs.GetOrCreateTextMaterial(this,this._text)),this.sprite.matrixAutoUpdate=!1,this.sprite.tundraReference=this._text,this.sprite.tundraBillboard=this,null!=this.parentEntity.placeable?this.parentEntity.placeable.addChild(this.sprite):void 0===this.subPlaceableCreated&&(this.subPlaceableCreated=this.parentEntity.onComponentCreated(this,this.onComponentCreated)),Tundra.renderer.onSceneMeshCreated(this.parentEntity,this,this.sprite)),this._updatePosition(),this._updateSize(),this._updateRotation(),EC_Billboard_ThreeJs.UpdateSub||(EC_Billboard_ThreeJs.UpdateSub=Tundra.frame.onUpdate(EC_Billboard_ThreeJs,EC_Billboard_ThreeJs.Update)),this.sprite&&EC_Billboard_ThreeJs.AddInstance(this)}},loadSprite:function(){if(""!==this.materialRef){var a=Tundra.asset.resourceTypeForAssetRef(this.materialRef);if("Texture"!==a)return void this.log.warn("Currently only 'Texture' type references are supported for 'materialRef' attribute:",this.materialRef);if(null!=this.sprite){if("string"==typeof this.sprite.tundraReference&&this.sprite.tundraReference===this.materialRef)return;this.reset()}null==this.sprite&&(this.sprite=new THREE.Sprite(EC_Billboard_ThreeJs.GetOrCreateMaterial(this,this.materialRef)),this.sprite.matrixAutoUpdate=!1,this.sprite.tundraReference=this.materialRef,this.sprite.tundraBillboard=this,null!=this.parentEntity.placeable?this.parentEntity.placeable.addChild(this.sprite):void 0===this.subPlaceableCreated&&(this.subPlaceableCreated=this.parentEntity.onComponentCreated(this,this.onComponentCreated)),Tundra.renderer.onSceneMeshCreated(this.parentEntity,this,this.sprite)),this._updatePosition(),this._updateSize(),this._updateRotation(),EC_Billboard_ThreeJs.UpdateSub||(EC_Billboard_ThreeJs.UpdateSub=Tundra.frame.onUpdate(EC_Billboard_ThreeJs,EC_Billboard_ThreeJs.Update)),this.sprite&&EC_Billboard_ThreeJs.AddInstance(this)}},onComponentCreated:function(a,b){20===b.typeId&&(null!=this.sprite&&b.addChild(this.sprite),void 0!==this.subPlaceableCreated&&(Tundra.events.unsubscribe(this.subPlaceableCreated),this.subPlaceableCreated=void 0))},reset:function(){this.sprite&&(this.sprite.visible=!1),this.sprite&&this.sprite.parent&&this.sprite.parent.remove(this.sprite),this.sprite=null,EC_Billboard_ThreeJs.RemoveInstance(this)},update:function(){this.loadSprite()},setOverrideScale:function(a,b){this._overrideScale.set(a,b),(this._overrideScale.isZero()||this.parentEntity&&this.parentEntity.placeable&&this.parentEntity.placeable._animatingVisibility||this._autoScaleDistanceCloserThan<0&&this._autoScaleDistanceFurtherThan<0&&this._autoHideDistanceFurtherThan<0)&&this._updateSize()},_updatePosition:function(){null!=this.sprite&&(this.sprite.position.copy(this.position),this.sprite.updateMatrix(),this.sprite.updateMatrixWorld(!0))},_updateSize:function(){null!=this.sprite&&(this.sprite.scale.set(this.attributes.width.value*this._autoScalingFactor*this._overrideScale.x,this.attributes.height.value*this._autoScalingFactor*this._overrideScale.y,1),this.sprite.updateMatrix(),this.sprite.updateMatrixWorld(!0))},_updateRotation:function(){var a=this.getMaterial();null!=a&&(a.rotation=MathUtils.degToRad(180+this.rotation),a.needsUpdate=!0)},attributeChanged:function(a){0===a?this.loadSprite():1===a?this._updatePosition():2===a||3===a?this._updateSize():4===a?this._updateRotation():5===a&&this.sprite&&this.setVisible(this.attributes.show.value,!0)},worldPosition:function(a){return null!=this.parentEntity&&null!=this.parentScene&&(null!=this.parentEntity.placeable?this.parentEntity.placeable.worldPosition(a).add(this.attributes.position.value):a.copy(this.attributes.position.value),!0)}}),EC_HtmlBillboard_ThreeJs=EC_HtmlBillboard.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this._element=null,Object.defineProperties(this,{element:{get:function(){return this._element},set:this.setElement.bind(this)}}),this._override=!1,this._hidden=!0,this._rawWidth=-1,this._rawHeight=-1,this.hovering=!1,this.hovertingT=0,this.fadeIn=!0,this.fadeOut=!0,this.maxDistance=1e3,this.minScale=0,this.maxScale=0,this.offset={x:0,y:0},this.scaleAccordingToDistance=0},__classvars__:{Implementation:"three.js",MinScale:.15,UpdateSub:null,Update:function(a){var b=Tundra.scene.components(EC_HtmlBillboard.TypeId);if(0===b.length)return void(null!=EC_HtmlBillboard_ThreeJs.UpdateSub&&(Tundra.events.unsubscribe(EC_HtmlBillboard_ThreeJs.UpdateSub),EC_HtmlBillboard_ThreeJs.UpdateSub=null));var c=Tundra.renderer.activeCameraEntity(),d=null!=c&&null!=c.camera?c.camera.camera:null;if(null!=d&&null!=c.placeable){void 0===this._sphere&&(this._sphere=new THREE.Sphere(void 0,5)),void 0===this._projScreenMatrix&&(this._projScreenMatrix=new THREE.Matrix4),void 0===this._frustum&&(this._frustum=new THREE.Frustum);var e=Tundra.client.container.width(),f=Tundra.client.container.height();this._projScreenMatrix.multiplyMatrices(d.projectionMatrix,d.matrixWorldInverse),this._frustum.setFromMatrix(this._projScreenMatrix);for(var g=c.placeable.worldPosition(),h=[],i=0,j=!1,k=!1,l=0,m=0,n=0,o=0,p=0,q=0;q<b.length;q++){var r=b[q];if(null!=r._element)if(k=r._hidden===!1,r.worldPosition(this._sphere.center)){var j=this._frustum.intersectsSphere(this._sphere);if(j&&r.parentEntity.placeable&&!r.parentEntity.placeable.visible&&(j=!1),j)if(i=g.distanceTo(this._sphere.center),r.maxDistance>0&&i>r.maxDistance)k&&r.hide(!1);else{for(var s={d:i,w:r._element},t=!1,u=0;u<h.length;u++)if(i<h[u].d){h.splice(u,0,s),t=!0;break}t||h.push(s),this._sphere.center.project(d),l=(this._sphere.center.x+1)/2,m=(-this._sphere.center.y+1)/2,void 0===r._cssCache&&(r._cssCache={left:-1e3,top:-1e3,scale:-1e3});var v=r._element.get(0),w=0,x=0;if(w=r._rawWidth<0?r._rawWidth=v.offsetWidth:r._rawWidth,x=r._rawHeight<0?r._rawHeight=v.offsetHeight:r._rawHeight,p=1,i>100){if(p=r.scaleAccordingToDistance>0?1-Math.round(i*r.scaleAccordingToDistance*1e4)/1e4:Math.round(100/i*1e4)/1e4,r.minScale>0&&p<r.minScale?p=r.minScale:r.maxScale>0&&p>r.maxScale&&(p=r.maxScale),p<=EC_HtmlBillboard_ThreeJs.MinScale){k&&r.hide(!1);continue}if(r.attributes.hoverMagnify.value===!0)if(r.hovering)p=r.hoveringScaleIn(a,p),s.hovering=!0;else if(r.hovertingT>=0){var y=r.hoveringScaleOut(a,p);void 0!==y&&(p=y,s.hovering=!0)}}var z=Math.abs(r._cssCache.scale-p);z>=.001&&(v.style.transform="scale("+p+","+p+")",r._cssCache.scale=p);var A=w/2+r.offset.x*p,B=x/2+r.offset.y*p;o=Math.round(100*(l*e-A))/100,n=Math.round(100*(m*f-B))/100;var C=Math.abs(r._cssCache.left-o);C>=.75&&(v.style.left=o+"px",r._cssCache.left=o);var D=Math.abs(r._cssCache.top-n);D>=.75&&(v.style.top=n+"px",r._cssCache.top=n),k||r.show(!1)}else k&&r.hide(!1)}else k&&r.hide(!1)}for(var E=100+h.length,u=0;u<h.length;u++)h[u].hovering===!0?h[u].w.get(0).style.zIndex=(101+h.length).toString():(h[u].w.get(0).style.zIndex=E.toString(),E--)}}},setElement:function(a){null!=this._element&&(this._updateHover(!1),"function"==typeof this._element.remove&&this._element.remove()),this._element=null,null!=a&&(this._override=!1,this._hidden=!0,this._rawWidth=-1,this._rawHeight=-1,this._element=$(a),this._updateSize(),this._element.remove(),Tundra.client.container.append(this._element),this._updateHover(),this._element.hide(),this._element.css("position","absolute"),this._element.attr("ec-html-billboard",!0),null==EC_HtmlBillboard_ThreeJs.UpdateSub&&(EC_HtmlBillboard_ThreeJs.UpdateSub=Tundra.frame.onUpdate(EC_HtmlBillboard_ThreeJs,EC_HtmlBillboard_ThreeJs.Update)))},setUnselectable:function(a){null!=this._element&&(a="boolean"!=typeof a||a,this._element.css({cursor:a?"pointer":"auto","user-select":a?"none":"text"}))},setPointerEvents:function(a){null!=this._element&&(a="boolean"!=typeof a||a,this._element.css("pointer-events",a?"":"none"))},_updateHover:function(a){if(null!=this._element){a=a||this.hoverMagnify;var b=this._element.data("HtmlBillboardHoverConnected");a||b!==!0?!a||void 0!==b&&b!==!1||(this._element.hover(this._onHoverIn.bind(this),this._onHoverOut.bind(this)),this.hovering=!1,this._element.data("HtmlBillboardHoverConnected",!0)):(this._element.off("mouseenter mouseleave"),this.hovering=!1,this._element.data("HtmlBillboardHoverConnected",!1))}},_onHoverIn:function(){this.hovering=!0,this.hovertingT<0&&(this.hovertingT=0)},_onHoverOut:function(){this.hovering=!1,this.hovertingT>1&&(this.hovertingT=1)},hoveringScaleIn:function(a,b){return this.hovering?this.hovertingT>=1?1:(this.hovertingT+=2*a,this.hovertingT>1&&(this.hovertingT=1),b+=this.hovertingT,this.hovertingScale=MathUtils.lerp(b,1,this.hovertingT),this.hovertingScale):b},hoveringScaleOut:function(a,b){if(!(this.hovertingT<=0))return this.hovertingT-=4*a,MathUtils.lerp(b,this.hovertingScale,this.hovertingT)},_updateSize:function(){null!=this._element&&(this.size.x>=0&&this._element.css("width",this.size.x),this.size.y>=0&&this._element.css("height",this.size.y))},reset:function(){this.setElement(null)},update:function(){},attributeChanged:function(a,b,c){1===a?this._updateSize():2===a&&this._updateHover()},worldPosition:function(a){return null!=this.parentEntity&&null!=this.parentScene&&(null!=this.parentEntity.placeable?this.parentEntity.placeable.worldPosition(a).add(this.attributes.position.value):a.copy(this.position),!0)},forceRecalc:function(){this._rawWidth=-1,this._rawHeight=-1},show:function(a){this._element&&("boolean"!=typeof a&&(a=!0),!a&&this._override||(this._override=a,this._hidden=!1,this._rawWidth=-1,this._rawHeight=-1,this.fadeIn?this._element.fadeIn(500):this._element.show()))},hide:function(a){this._element&&("boolean"!=typeof a&&(a=!0),!a&&this._override||(this._override=a,this._hidden=!0,this._rawWidth=-1,this._rawHeight=-1,this.fadeOut?this._element.fadeOut(500):this._element.hide()))},clearVisibilityOverride:function(){this._override=!1}}),EC_WaterPlane=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"xSize",5e3,Attribute.Int),this.declareAttribute(1,"ySize",5e3,Attribute.Int),this.declareAttribute(2,"depth",1e4,Attribute.Int),this.declareAttribute(3,"position",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(4,"rotation",new THREE.Quaternion(0,0,0,1),Attribute.Quat),this.declareAttribute(5,"scaleUfactor",2e-4,Attribute.Real),this.declareAttribute(6,"scaleVfactor",2e-4,Attribute.Real),this.declareAttribute(7,"xSegments",10,Attribute.Int),this.declareAttribute(8,"ySegments",10,Attribute.Int),this.declareAttribute(9,"materialName","",Attribute.String),this.declareAttribute(10,"materialRef","",Attribute.AssetReference),this.declareAttribute(11,"fogColor",new Color(.2,.4,.35),Attribute.Color),this.declareAttribute(12,"fogStartDistance",100,Attribute.Real),this.declareAttribute(13,"fogEndDistance",2e3,Attribute.Real),this.declareAttribute(14,"fogMode",EC_WaterPlane.FogMode.Linear,Attribute.Int),this.declareAttribute(15,"fogExpDensity",999,Attribute.Real)},__classvars__:{TypeId:12,TypeName:"WaterPlane",FogMode:{NoFog:0,Exponential:1,ExponentiallySquare:2,Linear:3}}}),EC_WaterPlane_ThreeJs=EC_WaterPlane.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.waterMesh=null,this.waterMaterial=null,this.waterLoaded=!1,this.skipLoading=!1,this.forwardMovement=!0,this.forwardPosition=!0},reset:function(){EC_WaterPlane_ThreeJs.resetWater(this)},update:function(){EC_WaterPlane_ThreeJs.updateWater(this)},attributeChanged:function(a,b,c){3===a&&EC_WaterPlane_ThreeJs.updateWaterPosition(this)},__classvars__:{implementationName:"three.js",uniforms:{map:{type:"t",value:null},normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)},normalMapPos:{type:"f",value:0},ambientLightColor:{type:"fv",value:[]},directionalLights:{value:[]},spotLights:{value:[]},pointLights:{value:[]},hemisphereLights:{value:[]},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},vertexShader:["attribute vec4 tangent;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vLightDirection;","#if NUM_DIR_LIGHTS > 0","uniform vec3 directionalLightDirection[ NUM_DIR_LIGHTS ];","#endif","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","#if NUM_DIR_LIGHTS > 0","vec3 biNormal = cross( normal.xyz, tangent.xyz );","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[0], 0.0 );","lDirection.x = max(dot( lDirection.xyz, tangent.xyz ), 0.01);","lDirection.y = max(dot( lDirection.xyz, biNormal.xyz ), 0.01);","lDirection.z = max(dot( lDirection.xyz, normal.xyz ), 0.01);","vLightDirection = normalize( lDirection.xyz );","#endif","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vUv = uv;","}"],fragmentShader:["uniform sampler2D map;","uniform sampler2D normalMap;","uniform float normalMapPos;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vLightDirection;","void main() {","#if NUM_DIR_LIGHTS > 0","vec4 normalValue = texture2D( normalMap, (vUv + vec2(-normalMapPos * 0.3, normalMapPos * 0.2)) * 128.0);","normalValue = normalValue * 1.2;","gl_FragColor = texture2D( map, (vUv + vec2(-normalMapPos * 0.4, -normalMapPos * 0.2)) * 48.0 ) * dot( normalValue.xyz, vLightDirection );","#else","gl_FragColor = texture2D( map, vUv * 48.0 );","#endif","}"],waterNodeScale:new THREE.Vector3(1,1,1),waterNodeRotation:new THREE.Vector3(-90,0,0),resetWater:function(a){null!=a.waterMesh&&(null!=a.waterMesh.geometry&&(a.waterMesh.geometry.dispose(),a.waterMesh.geometry=null),Tundra.renderer.scene.remove(a.waterMesh),a.waterMesh=null),null!=a.directionLight&&(Tundra.renderer.scene.remove(a.directionLight),a.directionLight=null),null!=a.skyBoxTexture&&(a.skyBoxTexture.dispose(),a.skyBoxTexture=null),null!=a.waterMaterial&&(null!=a.waterMaterial.uniforms.map.value&&(a.waterMaterial.uniforms.map.value.dispose(),a.waterMaterial.uniforms.map.value=null),null!=a.waterMaterial.uniforms.normalMap.value&&(a.waterMaterial.uniforms.normalMap.value.dispose(),a.waterMaterial.uniforms.normalMap.value=null),a.waterMaterial.dispose(),a.waterMaterial=null),a.waterLoaded=!1,a.skipLoading=!1},updateWater:function(a){if(null!=a.parentEntity&&null!=a.parentEntity.parentScene&&!a.waterLoaded&&!a.skipLoading){if(a.skipLoading=EC_WaterPlane_ThreeJs.checkExistingWater(a),a.skipLoading)return void Tundra.client.logWarning("Skipping loading of "+a.typeName+", scene already has a loaded water component.",!0);if(null==a.waterMaterial){var b=new THREE.DDSLoader;b.crossOrigin="anonymous";var c={uniforms:EC_WaterPlane_ThreeJs.uniforms,vertexShader:EC_WaterPlane_ThreeJs.vertexShader.join("\n"),fragmentShader:EC_WaterPlane_ThreeJs.fragmentShader.join("\n")},d=Tundra.asset.resolveAssetRef("webtundra://media/assets/waterplane/waterplane-diffuse-1.dds"),e=b.load(d,function(a){null!=a.mipmaps&&a.mipmaps.length>1&&(a.minFilter=THREE.NearestMipMapNearestFilter),a.anisotropy=4});e.magFilter=THREE.LinearFilter,e.minFilter=THREE.LinearFilter,e.wrapT=THREE.RepeatWrapping,e.wrapS=THREE.MirroredRepeatWrapping,d=Tundra.asset.resolveAssetRef("webtundra://media/assets/waterplane/waterplane-normal-1.dds");var f=b.load(d,function(a){null!=a.mipmaps&&a.mipmaps.length>1&&(a.minFilter=THREE.NearestMipMapNearestFilter),a.anisotropy=4});f.magFilter=THREE.LinearFilter,f.minFilter=THREE.LinearFilter,f.wrapT=THREE.RepeatWrapping,f.wrapS=THREE.RepeatWrapping;var g=THREE.UniformsUtils.clone(c.uniforms);g.map.value=e,g.normalMap.value=f,a.waterMaterial=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:g}),a.waterMaterial.lights=!0}if(null==a.waterMesh){var h={x:2e3,y:2e3};"EC_WaterPlane"===a.typeName&&(h.x=a.attributes.xSize.get(),h.y=a.attributes.ySize.get()),a.waterMesh=new THREE.Mesh(new THREE.PlaneGeometry(Math.min(2e3,h.x),Math.min(2e3,h.y)),a.waterMaterial),a.waterMesh.name=a.typeName+"-mesh",a.waterMesh.geometry.computeTangents(),EC_WaterPlane_ThreeJs.updateWaterPosition(a),Tundra.client.renderer.scene.add(a.waterMesh)}a.waterLoaded=!0,Tundra.frame.onUpdate(a,EC_WaterPlane_ThreeJs.onUpdate)}},updateWaterPosition:function(a){if(null!=a.waterMesh){var b=new THREE.Vector3(0,0,0);"EC_MeshmoonWater"===a.typeName?b.y=a.seaLevel:b.copy(a.position),Tundra.renderer.updateSceneNode(a.waterMesh,new Transform(b,EC_WaterPlane_ThreeJs.waterNodeRotation,EC_WaterPlane_ThreeJs.waterNodeScale)),a.waterMesh.matrixAutoUpdate=!0,a.forwardPosition=!0}},onUpdate:function(a){if(null!=this.waterMaterial&&null!=this.waterMesh){var b=this.waterMaterial.uniforms.normalMapPos.value;this.forwardMovement?b+=a/7e3:b-=a/7e3,b>.05?this.forwardMovement=!1:b<=0&&(this.forwardMovement=!0),this.waterMaterial.uniforms.normalMapPos.value=b,this.forwardPosition?this.waterMesh.position.y+=a/80:this.waterMesh.position.y-=a/80;var c="EC_MeshmoonWater"===this.typeName?this.seaLevel:this.attributes.position.get().y;this.waterMesh.position.y>c+.1?this.forwardPosition=!1:this.waterMesh.position.y<=c&&(this.forwardPosition=!0)}},checkExistingWater:function(a){if(null==a.parentEntity||null==a.parentEntity.parentScene)return!1;for(var b=a.parentEntity.parentScene.components("EC_WaterPlane"),c=0;c<b.length;c++)if(b[c].waterLoaded===!0)return!0;b=a.parentEntity.parentScene.components("EC_HydraX");for(var c=0;c<b.length;c++)if(b[c].waterLoaded===!0)return!0;return!1}}}),ThreeJsRenderer=IRenderSystem.$extend({__init__:function(){this.$super("three.js"),this.log=TundraLogging.getLogger("ThreeJsRenderer")},__classvars__:{getDefaultOptions:function(){return{type:"webgl",antialias:!Tundra.browser.isMobile(),precision:Tundra.browser.isMobile()?"mediump":"highp",logarithmicDepthBuffer:CoreStringUtils.queryValueBool("logdepth"),sortObjects:!0,devicePixelRatio:1}}},load:function(a){this.options=$.extend(ThreeJsRenderer.getDefaultOptions(),a),this.windowSize={width:Tundra.container.width(),height:Tundra.container.height(),position:Tundra.container.position()};try{var b=this.options.type;delete this.options.type,"string"!=typeof b||"canvas"!==b?(this.renderer=new THREE.WebGLRenderer(this.options),this.renderer.setSize(this.windowSize.width,this.windowSize.height)):(this.log.warn("Creating THREE.CanvasRenderer, this is not recommended outside of headless tests!"),this.renderer=new THREE.CanvasRenderer(this.options)),"boolean"==typeof this.options.sortObjects&&(this.renderer.sortObjects=this.options.sortObjects),1!==this.options.devicePixelRatio&&this.setDevicePixelRatio(this.options.devicePixelRatio)}catch(c){return this.renderer=null,void this.log.error("Failed to initialize WebGL rendering, aborting startup:",c)}this.setupShadows({enabled:!0,softShadows:!0,drawDebug:!1,clip:{near:50,far:1e3},textureSize:{width:2048,height:2048},bounds:{right:30,left:-30,top:20,bottom:-20}}),this.cssRenderer=null,this.cssRendererScene=null,this.renderOverride=void 0,this.scene=null,this.activeCameraComponent=null,this.camera=null,this.raycaster=new THREE.Raycaster,this.raycastResult=new RaycastResult,this.raycastResult._raycastVector=new THREE.Vector3(0,0,0),this.raycastResult._raycastDir=new THREE.Vector3(0,0,0),this.raycastResult._raycastTemp=new THREE.Vector3(0,0,0),this.raycastFromResult=new RaycastResult,this.meshes=[],this.axisX=new THREE.Vector3(1,0,0),this.axisY=new THREE.Vector3(0,1,0),this.axisZ=new THREE.Vector3(0,0,1),$(this.renderer.domElement).attr("id","threejs-webgl-canvas").css("pointer-events","auto"),$(this.renderer.domElement).css({position:"absolute",top:0,left:0}),Tundra.client.container.append(this.renderer.domElement),this.onWindowResize(),Tundra.ui.onWindowResize(this,this.onWindowResize),this.materialWhite=new THREE.MeshPhongMaterial({color:this.convertColor("rgb(240,240,240)"),wireframe:!1}),this.materialWhite.name="tundra.MaterialLibrary.SolidWhite",this.materialLoadError=new THREE.MeshPhongMaterial({color:this.convertColor("rgb(240,50,50)"),wireframe:!1}),this.materialLoadError.name="tundra.MaterialLibrary.LoadError",this.registerAssetFactories(),this.registerComponents()},postInitialize:function(){this._sceneObjects={},this._sceneObjectsArray=[],this._sceneObjectsArrayUpdate=!0,this._meshLoadedSubs={},this._trackingKey="",Tundra.client.onConnected(this,this.onConnected),Tundra.client.onDisconnected(this,this.onDisconnected),this.onSceneReset(),Tundra.scene.onReset(this,this.onSceneReset)},onConnected:function(){EC_Placeable_ThreeJs.TransformInterpolator=new TransformInterpolator},onDisconnected:function(){EC_Placeable_ThreeJs.TransformInterpolator=void 0},unload:function(){},onSceneReset:function(){Tundra.scene.onComponentCreated(this,this.onSceneComponentCreated),Tundra.scene.onComponentRemoved(this,this.onSceneComponentRemoved)},onSceneComponentCreated:function(a,b){17===b.typeId&&"function"==typeof b.onMeshLoaded&&(this._trackingKey=a.id+"."+b.id,this._meshLoadedSubs[this._trackingKey]=b.onMeshLoaded(this,this.onSceneMeshLoaded))},onSceneComponentRemoved:function(a,b){17===b.typeId&&this.onSceneMeshUnloaded(a,b)},onSceneMeshLoaded:function(a,b,c){this._trackingKey=a.id+"."+b.id,void 0!==this._sceneObjects[this._trackingKey]&&delete this._sceneObjects[this._trackingKey],Array.isArray(this._sceneObjects[this._trackingKey])||(this._sceneObjects[this._trackingKey]=[]);for(var d=0,e=c.numSubmeshes();d<e;++d)this._sceneObjects[this._trackingKey].push(c.getSubmesh(d));this._sceneObjectsArrayUpdate=!0},onSceneMeshCreated:function(a,b,c){if(this._trackingKey=a.id+"."+b.id,Array.isArray(this._sceneObjects[this._trackingKey])||(this._sceneObjects[this._trackingKey]=[]),Array.isArray(c))for(var d=0;d<c.length;d++)this._sceneObjects[this._trackingKey].push(c[d]);else this._sceneObjects[this._trackingKey].push(c);this._sceneObjectsArrayUpdate=!0},onSceneMeshUnloaded:function(a,b){var c=a.id+"."+b.id;void 0!==this._sceneObjects[c]&&(delete this._sceneObjects[c],this._sceneObjectsArrayUpdate=!0)},_getAllObjects:function(){var a=[];for(var b in this._sceneObjects)a=a.concat(this._sceneObjects[b]);return a},registerAssetFactories:function(){Tundra.asset.registerAssetFactory(new AssetFactory("ThreeJsonMesh",ThreeJsonAsset,{".3geo":"json",".json":"json",".js":"json"},"json")),Tundra.asset.registerAssetFactory(new AssetFactory("ObjMesh",ObjMeshAsset,{".obj":"text"})),Tundra.asset.registerAssetFactory(new AssetFactory("Gltf",GltfAsset,{".gltf":"json"})),Tundra.asset.registerAssetFactory(new AssetFactory("Collada",ColladaAsset,{".dae":"text"})),Tundra.asset.registerAssetFactory(new AssetFactory("Fbx",FBXAsset,{".fbx":"text"})),Tundra.asset.registerAssetFactory(new AssetFactory("AssimpJson",AssimpJsonAsset,{".assimp.json":"json"},"json"))},registerComponents:function(){Scene.registerComponent(EC_EnvironmentLight_ThreeJs),Scene.registerComponent(EC_Fog_ThreeJs),Scene.registerComponent(EC_Sky_ThreeJs),Scene.registerComponent(EC_SkyX_ThreeJs),Scene.registerComponent(EC_AnimationController_ThreeJs),Scene.registerComponent(EC_Light_ThreeJs),Scene.registerComponent(EC_Camera_ThreeJs),Scene.registerComponent(EC_Mesh_ThreeJs),Scene.registerComponent(EC_Placeable_ThreeJs),Scene.registerComponent(EC_Billboard_ThreeJs),Scene.registerComponent(EC_HtmlBillboard_ThreeJs),Scene.registerComponent(EC_WaterPlane_ThreeJs)},getCssRenderer:function(){if(null==this.cssRenderer){this.cssRenderer=new THREE.CSS3DRenderer,this.cssRenderer.setSize(this.windowSize.width,this.windowSize.height);var a=$(this.cssRenderer.domElement),b=$(this.renderer.domElement);a.children().first().attr("id","css-renderer-camera").css("pointer-events","none"),a.attr("id","css-renderer-container"),a.css({"pointer-events":"none","background-color":"transparent",position:"absolute",top:0,margin:0,padding:0,"z-index":1}),b.css({"pointer-events":"auto","background-color":"transparent",position:"absolute",top:0,margin:0,padding:0,"z-index":-1}),Tundra.client.container.append(a),a.append(b)}return this.cssRenderer},setDevicePixelRatio:function(a){this.renderer&&"number"==typeof a&&(a=Math.max(.1,a),this.renderer.setPixelRatio(a),this.onWindowResize())},devicePixelRatio:function(){return this.renderer?this.renderer.getPixelRatio():ThreeJsRenderer.getDefaultOptions().devicePixelRatio},getCssRendererScene:function(){return null==this.cssRenderer&&this.getCssRenderer(),null==this.cssRendererScene&&(this.cssRendererScene=new THREE.Scene),this.cssRendererScene},addCssObject:function(a){this.getCssRendererScene().add(a),void 0!==a.element&&$(a.element).css({"pointer-events":"auto",visibility:"",display:"","user-select":"","-webkit-user-select":"","-moz-user-select":"","-ms-user-select":""})},removeCssObject:function(a){this.getCssRendererScene().remove(a),void 0!==a.element&&$(a.element).css({"pointer-events":"none",visibility:"hidden",display:"none","user-select":"none","-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"})},onWindowResize:function(){this.windowSize.width=Tundra.container.width(),this.windowSize.height=Tundra.container.height(),this.windowSize.position=Tundra.container.position(),this.renderer.setSize(this.windowSize.width,this.windowSize.height),null!=this.cssRenderer&&this.cssRenderer.setSize(this.windowSize.width,this.windowSize.height),void 0!==this.camera&&null!==this.camera&&(this.camera.aspect=this.windowSize.width/this.windowSize.height,this.camera.updateProjectionMatrix()),0!==this.windowSize.width&&0!==this.windowSize.height||setTimeout(this.onWindowResize.bind(this),100)},reset:function(){if(null!=this.scene){for(var a=function(a,b){b=Array.isArray(b)?b:[b];for(var c=0;c<b.length;c++){var d=b[c];a&&a[d]&&("function"==typeof a[d].dispose?(a[d].dispose(),a[d]=void 0):"object"==typeof a[d].value&&"function"==typeof a[d].value.dispose&&(a[d].value.dispose(),a[d].value=void 0))}};this.scene.children.length>0;){var b=this.scene.children[0];try{b instanceof THREE.Mesh&&(b&&b.material&&(b.material instanceof THREE.ShaderMaterial?"object"==typeof b.material.uniforms&&a(b.material.uniforms,["map","tCube","normalMap"]):a(b.material,["map","lightMap","specularMap","envMap"])),a(b,["material","geometry"]))}catch(c){this.log.error("Exception while removing child from renderer scene:",b,c.stack||c)}this.scene.remove(b),b=null}delete this.scene,this.scene=null}this.scene=new THREE.Scene,this.ambientLight=this.createLight("ambient"),this.ambientLight.color=this.defaultSceneAmbientLightColor().toThreeColor(),this.scene.add(this.ambientLight)},setupShadows:function(a,b){if(null==this.renderer||void 0===a)return!1;void 0===this.shadowSettings&&(this.shadowSettings={shadowCastingLights:0,lights:0}),void 0!==a.enabled&&(this.shadowSettings.enabled=a.enabled),void 0!==a.softShadows&&(this.shadowSettings.softShadows=a.softShadows),void 0!==a.textureSize&&(this.shadowSettings.textureSize=a.textureSize),void 0!==a.clip&&(this.shadowSettings.clip=a.clip),void 0!==a.bounds&&(this.shadowSettings.bounds=a.bounds),void 0!==a.drawDebug&&(this.shadowSettings.drawDebug=a.drawDebug),Tundra.browser.isMobile()&&(this.shadowSettings.enabled=!1,this.shadowSettings.softShadows=!1,this.shadowSettings.drawDebug=!1);var c=!1;return this.renderer.shadowMap&&(c=this.renderer.shadowMap.enabled!==(this.shadowSettings.enabled===!0&&this.shadowSettings.shadowCastingLights>0),c=c||this.renderer.shadowMap.type!==(this.shadowSettings.softShadows===!0?THREE.PCFSoftShadowMap:THREE.PCFShadowMap),this.renderer.shadowMap.enabled=this.shadowSettings.enabled===!0&&this.shadowSettings.shadowCastingLights>0,this.renderer.shadowMap.type=this.shadowSettings.softShadows===!0?THREE.PCFSoftShadowMap:THREE.PCFShadowMap),Tundra.events.send("ThreeJsRenderer.ShadowSettingsChanged",this.shadowSettings,c,b),c},updateLights:function(a){var b=this.shadowSettings.lights,c=this.shadowSettings.shadowCastingLights;this.shadowSettings.shadowCastingLights=0,this.shadowSettings.lights=0,this.scene.traverse(function(a){a instanceof THREE.Light&&(this.shadowSettings.lights++,a instanceof THREE.SpotLight&&a.castShadow?this.shadowSettings.shadowCastingLights++:a instanceof THREE.DirectionalLight&&a.castShadow&&!a.shadowCascade?this.shadowSettings.shadowCastingLights++:a instanceof THREE.PointLight&&a.castShadow&&this.shadowSettings.shadowCastingLights++)}.bind(this)),a&&"object"==typeof a&&(a._lights_self_change=!0);var d=this.setupShadows({enabled:this.shadowSettings.enabled},a)||this.shadowSettings.shadowCastingLights!==c||this.shadowSettings.lights!==b;
a&&"object"==typeof a&&"boolean"==typeof a._lights_self_change&&delete a._lights_self_change,d&&this.scene.traverse(function(a){a&&"object"==typeof a&&a.material&&"boolean"==typeof a.material.needsUpdate&&(a.material.needsUpdate=!0)})},onShadowSettingsChanged:function(a,b){return Tundra.events.subscribe("ThreeJsRenderer.ShadowSettingsChanged",a,b)},defaultSceneAmbientLightColor:function(){return new Color(.364,.364,.364,1)},getAllMeshes:function(){if(0==this.meshes.length)for(var a=Tundra.client.scene.components("Mesh"),b=0;b<a.length;++b){var c=a[b];if(null!=c.meshAsset&&null!=c.meshAsset.mesh)for(var d=0;d<c.meshAsset.numSubmeshes();++d)this.meshes.push(c.meshAsset.getSubmesh(d))}return this.meshes},update:function(a,b){this.raycastResult.reset(),this.meshes.length>0&&(this.meshes=[]),TWEEN.update(),WebTundraColladaWrapper.KeyFrameAnimationHandler.update(a),WebTundraGltfWrapper.Animator.update(),this.scene&&this.camera&&WebTundraGltfWrapper.Shaders.update(this.scene,this.camera),this.render()},render:function(){if(void 0!==this.scene&&null!==this.scene&&void 0!==this.camera&&null!==this.camera&&(this.renderOverride?this.renderOverride(this.renderer,this.scene,this.camera):this.renderer.render(this.scene,this.camera),null!=this.cssRenderer&&null!=this.cssRendererScene)){for(var a=Tundra.scene.components("WebBrowser"),b=0,c=a.length;b<c;b++)a[b].updateCssObjectTransform();this.cssRenderer.render(this.cssRendererScene,this.camera)}},posDirForMouse:function(a,b){var c,d;"object"==typeof a?(c=a.x,d=a.y):(c=a,d=b);var e=MathUtils.degToRad(.5*this.camera.fov),f=Math.atan(Math.tan(e)*this.camera.aspect),g=1*Math.tan(f),h=1*Math.tan(e);return this.activeCameraComponent.orthographic&&(g=this.camera.right,h=this.camera.top),void 0===this._resultCache&&(this._resultCache={pos:new THREE.Vector3,dir:new THREE.Vector3}),void 0===this._quatCache&&(this._quatCache=new THREE.Quaternion),this._resultCache.dir.set(c*g,d*h,-1),this._resultCache.pos.setFromMatrixPosition(this.camera.matrixWorld),this._quatCache.setFromRotationMatrix(this.camera.matrixWorld),this._resultCache.dir.applyQuaternion(this._quatCache),this.activeCameraComponent.orthographic&&(this._resultCache.pos.add(this._resultCache.dir),this._resultCache.dir.set(0,0,-1),this._resultCache.dir.applyQuaternion(this._quatCache)),this._resultCache},raycastAllFrom:function(a,b,c,d,e,f){return this.raycastFrom(a,b,c,d,e,f,!0)},raycastFrom:function(a,b,c){if(!c||"object"!=typeof c){c={};for(var d=0;d<arguments.length;++d){var e=arguments[d];switch(d){case 2:c.selectionLayer=e;break;case 3:c.targets=e;break;case 4:c.ignoreECModel=e;break;case 5:c.recursive=e;break;case 6:c.all=e}}}if("number"!=typeof c.selectionLayer&&c.selectionLayer>0&&(c.selectionLayer=4294967295),"boolean"!=typeof c.ignoreECModel&&(c.ignoreECModel=!1),"boolean"!=typeof c.recursive&&(c.recursive=!1),"boolean"!=typeof c.all&&(c.all=!1),this.raycastFromResult.reset(),this.raycastFromResult.setExecutionInfo(-1,-1,c.selectionLayer),a instanceof THREE.Vector3==!1||b instanceof THREE.Vector3==!1)return this.log.warn("raycastFrom: origin/direction is not a THREE.Vector3:",a,b),this.raycastFromResult;if(void 0===this.raycastFromResult.origin&&(this.raycastFromResult.origin=new THREE.Vector3),this.raycastFromResult.origin.copy(a),void 0===this.raycastFromResult.direction&&(this.raycastFromResult.direction=new THREE.Vector3),this.raycastFromResult.direction.copy(b),void 0===c.targets&&(this._sceneObjectsArrayUpdate&&(this._sceneObjectsArray=this._getAllObjects(),this._sceneObjectsArrayUpdate=!1),c.targets=this._sceneObjectsArray),0===c.targets.length)return this.raycastFromResult;this.raycaster.set(a,b);var f=this.raycaster.intersectObjects(c.targets,c.recursive);return this._raycastResults(this.raycaster,f,this.raycastFromResult,c.selectionLayer,c.ignoreECModel,c.all)},raycastAll:function(a){if("object"!=typeof a){a={};for(var b=0;b<arguments.length;++b){var c=arguments[b];switch(b){case 0:a.x=c;break;case 1:a.y=c;break;case 2:a.selectionLayer=c;break;case 3:a.targets=c;break;case 4:a.ignoreECModel=c;break;case 5:a.recursive=c;break;case 6:a.all=c}}}return a.all=!0,this.raycast(a)},raycast:function(a){if(!a||"object"!=typeof a){a={};for(var b=0;b<arguments.length;++b){var c=arguments[b];switch(b){case 0:a.x=c;break;case 1:a.y=c;break;case 2:a.selectionLayer=c;break;case 3:a.targets=c;break;case 4:a.ignoreECModel=c;break;case 5:a.recursive=c;break;case 6:a.all=c}}}"number"!=typeof a.x&&(a.x=Tundra.input.mouse.x),"number"!=typeof a.y&&(a.y=Tundra.input.mouse.y),"number"!=typeof a.selectionLayer&&(a.selectionLayer=4294967295),"boolean"!=typeof a.ignoreECModel&&(a.ignoreECModel=!1),"boolean"!=typeof a.recursive&&(a.recursive=!1),"boolean"!=typeof a.all&&(a.all=!1),a.x+=this.windowSize.position.left,a.y-=this.windowSize.position.top;var d=!1;if(void 0!==this.raycastResult._ignoreECModel&&this.raycastResult._ignoreECModel!==a.ignoreECModel?d=!0:void 0!==this.raycastResult._all&&this.raycastResult._all!==a.all&&(d=!0),!d&&void 0===a.targets&&!this.raycastResult.hasError()&&this.raycastResult.executionMatches(a.x,a.y,a.selectionLayer))return this.raycastResult;if(this.raycastResult.reset(),null===a.x||null===a.y)return this.raycastResult;if(void 0===this.camera||null===this.camera)return this.raycastResult.setError("No active rendering camera set"),this.raycastResult;if(a.x>this.windowSize.width||a.y>this.windowSize.height)return this.raycastResult.setError("x and/or y screen position out of bounds"),this.raycastResult;if(void 0===a.targets&&(this._sceneObjectsArrayUpdate&&(this._sceneObjectsArray=this._getAllObjects(),this._sceneObjectsArrayUpdate=!1),a.targets=this._sceneObjectsArray),0===a.targets.length)return this.raycastResult;this.raycastResult.setExecutionInfo(a.x,a.y,a.selectionLayer),this.raycastResult._ignoreECModel=a.ignoreECModel,this.raycastResult._all=a.all,this.raycastResult._raycastVector.x=a.x/this.windowSize.width*2-1,this.raycastResult._raycastVector.y=2*-(a.y/this.windowSize.height)+1,this.raycastResult._raycastVector.z=0;var e=this.camera.near;if(this.camera.near=2e3,this.camera.updateProjectionMatrix(),this.camera instanceof THREE.PerspectiveCamera)this.raycastResult._raycastVector.z=.5,this.raycastResult._raycastVector.unproject(this.camera),this.activeCameraComponent.parentEntity.placeable.worldPosition(this.raycastResult._raycastTemp),this.raycaster.set(this.raycastResult._raycastTemp,this.raycastResult._raycastVector.sub(this.raycastResult._raycastTemp).normalize());else{if(!(this.camera instanceof THREE.OrthographicCamera))return Tundra.options.usingRequireJS()&&this.log.error("Only THREE.OrthographicCamera and THREE.PerspectiveCamera are supported atm!"),a.all?(this._resetRaycastNearClip(this.camera,e),[raycastResult]):(this._resetRaycastNearClip(this.camera,e),raycastResult);var f=this.posDirForMouse(this.raycastResult._raycastVector);this.raycaster.set(f.pos,f.dir)}this._resetRaycastNearClip(this.camera,e);var g=this.raycaster.intersectObjects(a.targets,a.recursive);return this._raycastResults(this.raycaster,g,this.raycastResult,a.selectionLayer,a.ignoreECModel,a.all,a.recursive)},_resetRaycastNearClip:function(a,b){this.camera.near=b,this.camera.updateProjectionMatrix()},_raycastResults:function(a,b,c,d,e,f,g){var h=f?[]:void 0;g=g||!1;for(var i=0,j=b.length;i<j;++i){var k=b[i];if(k.object instanceof THREE.Mesh||k.object instanceof THREE.SkinnedMesh||k.object instanceof THREE.Sprite){var l=k.object;if(g){for(;l.parent&&null==l.parent.tundraEntityId;)l=l.parent;if(!(e||l.parent&&null!=l.parent.tundraEntityId))continue}if(e||null==l.parent||null==l.parent.tundraEntityId){if(e){if(c.object=k.object,c.pos.copy(k.point),c.distance=k.distance,c.ray.copy(a.ray),c.copyFace(k.face),void 0===h)break;h.push(c.clone())}}else{var m=Tundra.scene.entityById(l.parent.tundraEntityId);if(null!=m){if(null!=m.placeable){if(!m.placeable.visible)continue;if(0===(m.placeable.selectionLayer&d))continue}if(l instanceof THREE.Sprite&&k.point.setFromMatrixPosition(l.matrixWorld),c.object=l,c.pos.copy(k.point),c.distance=k.distance,c.ray.copy(a.ray),c.copyFace(k.face),void 0!==l.tundraSubmeshIndex&&(c.submeshIndex=l.tundraSubmeshIndex),c.entity=m,c.component=m.mesh,(l instanceof THREE.Sprite||!c.component)&&m.billboard&&(c.component=m.billboard),c.selectionLayer=m.placeable.selectionLayer,void 0===h)break;h.push(c.clone())}}}}return void 0!==h?h:c},createLight:function(a,b,c,d){void 0!==b&&(b=this.convertColor(b)),void 0===c&&(c=1),void 0===d&&(d=0);var e=null;return"point"==a?e=new THREE.PointLight(b,c,d):"directional"==a?e=new THREE.DirectionalLight(b,c,d):"spot"==a?e=new THREE.SpotLight(b,c,d,!0):"ambient"==a&&(e=new THREE.AmbientLight(b)),e},convertColor:function(a){if(void 0!==a){if("#"===a.substr(0,1))return a;var b=/(.*?)rgb\((\d+),(\d+),(\d+)\)/.exec(a),c=parseInt(b[2]),d=parseInt(b[3]),e=parseInt(b[4]);return e|d<<8|c<<16}},onActiveCameraChanged:function(a,b){return Tundra.events.subscribe("ThreeJsRenderer.ActiveCameraChanged",a,b)},setActiveCamera:function(a){if(null===a)return void 0!==this.activeCameraComponent&&null!==this.activeCameraComponent&&(this.activeCameraComponent.active=!1),this.camera=null,this.activeCameraComponent=null,!0;if(!(a instanceof EC_Camera_ThreeJs))return this.log.error("[ThreeJsRenderer]: setActiveCamera called with non EC_Camera_ThreeJs component!",a),!1;var b;return this.activeCameraComponent&&(this.activeCameraComponent.active=!1,b=this.activeCameraComponent),this.camera=a.camera,this.activeCameraComponent=a,this.activeCameraComponent.active=!0,this.options.logarithmicDepthBuffer===!0&&(this.camera.far=1e27,this.camera.near=1e-6),Tundra.events.send("ThreeJsRenderer.ActiveCameraChanged",this.activeCameraComponent,b),b=void 0,!0},activeCamera:function(){return this.activeCameraComponent},activeCameraEntity:function(){return null!=this.activeCameraComponent?this.activeCameraComponent.parentEntity:null},activeCameraWorldPosition:function(){var a=this.activeCameraEntity();if(a&&a.placeable)return a.placeable.worldPosition()},activeCameraWorldFocusPosition:function(){if(this.activeCameraComponent&&"function"==typeof this.activeCameraComponent.getWorldFocusPosition)return this.activeCameraComponent.getWorldFocusPosition()},createSceneNode:function(){var a=new THREE.Object3D;return a.matrixAutoUpdate=!1,a},updateSceneNode:function(a,b){null!=a&&(a.matrixAutoUpdate===!0&&(a.matrixAutoUpdate=!1),a.position.copy(b.pos),b.copyOrientationTo(a.quaternion),a.scale.copy(b.scale),(a.scale.x<1e-7||a.scale.y<1e-7||a.scale.z<1e-7)&&(this.log.warn("Fixing negative/zero scale",a.scale.toString(),"for object",a.name),a.scale.x<1e-7&&(a.scale.x=1e-7),a.scale.y<1e-7&&(a.scale.y=1e-7),a.scale.z<1e-7&&(a.scale.z=1e-7)),a.updateMatrix(),a.updateMatrixWorld())}}),IInputPlugin=Class.$extend({__init__:function(a){void 0===a&&(console.error("[IInputPlugin]: Constructor called without a plugin name!"),a="Unknown"),this.name=a,this.running=!1,this._registeredInputEvents=[]},__classvars__:{register:function(){var a=new this;InputAPI.registerPlugin(a)}},_start:function(){this.start(),this.running=!0},start:function(){Tundra.client.logError("[IInputPlugin]: Plugin '"+name+"' has not implemented start()")},_stop:function(){this.stop(),this.unregisterEvents(!0),this.running=!1},stop:function(){Tundra.client.logError("[IInputPlugin]: Plugin '"+name+"' has not implemented stop()")},_reset:function(){this.reset(),this.unregisterEvents(!1)},reset:function(){},registerEvent:function(a,b){var c=Tundra.input.registerPluginEvent(a,b);return c===!0&&this._registeredInputEvents.push(b),c},unregisterEvents:function(a){for(var b=0;b<this._registeredInputEvents.length;b++){var c=this._registeredInputEvents[b];"string"==typeof c&&Tundra.events.remove(c)}a===!0&&(this._registeredInputEvents=[])}}),InputEventTouch=IInputEvent.$extend({__init__:function(){this.$super("InputEventTouch"),Object.defineProperties(this,{isMultiTouch:{get:function(){return this.pointers.length>1}}}),this.isFirst=!1,this.isFinal=!1,this.pointers=[],this.changedPointers=[],this.pointerType="",this.event="",this.eventId=0,this.deltaX=0,this.deltaY=0,this.deltaTime=0,this.distance=0,this.angle=0,this.velocityX=0,this.velocityY=0,this.velocity=0,this.direction=0,this.offsetDirection=0,this.scale=1,this.relativeScale=0,this.rotation=0,this.relativeRotation=0,this.center={x:0,y:0},this._start=!1,this._cache={scale:{},rotation:{}},this._clearCache()},__classvars__:{Type:{tap:1,doubletap:2,pan:3,swipe:4,press:5,pinch:6,rotate:7},Event:{Start:1,Move:2,End:4,Cancel:8},Direction:{None:1,Left:2,Right:4,Up:8,Down:16,Horizontal:6,Vertical:24,All:30},CommonHammerProperties:["isFirst","isFinal","pointers","changedPointers","deltaX","deltaY","deltaTime","distance","angle","velocityX","velocityY","velocity","direction","offsetDirection","pointerType"]},clear:function(){this._start=!0},toString:function(){var a=this.name+"{ "+this.basePropertiesToString();return a+"\n    "+this.propertiesToString()+" }"},propertiesToString:function(){return"eventId:"+this.eventId+" event:"+this.event+" first:"+this.isFirst+" last:"+this.isFinal+" pointers:"+this.changedPointers.length+"/"+this.pointers.length+" "+this.pointerType+" delta:("+this.deltaX+","+this.deltaY+") deltaTime:"+this.deltaTime+" distance:"+this.distance+" angle:"+this.angle+" velocity:("+this.velocityX+","+this.velocityY+") direction:"+this.direction+" scale:"+this.scale+" relativeScale:"+this.relativeScale+" rotation:"+this.rotation+" relativeRotation:"+this.relativeRotation},_copyProperties:function(a,b){for(var c=0;c<b.length;c++){var d=b[c];this[d]=a[d]}},_clearCache:function(a){if("string"!=typeof a)for(var b=Object.keys(InputEventTouch.Type),c=0;c<b.length;c++){var a=b[c];this._cache.scale[a]=1,this._cache.rotation[a]=0}else this._cache.scale[a]=1,this._cache.rotation[a]=0},setOriginalEvent:function(a){this.$super(a.srcEvent),this._copyProperties(a,InputEventTouch.CommonHammerProperties),this._preventDefaultFunction=a.preventDefault,this.setType(a.type),this.setEvent(a.eventType),this._start===!0&&(this.clearPosition(),this.clearScaleAndRotation(),this.isFirst=!0,this._start=!1),this.setPosition(a.center.x,a.center.y),this.center.x=a.center.x,this.center.y=a.center.y,this.setScale(a),this.setRotation(a),this.eventId!==Hammer.INPUT_END&&this.eventId!==Hammer.INPUT_CANCEL||(this.clearRelativePosition(),this.clearRelativeScaleAndRotation())},setType:function(a){"pan2"===a&&(a="pan"),this.type=a,this.typeId="number"==typeof InputEventTouch.Type[a]?InputEventTouch.Type[a]:IInputEvent.Type.Unknown},setEvent:function(a){switch(a){case Hammer.INPUT_START:this.event="start",this._start=!0;break;case Hammer.INPUT_MOVE:this.event="move";break;case Hammer.INPUT_END:this.event="end",this.isFinal=!0;break;case Hammer.INPUT_CANCEL:this.event="cancel",this.isFinal=!0;break;default:return this.log.error("setEvent: Invalid event id:",a),this.event="",this.eventId=-1,this.clearPosition(),void this.clearRelativeScaleAndRotation()}this.eventId=a},setPosition:function(a,b){var c=null===this.x,d=null===this.y;this.$super(a,b),c&&(this.relativeX=0),d&&(this.relativeY=0)},clearScaleAndRotation:function(){this.scale=1,this.rotation=0,this._clearCache(this.type)},clearRelativeScaleAndRotation:function(){this.relativeScale=0,this.relativeRotation=0},setScale:function(a){var b=this._cache.scale[a.type];a.pointers.length>1&&"number"==typeof b?this.relativeScale=a.scale-b:this.relativeScale=0,this._cache.scale[a.type]=this.scale=a.scale},setRotation:function(a){var b=this._cache.rotation[a.type];a.pointers.length>1&&"number"==typeof b?this.relativeRotation=a.rotation-b:this.relativeRotation=0,this._cache.rotation[a.type]=this.rotation=a.rotation}}),InputTouchPlugin=IInputPlugin.$extend({__init__:function(a){this.$super("Touch"),this.suppressing={pan:!1},this.hammers=[]},__classvars__:{SimulateWithMouse:Tundra.browser.isMobile(),SuppressMasecPanAfterMultiPan:200},start:function(){this.touch=new InputEventTouch,this.registerTouchEvents(Tundra.client.container),this.registerEvent("TouchEvent","InputTouchPlugin.TouchEvent"),this.registerEvent("TouchPan","InputTouchPlugin.TouchPan"),this.registerEvent("TouchSwipe","InputTouchPlugin.TouchSwipe"),this.registerEvent("TouchPinch","InputTouchPlugin.TouchPinch"),this.registerEvent("TouchRotate","InputTouchPlugin.TouchRotate"),this.registerEvent("TouchPress","InputTouchPlugin.TouchPress"),this.registerEvent("TouchTap","InputTouchPlugin.TouchTap"),this.registerEvent("TouchDoubleTap","InputTouchPlugin.TouchDoubleTap")},stop:function(){for(var a=0;a<this.hammers.length;a++)this.hammers[a].stop(!0),this.hammers[a].destroy();this.hammers=[]},registerTouchEvents:function(a){var b=new Hammer($(a).get(0)),c=new Hammer.Rotate,d=new Hammer.Pinch,e=b.get("pan").set({threshold:10,pointers:1,direction:Hammer.DIRECTION_ALL}),f=new Hammer.Pan({event:"pan2",threshold:15,pointers:2,direction:Hammer.DIRECTION_ALL});f.recognizeWith(e),d.recognizeWith([f]),c.recognizeWith([d,f]),b.add([f,d,c]),b.get("rotate").set({threshold:10}),b.get("tap").set({threshold:10}),b.get("doubletap").set({threshold:10,posThreshold:20}),b.get("pinch").set({threshold:.05}),b.on("pan",this._onPanInternal.bind(this)),b.on("pan2",this._onPanInternal.bind(this)),b.on("swipe",this._onSwipeInternal.bind(this)),b.on("pinch",this._onPinchInternal.bind(this)),b.on("rotate",this._onRotateInternal.bind(this)),b.on("press",this._onPressInternal.bind(this)),b.on("tap",this._onTapInternal.bind(this)),b.on("doubletap",this._onDoubleTapInternal.bind(this)),b.on("hammer.input",function(a){a.eventType===Hammer.INPUT_START&&this.touch.clear()}.bind(this)),this.hammers.push(b)},_onPanInternal:function(a){if(this.readTouchEvent(a)){var b=this.touch.isMultiTouch;if(this.touch.eventId===InputEventTouch.Event.End&&b&&!this.suppressing.pan)"number"==typeof InputTouchPlugin.SuppressMasecPanAfterMultiPan&&InputTouchPlugin.SuppressMasecPanAfterMultiPan>0&&(setTimeout(function(){this.suppressing.pan=!1}.bind(this),InputTouchPlugin.SuppressMasecPanAfterMultiPan),this.suppressing.pan=!0);else if(!b&&this.suppressing.pan)return;Tundra.events.send("InputTouchPlugin.TouchPan",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)}},_onSwipeInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchSwipe",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onPinchInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchPinch",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onRotateInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchRotate",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onPressInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchPress",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onTapInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchTap",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onDoubleTapInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchDoubleTap",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},readTouchEvent:function(a){return(InputTouchPlugin.SimulateWithMouse!==!1||!("mouse"===a.pointerType||a.srcEvent instanceof MouseEvent))&&(this.touch.setOriginalEvent(a),!0)},onTouchEvent:function(a,b){return Tundra.events.subscribe("InputTouchPlugin.TouchEvent",a,b)},onTouchPan:function(a,b){return Tundra.events.subscribe("InputTouchPlugin.TouchPan",a,b)}});InputTouchPlugin.register();var ITundraPlugin=Class.$extend({__init__:function(a,b){"string"==typeof a&&""!==a||console.error("ITundraPlugin constructor must be called with name that is a non-empty string!"),this.framework=null,this.name=a,this.nameAliases="string"==typeof b?[b]:Array.isArray(b)?[].concat(b):[],this.loaded=!1,this.log=TundraLogging.getLogger(this.name)},_setFramework:function(a){this.framework=a},_initialize:function(a){return this.loaded===!0?void this.log("Already loaded!"):(this.initialize(a),void(this.loaded=!0))},pluginPropertyName:function(){return this.name},initialize:function(a){},_postInitialize:function(){this.postInitialize()},postInitialize:function(){},_uninitialize:function(){this.uninitialize(),this.framework=null,this.loaded=!1},uninitialize:function(){}}),LoginScreenPlugin=ITundraPlugin.$extend({__init__:function(){this.$super("LoginScreenPlugin"),this.loginProperties={},this.ui={},this.loadingScreen=null,this.transfersPeak=0,this.transfersProgress=-1},__classvars__:{LoginControlsEnabled:!1,LoadingScreenEnabled:!1,LoadingScreenBackgroundTransparent:!1,LoadingScreenAutoUpdateAssetProgress:!0,LoadingScreenConnectingText:"Loading Scene",LoadingScreenHeaderText:"realXtend WebTundra",LoadingScreenHeaderLinkUrl:"https://github.com/realXtend/WebTundra"},initialize:function(a){"boolean"==typeof a.loginControlsEnabled&&(LoginScreenPlugin.LoginControlsEnabled=a.loginControlsEnabled),"boolean"==typeof a.loadingScreenEnabled&&(LoginScreenPlugin.LoadingScreenEnabled=a.loadingScreenEnabled),"boolean"==typeof a.transparentBackground&&(LoginScreenPlugin.LoadingScreenBackgroundTransparent=a.transparentBackground),"boolean"==typeof a.updateAssetProgress&&(LoginScreenPlugin.LoadingScreenAutoUpdateAssetProgress=a.updateAssetProgress),"string"==typeof a.connectingText&&(LoginScreenPlugin.LoadingScreenConnectingText=a.connectingText),"string"==typeof a.headerText&&(LoginScreenPlugin.LoadingScreenHeaderText=a.headerText),"string"==typeof a.headerLinkUrl&&(LoginScreenPlugin.LoadingScreenHeaderLinkUrl=a.headerLinkUrl),this.framework.client.onConnectionError(this,this.onConnectionError),this.framework.client.onConnected(this,this.onConnectedToServer),this.framework.client.onDisconnected(this,this.onDisconnectedFromServer),this.framework.asset.onActiveAssetTransferCountChanged(this,this.onActiveAssetTransferCountChanged),this.framework.ui.onWindowResize(this,this.onWindowResized),this.createLoginControls(),this.showLoadingScreen(),setTimeout(this.onWindowResized.bind(this),100)},pluginPropertyName:function(){return"loginscreen"},hide:function(a){a="boolean"!=typeof a||a,this.hideLoginControls(a),this.hideLoadingScreen(!0,a)},createLoginControls:function(){if(LoginScreenPlugin.LoginControlsEnabled){var a="string"==typeof Tundra.DeveloperServerHost?Tundra.DeveloperServerHost:"127.0.0.1",b=CoreStringUtils.queryValue("username")||"Tundra Developer";this.ui.loginControls=$("<div/>",{id:"login-controls"}),this.ui.localControls=$("<div/>",{id:"local-controls"}),this.ui.loginHost=$("<input/>",{id:"login-host",type:"text",value:"ws://"+a+":2345"}),this.ui.loginUsername=$("<input/>",{id:"login-username",type:"text",value:b}),this.ui.loginError=$("<div/>",{id:"login-error",css:{padding:15,"font-size":16,color:"red"}}),this.ui.loginButton=$("<button/>",{id:"login-button",text:"CONNECT",css:{"font-size":12,"font-weight":"bold"}}).button(),this.ui.localButton=$("<button/>",{id:"local-button",text:"NEW LOCAL SCENE",css:{"font-size":12,"font-weight":"bold"}}).button(),this.ui.loginControls.css({position:"absolute",top:180,left:0,width:"100%",padding:10,border:0,"z-index":Tundra.ui.topZIndex()+1,"text-align":"center","font-family":"Arial","font-size":14,"font-weight":"bold","background-color":"transparent"}),this.ui.localControls.css({position:"absolute",top:60,left:0,width:"100%",padding:10,border:0,"z-index":Tundra.ui.topZIndex()+1,"text-align":"center","font-family":"Arial","font-size":14,"font-weight":"bold","background-color":"transparent"});for(var c=[this.ui.loginHost,this.ui.loginUsername,this.ui.loginButton,this.ui.localButton],d=0;d<c.length;d++)c[d].css({"min-width":100,"max-height":25,"margin-left":6,"margin-right":9,padding:c[d]===this.ui.loginButton||c[d]===this.ui.localButton?0:3,border:"1px solid lightgrey","border-radius":4});this.ui.localControls.append("<div style='margin-bottom: 5px'>or start a new, empty local scene:</div>"),this.ui.localControls.append(this.ui.localButton),this.ui.localControls.fadeIn(1e3),this.ui.loginControls.append("<div style='margin-bottom: 5px'>Connect to a Tundra server:</div>"),this.ui.loginControls.append(this.ui.loginHost),this.ui.loginControls.append(this.ui.loginUsername),this.ui.loginControls.append(this.ui.loginButton),this.ui.loginControls.append(this.ui.loginError),this.ui.loginControls.append(this.ui.localControls),this.ui.loginControls.fadeIn(1e3),this.framework.ui.addWidgetToScene(this.ui.loginControls),this.ui.loginButton.click(this.onToggleConnectionState.bind(this)),this.ui.localButton.click(function(){Tundra.client.fakeConnectionState()})}},onToggleConnectionState:function(){this.ui.loginError.text(""),this.framework.client.isConnected()?this.framework.client.disconnect():(void 0===this.loginProperties&&(this.loginProperties={}),this.loginProperties.username=this.ui.loginUsername.val(),this.framework.client.connect(this.ui.loginHost.val(),this.loginProperties))},onConnectionError:function(a){void 0!==this.ui.loginError&&this.ui.loginError.text("Failed to connect to "+a.target.url)},onConnectedToServer:function(){this.updateLoadingScreen(LoginScreenPlugin.LoadingScreenConnectingText,0),LoginScreenPlugin.LoginControlsEnabled&&(this.ui.loginHost.attr("disabled","disabled"),this.ui.loginUsername.attr("disabled","disabled"),this.ui.loginButton.button("option","label","Disconnect"),this.hideLoginControls(!1)),setTimeout(function(){this.isLoadingScreenVisible()&&this.framework.asset.allTransfersCompleted()&&(this.log.debug("Seems there are no pending asset transfers, hiding loading screen..."),this.hideLoadingScreen())}.bind(this),2500)},onDisconnectedFromServer:function(){this.showLoadingScreen(),LoginScreenPlugin.LoginControlsEnabled&&(this.ui.loginHost.removeAttr("disabled"),this.ui.loginUsername.removeAttr("disabled"),this.ui.loginButton.button("option","label","Connect"),this.loginProperties={},this.showLoginControls())},showLoginControls:function(){void 0!==this.ui.loginControls&&(this.ui.loginControls.fadeIn(1e3),this.onWindowResized())},hideLoginControls:function(a){a="boolean"!=typeof a||a,void 0!==this.ui.loginControls&&(a===!0?this.ui.loginControls.fadeOut(500):this.ui.loginControls.hide())},isLoadingScreenVisible:function(){return null!=this.loadingScreen},showLoadingScreen:function(){if(Tundra.events.send("LoginScreenPlugin.Show"),LoginScreenPlugin.LoadingScreenEnabled&&null==this.loadingScreen){if(this.loadingScreen={done:!1},this.transfersPeak=0,this.transfersProgress=-1,this.loadingScreen.screen=$("<div/>",{id:"webtundra-loading-screen"}),this.loadingScreen.screen.css({position:"absolute",width:"100%",height:"100%",top:0,left:0,"background-color":"rgb(248,248,248)","z-index":Tundra.ui.topZIndex()}),this.loadingScreen.screen.css("background-color",LoginScreenPlugin.LoadingScreenBackgroundTransparent?"transparent":"rgb(221,221,221)"),this.loadingScreen.text=$("<div/>",{id:"webtundra-loading-screen-label"}).css({color:"rgb(50,50,50)","text-align":"center","font-family":"Verdana","font-weight":"bold","font-size":36,"text-align":"center","vertical-align":"center","text-decoration":"none"}),""!==LoginScreenPlugin.LoadingScreenHeaderText){var a=$("<a/>",{text:LoginScreenPlugin.LoadingScreenHeaderText,href:LoginScreenPlugin.LoadingScreenHeaderLinkUrl,target:"_blank"});a.css({color:"rgb(50,50,50)","text-align":"center","font-family":"Verdana","font-weight":"bold","text-align":"center","vertical-align":"bottom","text-decoration":"none"}),this.loadingScreen.text.append(a)}if(this.loadingScreen.progress=$("<div/>",{id:"webtundra-loading-screen-progress"}),this.loadingScreen.progress.css({color:"rgba(50,50,50, 0.0)","text-align":"center","font-family":"Verdana","font-weight":"bold","font-size":"80pt","vertical-align":"center"}),this.loadingScreen.progress.hide(),this.loadingScreen.hideButton=$("<div/>",{id:"webtundra-loading-screen-hidebutton",html:"Hide Loading Screen"}),this.loadingScreen.hideButton.css({color:"rgba(50,50,50,0.6)","font-family":"Verdana","font-weight":"bold","font-size":"7pt",position:"absolute",cursor:"pointer",top:5,left:5}),this.loadingScreen.hideButton.click(function(a){""!=this.loadingScreen.progress.text()&&(this.hideLoadingScreen(),a.preventDefault(),a.stopPropagation())}.bind(this)),this.loadingScreen.screen.append(this.loadingScreen.hideButton),this.loadingScreen.screen.append(this.loadingScreen.text),this.loadingScreen.screen.append(this.loadingScreen.progress),this.framework.ui.addWidgetToScene(this.loadingScreen.screen),this.loadingScreen.text.hide(),this.loadingScreen.text.fadeIn(1e3),this.onWindowResized(),this.autoConnectedOnce!==!0){this.autoConnectedOnce=!0;var b=CoreStringUtils.queryValue("autoconnect");if(""!==b&&!isNaN(parseInt(b))){var c=parseInt(b);if(!(c<0)){var d=c<200?1e3*c:c,e=d/1e3;if(setTimeout(function(){Tundra.client.isConnected()||this.onToggleConnectionState()}.bind(this),d),e>=1){var f=$("<div/>",{html:"Auto connecting in <span style='color: steelblue;'>"+e+"</span>",css:{position:"absolute",top:"calc(100% - 100px)",left:0,width:"100%","text-align":"center","font-size":34,color:"#616161"}});this.loadingScreen.screen.prepend(f);var g=setInterval(function(){e--,f.html("Auto connecting in <span style='color: steelblue;'>"+e+"</span>"),e<=0&&(f.remove(),f=null,clearInterval(g))},1e3)}}}}}},updateLoadingScreen:function(a,b){if(Tundra.client.isConnected()&&(Tundra.events.send("LoginScreenPlugin.ProgressUpdate",b),LoginScreenPlugin.LoadingScreenEnabled&&null!=this.loadingScreen&&!this.loadingScreen.done&&(null!=a&&null!=this.loadingScreen.text&&this.loadingScreen.text.text(a),null!=b&&null!=this.loadingScreen.progress))){if(void 0!==this.loadingScreen.completedOnce&&this.loadingScreen.completedOnce===!0)return;var c=this.loadingScreen.progress.is(":visible");if(b<100){var d=b/100;d>.9&&(d=.9),this.loadingScreen.progress.html(b+"<span style='font-size: 20pt;color:rgba(50,50,50,"+d+");'>%</span>"),this.loadingScreen.progress.css("color","rgba(242,154,41, "+d+")")}else this.loadingScreen.completedOnce=!0,this.loadingScreen.text.html("Loading completed<br><span style='color:rgba(50,50,50, 0.4);font-size: 28pt';>Please wait</span>"),this.loadingScreen.progress.text(""),this.loadingScreen.progress.hide(),this.onWindowResized();c||(this.loadingScreen.progress.show(),this.onWindowResized())}},hideLoadingScreen:function(a,b){b="boolean"!=typeof b||b,this.transfersPeak=0,this.transfersProgress=-1,void 0===a&&(a=!1),(a||Tundra.client.isConnected())&&(Tundra.events.send("LoginScreenPlugin.Hide"),null==this.loadingScreen||this.loadingScreen.done||(this.loadingScreen.done=!0,this.loadingScreen.hideButton.remove(),this.loadingScreen.screen.fadeOut(500,function(){this.loadingScreen.screen.remove(),this.loadingScreen.screen=null,this.loadingScreen=null,this.onWindowResized()}.bind(this))))},onWindowResized:function(a,b){b=b||Tundra.ui.height(),null==this.loadingScreen||this.loadingScreen.done||(this.loadingScreen.text.position({my:"left top",at:"left top+"+(b>500?100:50),of:this.loadingScreen.screen}),this.loadingScreen.progress.position({my:"left top",at:"left bottom+25",of:this.loadingScreen.text}),null!=this.ui.loginControls&&this.ui.loginControls.position({my:"left top",at:"left bottom",of:this.loadingScreen.text}))},onActiveAssetTransferCountChanged:function(a){if(LoginScreenPlugin.LoadingScreenEnabled){if(this.transfersPeak<a&&(this.transfersPeak=a),LoginScreenPlugin.LoadingScreenAutoUpdateAssetProgress&&this.transfersPeak>0){var b=Number(100-a/this.transfersPeak*100);b>this.transfersProgress&&(this.transfersProgress=b,this.updateLoadingScreen(null,b.toFixed(0)))}0===a&&setTimeout(function(){this.framework.asset.allTransfersCompleted()&&this.hideLoadingScreen()}.bind(this),200)}}});Tundra.registerPlugin(new LoginScreenPlugin);var OgreDefines={RenderOperation:{POINT_LIST:1,LINE_LIST:2,LINE_STRIP:3,
TRIANGLE_LIST:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6}},OgreVertexElement=Class.$extend({__init__:function(a,b,c,d,e){this.source=a,this.type=b,this.semantic=c,this.offset=d,this.index=e,this.typeName=OgreVertexElement.getTypeName(this.type),this.size=OgreVertexElement.getTypeSize(this.type),this.itemCount=OgreVertexElement.getTypeItemCount(this.type)},__classvars__:{type:{FLOAT1:0,FLOAT2:1,FLOAT3:2,FLOAT4:3,COLOUR:4,SHORT1:5,SHORT2:6,SHORT3:7,SHORT4:8,UBYTE4:9,COLOUR_ARGB:10,COLOUR_ABGR:11,DOUBLE1:12,DOUBLE2:13,DOUBLE3:14,DOUBLE4:15,USHORT1:16,USHORT2:17,USHORT3:18,USHORT4:19,INT1:20,INT2:21,INT3:22,INT4:23,UINT1:24,UINT2:25,UINT3:26,UINT4:27},semantic:{POSITION:1,BLEND_WEIGHTS:2,BLEND_INDICES:3,NORMAL:4,DIFFUSE:5,SPECULAR:6,TEXTURE_COORDINATES:7,BINORMAL:8,TANGENT:9,COUNT:9},getTypeName:function(a){switch(a){case OgreVertexElement.type.COLOUR:return"COLOUR";case OgreVertexElement.type.COLOUR_ABGR:return"COLOUR_ABGR";case OgreVertexElement.type.COLOUR_ARGB:return"COLOUR_ARGB";case OgreVertexElement.type.FLOAT1:return"FLOAT1";case OgreVertexElement.type.FLOAT2:return"FLOAT2";case OgreVertexElement.type.FLOAT3:return"FLOAT3";case OgreVertexElement.type.FLOAT4:return"FLOAT4";case OgreVertexElement.type.DOUBLE1:return"DOUBLE1";case OgreVertexElement.type.DOUBLE2:return"DOUBLE2";case OgreVertexElement.type.DOUBLE3:return"DOUBLE3";case OgreVertexElement.type.DOUBLE4:return"DOUBLE4";case OgreVertexElement.type.SHORT1:return"SHORT1";case OgreVertexElement.type.SHORT2:return"SHORT2";case OgreVertexElement.type.SHORT3:return"SHORT3";case OgreVertexElement.type.SHORT4:return"SHORT4";case OgreVertexElement.type.USHORT1:return"USHORT1";case OgreVertexElement.type.USHORT2:return"USHORT2";case OgreVertexElement.type.USHORT3:return"USHORT3";case OgreVertexElement.type.USHORT4:return"USHORT4";case OgreVertexElement.type.INT1:return"INT1";case OgreVertexElement.type.INT2:return"INT2";case OgreVertexElement.type.INT3:return"INT3";case OgreVertexElement.type.INT4:return"INT4";case OgreVertexElement.type.UINT1:return"UINT1";case OgreVertexElement.type.UINT2:return"UINT2";case OgreVertexElement.type.UINT3:return"UINT3";case OgreVertexElement.type.UINT4:return"UINT4";case OgreVertexElement.type.UBYTE4:return"UBYTE4"}return"Unknown"},getTypeSize:function(a){switch(a){case OgreVertexElement.type.COLOUR:case OgreVertexElement.type.COLOUR_ABGR:case OgreVertexElement.type.COLOUR_ARGB:return 4;case OgreVertexElement.type.FLOAT1:return 4;case OgreVertexElement.type.FLOAT2:return 8;case OgreVertexElement.type.FLOAT3:return 12;case OgreVertexElement.type.FLOAT4:return 16;case OgreVertexElement.type.DOUBLE1:return 8;case OgreVertexElement.type.DOUBLE2:return 16;case OgreVertexElement.type.DOUBLE3:return 24;case OgreVertexElement.type.DOUBLE4:return 32;case OgreVertexElement.type.SHORT1:return 2;case OgreVertexElement.type.SHORT2:return 4;case OgreVertexElement.type.SHORT3:return 6;case OgreVertexElement.type.SHORT4:return 8;case OgreVertexElement.type.USHORT1:return 2;case OgreVertexElement.type.USHORT2:return 4;case OgreVertexElement.type.USHORT3:return 6;case OgreVertexElement.type.USHORT4:return 8;case OgreVertexElement.type.INT1:return 4;case OgreVertexElement.type.INT2:return 8;case OgreVertexElement.type.INT3:return 12;case OgreVertexElement.type.INT4:return 16;case OgreVertexElement.type.UINT1:return 4;case OgreVertexElement.type.UINT2:return 8;case OgreVertexElement.type.UINT3:return 12;case OgreVertexElement.type.UINT4:return 16;case OgreVertexElement.type.UBYTE4:return 4}},getTypeItemCount:function(a){switch(a){case OgreVertexElement.type.COLOUR:case OgreVertexElement.type.COLOUR_ABGR:case OgreVertexElement.type.COLOUR_ARGB:return 4;case OgreVertexElement.type.FLOAT1:case OgreVertexElement.type.DOUBLE1:case OgreVertexElement.type.SHORT1:case OgreVertexElement.type.USHORT1:case OgreVertexElement.type.INT1:case OgreVertexElement.type.UINT1:return 1;case OgreVertexElement.type.FLOAT2:case OgreVertexElement.type.DOUBLE2:case OgreVertexElement.type.SHORT2:case OgreVertexElement.type.USHORT2:case OgreVertexElement.type.INT2:case OgreVertexElement.type.UINT2:return 2;case OgreVertexElement.type.FLOAT3:case OgreVertexElement.type.DOUBLE3:case OgreVertexElement.type.SHORT3:case OgreVertexElement.type.USHORT3:case OgreVertexElement.type.INT3:case OgreVertexElement.type.UINT3:return 3;case OgreVertexElement.type.FLOAT4:case OgreVertexElement.type.DOUBLE4:case OgreVertexElement.type.SHORT4:case OgreVertexElement.type.USHORT4:case OgreVertexElement.type.INT4:case OgreVertexElement.type.UINT4:return 4;case OgreVertexElement.type.UBYTE4:return 4}}},getTypeName:function(){return this.typeName},getSize:function(){return this.size},getItemCount:function(){return this.itemCount}}),OgreVertexDeclaration=Class.$extend({__init__:function(){this.elements=[]},addElement:function(a){a instanceof OgreVertexElement?this.elements.push(a):Tundra.client.logError("[OgreVertexDeclaration]: addElement() called with non OgreVertexElement parameter")},getElement:function(a,b){for(var c=0;c<this.elements.length;c++){var d=this.elements[c];if(d.semantic===a){if(void 0===b)return d;if(d.index===b)return d}}return null},getElementsInOffsetOrder:function(a){if(0===this.elements.length)return[];for(var b=[],c=null,d=!1,e=0;e<this.elements.length;++e)if(c=this.elements[e],c.source===a){d=!1;for(var f=0;f<b.length;++f)if(c.offset<b[f].offset){b.splice(f,1,c),d=!0;break}d||b.push(c)}return b},getVertexSize:function(a){for(var b=0,c=this.elements.length,d=0;d<c;d++){var e=this.elements[d];e.source===a&&(b+=e.getSize())}return b}}),OgreVertexBufferBinding=Class.$extend({__init__:function(){this.bindings={}},numBindings:function(){return Object.keys(this.bindings).length},setBinding:function(a,b){this.bindings[a]=b},getBinding:function(a){return this.bindings[a]}}),OgreVertexData=Class.$extend({__init__:function(){this.vertexStart=0,this.vertexCount=void 0,this.vertexDeclaration=new OgreVertexDeclaration,this.vertexBufferBinding=new OgreVertexBufferBinding},getElementItemCount:function(a,b){var c=this.vertexDeclaration.getElement(a,b);return null!=c?c.getItemCount():-1},getElementSize:function(a,b){var c=this.vertexDeclaration.getElement(a,b);return null!=c?c.getSize():-1},getUVType:function(a){var b=this.vertexDeclaration.getElement(OgreVertexElement.semantic.TEXTURE_COORDINATES,a);if(null!=b)return b.type},getUvSize:function(a){var b=this.vertexDeclaration.getElement(OgreVertexElement.semantic.TEXTURE_COORDINATES,a);if(null!=b)return b.getSize()},getVertexDataArrays:function(a,b){void 0===a&&(a=Number.MAX_VALUE),void 0===b&&(b=!1);for(var c={vertices:[],normals:[],uvs:[[]],hasUvLayer:function(a){return void 0!==this.uvs[a]&&this.uvs[a].length>0},getUvLayer:function(a){return this.uvs[a]},getUvCoord:function(a,b){if(void 0!==this.uvs[a])return this.uvs[a][b]},wrapUvRange:function(a){return a<0?(console.log("Correction",a,"->",1-Math.abs(a)%1),1-Math.abs(a)%1):a>1?(console.log("Correction",a,"->",a-1),a-1):a}},d=0;d<this.vertexBufferBinding.numBindings();++d){var e=this.vertexBufferBinding.getBinding(d),f=(this.vertexDeclaration.getVertexSize(d),this.vertexDeclaration.getElementsInOffsetOrder(d));b&&(console.log("Iterating vertex buffer at binding index",d),console.log(f));for(var g=new DataDeserializer(e.buffer,e.byteOffset,e.length),h=0;h<this.vertexCount;++h)for(var i=0;i<f.length;++i){var j=!1,k=f[i];switch(k.semantic){case OgreVertexElement.semantic.POSITION:j=this._readElement(g,k.type,c.vertices);break;case OgreVertexElement.semantic.NORMAL:j=this._readElement(g,k.type,c.normals);break;case OgreVertexElement.semantic.TEXTURE_COORDINATES:if(k.index>=a)break;void 0===c.uvs[k.index]&&(c.uvs[k.index]=[]),j=this._readElement(g,k.type,c.uvs[k.index])}j||g.skipBytes(k.getSize())}}return c},_readElement:function(a,b,c){if(b===OgreVertexElement.type.SHORT1||b===OgreVertexElement.type.USHORT1)c.push([a.readU16()]);else if(b===OgreVertexElement.type.SHORT2||b===OgreVertexElement.type.USHORT2)c.push([a.readU16(),a.readU16()]);else if(b===OgreVertexElement.type.SHORT3||b===OgreVertexElement.type.USHORT3)c.push([a.readU16(),a.readU16(),a.readU16()]);else if(b===OgreVertexElement.type.SHORT4||b===OgreVertexElement.type.USHORT4)c.push([a.readU16(),a.readU16(),a.readU16(),a.readU16()]);else if(b===OgreVertexElement.type.INT1||b===OgreVertexElement.type.UINT1)c.push([a.readU32()]);else if(b===OgreVertexElement.type.INT2||b===OgreVertexElement.type.UINT2)c.push([a.readU32(),a.readU32()]);else if(b===OgreVertexElement.type.INT3||b===OgreVertexElement.type.UINT3)c.push([a.readU32(),a.readU32(),a.readU32()]);else if(b===OgreVertexElement.type.INT4||b===OgreVertexElement.type.UINT4)c.push([a.readU32(),a.readU32(),a.readU32(),a.readU32()]);else if(b===OgreVertexElement.type.FLOAT1)c.push([a.readFloat32()]);else if(b===OgreVertexElement.type.FLOAT2)c.push([a.readFloat32(),a.readFloat32()]);else if(b===OgreVertexElement.type.FLOAT3)c.push([a.readFloat32(),a.readFloat32(),a.readFloat32()]);else if(b===OgreVertexElement.type.FLOAT4)c.push([a.readFloat32(),a.readFloat32(),a.readFloat32(),a.readFloat32()]);else if(b===OgreVertexElement.type.DOUBLE1)c.push([a.readFloat64()]);else if(b===OgreVertexElement.type.DOUBLE2)c.push([a.readFloat64(),a.readFloat64()]);else if(b===OgreVertexElement.type.DOUBLE3)c.push([a.readFloat64(),a.readFloat64(),a.readFloat64()]);else if(b===OgreVertexElement.type.DOUBLE4)c.push([a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64()]);else{if(b!==OgreVertexElement.type.UBYTE4)return Tundra.client.logWarning("[OgreVertexData]: Reading element data of type "+b+" not supported!",!0),!1;c.push([a.readU8(),a.readU8(),a.readU8(),a.readU8()])}return!0},getVertices:function(){var a=this.vertexDeclaration.getElement(OgreVertexElement.semantic.POSITION);return null!=a?this.getElementList(a):null},getNormals:function(){var a=this.vertexDeclaration.getElement(OgreVertexElement.semantic.NORMAL);return null!=a?this.getElementList(a):null},getElementList:function(a){for(var b=a.offset,c=this.vertexDeclaration.getVertexSize(0)-(b+a.getSize()),d=this.vertexDeclaration.vertexBuffer,e=new DataDeserializer(d.buffer,d.byteOffset,d.length),f=[];e.bytesLeft()>0;)a.type===OgreVertexElement.type.FLOAT3&&(e.skipBytes(b),f.push([e.readFloat32(),e.readFloat32(),e.readFloat32()]),e.skipBytes(c));return f}}),OgreMesh=Class.$extend({__init__:function(){this.submeshes=[],this.sharedVertexData=null,this.skeletonName="",this.boneAssignments={},this.AABB={min:{x:0,y:0,z:0},max:{x:0,y:0,z:0}},this.radius=0},numSubmeshes:function(){return this.submeshes.length},getSubmesh:function(a){return this.numSubmeshes()>a?this.submeshes[a]:null},addSubmesh:function(a){this.submeshes.push(a)},addBoneAssignment:function(a){void 0===this.boneAssignments[a.vertexIndex]&&(this.boneAssignments[a.vertexIndex]=[]),this.boneAssignments[a.vertexIndex].push(a)},getBoneAssignmentsForVertexIndex:function(a){return void 0===this.boneAssignments[a]&&(this.boneAssignments[a]=[]),this.boneAssignments[a]},numBoneAssignments:function(){return Object.keys(this.boneAssignments).length}}),OgreSkeleton=Class.$extend({__init__:function(a){this.name=a,this.bones={},this.bonesFlat=[],this.animations={},this.animationsFlat=[]},__classvars__:{MAX_NUM_BONES:256,BlendMode:{AVERAGE:0,CUMULATIVE:1}},getBone:function(a){if("number"==typeof a)return this.bones[a];if("string"==typeof a)for(var b in this.bones)if(this.bones[b].name===a)return this.bones[b];return null},addBone:function(a){this.bones[a.id]=a,this.bonesFlat.push(a)},parentBone:function(a,b){this.bones[a].parentId=b,this.bones[a].parent=this.getBone(b)},addAnimation:function(a){this.animations[a.name]=a,this.animationsFlat.push(a)}}),OgreAnimation=Class.$extend({__init__:function(a,b){this.name=a,this.length=b,this.tracks=[]},addTrack:function(a){this.tracks.push(a)}}),OgreThreeJsUtils={MAX_UV_SETS:2,WRITTEN_INDEXES:{},OLD_TO_NEW_INDEXES:{},logError:function(a){return Tundra.client.logError("[OgreThreeJsUtils]: "+a,!0),!1},logWarning:function(a){return Tundra.client.logWarning("[OgreThreeJsUtils]: "+a,!0),!1},convertOgreMesh:function(a,b,c){if(void 0!==c&&"boolean"==typeof c||(c=!1),!(a instanceof OgreMesh))return this.logError("convertOgreMesh() 'ogreMesh' parameter is not of type OgreMesh");if(!(b instanceof THREE.Object3D))return this.logError("convertOgreMesh() 'parentThreeJsObject' parameter is not of type THREE.Object3D");try{for(var d=null!==a.sharedVertexData?a.sharedVertexData.getVertexDataArrays(this.MAX_UV_SETS,c):null,e=a.numSubmeshes(),f=0;f<e;++f){var g=a.getSubmesh(f);if(!g)return this.logError("Failed to get submesh index "+f);if(g.operationType!==OgreDefines.RenderOperation.TRIANGLE_LIST)return this.logError("Submesh operation type is not TRIANGLE_LIST.");var h=new THREE.BufferGeometry;if(g.useSharedVertices){if(!this._convertGeometry(a,g,h,g.indexData,a.sharedVertexData,d))return!1}else{var i=g.vertexData.getVertexDataArrays(this.MAX_UV_SETS,c);if(!this._convertGeometry(a,g,h,g.indexData,g.vertexData,i))return!1}h.computeBoundingBox(),h.computeBoundingSphere(),void 0===h.attributes.normal&&h.computeVertexNormals();var j=null;j=void 0!==h.attributes.skinIndex&&void 0!==h.attributes.skinWeight?new THREE.SkinnedMesh(h,Tundra.renderer.materialWhite,!1):new THREE.Mesh(h,Tundra.renderer.materialWhite),j.name=b.name+"_submesh_"+g.index,j.tundraSubmeshIndex=g.index,b.add(j),delete g,delete h,delete j,g=void 0,h=void 0,j=void 0}return!0}catch(k){return void 0!==k.stack?console.error(k.stack):console.error(k),!1}},_convertGeometry:function(a,b,c,d,e,f){var g=new DataDeserializer(d.indexBuffer.buffer,d.indexBuffer.byteOffset,d.indexBuffer.length),h=d.is32bit,i=[],j=-1;for(this.OLD_TO_NEW_INDEXES={};g.bytesLeft()>0;){var k={a:h?g.readU32():g.readU16(),b:h?g.readU32():g.readU16(),c:h?g.readU32():g.readU16()},l={a:k.a,b:k.b,c:k.c},m=this.OLD_TO_NEW_INDEXES[k.a];void 0===m?(this.OLD_TO_NEW_INDEXES[k.a]=++j,k.a=j):k.a=m,m=this.OLD_TO_NEW_INDEXES[k.b],void 0===m?(this.OLD_TO_NEW_INDEXES[k.b]=++j,k.b=j):k.b=m,m=this.OLD_TO_NEW_INDEXES[k.c],void 0===m?(this.OLD_TO_NEW_INDEXES[k.c]=++j,k.c=j):k.c=m,i.push({assigned:k,read:l})}var n=Object.keys(this.OLD_TO_NEW_INDEXES).length,o=3*i.length,p=e.getElementItemCount(OgreVertexElement.semantic.POSITION),q=e.getElementItemCount(OgreVertexElement.semantic.NORMAL),r=e.getElementItemCount(OgreVertexElement.semantic.TEXTURE_COORDINATES,0),s=e.getElementItemCount(OgreVertexElement.semantic.TEXTURE_COORDINATES,1);r>2&&(r=2),s>2&&(s=2);var t=b.useSharedVertices?a:b,u=new DataSerializer(o,h===!0?DataSerializer.ArrayType.Uint32:DataSerializer.ArrayType.Uint16),v=f.vertices.length>0?new DataSerializer(n*p,DataSerializer.ArrayType.Float32):null,w=f.normals.length>0?new DataSerializer(n*q,DataSerializer.ArrayType.Float32):null,x=f.hasUvLayer(0)===!0?new DataSerializer(n*r,DataSerializer.ArrayType.Float32):null,y=f.hasUvLayer(1)===!0?new DataSerializer(n*s,DataSerializer.ArrayType.Float32):null,z=t.numBoneAssignments()>0?new DataSerializer(4*n,DataSerializer.ArrayType.Float32):null,A=t.numBoneAssignments()>0?new DataSerializer(4*n,DataSerializer.ArrayType.Float32):null;this.WRITTEN_INDEXES={};for(var B=0;B<i.length;++B)this._writeIndexToVertexBuffer(f,i[B],u,v,w,x,y);if(t.numBoneAssignments()>0)for(var C=0;C<n;++C){var D=this.OLD_TO_NEW_INDEXES[C],E=16*D,F=t.getBoneAssignmentsForVertexIndex(D);if(F.length>4)for(var G=0;G<F.length&&!(0==F[G].weight&&(F.splice(G,1),F.length<=4));G++);for(var H=0;H<4&&F.length>H;++H)z.data.setFloat32(E+4*H,F[H].boneIndex,!0),A.data.setFloat32(E+4*H,F[H].weight,!0);z.bytePos=E+16}return c.addGroup(0,o),null!=u&&(c.setIndex(new THREE.BufferAttribute(u.array,1)),c.index.is32bit=h),null!=v&&c.addAttribute("position",new THREE.BufferAttribute(v.array,3)),null!=w&&c.addAttribute("normal",new THREE.BufferAttribute(w.array,3)),null!=x&&c.addAttribute("uv",new THREE.BufferAttribute(x.array,r)),null!=y&&c.addAttribute("uv2",new THREE.BufferAttribute(y.array,s)),null!=A&&c.addAttribute("skinWeight",new THREE.BufferAttribute(A.array,4)),null!=z&&c.addAttribute("skinIndex",new THREE.BufferAttribute(z.array,4)),Tundra.renderer.renderer.info.memory.geometries++,this.WRITTEN_INDEXES={},this.OLD_TO_NEW_INDEXES={},delete i,i=void 0,!0},_writeIndexToVertexBuffer:function(a,b,c,d,e,f,g){var h=null,i=null,j=null,k=null;c.type===DataSerializer.ArrayType.Uint16?(c.writeU16(b.assigned.a),c.writeU16(b.assigned.b),c.writeU16(b.assigned.c)):(c.writeU32(b.assigned.a),c.writeU32(b.assigned.b),c.writeU32(b.assigned.c));for(var l=void 0!==b.read?b.read:b.assigned,m=0;m<3;++m)h=0===m?l.a:1===m?l.b:l.c,void 0===this.WRITTEN_INDEXES[h]&&(this.WRITTEN_INDEXES[h]=!0,null!=d&&(i=a.vertices[h],d.writeFloat32(i[0]),d.writeFloat32(i[1]),d.writeFloat32(i[2])),null!=e&&(j=a.normals[h],e.writeFloat32(j[0]),e.writeFloat32(j[1]),e.writeFloat32(j[2])),null!=f&&(k=a.getUvCoord(0,h),f.writeFloat32(k[0]),f.writeFloat32(k[1])),null!=g&&(k=a.getUvCoord(1,h),g.writeFloat32(k[0]),g.writeFloat32(k[1])))},convertOgreAnimation:function(a,b,c,d){if(void 0!==d&&"boolean"==typeof d||(d=!1),!(a instanceof OgreSkeleton))return this.logError("convertOgreAnimation() 'ogreSkeleton' parameter is not of type OgreSkeleton");if(void 0===a.name)return this.logError("convertOgreAnimation() 'ogreSkeleton' parameter needs to have a unique 'name' property!");if(!(b instanceof OgreAnimation))return this.logError("convertOgreAnimation() 'ogreAnimation' parameter is not of type OgreAnimation");if("object"!=typeof c)return this.logError("convertOgreAnimation() 'animation' parameter is not of type 'object'");c.name=b.name,c.duration=b.length,c.tracks=[];this.convertOgreBones(a);d&&console.log(c.name),d&&console.log("  >> Tracks: "+b.tracks.length);for(var e=/\(|\)/g,f=0;f<b.tracks.length;++f){var g=b.tracks[f],h=g.bone.name.replace(e,"_");d&&console.log("    >> "+h);var i=[],j=[],k=[];d&&console.log("      >> Keyframes: "+g.keyFrames.length);for(var l=0;l<g.keyFrames.length;l++){var m=g.keyFrames[l],n=m.toArray("position",!0);i.push(n[0],n[1],n[2]);var o=this.quaternionFromObject(m.quaternion);o.multiplyQuaternions(this.quaternionFromObject(m.bone.quaternion),o),j.push(o.x,o.y,o.z,o.w),k.push(m.time)}c.tracks.push(new THREE.VectorKeyframeTrack("undefined.bones["+h+"].position",k,i)),c.tracks.push(new THREE.QuaternionKeyframeTrack("undefined.bones["+h+"].quaternion",k,j))}return!0},convertOgreBones:function(a){for(var b=/\(|\)/g,c=[],d=0;d<a.bonesFlat.length;d++){var e=a.bonesFlat[d],f=e.name.replace(b,"_"),g=null!=e.parent?e.parent.name.replace(b,"_"):"",h=new THREE.Bone;h.sourceBoneId=e.id,h.name=f,h.parentName=g,this.copyObjectToVector3(h.position,e.position),this.copyObjectToQuaternion(h.quaternion,e.quaternion),h.originalPosition=h.position.clone(),h.originalQuaternion=h.quaternion.clone(),c.push(h)}return c},createThreeJsBoneHierarchy:function(a){for(var b=[],c=function(a,b){for(var d=null,e=0;e<b.length&&(b[e].name===a?d=b[e]:null!=b[e].children&&b[e].children.length>0&&(d=c(a,b[e].children)),null==d);e++);return d},d=function(b){for(var d=null,e=0;e<a.length&&(a[e].name===b?d=a[e]:null!=a[e].children&&a[e].children.length>0&&(d=c(b,a[e].children)),null==d);e++);return d},e=0;e<a.length;e++){var f=a[e],g=d(f.parentName);null!=f&&null!=g?g.add(f):b.push(f)}return b},copyObjectToVector3:function(a,b){a.set(b.x,b.y,b.z)},copyObjectToQuaternion:function(a,b){a.set(b.x,b.y,b.z,b.w)},quaternionFromObject:function(a){return new THREE.Quaternion(a.x,a.y,a.z,a.w)},loadOgreAnimations:function(a,b){for(var c={},d=0;d<a.animationsFlat.length;d++){var e={};if(!OgreThreeJsUtils.convertOgreAnimation(a,a.animationsFlat[d],e,b))return[];c[e.name]=new THREE.AnimationClip(e.name,e.duration,e.tracks)}return c}},OgreIndexData=Class.$extend({__init__:function(){this.indexStart=0,this.indexCount=0,this.is32bit=!1,this.indexBuffer=null},readIndexBuffer:function(a){this.indexBuffer=a.readUint8Array(this.indexCount*(this.is32bit?4:2))}}),OgreSubMesh=Class.$extend({__init__:function(){this.name="",this.index=void 0,this.materialName="",this.useSharedVertices=!1,this.indexData=new OgreIndexData,this.vertexData=null,this.operationType=void 0,this.boneAssignments={}},addBoneAssignment:function(a){void 0===this.boneAssignments[a.vertexIndex]&&(this.boneAssignments[a.vertexIndex]=[]),this.boneAssignments[a.vertexIndex].push(a)},getBoneAssignmentsForVertexIndex:function(a){return void 0===this.boneAssignments[a]&&(this.boneAssignments[a]=[]),this.boneAssignments[a]},numBoneAssignments:function(){return Object.keys(this.boneAssignments).length}}),OgreVertexBoneAssignment=Class.$extend({__init__:function(a,b,c){this.vertexIndex=a,this.boneIndex=b,this.weight=c}}),OgreMeshSerializer=Class.$extend({__init__:function(a){void 0===a&&(a={}),this.logging=void 0!==a.logging&&a.logging,this.reset()},__classvars__:{supportedVersions:["[MeshSerializer_v1.8]","[MeshSerializer_v1.41]","[MeshSerializer_v1.40]"],isSupportedVersion:function(a){for(var b=0;b<OgreMeshSerializer.supportedVersions.length;b++)if(OgreMeshSerializer.supportedVersions[b]===a)return!0;return!1},chunk:{HEADER:4096,HEADER_ENDIAN_FLIP:16,MESH:12288,SUBMESH:16384,SUBMESH_OPERATION:16400,SUBMESH_BONE_ASSIGNMENT:16640,SUBMESH_TEXTURE_ALIAS:16896,GEOMETRY:20480,GEOMETRY_VERTEX_DECLARATION:20736,GEOMETRY_VERTEX_ELEMENT:20752,GEOMETRY_VERTEX_BUFFER:20992,GEOMETRY_VERTEX_BUFFER_DATA:21008,MESH_SKELETON_LINK:24576,MESH_BONE_ASSIGNMENT:28672,MESH_LOD:32768,MESH_LOD_USAGE:33024,MESH_LOD_MANUAL:33040,MESH_LOD_GENERATED:33056,MESH_BOUNDS:36864,SUBMESH_NAME_TABLE:40960,SUBMESH_NAME_TABLE_ELEMENT:41216,EDGE_LISTS:45056,EDGE_LIST_LOD:45312,EDGE_GROUP:45328},chunkIdToString:function(a){switch(a){case this.chunk.HEADER:return"HEADER";case this.chunk.HEADER_ENDIAN_FLIP:return"HEADER_ENDIAN_FLIP";case this.chunk.MESH:return"MESH";case this.chunk.SUBMESH:return"SUBMESH";case this.chunk.SUBMESH_OPERATION:return"SUBMESH_OPERATION";case this.chunk.SUBMESH_BONE_ASSIGNMENT:return"SUBMESH_BONE_ASSIGNMENT";case this.chunk.SUBMESH_TEXTURE_ALIAS:return"SUBMESH_TEXTURE_ALIAS";case this.chunk.GEOMETRY:return"GEOMETRY";case this.chunk.GEOMETRY_VERTEX_DECLARATION:return"GEOMETRY_VERTEX_DECLARATION";case this.chunk.GEOMETRY_VERTEX_ELEMENT:return"GEOMETRY_VERTEX_ELEMENT";case this.chunk.GEOMETRY_VERTEX_BUFFER:return"GEOMETRY_VERTEX_BUFFER";case this.chunk.GEOMETRY_VERTEX_BUFFER_DATA:return"GEOMETRY_VERTEX_BUFFER_DATA";case this.chunk.MESH_SKELETON_LINK:return"MESH_SKELETON_LINK";case this.chunk.MESH_BONE_ASSIGNMENT:return"MESH_BONE_ASSIGNMENT";case this.chunk.MESH_LOD:return"MESH_MESH_LOD";case this.chunk.MESH_LOD_USAGE:return"MESH_LOD_USAGE";case this.chunk.MESH_LOD_MANUAL:return"MESH_LOD_MANUAL";case this.chunk.MESH_LOD_GENERATED:return"MESH_LOD_GENERATED";case this.chunk.MESH_BOUNDS:return"MESH_BOUNDS";case this.chunk.SUBMESH_NAME_TABLE:return"SUBMESH_NAME_TABLE";case this.chunk.SUBMESH_NAME_TABLE_ELEMENT:return"SUBMESH_NAME_TABLE_ELEMENT";case this.chunk.EDGE_LISTS:return"EDGE_LISTS";case this.chunk.EDGE_LIST_LOD:return"EDGE_LIST_LOD";case this.chunk.EDGE_GROUP:return"EDGE_GROUP"}return"Unknown_Chunk_ID_"+a}},reset:function(){this.ds=null,this.version="",this.ogreMesh=null,this.chunk={id:void 0,len:void 0,lenLeft:void 0,size:6},this.logging&&(this.time=new Date)},logError:function(a){return Tundra.client.logError("[OgreMeshSerializer]: "+a,!0),!1},logWarning:function(a){},logChunk:function(){console.log(OgreMeshSerializer.chunkIdToString(this.chunk.id)+" len = "+this.chunk.lenLeft+" bytesLeft = "+this.ds.bytesLeft())},importMesh:function(a,b){if(!(b instanceof OgreMesh))return this.logError("importMesh(): 'ogreMesh' parameter is no of type OgreMesh");try{return this.ds=new DataDeserializer(a),!!this.readHeader()&&(this.ogreMesh=b,!!this.readMesh()&&(this.logging&&console.log("  >> Mesh imported in "+(new Date-this.time)+" msec"),!0))}catch(c){return void 0!==c.stack?console.error(c.stack):console.error(c),!1}},readChunk:function(){return this.ds.bytesLeft()<this.chunk.size?this.logError("readChunk(): Not enough data to read next chunks metadata"):(this.chunk.id=this.ds.readU16(),this.chunk.len=this.ds.readU32(),this.chunk.lenLeft=this.chunk.len-this.chunk.size,this.logging&&this.chunk.id!==OgreMeshSerializer.chunk.SUBMESH_BONE_ASSIGNMENT&&this.logChunk(),!0)},rewindChunk:function(){this.logging&&console.log("    -- Rewinding chunk"),this.ds.skipBytes(-this.chunk.size)},readHeader:function(){return this.ds.readU16()!==OgreMeshSerializer.chunk.HEADER?this.logError("readHeader(): First data chunk is not HEADER"):(this.version=this.ds.readStringUntil("\0",10),!!OgreMeshSerializer.isSupportedVersion(this.version)||this.logError("Unsupported mesh version "+this.version))},readMesh:function(){if(!this.readChunk())return!1;if(this.chunk.id!==OgreMeshSerializer.chunk.MESH)return this.logError("readMesh(): MESH chunk cound not be found, instead found "+OgreMeshSerializer.chunkIdToString(this.chunk.id));var a=this.ds.readBoolean();for(this.logging&&console.log("    -- Skeletal animated:",a);this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;switch(this.chunk.id){case OgreMeshSerializer.chunk.GEOMETRY:if(this.ogreMesh.sharedVertexData=new OgreVertexData,!this.readGeometry(this.ogreMesh.sharedVertexData))return!1;break;case OgreMeshSerializer.chunk.SUBMESH:if(!this.readSubmesh())return!1;break;case OgreMeshSerializer.chunk.MESH_BOUNDS:if(!this.readBoundsInfo())return!1;break;case OgreMeshSerializer.chunk.SUBMESH_NAME_TABLE:if(!this.readSubMeshNameTable())return!1;break;case OgreMeshSerializer.chunk.MESH_SKELETON_LINK:if(!this.readSkeletonLink())return!1;break;case OgreMeshSerializer.chunk.MESH_BONE_ASSIGNMENT:if(!this.readBoneAssignment(this.ogreMesh))return!1;break;default:this.ds.skipBytes(this.chunk.lenLeft)}}return!0},readGeometry:function(a){for(a.vertexCount=this.ds.readU32(),this.logging&&console.log("    -- Vertex count:",a.vertexCount);this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id===OgreMeshSerializer.chunk.GEOMETRY_VERTEX_DECLARATION){if(!this.readGeometryVertexDeclaration(a))return!1}else{if(this.chunk.id!==OgreMeshSerializer.chunk.GEOMETRY_VERTEX_BUFFER){this.rewindChunk();break}if(!this.readGeometryVertexBuffer(a))return!1}}return!0},readGeometryVertexDeclaration:function(a){for(;this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id!==OgreMeshSerializer.chunk.GEOMETRY_VERTEX_ELEMENT){this.rewindChunk();break}if(!this.readGeometryVertexElement(a))return!1}return!0},readGeometryVertexElement:function(a){var b=new OgreVertexElement(this.ds.readU16(),this.ds.readU16(),this.ds.readU16(),this.ds.readU16(),this.ds.readU16());return a.vertexDeclaration.addElement(b),this.logging&&console.log("    --",b),!0},readGeometryVertexBuffer:function(a){var b={bindIndex:this.ds.readU16(),vertexSize:this.ds.readU16()};return this.logging&&console.log("    --",b),!!this.readChunk()&&(this.chunk.id!==OgreMeshSerializer.chunk.GEOMETRY_VERTEX_BUFFER_DATA?this.logError("Failed to find vertex buffer data area GEOMETRY_VERTEX_BUFFER_DATA"):a.vertexDeclaration.getVertexSize(b.bindIndex)!==b.vertexSize?this.logError("Buffer vertex size does not agree with vertex declaration: Vertex declaration "+a.vertexDeclaration.getVertexSize(b.bindIndex)+" Vertex buffer metadata "+b.vertexSize):(a.vertexBufferBinding.setBinding(b.bindIndex,this.ds.readUint8Array(a.vertexCount*b.vertexSize)),!0))},readSubmesh:function(){var a=new OgreSubMesh;if(a.index=this.ogreMesh.numSubmeshes(),a.materialName=this.ds.readStringUntil("\0",10),a.useSharedVertices=this.ds.readBoolean(),a.indexData.indexCount=this.ds.readU32(),a.indexData.is32bit=this.ds.readBoolean(),a.indexData.indexCount>0&&a.indexData.readIndexBuffer(this.ds),!a.useSharedVertices){if(!this.readChunk())return!1;if(this.chunk.id!==OgreMeshSerializer.chunk.GEOMETRY)return this.logError("Missing geometry chunk for OgreSubmesh");if(a.vertexData=new OgreVertexData,!this.readGeometry(a.vertexData))return!1}for(;this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id===OgreMeshSerializer.chunk.SUBMESH_OPERATION)a.operationType=this.ds.readU16();else if(this.chunk.id===OgreMeshSerializer.chunk.SUBMESH_BONE_ASSIGNMENT){if(!this.readBoneAssignment(a))return!1}else{if(this.chunk.id!==OgreMeshSerializer.chunk.SUBMESH_TEXTURE_ALIAS){this.rewindChunk();break}this.ds.skipBytes(this.chunk.lenLeft)}}return this.ogreMesh.addSubmesh(a),!0},readBoundsInfo:function(){return this.ogreMesh.AABB.min.x=this.ds.readFloat32(),this.ogreMesh.AABB.min.y=this.ds.readFloat32(),this.ogreMesh.AABB.min.z=this.ds.readFloat32(),this.ogreMesh.AABB.max.x=this.ds.readFloat32(),this.ogreMesh.AABB.max.y=this.ds.readFloat32(),this.ogreMesh.AABB.max.z=this.ds.readFloat32(),this.ogreMesh.radius=this.ds.readFloat32(),!0},readSubMeshNameTable:function(){for(;this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id!==OgreMeshSerializer.chunk.SUBMESH_NAME_TABLE_ELEMENT){this.rewindChunk();break}var a=this.ds.readU16(),b=this.ds.readStringUntil("\0",10),c=this.ogreMesh.getSubmesh(a);null!=c?c.name=b:this.logWarning("Submesh name table had submesh index "+a+" that does not exist")}return!0},readSkeletonLink:function(){var a=this.ds.bytesLeft();return this.ogreMesh.skeletonName=this.ds.readStringUntil("\0",10),this.logging&&console.log("    -- Skeleton name:",this.ogreMesh.skeletonName,"read",a-this.ds.bytesLeft()),!0},readBoneAssignment:function(a){return a.addBoneAssignment(new OgreVertexBoneAssignment(this.ds.readU32(),this.ds.readU16(),this.ds.readFloat32())),!0}}),OgreMeshAsset=IAsset.$extend({__init__:function(a){this.$super(a,"OgreMeshAsset"),this.requiresCloning=!0,this.mesh=Tundra.renderer.createSceneNode(),this.mesh.name=this.name},isLoaded:function(){return void 0!==this.mesh&&this.mesh.children.length>0},resetMaterials:function(){for(var a=0,b=this.numSubmeshes();a<b;a++){var c=this.getSubmesh(a);null!=c&&(c.material=Tundra.renderer.materialWhite,c.material.needsUpdate=!0)}},unload:function(){if(!this.requiresCloning||!this.isCloneSource){var a=this.numSubmeshes();this.logging&&null!=this.mesh&&a>0&&console.log("OgreMeshAsset unload",this.name);for(var b=0;b<a;++b){var c=this.getSubmesh(b);null!=c&&null!=c.material&&(c.material=Tundra.renderer.materialWhite)}return void(this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh));var b,c}},isGeometryInUse:function(a){if(void 0===a.uuid)return!1;var b=!1;return Tundra.renderer.scene.traverse(function(c){b!==!0&&null!=c&&void 0!==c.geometry&&(c.geometry instanceof THREE.BufferGeometry||c.geometry instanceof THREE.Geometry)&&c.geometry.uuid===a.uuid&&(b=!0)}),b},getSceneNode:function(){return this.isLoaded()?this.mesh:null},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:null},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},canAttachSkeleton:function(){if(0===this.numSubmeshes())return!1;for(var a=0,b=this.numSubmeshes();a<b;++a)if(!(this.getSubmesh(a)instanceof THREE.SkinnedMesh))return!1;return!0},_cloneImpl:function(a){for(var b=new OgreMeshAsset(a),c=0,d=this.numSubmeshes();c<d;++c){var e=this.getSubmesh(c);if(e instanceof THREE.Mesh||e instanceof THREE.SkinnedMesh){var f=null;f=e instanceof THREE.SkinnedMesh?new THREE.SkinnedMesh(e.geometry,Tundra.renderer.materialWhite,!1):new THREE.Mesh(e.geometry,Tundra.renderer.materialWhite),f.name=b.name+"_submesh_"+c,f.tundraSubmeshIndex=e.tundraSubmeshIndex,b.mesh.add(f)}}return b},cloneFrom:function(a){if(!(a instanceof OgreMeshAsset))return void consoloe.log("ERROR: OgreMeshAsset.clone can only clone from another OgreMeshAsset instance.");this.unload(),this.type=a.type,this.requiresCloning=a.requiresCloning,this.mesh=Tundra.renderer.createSceneNode(),this.mesh.name=a.name;for(var b=a.numSubmeshes(),c=0;c<b;++c){var d=a.getSubmesh(c);if(d instanceof THREE.Mesh||d instanceof THREE.SkinnedMesh){var e=null;e=d instanceof THREE.SkinnedMesh?new THREE.SkinnedMesh(this.cloneGeometry(d.geometry),Tundra.renderer.materialWhite,!1):new THREE.Mesh(this.cloneGeometry(d.geometry),Tundra.renderer.materialWhite),
e.name=this.mesh.name+"_submesh_"+c,e.tundraSubmeshIndex=d.tundraSubmeshIndex,this.mesh.add(e)}}},cloneGeometry:function(a){if(!(a instanceof THREE.Geometry||a instanceof THREE.BufferGeometry))return Tundra.client.logError("[OgreMeshAsset]: cloneGeometry() called with incorrect 'src', must be THREE.Geometry|THREE.BufferGeometry."),null;var b=a.clone();if(a instanceof THREE.Geometry){var c=0;if(a.faceVertexUvs.length>1){b.faceVertexUvs[1]=[];var d=a.faceVertexUvs[1],e=[],f=[];for(c=0,il=d.length;c<il;c++){e=d[c],f=[];for(var g=0,h=e.length;g<h;g++)f.push(new THREE.Vector2(e[g].x,e[g].y));b.faceVertexUvs[1].push(f)}}if(a.skinWeights.length>0)for(c=0;c<a.skinWeights.length;c++)b.skinWeights.push(a.skinWeights[c].clone());if(a.skinIndices.length>0)for(c=0;c<a.skinIndices.length;c++)b.skinIndices.push(a.skinIndices[c].clone())}return b},deserializeFromData:function(a,b,c){var d=!1;return d="arraybuffer"===b?this.deserializeFromBinary(a):this.deserializeFromXML(a)},deserializeFromBinary:function(a){var b=new OgreMesh,c=new OgreMeshSerializer({logging:this.logging}),d=c.importMesh(a,b);return c.reset(),delete c,c=void 0,d===!0&&(d=OgreThreeJsUtils.convertOgreMesh(b,this.mesh,this.logging)),delete b,b=void 0,d},deserializeFromXML:function(a){this.logging&&console.log(this.name);var b=this,c=this.logging?Date.now():null,d=this.logging?Date.now():null,e={positions:!1,normals:!1,textureCoords:!1,textureCoordCount:0,textureCoordsTypes:[],vextexCount:0},f=$(a),g=f.find("sharedgeometry");if(null==g||g.length<=0){if(g=f.find("geometry"),null==g||g.length<=0)return Tundra.client.logError("[OgreMeshAsset]: Failed to find <sharedgeometry> or <geometry> from mesh data",!0),!1;g.length>1&&null!=console.warn&&console.warn("OgreMeshAsset: Support incomplete for non sharedgeometry multi-submesh meshes. Only first submesh will be parsed correctly!")}e.vertexCount=parseInt(g.attr("vertexcount")),(null==e.vertexCount||isNaN(e.vertexCount))&&(e.vertexCount=0),this.logging&&console.log("  >> XML reported vertex count: "+(e.vertexCount>0?e.vertexCount:"undefined"));var h=new Array(e.vertexCount),i=new Array(e.vertexCount),j=[[]],k=0,l=0,m=g.find("vertexbuffer");m.each(function(){var a={positions:!1,normals:!1,textureCoords:!1},b=$(this),c=b.attr("texture_coords");if(a.positions="true"===b.attr("positions"),a.normals="true"===b.attr("normals"),a.textureCoords=null!=c&&"undefined"!=typeof c&&c!==!1,a.positions&&!e.positions&&(e.positions=!0),a.normals&&!e.normals&&(e.normals=!0),a.textureCoords)if(e.textureCoords)e.textureCoordCount!=parseInt(c)&&null!=console.warn&&console.warn("Found different amount of texture coords in multiple vertex buffers!");else for(e.textureCoords=!0,e.textureCoordCount=parseInt(c),isNaN(e.textureCoordCount)&&(e.textureCoordCount=0),l=0;l<e.textureCoordCount;++l)e.textureCoordsTypes.push(b.attr("texture_coord_dimensions_"+l)),j[l]=[];k=0;var d=b.find("vertex");d.each(function(){var b=$(this);if(a.positions){var c=b.find("position");h[k]=new THREE.Vector3(parseFloat(c.attr("x")),parseFloat(c.attr("y")),parseFloat(c.attr("z")))}if(a.normals){var c=b.find("normal");i[k]=new THREE.Vector3(parseFloat(c.attr("x")),parseFloat(c.attr("y")),parseFloat(c.attr("z")))}if(a.textureCoords){var d=0,e=b.find("texcoord");e.each(function(){var a=$(this);j[d][k]=new THREE.Vector2(parseFloat(a.attr("u")),parseFloat(a.attr("v"))),d++})}k++}),a=null,b=null,c=null,d=null}),this.logging&&(console.log("    >> Vertex buffers read"),console.log("    >> Normals: "+i.length+" Vertices: "+h.length+" UVs: "+e.textureCoordCount),console.log("    >> "+(Date.now()-c)+" msec"),c=Date.now());var n=f.find("submeshes");return n.find("submesh").each(function(){var a=$(this),f=new THREE.Geometry;for(s=0;s<e.textureCoordCount;++s)f.faceVertexUvs[s]=[];var g=[],l=a.find("boneassignments");if(null!=l||l.length>0){var m=l.find("vertexboneassignment");m.each(function(){g.push({vertexIndex:parseInt($(this).attr("vertexindex")),boneIndex:parseInt($(this).attr("boneindex")),weight:parseFloat($(this).attr("weight"))})}),m=null}l=null;var n=a.find("faces");b.logging&&(console.log("  >> SUBMESH"),console.log("    >> Face count: "+parseInt(n.attr("count"))),console.log("    >> "+(Date.now()-c)+" msec"),c=Date.now());var o={};if(k=-1,n.each(function(){var a=$(this).find("face");a.each(function(){var a=$(this),g=new THREE.Face3(parseInt(a.attr("v1")),parseInt(a.attr("v2")),parseInt(a.attr("v3"))),l=f.faces.length;if(e.normals){var m=i[g.a],n=i[g.b],p=i[g.c];g.vertexNormals.push(m),g.vertexNormals.push(n),g.vertexNormals.push(p),g.normal.x=(m.x+n.x+p.x)/3,g.normal.y=(m.y+n.y+p.y)/3,g.normal.z=(m.z+n.z+p.z)/3}if(e.textureCoordCount>0)for(var q=0;q<e.textureCoordCount;++q)f.faceVertexUvs[q][l]=[j[q][g.a],j[q][g.b],j[q][g.c]];if(e.positions){var r=o[g.a];null==r?(f.vertices[++k]=h[g.a],o[g.a]=k,g.a=k):g.a=r,r=o[g.b],null==r?(f.vertices[++k]=h[g.b],o[g.b]=k,g.b=k):g.b=r,r=o[g.c],null==r?(f.vertices[++k]=h[g.c],o[g.c]=k,g.c=k):g.c=r}if(f.faces[l]=g,b.logging&&l>0&&l%1e4===0){var s=Date.now();console.log("    >> Vertexes processed: "+l+" in "+(s-c)+" msec     - total "+(s-d)+" msec"),c=Date.now()}}),a=null}),n=null,b.logging&&console.log("    >> Vertex count: "+f.vertices.length),g.length>0){for(b.logging&&console.log("    >> Total bone assignments: "+g.length),f.skinWeights=new Array(f.vertices.length),f.skinIndices=new Array(f.vertices.length),s=0;s<f.vertices.length;++s)f.skinWeights[s]=null,f.skinIndices[s]=null;var p=0;for(s=0;s<g.length;++s){var q=g[s],r=o[q.vertexIndex];null!=r?(p++,null==f.skinWeights[r]?(f.skinWeights[r]=new THREE.Vector4(q.weight,0,0,0),f.skinWeights[r].y=null):null==f.skinWeights[r].y&&(f.skinWeights[r].y=q.weight),null==f.skinIndices[r]?(f.skinIndices[r]=new THREE.Vector4(q.boneIndex,0,0,0),f.skinIndices[r].y=null):null==f.skinIndices[r].y&&(f.skinIndices[r].y=q.boneIndex)):(f.skinWeights[r]=null,f.skinIndices[r]=null)}b.logging&&console.log("    >> Bone assignments assigned: "+p);for(var s=0;s<f.vertices.length;++s)null==f.skinWeights[s]?f.skinWeights[s]=new THREE.Vector4(0,0,0,0):null==f.skinWeights[s].y&&(f.skinWeights[s].y=0),null==f.skinIndices[s]?f.skinIndices[s]=new THREE.Vector4(0,0,0,0):null==f.skinIndices[s].y&&(f.skinIndices[s].y=0)}f.uvsNeedUpdate=!0,f.verticesNeedUpdate=!0,f.elementsNeedUpdate=!0;var t=null;t=0==g.length?new THREE.Mesh(f,Tundra.renderer.materialWhite):new THREE.SkinnedMesh(f,Tundra.renderer.materialWhite,!1),t.name=b.mesh.name+"_submesh_"+b.numSubmeshes(),t.tundraSubmeshIndex=b.numSubmeshes(),b.mesh.add(t),f=null,t=null,a=null,g=null,o=null,n=null}),h=null,i=null,j=null,e=null,f=null,g=null,m=null,n=null,k=null,this.logging&&(console.log("OgreMeshAssset loaded with",this.numSubmeshes(),"submeshes"),console.log("")),!0}});window=this,"undefined"==typeof console&&(console={log:function(){},error:function(){}});var WebGLTextureUtil=function(){"use strict";function a(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function b(a){return String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)}function c(a,b,c){switch(a){case i:case l:case N:return(b+3>>2)*(c+3>>2)*8;case j:case k:case m:case n:return(b+3>>2)*(c+3>>2)*16;case J:case L:return Math.floor((Math.max(b,8)*Math.max(c,8)*4+7)/8);case K:case M:return Math.floor((Math.max(b,16)*Math.max(c,8)*2+7)/8);default:return 0}}function d(a,b,c,d){console.error(b),a.bindTexture(a.TEXTURE_2D,c),a.texImage2D(a.TEXTURE_2D,0,a.RGB,1,1,0,a.RGB,a.UNSIGNED_BYTE,new Uint8Array([0,0,0])),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),d&&d(c,b,null)}function e(a){return 0===(a&a-1)}function f(a,b){var c=["","WEBKIT_"];"WEBGL_compressed_texture_pvrtc"!==b&&"WEBGL_compressed_texture_atc"!==b&&c.push("MOZ_");var d=null;for(var e in c)if(d=a.getExtension(c[e]+b))break;return d}function g(a,c,d){if(c&&d){var e=new Int32Array(a,0,r);if(e[s]!=o)return d("Invalid magic number in DDS header"),0;if(!e[y]&q)return d("Unsupported format, must contain a FourCC code"),0;var f,g=e[z];switch(g){case A:f=i;break;case B:f=j;break;case C:f=k;break;case D:f=N;break;case E:f=l;break;case F:f=m;break;case G:f=n;break;default:return void d("Unsupported FourCC code: "+b(g))}var h=1;e[u]&p&&(h=Math.max(1,e[x]));var H=e[w],I=e[v],J=e[t]+4,K=new Uint8Array(a,J);c(K,H,I,h,f)}}function h(a,b,c){if(b&&c){var d=new Int32Array(a,0,W);if(d[Y]!=X)return c("Invalid magic number in PVR header"),0;var e,f=d[Z];switch(f){case O:e=K;break;case P:e=M;break;case Q:e=J;break;case R:e=L;break;case S:e=N;break;case T:e=i;break;case U:e=j;break;case V:e=k;break;default:return void c("Unsupported PVR format: "+f)}var g=d[_],h=d[$],l=d[aa],m=d[ba]+52,n=new Uint8Array(a,m);b(n,g,h,l,e)}}var i=33776,j=33778,k=33779,l=35986,m=35987,n=34798,o=542327876,p=131072,q=4,r=31,s=0,t=1,u=2,v=3,w=4,x=7,y=20,z=21,A=a("DXT1"),B=a("DXT3"),C=a("DXT5"),D=a("ETC1"),E=a("ATC "),F=a("ATCA"),G=a("ATCI"),H={cCRNFmtInvalid:-1,cCRNFmtDXT1:0,cCRNFmtDXT3:1,cCRNFmtDXT5:2},I={};I[H.cCRNFmtDXT1]=i,I[H.cCRNFmtDXT3]=j,I[H.cCRNFmtDXT5]=k;var J=35840,K=35841,L=35842,M=35843,N=36196,O=0,P=1,Q=2,R=3,S=6,T=7,U=9,V=5,W=13,X=55727696,Y=0,Z=2,$=6,_=7,aa=11,ba=12,ca=function(){function a(a,b,c,d){var e,f=c/4,g=d%4,h=new Uint32Array(a.buffer,0,(d-g)/4),i=new Uint32Array(b.buffer);for(e=0;e<h.length;e++)i[f+e]=h[e];for(e=d-g;e<d;e++)b[c+e]=a[e]}var b=null,d=null,e=0,f=null;return function(g,h,i){if(h&&i){f||(f=LoadCrunchDecoder());var j=g.byteLength,k=new Uint8Array(g),l=f._malloc(j);a(k,f.HEAPU8,l,j);var m=f._crn_get_dxt_format(l,j);if(!I[m])return void i("Unsupported DXT format");var n,o=f._crn_get_levels(l,j),p=f._crn_get_width(l,j),q=f._crn_get_height(l,j),r=0;for(n=0;n<o;++n)r+=c(I[m],p>>n,q>>n);e<r&&(b&&f._free(b),b=f._malloc(r),d=new Uint8Array(f.HEAPU8.buffer,b,r),e=r),f._crn_decompress(l,j,b,r,0,o),f._free(l),h(d,p,q,o,I[m])}}}(),da=function(){function a(a){var b;h.length?(b=h.shift(),a.loadTexture(b.gl,b.src,b.texture,b.callback)):c[f++]=a}var b=16,c=new Array(b),f=0,g=b,h=[],i=function(a){var b=this;new Uint8Array([0,0,0]);this.gl=null,this.texture=null,this.callback=null,this.image=new Image,this.image.addEventListener("load",function(){var c=b.gl;c.bindTexture(c.TEXTURE_2D,b.texture);var d=Date.now();c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,b.image),e(b.image.width)&&e(b.image.height)?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST),c.generateMipmap(c.TEXTURE_2D)):(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR));var f=Date.now()-d;if(b.callback){var g={width:b.image.width,height:b.image.height,internalFormat:c.RGBA,levelZeroSize:b.image.width*b.image.height*4,uploadTime:f};b.callback(b.texture,null,g)}a(b)},!1),this.image.addEventListener("error",function(c){d(b.gl,"Image could not be loaded",b.texture,b.callback),a(b)},!1)};i.prototype.loadTexture=function(a,b,c,d){this.gl=a,this.texture=c,this.callback=d,this.image.src=b};var j=function(a,b,c,d){this.gl=a,this.src=b,this.texture=c,this.callback=d};return function(b,d,e,k){var l;return f?(l=c[--f],l.loadTexture(b,d,e,k)):g?(l=new i(a),l.loadTexture(b,d,e,k),--g):h.push(new j(b,d,e,k)),e}}();if(void 0!==window.document){var ea=0,fa=function(a,b){this.id=ea++,this.texture=a,this.callback=b},ga=!1,ha=function(a){if(this.gl=a,this.worker=null,this.dxtExt=f(a,"WEBGL_compressed_texture_s3tc"),this.pvrtcExt=f(a,"WEBGL_compressed_texture_pvrtc"),this.atcExt=f(a,"WEBGL_compressed_texture_atc"),this.etc1Ext=f(a,"WEBGL_compressed_texture_etc1"),ga&&this.supportsDXT()){var b=this;this.pendingTextures={},this.worker=new Worker("js/webgl-texture-util.js"),this.worker.onmessage=function(a){var c=a.data.id,e=b.pendingTextures[c];if(e)return delete b.pendingTextures[c],a.data.error?void d(b.gl,a.data.error,e.texture,e.callback):b._formatSupported(a.data.internalFormat)?void b._uploadCompressedData(new Uint8Array(a.data.dxtData),a.data.width,a.data.height,a.data.levels,a.data.internalFormat,e.texture,e.callback):void d(b.gl,"Texture format not supported",e.texture,e.callback)}}};return ha.prototype._formatSupported=function(a){switch(a){case i:case j:case k:return!!this.dxtExt;case J:case L:case K:case M:return!!this.pvrtcExt;case l:case m:case n:return!!this.atcExt;case N:return!!this.etc1Ext;default:return!1}},ha.prototype._uploadCompressedData=function(a,b,d,e,f,g,h){var i=this.gl;i.bindTexture(i.TEXTURE_2D,g);for(var j=0,k={width:b,height:d,internalFormat:f,levelZeroSize:c(f,b,d),uploadTime:0},l=Date.now(),m=0;m<e;++m){var n=c(f,b,d),o=new Uint8Array(a.buffer,a.byteOffset+j,n);i.compressedTexImage2D(i.TEXTURE_2D,m,f,b,d,0,o),b>>=1,d>>=1,j+=n}k.uploadTime=Date.now()-l,e>1?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_NEAREST)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR)),h&&h(g,null,k)},ha.prototype.supportsDXT=function(){return!!this.dxtExt},ha.prototype.supportsPVRTC=function(){return!!this.pvrtcExt},ha.prototype.supportsATC=function(){return!!this.atcExt},ha.prototype.supportsETC1=function(){return!!this.etc1Ext},ha.prototype.loadIMG=function(a,b,c){return b||(b=this.gl.createTexture()),da(gl,a,b,c),b},ha.prototype.loadDDS=function(a,b,c){var e=this;b||(b=this.gl.createTexture());var f=new XMLHttpRequest;return f.addEventListener("load",function(a){200==f.status?g(f.response,function(a,f,g,h,i){return e._formatSupported(i)?void e._uploadCompressedData(a,f,g,h,i,b,c):void d(e.gl,"Texture format not supported",b,c)},function(a){d(e.gl,a,b,c)}):d(e.gl,f.statusText,b,c)},!1),f.open("GET",a,!0),f.responseType="arraybuffer",f.send(null),b},ha.prototype.parseDDS=g,ha.prototype.isPowerOfTwo=e,ha.prototype.loadCRN=function(a,b,c){var e=this;if(b||(b=this.gl.createTexture()),!this.supportsDXT())return d(this.gl,"Texture format not supported",b,c),b;if(this.worker){var f=new fa(b,c);this.pendingTextures[f.id]=f,this.worker.postMessage({id:f.id,src:a})}else{var g=new XMLHttpRequest;g.addEventListener("load",function(a){200==g.status?ca(g.response,function(a,f,g,h,i){return e._formatSupported(i)?void e._uploadCompressedData(a,f,g,h,i,b,c):void d(e.gl,"Texture format not supported",b,c)},function(a){d(e.gl,a,b,c)}):d(e.gl,g.statusText,b,c)},!1),g.open("GET",a,!0),g.responseType="arraybuffer",g.send(null)}return b},ha.prototype.decompressCRN=ca,ha.prototype.loadPVR=function(a,b,c){var e=this;b||(b=this.gl.createTexture());var f=new XMLHttpRequest;return f.addEventListener("load",function(a){200==f.status?h(f.response,function(a,f,g,h,i){return e._formatSupported(i)?void e._uploadCompressedData(a,f,g,h,i,b,c):void d(e.gl,"Texture format not supported",b,c)},function(a){d(e.gl,a,b,c)}):d(e.gl,f.statusText,b,c)},!1),f.open("GET",a,!0),f.responseType="arraybuffer",f.send(null),b},ha.prototype.loadTexture=function(a,b,c){var d=/(?:\.([^.]+))?$/,e=d.exec(a)[1]||"";switch(e=e.toLowerCase()){case"crn":return this.loadCRN(a,b,c);case"dds":return this.loadDDS(a,b,c);case"pvr":return this.loadPVR(a,b,c);default:return this.loadIMG(a,b,c)}},ha.prototype.makeSolidColor=function(a,b,c,d,e){var f=this.gl,g=new Uint8Array([a,b,c,d]);return e||(e=f.createTexture()),f.bindTexture(f.TEXTURE_2D,e),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,1,1,0,f.RGBA,f.UNSIGNED_BYTE,g),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),e},ha}onmessage=function(a){function b(a,b,c,d,f){postMessage({id:e,dxtData:a,width:b,height:c,levels:d,internalFormat:f})}function c(a){postMessage({id:e,error:a})}var d=a.data.src,e=a.data.id,f=new XMLHttpRequest;f.addEventListener("load",function(a){200==f.status?ca(f.response,b,c):c(f.statusText)},!1),f.open("GET","../"+d,!0),f.responseType="arraybuffer",f.send(null)}}(),TextureAsset=IAsset.$extend({__init__:function(a){this.$super(a,"TextureAsset"),this.texture=null,this.cubeTexture=null,this._instances=[],this.instanceUsed=!1},__classvars__:{__init__:function(a){TextureAsset.TextureLoader=new THREE.TextureLoader,TextureAsset.CubeTextureLoader=new THREE.CubeTextureLoader,TextureAsset.WebGLTextureLoader=new WebGLTextureUtil(a.renderer.renderer.getContext());a.renderer.renderer.extensions.get("WEBGL_compressed_texture_s3tc");TextureAsset.SupportsDXT=!1,TextureAsset.SupportsETC1=TextureAsset.WebGLTextureLoader.supportsETC1(),TextureAsset.SupportsPVR=TextureAsset.WebGLTextureLoader.supportsPVRTC(),Tundra.browser.isMobile()&&(TextureAsset.EnabledFormat=TextureAsset.SupportsETC1?"etc1":TextureAsset.SupportsPVR?"pvr":""),console.log("[TextureAsset]: Compression support DXT:"+TextureAsset.SupportsDXT,"ETC1:"+TextureAsset.SupportsETC1,"PVR:"+TextureAsset.SupportsPVR,"Enabled format:'"+TextureAsset.EnabledFormat+"'")},SupportsDXT:!0,SupportsETC1:!1,SupportsPVR:!1,EnabledFormat:"",Format:{COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35987,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798},WebGLTextureLoader:null,DIFFUSE:0,SPECULAR:1,NORMAL:2,LIGHT:3,REFLECTION:4,SHADOW:5,typeToString:function(a){return a===TextureAsset.DIFFUSE?"DIFFUSE":a===TextureAsset.SPECULAR?"SPECULAR":a===TextureAsset.NORMAL?"NORMAL":a===TextureAsset.LIGHT?"LIGHT":a===TextureAsset.REFLECTION?"REFLECTION":a===TextureAsset.SHADOW?"SHADOW":"Unkown texture type "+a.toString()},typeFromString:function(a){return"DIFFUSE"===a?TextureAsset.DIFFUSE:"SPECULAR"===a?TextureAsset.SPECULAR:"NORMAL"===a?TextureAsset.NORMAL:"LIGHT"===a?TextureAsset.LIGHT:"REFLECTION"===a?TextureAsset.REFLECTION:"SHADOW"===a?TextureAsset.SHADOW:-1},formatToString:function(a){if("number"==typeof a){if(a===THREE.AlphaFormat)return"Alpha";if(a===THREE.RGBFormat)return"RGB";if(a===THREE.LuminanceFormat)return"Luminance";if(a===THREE.LuminanceAlphaFormat)return"LuminanceAlpha";if(a===THREE.RGB_S3TC_DXT1_Format)return"RGB_S3TC_DXT1";if(a===THREE.RGBA_S3TC_DXT1_Format)return"RGBA_S3TC_DXT1";if(a===THREE.RGBA_S3TC_DXT3_Format)return"RGBA_S3TC_DXT3";if(a===THREE.RGBA_S3TC_DXT5_Format)return"RGBA_S3TC_DXT5"}return"INVALID_TEXTURE_FORMAT"},filterToString:function(a){if("number"==typeof a){if(a===THREE.NearestFilter)return"Nearest";if(a===THREE.NearestMipMapNearestFilter)return"NearestMipMapNearest";if(a===THREE.NearestMipMapLinearFilter)return"NearestMipMapLinear";if(a===THREE.LinearFilter)return"Linear";if(a===THREE.LinearMipMapNearestFilter)return"LinearMipMapNearest";if(a===THREE.LinearMipMapLinearFilter)return"LinearMipMapLinear"}return"INVALID_TEXTURE_FILTER"},addressModeFromString:function(a){return"wrap"===a||""===a?THREE.RepeatWrapping:"clamp"===a?THREE.ClampToEdgeWrapping:"mirror"===a?THREE.MirroredRepeatWrapping:THREE.RepeatWrapping}},isLoaded:function(){return null!==this.texture&&void 0!==this.texture.mipmaps&&null!==this.texture.mipmaps},unload:function(){null!=this.texture&&this.texture.dispose(),this.texture=null,null!=this.cubeTexture&&this.cubeTexture.dispose(),this.cubeTexture=null},height:function(){return this.isLoaded()&&null!=this.texture&&null!=this.texture.image?this.texture.image.height:-1},width:function(){return this.isLoaded()&&null!=this.texture&&null!=this.texture.image?this.texture.image.width:-1},numMipmaps:function(){return this.isLoaded()&&null!=this.texture&&null!=this.texture.mipmaps?this.texture.mipmaps.length:-1},getOrCreateInstance:function(a){if(void 0===this.texture||null===this.texture)return null;if(a.type===TextureAsset.REFLECTION){if(null===this.cubeTexture){if(this.texture.image.width!==this.texture.image.height)return this.log.warn("Cannot create reflection cube map from texture with width != height:",this.texture.image.width,"x",this.texture.image.height,"in",this.name),null;this.cubeTexture=new THREE.CompressedTexture,this.cubeTexture.name=this.texture.name,this.cubeTexture.wrapS=this.texture.wrapS,this.cubeTexture.wrapT=this.texture.wrapT,this.cubeTexture.magFilter=this.texture.magFilter,this.cubeTexture.minFilter=this.texture.minFilter,this.cubeTexture.format=this.texture.format,this.cubeTexture.anisotropy=this.texture.anisotropy,this.cubeTexture.needsUpdate=!0,this.cubeTexture.image=[];for(var b=0;b<6;++b)this.cubeTexture.image.push(this.texture)}return this.cubeTexture}var c={repeat:a.scale,addressModeString:a.addressMode,addressMode:TextureAsset.addressModeFromString(a.addressMode),matches:function(a){var b=a.texture;return this.repeat.x===b.repeat.x&&this.repeat.y===b.repeat.y&&this.addressMode===b.wrapS&&this.addressMode===b.wrapT},clone:function(a){var b=a.clone();return this.apply(b),b},apply:function(a){a.texture.repeat=this.repeat.clone(),a.texture.wrapS=this.addressMode,a.texture.wrapT=this.addressMode,a.texture.needsUpdate=!0,a.instanceUsed=!0},toString:function(){return"repeat = "+this.repeat.x+","+this.repeat.y+" addressMode = "+this.addressModeString},textureId:function(a){return a.name.substring(a.name.lastIndexOf("/")+1)}};if(!c.matches(this)){if(!this.instanceUsed)return this.logging&&this.log.info("Modifying base instance with",c.toString(),c.textureId(this)),c.apply(this),this.texture;for(var b=0,d=this.numClones();b<d;++b){var e=Tundra.asset.getAsset(this.cloneName(b));if(null!=e&&null!=e.texture&&c.matches(e))return this.logging&&this.log.info("Found existing instance",c.toString(),c.textureId(e)),e.texture}var f=c.clone(this);return this._instances.push(f.texture),this.logging&&this.log.info("Cloned instance",c.toString(),c.textureId(f)),f.texture}return this.logging&&this.log.info("Returning base instance",c.toString(),c.textureId(this)),this.instanceUsed=!0,this.texture},_cloneImpl:function(a){var b=new TextureAsset(a);return b.texture=this.texture.clone(),b.texture.name=a,b.texture.needsUpdate=!0,b},deserializeFromData:function(a,b,c){if(null!=this.texture)return this.log.warn("Texture already loaded: "+this.name),!1;if(".png"===c.suffix&&".dds"!==c.proxyMetadata.type||".png"===c.proxyMetadata.type)return TextureAsset.TextureLoader.crossOrigin="anonymous",TextureAsset.TextureLoader.load(".png"===c.suffix?c.ref:c.proxyRef,function(a){this.texture=a,this.texture.tundraAsset=this,this.texture.width=a.image.width,this.texture.height=a.image.height,this.texture.wrapS=THREE.RepeatWrapping,this.texture.wrapT=THREE.RepeatWrapping,this.texture.magFilter=THREE.LinearFilter,this.texture.minFilter=THREE.LinearFilter,this.texture.flipY=!1,this.texture.anisotropy=4,this.texture.generateMipmaps=!1,this.texture.needsUpdate=!0,this._emitLoaded()}.bind(this),void 0,function(a){this._emitFailed("Failed to load png via <img>")}.bind(this)),!0;if(TextureAsset.SupportsDXT===!1&&TextureAsset.SupportsETC1===!1||""!==TextureAsset.EnabledFormat&&"dxt"!==TextureAsset.EnabledFormat&&"etc1"!=TextureAsset.EnabledFormat)return this.log.error("Cannot load texture: Enabled profile '"+TextureAsset.EnabledFormat+"' asset ref:",this.name),!1;var d=THREE.DDSLoader.parse(a,!0);return null!=d&&null!=d.format&&(this.texture=new THREE.CompressedTexture,this.texture.tundraAsset=this,this.texture.name=this.name,this.texture.wrapS=THREE.RepeatWrapping,this.texture.wrapT=THREE.RepeatWrapping,this.texture.magFilter=THREE.LinearFilter,this.texture.minFilter=THREE.LinearFilter,this.texture.format=d.format,this.texture.mipmaps=d.mipmaps,this.texture.width=this.texture.image.width=d.width,this.texture.height=this.texture.image.height=d.height,this.texture.anisotropy=4,this.texture.generateMipmaps=!1,this.texture.needsUpdate=!0,void 0!==this.texture.mipmaps&&null!==this.texture.mipmaps?this.texture.mipmaps.length>1&&(this.texture.magFilter=THREE.NearestFilter,this.texture.minFilter=THREE.NearestMipMapNearestFilter):this.log.error("Mipmaps null after loading for "+this.name,!0),this.logging&&this.dumpDebugInfo(),this.texture.addEventListener("dispose",this._onTextureDispose.bind(this)),delete d,d=null,!0)},dumpDebugInfo:function(){this.log.debug(this.name),this.log.debug("  -- loaded  "+this.isLoaded()),this.log.debug("  -- format  "+TextureAsset.formatToString(this.isLoaded()?this.texture.format:void 0)),this.log.debug("  -- filters min = "+TextureAsset.filterToString(this.isLoaded()?this.texture.minFilter:void 0)+" mag = "+TextureAsset.filterToString(this.isLoaded()?this.texture.magFilter:void 0)),this.log.debug("  -- size    "+this.width()+" x "+this.height()),this.log.debug("  -- mipmaps "+this.numMipmaps()),this.log.debug("")},_onTextureDispose:function(a){if(null!=this.texture||null!=this.cubeTexture){for(var b=[null!=this.texture?this.texture.uuid:this.cubeTexture.uuid],c=0;c<this._instances.length;c++)b.push(this._instances[c].uuid),this._instances[c].dispose();for(var d=function(a){for(var c=0,d=b.length;c<d;++c)if(b[c]===a)return!0;return!1},e=0,f=Tundra.renderer.getAllMeshes(),g=0,h=f.length;g<h;g++){var i=f[g].material;if(null!=f[g].material){var j=e;i instanceof THREE.ShaderMaterial?null!=i.uniforms&&(null!=i.uniforms.map1&&null!=i.uniforms.map1.value&&d(i.uniforms.map1.value.uuid)&&(this.logging&&console.log("  uniform map1"),e++,i.uniforms.map1.value=null),null!=i.uniforms.map2&&null!=i.uniforms.map2.value&&d(i.uniforms.map2.value.uuid)&&(this.logging&&console.log("  uniform map2"),e++,i.uniforms.map2.value=null),null!=i.uniforms.tCube&&null!=i.uniforms.tCube.value&&d(i.uniforms.tCube.value.uuid)&&(this.logging&&console.log("  uniform tCube"),e++,i.uniforms.tCube.value=null),null!=i.uniforms.map&&null!=i.uniforms.map.value&&d(i.uniforms.map.value.uuid)&&(this.logging&&console.log("  uniform map"),e++,i.uniforms.map.value=null),null!=i.uniforms.normalMap&&null!=i.uniforms.normalMap.value&&d(i.uniforms.normalMap.value.uuid)&&(this.logging&&console.log("  uniform normalMap"),e++,i.uniforms.normalMap.value=null)):i instanceof THREE.Material&&(null!=i.map&&d(i.map.uuid)&&(this.logging&&console.log("  map"),e++,i.map=null),null!=i.lightMap&&d(i.lightMap.uuid)&&(this.logging&&console.log("  lightMap"),e++,i.lightMap=null),null!=i.specularMap&&d(i.specularMap.uuid)&&(this.logging&&console.log("  specularMap"),e++,i.specularMap=null),null!=i.normalMap&&d(i.normalMap.uuid)&&(this.logging&&console.log("  normalMap"),e++,i.normalMap=null),null!=i.envMap&&d(i.envMap.uuid)&&(this.logging&&console.log("  envMap"),e++,i.envMap=null)),j!=e&&(i.needsUpdate=!0)}}this._instances=[],this.texture&&(this.texture.mipmaps=[]),this.texture=null,this.cubeTexture&&(this.cubeTexture.mipmaps=[]),this.cubeTexture=null}}}),OgreShader=Class.$extend({__init__:function(a,b,c){this.type=a,this.blockId=this.type===OgreShader.Type.Vertex?"vertex_program_ref":"fragment_program_ref",this.name="",this.data="",this.params={},this.logging=c||!1,void 0!==b&&"string"==typeof b&&this.deserializeFromData(b)},__classvars__:{Type:{Vertex:0,Fragment:1}},deserializeFromData:function(a){var b=a.indexOf(this.blockId+" ");if(b!==-1){var c=b+this.blockId.length+1;this.name=CoreStringUtils.readLine(a.substring(c),null,!0,!0);var d=a.indexOf("{",c),e=a.indexOf("}",c);d!==-1&&e!==-1&&(this.data=a.substring(d+1,e-1))}this.logging&&""!==this.name&&console.log("  >>",this.blockId+(this.type===OgreShader.Type.Vertex?"  ":""),"'"+this.name+"'")},isValid:function(){return""!==this.name},nameContains:function(a){return""!==this.name&&this.name.indexOf(a)!==-1},nameMatches:function(a){return this.name===a},readNamedParameters:function(a){if(""!==this.data)for(var b in a){var c=a[b];this.namedParameter(b,c)}},namedParameter:function(a,b){if(""!==this.data){if(void 0!==this.params[a])return this.params[a];var c="param_named "+a;""!==b&&(c+=" "+b),c+=" ";var d=this.data.indexOf(c);if(d!==-1){var e=CoreStringUtils.readLine(this.data.substring(d+c.length),null,!0,!0).split(" "),f={id:a,type:b,value:e};return this.params[a]=f,this.logging&&console.log("     --",a,b,e.join(" ")),f}}},getNamedParameter:function(a,b){var c=this.params[a];if(null!=c&&c.id===a){if("string"==typeof b){if("float2"===b)return c.value.length<2?(console.error("OgreShader: Named parameter value "+a+" does not have enough indexes. Requested "+b+" actual value is",c.value),null):new THREE.Vector2(parseFloat(c.value[0]),parseFloat(c.value[1]));if("float4"===b)return c.value.length<4?(console.error("OgreShader: Named parameter value "+a+" does not have enough indexes. Requested "+b+" actual value is",c.value),null):new THREE.Vector4(parseFloat(c.value[0]),parseFloat(c.value[1]),parseFloat(c.value[2]),parseFloat(c.value[3]));if("float"===b)return c.value.length<1?(console.error("OgreShader: Named parameter value "+a+" does not have enough indexes. Requested "+b+" actual value is",c.value),null):parseFloat(c.value[0]);if("floatarray"==b){for(var d=[],e=0;e<c.value.length;e++){var f=parseFloat(c.value[e]);isNaN(f)?(console.warn("OgreShader: Failed to parse float for floatarray type from",f),d.push(0)):d.push(f)}return d}if("float4array"==b){for(var d=[],e=0;e<c.value.length;e++){var f=parseFloat(c.value[e]);isNaN(f)?(console.warn("OgreShader: Failed to parse float for floatarray type from",f),d.push(0)):d.push(f)}if(d.length<=0)return null;for(var g=[],e=0;e<d.length;e+=4){var f=new THREE.Vector4(0,0,0,0);d.length>=e+1&&(f.x=d[e]),d.length>=e+2&&(f.y=d[e+1]),d.length>=e+3&&(f.z=d[e+2]),d.length>=e+4&&(f.w=d[e+3]),g.push(f)}return g}}return c.value}return null}}),OgreTextureUnit=Class.$extend({__init__:function(a,b,c,d){this.index=a,this.name=b,this.textureRef="",this.logging=d||!1,void 0!==c&&"string"==typeof c&&this.deserializeFromData(c)},deserializeFromData:function(a){this.logging&&(console.log("  >> texture_unit",this.index),""!==this.name&&console.log("     --",this._logPadding("name"),"'"+this.name+"'")),this.data=a,this.texture=this.textureRef=this.readFirstString("texture"),this.addressMode=this.readFirstString("tex_address_mode"),this.alias=this.readString("texture_alias",!0),this.coordSet=this.readInt("tex_coord_set",-1),this.scale=this.readFloat2("scale",1,new THREE.Vector2(1,1)),this.logging===!1&&(this.data=void 0)},_logPadding:function(a){return a},readFirstString:function(a){var b=this.readString(a);return b.indexOf(" ")!==-1&&(b=b.substring(0,b.indexOf(" "))),this.logging&&""!==b&&console.log("     --",this._logPadding(a),"'"+b+"'"),b},readString:function(a,b){a+=" ";var c=this.data.indexOf(a),d=c!==-1?CoreStringUtils.readLine(this.data.substring(c+a.length),null,!0,!0):"";return this.logging&&b===!0&&""!==d&&console.log("     --",this._logPadding(a)+"'"+d+"'"),d},readInt:function(a,b){var c=this.readString(a);return""===c?b:(this.logging&&console.log("     --",this._logPadding(a),parseInt(c)),parseInt(c))},readFloat2:function(a,b,c){void 0===b&&(b=1),void 0===c&&(c=new THREE.Vector2);var d=this.readString(a);if(""===d)return c;var e=d.split(" ");return e.length>=2&&(c.x=Math.min(parseFloat(e[0]),b),c.y=Math.min(parseFloat(e[1]),b),this.logging&&console.log("     --",this._logPadding(a),c.x,c.y)),c}}),OgreMaterial=Class.$extend({__init__:function(a,b,c){this.name=a,this.logging=c||!1,void 0!==b&&"string"==typeof b&&this.deserializeFromData(b)},__classvars__:{IgnoredTextureUnitTypes:{},Color:{Ambient:0,Diffuse:1,Specular:2,Emissive:3},ignoreTextureUnit:function(a){for(var b=Array.isArray(a)?a:[a],c=0;c<b.length;c++){var d=b[c];"string"==typeof d&&(d=TextureAsset.typeFromString(d)),"number"!=typeof d||d<0||(OgreMaterial.IgnoredTextureUnitTypes[d]=!0)}},typeFromString:function(a){return"ambient"===a?OgreMaterial.Color.Ambient:"diffuse"===a?OgreMaterial.Color.Diffuse:"specular"===a?OgreMaterial.Color.Specular:"emissive"===a?OgreMaterial.Color.Emissive:void 0},typeToString:function(a){return a===OgreMaterial.Color.Ambient?"ambient":a===OgreMaterial.Color.Diffuse?"diffuse":a===OgreMaterial.Color.Specular?"specular":a===OgreMaterial.Color.Emissive?"emissive":"Unkown color type";
},defaultMaterialColor:function(a){if("string"==typeof a&&(a=OgreMaterial.typeFromString(a)),void 0===a)return null;var b=new Color;return a===OgreMaterial.Color.Ambient?b.setRGBA(.8,.8,.8):a===OgreMaterial.Color.Diffuse?b.setRGBA(1,1,1):a===OgreMaterial.Color.Specular?b.setRGBA(.067,.067,.067):a===OgreMaterial.Color.Emissive&&b.setRGBA(0,0,0),b},clampColor:function(a,b,c,d){(b.r>c||b.g>c||b.b>c)&&(b.r>c&&(b.r=c),b.g>c&&(b.g=c),b.b>c&&(b.b=c),d&&("string"==typeof a&&(a=OgreMaterial.typeFromString(a)),console.log("  -- Clamped",OgreMaterial.typeToString(a),"to",c)))},_passRegexp:/\spass/g,_texUnitRegexp:/\stexture_unit/g},deserializeFromData:function(a){if(this.data=CoreStringUtils.removeComments(a),this.logging&&console.log("Parsing '"+this.name+"'"),this.passes={},this.passes.count=this.readCount("pass",OgreMaterial._passRegexp),this.passes.count>1){console.warn("OgreMaterial: Parser detected",this.passes.count,"passes. Only single pass fixed pipeline materials are supported '"+this.name+"'. Continuing parsing witht the first pass.");var b=this.readBlock("pass",0,!1);this.data=b.data}this.logging&&this.readCount("texture_unit",OgreMaterial._texUnitRegexp),this.shaders={},this.shaders.vertex=new OgreShader(OgreShader.Type.Vertex,this.data,this.logging),this.shaders.fragment=new OgreShader(OgreShader.Type.Fragment,this.data,this.logging),this.shaders.hasShadowShaders=function(){return this.vertex.nameContains("Shadow")||this.fragment.nameContains("Shadow")},this.shaders.fragment.readNamedParameters({opacity:"float4",specularPower:"float4"}),this.attributes={},this.attributes.scene_blend=this.readString("scene_blend",!0),this.attributes.scene_blend_op=this.readString("scene_blend_op",!0),this.attributes.colour_op_ex=this.readAttributeList("colour_op_ex"),this.attributes.alpha_op_ex=this.readAttributeList("alpha_op_ex"),this.attributes.alpha_rejection=this.readAttributeList("alpha_rejection"),this.attributes.fog_override=this.readAttributeList("fog_override"),this.ambient=this.readColor(OgreMaterial.Color.Ambient),this.diffuse=this.readColor(OgreMaterial.Color.Diffuse),this.specular=this.readColor(OgreMaterial.Color.Specular),this.emissive=this.readColor(OgreMaterial.Color.Emissive),this.opacity=this.readOpacity(),this.depthWrite=this.data.indexOf("depth_write off")===-1,this.lighting=this.data.indexOf("lighting off")===-1,this.logging&&!this.depthWrite&&console.log("  -- depth_write off"),this.logging&&!this.lighting&&console.log("  -- lighting off"),this.textureUnits=[];for(var c=0,d=0;d!==-1;++c){var b=this.readBlock("texture_unit",d,!1);if(void 0===b)break;d=b.indexEnd;var e=new OgreTextureUnit(c,b.name,b.data,this.logging);if(e.type=this.resolveTextureType(e),void 0!==e.type){if(e.type!==TextureAsset.SHADOW){var f=OgreMaterial.IgnoredTextureUnitTypes[e.type];void 0===f||f!==!0?this.isTextureTypeReserved(e.type)?this.logging&&console.log("     Ignoring "+TextureAsset.typeToString(e.type)+" as its already set once!"):this.textureUnits.push(e):this.logging&&console.log("     Ignoring "+TextureAsset.typeToString(e.type)+" as instructed by 3rd party code.")}}else console.warn("Failed to resolve texture type","index =",e.index,"name =",e.name,"coord set =",e.coordSet,"fragment shader =",this.shaders.fragment.name)}this.logging===!1&&(this.data=void 0)},readString:function(a,b){a+=" ";var c=this.data.indexOf(a),d=c!==-1?CoreStringUtils.readLine(this.data.substring(c+a.length),null,!0,!0):"";return this.logging&&b===!0&&""!==d&&console.log("  --",a+"'"+d+"'"),d},readList:function(a,b){var c=this.data.indexOf(a);if(c===-1)return[];var d=CoreStringUtils.trim(this.readLine(this.data.substring(c+a.length)));return""!==d?d.split("string"==typeof b?b:" "):[]},readColor:function(a){var b=null,c=this.readList(OgreMaterial.typeToString(a)+" ");if(c.length>=3?(b=new Color,b.r=Math.min(parseFloat(c[0]),1),b.g=Math.min(parseFloat(c[1]),1),b.b=Math.min(parseFloat(c[2]),1)):b=OgreMaterial.defaultMaterialColor(a),this.logging){for(var d="";OgreMaterial.typeToString(a).length+d.length<8;)d+=" ";console.log("  --",OgreMaterial.typeToString(a)+d,b.r,b.g,b.b,c.length<3?"[default]":"")}return b},readOpacity:function(){var a=void 0,b=this.shaders.fragment.namedParameter("opacity","float4");if(void 0!==b&&b.value.length>0){var c=Math.min(parseFloat(b.value[0]),1);isNaN(c)||(a=c)}if(void 0===a&&Array.isArray(this.attributes.alpha_op_ex)&&this.attributes.alpha_op_ex.length>=4&&(a=Math.min(parseFloat(this.attributes.alpha_op_ex[3]),1)),void 0===a){var d=this.readList("diffuse ");a=d.length>=4?Math.min(parseFloat(d[3]),1):1}return this.logging&&1!==a&&console.log("  -- opacity ",a),a},readAttributeList:function(a){var b=this.readList(a+" ");return this.logging&&b.length>0&&console.log("  --",a,b.join(" ")),b},readBlock:function(a,b,c){void 0===b&&(b=0);var d=this.data.indexOf(a,b);if(d!==-1){var e={indexEnd:-1,id:a,name:"",data:""},f=d+a.length,g=this.data.indexOf("{",f),h=this.data.indexOf("}",f);if(g===-1||h===-1)return console.error("Failed to read block { } data content starting from index",d),console.error("in",this.name),void console.error(this.data.substring(d));for(var i=this.data.indexOf("{",g+1);i>=0&&i<h;){if(innerClose=this.data.indexOf("}",i+1),innerClose===-1||i>=h)return console.error("Syntax error in material file in {} scope at index",g,"in material:",this.name),void console.log(this.data);h=this.data.indexOf("}",innerClose+1),i=this.data.indexOf("{",i+1)}return e.name=CoreStringUtils.trim(this.readLine(this.data.substring(f))),e.data=this.data.substring(g+1,h-1),e.indexEnd=h+1,this.logging&&c===!0&&console.log("  >>",e.id,""!==e.name?"'"+e.name+"'":""),e}},readCount:function(a,b,c){var d=this.data.match(b),e=null!=d?d.length:0;return this.logging&&console.log("  --",a,"count",e),e},readLine:function(a,b){var c=null,d=a.indexOf("\n"),e=a.indexOf("\r\n"),f=a.indexOf("\t"),g=void 0!==b?a.indexOf(b):-1;return(null==c||d!==-1&&d<c)&&(c=d),(null==c||e!==-1&&e<c)&&(c=e),(null==c||f!==-1&&f<c)&&(c=f),(null==c||g!==-1&&g<c)&&(c=g),c!==-1?a.substring(0,c):""},numTextures:function(){return this.textureUnits.length},isTextureTypeReserved:function(a){for(var b=0;b<this.textureUnits.length;++b)if(this.textureUnits[b].type===a)return!0;return!1},isTextureCoordReserver:function(a){for(var b=0;b<this.textureUnits.length;++b)if(this.textureUnits[b].coordSet===a)return!0;return!1},resolveTextureType:function(a){var b=void 0;if("baseMap"===a.name||"diffuseMap"===a.name)b=TextureAsset.DIFFUSE;else if("specularMap"===a.name)b=TextureAsset.SPECULAR;else if("lightMap"===a.name)b=TextureAsset.LIGHT;else if("normalMap"===a.name)b=TextureAsset.NORMAL;else if("reflectionMap"===a.name)b=TextureAsset.REFLECTION;else if(CoreStringUtils.startsWith(a.name,"shadowMap"))return this.logging&&console.log("     --",TextureAsset.typeToString(TextureAsset.SHADOW)),TextureAsset.SHADOW;return void 0===b&&a.coordSet>-1&&(0===a.coordSet?b=this.isTextureTypeReserved(TextureAsset.DIFFUSE)?TextureAsset.SPECULAR:TextureAsset.DIFFUSE:1===a.coordSet&&(b=TextureAsset.LIGHT)),void 0===b&&(this.shaders.fragment.isValid()?this.shaders.fragment.nameContains("/Diff")&&0===a.index&&(b=TextureAsset.DIFFUSE):0===a.index?b=TextureAsset.DIFFUSE:1===a.index&&(b=this.isTextureTypeReserved(TextureAsset.LIGHT)?TextureAsset.DIFFUSE:TextureAsset.LIGHT)),this.shaders.fragment.nameContains("meshmoon/MultiDiff")?b=0===a.index?TextureAsset.DIFFUSE:void 0:this.shaders.fragment.nameContains("DiffSpecmapNormalShadowLightmap"),this.logging&&void 0!==b&&console.log("     --",TextureAsset.typeToString(b)),b}}),OgreMaterialAsset=IAsset.$extend({__init__:function(a){this.$super(a,"OgreMaterialAsset"),this.material=null,this.ogreMaterial=null,this.textureRequests=[]},__classvars__:{DebugMaterial:new THREE.MeshBasicMaterial({color:(new THREE.Color).setRGB(.2,.2,.2)}),sceneBlendFactorFromString:function(a){return"one"===a?THREE.OneFactor:"zero"===a?THREE.ZeroFactor:"dest_colour"===a?THREE.DstColorFactor:"src_colour"===a?THREE.SrcColorFactor:"one_minus_dest_colour"===a?THREE.OneMinusDstColorFactor:"one_minus_src_colour"===a?THREE.OneMinusSrcColorFactor:"dest_alpha"===a?THREE.DstAlphaFactor:"src_alpha"===a?THREE.SrcAlphaFactor:"one_minus_dest_alpha"===a?THREE.OneMinusDstAlphaFactor:"one_minus_src_alpha"===a?THREE.OneMinusSrcAlphaFactor:void 0},ignoreTextureUnit:function(a){OgreMaterial.ignoreTextureUnit(a)}},isLoaded:function(){return null!==this.material&&0===this.numPendingDependencies()},_unloadTexture:function(a){if(null!=a){for(var b=a.uuid,c=!1,d=Tundra.renderer.getAllMeshes(),e=0,f=d.length;e<f;e++){var g=d[e].material;if(null!=d[e].material&&(g instanceof THREE.ShaderMaterial?null!=g.uniforms&&(null!=g.uniforms.map1&&null!=g.uniforms.map1.value&&g.uniforms.map1.value.uuid===b?c=!0:null!=g.uniforms.map2&&null!=g.uniforms.map2.value&&g.uniforms.map2.value.uuid===b?c=!0:null!=g.uniforms.tCube&&null!=g.uniforms.tCube.value&&g.uniforms.tCube.value.uuid===b?c=!0:null!=g.uniforms.map&&null!=g.uniforms.map.value&&g.uniforms.map.value.uuid===b?c=!0:null!=g.uniforms.normalMap&&null!=g.uniforms.normalMap.value&&g.uniforms.normalMap.value.uuid===b&&(c=!0)):g instanceof THREE.Material&&(null!=g.map&&g.map.uuid===b?c=!0:null!=g.lightMap&&g.lightMap.uuid===b?c=!0:null!=g.specularMap&&g.specularMap.uuid===b?c=!0:null!=g.normalMap&&g.normalMap.uuid===b?c=!0:null!=g.envMap&&g.envMap.uuid===b&&(c=!0)),c))break}c||a.dispose()}},isMaterialInUse:function(a){if(void 0===a.uuid)return!1;var b=!1;return Tundra.renderer.scene.traverse(function(c){b!==!0&&null!=c&&null!=c.material&&c.material.uuid===a.uuid&&(b=!0)}),b},unload:function(){null!=this.material&&(this.isMaterialInUse(this.material)||(this.logging&&console.log("OgreMaterialAsset unload",this.name),this.material instanceof THREE.ShaderMaterial?null!=this.material.uniforms&&(null!=this.material.uniforms.map1&&null!=this.material.uniforms.map1.value&&(this.logging&&console.log("  uniform map1"),this._unloadTexture(this.material.uniforms.map1.value),this.material.uniforms.map1.value=null),null!=this.material.uniforms.map2&&null!=this.material.uniforms.map2.value&&(this.logging&&console.log("  uniform map2"),this._unloadTexture(this.material.uniforms.map2.value),this.material.uniforms.map2.value=null),null!=this.material.uniforms.tCube&&null!=this.material.uniforms.tCube.value&&(this.logging&&console.log("  uniform tCube"),this._unloadTexture(this.material.uniforms.tCube.value),this.material.uniforms.tCube.value=null),null!=this.material.uniforms.map&&null!=this.material.uniforms.map.value&&(this.logging&&console.log("  uniform map"),this._unloadTexture(this.material.uniforms.map.value),this.material.uniforms.map.value=null),null!=this.material.uniforms.normalMap&&null!=this.material.uniforms.normalMap.value&&(this.logging&&console.log("  uniform normalMap"),this._unloadTexture(this.material.uniforms.normalMap.value),this.material.uniforms.normalMap.value=null)):this.material instanceof THREE.Material&&(null!=this.material.map&&(this.logging&&console.log("  map"),this._unloadTexture(this.material.map),this.material.map=null),null!=this.material.lightMap&&(this.logging&&console.log("  lightMap"),this._unloadTexture(this.material.lightMap),this.material.lightMap=null),null!=this.material.specularMap&&(this.logging&&console.log("  specularMap"),this._unloadTexture(this.material.specularMap),this.material.specularMap=null),null!=this.material.normalMap&&(this.logging&&console.log("  normalMap"),this._unloadTexture(this.material.normalMap),this.material.normalMap=null),null!=this.material.envMap&&(this.logging&&console.log("  envMap"),this._unloadTexture(this.material.envMap),this.material.envMap=null)),this.material.dispose(),null!=this.material&&this.log.error("Material non null after release")))},_onMaterialDisposed:function(){if(null!=this.material){for(var a=0,b=Tundra.renderer.getAllMeshes(),c=0,d=b.length;c<d;c++)null!=b[c].material&&b[c].material.uuid===this.material.uuid&&(b[c].material=Tundra.renderer.materialWhite,b[c].material.needsUpdate=!0,a++);this.material._listeners=[],this.material=null}},textureRefs:function(){var a=[];return null==this.material?a:(null!=this.material.map&&a.push(this.material.map.name),null!=this.material.lightMap&&a.push(this.material.lightMap.name),null!=this.material.specularMap&&a.push(this.material.specularMap.name),null!=this.material.normalMap&&a.push(this.material.normalMap.name),null!=this.material.envMap&&a.push(this.material.envMap.name),a)},deserializeFromData:function(a,b,c){this.ogreMaterial=new OgreMaterial(this.name,a,this.logging),this.logging&&console.log("Converting to THREE.Material"),this.ogreMaterial.lighting&&this.ogreMaterial.depthWrite!==!1?(this.logging&&console.log("  -- THREE.MeshPhongMaterial"),this.material=new THREE.MeshPhongMaterial):(this.logging&&console.log("  -- THREE.MeshBasicMaterial [lighting off]"),this.material=new THREE.MeshBasicMaterial);var d=this.ogreMaterial.attributes.fog_override;if(Array.isArray(d)&&d.length>0)if(1===d.length){var e="string"==typeof d[0]?d[0].toLowerCase():d[0];"true"===e?this.material.fog=!1:"false"===e?this.material.fog=!0:this.log.warn("Unsupported fog_override:",e,". Supported 'fog_override {true|false}', will turn off/on fog for this material.")}else this.log.warn("Unsupported fog_override:",d,". Supported 'fog_override {true|false}', will turn off/on fog for this material.");else this.material.fog=!0;this.material.name=this.name,this.material.hasTundraShadowShader=this.ogreMaterial.shaders.hasShadowShaders(),(this.material instanceof THREE.ShaderMaterial||!(this.material instanceof THREE.ShaderMaterial)&&this.material.ambient)&&(this.material.ambient=this.ogreMaterial.ambient.toThreeColor());var f=this.ogreMaterial.diffuse.toThreeColor();(this.material instanceof THREE.ShaderMaterial||!(this.material instanceof THREE.ShaderMaterial)&&this.material.color)&&(this.material.color=f),(this.material instanceof THREE.ShaderMaterial||!(this.material instanceof THREE.ShaderMaterial)&&this.material.diffuse)&&(this.material.diffuse=f),(this.material instanceof THREE.ShaderMaterial||!(this.material instanceof THREE.ShaderMaterial)&&this.material.specular)&&(this.material.specular=this.ogreMaterial.specular.toThreeColor()),(this.material instanceof THREE.ShaderMaterial||!(this.material instanceof THREE.ShaderMaterial)&&this.material.emissive)&&(this.material.emissive=this.ogreMaterial.emissive.toThreeColor()),this.material.opacity=this.ogreMaterial.opacity,this.material.emissive&&OgreMaterial.clampColor(OgreMaterial.Color.Emissive,this.material.emissive,.5,this.logging),this.material.specular&&!this.ogreMaterial.shaders.fragment.isValid()&&this.material instanceof THREE.MeshPhongMaterial&&this.ogreMaterial.numTextures()<=1&&OgreMaterial.clampColor(OgreMaterial.Color.Specular,this.material.specular,.1,this.logging),this.ogreMaterial.depthWrite===!1&&(this.material.transparent=!0,this.material.depthWrite=!1,this.material.color&&this.material.color.setRGB(1,1,1),this.material.diffuse&&this.material.diffuse.setRGB(1,1,1));var g=this.ogreMaterial.shaders.fragment.namedParameter("specularPower","float4");if(void 0!==g&&g.value.length>0){var h=parseFloat(g.value[0]);isNaN(h)||(this.material.shininess=h,this.logging&&console.log("  -- specularPower -> shininess",this.material.shininess))}var i=30;"number"==typeof this.material.shininess&&this.material.shininess>i&&(this.material.shininess=i);var j=this.ogreMaterial.attributes.scene_blend_op;"string"==typeof j&&""!==j&&"add"!==j&&("subtract"==j?(this.material.blending=THREE.CustomBlending,this.material.blendEquation=THREE.SubtractEquation):"reverse_subtract"==j?(this.material.blending=THREE.CustomBlending,this.material.blendEquation=THREE.ReverseSubtractEquation):this.log.warn("Unsupported scene_blend_op '"+j+"'"));var k=this.ogreMaterial.attributes.colour_op_ex;Array.isArray(k)&&k.length>=6&&this.material.color&&(this.material.color.r=Math.min(parseFloat(k[3]),1),this.material.color.g=Math.min(parseFloat(k[4]),1),this.material.color.b=Math.min(parseFloat(k[5]),1),this.material.diffuse=this.material.color);var l=this.ogreMaterial.attributes.alpha_rejection;if(Array.isArray(l)&&l.length>=2){var m=l[0].toLowerCase();if("greater_equal"===m||"greater"===m){var n=parseInt(l[1]);null!=n&&n>0&&(n>255&&(n=255),this.material.alphaTest=n/255,this.logging&&console.log("  -- alpha_rejection -> alphaTest",this.material.alphaTest))}else"always_fail"===m?this.material.opacity=0:"always_pass"!==m&&this.log.warn("Unsupported alpha_rejection function '"+m+"' Supported: 'always_fail', greater_equal' and 'greater'")}var o=this.ogreMaterial.attributes.scene_blend;if("string"==typeof o&&""!==o)if(this.material.blending=THREE.CustomBlending,o.indexOf(" ")===-1)"add"==o?this.material.blending=THREE.AdditiveBlending:"modulate"==o?this.material.blending=THREE.MultiplyBlending:"colour_blend"==o?(this.material.blendSrc=THREE.OneFactor,this.material.blendDst=THREE.OneMinusSrcColorFactor):"alpha_blend"==o?(this.material.blendSrc=THREE.SrcAlphaFactor,this.material.blendDst=THREE.OneMinusSrcAlphaFactor):(this.log.warn("Unsupported scene_blend '"+o+"'"),this.material.blending=THREE.NormalBlending);else{var p=o.split(" "),q=OgreMaterialAsset.sceneBlendFactorFromString(p[0]),r=OgreMaterialAsset.sceneBlendFactorFromString(p[1]);void 0!==q&&void 0!==r?(this.material.blendSrc=q,this.material.blendDst=r):(this.log.warn("Unsupported parts in scene_blend '"+o+"'"),this.material.blending=THREE.NormalBlending)}for(var s=0,t=this.ogreMaterial.numTextures();s<t;++s){var u=this.ogreMaterial.textureUnits[s];if(u.type!=TextureAsset.REFLECTION)if(""!==u.texture){var v=this.logging?u.scale.clone():void 0;1===u.scale.x&&1===u.scale.y||(u.scale.x=1/u.scale.x,u.scale.y=1/u.scale.y,this.logging&&console.log("  -- scale",v.x,v.y,"-> repeat",u.scale.x,u.scale.y));var c=Tundra.asset.requestDependencyAsset(this,u.textureRef,"Texture");null!=c&&(c.onCompleted(this,this._textureLoaded,u),c.onFailed(this,this._textureFailed),this.textureRequests.push(u))}else this.logging&&console.warn("  -- Ignoring texture_unit "+s+": Does not have a texture.");else this.logging&&console.warn("Skipping reflection map loading as it breaks rendering with THREE.js r75 and later.")}this.numPendingDependencies()>0&&this.logging&&console.log("  -- Waiting for",this.numPendingDependencies(),"dependency textures"),this.logging&&console.log(""),this.material.addEventListener("dispose",this._onMaterialDisposed.bind(this))},numPendingDependencies:function(){return this.textureRequests.length},pendingDependencies:function(){for(var a=[],b=0;b<this.textureRequests.length;++b)a.push(this.textureRequests[b].textureRef);return a},_removeTextureDependency:function(a,b){for(var c=0;c<this.textureRequests.length;++c)this.textureRequests[c].textureRef===a&&this.textureRequests[c].index===b&&(this.textureRequests.splice(c,1),c--)},_textureLoaded:function(a,b){if(null!==this.material){if(void 0===a&&null===a)return this.log.error("Texture 'completed' but asset is not valid:",a),this._emitDependencyFailed(b.textureRef),void this.unload();var c=a.getOrCreateInstance(b);b.type===TextureAsset.DIFFUSE?this.material.map=c:b.type===TextureAsset.SPECULAR?void 0!==this.material.specularMap?this.material.specularMap=c:this.logging&&this.log.warn("Cannot set specular map to this type of material",this.material):b.type===TextureAsset.LIGHT?void 0!==this.material.lightMap?this.material.lightMap=c:this.logging&&this.log.warn("Cannot set light map to this type of material",this.material):b.type===TextureAsset.NORMAL?void 0!==this.material.normalMap?this.material.normalMap=c:this.logging&&this.log.warn("Cannot set normal map to this type of material",this.material):b.type===TextureAsset.REFLECTION?void 0!==this.material.envMap?this.material.envMap=c:this.logging&&this.log.warn("Cannot set reflection map to this type of material",this.material):this.log.error("Unknown texture loaded with type "+TextureAsset.typeToString(b.type)),this.material.needsUpdate=!0,this._removeTextureDependency(b.textureRef,b.index),0===this.numPendingDependencies()&&(this.logging&&console.log("All dependencies loaded for",this.name),this._emitLoaded())}},_textureFailed:function(a,b,c){this._emitDependencyFailed(a.ref),this.unload()}}),OgreBone=Class.$extend({__init__:function(a,b,c,d,e){this.name=a,this.id=b,this.position=c,this.quaternion=d,this.scale=e}}),OgreAnimationTrack=Class.$extend({__init__:function(a){this.bone=a,this.keyFrames=[]},addKeyFrame:function(a){a.bone=this.bone,this.keyFrames.push(a)}}),OgreTransformKeyFrame=Class.$extend({__init__:function(a,b,c,d){this.time=a,this.quaternion=b,this.translate=c,this.scale=d},positionFromParent:function(){var a={x:this.translate.x,y:this.translate.y,z:this.translate.z};return null!=this.bone&&(a.x+=this.bone.position.x,a.y+=this.bone.position.y,a.z+=this.bone.position.z),a},toArray:function(a,b){var c=[];if("translate"===a||"position"===a)if(b===!0){var d=this.positionFromParent();c=[d.x,d.y,d.z]}else c=[this.translate.x,this.translate.y,this.translate.z];else c="scale"===a?[this.scale.x,this.scale.y,this.scale.z]:null;return c}}),OgreSkeletonSerializer=Class.$extend({__init__:function(a){void 0===a&&(a={}),this.logging=void 0!==a.logging&&a.logging,this.reset()},__classvars__:{supportedVersions:["[Serializer_v1.10]","[Serializer_v1.80]"],isSupportedVersion:function(a){for(var b=0;b<OgreSkeletonSerializer.supportedVersions.length;b++)if(OgreSkeletonSerializer.supportedVersions[b]===a)return!0;return!1},chunk:{HEADER:4096,HEADER_ENDIAN_FLIP:16,BLENDMODE:4112,BONE:8192,BONE_PARENT:12288,ANIMATION:16384,ANIMATION_BASEINFO:16400,ANIMATION_TRACK:16640,ANIMATION_TRACK_KEYFRAME:16656,ANIMATION_LINK:20480},chunkIdToString:function(a){switch(a){case this.chunk.HEADER:return"HEADER";case this.chunk.HEADER_ENDIAN_FLIP:return"HEADER_ENDIAN_FLIP";case this.chunk.BLENDMODE:return"BLENDMODE";case this.chunk.BONE:return"BONE";case this.chunk.BONE_PARENT:return"BONE_PARENT";case this.chunk.ANIMATION:return"ANIMATION";case this.chunk.ANIMATION_BASEINFO:return"ANIMATION_BASEINFO";case this.chunk.ANIMATION_TRACK:return"ANIMATION_TRACK";case this.chunk.ANIMATION_TRACK_KEYFRAME:return"ANIMATION_TRACK_KEYFRAME";case this.chunk.ANIMATION_LINK:return"ANIMATION_LINK"}return"Unknown_Chunk_ID_"+a},boneSizeWithoutScale:30,keyFrameSizeWithoutScale:32},reset:function(){this.ds=null,this.version="",this.ogreSkeleton=null,this.chunk={id:void 0,len:void 0,lenLeft:void 0,size:6},this.logging&&(this.time=new Date)},logError:function(a){return Tundra.client.logError("[OgreSkeletonSerializer]: "+a,!0),!1},logWarning:function(a){},logChunk:function(){console.log(OgreSkeletonSerializer.chunkIdToString(this.chunk.id)+" len = "+this.chunk.lenLeft+" bytesLeft = "+this.ds.bytesLeft())},importSkeleton:function(a,b){if(!(b instanceof OgreSkeleton))return this.logError("importMesh(): 'ogreSkeleton' parameter is no of type OgreSkeleton");try{return this.ds=new DataDeserializer(a),!!this.readHeader()&&(this.ogreSkeleton=b,!!this.readSkeleton()&&(this.logging&&console.log("  >> Skeleton imported in "+(new Date-this.time)+" msec"),!0))}catch(c){return void 0!==c.stack?console.error(c.stack):console.error(c),!1}},readChunk:function(){return this.ds.bytesLeft()<this.chunk.size?this.logError("readChunk(): Not enough data to read next chunks metadata"):(this.chunk.id=this.ds.readU16(),this.chunk.len=this.ds.readU32(),this.chunk.lenLeft=this.chunk.len-this.chunk.size,this.logging&&this.chunk.id!==OgreSkeletonSerializer.chunk.ANIMATION_TRACK_KEYFRAME&&this.logChunk(),!0)},rewindChunk:function(){this.logging&&console.log("    -- Rewinding chunk"),this.ds.skipBytes(-this.chunk.size)},readHeader:function(){return this.ds.readU16()!==OgreSkeletonSerializer.chunk.HEADER?this.logError("readHeader(): First data chunk is not HEADER"):(this.version=this.ds.readStringUntil("\0",10),!!OgreSkeletonSerializer.isSupportedVersion(this.version)||this.logError("Unsupported mesh version "+this.version))},readSkeleton:function(){for(;this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;switch(this.chunk.id){case OgreSkeletonSerializer.chunk.BONE:if(!this.readBone())return!1;break;case OgreSkeletonSerializer.chunk.BONE_PARENT:if(!this.readBoneParent())return!1;break;case OgreSkeletonSerializer.chunk.ANIMATION:if(!this.readAnimation())return!1;break;default:this.ds.skipBytes(this.chunk.lenLeft)}}return!0},readBone:function(){var a=new OgreBone(this.ds.readStringUntil("\0",10),this.ds.readU16(),this.ds.readFloat32Vector3(),this.ds.readFloat32Vector4(),{x:1,y:1,z:1});return this.chunk.lenLeft>OgreSkeletonSerializer.boneSizeWithoutScale&&(a.scale=this.ds.readFloat32Vector3()),this.ogreSkeleton.addBone(a),!0},readBoneParent:function(){return this.ogreSkeleton.parentBone(this.ds.readU16(),this.ds.readU16()),!0},readAnimation:function(){var a=new OgreAnimation(this.ds.readStringUntil("\0",10),this.ds.readFloat32());if(!this.readChunk())return!1;for(this.chunk.id===OgreSkeletonSerializer.chunk.ANIMATION_BASEINFO?a.baseKeyFrame={name:this.ds.readString(),time:this.ds.readFloat32()}:this.rewindChunk();this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id!==OgreSkeletonSerializer.chunk.ANIMATION_TRACK){this.rewindChunk();break}if(!this.readAnimationTrack(a))return!1}return this.ogreSkeleton.addAnimation(a),!0},readAnimationTrack:function(a){for(var b=new OgreAnimationTrack(this.ogreSkeleton.getBone(this.ds.readU16()));this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id!==OgreSkeletonSerializer.chunk.ANIMATION_TRACK_KEYFRAME){this.rewindChunk();break}if(!this.readKeyFrame(b))return!1}return a.addTrack(b),!0},readKeyFrame:function(a){var b=new OgreTransformKeyFrame(this.ds.readFloat32(),this.ds.readFloat32Vector4(),this.ds.readFloat32Vector3(),{x:1,y:1,z:1});return this.chunk.lenLeft>OgreSkeletonSerializer.keyFrameSizeWithoutScale&&(b.scale=this.ds.readFloat32Vector3()),a.addKeyFrame(b),!0}}),OgreSkeletonAsset=AnimationProviderAsset.$extend({__init__:function(a){this.$super(a,"OgreSkeletonAsset",AnimationProviderAsset.Type.SkinnedMesh),this.requiresCloning=!0,this.skin=null,this.skeleton=null,this.bones=[],this.bonesFlat=[],this.animationHierarchy={},this.animationCache={},this.currentAnimation=null},isLoaded:function(){return Object.keys(this.animationHierarchy).length>0},unload:function(){if(!this.requiresCloning||!this.isCloneSource){null!=this.currentAnimation&&this.currentAnimation.stop();for(var a=0;a<this.bones.length;a++){var b=this.bones[a].parent;null!=b&&b.remove(this.bones[a])}this.skin=null,this.skeleton=null,this.bones=[],this.bonesFlat=[],this.animationHierarchy={},this.animationCache={}}},_cloneImpl:function(a){var b=new OgreSkeletonAsset(a);return b.cloneFrom(this),b},cloneFrom:function(a){return a instanceof OgreSkeletonAsset?(this.unload(),this.type=a.type,this.requiresCloning=a.requiresCloning,this.loaded=a.isLoaded(),this.bonesFlat=a.cloneBones(),this.bones=this.createHierarchy(this.bonesFlat),void(this.animationHierarchy=a.animationHierarchy)):void this.log.error("OgreSkeletonAsset.cloneFrom can only clone from another OgreSkeletonAsset instance.")},isAttached:function(){return null!=this.skin},getSkeletonParent:function(){return this.isAttached()?this.skin.mesh:null},getBoneParent:function(){return this.isAttached()?this.skin.getSubmesh(0):null},getBone:function(a){for(var b=null,c=0;c<this.bones.length&&(this.bones[c].name===a?b=this.bones[c]:null!=this.bones[c].children&&this.bones[c].children.length>0&&(b=this._getBone(a,this.bones[c].children)),null==b);c++);return b},_getBone:function(a,b){for(var c=null,d=0;d<b.length&&(b[d].name===a?c=b[d]:null!=b[d].children&&b[d].children.length>0&&(c=this._getBone(a,b[d].children)),null==c);d++);return c},cloneBones:function(){for(var a=[],b=0;b<this.bonesFlat.length;b++){var c=this.bonesFlat[b],d=new THREE.Bone;d.sourceBoneId=c.sourceBoneId,d.name=c.name,d.parentName=c.parent?c.parent.name:"",d.position.copy(c.originalPosition),d.quaternion.copy(c.originalQuaternion),d.originalPosition=c.originalPosition.clone(),d.originalQuaternion=c.originalQuaternion.clone(),a.push(d)}return a},createHierarchy:function(a){for(var b=[],c=function(a,b){for(var d=null,e=0;e<b.length&&(b[e].name===a?d=b[e]:null!=b[e].children&&b[e].children.length>0&&(d=c(a,b[e].children)),null==d);e++);return d},d=function(b){for(var d=null,e=0;e<a.length&&(a[e].name===b?d=a[e]:null!=a[e].children&&a[e].children.length>0&&(d=c(b,a[e].children)),null==d);e++);return d},e=0;e<a.length;e++){var f=a[e],g=d(f.parentName);null!=f&&null!=g?g.add(f):b.push(f)}return b},attach:function(a){if(this.isAttached())return this.skin.name!==a.name&&this.log.warn("Skeleton already attached to",this.skin.name),!1;if(!a.isLoaded())return this.log.error("Target mesh",a.name,"is not loaded"),!1;if(!a.canAttachSkeleton())return this.log.error("Target mesh",a.name,"does not have skeleton support"),!1;this.skin=a;for(var b=this.getSkeletonParent(),c=0;c<this.bones.length;c++){var d=this.bones[c];b.add(d),d.updateMatrix(),d.updateMatrixWorld(!0)}return this.skeleton=new THREE.Skeleton(this.bonesFlat,void 0,!1),this.link(this.skin)},link:function(a){if(!this.isAttached())return this.log.warn("link: Called before attach()",this.name),!1;if(null==this.skeleton)return this.log.warn("link: Skeleton not ready",this.name),!1;if(a.linkedSkeleton===this.name)return!0;for(var b=0,c=a.numSubmeshes();b<c;++b){var d=a.getSubmesh(b);d instanceof THREE.SkinnedMesh&&(null!=d.material?(d.needsUpdate=!0,d.material.name.indexOf("tundra.MaterialLibrary")===-1&&(d.material.skinning=!0,d.material.needsUpdate=!0),d.bind(this.skeleton)):this.log.warn("link: Submesh",b,b.name,"does not have material set"))}return this.skeleton.pose(),a.linkedSkeleton=this.name,!0},deserializeFromData:function(a,b,c){var d=!1;return d="arraybuffer"===b?this.deserializeFromBinary(a):this.deserializeFromXML(a)},deserializeFromBinary:function(a){var b=new OgreSkeleton(this.name),c=new OgreSkeletonSerializer,d=c.importSkeleton(a,b);return c.reset(),d===!0&&(this.animationHierarchy=OgreThreeJsUtils.loadOgreAnimations(b,this.logging),Object.keys(this.animationHierarchy).length>0?(this.bonesFlat=OgreThreeJsUtils.convertOgreBones(b),this.bones=this.createHierarchy(this.bonesFlat)):d=!1),d},deserializeFromXML:function(a){return this.log.error("Loading OgreSkeletonAsset from .mesh.xml is no longer supported. Use a binary skeleton instead."),!1},parseAnimation:function(a,b,c){var d=this,e={};e.name=b.attr("name"),e.length=parseFloat(b.attr("length")),e.tracks=[],e.parseTracks=function(a,b,c){var f={};f.bone=d.getBone(b.attr("bone")),f.keyframes=[],f.parseKeyframe=function(a,b,c){var d={};d.time=parseFloat(b.attr("time"));var e=b.find("translate");d.pos=[parseFloat(e.attr("x"))+this.bone.position.x,parseFloat(e.attr("y"))+this.bone.position.y,parseFloat(e.attr("z"))+this.bone.position.z];var f=b.find("rotate"),g=f.find("axis");d.rot=new THREE.Quaternion,d.rot.setFromAxisAngle(new THREE.Vector3(parseFloat(g.attr("x")),parseFloat(g.attr("y")),parseFloat(g.attr("z"))),parseFloat(f.attr("angle"))),d.rot.multiplyQuaternions(this.bone.quaternion,d.rot),d.scl=[1,1,1],this.keyframes.push(d)};var g=(b.find("keyframes"),b.find("keyframe"));g.each(function(a,b){f.parseKeyframe(a,$(this),b)}),e.tracks.push(f)};var f=(b.find("tracks"),b.find("track"));f.each(function(a,b){e.parseTracks(a,$(this),b)}),this.ogreAnimations.push(e)},parseBone:function(a,b,c){var d=new THREE.Bone(null);d.id=parseInt(b.attr("id")),d.name=b.attr("name");var e=b.find("position");d.position.x=parseFloat(e.attr("x")),d.position.y=parseFloat(e.attr("y")),d.position.z=parseFloat(e.attr("z"));var f=b.find("rotation"),g=f.find("axis");d.quaternion.setFromAxisAngle(new THREE.Vector3(parseFloat(g.attr("x")),parseFloat(g.attr("y")),parseFloat(g.attr("z"))),parseFloat(f.attr("angle"))),d.originalPosition=d.position.clone(),d.originalQuaternion=d.quaternion.clone(),this.bones.push(d),this.bonesFlat.push(d)},parseBoneHierarchy:function(a,b,c){
var d=b.attr("bone"),e=b.attr("parent"),f=this.getBone(d),g=this.getBone(e);if(null==f||null==g)return void(null!=console.warn&&console.warn("Bone",d,"or its parent",e,"cannot be found!"));null!=f.parent&&null!=console.warn&&console.warn("Bone",f.name,"already has parent!"),g.add(f);for(var h=0;h<this.bones.length;h++)if(this.bones[h].name===d){this.bones.splice(h,1);break}}}),OgrePlugin=ITundraPlugin.$extend({__init__:function(){this.$super("OgrePlugin",["Ogre"])},pluginPropertyName:function(){return"ogre"},initialize:function(a){this.framework.asset.registerAssetFactory(new AssetFactory("OgreMesh",OgreMeshAsset,{".mesh":"arraybuffer",".mesh.xml":"xml"})),this.framework.asset.registerAssetFactory(new AssetFactory("OgreMaterial",OgreMaterialAsset,{".material":"text"})),this.framework.asset.registerAssetFactory(new AssetFactory("OgreSkeleton",OgreSkeletonAsset,{".skeleton":"arraybuffer",".skeleton.xml":"xml"})),this.framework.asset.registerAssetFactory(new AssetFactory("Texture",TextureAsset,{".dds":void 0,".crn":void 0,".png":void 0,".jpg":void 0,".jpeg":void 0,".bmp":void 0,".gif":void 0},"arraybuffer"))},postInitialize:function(){void 0!==TextureAsset.__init__&&TextureAsset.__init__(this.framework)}});Tundra.registerPlugin(new OgrePlugin);var ScriptInstance=Class.$extend({__init__:function(a,b){this.entityId=a.id,this.componentId=b.id,this.application=null,this.startupApplication=!1},setApplication:function(a){this.application=a,this.startupApplication=a.startupApplication,Tundra.events.send("ScriptInstance."+this.entityId+"."+this.componentId+".ScriptStarted",this,this.application)},isRunning:function(){return null!=this.application},isStartupApplication:function(){return this.startupApplication},stop:function(){if(!this.isRunning()||this.isStartupApplication())return!1;if(Tundra.events.remove("ScriptInstance."+this.entityId+"."+this.componentId+".ScriptStarted",this,this.application),"function"==typeof this.application._onScriptDestroyed)try{this.application._onScriptDestroyed()}catch(a){console.error("ScriptInstance.onScriptDestroyed threw exception:",a.stack||a)}return delete this.application,this.application=null,!0},onApplicationStarted:function(a,b){return Tundra.events.subscribe("ScriptInstance."+this.entityId+"."+this.componentId+".ScriptStarted",a,b)}}),ScriptAsset=IAsset.$extend({__init__:function(a){this.$super(a,"ScriptAsset"),this.script=null,this.instances=[]},_getInstance:function(a,b){if(null==a||null==b)return null;for(var c=0;c<this.instances.length;c++)if(this.instances[c].entityId===a.id&&this.instances[c].componentId===b.id)return this.instances[c];return null},_stopAndRemoveInstance:function(a,b){if(null!=a&&null!=b)for(var c=0;c<this.instances.length;c++)if(this.instances[c].entityId===a.id&&this.instances[c].componentId===b.id)return this.instances[c].stop()&&this.log.debug("Stopped instance of "+this.name+" (Entity: "+a.toString()+", Component: "+b.toString()+")"),void(this.instances[c].isStartupApplication()||this.instances.splice(c,1))},_getOrCreateInstance:function(a,b){var c=this._getInstance(a,b);return null==c&&(this.log.debug("Creating instance of "+this.name+" (Entity: "+a.toString()+", Component: "+b.toString()+")"),c=new ScriptInstance(a,b),this.instances.push(c)),c},_setApplication:function(a){var b=this._getInstance(a.entity,a.component);null==b||Tundra.usingRequireJS()||setTimeout(function(){b.setApplication(a)},10)},requireJsModuleName:function(){return"lib/require.webtundrajs.loader!"+this.name},isLoaded:function(){return null!==this.script},isRunning:function(a,b){var c=this._getInstance(a,b);return null!=c&&null!=c.application},deserializeFromData:function(a,b,c){this.script=a},unload:function(){this.script=null,this.stop()},run:function(a,b,c){var d=null;if(!this.isLoaded())return d;if(this.isRunning(a,b))return d;if(void 0===a||null===a)return this.log.error("Tried to run script "+this.name+" with null parent Entity"),d;if(void 0===b||null===b)return this.log.error("Tried to run script "+this.name+" with null parent EC_Script"),d;if(void 0!==c&&null!==c||(c=!1),Tundra.usingRequireJS()&&this.script.indexOf("define(")!==-1){d=this._getOrCreateInstance(a,b);var e=this;require([this.requireJsModuleName()],function(f){IApplication._setupStatic(a,b,e.name,c);try{d.setApplication(new f)}catch(g){e.log.error(e.name+" instance requirejs execution failed: "+g),e.log.error(typeof f,f),void 0!==g.stack&&console.error(g.stack),e.script=null,e._stopAndRemoveInstance(a,b)}IApplication._resetStatic()})}else{d=this._getOrCreateInstance(a,b),IApplication._setupStatic(a,b,this.name,c,this);try{$.globalEval(this.script)}catch(f){this.log.error(this.name+" instance eval execution failed: "+f),void 0!==f.stack&&console.error(f.stack),this.script=null,this._stopAndRemoveInstance(a,b)}IApplication._resetStatic()}return d},stop:function(a,b){if(void 0!==a&&void 0!==b)this._stopAndRemoveInstance(a,b);else{for(var c=!1,d=0;d<this.instances.length;d++)this.instances[d].stop()&&(c=!0),this.instances[d].isStartupApplication()||(this.instances.splice(d,1),d--);c&&0===this.instances.length&&this.log.debug("Stopped all running instances of "+this.name),0===this.instances.length&&Tundra.usingRequireJS()&&requirejs.undef(this.requireJsModuleName())}}}),ScriptPlugin=ITundraPlugin.$extend({__init__:function(){this.$super("ScriptPlugin",["Script"])},pluginPropertyName:function(){return"script"},initialize:function(a){this.framework.asset.registerAssetFactory(new AssetFactory("Script",ScriptAsset,{".js":void 0,".webtundrajs":void 0},"text"))},postInitialize:function(){}});Tundra.registerPlugin(new ScriptPlugin);var PhysicsRaycastResult=Class.$extend({__init__:function(a,b,c,d){this.entity=a?a:null,this.pos=b?b:new THREE.Vector3,this.normal=c?c:new THREE.Vector3,this.distance=d?d:new THREE.Vector3}}),CollisionInfo=Class.$extend({__init__:function(a,b,c,d,e,f,g){this.bodyA=a?a:null,this.bodyB=b?b:null,this.position=c?c:new THREE.Vector3,this.normal=d?d:new THREE.Vector3,this.distance=e?e:0,this.impulse=f?f:0,this.newCollision=!!g&&g}}),IPhysicsWorld=Class.$extend({__init__:function(){this.physicsUpdatePeriod=1/60,this.maxSubSteps=6,this.runPhysics=!0,this.useVariableTimestep=!1,this.previousCollisions=[]},simulate:function(a){TundraLogging.getLogger("IPhysicsWorld").warn("simulate(frametime) not implemented.")},processPostTick:function(a){TundraLogging.getLogger("IPhysicsWorld").warn("processPostTick(subStepTime) not implemented.")},onPhysicsCollision:function(a,b){return Tundra.events.subscribe("PhysicsWorld.PhysicsCollision",a,b)},onAboutToUpdate:function(a,b){return Tundra.events.subscribe("PhysicsWorld.AboutToUpdate",a,b)},setUpdatePeriod:function(a){a<=.001&&(a=.001),this.physicsUpdatePeriod=a},setMaxSubSteps:function(a){a>0&&(this.maxSubSteps=a)},setRunning:function(a){this.runPhysics_=a},isRunning:function(){return this.runPhysics_},raycast:function(a,b,c,d,e){TundraLogging.getLogger("IPhysicsWorld").warn("raycast(origin, direction, maxDistance, collisionGroup, collisionMask) not implemented.")}}),PhysicsWorld_Ammo=IPhysicsWorld.$extend({__init__:function(){this.$super(),this.log=TundraLogging.getLogger("PhysicsWorldAmmo"),this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.collisionDispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.broadphase=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.world=new Ammo.btDiscreteDynamicsWorld(this.collisionDispatcher,this.broadphase,this.solver,this.collisionConfiguration),this.previousCollisions=[],this.ptrToRigidbodyMap_={},this.processPostTickEventId_=null,this.frameUpdateEventId_=null,Tundra.client.onConnected(this,this.onConnected),this.setGravity(0,-10,0)},__classvars__:{ObjectPair:function(a,b){this.key1=a,this.key2=b,this.equals=function(a){return a instanceof PhysicsWorld_Ammo.ObjectPair&&this.key1===a.key1&&this.key2===a.key2}}},onConnected:function(){null===this.processPostTickEventId_&&(this.processPostTickEventId_=Tundra.frame.onUpdate(this,this.processPostTick),this.frameUpdateEventId_=Tundra.events.subscribe("PhysicsWorld.Update",this,this.simulate))},addRigidBody:function(a,b,c){var d=a.rigidAmmo;this.ptrToRigidbodyMap_[d.ptr]=a,"number"==typeof b&&"number"==typeof c?this.world.addRigidBody(d,b,c):this.world.addRigidBody(d)},removeRigidBody:function(a){var b=a.rigidAmmo;delete this.ptrToRigidbodyMap_[b.ptr],this.world.removeRigidBody(b)},postInitialize:function(){null===this.processPostTickEventId_&&(this.processPostTickEventId_=Tundra.frame.onUpdate(this,this.processPostTick),this.frameUpdateEventId_=Tundra.events.subscribe("PhysicsWorld.Update",this,this.simulate))},simulate:function(a){if(this.runPhysics)if(Tundra.events.send("PhysicsWorld.AboutToUpdate",a),this.useVariableTimestep&&a>this.physicsUpdatePeriod){var b=a;b>.1&&(b=.1),this.world.stepSimulation(b,0,b)}else this.world.stepSimulation(a,this.maxSubSteps,this.physicsUpdatePeriod)},processPostTick:function(a){for(var b=this.collisionDispatcher.getNumManifolds(),c=[],d=[],e=0;e<b;++e){var f=this.collisionDispatcher.getManifoldByIndexInternal(e),g=f.getNumContacts();if(0!==g){var h=f.getBody0(),i=f.getBody1(),j=this.ptrToRigidbodyMap_[h.ptr],k=this.ptrToRigidbodyMap_[i.ptr];if(void 0!==j&&null!==j&&void 0!==k&&null!==k){var l=j.parentEntity,m=k.parentEntity;if(void 0!==l&&null!==l&&void 0!==m&&null!==m){var n=null;if(n=l.id<m.id?new PhysicsWorld_Ammo.ObjectPair(l,m):new PhysicsWorld_Ammo.ObjectPair(m,l),h.isActive()||i.isActive()){for(var o=!0,p=0;p<this.previousCollisions.length;++p)this.previousCollisions[p].equals(n)&&(o=!1);for(var q=0;q<g;++q){var r=f.getContactPoint(q),s=new CollisionInfo;s.bodyA=l.rigidbody?l.rigidbody:null,s.bodyB=m.rigidbody?m.rigidbody:null;var t=r.get_m_positionWorldOnB();s.position=new THREE.Vector3(t.x(),t.y(),t.z()),t=r.get_m_normalWorldOnB(),s.normal=new THREE.Vector3(t.x(),t.y(),t.z()),s.distance=r.getDistance(),s.newCollision=o,d.push(s),o=!1}c.push(n)}}else this.log.error("Inconsistent Bullet physics scene state! A parentless EC_RigidBody exists in the physics scene!")}else this.log.error("Inconsistent Bullet physics scene state! An object exists in the physics scene which does not have an associated EC_RigidBody!")}}for(var u=null,e=0;e<d.length;++e)u=d[e],u.newCollision&&null!==m&&null!==l&&(Tundra.events.send("PhysicsWorld.PhysicsCollision",s),u.bodyA.emitPhysicsCollision(m,s.position,s.normal,s.distance,s.impulse,s.newCollision),u.bodyB.emitPhysicsCollision(l,s.position,s.normal,s.distance,s.impulse,s.newCollision));this.previousCollisions=c,Tundra.events.send("PhysicsWorld.Update",a)},setGravity:function(a,b,c){this.world.setGravity(new Ammo.btVector3(a,b,c))},gravity:function(){var a=this.world.getGravity();return new THREE.Vector3(a.x(),a.y(),a.z())},raycast:function(a,b,c,d,e){var f=null,g=new THREE.Vector3(b.x,b.y,b.z);g.normalize();var h=new Ammo.btVector3(a.x,a.y,a.z),i=new Ammo.btVector3(a.x+g.x*c,a.y+g.y*c,a.z+g.z*c),j=new Ammo.ClosestRayResultCallback(h,i);if("number"==typeof d&&j.set_m_collisionFilterGroup(d),"number"==typeof e&&j.set_m_collisionFilterMask(e),this.world.rayTest(j.get_m_rayFromWorld(),j.get_m_rayToWorld(),j),j.hasHit()){f=new PhysicsRaycastResult;var k=j.get_m_hitPointWorld(),l=j.get_m_hitNormalWorld();f.pos=new THREE.Vector3(k.x(),k.y(),k.z()),f.normal=new THREE.Vector3(l.x(),l.y(),l.z()),f.distance=new THREE.Vector3(f.pos.x-a.x,f.pos.y-a.y,f.pos.z-a.z).length(),f.entity=this.ptrToRigidbodyMap_[j.get_m_collisionObject().ptr].parentEntity}return Ammo.destroy(h),Ammo.destroy(i),i=null,h=null,g=null,f},reset:function(){null!==this.processPostTickEventId_&&(Tundra.events.unsubscribe(this.processPostTickEventId_.channel,this.processPostTickEventId_.id),this.processPostTickEventId_=null),null!==this.frameUpdateEventId_&&(Tundra.events.unsubscribe(this.frameUpdateEventId_.channel,this.frameUpdateEventId_.id),this.frameUpdateEventId_=null),this.ptrToRigidbodyMap_={}}}),EC_RigidBody=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"mass",0,Attribute.Real,"Mass"),this.declareAttribute(1,"shapeType",EC_RigidBody.ShapeType.Box,Attribute.Int,"Shape type"),this.declareAttribute(2,"size",new THREE.Vector3(1,1,1),Attribute.Float3,"Size"),this.declareAttribute(3,"collisionMeshRef","",Attribute.AssetReference,"Collision mesh ref"),this.declareAttribute(4,"friction",.5,Attribute.Real,"Friction"),this.declareAttribute(5,"restitution",0,Attribute.Real,"Restitution"),this.declareAttribute(6,"linearDamping",0,Attribute.Real,"Linear damping"),this.declareAttribute(7,"angularDamping",0,Attribute.Real,"Angular damping"),this.declareAttribute(8,"linearFactor",new THREE.Vector3(1,1,1),Attribute.Float3,"Linear factor"),this.declareAttribute(9,"angularFactor",new THREE.Vector3(1,1,1),Attribute.Float3,"Angular factor"),this.declareAttribute(10,"kinematic",!1,Attribute.Bool,"Kinematic"),this.declareAttribute(11,"phantom",!1,Attribute.Bool,"Phantom"),this.declareAttribute(12,"drawDebug",!1,Attribute.Bool,"Draw debug"),this.declareAttribute(13,"linearVelocity",new THREE.Vector3(0,0,0),Attribute.Float3,"Linear velocity"),this.declareAttribute(14,"angularVelocity",new THREE.Vector3(0,0,0),Attribute.Float3,"Angular velocity"),this.declareAttribute(15,"collisionLayer",-1,Attribute.Int,"Collision layer"),this.declareAttribute(16,"collisionMask",-1,Attribute.Int,"Collision mask"),this.declareAttribute(17,"rollingFriction",.5,Attribute.Real),this.declareAttribute(18,"useGravity",!0,Attribute.Bool)},__classvars__:{TypeId:23,TypeName:"RigidBody",ShapeType:{Box:0,Sphere:1,Cylinder:2,Capsule:3,TriMesh:4,HeightField:5,ConvexHull:6,Cone:7},CollisionFlags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32,DISABLE_SPU_COLLISION_PROCESSING:64},ForceThresholdSq:2.5e-7,ImpulseThresholdSq:2.5e-7,TorqueThresholdSq:2.5e-7}}),EC_RigidBody_Ammo=EC_RigidBody.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.updateId_=Tundra.frame.onUpdate(this,this.update),this.ignoreTransformChange_=!1,this.parentChangedEvent_=null,this.collisionShapeAmmo=null,this.rigidAmmo=null,this.pendingMeshAsset_=!1,this.dirty_=!1},__classvars__:{Implementation:"ammo.js"},reset:function(){Tundra.events.remove("EC_Rigidbody."+this.parentEntity.id+".PhysicsCollision"),Tundra.events.unsubscribe(this.updateId_.channel,this.updateId_.id),this.removeCollisionShape(),this.removeBody()},attributeChanged:function(a,b,c){switch(a){case 0:this.dirty_=!0;break;case 1:this.dirty_=!0;break;case 2:this.dirty_=!0;break;case 3:break;case 4:this.rigidAmmo.setFriction(c);break;case 5:this.rigidAmmo.setRestitution(c);break;case 6:this.dirty_=!0;break;case 7:this.dirty_=!0;break;case 8:if(this.rigidAmmo){var d=new Ammo.btVector3(c.x,c.y,c.z);this.rigidAmmo.setLinearFactor(d),Ammo.destroy(d),d=null}break;case 9:if(this.rigidAmmo){var d=new Ammo.btVector3(c.x,c.y,c.z);this.rigidAmmo.setAngularFactor(d),Ammo.destroy(d),d=null}break;case 10:this.dirty_=!0;break;case 11:this.dirty_=!0;break;case 12:break;case 13:if(!this.ignoreTransformChange_&&this.rigidAmmo){var d=new Ammo.btVector3(c.x,c.y,c.z);this.rigidAmmo.setLinearVelocity(d),Ammo.destroy(d),d=null}break;case 14:if(!this.ignoreTransformChange_&&this.rigidAmmo){var d=new Ammo.btVector3(c.x*Math.PI/180,c.y*Math.PI/180,c.z*Math.PI/180);this.rigidAmmo.setAngularVelocity(d),Ammo.destroy(d),d=null}break;case 15:this.dirty_=!0;break;case 16:this.dirty_=!0;break;case 17:this.rigidAmmo&&this.rigidAmmo.setRollingFriction(c);break;case 18:}},isActive:function(){return null!==this.rigidAmmo&&this.rigidAmmo.isActive()},isDynamicBody:function(){return this.attributes.mass.get()>0&&this.attributes.shapeType.get()!==EC_RigidBody.ShapeType.TriMesh},activate:function(){null!==this.rigidAmmo&&this.rigidAmmo.activate(!0)},setParent:function(a){this.$super(a),null===this.rigidAmmo&&this.createBody(),null!==this.parentChangedEvent_&&Tundra.events.unsubscribe(this.parentChangedEvent_.channel,this.parentChangedEvent_.id),void 0!==this.parentEntity&&null!==this.parentEntity&&(this.parentChangedEvent_=this.parentEntity.placeable.onAttributeChanged(this,this.onPlaceableUpdated))},applyForce:function(a,b){if(!(null===this.rigidAmmo||a.lengthSq()<EC_RigidBody.ForceThresholdSq)){this.activate();var c=new Ammo.btVector3(a.x,a.y,a.z);if("number"==typeof b&&b.length()>1e-4){var d=new Ammo.btVector3(b.x,b.y,b.z);this.rigidAmmo.applyForce(c,d),Ammo.destroy(d),d=null}else this.rigidAmmo.applyCentralForce(c);Ammo.destroy(c),c=null}},applyTorgue:function(a){if(!(null===this.rigidAmmo||a.lengthSq()<EC_RigidBody.TorqueThresholdSq)){this.activate();var b=new Ammo.btVector3(a.x,a.y,a.z);this.rigidAmmo.applyTorque(b),Ammo.destroy(b),b=null}},applyImpulse:function(a,b){if(!(null===this.rigidAmmo||a.lengthSq()<EC_RigidBody.ImpulseThresholdSq)){this.activate();var c=new Ammo.btVector3(a.x,a.y,a.z);if("number"==typeof b&&b.length()>1e-4){var d=new Ammo.btVector3(b.x,b.y,b.z);this.rigidAmmo.applyImpulse(c,d),Ammo.destroy(d),d=null}else this.rigidAmmo.applyCentralImpulse(c);Ammo.destroy(c),c=null}},applyTorgueImpulse:function(a){if(!(null===this.rigidAmmo||a.lengthSq()<EC_RigidBody.TorqueThresholdSq)){this.activate();var b=new Ammo.btVector3(a.x,a.y,a.z);this.rigidAmmo.applyTorqueImpulse(b),Ammo.destroy(b),b=null}},onPlaceableUpdated:function(a,b,c,d,e){void 0!==this.rigidAmmo&&null!==this.rigidAmmo&&0===c&&this.setRigidbodyTransform(this.parentEntity.placeable.worldPosition(),this.parentEntity.placeable.worldOrientation())},isPrimitiveShape:function(){switch(this.attributes.shapeType.get()){case EC_RigidBody.ShapeType.TriMesh:case EC_RigidBody.ShapeType.HeightField:case EC_RigidBody.ShapeType.ConvexHull:return!1;default:return!0}},createBody:function(){if(void 0!==this.parentEntity.placeable&&null!==this.parentEntity.placeable&&(this.dirty_=!1,this.removeCollisionShape(),this.removeBody(),this.createCollisionShape(),null!==this.collisionShapeAmmo)){var a=this.attributes.mass.get(),b=this.attributes.linearDamping.get(),c=this.attributes.angularDamping.get(),d=this.attributes.collisionLayer.get(),e=this.attributes.collisionMask.get(),f=this.attributes.friction.get(),g=this.attributes.linearVelocity.get(),h=this.attributes.angularVelocity.get(),i=this.attributes.rollingFriction.get(),j=this.attributes.linearFactor.get(),k=this.attributes.angularFactor.get(),l=this.attributes.kinematic.get(),m=this.attributes.phantom.get(),n=this.attributes.drawDebug.get(),o=this.isDynamicBody(),p=this.parentEntity.placeable.worldPosition(),q=this.parentEntity.placeable.worldOrientation(),r=new Ammo.btTransform,s=new Ammo.btVector3(p.x,p.y,p.z),t=new Ammo.btQuaternion(q.x,q.y,q.z,q.w);r.setOrigin(s),r.setRotation(t);var u=new Ammo.btVector3(0,0,0);o&&this.collisionShapeAmmo.calculateLocalInertia(a,u);var v=new Ammo.btDefaultMotionState(r),w=new Ammo.btRigidBodyConstructionInfo(a,v,this.collisionShapeAmmo,u);w.set_m_linearDamping(b),w.set_m_angularDamping(c),this.rigidAmmo=new Ammo.btRigidBody(w);var x=0;o||(x|=EC_RigidBody.CollisionFlags.STATIC_OBJECT),l&&(x|=EC_RigidBody.CollisionFlags.KINEMATIC_OBJECT),m&&(x|=EC_RigidBody.CollisionFlags.NO_CONTACT_RESPONSE),n||(x|=EC_RigidBody.CollisionFlags.DISABLE_VISUALIZE_OBJECT),this.rigidAmmo.setCollisionFlags(x),d>-1&&e>-1?Tundra.physicsWorld.addRigidBody(this,d,e):Tundra.physicsWorld.addRigidBody(this),this.rigidAmmo.setFriction(f),isNaN(i)||this.rigidAmmo.setRollingFriction(i);var y=new Ammo.btVector3(g.x,g.y,g.z);this.rigidAmmo.setLinearVelocity(y),h.multiplyScalar(Math.PI/180),y.setValue(h.x,h.y,h.z),this.rigidAmmo.setAngularVelocity(y),y.setValue(j.x,j.y,j.z),this.rigidAmmo.setLinearFactor(y),y.setValue(k.x,k.y,k.z),this.rigidAmmo.setAngularFactor(y),Ammo.destroy(y),y=null,Ammo.destroy(w),Ammo.destroy(u),Ammo.destroy(r),Ammo.destroy(s),Ammo.destroy(t),w=null,u=null,r=null,s=null,t=null,this.pendingMeshAsset_=!1}},removeBody:function(){void 0!==this.rigidAmmo&&null!==this.rigidAmmo&&(Tundra.physicsWorld.removeRigidBody(this),Ammo.destroy(this.rigidAmmo),this.rigidAmmo=null,this.pendingMeshAsset_=!1)},createCollisionShape:function(){var a=this.attributes.shapeType.get(),b=this.attributes.size.get();if(b.x<0&&(b.x=0),b.y<0&&(b.y=0),b.z<0&&(b.z=0),a===EC_RigidBody.ShapeType.Box){var c=new Ammo.btVector3(.5*b.x,.5*b.y,.5*b.z);this.collisionShapeAmmo=new Ammo.btBoxShape(c),Ammo.destroy(c),c=null}else if(a===EC_RigidBody.ShapeType.Sphere)this.collisionShapeAmmo=new Ammo.btSphereShape(.5*b.x);else if(a===EC_RigidBody.ShapeType.Cylinder){var c=new Ammo.btVector3(.5*b.x,.5*b.x,.5*b.x);this.collisionShapeAmmo=new Ammo.btCylinderShape(c),Ammo.destroy(c),c=null}else a===EC_RigidBody.ShapeType.Capsule?this.collisionShapeAmmo=new Ammo.btCapsuleShape(.5*b.x,.5*b.y):a===EC_RigidBody.ShapeType.TriMesh?(this.collisionShapeAmmo=this._createTriangleMeshCollider(),null===this.collisionShapeAmmo&&(this.pendingMeshAsset_=!0)):a===EC_RigidBody.ShapeType.HeightField?this.log.warn("HeightField collsion shape is not supported"):a===EC_RigidBody.ShapeType.ConvexHull?this.log.warn("ConvexHull collsion shape is not supported"):a===EC_RigidBody.ShapeType.Cone&&(this.collisionShapeAmmo=new Ammo.btConeShape(.5*b.x,b.y));this.updateScale()},updateScale:function(){if(null!==this.collisionShapeAmmo&&void 0!==this.parentEntity.placeable&&null!==this.parentEntity.placeable){var a=this.size,b=this.parentEntity.placeable.transform.scale;a.x<0&&(a.x=0),a.y<0&&(a.y=0),a.z<0&&(a.z=0);var c=new Ammo.btVector3;this.shapeType===EC_RigidBody.ConvexHull||this.shapeType===EC_RigidBody.TriMesh?c.setValue(b.x,b.y,b.z):c.setValue(a.x*b.x,a.y*b.y,a.z*b.z),this.collisionShapeAmmo.setLocalScaling(c),Ammo.destroy(c),c=null}},_createTriangleMeshCollider:function(){if(!this.hasParentEntity()||null==this.parentEntity.mesh||null==this.parentEntity.mesh.meshAsset)return null;triangleMesh=new Ammo.btTriangleMesh;for(var a=this.parentEntity.mesh.meshAsset.getSubmesh(0),b=a.geometry.vertices,c=a.geometry.faces,d=[],e=null,f=0;f<b.length;++f)e=b[f],d.push(new Ammo.btVector3(e.x,e.y,e.z));for(var g=null,f=0;f<c.length;++f)g=c[f],g instanceof THREE.Face3?triangleMesh.addTriangle(d[g.a],d[g.b],d[g.c]):g instanceof THREE.Face4&&(triangleMesh.addTriangle(d[g.a],d[g.b],d[g.c]),triangleMesh.addTriangle(d[g.b],d[g.c],d[g.d]));for(var h=new Ammo.btBvhTriangleMeshShape(triangleMesh,!0,!0),f=0;f<d.length;++f)Ammo.destroy(d[f]);return d=null,h},removeCollisionShape:function(){void 0!==this.collisionShapeAmmo&&null!==this.collisionShapeAmmo&&(Ammo.destroy(this.collisionShapeAmmo),this.collisionShapeAmmo=null)},update:function(){if(this.updateTransformPosition(),this.dirty_&&this.createBody(),this.pendingMeshAsset_){var a=this.attributes.shapeType.get();a===EC_RigidBody.ShapeType.TriMesh&&null===this.rigidAmmo&&this.createBody()}},updateTransformPosition:function(){if(!this.ignoreTransformChange_&&null!==this.rigidAmmo&&void 0!==this.parentEntity.placeable&&null!==this.parentEntity.placeable&&this.isActive()){this.ignoreTransformChange_=!0;var a=new Ammo.btTransform;this.rigidAmmo.getMotionState().getWorldTransform(a);var b=a.getOrigin(),c=new THREE.Quaternion,d=a.getRotation();c.set(d.x(),d.y(),d.z(),d.w());var e=this.parentEntity.placeable.transform;if(e.setPosition(b.x(),b.y(),b.z()),e.setRotation(c),this.parentEntity.placeable.transform=e,Ammo.destroy(a),a=null,null!==this.rigidAmmo){var f=this.rigidAmmo.getLinearVelocity(),g=new THREE.Vector3(f.x(),f.y(),f.z());this.attributes.linearVelocity.get().equals(g)||this.attributes.linearVelocity.set(g);var h=this.rigidAmmo.getAngularVelocity(),i=180/Math.PI;g=new THREE.Vector3(h.x()*i,h.y()*i,h.z()*i),this.attributes.angularVelocity.get().equals(g)||this.attributes.angularVelocity.set(g)}this.ignoreTransformChange_=!1}},setRigidbodyPosition:function(a){if(!this.ignoreTransformChange_&&void 0!==this.rigidAmmo&&null!==this.rigidAmmo){var b=new Ammo.btTransform;this.rigidAmmo.getWorldTransform(b);var c=new Ammo.btVector3(a.x,a.y,a.z);b.setOrigin(c),this.rigidAmmo.setWorldTransform(b),this.rigidAmmo.updateInertiaTensor(),this.rigidAmmo.activate(!1),Ammo.destroy(c),Ammo.destroy(b),b=null}},setRigidbodyTransform:function(a,b){if(!this.ignoreTransformChange_&&void 0!==this.rigidAmmo&&null!==this.rigidAmmo){var c=new Ammo.btTransform;this.rigidAmmo.getWorldTransform(c);var d=new Ammo.btVector3(a.x,a.y,a.z),e=new Ammo.btQuaternion(b.x,b.y,b.z,b.w);c.setOrigin(d),c.setRotation(e),this.rigidAmmo.setWorldTransform(c),this.rigidAmmo.updateInertiaTensor(),this.rigidAmmo.activate(!1),Ammo.destroy(d),Ammo.destroy(e),Ammo.destroy(c),c=null}},onPhysicsCollision:function(a,b){return Tundra.events.subscribe("EC_Rigidbody."+this.parentEntity.id+".PhysicsCollision",a,b)},emitPhysicsCollision:function(a,b,c,d,e,f){null!==this.parentEntity&&Tundra.events.send("EC_Rigidbody."+this.parentEntity.id+".PhysicsCollision",this.parentEntity,a,b,c,d,e,f)}}),AmmoPhysics=ITundraPlugin.$extend({__init__:function(a){this.$super("AmmoPhysics")},initialize:function(){Tundra.physicsWorld=new PhysicsWorld_Ammo,Tundra.physicsWorld.postInitialize(),Scene.registerComponent(EC_RigidBody_Ammo)},uninitialize:function(){Tundra.physicsWorld.reset(),Tundra.physicsWorld=null}});Tundra.registerPlugin(new AmmoPhysics);var IParticleEngine=Class.$extend({__init__:function(){this.factories={},this.systems={},this.log=TundraLogging.get("IParticleEngine")},registerFactory:function(a){return this.factories[a.ref]?void this.log.error("Factory "+a.name+" already registered."):void(this.factories[a.ref]=a)},handleParticleRef:function(a){this.log.warn("'handleParticleRef': not implemented")},particleRefs:function(){return Object.keys(this.factories)}}),EC_ParticleSystem=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"particleRef","",Attribute.AssetReference,"Particle ref")},__classvars__:{TypeId:27,TypeName:"ParticleSystem"}}),EC_ParticleSystem_ThreeJs=EC_ParticleSystem.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.engine=Tundra.plugins.particleEngine.impl,this.properties={},this.systemId="",this.system=void 0,this.placeableCache=void 0,this.placeableSub=void 0,this.posCache=new THREE.Vector3},__classvars__:{Implementation:"three.js"},reset:function(){this.engine.destroySystem(this.systemId),this.system=void 0,delete this.properties,this.properties={}},update:function(){this.systemId=this.parentEntity.id+"_"+this.id,""!==this.particleRef&&this.handleParticleRef(this.particleRef),this.checkAndUpdatePlaceable(),this.parentEntity.onComponentCreated(this,this.onComponentCreated),this.parentEntity.onComponentRemoved(this,this.onComponentRemoved)},handleParticleRef:function(a){if(this.reset(),""!==a)if(this.system=this.engine.createSystemFromFactory(this.systemId,a),this.system)this.properties=this.system.exportProperties(),this.checkAndUpdatePlaceable();else{var b=Tundra.asset.requestAsset(a,"Text");null!=b&&(b.onCompleted(this,this._onParticleLoaded),b.onFailed(this,this._onParticleFailed))}},_onParticleLoaded:function(a){this.system=this.engine.createSystem(this.systemId,a.data),this.system&&(this.properties=this.system.exportProperties(),this.checkAndUpdatePlaceable())},_onParticleFailed:function(a,b,c){this.log.error("Failed to load particle description file: ",a.ref," reason: ",b)},_updatePosition:function(){this.properties.followCamera!==!0&&this.properties.particle&&this.properties.particle.position&&(this.placeableCache.worldPosition(this.posCache),this.properties.particle.position.x=this.posCache.x,this.properties.particle.position.y=this.posCache.y,this.properties.particle.position.z=this.posCache.z)},_updateVisibility:function(){this.system&&this.placeableCache&&(this.system.visible=this.placeableCache.visible)},checkAndUpdatePlaceable:function(){return this.placeableCache?(this._updatePosition(),void this._updateVisibility()):void(this.hasParentEntity()&&this.parentEntity.placeable&&(this.placeableCache=this.parentEntity.placeable,this._updatePosition(),this._updateVisibility(),this.placeableSub&&(Tundra.events.unsubscribe(this.placeableSub),delete this.placeableSub),this.placeableSub=this.parentEntity.placeable.onAttributeChanged(this,this.onPlaceableAttributeChanged)))},onComponentCreated:function(a,b){20==b.typeId&&this.checkAndUpdatePlaceable()},onComponentRemoved:function(a,b){20==b.typeId&&this.placeableCache&&this.placeableCache.id===b.id&&(Tundra.events.unsubscribe(this.placeableSub),this.placeableSub=void 0,this.placeableCache=void 0)},onPlaceableAttributeChanged:function(a,b,c){0==c?this._updatePosition():2==c&&this._updateVisibility()},attributeChanged:function(a,b,c){0===a&&this.handleParticleRef(c)}});!function(){THREE.GPUParticleSystem=function(a){var b=this,a=a||{};b.PARTICLE_COUNT=a.maxParticles||1e6,b.PARTICLE_CONTAINERS=a.containerCount||1,b.PARTICLES_PER_CONTAINER=Math.ceil(b.PARTICLE_COUNT/b.PARTICLE_CONTAINERS),b.PARTICLE_CURSOR=0,b.time=0,b.scaleOnCameraDistance=a.scaleOnCameraDistance||!1,b._posCache=new THREE.Vector3;var c={vertexShader:["precision highp float;","const vec4 bitSh = vec4(256. * 256. * 256., 256. * 256., 256., 1.);","const vec4 bitMsk = vec4(0.,vec3(1./256.0));","const vec4 bitShifts = vec4(1.) / bitSh;","#define FLOAT_MAX  1.70141184e38","#define FLOAT_MIN  1.17549435e-38","lowp vec4 encode_float(highp float v) {","highp float av = abs(v);","//Handle special cases","if(av < FLOAT_MIN) {","return vec4(0.0, 0.0, 0.0, 0.0);","} else if(v > FLOAT_MAX) {","return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;","} else if(v < -FLOAT_MAX) {","return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;","}","highp vec4 c = vec4(0,0,0,0);","//Compute exponent and mantissa","highp float e = floor(log2(av));","highp float m = av * pow(2.0, -e) - 1.0;","c[1] = floor(128.0 * m);","m -= c[1] / 128.0;","c[2] = floor(32768.0 * m);","m -= c[2] / 32768.0;","c[3] = floor(8388608.0 * m);","//Unpack exponent","highp float ebias = e + 127.0;","c[0] = floor(ebias / 2.0);","ebias -= c[0] * 2.0;","c[1] += floor(ebias) * 128.0;","//Unpack sign bit","c[0] += 128.0 * step(0.0, -v);","//Scale back to range","return c / 255.0;","}","vec4 pack(const in float depth)","{","const vec4 bit_shift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);","const vec4 bit_mask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);","vec4 res = mod(depth*bit_shift*vec4(255), vec4(256))/vec4(255);","res -= res.xxyz * bit_mask;","return res;","}","float unpack(const in vec4 rgba_depth)","{","const vec4 bit_shift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);","float depth = dot(rgba_depth, bit_shift);","return depth;","}","uniform float uTime;","uniform float uScale;","uniform float scaleMultiplier;","uniform sampler2D tNoise;","attribute vec4 particlePositionsStartTime;","attribute vec4 particleVelColSizeLife;","varying vec4 vColor;","varying float lifeLeft;","void main() {","// unpack things from our attributes","vColor = encode_float( particleVelColSizeLife.y );","// convert our velocity back into a value we can use","vec4 velTurb = encode_float( particleVelColSizeLife.x );","vec3 velocity = vec3( velTurb.xyz );","float turbulence = velTurb.w;","vec3 newPosition;","float timeElapsed = uTime - particlePositionsStartTime.a;","lifeLeft = 1. - (timeElapsed / particleVelColSizeLife.w);","gl_PointSize = ( uScale * particleVelColSizeLife.z ) * lifeLeft;","velocity.x = ( velocity.x - .5 ) * 3.;","velocity.y = ( velocity.y - .5 ) * 3.;","velocity.z = ( velocity.z - .5 ) * 3.;","newPosition = particlePositionsStartTime.xyz + ( velocity * 10. ) * ( uTime - particlePositionsStartTime.a );","vec3 noise = texture2D( tNoise, vec2( newPosition.x * .015 + (uTime * .05), newPosition.y * .02 + (uTime * .015) )).rgb;","vec3 noiseVel = ( noise.rgb - .5 ) * 30.;","newPosition = mix(newPosition, newPosition + vec3(noiseVel * ( turbulence * 5. ) ), (timeElapsed / particleVelColSizeLife.a) );","vec4 worldPosition = modelMatrix * vec4(newPosition, 1.0);",b.scaleOnCameraDistance?"gl_PointSize *= 1.0 / (length(cameraPosition - worldPosition.xyz) * scaleMultiplier);":"","if( velocity.y > 0. && velocity.y < .05 ) {"," lifeLeft = 0.;","}","if( velocity.x < -1.45 ) {"," lifeLeft = 0.;","}","if( timeElapsed > 0. ) {"," gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );","} else {"," gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );"," lifeLeft = 0.;"," gl_PointSize = 0.;","}","}"].join("\n"),
fragmentShader:["float scaleLinear(float value, vec2 valueDomain) {","return (value - valueDomain.x) / (valueDomain.y - valueDomain.x);","}","float scaleLinear(float value, vec2 valueDomain, vec2 valueRange) {","return mix(valueRange.x, valueRange.y, scaleLinear(value, valueDomain));","}","varying vec4 vColor;","varying float lifeLeft;","uniform sampler2D tSprite;","void main() {","float alpha = 0.;","if( lifeLeft > .995 ) {","alpha = scaleLinear( lifeLeft, vec2(1., .995), vec2(0., 1.));//mix( 0., 1., ( lifeLeft - .95 ) * 100. ) * .75;","} else {","alpha = lifeLeft * .75;","}","vec4 tex = texture2D( tSprite, gl_PointCoord );","gl_FragColor = vec4( vColor.rgb, alpha * tex.a );","}"].join("\n")};b.rand=[];for(var d=1e5;d>0;d--)b.rand.push(Math.random()-.5);b.random=function(){return++d>=b.rand.length?b.rand[d=1]:b.rand[d]};var e=new THREE.TextureLoader;e.crossOrigin="",b.particleNoiseTex=e.load(Tundra.asset.resolveRef("webtundra://media/textures/perlin-512.png")),b.particleNoiseTex.wrapS=b.particleNoiseTex.wrapT=THREE.RepeatWrapping,b.particleSpriteTex=e.load(a.texture),b.particleSpriteTex.wrapS=b.particleSpriteTex.wrapT=THREE.RepeatWrapping,b.particleShaderMat=new THREE.ShaderMaterial({transparent:!0,depthWrite:!1,uniforms:{uTime:{type:"f",value:0},uScale:{type:"f",value:1},tNoise:{type:"t",value:b.particleNoiseTex},tSprite:{type:"t",value:b.particleSpriteTex},scaleMultiplier:{type:"f",value:0}},blending:THREE.NormalBlending,vertexShader:c.vertexShader,fragmentShader:c.fragmentShader}),b.particleShaderMat.defaultAttributeValues.particlePositionsStartTime=[0,0,0,0],b.particleShaderMat.defaultAttributeValues.particleVelColSizeLife=[0,0,0,0],b.particleContainers=[],THREE.Object3D.apply(this,arguments),this.init=function(){for(var a=0;a<b.PARTICLE_CONTAINERS;a++){var c=new THREE.GPUParticleContainer(b.PARTICLES_PER_CONTAINER,b);b.particleContainers.push(c),b.add(c)}},this.spawnParticle=function(a){b.PARTICLE_CURSOR++,b.PARTICLE_CURSOR>=b.PARTICLE_COUNT&&(b.PARTICLE_CURSOR=1);var c=b.particleContainers[Math.floor(b.PARTICLE_CURSOR/b.PARTICLES_PER_CONTAINER)];c.spawnParticle(a)},this.update=function(a){b.scaleOnCameraDistance&&(b.particleShaderMat.uniforms.scaleMultiplier.value=1*Math.tan(Tundra.renderer.activeCameraComponent.camera.fov)),this.time+=a;for(var c=0;c<b.PARTICLE_CONTAINERS;c++)b.particleContainers[c].update(this.time)},this.init()},THREE.GPUParticleSystem.prototype=Object.create(THREE.Object3D.prototype),THREE.GPUParticleSystem.prototype.constructor=THREE.GPUParticleSystem,THREE.GPUParticleContainer=function(a,b){function c(a,b,c,d){return f[0]=Math.floor(d),f[1]=Math.floor(c),f[2]=Math.floor(b),f[3]=Math.floor(a),g[0]}function d(a){var b=a>>16,c=(65280&a)>>8,d=255&a;return b>0&&b--,c>0&&c--,d>0&&d--,[b,c,d]}var e=this;e.PARTICLE_COUNT=a||1e5,e.PARTICLE_CURSOR=0,e.time=0,e.DPR=window.devicePixelRatio,e.GPUParticleSystem=b;Math.floor(e.PARTICLE_COUNT/e.MAX_ATTRIBUTES);THREE.Object3D.apply(this,arguments);var f=new Uint8Array(4),g=new Float32Array(f.buffer);e.particles=[],e.deadParticles=[],e.particlesAvailableSlot=[],e.particleUpdate=!1,e.particleShaderGeo=new THREE.BufferGeometry,e.particleVertices=new Float32Array(3*e.PARTICLE_COUNT),e.particlePositionsStartTime=new Float32Array(4*e.PARTICLE_COUNT),e.particleVelColSizeLife=new Float32Array(4*e.PARTICLE_COUNT);for(var h=0;h<e.PARTICLE_COUNT;h++)e.particlePositionsStartTime[4*h+0]=100,e.particlePositionsStartTime[4*h+1]=0,e.particlePositionsStartTime[4*h+2]=0,e.particlePositionsStartTime[4*h+3]=0,e.particleVertices[3*h+0]=0,e.particleVertices[3*h+1]=0,e.particleVertices[3*h+2]=0,e.particleVelColSizeLife[4*h+0]=c(128,128,0,0),e.particleVelColSizeLife[4*h+1]=c(0,254,0,254),e.particleVelColSizeLife[4*h+2]=1,e.particleVelColSizeLife[4*h+3]=0;e.particleShaderGeo.addAttribute("position",new THREE.BufferAttribute(e.particleVertices,3)),e.particleShaderGeo.addAttribute("particlePositionsStartTime",new THREE.BufferAttribute(e.particlePositionsStartTime,4).setDynamic(!0)),e.particleShaderGeo.addAttribute("particleVelColSizeLife",new THREE.BufferAttribute(e.particleVelColSizeLife,4).setDynamic(!0)),e.posStart=e.particleShaderGeo.getAttribute("particlePositionsStartTime"),e.velCol=e.particleShaderGeo.getAttribute("particleVelColSizeLife"),e.particleShaderMat=e.GPUParticleSystem.particleShaderMat,this.init=function(){e.particleSystem=new THREE.Points(e.particleShaderGeo,e.particleShaderMat),e.particleSystem.frustumCulled=!1,this.add(e.particleSystem)};var h,i=new THREE.Vector3,j=new THREE.Vector3,k=0,l=0,m=16777215,n=0,o=0,p=0,q=0,r=2,s=250;this.offset=0,this.count=0,this.spawnParticle=function(a){a=a||{},i=void 0!==a.position?i.copy(a.position):i.set(0,0,0),j=void 0!==a.velocity?j.copy(a.velocity):j.set(0,0,0),k=void 0!==a.positionRandomness?a.positionRandomness:0,l=void 0!==a.velocityRandomness?a.velocityRandomness:0,m=void 0!==a.color?a.color:16777215,n=void 0!==a.colorRandomness?a.colorRandomness:1,u=void 0!==a.turbulence?a.turbulence:1,o=void 0!==a.lifetime?a.lifetime:5,p=void 0!==a.size?a.size:10,q=void 0!==a.sizeRandomness?a.sizeRandomness:0,smoothPosition=void 0!==a.smoothPosition&&a.smoothPosition,void 0!==e.DPR&&(p*=e.DPR),h=e.PARTICLE_CURSOR,e.posStart.array[4*h+0]=i.x+b.random()*k,e.posStart.array[4*h+1]=i.y+b.random()*k,e.posStart.array[4*h+2]=i.z+b.random()*k,e.posStart.array[4*h+3]=e.time+.02*b.random(),smoothPosition===!0&&(e.posStart.array[4*h+0]+=-(j.x*b.random()),e.posStart.array[4*h+1]+=-(j.y*b.random()),e.posStart.array[4*h+2]+=-(j.z*b.random()));var f=j.x+b.random()*l,g=j.y+b.random()*l,t=j.z+b.random()*l,u=Math.floor(254*u);f=Math.floor(s*((f- -r)/(r- -r))),g=Math.floor(s*((g- -r)/(r- -r))),t=Math.floor(s*((t- -r)/(r- -r))),e.velCol.array[4*h+0]=c(f,g,t,u);for(var v=d(m),w=0;w<v.length;w++)v[w]=Math.floor(v[w]+b.random()*n*254),v[w]>254&&(v[w]=254),v[w]<0&&(v[w]=0);e.velCol.array[4*h+1]=c(v[0],v[1],v[2],254),e.velCol.array[4*h+2]=p+b.random()*q,e.velCol.array[4*h+3]=o,0==this.offset&&(this.offset=e.PARTICLE_CURSOR),e.count++,e.PARTICLE_CURSOR++,e.PARTICLE_CURSOR>=e.PARTICLE_COUNT&&(e.PARTICLE_CURSOR=0),e.particleUpdate=!0},this.update=function(a){e.time=a,e.particleShaderMat.uniforms.uTime.value=a,this.geometryUpdate()},this.geometryUpdate=function(){1==e.particleUpdate&&(e.particleUpdate=!1,e.offset+e.count<e.PARTICLE_COUNT?(e.posStart.updateRange.offset=e.velCol.updateRange.offset=4*e.offset,e.posStart.updateRange.count=e.velCol.updateRange.count=4*e.count):(e.posStart.updateRange.offset=0,e.posStart.updateRange.count=e.velCol.updateRange.count=4*e.PARTICLE_COUNT),e.posStart.needsUpdate=!0,e.velCol.needsUpdate=!0,e.offset=0,e.count=0)},this.init()},THREE.GPUParticleContainer.prototype=Object.create(THREE.Object3D.prototype),THREE.GPUParticleContainer.prototype.constructor=THREE.GPUParticleContainer}();var IParticleSystem=Class.$extend({__init__:function(a){this.id=a,this.factories={},this.log=TundraLogging.get("IParticleSystem")},create:function(){this.log.warn("'create' not implemented")},onUpdate:function(){this.log.warn("'onUpdate' not implemented")},destroy:function(){this.log.warn("'destroy' not implemented")},exportProperties:function(){this.log.warn("'exportProperties' not implemented")}}),GeneralParticleSystem=IParticleSystem.$extend({__init__:function(a,b){this.$super(a),this.factories={},this.log=TundraLogging.get("GeneralParticleSystem"),this.cache={system:void 0,delta:1},this.options=$.extend(!0,{timeScale:1,maxParticles:25e4,spawnRate:15e3,scaleOnCameraDistance:!1},b),Object.defineProperty(this,"visible",{get:function(){return!!this.cache.system&&this.cache.system.visible},set:function(a){this.cache.system&&(this.cache.system.visible=a)}}),this.create()},__classvars__:{Implementation:"three.js"},create:function(){this.cache.system=new THREE.GPUParticleSystem(this.options),Tundra.renderer.scene.add(this.cache.system)},onUpdate:function(a){if(this.cache.system){this.cache.delta=this.options.timeScale*a;for(var b=0;b<this.options.spawnRate;++b)this.cache.system.spawnParticle(this.options.particle);this.cache.delta>0&&this.cache.system.update(this.cache.delta)}},destroy:function(){this.cache.system&&(Tundra.renderer.scene.remove(this.cache.system),delete this.cache.system)},exportProperties:function(){var a={},b=Object.keys(this.options);return b.forEach(function(b){Object.defineProperty(a,b,{get:function(){return this.options[b]}.bind(this),set:function(a){this.options[b]=a}.bind(this)})}.bind(this)),a},exportProperty:function(a,b){Object.defineProperty(a,b,{get:function(){return this.options[b]},set:function(a){this.options[b]=a}})}}),IParticleFactory=Class.$extend({__init__:function(a){this.log=TundraLogging.get("IParticleFactory"),this.name=a,this.ref="webtundra.particles."+a.toLowerCase()},createSystem:function(a){this.log.warn("'createSystem' not implemented in factory named "+this.name)}}),RainParticleFactory=IParticleFactory.$extend({__init__:function(){this.$super("Rain"),this.options={name:"Rain",texture:Tundra.asset.resolveRef("webtundra://media/textures/droplet.png"),spawnRate:1e4,timeScale:10,particle:{position:{x:0,y:10,z:0},velocity:{x:0,y:-1,z:0},positionRandomness:50,velocityRandomness:0,colorRandomness:0,turbulence:0,lifetime:1,size:50,sizeRandomness:0,smoothPosition:!0}}},createSystem:function(a){return new GeneralParticleSystem(a,this.options)}}),SmokeParticleFactory=IParticleFactory.$extend({__init__:function(){this.$super("Smoke"),this.options={name:"Smoke",texture:Tundra.asset.resolveRef("webtundra://media/textures/smoke.png"),spawnRate:10,timeScale:.1,scaleOnCameraDistance:!0,magicNumber:10,containerCount:1,particle:{position:{x:0,y:0,z:0},velocity:{x:0,y:1,z:0},color:2236962,positionRandomness:0,velocityRandomness:1,colorRandomness:0,turbulence:0,lifetime:.4,size:100,sizeRandomness:0,smoothPosition:!0}}},createSystem:function(a){return new GeneralParticleSystem(a,this.options)}}),StardustParticleFactory=IParticleFactory.$extend({__init__:function(){this.$super("Stardust"),this.options={name:"Stardust",texture:Tundra.asset.resolveRef("webtundra://media/textures/star.png"),spawnRate:1e3,timeScale:.2,scaleOnCameraDistance:!0,magicNumber:10,containerCount:1,particle:{position:{x:0,y:0,z:0},velocity:{x:1,y:1,z:1},color:16777215,positionRandomness:0,velocityRandomness:10,colorRandomness:0,turbulence:10,lifetime:1,size:100,sizeRandomness:10,smoothPosition:!0}}},createSystem:function(a){return new GeneralParticleSystem(a,this.options)}}),ThreeJsParticleEngine=IParticleEngine.$extend({__init__:function(){this.$super()},__classvars__:{Implementation:"three.js"},registerComponents:function(){Scene.registerComponent(EC_ParticleSystem_ThreeJs)},registerParticleFactories:function(){this.registerFactory(new RainParticleFactory),this.registerFactory(new SmokeParticleFactory),this.registerFactory(new StardustParticleFactory),Tundra.frame.onUpdate(this,this.onUpdate)},createSystem:function(a,b){return"string"==typeof a&&""!==a||this.log.error("'createSystem': invalid 'id' supplied:",a),"object"!=typeof b||$.isEmptyObject(b)?void this.log.error("'createSystem': invalid 'options' object supplied:",b):(this.systems[a]||(this.systems[a]=new GeneralParticleSystem(a,b)),this.systems[a])},createSystemFromFactory:function(a,b){if("string"!=typeof a||""===a)return void this.log.error("'createSystemFromFactory': invalid 'id' supplied:",a);if("string"!=typeof b||""===b)return void this.log.error("'createSystemFromFactory': invalid 'ref' supplied:",b);if(this.isFactoryRegisteredForRef(b))return this.systems[a]=this.factories[b].createSystem(a),this.systems[a]},isFactoryRegisteredForRef:function(a){return!!this.factories[a]},destroySystem:function(a){this.systems[a]&&(this.systems[a].destroy(),delete this.systems[a])},onUpdate:function(a){for(var b=Object.keys(this.systems),c=0,d=b.length;c<d;++c)this.systems[b[c]].onUpdate(a)},__classvars__:{Implementation:"three.js"}}),ParticleEnginePlugin=ITundraPlugin.$extend({__init__:function(){this.$super("ParticleEnginePlugin",["ParticleEngine"]),this.impl=null},pluginPropertyName:function(){return"particleEngine"},initialize:function(){this.impl=new ThreeJsParticleEngine},postInitialize:function(){this.impl.registerComponents(),this.impl.registerParticleFactories()}});Tundra.registerPlugin(new ParticleEnginePlugin);var BenchmarkPlugin=ITundraPlugin.$extend({__init__:function(){this.$super("BenchmarkPlugin",["Benchmark"]),this.suites={}},pluginPropertyName:function(){return"benchmark"},initialize:function(a){},postInitialize:function(){},suite:function(a){return this.suites[a]?this.suites[a]:(this.suites[a]=new Benchmark.Suite(a),this.suites[a])}});Tundra.registerPlugin(new BenchmarkPlugin);var AvatarAttachement=Class.$extend({__init__:function(a){this.parentRef="string"==typeof a?a:"",this.baseRef=0!=this.parentRef.indexOf("/")?this.parentRef.substring(0,this.parentRef.lastIndexOf("/")+1):"",this.parentRef.indexOf(".zip#")!=-1&&(this.baseRef=this.parentRef.substring(0,this.parentRef.lastIndexOf(".zip#")+5)),this.name="",this.category="",this.assets={mesh:"",materials:[]},this.transform=new Transform,this.boneName="",this.linkSkeleton=!1,this.verticesToHide=[],this._completed={all:!1,failed:!1,mesh:void 0,meshAsset:void 0,materials:[],materialAssets:[]},this._assetsRequested=!1,this._cbContext=null,this._cbFunc=null,a instanceof AvatarAttachement&&this.cloneFrom(a)},clone:function(){return new AvatarAttachement(this)},cloneFrom:function(a){this.parentRef=a.parentRef,this.baseRef=a.baseRef,this.name=a.name,this.category=this.category,this.assets.mesh=a.assets.mesh,this.assets.materials=[].concat(a.assets.materials),this.transform=a.transform.clone(),this.boneName=a.boneName,this.linkSkeleton=a.linkSkeleton,this.verticesToHide=[].concat(a.verticesToHide)},validate:function(){"none"===this.boneName.toLowerCase()&&(this.boneName=""),""===this.assets.mesh||CoreStringUtils.startsWith(this.assets.mesh,"http",!0)||(this.assets.mesh=this.baseRef+this.assets.mesh);for(var a=0;a<this.assets.materials.length;a++){var b=this.assets.materials[a];""===b||CoreStringUtils.startsWith(b,"http",!0)||(this.assets.materials[a]=this.baseRef+b)}},isCompleted:function(){return this._completed.all},isLoaded:function(){return this.isCompleted()&&this._completed.failed===!1},onCompleted:function(a,b){null==a&&null==b||(this._cbContext=null!==a&&void 0!==a?a:null,this._cbFunc="function"==typeof a&&"function"!=typeof b?a:b,this._completed.all===!0&&"function"==typeof this._cbFunc&&this._cbFunc.call(void 0!==this._cbContext&&null!==this._cbContext?this._cbContext:this,this._completed.failed,this))},requestAssets:function(a,b){if(this.onCompleted(a,b),!this._assetsRequested){if(this._assetsRequested=!0,""!==this.assets.mesh){var c=Tundra.asset.requestAsset(this.assets.mesh);null!=c&&(c.onCompleted(this,this._onTransferCompleted),c.onFailed(this,this._onTransferFailed))}for(var d=0;d<this.assets.materials.length;d++){var e=this.assets.materials[d];if(""!==e){var c=Tundra.asset.requestAsset(e);null!=c&&(c.onCompleted(this,this._onTransferCompleted),c.onFailed(this,this._onTransferFailed))}}}},markAssetCompleted:function(a,b){var c=!0,d="string"!=typeof a?a:null;null!=d&&(a=d.originalName()),this.assets.mesh===a?(this._completed.meshAsset=d,b===!1&&(this._completed.failed=!0)):void 0===this._completed.meshAsset&&(c=!1);for(var e=0;e<this.assets.materials.length;e++){var f=this.assets.materials[e];f===a?(this._completed.materialAssets[e]=d,b===!1&&(this._completed.failed=!0)):""!==f&&void 0===this._completed.materialAssets[e]&&(c=!1)}c&&(this._completed.all=!0,"function"==typeof this._cbFunc&&this._cbFunc.call(void 0!==this._cbContext&&null!==this._cbContext?this._cbContext:this,this._completed.failed,this))},_onTransferCompleted:function(a){this.markAssetCompleted(a,!0)},_onTransferFailed:function(a){this.markAssetCompleted(a.ref,!1)},findMeshParentObject:function(a,b){return""===this.boneName?null!=a?a.mesh:null:null!=b?b.getBone(this.boneName):null},attach:function(a,b){var c=!1;if(null==a&&null==b)return c;if(!this.isCompleted())return console.error("AvatarAttachement.attach: Transfer not completed yet",this.baseRef),c;if(!this.isLoaded())return c;var d=""!==this.assets.mesh?this._completed.meshAsset:null;if(null!=d&&null!=d.mesh&&null!=a){d.isAttachement=!0,d.mesh.isAttachement=!0;for(var e=0,f=d.numSubmeshes();e<f;++e){var g=d.getSubmesh(e);null!=g&&(g.isAttachement=!0)}if(null!=a&&a.isLoaded()){var h=this.findMeshParentObject(a,b);null!=h?(null==d.parent?(h.add(d.mesh),this.transform.apply(d.mesh)):d.parent.name!==h.name&&(d.parent.remove(d.mesh),h.add(d.mesh),this.transform.apply(d.mesh)),c=!0):console.error("AvatarAttachement.attach: Failed to find parent object with bone='"+this.boneName+"'"(null!=a?" from "+a.name:""))}else console.error("AvatarAttachement.attach: Parent Mesh asset not loaded",this.baseRef);for(var e=0,f=d.numSubmeshes();e<f;++e){var i=this.assets.materials[e];if("string"==typeof i&&""!==i){var g=d.getSubmesh(e);if(null!=g){var j=this._completed.materialAssets[e];null!=j&&null!=j.material&&g.material.uuid!==j.material.uuid&&(g.material=j.material)}}}this.linkSkeleton===!0&&(null!=b&&b.isLoaded()?b.link(d):console.error("AvatarAttachement.attach: Linking to avatar skeleton is enabled but skeleton asset is not ready",null!=b?b.name:""))}return c},detach:function(){var a=""!==this.assets.mesh?this._completed.meshAsset:null;null!=a&&null!=a.mesh&&null!=a.mesh.parent&&a.mesh.parent.remove(a.mesh)}}),AvatarDescAsset=IAsset.$extend({__init__:function(a){this.$super(a,"AvatarDescAsset"),this.reset()},reset:function(){this.assets={mesh:"",skeleton:"",materials:[]},this.attachements=[],this.transform=new Transform},cloneInstance:function(){for(var a={assets:{mesh:this.assets.mesh,skeleton:this.assets.skeleton,materials:[].concat(this.assets.materials)},attachements:[],transform:this.transform.clone()},b=0;b<this.attachements.length;b++)a.attachements.push(this.attachements[b].clone());return a},cloneAttachements:function(){for(var a=[],b=0;b<this.attachements.length;b++)a.push(this.attachements[b].clone());return a},isLoaded:function(){return""!==this.assets.mesh},deserializeFromData:function(a,b,c){this.reset();var d=this,e=$(a).find("avatar");if(this.assets.mesh=this._readStringAttr(e.children("base"),"mesh"),""===this.assets.mesh){var f=e.children("property");f.each(function(){if(""===d.assets.mesh){var a=d._readStringAttr($(this),"name");"basemesh"===a&&(d.assets.mesh=d._readStringAttr($(this),"value"))}})}this.assets.skeleton=this._readStringAttr(e.children("skeleton"),"name"),this.assets.materials=this._readEach(e.children("material"),"name"),this.assets.mesh=this._validateAssetRef(this.assets.mesh,"mesh"),this.assets.skeleton=this._validateAssetRef(this.assets.skeleton,"skeleton"),this.assets.materials=this._validateAssetRefList(this.assets.materials,"material",!0),this._readTransformAttrs(e.children("transformation"),"position","rotation","scale",this.transform);var g=e.children("attachment");return g.each(function(){d.attachements.push(d._readAttachement($(this)))}),this.isLoaded()},_validateAssetRef:function(a,b){if(""!==a){if(!CoreStringUtils.startsWith(a,"http",!0))return this.baseRef+a}else this.log.warn("Failed to parse",b,"ref from",this.name);return a},_validateAssetRefList:function(a,b,c){if(0===a.length)return this.log.warn("No",b,"assets declared in",this.name),a;c="boolean"!=typeof c||c;for(var d=0;d<a.length;d++){var e=a[d];""!==e?CoreStringUtils.startsWith(e,"http",!0)||(a[d]=this.baseRef+e):c||this.log.warn("Empty",b,"found at index",d,"from",this.name)}return a},_readEach:function(a,b,c){var d=this,e=[];return a.each(function(){var a=d._readStringAttr($(this),b);"boolean"===c||"bool"===c?a="1"===a||"true"===a||"on"===a:"int"===c?a=parseInt(a):"float"===c&&(a=parseFloat(a)),e.push(a)}),e},_readAttachement:function(a){var b=a.children("avatar").children("bone").first(),c=new AvatarAttachement(this.name);return c.name=this._readStringAttr(a.children("name"),"value"),c.category=this._readStringAttr(a.children("category"),"name"),c.boneName=this._readStringAttr(b,"name"),c.linkSkeleton=this._readBoolAttr(a.children("mesh"),"linkskeleton"),c.assets.mesh=this._readStringAttr(a.children("mesh"),"name"),c.assets.materials=this._readEach(a.children("material"),"name"),c.verticesToHide=this._readEach(a.children("avatar").children("avatar_polygon"),"idx","int"),this._readTransformAttrs(b,"offset","rotation","scale",c.transform),c.validate(),c},_readStringAttr:function(a,b){var c=a.attr(b);return"string"==typeof c?c:""},_readBoolAttr:function(a,b,c){var d=this._readStringAttr(a,b).toLowerCase();return""===d?"boolean"==typeof c&&c:"1"===d||"true"===d||"on"===d},_readTransformAttrs:function(a,b,c,d,e){this._readTransformComponentAttr(a,b,e.pos),this._readTransformComponentAttr(a,c,e),this._readTransformComponentAttr(a,d,e.scale)},_readTransformComponentAttr:function(a,b,c){var d=a.attr(b);if("string"==typeof d){var e=d.split(" ");if("rotation"!==b)e.length>=3?(c.x=parseFloat(e[0]),c.y=parseFloat(e[1]),c.z=parseFloat(e[2])):this.log.warn("Transform component '"+b+"' does not have enough data:",d,e);else if(e.length>=4){var f=new THREE.Quaternion;f.w=parseFloat(e[0]),f.x=parseFloat(e[1]),f.y=parseFloat(e[2]),f.z=parseFloat(e[3]),c.setRotation(f)}else this.log.warn("Transform component '"+b+"' does not have enough data:",d,e)}},unload:function(){this.reset()}}),AvatarPlugin=ITundraPlugin.$extend({__init__:function(){this.$super("AvatarPlugin",["Avatar"])},pluginPropertyName:function(){return"avatar"},initialize:function(a){this.framework.asset.registerAssetFactory(new AssetFactory("RealXtendAvatarDescription",AvatarDescAsset,{".avatar":"xml"}))},postInitialize:function(){}});Tundra.registerPlugin(new AvatarPlugin);